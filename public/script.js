// script.js - MathHub Application with Complete Database-Driven Progress Tracking
// Includes lesson management, practice exercises, quiz system, and full progress integration

// ============================================
// MATHHUB APPLICATION - JAVASCRIPT
// ============================================

let authToken = localStorage.getItem('authToken') || null;
   
const API_BASE_URL = window.location.origin;


// Define default practice statistics function
function getDefaultPracticeStats() {
    return {
        totalSessions: 0,
        totalQuestions: 0,
        correctAnswers: 0,
        averageScore: 0,
        studyTime: 0,
        weakAreas: [],
        strongAreas: [],
        recentActivity: []
    };
}

// ============================================
// âœ… FIXED: ToolManager with better error handling
// ============================================
class ToolManager {
    constructor() {
        this.tools = {};
        this.currentTool = null;
        this.modalsContainer = document.getElementById('toolModalsContainer');
        
        // Create modals container if it doesn't exist
        if (!this.modalsContainer) {
            this.modalsContainer = document.createElement('div');
            this.modalsContainer.id = 'toolModalsContainer';
            document.body.appendChild(this.modalsContainer);
        }
        
        this.init();
    }

    init() {
        console.log('ðŸ”§ Initializing ToolManager...');
        this.createModals();
        this.initializeTools();
        this.setupEventListeners();
    }

    createModals() {
        console.log('ðŸ“¦ Creating tool modals...');
        // Check if modals already exist
        const existingModals = [
            'calculatorModal', 'graphModal', 'whiteboardModal', 
            'notepadModal', 'formulaModal', 'timerModal'
        ];
        
        let anyModalMissing = false;
        existingModals.forEach(id => {
            if (!document.getElementById(id)) {
                anyModalMissing = true;
            }
        });
        
        // If any modal is missing, create them
        if (anyModalMissing) {
            this.injectModalHTML();
        }
    }

    injectModalHTML() {
        const modalHTML = `
            <!-- Calculator Modal -->
            <div id="calculatorModal" class="modal-overlay">
                <div class="modal-container">
                    <div class="modal-header" style="background: #7a0000; color: white;">
                        <h3 style="margin: 0;"><i class="fas fa-calculator"></i> Calculator</h3>
                        <button class="modal-close" onclick="window.toolManager.closeTool()" style="color: white;">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="calculator-container">
                            <div class="calculator-display" id="calcDisplay">0</div>
                            <div class="calculator-buttons" id="calcButtons"></div>
                            <div class="calculator-history">
                                <h3><i class="fas fa-history"></i> History</h3>
                                <div class="history-list" id="calcHistory"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Graph Modal -->
            <div id="graphModal" class="modal-overlay">
                <div class="modal-container">
                    <div class="modal-header" style="background: #7a0000; color: white;">
                        <h3 style="margin: 0;"><i class="fas fa-chart-line"></i> Graph Tool</h3>
                        <button class="modal-close" onclick="window.toolManager.closeTool()" style="color: white;">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="graph-tool">
                            <canvas id="graphCanvas" width="600" height="400"></canvas>
                            <div class="graph-controls">
                                <input type="text" id="graphExpression" placeholder="f(x) = " value="x^3 - 2x^2 + x - 1">
                                <button id="plotGraphBtn">Plot</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Whiteboard Modal -->
            <div id="whiteboardModal" class="modal-overlay">
                <div class="modal-container">
                    <div class="modal-header" style="background: #7a0000; color: white;">
                        <h3 style="margin: 0;"><i class="fas fa-paint-brush"></i> Whiteboard</h3>
                        <button class="modal-close" onclick="window.toolManager.closeTool()" style="color: white;">&times;</button>
                    </div>
                    <div class="modal-body">
                        <canvas id="whiteboardCanvas" width="600" height="400"></canvas>
                        <div class="whiteboard-controls">
                            <button onclick="window.toolManager.tools.whiteboard.setTool('pen')">Pen</button>
                            <button onclick="window.toolManager.tools.whiteboard.setTool('eraser')">Eraser</button>
                            <button onclick="window.toolManager.tools.whiteboard.clear()">Clear</button>
                            <input type="color" id="colorPicker" value="#7a0000">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Notepad Modal -->
            <div id="notepadModal" class="modal-overlay">
                <div class="modal-container">
                    <div class="modal-header" style="background: #7a0000; color: white;">
                        <h3 style="margin: 0;"><i class="fas fa-sticky-note"></i> Notepad</h3>
                        <button class="modal-close" onclick="window.toolManager.closeTool()" style="color: white;">&times;</button>
                    </div>
                    <div class="modal-body">
                        <input type="text" id="noteTitle" placeholder="Note Title">
                        <textarea id="noteContent" placeholder="Write your notes here..." rows="10"></textarea>
                        <button onclick="window.toolManager.tools.notepad.save()">Save Note</button>
                        <button onclick="window.toolManager.tools.notepad.clear()">Clear</button>
                    </div>
                </div>
            </div>
            
            <!-- Formula Sheet Modal -->
            <div id="formulaModal" class="modal-overlay">
                <div class="modal-container">
                    <div class="modal-header" style="background: #7a0000; color: white;">
                        <h3 style="margin: 0;"><i class="fas fa-square-root-alt"></i> Formula Sheet</h3>
                        <button class="modal-close" onclick="window.toolManager.closeTool()" style="color: white;">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="formula-categories">
                            <button onclick="window.toolManager.tools.formula.showCategory('polynomial')">Polynomial</button>
                            <button onclick="window.toolManager.tools.formula.showCategory('algebra')">Algebra</button>
                            <button onclick="window.toolManager.tools.formula.showCategory('calculus')">Calculus</button>
                        </div>
                        <div id="formulaList"></div>
                    </div>
                </div>
            </div>
            
            <!-- Timer Modal -->
            <div id="timerModal" class="modal-overlay">
                <div class="modal-container">
                    <div class="modal-header" style="background: #7a0000; color: white;">
                        <h3 style="margin: 0;"><i class="fas fa-clock"></i> Study Timer</h3>
                        <button class="modal-close" onclick="window.toolManager.closeTool()" style="color: white;">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="timer-display" id="timerDisplay">25:00</div>
                        <div class="timer-controls">
                            <button id="timerStartBtn">Start</button>
                            <button id="timerPauseBtn">Pause</button>
                            <button id="timerResetBtn">Reset</button>
                        </div>
                        <div class="timer-presets">
                            <button id="timer15min">15 min</button>
                            <button id="timer25min" class="active">25 min</button>
                            <button id="timer50min">50 min</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        this.modalsContainer.innerHTML = modalHTML;
    }

    initializeTools() {
        console.log('ðŸ”§ Initializing tool instances...');
        this.tools = {
            calculator: new Calculator(),
            whiteboard: new Whiteboard(),
            notepad: new Notepad(),
            formula: new FormulaSheet(),
            timer: new StudyTimer(),
            graph: new GraphTool()
        };
    }

    setupEventListeners() {
        console.log('ðŸ”— Setting up event listeners...');
        
        // Close modal when clicking on the overlay (background)
        window.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                console.log('ðŸ”˜ Clicked on overlay, closing tool');
                this.closeTool();
            }
        });

        // Close modal when pressing ESC key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                console.log('ðŸ”˜ ESC key pressed, closing tool');
                this.closeTool();
            }
        });
    }

    openTool(toolName) {
        console.log(`ðŸ”§ Opening tool: ${toolName}`);
        
        // Close any open tool first
        this.closeTool();
        
        const modal = document.getElementById(`${toolName}Modal`);
        if (modal) {
            // Force show modal
            modal.style.display = 'flex';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
            modal.style.zIndex = '10000';
            modal.style.alignItems = 'center';
            modal.style.justifyContent = 'center';
            
            modal.classList.add('active');
            this.currentTool = toolName;
            
            // Initialize tool when opened
            if (this.tools[toolName] && typeof this.tools[toolName].onOpen === 'function') {
                setTimeout(() => {
                    try {
                        this.tools[toolName].onOpen();
                    } catch (e) {
                        console.error(`Error opening ${toolName}:`, e);
                    }
                }, 100);
            }
            
            console.log(`âœ… ${toolName} opened successfully`);
            return true;
        } else {
            console.error(`âŒ Modal not found: ${toolName}Modal`);
            return false;
        }
    }

    closeTool() {
        console.log('ðŸ”§ Closing current tool');
        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.style.display = 'none';
            modal.classList.remove('active');
        });
        this.currentTool = null;
    }

    // Timer bridge methods
    startTimer() {
        if (this.tools && this.tools.timer) {
            this.tools.timer.start();
        }
    }

    pauseTimer() {
        if (this.tools && this.tools.timer) {
            this.tools.timer.pause();
        }
    }

    resetTimer() {
        if (this.tools && this.tools.timer) {
            this.tools.timer.reset();
        }
    }
}

// ========================================
// CALCULATOR TOOL - FIXED VERSION
// ========================================
class Calculator {
    constructor() {
        this.display = '0';
        this.history = [];
        this.memory = 0;
        this.expression = '';
        this.lastResult = null;
    }

    onOpen() {
        this.display = '0';
        this.expression = '';
        this.renderButtons();
        this.loadHistory();
    }

    renderButtons() {
        const buttons = [
            ['C', 'âŒ«', '%', 'Ã·'],
            ['7', '8', '9', 'Ã—'],
            ['4', '5', '6', '-'],
            ['1', '2', '3', '+'],
            ['00', '0', '.', '=']
        ];

        const buttonsHtml = buttons.map(row => 
            row.map(btn => {
                let className = 'calc-btn';
                if (['+', '-', 'Ã—', 'Ã·', '%'].includes(btn)) className += ' operator';
                if (btn === '=') className += ' equals';
                if (btn === 'C') className += ' clear';
                if (btn === 'âŒ«') className += ' backspace';
                
                return `<button class="${className}" data-value="${btn}">${btn}</button>`;
            }).join('')
        ).join('');

        const buttonsContainer = document.getElementById('calcButtons');
        if (buttonsContainer) {
            buttonsContainer.innerHTML = buttonsHtml;
            
            // Add event listeners to buttons
            buttonsContainer.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('click', () => {
                    const value = btn.getAttribute('data-value');
                    this.handleButton(value);
                });
            });
        }
        
        this.updateDisplay();
    }

    handleButton(btn) {
        switch(btn) {
            case 'C':
                this.display = '0';
                this.expression = '';
                this.lastResult = null;
                break;
                
            case 'âŒ«':
                if (this.display.length > 1) {
                    this.display = this.display.slice(0, -1);
                } else {
                    this.display = '0';
                }
                break;
                
            case '=':
                this.calculate();
                break;
                
            case 'Ã·':
                this.addToExpression('/');
                break;
                
            case 'Ã—':
                this.addToExpression('*');
                break;
                
            default:
                this.addToExpression(btn);
        }
        this.updateDisplay();
    }

    addToExpression(value) {
        // Handle numbers and operators
        if (this.display === '0' && !isNaN(value)) {
            this.display = value;
        } else {
            this.display += value;
        }
    }

    calculate() {
        try {
            // Replace display operators with JavaScript operators
            let expression = this.display
                .replace(/Ã·/g, '/')
                .replace(/Ã—/g, '*');
            
            // Don't calculate if expression is empty or just operators
            if (!expression || expression.match(/^[+\-*/]+$/)) {
                return;
            }
            
            let result = eval(expression);
            
            // Handle decimal places
            if (result.toString().includes('.')) {
                result = Math.round(result * 1000000) / 1000000;
            }
            
            // Add to history
            this.history.unshift({
                expression: this.display,
                result: result,
                timestamp: new Date().toLocaleTimeString()
            });
            
            // Keep history to 10 items
            if (this.history.length > 10) {
                this.history.pop();
            }
            
            // Save to backend
            this.saveToHistory(this.display, result);
            
            // Update display
            this.display = result.toString();
            this.lastResult = result;
            this.updateHistory();
            
        } catch (error) {
            console.error('Calculation error:', error);
            this.display = 'Error';
            setTimeout(() => {
                this.display = '0';
                this.updateDisplay();
            }, 1500);
        }
    }

    async saveToHistory(expression, result) {
        try {
            const token = localStorage.getItem('authToken') || authToken;
            if (!token) return;

            await fetch(`/calculator/save`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ expression, result })
            });
        } catch (error) {
            console.log('Failed to save calculation:', error);
        }
    }

    async loadHistory() {
        try {
            const token = localStorage.getItem('authToken') || authToken;
            if (!token) return;

            const response = await fetch(`/api/calculator/history`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (!response.ok) return;
            
            const data = await response.json();
            
            if (data.success && data.history) {
                this.history = data.history.map(item => ({
                    expression: item.expression,
                    result: item.result,
                    timestamp: new Date(item.created_at).toLocaleTimeString()
                }));
                this.updateHistory();
            }
        } catch (error) {
            console.log('Failed to load history:', error);
        }
    }

    updateDisplay() {
        const displayEl = document.getElementById('calcDisplay');
        if (displayEl) {
            displayEl.textContent = this.display;
        }
    }

    updateHistory() {
        const historyEl = document.getElementById('calcHistory');
        if (!historyEl) return;

        if (this.history.length === 0) {
            historyEl.innerHTML = '<div class="history-empty">No calculations yet</div>';
            return;
        }

        historyEl.innerHTML = this.history.map(item => `
            <div class="history-item" onclick="window.toolManager.tools.calculator.useHistory('${item.expression}')">
                <div class="history-expression">${item.expression} =</div>
                <div class="history-result">${item.result}</div>
                <div class="history-time">${item.timestamp}</div>
            </div>
        `).join('');
    }

    useHistory(expression) {
        this.display = expression;
        this.updateDisplay();
    }
}

// ========================================
// GRAPH TOOL - FOR ANY POLYNOMIAL FUNCTION
// ========================================
class GraphTool {
    constructor() {
        this.canvas = null;
        this.ctx = null;
        this.expression = 'x^3 - 2x^2 + x - 1'; // Default polynomial
        this.range = { min: -5, max: 5 };
        this.points = [];
        this.isDarkMode = false;
        this.xRoots = []; // X-intercepts (y=0)
        this.yRoots = []; // Y-intercepts (x=0)
        this.turningPoints = []; // Local maxima/minima
    }

    onOpen() {
        setTimeout(() => {
            this.canvas = document.getElementById('graphCanvas');
            if (this.canvas) {
                this.ctx = this.canvas.getContext('2d');
                this.setupCanvas();
                this.setupEventListeners();
                this.drawGrid();
                this.plotFunction();
            }
        }, 100);
    }

    setupCanvas() {
        // Set canvas size
        this.canvas.width = this.canvas.offsetWidth;
        this.canvas.height = this.canvas.offsetHeight;
        
        // Set default styles
        this.ctx.lineWidth = 2;
        this.ctx.strokeStyle = '#667eea';
        this.ctx.fillStyle = '#667eea';
        this.ctx.font = '12px Arial';
    }

    setupEventListeners() {
        // Expression input
        const exprInput = document.getElementById('graphExpression');
        if (exprInput) {
            exprInput.addEventListener('input', (e) => {
                this.expression = e.target.value;
            });
        }

        // Plot button
        const plotBtn = document.getElementById('plotGraphBtn');
        if (plotBtn) {
            plotBtn.addEventListener('click', () => {
                this.plotFunction();
            });
        }

        // Range inputs
        const minRange = document.getElementById('graphMinRange');
        const maxRange = document.getElementById('graphMaxRange');
        
        if (minRange) {
            minRange.addEventListener('change', (e) => {
                this.range.min = parseFloat(e.target.value) || -5;
                this.drawGrid();
                this.plotFunction();
            });
        }
        
        if (maxRange) {
            maxRange.addEventListener('change', (e) => {
                this.range.max = parseFloat(e.target.value) || 5;
                this.drawGrid();
                this.plotFunction();
            });
        }

        // Clear button
        const clearBtn = document.getElementById('clearGraphBtn');
        if (clearBtn) {
            clearBtn.addEventListener('click', () => {
                this.expression = 'x^3 - 2x^2 + x - 1';
                if (exprInput) exprInput.value = 'x^3 - 2x^2 + x - 1';
                this.drawGrid();
                this.plotFunction();
            });
        }

        // Save button
        const saveBtn = document.getElementById('saveGraphBtn');
        if (saveBtn) {
            saveBtn.addEventListener('click', () => {
                this.saveGraph();
            });
        }

        // Dark mode toggle
        const darkModeBtn = document.getElementById('graphDarkMode');
        if (darkModeBtn) {
            darkModeBtn.addEventListener('click', () => {
                this.isDarkMode = !this.isDarkMode;
                this.drawGrid();
                this.plotFunction();
            });
        }
    }

    f(x) {
        // Evaluate ANY polynomial function
        try {
            if (!this.expression || this.expression.trim() === '') {
                return 0;
            }
            
            // Replace ^ with ** for JavaScript exponentiation
            let expr = this.expression.replace(/\^/g, '**');
            
            // Handle implicit multiplication (e.g., "2x" becomes "2*x")
            expr = expr.replace(/(\d)(x)/g, '$1*$2');
            
            // Create a safe evaluation function
            const fn = new Function('x', `return ${expr}`);
            return fn(x);
        } catch (e) {
            console.error('Error evaluating function:', e);
            return NaN;
        }
    }

    generatePoints() {
        this.points = [];
        const step = (this.range.max - this.range.min) / 500; // Higher resolution for better accuracy
        
        for (let x = this.range.min; x <= this.range.max; x += step) {
            try {
                const y = this.f(x);
                
                if (isFinite(y) && !isNaN(y) && Math.abs(y) < 100) { // Limit y-range to avoid extreme values
                    this.points.push({ x, y });
                }
            } catch (e) {
                // Skip points where function fails
            }
        }
    }

    findRoots() {
        this.xRoots = []; // X-intercepts (y=0)
        this.yRoots = []; // Y-intercepts (x=0)
        this.turningPoints = []; // Local maxima/minima
        
        // Find Y-intercept (x=0)
        try {
            const yAtZero = this.f(0);
            if (isFinite(yAtZero) && !isNaN(yAtZero) && Math.abs(yAtZero) < 100) {
                this.yRoots.push({ x: 0, y: yAtZero });
            }
        } catch (e) {
            console.log('Could not calculate y-intercept');
        }
        
        // Find X-intercepts (where y=0) using zero-crossing detection
        if (this.points.length < 2) return;
        
        for (let i = 1; i < this.points.length; i++) {
            const p1 = this.points[i-1];
            const p2 = this.points[i];
            
            // Check if function crosses zero
            if (p1.y * p2.y <= 0 && Math.abs(p1.y) < 100 && Math.abs(p2.y) < 100) {
                // Linear interpolation to find root
                const rootX = p1.x - p1.y * (p2.x - p1.x) / (p2.y - p1.y);
                
                // Check if this root is unique (avoid duplicates)
                const isDuplicate = this.xRoots.some(r => Math.abs(r.x - rootX) < 0.01);
                
                if (!isDuplicate && rootX >= this.range.min && rootX <= this.range.max) {
                    this.xRoots.push({ x: rootX, y: 0 });
                }
            }
        }
        
        // Find turning points (where derivative changes sign)
        for (let i = 1; i < this.points.length - 1; i++) {
            const prev = this.points[i-1];
            const curr = this.points[i];
            const next = this.points[i+1];
            
            // Check for local maximum
            if (curr.y > prev.y && curr.y > next.y) {
                this.turningPoints.push({ x: curr.x, y: curr.y, type: 'max' });
            }
            
            // Check for local minimum
            if (curr.y < prev.y && curr.y < next.y) {
                this.turningPoints.push({ x: curr.x, y: curr.y, type: 'min' });
            }
        }
        
        // Display all features
        this.displayFeatures();
    }

    displayFeatures() {
        const rootsEl = document.getElementById('graphRoots');
        if (!rootsEl) return;
        
        let html = '<div class="roots-container">';
        
        // Display X-intercepts
        if (this.xRoots.length > 0) {
            html += '<div class="roots-section">';
            html += '<h4 style="color: #e74c3c;"><i class="fas fa-arrow-right"></i> X-Intercepts (y=0):</h4>';
            html += '<ul>';
            this.xRoots.forEach((root, index) => {
                html += `<li>x = ${root.x.toFixed(3)}</li>`;
            });
            html += '</ul>';
            html += '</div>';
        }
        
        // Display Y-intercept
        if (this.yRoots.length > 0) {
            html += '<div class="roots-section">';
            html += '<h4 style="color: #2980b9;"><i class="fas fa-arrow-up"></i> Y-Intercept (x=0):</h4>';
            html += '<ul>';
            this.yRoots.forEach(root => {
                html += `<li>y = ${root.y.toFixed(3)}</li>`;
            });
            html += '</ul>';
            html += '</div>';
        }
        
        // Display Turning Points
        if (this.turningPoints.length > 0) {
            html += '<div class="roots-section">';
            html += '<h4 style="color: #f39c12;"><i class="fas fa-chart-line"></i> Turning Points:</h4>';
            html += '<ul>';
            this.turningPoints.forEach(point => {
                const icon = point.type === 'max' ? 'â–²' : 'â–¼';
                html += `<li>${icon} (${point.x.toFixed(3)}, ${point.y.toFixed(3)}) - ${point.type === 'max' ? 'Maximum' : 'Minimum'}</li>`;
            });
            html += '</ul>';
            html += '</div>';
        }
        
        // If no features found
        if (this.xRoots.length === 0 && this.yRoots.length === 0 && this.turningPoints.length === 0) {
            html += '<p class="no-roots">No intercepts or turning points found in current range</p>';
        }
        
        html += '</div>';
        rootsEl.innerHTML = html;
    }

    drawGrid() {
        if (!this.ctx || !this.canvas) return;
        
        const w = this.canvas.width;
        const h = this.canvas.height;
        
        // Clear canvas
        this.ctx.clearRect(0, 0, w, h);
        
        // Set colors based on mode
        const gridColor = this.isDarkMode ? '#333' : '#ddd';
        const axisColor = this.isDarkMode ? '#666' : '#999';
        const textColor = this.isDarkMode ? '#ccc' : '#333';
        const bgColor = this.isDarkMode ? '#1a1a1a' : '#fff';
        
        // Fill background
        this.ctx.fillStyle = bgColor;
        this.ctx.fillRect(0, 0, w, h);
        
        // Calculate y-range based on function values
        let yMin = -10, yMax = 10;
        if (this.points.length > 0) {
            const yValues = this.points.map(p => p.y).filter(y => isFinite(y) && !isNaN(y) && Math.abs(y) < 100);
            if (yValues.length > 0) {
                yMin = Math.min(...yValues);
                yMax = Math.max(...yValues);
                // Add some padding
                const padding = (yMax - yMin) * 0.1;
                yMin -= padding;
                yMax += padding;
            }
        }
        
        const yRange = yMax - yMin;
        
        // Pixel to coordinate mapping
        const xToPx = (x) => ((x - this.range.min) / (this.range.max - this.range.min)) * w;
        const yToPx = (y) => h - ((y - yMin) / yRange) * h;
        
        // Draw grid lines
        this.ctx.strokeStyle = gridColor;
        this.ctx.lineWidth = 0.5;
        
        // Vertical grid lines (every integer)
        for (let x = Math.ceil(this.range.min); x <= this.range.max; x++) {
            if (x === 0) continue; // Skip axis
            const px = xToPx(x);
            if (px >= 0 && px <= w) {
                this.ctx.beginPath();
                this.ctx.moveTo(px, 0);
                this.ctx.lineTo(px, h);
                this.ctx.stroke();
            }
        }
        
        // Horizontal grid lines (every integer in y-range)
        for (let y = Math.ceil(yMin); y <= yMax; y++) {
            if (y === 0) continue; // Skip axis
            const py = yToPx(y);
            if (py >= 0 && py <= h) {
                this.ctx.beginPath();
                this.ctx.moveTo(0, py);
                this.ctx.lineTo(w, py);
                this.ctx.stroke();
            }
        }
        
        // Draw axes
        this.ctx.strokeStyle = axisColor;
        this.ctx.lineWidth = 2;
        
        // Y-axis
        const xZero = xToPx(0);
        if (xZero >= 0 && xZero <= w) {
            this.ctx.beginPath();
            this.ctx.moveTo(xZero, 0);
            this.ctx.lineTo(xZero, h);
            this.ctx.stroke();
        }
        
        // X-axis
        const yZero = yToPx(0);
        if (yZero >= 0 && yZero <= h) {
            this.ctx.beginPath();
            this.ctx.moveTo(0, yZero);
            this.ctx.lineTo(w, yZero);
            this.ctx.stroke();
        }
        
        // Draw axis labels
        this.ctx.fillStyle = textColor;
        this.ctx.font = '12px Arial';
        
        // X-axis labels
        for (let x = Math.ceil(this.range.min); x <= this.range.max; x++) {
            if (x === 0) continue;
            const px = xToPx(x);
            const py = yZero;
            if (px >= 0 && px <= w && py >= 0 && py <= h) {
                this.ctx.fillText(x, px - 5, py - 5);
            }
        }
        
        // Y-axis labels
        for (let y = Math.ceil(yMin); y <= yMax; y++) {
            if (y === 0) continue;
            const px = xZero;
            const py = yToPx(y);
            if (px >= 0 && px <= w && py >= 0 && py <= h) {
                this.ctx.fillText(y, px + 5, py - 5);
            }
        }
        
        // Draw origin
        if (xZero >= 0 && xZero <= w && yZero >= 0 && yZero <= h) {
            this.ctx.fillStyle = textColor;
            this.ctx.fillText('0', xZero + 5, yZero - 5);
        }
    }

    plotFunction() {
        this.generatePoints();
        this.findRoots();
        this.drawGrid();
        
        if (this.points.length === 0) return;
        
        const w = this.canvas.width;
        const h = this.canvas.height;
        
        // Calculate y-range
        let yMin = -10, yMax = 10;
        const yValues = this.points.map(p => p.y).filter(y => isFinite(y) && !isNaN(y) && Math.abs(y) < 100);
        if (yValues.length > 0) {
            yMin = Math.min(...yValues);
            yMax = Math.max(...yValues);
            const padding = (yMax - yMin) * 0.1;
            yMin -= padding;
            yMax += padding;
        }
        
        const yRange = yMax - yMin;
        
        // Pixel to coordinate mapping
        const xToPx = (x) => ((x - this.range.min) / (this.range.max - this.range.min)) * w;
        const yToPx = (y) => h - ((y - yMin) / yRange) * h;
        
        // Draw function
        this.ctx.strokeStyle = '#667eea';
        this.ctx.lineWidth = 3;
        this.ctx.beginPath();
        
        let first = true;
        for (const point of this.points) {
            const px = xToPx(point.x);
            const py = yToPx(point.y);
            
            if (px >= 0 && px <= w && py >= 0 && py <= h) {
                if (first) {
                    this.ctx.moveTo(px, py);
                    first = false;
                } else {
                    this.ctx.lineTo(px, py);
                }
            } else {
                first = true; // Break line when going out of bounds
            }
        }
        
        this.ctx.stroke();
        
        // Draw X-intercepts (red circles)
        const yZero = yToPx(0);
        this.ctx.fillStyle = '#e74c3c';
        this.xRoots.forEach(root => {
            const px = xToPx(root.x);
            if (px >= 0 && px <= w && yZero >= 0 && yZero <= h) {
                this.ctx.beginPath();
                this.ctx.arc(px, yZero, 6, 0, 2 * Math.PI);
                this.ctx.fill();
                
                // Add label
                this.ctx.fillStyle = this.isDarkMode ? '#fff' : '#000';
                this.ctx.font = 'bold 10px Arial';
                this.ctx.fillText(`x=${root.x.toFixed(2)}`, px - 25, yZero - 15);
                this.ctx.fillStyle = '#e74c3c';
            }
        });
        
        // Draw Y-intercept (blue circle)
        const xZero = xToPx(0);
        this.ctx.fillStyle = '#2980b9';
        this.yRoots.forEach(root => {
            const px = xZero;
            const py = yToPx(root.y);
            if (px >= 0 && px <= w && py >= 0 && py <= h) {
                this.ctx.beginPath();
                this.ctx.arc(px, py, 6, 0, 2 * Math.PI);
                this.ctx.fill();
                
                // Add label
                this.ctx.fillStyle = this.isDarkMode ? '#fff' : '#000';
                this.ctx.font = 'bold 10px Arial';
                this.ctx.fillText(`y=${root.y.toFixed(2)}`, px + 10, py - 10);
                this.ctx.fillStyle = '#2980b9';
            }
        });
        
        // Draw Turning Points (orange circles)
        this.ctx.fillStyle = '#f39c12';
        this.turningPoints.forEach(point => {
            const px = xToPx(point.x);
            const py = yToPx(point.y);
            if (px >= 0 && px <= w && py >= 0 && py <= h) {
                this.ctx.beginPath();
                this.ctx.arc(px, py, 5, 0, 2 * Math.PI);
                this.ctx.fill();
            }
        });
    }

    async saveGraph() {
        try {
            const token = localStorage.getItem('authToken') || authToken;
            if (!token) {
                alert('Please login to save graphs');
                return;
            }
            
            const response = await fetch(`/api/graph/save`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    expression: this.expression,
                    graph_type: 'polynomial',
                    range: this.range,
                    xRoots: this.xRoots,
                    yRoots: this.yRoots,
                    turningPoints: this.turningPoints
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                alert('Graph saved successfully!');
            } else {
                alert('Failed to save graph');
            }
        } catch (error) {
            console.error('Error saving graph:', error);
            alert('Error saving graph');
        }
    }
}

// ========================================
// WHITEBOARD TOOL - MOBILE FIXED VERSION
// ========================================
class Whiteboard {
    constructor() {
        this.canvas = null;
        this.ctx = null;
        this.drawing = false;
        this.currentTool = 'pen';
        this.color = '#7a0000';
        this.lineWidth = 2;
        this.lastX = 0;
        this.lastY = 0;
    }

    onOpen() {
        console.log('ðŸŽ¨ Whiteboard opened - initializing with mobile support...');
        
        setTimeout(() => this.setupCanvas(), 100);
        setTimeout(() => this.setupCanvas(), 300);
    }

    setupCanvas() {
        this.canvas = document.getElementById('whiteboardCanvas');
        
        if (!this.canvas) {
            const activeModal = document.querySelector('.modal-overlay.active, .modal-overlay[style*="display: flex"]');
            if (activeModal) {
                this.canvas = activeModal.querySelector('#whiteboardCanvas');
            }
        }
        
        if (this.canvas) {
            console.log('âœ… Whiteboard canvas found');
            
            // Set canvas size
            const container = this.canvas.parentElement;
            if (container) {
                this.canvas.width = container.clientWidth - 40;
                this.canvas.height = container.clientHeight - 100;
            } else {
                this.canvas.width = 600;
                this.canvas.height = 400;
            }
            
            this.ctx = this.canvas.getContext('2d');
            
            // Set styles
            this.ctx.strokeStyle = this.color;
            this.ctx.lineWidth = this.lineWidth;
            this.ctx.lineCap = 'round';
            this.ctx.lineJoin = 'round';
            
            // Clear canvas
            this.ctx.fillStyle = '#ffffff';
            this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
            
            this.setupEventListeners();
            
            console.log('âœ… Whiteboard ready for mobile');
        }
    }

    setupEventListeners() {
        if (!this.canvas || !this.ctx) return;
        
        // Remove old listeners
        this.canvas.removeEventListener('mousedown', this.startDrawing.bind(this));
        this.canvas.removeEventListener('mousemove', this.draw.bind(this));
        this.canvas.removeEventListener('mouseup', this.stopDrawing.bind(this));
        this.canvas.removeEventListener('mouseout', this.stopDrawing.bind(this));
        
        // Remove old touch listeners
        this.canvas.removeEventListener('touchstart', this.handleTouchStart.bind(this));
        this.canvas.removeEventListener('touchmove', this.handleTouchMove.bind(this));
        this.canvas.removeEventListener('touchend', this.handleTouchEnd.bind(this));
        this.canvas.removeEventListener('touchcancel', this.handleTouchEnd.bind(this));
        
        // Mouse events (for desktop)
        this.canvas.addEventListener('mousedown', this.startDrawing.bind(this));
        this.canvas.addEventListener('mousemove', this.draw.bind(this));
        this.canvas.addEventListener('mouseup', this.stopDrawing.bind(this));
        this.canvas.addEventListener('mouseout', this.stopDrawing.bind(this));
        
        // TOUCH EVENTS (for mobile) - ITO ANG SOLUTION!
        this.canvas.addEventListener('touchstart', this.handleTouchStart.bind(this), { passive: false });
        this.canvas.addEventListener('touchmove', this.handleTouchMove.bind(this), { passive: false });
        this.canvas.addEventListener('touchend', this.handleTouchEnd.bind(this), { passive: false });
        this.canvas.addEventListener('touchcancel', this.handleTouchEnd.bind(this), { passive: false });
        
        // Prevent default touch behaviors sa buong modal
        const modal = this.canvas.closest('.modal-overlay');
        if (modal) {
            modal.addEventListener('touchmove', (e) => {
                if (this.drawing) {
                    e.preventDefault();
                }
            }, { passive: false });
        }
        
        // Color picker
        const colorPicker = document.getElementById('colorPicker');
        if (colorPicker) {
            colorPicker.removeEventListener('input', this.handleColorChange.bind(this));
            colorPicker.addEventListener('input', this.handleColorChange.bind(this));
        }
        
        console.log('âœ… Mobile touch listeners added');
    }

    handleTouchStart(e) {
        e.preventDefault(); // ITO ANG SUSI - pigilan ang page scroll/drag
        e.stopPropagation();
        
        if (!this.ctx || !this.canvas) return;
        
        const touch = e.touches[0];
        if (!touch) return;
        
        this.drawing = true;
        
        const rect = this.canvas.getBoundingClientRect();
        const scaleX = this.canvas.width / rect.width;
        const scaleY = this.canvas.height / rect.height;
        
        this.lastX = (touch.clientX - rect.left) * scaleX;
        this.lastY = (touch.clientY - rect.top) * scaleY;
        
        this.ctx.beginPath();
        this.ctx.moveTo(this.lastX, this.lastY);
    }

    handleTouchMove(e) {
        e.preventDefault(); // ITO ANG PINAKAIMPORTANTE - pigilan ang page drag
        e.stopPropagation();
        
        if (!this.drawing || !this.ctx || !this.canvas) return;
        
        const touch = e.touches[0];
        if (!touch) return;
        
        const rect = this.canvas.getBoundingClientRect();
        const scaleX = this.canvas.width / rect.width;
        const scaleY = this.canvas.height / rect.height;
        
        const currentX = (touch.clientX - rect.left) * scaleX;
        const currentY = (touch.clientY - rect.top) * scaleY;
        
        if (this.currentTool === 'pen') {
            this.ctx.lineTo(currentX, currentY);
            this.ctx.stroke();
        } else if (this.currentTool === 'eraser') {
            this.ctx.save();
            this.ctx.strokeStyle = '#ffffff';
            this.ctx.lineWidth = 20;
            this.ctx.lineTo(currentX, currentY);
            this.ctx.stroke();
            this.ctx.restore();
            
            if (this.ctx) {
                this.ctx.strokeStyle = this.color;
                this.ctx.lineWidth = this.lineWidth;
            }
        }
        
        this.lastX = currentX;
        this.lastY = currentY;
    }

    handleTouchEnd(e) {
        e.preventDefault();
        e.stopPropagation();
        
        this.drawing = false;
        if (this.ctx) {
            this.ctx.closePath();
        }
    }

    handleColorChange(e) {
        this.color = e.target.value;
        if (this.currentTool === 'pen' && this.ctx) {
            this.ctx.strokeStyle = this.color;
        }
    }

    startDrawing(e) {
        if (!this.ctx || !this.canvas) return;
        
        this.drawing = true;
        
        const rect = this.canvas.getBoundingClientRect();
        const scaleX = this.canvas.width / rect.width;
        const scaleY = this.canvas.height / rect.height;
        
        this.lastX = (e.clientX - rect.left) * scaleX;
        this.lastY = (e.clientY - rect.top) * scaleY;
        
        this.ctx.beginPath();
        this.ctx.moveTo(this.lastX, this.lastY);
    }

    draw(e) {
        if (!this.drawing || !this.ctx || !this.canvas) return;
        
        e.preventDefault();
        
        const rect = this.canvas.getBoundingClientRect();
        const scaleX = this.canvas.width / rect.width;
        const scaleY = this.canvas.height / rect.height;
        
        const currentX = (e.clientX - rect.left) * scaleX;
        const currentY = (e.clientY - rect.top) * scaleY;
        
        if (this.currentTool === 'pen') {
            this.ctx.lineTo(currentX, currentY);
            this.ctx.stroke();
        } else if (this.currentTool === 'eraser') {
            this.ctx.save();
            this.ctx.strokeStyle = '#ffffff';
            this.ctx.lineWidth = 20;
            this.ctx.lineTo(currentX, currentY);
            this.ctx.stroke();
            this.ctx.restore();
            
            if (this.ctx) {
                this.ctx.strokeStyle = this.color;
                this.ctx.lineWidth = this.lineWidth;
            }
        }
        
        this.lastX = currentX;
        this.lastY = currentY;
    }

    stopDrawing() {
        this.drawing = false;
        if (this.ctx) {
            this.ctx.closePath();
        }
    }

    setTool(tool) {
        this.currentTool = tool;
        console.log(`ðŸ–Œï¸ Tool changed to: ${tool}`);
        
        if (tool === 'pen') {
            this.lineWidth = 2;
            if (this.ctx) {
                this.ctx.strokeStyle = this.color;
                this.ctx.lineWidth = this.lineWidth;
            }
        } else if (tool === 'eraser') {
            this.lineWidth = 20;
            if (this.ctx) {
                this.ctx.strokeStyle = '#ffffff';
                this.ctx.lineWidth = this.lineWidth;
            }
        }
    }

    clear() {
        if (!this.ctx || !this.canvas) return;
        
        console.log('ðŸ§¹ Clearing whiteboard');
        
        this.ctx.fillStyle = '#ffffff';
        this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
        
        this.ctx.strokeStyle = this.color;
        this.ctx.lineWidth = this.lineWidth;
        this.ctx.lineCap = 'round';
        this.ctx.lineJoin = 'round';
        
        this.drawing = false;
    }
}


// ============================================
// ðŸš¨ EMERGENCY MOBILE WHITEBOARD FIX
// ============================================
(function fixWhiteboardForMobile() {
    console.log('ðŸ“± Applying emergency mobile whiteboard fix...');
    
    // Listen for when whiteboard modal opens
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                const modal = mutation.target;
                if (modal.id === 'whiteboardModal' && modal.classList.contains('active')) {
                    console.log('ðŸ“± Whiteboard modal opened - applying mobile fixes');
                    
                    setTimeout(() => {
                        const canvas = document.getElementById('whiteboardCanvas');
                        if (canvas) {
                            // Force disable all default touch behaviors
                            canvas.style.touchAction = 'none';
                            canvas.style.webkitTouchCallout = 'none';
                            canvas.style.webkitUserSelect = 'none';
                            canvas.style.userSelect = 'none';
                            
                            // Ensure canvas can capture touch events
                            canvas.addEventListener('touchstart', (e) => {
                                e.preventDefault();
                                e.stopPropagation();
                            }, { passive: false });
                            
                            canvas.addEventListener('touchmove', (e) => {
                                e.preventDefault();
                                e.stopPropagation();
                            }, { passive: false });
                            
                            canvas.addEventListener('touchend', (e) => {
                                e.preventDefault();
                                e.stopPropagation();
                            }, { passive: false });
                            
                            console.log('ðŸ“± Mobile touch events blocked on canvas');
                        }
                    }, 200);
                }
            }
        });
    });
    
    const whiteboardModal = document.getElementById('whiteboardModal');
    if (whiteboardModal) {
        observer.observe(whiteboardModal, { attributes: true });
    }
})();

// Add CSS to prevent page scrolling when drawing
const style = document.createElement('style');
style.textContent = `
    /* Prevent page scroll/drag when drawing on whiteboard */
    #whiteboardCanvas {
        touch-action: none !important;
        -webkit-touch-callout: none !important;
        -webkit-user-select: none !important;
        user-select: none !important;
        cursor: crosshair !important;
    }
    
    /* Ensure modal doesn't scroll */
    #whiteboardModal.modal-overlay.active {
        overflow: hidden !important;
    }
    
    #whiteboardModal .modal-body {
        overflow: hidden !important;
    }
`;
document.head.appendChild(style);

console.log('âœ… Mobile whiteboard fix applied');


// ============================================
// EMERGENCY FIX: Direct whiteboard button handler
// ============================================
document.addEventListener('DOMContentLoaded', function() {
    const whiteboardBtn = document.getElementById('openWhiteboard');
    
    if (whiteboardBtn) {
        whiteboardBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            console.log('ðŸŽ¨ Opening whiteboard');
            
            const modal = document.getElementById('whiteboardModal');
            
            if (modal) {
                // Hide all modals first
                document.querySelectorAll('.modal-overlay').forEach(m => {
                    m.style.display = 'none';
                    m.classList.remove('active');
                });
                
                // Show whiteboard modal
                modal.style.display = 'flex';
                modal.classList.add('active');
                
                // Initialize whiteboard
                setTimeout(() => {
                    if (window.toolManager && window.toolManager.tools && window.toolManager.tools.whiteboard) {
                        window.toolManager.tools.whiteboard.onOpen();
                    } else {
                        // Emergency direct initialization
                        const whiteboard = new Whiteboard();
                        window.tempWhiteboard = whiteboard;
                        whiteboard.onOpen();
                    }
                }, 200);
            }
        });
    }
});

// ========================================
// NOTEPAD TOOL
// ========================================
class Notepad {
    constructor() {
        this.notes = JSON.parse(localStorage.getItem('notes') || '[]');
        this.currentNoteId = null;
    }

    onOpen() {
        this.loadNotes();
    }

    save() {
        const title = document.getElementById('noteTitle').value || 'Untitled';
        const content = document.getElementById('noteContent').value;
        
        if (!content) {
            alert('Please write something before saving!');
            return;
        }

        const note = {
            id: Date.now(),
            title: title,
            content: content,
            created: new Date().toISOString()
        };

        this.notes.unshift(note);
        localStorage.setItem('notes', JSON.stringify(this.notes));
        
        alert('Note saved!');
        this.clear();
    }

    loadNotes() {
        // Display recent notes in a list (optional)
    }

    clear() {
        document.getElementById('noteTitle').value = '';
        document.getElementById('noteContent').value = '';
        this.currentNoteId = null;
    }
}

// ========================================
// FORMULA SHEET TOOL - FIXED VERSION
// ========================================
class FormulaSheet {
    constructor() {
        this.formulas = {
            polynomial: [
                { name: 'Quadratic Formula', formula: 'x = (-b Â± âˆš(bÂ² - 4ac)) / 2a' },
                { name: 'Synthetic Division', formula: 'P(x) Ã· (x - r) = Q(x) + R/(x - r)' },
                { name: 'Factor Theorem', formula: 'If P(r) = 0, then (x - r) is a factor' },
                { name: 'Remainder Theorem', formula: 'P(r) = remainder when P(x) Ã· (x - r)' }
            ],
            algebra: [
                { name: 'FOIL Method', formula: '(a + b)(c + d) = ac + ad + bc + bd' },
                { name: 'Perfect Square', formula: '(a + b)Â² = aÂ² + 2ab + bÂ²' },
                { name: 'Difference of Squares', formula: 'aÂ² - bÂ² = (a - b)(a + b)' }
            ],
            calculus: [
                { name: 'Power Rule', formula: 'd/dx [xâ¿] = nÂ·xâ¿â»Â¹' },
                { name: 'Product Rule', formula: 'd/dx [fÂ·g] = fÂ·g\' + f\'Â·g' },
                { name: 'Chain Rule', formula: 'd/dx [f(g(x))] = f\'(g(x))Â·g\'(x)' }
            ]
        };
        this.currentCategory = 'polynomial';
    }

    onOpen() {
        console.log('ðŸ“š Formula Sheet opened');
        this.showCategory('polynomial');
        this.setupCategoryButtons();
    }

    setupCategoryButtons() {
        // Remove existing event listeners and add new ones
        const categoryBtns = document.querySelectorAll('.formula-category-btn');
        
        categoryBtns.forEach(btn => {
            // Clone to remove old listeners
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            
            // Add new click handler
            newBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                const category = newBtn.getAttribute('data-category') || 
                                 newBtn.textContent.toLowerCase();
                
                this.showCategory(category);
                
                // Update active state
                document.querySelectorAll('.formula-category-btn').forEach(b => {
                    b.classList.remove('active');
                });
                newBtn.classList.add('active');
            });
        });
    }

    showCategory(category) {
        console.log(`ðŸ“– Showing category: ${category}`);
        
        this.currentCategory = category;
        
        // Get formulas for the selected category
        const formulas = this.formulas[category] || [];
        
        // Find the formula list container
        const listEl = document.getElementById('formulaList');
        if (!listEl) {
            console.error('âŒ Formula list container not found');
            return;
        }
        
        // Generate HTML
        if (formulas.length === 0) {
            listEl.innerHTML = '<p class="no-formulas">No formulas available for this category.</p>';
            return;
        }
        
        listEl.innerHTML = formulas.map(f => `
            <div class="formula-item">
                <div class="formula-name">${f.name}</div>
                <div class="formula-expression">${f.formula}</div>
            </div>
        `).join('');
        
        console.log(`âœ… Displayed ${formulas.length} formulas`);
    }
}

// ========================================
// STUDY TIMER TOOL - ULTIMATE FIXED VERSION WITH MUTATION OBSERVER
// ========================================
class StudyTimer {
    constructor() {
        this.timeLeft = 25 * 60; // 25 minutes in seconds
        this.initialTime = 25 * 60;
        this.timerId = null;
        this.isRunning = false;
        this.timerElement = null;
        self = this; // Store reference
        
        // Bind methods
        this.start = this.start.bind(this);
        this.pause = this.pause.bind(this);
        this.reset = this.reset.bind(this);
        this.setTime = this.setTime.bind(this);
        this.updateDisplay = this.updateDisplay.bind(this);
        this.findTimerElement = this.findTimerElement.bind(this);
    }

    findTimerElement() {
    // Try multiple ways to find the timer element
    let element = document.getElementById('timerDisplay');
    
    if (!element) {
        element = document.querySelector('.timer-display');
    }
    
    // If still not found, search in all modals
    if (!element) {
        const modals = document.querySelectorAll('.modal-overlay');
        for (let modal of modals) {
            if (modal.style.display === 'flex' || modal.classList.contains('active')) {
                element = modal.querySelector('#timerDisplay') || modal.querySelector('.timer-display');
                if (element) break;
            }
        }
    }
    
    return element;
}

    onOpen() {
    console.log('â±ï¸ Timer onOpen called');
    
    // Reset timer
    this.timeLeft = this.initialTime;
    this.isRunning = false;
    
    if (this.timerId) {
        clearInterval(this.timerId);
        this.timerId = null;
    }
    
    // Try multiple times to find and update the timer element
    const findAndUpdateTimer = () => {
        this.timerElement = this.findTimerElement();
        if (this.timerElement) {
            console.log('âœ… Timer element found');
            this.updateDisplay();
            this.attachEventListeners();
        } else {
            console.log('â±ï¸ Timer element not found, retrying...');
            setTimeout(findAndUpdateTimer, 100);
        }
    };
    
    // Start trying to find the element
    findAndUpdateTimer();
}

    updateDisplay() {
        // Find element if not stored
        if (!this.timerElement) {
            this.timerElement = this.findTimerElement();
        }
        
        if (this.timerElement) {
            const minutes = Math.floor(this.timeLeft / 60);
            const seconds = this.timeLeft % 60;
            const display = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Update the display
            this.timerElement.textContent = display;
            
            console.log(`â±ï¸ Timer display updated to: ${display}`);
        } else {
            console.warn('â±ï¸ Timer element not available for update');
            
            // Try to find it again
            this.timerElement = this.findTimerElement();
            if (this.timerElement) {
                this.updateDisplay();
            }
        }
    }

    attachEventListeners() {
        console.log('ðŸ”— Attaching timer event listeners');
        
        // Helper function to safely get button
        const getButton = (id) => {
            let btn = document.getElementById(id);
            
            // If not found, search in active modal
            if (!btn) {
                const activeModal = document.querySelector('.modal-overlay.active, .modal-overlay[style*="display: flex"]');
                if (activeModal) {
                    btn = activeModal.querySelector(`#${id}`) || activeModal.querySelector(`.${id}`);
                }
            }
            
            return btn;
        };
        
        // Get all buttons
        const startBtn = getButton('timerStartBtn');
        const pauseBtn = getButton('timerPauseBtn');
        const resetBtn = getButton('timerResetBtn');
        const btn15 = getButton('timer15min');
        const btn25 = getButton('timer25min');
        const btn50 = getButton('timer50min');
        
        console.log('Buttons found:', {
            start: !!startBtn,
            pause: !!pauseBtn,
            reset: !!resetBtn,
            btn15: !!btn15,
            btn25: !!btn25,
            btn50: !!btn50
        });
        
        // Remove old listeners and add new ones
        if (startBtn) {
            startBtn.replaceWith(startBtn.cloneNode(true));
            const newStartBtn = getButton('timerStartBtn');
            newStartBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                console.log('â–¶ï¸ Start clicked');
                this.start();
            });
        }
        
        if (pauseBtn) {
            pauseBtn.replaceWith(pauseBtn.cloneNode(true));
            const newPauseBtn = getButton('timerPauseBtn');
            newPauseBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                console.log('â¸ï¸ Pause clicked');
                this.pause();
            });
        }
        
        if (resetBtn) {
            resetBtn.replaceWith(resetBtn.cloneNode(true));
            const newResetBtn = getButton('timerResetBtn');
            newResetBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                console.log('ðŸ”„ Reset clicked');
                this.reset();
            });
        }
        
        if (btn15) {
            btn15.replaceWith(btn15.cloneNode(true));
            const newBtn15 = getButton('timer15min');
            newBtn15.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                console.log('â±ï¸ 15 min preset');
                this.setTime(15);
            });
        }
        
        if (btn25) {
            btn25.replaceWith(btn25.cloneNode(true));
            const newBtn25 = getButton('timer25min');
            newBtn25.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                this.setTime(25);
            });
        }
        
        if (btn50) {
            btn50.replaceWith(btn50.cloneNode(true));
            const newBtn50 = getButton('timer50min');
            newBtn50.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                this.setTime(50);
            });
        }
    }

    start() {
        console.log('â–¶ï¸ Timer start');
        
        if (!this.isRunning && this.timeLeft > 0) {
            this.isRunning = true;
            
            // Update display immediately
            this.updateDisplay();
            
            this.timerId = setInterval(() => {
                if (this.timeLeft > 0) {
                    this.timeLeft--;
                    this.updateDisplay();
                    
                    if (this.timeLeft <= 0) {
                        this.complete();
                    }
                }
            }, 1000);
        }
    }

    pause() {
        console.log('â¸ï¸ Timer pause');
        
        if (this.isRunning) {
            clearInterval(this.timerId);
            this.isRunning = false;
            this.timerId = null;
        }
        
        this.updateDisplay();
    }

    reset() {
        console.log('ðŸ”„ Timer reset');
        this.pause();
        this.timeLeft = this.initialTime;
        this.updateDisplay();
    }

    setTime(minutes) {
        console.log(`â±ï¸ Timer set to ${minutes} minutes`);
        this.pause();
        this.initialTime = minutes * 60;
        this.timeLeft = this.initialTime;
        this.updateDisplay();
    }

    complete() {
        console.log('ðŸŽ‰ Timer complete!');
        this.pause();
        
        // Show notification
        alert('ðŸŽ‰ Study session complete! Great job!');
        
        // Play sound
        try {
            const audio = new Audio('https://www.soundjay.com/misc/sounds/bell-ringing-05.mp3');
            audio.play();
        } catch (e) {
            console.log('Sound not available');
        }
        
        this.reset();
    }
}
// ============================================
// âœ… INITIALIZE TOOL MANAGER
// ============================================
window.toolManager = new ToolManager();
console.log('âœ… ToolManager initialized and attached to window');

// ========================================
// MAKE TOOLS GLOBALLY AVAILABLE
// ========================================
window.Calculator = Calculator;
window.GraphTool = GraphTool;
window.Whiteboard = Whiteboard;
window.Notepad = Notepad;
window.FormulaSheet = FormulaSheet;
window.StudyTimer = StudyTimer;

console.log('âœ… Tools globally available');

// ============================================
// FIXED HELPER FUNCTION FOR ALL API CALLS - WITH BETTER ERROR HANDLING
// ============================================
async function apiRequest(endpoint, options = {}) {
    const url = endpoint.startsWith('http') ? endpoint : `${API_BASE_URL}${endpoint}`;
    
    // Default headers
    const headers = {
        'Content-Type': 'application/json',
        'Accept': 'application/json', // Add this to request JSON responses
        ...options.headers
    };
    
    // Add auth token if available
    const token = localStorage.getItem('authToken') || authToken;
    if (token) {
        headers['Authorization'] = `Bearer ${token}`;
    }
    
    try {
        console.log(`ðŸ“¡ API Request: ${url}`);
        const response = await fetch(url, {
            ...options,
            headers
        });
        
        // Check if response is OK
        if (!response.ok) {
            const text = await response.text();
            console.error(`âŒ API Error (${response.status}):`, text.substring(0, 200));
            
            // Check if it's an HTML response (404 page)
            if (text.trim().startsWith('<!DOCTYPE') || text.trim().startsWith('<html')) {
                console.error('âš ï¸ Received HTML instead of JSON. Endpoint may not exist:', endpoint);
                
                // Return mock data for known endpoints
                if (endpoint.includes('/admin/structure')) {
                    return {
                        success: true,
                        structure: {
                            lessons: [],
                            modules: [],
                            topics: []
                        }
                    };
                }
                
                if (endpoint.includes('/api/progress/daily')) {
                    return {
                        success: true,
                        progress: {
                            lessons_completed: 0,
                            exercises_completed: 0,
                            time_spent_minutes: 0
                        }
                    };
                }
            }
            
            throw new Error(`API returned ${response.status}`);
        }
        
        // Check if response is JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const text = await response.text();
            console.warn('âš ï¸ Non-JSON response:', text.substring(0, 100));
            
            // If it's HTML but we expected JSON, return a mock response
            if (text.trim().startsWith('<!DOCTYPE') || text.trim().startsWith('<html')) {
                console.warn('âš ï¸ Received HTML when JSON expected for:', endpoint);
                return { success: true, data: text, isHtml: true };
            }
            
            return { success: true, data: text };
        }
        
        return await response.json();
        
    } catch (error) {
        console.error(`âŒ API Request Failed: ${url}`, error);
        
        // Return fallback data para hindi mag-crash ang app
        if (endpoint.includes('/api/progress/daily')) {
            return {
                success: true,
                progress: {
                    lessons_completed: 0,
                    exercises_completed: 0,
                    time_spent_minutes: 0
                }
            };
        }
        
        return { success: false, error: error.message };
    }
}


// Application State
const AppState = {
    currentUser: null,
    currentPage: 'loading',
    isAuthenticated: false,
    selectedApp: null,
    previousPage: null,
    hasSelectedApp: false,
    currentLessonData: null,
    currentVideoData: null
};

// Lesson State
const LessonState = {
    lessons: [],
    currentLesson: null,
    userProgress: {},
    continueLearningLesson: null,
    currentTopic: null
};

// Practice Exercises State
const PracticeState = {
    currentTopic: null,
    currentExercise: null,
    exercises: [],
    timer: 300, // 5 minutes
    timerInterval: null,
    isExerciseActive: false,
    isReviewMode: false,
    userPracticeProgress: {}
};



// ============================================
// ðŸ†• BAGONG QUIZ SYSTEM - HIWALAY SA LUMANG QUIZ
// ============================================
const QuizSystem = {
    currentQuiz: null,
    currentAttemptId: null,
    questions: [],
    currentIndex: 0,
    userAnswers: {},
    startTime: null,
    timerInterval: null,
    timeLeft: 0,
    totalTime: 0,
    stats: {
        correct: 0,
        wrong: 0,
        score: 0
    }
};

// Progress State
const ProgressState = {
    dailyProgress: null,
    weeklyProgress: null,
    monthlyProgress: null,
    learningGoals: [],
    topicMastery: {},
    moduleProgress: {},
    activityLog: [],
    dashboardStats: null,
    progressTrends: [],
    achievementTimeline: []
};

// Module Dashboard State
const ModuleState = {
    lessonProgress: 0,
    currentModule: null
};

// ============================================
// [NEW] STRUCTURE STATE - DATABASE DRIVEN
// ============================================
const StructureState = {
    lessons: [],
    modules: [],
    topics: [],
    isLoading: false,
    error: null,
    selectedLessonId: null,
    selectedModuleId: null,
    selectedTopicId: null,
    lastRefresh: null
};
let feedbackData = [];
// Add practice styles flag
let practiceStylesAdded = false;

// ============================================
// [NEW] ADMIN AUTHENTICATION SYNC
// ============================================

function syncMathHubAdminAuth() {
    console.log("ðŸ”„ [CRITICAL] Syncing MathHub admin authentication...");
    
    const authToken = localStorage.getItem('authToken');
    const userJson = localStorage.getItem('mathhub_user');
    
    if (authToken && userJson) {
        try {
            const user = JSON.parse(userJson);
            console.log("ðŸ‘¤ Current MathHub user:", user.username, "Role:", user.role);
            
            if (user.role === 'admin') {
                console.log("âœ… ADMIN DETECTED - Syncing admin tokens");
                localStorage.setItem('admin_token', authToken);
                localStorage.setItem('admin_user', userJson);
                localStorage.setItem('user_role', user.role);
                localStorage.setItem('admin_session', 'true');
                localStorage.setItem('token', authToken);
                
                console.log("âœ… Admin tokens synced for:", user.username);
                return true;
            } else {
                console.log(`â„¹ï¸ User is ${user.role} - not admin, clearing admin tokens`);
                clearAdminTokens();
            }
        } catch (e) {
            console.error("âŒ Failed to sync admin auth:", e);
            clearAdminTokens();
        }
    } else {
        console.log("â„¹ï¸ No MathHub user logged in - clearing admin tokens");
        clearAdminTokens();
    }
    return false;
}

function clearAdminTokens() {
    localStorage.removeItem('admin_token');
    localStorage.removeItem('admin_user');
    localStorage.removeItem('user_role');
    localStorage.removeItem('admin_session');
    localStorage.removeItem('token');
    console.log("ðŸ§¹ Admin tokens cleared");
}

// Run sync immediately
syncMathHubAdminAuth();

// ============================================
// [NEW] STRUCTURE MANAGEMENT - GENERAL MODULE SYSTEM
// ============================================

async function loadStructureFromDatabase(forceRefresh = false) {
    console.log("ðŸ“š Loading structure from database...");
    
    if (!forceRefresh && StructureState.lessons.length > 0 && StructureState.lastRefresh) {
        const fiveMinutesAgo = Date.now() - 5 * 60 * 1000;
        if (StructureState.lastRefresh > fiveMinutesAgo) {
            console.log("ðŸ“¦ Using cached structure");
            return true;
        }
    }
    
    StructureState.isLoading = true;
    
    try {
        const data = await apiRequest('/api/admin/structure');
        
        if (data.success) {
            StructureState.lessons = data.structure?.lessons || [];
            StructureState.modules = data.structure?.modules || [];
            StructureState.topics = data.structure?.topics || [];
            StructureState.lastRefresh = Date.now();
            
            console.log(`âœ… Structure loaded:`, {
                lessons: StructureState.lessons.length,
                modules: StructureState.modules.length,
                topics: StructureState.topics.length
            });
            
            return true;
        } else {
            throw new Error(data.message || 'Failed to load structure');
        }
    } catch (error) {
        console.error('âŒ Error loading structure:', error);
        StructureState.error = error.message;
        return false;
    } finally {
        StructureState.isLoading = false;
    }
}

/**
 * POPULATE LESSON DROPDOWN
 */
function populateLessonDropdown(selectElementId = 'lessonSelect') {
    const select = document.getElementById(selectElementId);
    if (!select) return;
    
    select.innerHTML = '<option value="">-- Select Lesson (Optional) --</option>';
    
    if (StructureState.lessons.length === 0) {
        const option = document.createElement('option');
        option.value = '';
        option.textContent = '-- No lessons available --';
        option.disabled = true;
        select.appendChild(option);
        
        // Add create option
        const createOption = document.createElement('option');
        createOption.value = 'create_lesson';
        createOption.textContent = 'âž• Create New Lesson...';
        createOption.style.color = '#7a0000';
        createOption.style.fontWeight = 'bold';
        select.appendChild(createOption);
        return;
    }
    
    StructureState.lessons.forEach(lesson => {
        const option = document.createElement('option');
        option.value = lesson.id;
        option.textContent = lesson.name;
        select.appendChild(option);
    });
    
    // Add create option at the end
    const createOption = document.createElement('option');
    createOption.value = 'create_lesson';
    createOption.textContent = 'âž• Create New Lesson...';
    createOption.style.color = '#7a0000';
    createOption.style.fontWeight = 'bold';
    select.appendChild(createOption);
}

/**
 * POPULATE MODULE DROPDOWN BASED ON SELECTED LESSON
 */
function populateModuleDropdown(selectElementId = 'moduleSelect', lessonId = null) {
    const select = document.getElementById(selectElementId);
    if (!select) return;
    
    select.innerHTML = '<option value="">-- Select Module (Optional) --</option>';
    select.disabled = true;
    
    // If no lesson selected, just show disabled dropdown
    if (!lessonId) {
        return;
    }
    
    // Filter modules by lesson ID
    const filteredModules = StructureState.modules.filter(module => 
        module.lesson_id == lessonId
    );
    
    if (filteredModules.length === 0) {
        // No modules found - add option to create new module
        const noModuleOption = document.createElement('option');
        noModuleOption.value = '';
        noModuleOption.textContent = '-- No modules available --';
        noModuleOption.disabled = true;
        select.appendChild(noModuleOption);
        
        const createOption = document.createElement('option');
        createOption.value = 'create_module';
        createOption.textContent = 'âž• Create New Module...';
        createOption.style.color = '#7a0000';
        createOption.style.fontWeight = 'bold';
        select.appendChild(createOption);
        
        select.disabled = false;
        return;
    }
    
    filteredModules.forEach(module => {
        const option = document.createElement('option');
        option.value = module.id;
        option.textContent = module.name;
        select.appendChild(option);
    });
    
    // Add create option at the end
    const createOption = document.createElement('option');
    createOption.value = 'create_module';
    createOption.textContent = 'âž• Create New Module...';
    createOption.style.color = '#7a0000';
    createOption.style.fontWeight = 'bold';
    select.appendChild(createOption);
    
    select.disabled = false;
}

/**
 * POPULATE TOPIC DROPDOWN BASED ON SELECTED MODULE
 */
function populateTopicDropdown(selectElementId = 'topicSelect', moduleId = null) {
    const select = document.getElementById(selectElementId);
    if (!select) return;
    
    select.innerHTML = '<option value="">-- Select Topic * --</option>';
    
    if (!moduleId) {
        // If no module selected, show all topics
        if (StructureState.topics.length === 0) {
            const option = document.createElement('option');
            option.value = '';
            option.textContent = '-- No topics available --';
            option.disabled = true;
            select.appendChild(option);
            
            const createOption = document.createElement('option');
            createOption.value = 'create_topic';
            createOption.textContent = 'âž• Create New Topic...';
            createOption.style.color = '#7a0000';
            createOption.style.fontWeight = 'bold';
            select.appendChild(createOption);
        } else {
            StructureState.topics.forEach(topic => {
                const option = document.createElement('option');
                option.value = topic.id;
                option.textContent = topic.name;
                select.appendChild(option);
            });
            
            const createOption = document.createElement('option');
            createOption.value = 'create_topic';
            createOption.textContent = 'âž• Create New Topic...';
            createOption.style.color = '#7a0000';
            createOption.style.fontWeight = 'bold';
            select.appendChild(createOption);
        }
        return;
    }
    
    // Filter topics by module ID
    const filteredTopics = StructureState.topics.filter(topic => 
        topic.module_id == moduleId
    );
    
    if (filteredTopics.length === 0) {
        // No topics found - add option to create new topic
        const noTopicOption = document.createElement('option');
        noTopicOption.value = '';
        noTopicOption.textContent = '-- No topics available --';
        noTopicOption.disabled = true;
        select.appendChild(noTopicOption);
        
        const createOption = document.createElement('option');
        createOption.value = 'create_topic';
        createOption.textContent = 'âž• Create New Topic...';
        createOption.style.color = '#7a0000';
        createOption.style.fontWeight = 'bold';
        select.appendChild(createOption);
    } else {
        filteredTopics.forEach(topic => {
            const option = document.createElement('option');
            option.value = topic.id;
            option.textContent = topic.name;
            select.appendChild(option);
        });
        
        const createOption = document.createElement('option');
        createOption.value = 'create_topic';
        createOption.textContent = 'âž• Create New Topic...';
        createOption.style.color = '#7a0000';
        createOption.style.fontWeight = 'bold';
        select.appendChild(createOption);
    }
}

/**
 * SETUP CASCADING DROPDOWNS
 */
function setupCascadingDropdowns() {
    console.log("ðŸ”— Setting up cascading dropdowns...");
    
    // Lesson change handler
    const lessonSelect = document.getElementById('lessonSelect');
    if (lessonSelect) {
        // Remove existing listeners to avoid duplicates
        const newLessonSelect = lessonSelect.cloneNode(true);
        lessonSelect.parentNode.replaceChild(newLessonSelect, lessonSelect);
        
        newLessonSelect.addEventListener('change', function(e) {
            const lessonId = this.value;
            StructureState.selectedLessonId = lessonId || null;
            
            // Check if "Create New Lesson" was selected
            if (lessonId === 'create_lesson') {
                openQuickLessonModal();
                this.value = ''; // Reset selection
                return;
            }
            
            // Update module dropdown
            populateModuleDropdown('moduleSelect', lessonId);
            
            // Reset module dropdown value
            const moduleSelect = document.getElementById('moduleSelect');
            if (moduleSelect) {
                moduleSelect.value = '';
            }
            
            // Reset and update topic dropdown
            populateTopicDropdown('topicSelect', null);
        });
    }
    
    // Module change handler
    const moduleSelect = document.getElementById('moduleSelect');
    if (moduleSelect) {
        const newModuleSelect = moduleSelect.cloneNode(true);
        moduleSelect.parentNode.replaceChild(newModuleSelect, moduleSelect);
        
        newModuleSelect.addEventListener('change', function() {
            const moduleId = this.value;
            StructureState.selectedModuleId = moduleId || null;
            
            // Check if "Create New Module" was selected
            if (moduleId === 'create_module') {
                openQuickModuleModal();
                this.value = ''; // Reset selection
                return;
            }
            
            // Update topic dropdown
            populateTopicDropdown('topicSelect', moduleId);
        });
    }
    
    // Topic change handler
    const topicSelect = document.getElementById('topicSelect');
    if (topicSelect) {
        const newTopicSelect = topicSelect.cloneNode(true);
        topicSelect.parentNode.replaceChild(newTopicSelect, topicSelect);
        
        newTopicSelect.addEventListener('change', function() {
            const topicId = this.value;
            StructureState.selectedTopicId = topicId || null;
            
            // Check if "Create New Topic" was selected
            if (topicId === 'create_topic') {
                openQuickTopicModal();
                this.value = ''; // Reset selection
                return;
            }
        });
    }
}

/**
 * CREATE NEW LESSON IN DATABASE
 */
async function createLesson(lessonName) {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) {
            throw new Error('No auth token available');
        }
        
        console.log(`ðŸ“š Creating new lesson: ${lessonName}`);
        
        const response = await fetch(`/api/admin/lessons`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                lesson_name: lessonName
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            console.log('âœ… Lesson created:', data.lesson);
            await loadStructureFromDatabase(true); // Force refresh structure
            return data.lesson;
        } else {
            throw new Error(data.message || 'Failed to create lesson');
        }
    } catch (error) {
        console.error('âŒ Error creating lesson:', error);
        showNotification('error', 'Failed', error.message);
        return null;
    }
}

/**
 * CREATE NEW MODULE IN DATABASE
 */
async function createModule(lessonId, moduleName, moduleDescription = '') {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) {
            throw new Error('No auth token available');
        }
        
        if (!lessonId) {
            throw new Error('Please select a lesson first');
        }
        
        console.log(`ðŸ“¦ Creating new module: ${moduleName} for lesson ${lessonId}`);
        
        const response = await fetch(`/api/admin/modules`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                lesson_id: parseInt(lessonId),
                module_name: moduleName,
                module_description: moduleDescription
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            console.log('âœ… Module created:', data.module);
            await loadStructureFromDatabase(true); // Force refresh structure
            
            // Update module dropdown with new module selected
            populateModuleDropdown('moduleSelect', lessonId);
            setTimeout(() => {
                const moduleSelect = document.getElementById('moduleSelect');
                if (moduleSelect) {
                    moduleSelect.value = data.module.id;
                }
            }, 100);
            
            return data.module;
        } else {
            throw new Error(data.message || 'Failed to create module');
        }
    } catch (error) {
        console.error('âŒ Error creating module:', error);
        showNotification('error', 'Failed', error.message);
        return null;
    }
}

/**
 * CREATE NEW TOPIC IN DATABASE
 */
async function createTopic(moduleId, topicName, topicDescription = '') {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) {
            throw new Error('No auth token available');
        }
        
        if (!moduleId) {
            throw new Error('Please select a module first');
        }
        
        console.log(`ðŸ“Œ Creating new topic: ${topicName} for module ${moduleId}`);
        
        const response = await fetch(`/api/admin/topics`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                module_id: parseInt(moduleId),
                topic_title: topicName,
                topic_description: topicDescription
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            console.log('âœ… Topic created:', data.topic);
            await loadStructureFromDatabase(true); // Force refresh structure
            
            // Update topic dropdown with new topic selected
            populateTopicDropdown('topicSelect', moduleId);
            setTimeout(() => {
                const topicSelect = document.getElementById('topicSelect');
                if (topicSelect) {
                    topicSelect.value = data.topic.id;
                }
            }, 100);
            
            return data.topic;
        } else {
            throw new Error(data.message || 'Failed to create topic');
        }
    } catch (error) {
        console.error('âŒ Error creating topic:', error);
        showNotification('error', 'Failed', error.message);
        return null;
    }
}

// ============================================
// QUICK LESSON MODAL - CREATE LESSON ON THE FLY
// ============================================

function openQuickLessonModal() {
    console.log("ðŸ“š Opening quick lesson modal...");
    
    // Check if modal already exists
    let modal = document.getElementById('quickLessonModal');
    
    if (!modal) {
        // Create modal
        modal = document.createElement('div');
        modal.id = 'quickLessonModal';
        modal.className = 'modal';
        modal.style.display = 'none';
        
        modal.innerHTML = `
            <div class="modal-backdrop" onclick="closeQuickLessonModal()"></div>
            <div class="modal-content" style="max-width: 450px;">
                <div class="modal-header" style="background: #7a0000; color: white;">
                    <h3 style="margin: 0;"><i class="fas fa-book"></i> Create New Lesson</h3>
                    <button class="modal-close" onclick="closeQuickLessonModal()" style="color: white;">&times;</button>
                </div>
                <div class="modal-body" style="padding: 25px;">
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">
                            <i class="fas fa-heading"></i> Lesson Name <span style="color: red;">*</span>
                        </label>
                        <input type="text" id="quickLessonName" class="form-control" 
                               placeholder="e.g., Polynomial Functions" style="width: 100%; padding: 10px;">
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">
                            <i class="fas fa-align-left"></i> Description (Optional)
                        </label>
                        <textarea id="quickLessonDescription" class="form-control" 
                                  placeholder="Describe what this lesson covers..." 
                                  rows="3" style="width: 100%; padding: 10px;"></textarea>
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button class="btn btn-secondary" onclick="closeQuickLessonModal()">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button class="btn btn-primary" onclick="saveQuickLesson()" 
                                style="background: #7a0000; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                            <i class="fas fa-save"></i> Create Lesson
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
    }
    
    // Show modal
    modal.style.display = 'flex';
    modal.style.zIndex = '10003';
    document.body.classList.add('modal-open');
    
    // Focus on input
    setTimeout(() => {
        const input = document.getElementById('quickLessonName');
        if (input) input.focus();
    }, 300);
}

function closeQuickLessonModal() {
    const modal = document.getElementById('quickLessonModal');
    if (modal) {
        modal.style.display = 'none';
        document.body.classList.remove('modal-open');
    }
}

async function saveQuickLesson() {
    const lessonName = document.getElementById('quickLessonName')?.value.trim();
    const lessonDescription = document.getElementById('quickLessonDescription')?.value.trim();
    
    if (!lessonName) {
        showNotification('error', 'Error', 'Please enter a lesson name');
        return;
    }
    
    // Show loading
    const saveBtn = document.querySelector('#quickLessonModal .btn-primary');
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
    saveBtn.disabled = true;
    
    try {
        const lesson = await createLesson(lessonName);
        
        if (lesson) {
            showNotification('success', 'Success!', `Lesson "${lessonName}" created successfully!`);
            closeQuickLessonModal();
            
            // Refresh the main lesson dropdown
            populateLessonDropdown('lessonSelect');
        }
    } finally {
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
    }
}

// ============================================
// QUICK MODULE MODAL - CREATE MODULE ON THE FLY
// ============================================

function openQuickModuleModal() {
    console.log("ðŸ“¦ Opening quick module modal...");
    
    // Check if modal already exists
    let modal = document.getElementById('quickModuleModal');
    
    if (!modal) {
        // Create modal
        modal = document.createElement('div');
        modal.id = 'quickModuleModal';
        modal.className = 'modal';
        modal.style.display = 'none';
        
        modal.innerHTML = `
            <div class="modal-backdrop" onclick="closeQuickModuleModal()"></div>
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header" style="background: #7a0000; color: white;">
                    <h3 style="margin: 0;"><i class="fas fa-cubes"></i> Create New Module</h3>
                    <button class="modal-close" onclick="closeQuickModuleModal()" style="color: white;">&times;</button>
                </div>
                <div class="modal-body" style="padding: 25px;">
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">
                            <i class="fas fa-book"></i> Select Lesson <span style="color: red;">*</span>
                        </label>
                        <select id="quickModuleLessonSelect" class="form-control" style="width: 100%; padding: 10px;">
                            <option value="">-- Select Lesson --</option>
                        </select>
                        <small style="color: #666; display: block; margin-top: 5px;">
                            Choose the lesson where this module belongs
                        </small>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">
                            <i class="fas fa-tag"></i> Module Name <span style="color: red;">*</span>
                        </label>
                        <input type="text" id="quickModuleName" class="form-control" 
                               placeholder="e.g., Introduction to Polynomials" style="width: 100%; padding: 10px;">
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">
                            <i class="fas fa-align-left"></i> Module Description (Optional)
                        </label>
                        <textarea id="quickModuleDescription" class="form-control" 
                                  placeholder="Describe what this module covers..." 
                                  rows="3" style="width: 100%; padding: 10px;"></textarea>
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button class="btn btn-secondary" onclick="closeQuickModuleModal()">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button class="btn btn-primary" onclick="saveQuickModule()" 
                                style="background: #7a0000; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                            <i class="fas fa-save"></i> Create Module
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
    }
    
    // Populate lesson dropdown
    const lessonSelect = document.getElementById('quickModuleLessonSelect');
    if (lessonSelect) {
        lessonSelect.innerHTML = '<option value="">-- Select Lesson --</option>';
        
        if (StructureState.lessons.length === 0) {
            const option = document.createElement('option');
            option.value = '';
            option.textContent = '-- No lessons available --';
            option.disabled = true;
            lessonSelect.appendChild(option);
            
            const createOption = document.createElement('option');
            createOption.value = 'create_lesson';
            createOption.textContent = 'âž• Create New Lesson...';
            createOption.style.color = '#7a0000';
            createOption.style.fontWeight = 'bold';
            lessonSelect.appendChild(createOption);
        } else {
            StructureState.lessons.forEach(lesson => {
                const option = document.createElement('option');
                option.value = lesson.id;
                option.textContent = lesson.name;
                lessonSelect.appendChild(option);
            });
            
            const createOption = document.createElement('option');
            createOption.value = 'create_lesson';
            createOption.textContent = 'âž• Create New Lesson...';
            createOption.style.color = '#7a0000';
            createOption.style.fontWeight = 'bold';
            lessonSelect.appendChild(createOption);
        }
    }
    
    // Handle create lesson option
    lessonSelect.addEventListener('change', function(e) {
        if (this.value === 'create_lesson') {
            closeQuickModuleModal();
            openQuickLessonModal();
        }
    });
    
    // Show modal
    modal.style.display = 'flex';
    modal.style.zIndex = '10002';
    document.body.classList.add('modal-open');
}

function closeQuickModuleModal() {
    const modal = document.getElementById('quickModuleModal');
    if (modal) {
        modal.style.display = 'none';
        document.body.classList.remove('modal-open');
    }
}

async function saveQuickModule() {
    const lessonId = document.getElementById('quickModuleLessonSelect')?.value;
    const moduleName = document.getElementById('quickModuleName')?.value.trim();
    const moduleDescription = document.getElementById('quickModuleDescription')?.value.trim();
    
    if (!lessonId) {
        showNotification('error', 'Error', 'Please select a lesson');
        return;
    }
    
    if (!moduleName) {
        showNotification('error', 'Error', 'Please enter a module name');
        return;
    }
    
    // Show loading
    const saveBtn = document.querySelector('#quickModuleModal .btn-primary');
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
    saveBtn.disabled = true;
    
    try {
        const module = await createModule(lessonId, moduleName, moduleDescription);
        
        if (module) {
            showNotification('success', 'Success!', `Module "${moduleName}" created successfully!`);
            closeQuickModuleModal();
            
            // Refresh the main module dropdown if it exists
            const lessonSelect = document.getElementById('lessonSelect');
            if (lessonSelect && lessonSelect.value) {
                populateModuleDropdown('moduleSelect', lessonSelect.value);
            }
        }
    } finally {
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
    }
}

// ============================================
// QUICK TOPIC MODAL - CREATE TOPIC ON THE FLY
// ============================================

function openQuickTopicModal() {
    console.log("ðŸ“ Opening quick topic modal...");
    
    // Check if modal already exists
    let modal = document.getElementById('quickTopicModal');
    
    if (!modal) {
        // Create modal
        modal = document.createElement('div');
        modal.id = 'quickTopicModal';
        modal.className = 'modal';
        modal.style.display = 'none';
        
        modal.innerHTML = `
            <div class="modal-backdrop" onclick="closeQuickTopicModal()"></div>
            <div class="modal-content" style="max-width: 550px;">
                <div class="modal-header" style="background: #7a0000; color: white;">
                    <h3 style="margin: 0;"><i class="fas fa-tag"></i> Create New Topic</h3>
                    <button class="modal-close" onclick="closeQuickTopicModal()" style="color: white;">&times;</button>
                </div>
                <div class="modal-body" style="padding: 25px;">
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">
                            <i class="fas fa-cube"></i> Select Module <span style="color: red;">*</span>
                        </label>
                        <select id="quickTopicModuleSelect" class="form-control" style="width: 100%; padding: 10px;">
                            <option value="">-- Select Module --</option>
                        </select>
                        <div style="margin-top: 8px;">
                            <button class="btn btn-sm btn-outline" onclick="openQuickModuleModal()" style="color: #7a0000; border-color: #7a0000;">
                                <i class="fas fa-plus-circle"></i> Create New Module First
                            </button>
                        </div>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">
                            <i class="fas fa-heading"></i> Topic Title <span style="color: red;">*</span>
                        </label>
                        <input type="text" id="quickTopicTitle" class="form-control" 
                               placeholder="e.g., What is a Polynomial?" style="width: 100%; padding: 10px;">
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">
                            <i class="fas fa-align-left"></i> Topic Description (Optional)
                        </label>
                        <textarea id="quickTopicDescription" class="form-control" 
                                  placeholder="Describe what this topic covers..." 
                                  rows="4" style="width: 100%; padding: 10px;"></textarea>
                    </div>
                    <div style="margin-bottom: 20px; background: #f5f5f5; padding: 12px; border-radius: 6px;">
                        <p style="margin: 0; color: #666; font-size: 0.9rem;">
                            <i class="fas fa-info-circle"></i> 
                            <strong>Note:</strong> Topics are required for creating lessons. 
                            Each topic belongs to a module, and modules belong to lessons.
                        </p>
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button class="btn btn-secondary" onclick="closeQuickTopicModal()">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button class="btn btn-primary" onclick="saveQuickTopic()" 
                                style="background: #7a0000; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                            <i class="fas fa-save"></i> Create Topic
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
    }
    
    // Populate module dropdown
    populateQuickTopicModuleDropdown();
    
    // Show modal
    modal.style.display = 'flex';
    modal.style.zIndex = '10001';
    document.body.classList.add('modal-open');
}

function closeQuickTopicModal() {
    const modal = document.getElementById('quickTopicModal');
    if (modal) {
        modal.style.display = 'none';
        document.body.classList.remove('modal-open');
    }
}

function populateQuickTopicModuleDropdown() {
    const moduleSelect = document.getElementById('quickTopicModuleSelect');
    if (!moduleSelect) return;
    
    moduleSelect.innerHTML = '<option value="">-- Select Module --</option>';
    
    if (StructureState.modules.length === 0) {
        const option = document.createElement('option');
        option.value = '';
        option.textContent = '-- No modules available --';
        option.disabled = true;
        moduleSelect.appendChild(option);
        
        const createOption = document.createElement('option');
        createOption.value = 'create_module';
        createOption.textContent = 'âž• Create New Module...';
        createOption.style.color = '#7a0000';
        createOption.style.fontWeight = 'bold';
        moduleSelect.appendChild(createOption);
    } else {
        StructureState.modules.forEach(module => {
            // Find the lesson name for this module
            const lesson = StructureState.lessons.find(l => l.id == module.lesson_id);
            const lessonName = lesson ? lesson.name : 'Unknown Lesson';
            
            const option = document.createElement('option');
            option.value = module.id;
            option.textContent = `${module.name} (${lessonName})`;
            moduleSelect.appendChild(option);
        });
        
        const createOption = document.createElement('option');
        createOption.value = 'create_module';
        createOption.textContent = 'âž• Create New Module...';
        createOption.style.color = '#7a0000';
        createOption.style.fontWeight = 'bold';
        moduleSelect.appendChild(createOption);
    }
    
    // Handle create module option
    moduleSelect.addEventListener('change', function(e) {
        if (this.value === 'create_module') {
            closeQuickTopicModal();
            openQuickModuleModal();
        }
    });
}

async function saveQuickTopic() {
    const moduleId = document.getElementById('quickTopicModuleSelect')?.value;
    const topicTitle = document.getElementById('quickTopicTitle')?.value.trim();
    const topicDescription = document.getElementById('quickTopicDescription')?.value.trim();
    
    if (!moduleId) {
        showNotification('error', 'Error', 'Please select a module');
        return;
    }
    
    if (!topicTitle) {
        showNotification('error', 'Error', 'Please enter a topic title');
        return;
    }
    
    // Show loading
    const saveBtn = document.querySelector('#quickTopicModal .btn-primary');
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
    saveBtn.disabled = true;
    
    try {
        const topic = await createTopic(moduleId, topicTitle, topicDescription);
        
        if (topic) {
            showNotification('success', 'Success!', `Topic "${topicTitle}" created successfully!`);
            closeQuickTopicModal();
            
            // Refresh the main topic dropdown if it exists
            const moduleSelect = document.getElementById('moduleSelect');
            if (moduleSelect && moduleSelect.value) {
                populateTopicDropdown('topicSelect', moduleSelect.value);
            } else {
                populateTopicDropdown('topicSelect', null);
            }
        }
    } finally {
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
    }
}

// ============================================
// CREATE LESSON MODAL - WITH GENERAL DROPDOWNS
// ============================================

async function openCreateLessonPopup() {
    console.log("âž• Opening Create Lesson Modal...");
    
    const modal = document.getElementById('createLessonModal');
    if (!modal) {
        console.error("âŒ Create lesson modal not found!");
        return;
    }
    
    // Clear edit ID
    const editId = document.getElementById('editLessonId');
    if (editId) {
        editId.value = '';
    }
    
    // Show loading state
    const statusDiv = document.getElementById('createLessonStatus');
    if (statusDiv) {
        statusDiv.style.display = 'block';
        statusDiv.innerHTML = `
            <div style="background: #e3f2fd; color: #1976d2; padding: 10px 15px; border-radius: 6px;">
                <i class="fas fa-spinner fa-spin"></i> Loading structure from database...
            </div>
        `;
    }
    
    // Load structure from database FIRST
    await loadStructureFromDatabase();
    
    // Hide loading
    if (statusDiv) {
        statusDiv.style.display = 'none';
    }
    
    // Populate all dropdowns
    populateLessonDropdown('lessonSelect');
    populateModuleDropdown('moduleSelect', null);
    populateTopicDropdown('topicSelect', null);
    
    // Setup cascading dropdowns
    setupCascadingDropdowns();
    
    // Show modal
    modal.style.display = 'flex';
    modal.style.zIndex = '9999';
    document.body.classList.add('modal-open');
    
    // Focus on title input
    setTimeout(() => {
        const titleInput = document.getElementById('createLessonTitle');
        if (titleInput) {
            titleInput.focus();
        }
    }, 300);
    
    showNotification('info', 'Create Lesson', 'Fill in the lesson details. Topic is required.');
}

function closeCreateLessonModal() {
    console.log("ðŸ”´ Closing create lesson modal...");
    const modal = document.getElementById('createLessonModal');
    if (modal) {
        modal.style.display = 'none';
        document.body.classList.remove('modal-open');
    }
}

// ============================================
// SAVE LESSON TO DATABASE - WITH TOPIC_ID - FIXED VERSION
// ============================================

async function saveLessonToMySQL() {
    console.log("=== SAVING TO MYSQL DATABASE ===");
    
    try {
        // Get form values
        const title = document.getElementById('createLessonTitle')?.value.trim();
        const description = document.getElementById('createLessonDescription')?.value.trim();
        const topicId = document.getElementById('topicSelect')?.value;
        const editLessonId = document.getElementById('editLessonId')?.value || '';
        const isUpdate = editLessonId && editLessonId !== '';
        
        console.log("ðŸ“‹ Form values:", { title, description, topicId, isUpdate, editLessonId });
        
        // VALIDATION
        if (!title) {
            showNotification('error', 'Error', 'Please enter a lesson title');
            return;
        }
        
        if (!description) {
            showNotification('error', 'Error', 'Please enter a lesson description');
            return;
        }
        
        if (!topicId) {
            showNotification('error', 'Error', 'Please select a topic');
            return;
        }
        
        // Check if topic exists in database
        const topicExists = StructureState.topics.some(t => t.id == topicId);
        if (!topicExists) {
            showNotification('error', 'Error', 'Selected topic does not exist in database');
            return;
        }
        
        // Determine content type
        const videoFileInput = document.getElementById('videoFileInput');
        const videoFile = videoFileInput?.files[0];
        const youtubeUrlInput = document.getElementById('videoYoutubeUrl');
        const youtubeUrl = youtubeUrlInput?.value;
        const pdfFileInput = document.getElementById('pdfFileInput');
        const pdfFile = pdfFileInput?.files[0];
        const textContentInput = document.getElementById('textContentInput');
        const textContent = textContentInput?.value;
        
        let contentType = 'text';
        if (videoFile || youtubeUrl) {
            contentType = 'video';
            console.log("ðŸŽ¬ Video content detected");
        } else if (pdfFile) {
            contentType = 'pdf';
        }
        
        // Get auth token
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) {
            showNotification('error', 'Auth Error', 'Please login again');
            return;
        }
        
        // Show loading state
        showNotification('info', 'Saving', 'Uploading lesson to MySQL...');
        
        const saveBtn = document.querySelector('#createLessonModal .btn-primary, #saveLessonBtn');
        if (saveBtn) {
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        }
        
        // ===== STEP 1: Kung bagong lesson, gumawa muna para makuha ang ID =====
        let finalContentId = editLessonId;
        
        if (!isUpdate) {
            console.log("ðŸ“ Creating new lesson to get ID first...");
            
            const createResponse = await fetch('/api/admin/lessons/create-temp', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    title: title,
                    description: description,
                    topic_id: parseInt(topicId)
                })
            });
            
            if (!createResponse.ok) {
                throw new Error(`Failed to create lesson: ${createResponse.status}`);
            }
            
            const createData = await createResponse.json();
            
            if (!createData.success || !createData.content_id) {
                throw new Error(createData.message || 'Failed to create lesson');
            }
            
            finalContentId = createData.content_id;
            console.log(`âœ… Created lesson with ID: ${finalContentId}`);
        }
        
        // ===== STEP 2: I-update ang lesson kasama ang video =====
        const formData = new FormData();
        formData.append('title', title);
        formData.append('description', description);
        formData.append('topic_id', parseInt(topicId));
        formData.append('content_type', contentType);
        formData.append('content_id', finalContentId); // CRITICAL: I-attach ang content_id
        
        // Add content based on type
        if (contentType === 'video') {
            if (youtubeUrl && youtubeUrl.trim() !== '') {
                formData.append('youtube_url', youtubeUrl);
                console.log(`ðŸ”— Adding YouTube URL for lesson ${finalContentId}:`, youtubeUrl);
            }
            if (videoFile) {
                formData.append('video_file', videoFile);
                console.log(`ðŸŽ¬ Adding video file for lesson ${finalContentId}:`, videoFile.name);
            }
        } else if (contentType === 'pdf') {
            if (pdfFile) {
                formData.append('pdf_file', pdfFile);
            }
        } else if (contentType === 'text') {
            if (textContent) {
                formData.append('text_content', textContent);
            }
        }
        
        // Send to server para i-update
        console.log(`ðŸ“¡ Sending update request for lesson ${finalContentId}...`);
        
        const response = await fetch('/api/admin/lessons', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`
            },
            body: formData
        });
        
        console.log("ðŸ“¥ Response status:", response.status);
        
        let result;
        try {
            const responseText = await response.text();
            console.log("ðŸ“„ Response text:", responseText);
            
            if (responseText) {
                result = JSON.parse(responseText);
            } else {
                throw new Error('Empty response from server');
            }
        } catch (parseError) {
            console.error("âŒ Parse error:", parseError);
            throw new Error('Invalid server response');
        }
        
        if (!response.ok) {
            throw new Error(result.message || `Server error: ${response.status}`);
        }
        
        if (result.success) {
            showNotification('success', 'Success!', 
                isUpdate ? 'Lesson updated successfully!' : 'Lesson saved successfully!');
            
            closeCreateLessonModal();
            resetLessonForm();
            
            if (editId) {
                editId.value = '';
            }
            
            // Refresh structure
            await loadStructureFromDatabase(true);
            
            // Refresh lessons list
            if (typeof loadAdminLessons === 'function') {
                setTimeout(() => {
                    loadAdminLessons();
                }, 500);
            }
            
            return result;
        } else {
            throw new Error(result.message || 'Failed to save lesson');
        }
        
    } catch (error) {
        console.error('âŒ SAVE ERROR:', error);
        showNotification('error', 'Save Failed', error.message);
    } finally {
        const saveBtn = document.querySelector('#createLessonModal .btn-primary, #saveLessonBtn');
        if (saveBtn) {
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Lesson';
        }
    }
}


function resetLessonForm() {
    console.log("ðŸ”„ Resetting lesson form...");
    try {
        const titleInput = document.getElementById('createLessonTitle');
        if (titleInput) titleInput.value = '';
        
        const descInput = document.getElementById('createLessonDescription');
        if (descInput) descInput.value = '';
        
        const youtubeInput = document.getElementById('videoYoutubeUrl');
        if (youtubeInput) youtubeInput.value = '';
        
        const textInput = document.getElementById('textContentInput');
        if (textInput) textInput.value = '';
        
        const videoInput = document.getElementById('videoFileInput');
        if (videoInput) videoInput.value = '';
        
        const pdfInput = document.getElementById('pdfFileInput');
        if (pdfInput) pdfInput.value = '';
        
        const editId = document.getElementById('editLessonId');
        if (editId) editId.value = '';
        
        // Hide file info
        const videoInfo = document.getElementById('videoFileInfo');
        if (videoInfo) videoInfo.style.display = 'none';
        
        const pdfInfo = document.getElementById('pdfFileInfo');
        if (pdfInfo) pdfInfo.style.display = 'none';
        
        const textInfo = document.getElementById('textFileInfo');
        if (textInfo) textInfo.style.display = 'none';
        
        const previewContainer = document.getElementById('videoPreviewContainer');
        if (previewContainer) previewContainer.style.display = 'none';
        
        const existingVideo = document.getElementById('existingVideoInfo');
        if (existingVideo) existingVideo.style.display = 'none';
        
        const newVideo = document.getElementById('newVideoIndicator');
        if (newVideo) newVideo.style.display = 'none';
        
    } catch (error) {
        console.error("âŒ Error resetting form:", error);
    }
}


// ============================================
// HELPER: Display lessons list
// ============================================
function displayLessonsList(lessons, data) {
    const content = document.getElementById('editLessonsContent');
    
    let html = `
        <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
            <h3><i class="fas fa-book"></i> Manage Lessons (${lessons.length} total)</h3>
            <button class="btn-primary" onclick="closeEditLessonsModal(); openCreateLessonPopup()">
                <i class="fas fa-plus"></i> Add New Lesson
            </button>
        </div>
        
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Title</th>
                        <th>Subject</th>
                        <th>Topic</th>
                        <th>Type</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    lessons.forEach(lesson => {
        const lessonId = lesson.id || lesson.lesson_id || lesson.content_id;
        const title = lesson.title || lesson.lesson_title || lesson.content_title || 'Untitled';
        const subject = lesson.subject_name || lesson.subject || 'N/A';
        const topic = lesson.topic_title || lesson.topic || 'N/A';
        const type = lesson.content_type || lesson.type || 'text';
        const status = lesson.status || 'published';
        
        html += `
            <tr>
                <td>#${lessonId}</td>
                <td><strong>${title}</strong></td>
                <td>${subject}</td>
                <td>${topic}</td>
                <td><span class="badge badge-${type}">${type}</span></td>
                <td><span class="badge badge-${status}">${status}</span></td>
                <td>
                    <button class="btn-sm btn-primary" onclick="editLesson(${lessonId})">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                    <button class="btn-sm btn-danger" onclick="deleteLesson(${lessonId})">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
    `;
    
    content.innerHTML = html;
}

// ============================================
// FIXED: fetchSubjects - With better error handling
// ============================================
async function fetchSubjects() {
    console.log("ðŸ“š Fetching subjects...");
    
    try {
        const token = localStorage.getItem('admin_token') || localStorage.getItem('authToken');
        
        const endpoints = [
            `/admin/subjects`,
            `/subjects`,
            `/subjects/all`
        ];
        
        for (const endpoint of endpoints) {
            try {
                const response = await fetch(endpoint, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log(`âœ… Subjects loaded from ${endpoint}`);
                    
                    if (data.subjects && Array.isArray(data.subjects)) {
                        return data.subjects;
                    } else if (data.data && Array.isArray(data.data)) {
                        return data.data;
                    } else if (Array.isArray(data)) {
                        return data;
                    }
                }
            } catch (e) {
                console.log(`Endpoint ${endpoint} failed:`, e.message);
            }
        }
        
        // Return default subjects if none found
        return [
            { id: 1, name: 'Mathematics' },
            { id: 2, name: 'Algebra' },
            { id: 3, name: 'Geometry' },
            { id: 4, name: 'Calculus' }
        ];
        
    } catch (error) {
        console.error('Error fetching subjects:', error);
        return [];
    }
}
// ============================================
// [NEW] VIDEO PROGRESS TRACKING - ADD THIS TO script.js
// ============================================

/**
 * Initialize video progress tracking
 * @param {HTMLVideoElement} videoElement - The video element to track
 * @param {number|string} contentId - The ID of the lesson/content
 */

// ===== HELPER FUNCTION TO UPDATE DISPLAY =====
function updateCurrentLessonDisplay() {
    const lessonProgressFill = document.getElementById('lessonProgressFill');
    const progressPercentage = document.getElementById('progressPercentage');
    const progressTime = document.getElementById('progressTime');
    const videoElement = document.getElementById('lessonVideo');
    const videoTimeDisplay = document.getElementById('videoTime');
    
    if (!videoElement || !videoElement.duration) return;
    
    const currentTime = videoElement.currentTime;
    const duration = videoElement.duration;
    const percentage = Math.floor((currentTime / duration) * 100) || 0;
    
    // Update progress bar
    if (lessonProgressFill) {
        lessonProgressFill.style.width = `${percentage}%`;
    }
    
    // Update percentage text
    if (progressPercentage) {
        progressPercentage.textContent = `${percentage}% Complete`;
    }
    
    // Update time display in sidebar
    if (progressTime) {
        const currentMinutes = Math.floor(currentTime / 60);
        const currentSeconds = Math.floor(currentTime % 60);
        const durationMinutes = Math.floor(duration / 60);
        const durationSeconds = Math.floor(duration % 60);
        
        progressTime.textContent = `${currentMinutes}:${currentSeconds.toString().padStart(2, '0')} / ${durationMinutes}:${durationSeconds.toString().padStart(2, '0')}`;
    }
    
    // Update video time display
    if (videoTimeDisplay) {
        const currentMinutes = Math.floor(currentTime / 60);
        const currentSeconds = Math.floor(currentTime % 60);
        const durationMinutes = Math.floor(duration / 60);
        const durationSeconds = Math.floor(duration % 60);
        
        videoTimeDisplay.innerHTML = `${currentMinutes}:${currentSeconds.toString().padStart(2, '0')} / ${durationMinutes}:${durationSeconds.toString().padStart(2, '0')}`;
    }
    
    console.log(`ðŸ”„ Display updated: ${percentage}% at ${currentTime.toFixed(1)}s`);
}

// ============================================
// ðŸŽ¬ ENHANCED: Video Progress Tracking - With session reset
// ============================================
function initVideoProgressTracking(videoElement, contentId) {
    if (!videoElement || !contentId) {
        console.warn("âš ï¸ Cannot initialize video tracking: missing video element or content ID");
        return;
    }
    
    console.log(`ðŸŽ¬ Initializing progress tracking for video ${contentId}`);
    
    let lastSaveTime = 0;
    const SAVE_INTERVAL = 10000;
    let lastReportedPercentage = 0;
    let isCompleted = false;
    
    // ===== TIME TRACKING =====
    let watchStartTime = null;
    let totalWatchedSeconds = 0;
    let lastCurrentTime = 0;
    let lastSavedTime = 0;
    let videoDuration = 0;
    let isActive = true;
    
    const videoKey = `video_progress_${contentId}`;
    
    // Load saved progress
    try {
        const saved = localStorage.getItem(videoKey);
        if (saved) {
            const savedProgress = JSON.parse(saved);
            console.log(`ðŸ“‚ Loaded saved progress: ${savedProgress.percentage}%`);
            
            if (savedProgress.totalWatchedSeconds) {
                totalWatchedSeconds = savedProgress.totalWatchedSeconds;
                lastSavedTime = savedProgress.currentTime || 0;
            }
            
            if (savedProgress.currentTime && videoElement.duration) {
                if (savedProgress.percentage < 90) {
                    videoElement.currentTime = savedProgress.currentTime;
                    lastCurrentTime = savedProgress.currentTime;
                }
            }
        }
    } catch (error) {
        console.warn('Could not load saved progress:', error);
    }
    
    // Update display after loading
    setTimeout(updateCurrentLessonDisplay, 100);
    
    /**
     * Save progress to server
     */
    async function saveProgress(status, percentage, currentTime = 0, additionalSeconds = 0) {
        if (isCompleted && status !== 'completed') return;
        
        const now = Date.now();
        if (now - lastSaveTime < SAVE_INTERVAL && status !== 'completed') return;
        if (Math.abs(percentage - lastReportedPercentage) < 5 && status !== 'completed') return;
        
        lastSaveTime = now;
        lastReportedPercentage = percentage;
        
        // Update total watched time
        if (additionalSeconds > 0) {
            totalWatchedSeconds += additionalSeconds;
        }
        
        // Save to localStorage
        try {
            localStorage.setItem(videoKey, JSON.stringify({
                percentage: percentage,
                currentTime: currentTime,
                timestamp: new Date().toISOString(),
                status: status,
                totalWatchedSeconds: totalWatchedSeconds
            }));
        } catch (error) {
            console.warn('Could not save to localStorage:', error);
        }
        
        // Send to server
        const token = localStorage.getItem('authToken');
        if (!token) return;
        
        try {
            const response = await fetch(`/api/lessons-db/${contentId}/progress`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    completion_status: status,
                    percentage: percentage,
                    time_spent_seconds: totalWatchedSeconds,
                    current_time: currentTime,
                    session_active: isActive
                })
            });
            
            if (!response.ok) return;
            
            const result = await response.json();
            
            if (result.success) {
                console.log(`âœ… Progress saved: ${percentage}% (${status}), Time: ${totalWatchedSeconds}s`);
                
                if (status === 'completed' && !isCompleted) {
                    isCompleted = true;
                    
                    const completeBtn = document.getElementById('completeLessonBtn');
                    if (completeBtn) {
                        completeBtn.innerHTML = '<i class="fas fa-check-double"></i> Lesson Completed!';
                        completeBtn.classList.remove('btn-primary');
                        completeBtn.classList.add('btn-success');
                        completeBtn.disabled = true;
                    }
                    
                    showNotification('ðŸŽ‰ Lesson completed! Great job!', 'success');
                }
            }
        } catch (error) {
            console.warn('âš ï¸ Error saving progress:', error.message);
        }
    }
    
    // ===== PAGE VISIBILITY CHANGE =====
    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            console.log('ðŸ‘‹ User left page - pausing video tracking');
            isActive = false;
            
            if (watchStartTime) {
                const watchDuration = Math.floor((Date.now() - watchStartTime) / 1000);
                totalWatchedSeconds += watchDuration;
                watchStartTime = null;
                
                // Save current progress but mark as inactive
                if (videoElement.duration > 0) {
                    const percentage = Math.floor((videoElement.currentTime / videoElement.duration) * 100);
                    saveProgress('in_progress', percentage, videoElement.currentTime);
                }
            }
        } else {
            console.log('ðŸ‘‹ User returned - resuming tracking');
            isActive = true;
            
            if (!videoElement.paused) {
                watchStartTime = Date.now();
            }
        }
    });
    
    videoElement.addEventListener('loadedmetadata', function() {
    videoDuration = videoElement.duration;
    console.log(`ðŸ“¹ Video duration: ${videoDuration}s`);
    updateCurrentLessonDisplay();
    
    // Show success in video info
    const videoInfo = document.getElementById('videoInfo');
    if (videoInfo) {
        videoInfo.innerHTML = `
            <p><i class="fas fa-check-circle" style="color: #27ae60;"></i> Video loaded successfully</p>
            <p><i class="fas fa-clock"></i> Duration: ${Math.floor(videoDuration / 60)} min</p>
        `;
    }
});

// Add error event listener
videoElement.addEventListener('error', function(e) {
    console.error('âŒ Video error:', e);
    const videoInfo = document.getElementById('videoInfo');
    if (videoInfo) {
        videoInfo.innerHTML = `
            <p style="color: #e74c3c;">
                <i class="fas fa-exclamation-triangle"></i> 
                Error loading video. Please check if the file exists.
            </p>
        `;
    }
});
    
    // ===== PLAY EVENT =====
    videoElement.addEventListener('play', function() {
        if (!isActive) return; // Don't track if page is hidden
        
        console.log(`â–¶ï¸ Video started playing at ${videoElement.currentTime}s`);
        watchStartTime = Date.now();
        updateCurrentLessonDisplay();
        
        const timeDisplay = document.getElementById('videoTime');
        if (timeDisplay) {
            timeDisplay.classList.add('watching');
        }
    });
    
    // ===== PAUSE EVENT =====
    videoElement.addEventListener('pause', function() {
        console.log(`â¸ï¸ Video paused at ${videoElement.currentTime}s`);
        
        if (watchStartTime) {
            const watchDuration = Math.floor((Date.now() - watchStartTime) / 1000);
            totalWatchedSeconds += watchDuration;
            watchStartTime = null;
            
            console.log(`â±ï¸ Watched for ${watchDuration}s (Total: ${totalWatchedSeconds}s)`);
        }
        
        updateCurrentLessonDisplay();
        
        const timeDisplay = document.getElementById('videoTime');
        if (timeDisplay) {
            timeDisplay.classList.remove('watching');
        }
        
        // Save on pause
        if (videoElement.duration > 0 && !isCompleted) {
            const percentage = Math.floor((videoElement.currentTime / videoElement.duration) * 100);
            saveProgress('in_progress', percentage, videoElement.currentTime);
        }
        
        // Refresh Today's Learning
        if (typeof updateTodaysLearningStats === 'function') {
            setTimeout(updateTodaysLearningStats, 500);
        }
    });
    
    // ===== TIME UPDATE =====
    videoElement.addEventListener('timeupdate', function() {
        if (!videoElement.duration) return;
        
        const currentTime = videoElement.currentTime;
        const duration = videoElement.duration;
        const percentage = Math.floor((currentTime / duration) * 100);
        
        // Check for seeking/jumping (fast forward/rewind)
        const timeDiff = currentTime - lastCurrentTime;
        if (Math.abs(timeDiff) > 2 && lastCurrentTime > 0) {
            console.log(`â© User seeked ${timeDiff > 0 ? 'forward' : 'backward'} from ${lastCurrentTime.toFixed(1)}s to ${currentTime.toFixed(1)}s`);
            
            if (timeDiff < -10) {
                console.log('ðŸ”„ Video restarted or rewound significantly');
                updateCurrentLessonDisplay();
            }
        }
        
        lastCurrentTime = currentTime;
        
        // Update display
        updateCurrentLessonDisplay();
        
        // Auto-save every 10 seconds (only if page is active)
        if (!isCompleted && watchStartTime && isActive) {
            const now = Date.now();
            if (now - lastSaveTime > SAVE_INTERVAL) {
                const watchDuration = Math.floor((now - watchStartTime) / 1000);
                saveProgress('in_progress', percentage, currentTime, watchDuration);
            }
        }
    });
    
    // ===== ENDED EVENT =====
    videoElement.addEventListener('ended', function() {
        console.log(`âœ… Video completed`);
        
        if (watchStartTime) {
            const watchDuration = Math.floor((Date.now() - watchStartTime) / 1000);
            totalWatchedSeconds += watchDuration;
            watchStartTime = null;
        }
        
        isCompleted = true;
        saveProgress('completed', 100, videoElement.duration);
        updateCurrentLessonDisplay();
        
        const timeDisplay = document.getElementById('videoTime');
        if (timeDisplay) {
            timeDisplay.classList.remove('watching');
        }
        
        if (typeof updateTodaysLearningStats === 'function') {
            setTimeout(updateTodaysLearningStats, 500);
        }
    });
    
    // ===== SEEKED EVENT =====
    videoElement.addEventListener('seeked', function() {
        console.log(`â© User seeked to ${videoElement.currentTime.toFixed(1)}s`);
        
        updateCurrentLessonDisplay();
        
        if (videoElement.duration > 0 && !isCompleted && isActive) {
            const currentTime = videoElement.currentTime;
            const percentage = Math.floor((currentTime / videoElement.duration) * 100);
            
            const now = Date.now();
            if (now - lastSaveTime > 2000) {
                saveProgress('in_progress', percentage, currentTime);
            }
        }
        
        if (typeof updateTodaysLearningStats === 'function') {
            setTimeout(updateTodaysLearningStats, 500);
        }
    });
    
    // ===== BEFORE UNLOAD =====
    window.addEventListener('beforeunload', function() {
        if (watchStartTime) {
            const watchDuration = Math.floor((Date.now() - watchStartTime) / 1000);
            totalWatchedSeconds += watchDuration;
            
            try {
                const currentTime = videoElement.currentTime || 0;
                const duration = videoElement.duration || 1;
                const percentage = Math.floor((currentTime / duration) * 100);
                
                localStorage.setItem(videoKey, JSON.stringify({
                    percentage: percentage,
                    currentTime: currentTime,
                    timestamp: new Date().toISOString(),
                    status: isCompleted ? 'completed' : 'in_progress',
                    totalWatchedSeconds: totalWatchedSeconds
                }));
            } catch (error) {
                console.warn('Could not save to localStorage:', error);
            }
        }
    });
    
    console.log(`âœ… Video progress tracking initialized for ${contentId}`);
}
// ============================================
// âœ… ADD THIS FUNCTION - Update Current Lesson Display
// ============================================
function updateCurrentLessonDisplay() {
    const lessonProgressFill = document.getElementById('lessonProgressFill');
    const progressPercentage = document.getElementById('progressPercentage');
    const progressTime = document.getElementById('progressTime');
    const videoElement = document.getElementById('lessonVideo');
    
    if (!videoElement || !videoElement.duration) return;
    
    const currentTime = videoElement.currentTime;
    const duration = videoElement.duration;
    const percentage = Math.floor((currentTime / duration) * 100);
    
    // Update progress bar
    if (lessonProgressFill) {
        lessonProgressFill.style.width = `${percentage}%`;
    }
    
    // Update percentage text
    if (progressPercentage) {
        progressPercentage.textContent = `${percentage}% Complete`;
    }
    
    // Update time display
    if (progressTime) {
        const currentMinutes = Math.floor(currentTime / 60);
        const currentSeconds = Math.floor(currentTime % 60);
        const durationMinutes = Math.floor(duration / 60);
        const durationSeconds = Math.floor(duration % 60);
        
        progressTime.textContent = `${currentMinutes}:${currentSeconds.toString().padStart(2, '0')} / ${durationMinutes}:${durationSeconds.toString().padStart(2, '0')}`;
    }
    
    console.log(`ðŸ”„ Display updated: ${percentage}% at ${currentTime.toFixed(1)}s`);
}
// ============================================
// FUNCTION TO LOAD VIDEO LESSON
// ============================================

/**
 * Load a video lesson by ID
 * @param {number|string} lessonId - The ID of the lesson to load
 */
async function loadVideoLesson(lessonId) {
    console.log("ðŸŽ¬ Loading video lesson:", lessonId);
    
    try {
        const token = localStorage.getItem('authToken');
        
        const response = await fetch(`/api/lessons-db/${lessonId}`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            const lesson = result.lesson;
            
            // Update lesson info
            const titleElement = document.getElementById('videoLessonTitle');
            if (titleElement) {
                titleElement.textContent = lesson.content_title || 'Video Lesson';
            }
            
            const descElement = document.getElementById('videoLessonDescription');
            if (descElement) {
                descElement.textContent = lesson.content_description || '';
            }
            
            // Get video container
            const videoContainer = document.getElementById('videoContainer');
            if (!videoContainer) return;
            
            // Clear existing video
            videoContainer.innerHTML = '';
            
            // Determine video source
            let videoSrc = '';
            if (lesson.video_filename) {
                // New uploaded video
                videoSrc = `/uploads/videos/${lesson.video_filename}`;
            } else if (lesson.content_url) {
                // YouTube URL
                videoSrc = lesson.content_url;
            } else {
                // Default video
                videoSrc = '/videos/quarter1-polynomial-equations.mp4';
            }
            
            // Create video element
            if (videoSrc.includes('youtube') || videoSrc.includes('youtu.be')) {
                // YouTube embed
                const videoId = extractYoutubeId(videoSrc);
                videoContainer.innerHTML = `
                    <iframe width="100%" height="400" 
                        src="https://www.youtube.com/embed/${videoId}?autoplay=0"
                        frameborder="0" allowfullscreen>
                    </iframe>
                `;
            } else {
                // HTML5 video
                const videoElement = document.createElement('video');
                videoElement.id = 'lessonVideo';
                videoElement.controls = true;
                videoElement.style.width = '100%';
                videoElement.style.maxHeight = '400px';
                videoElement.style.backgroundColor = '#000';
                
                const source = document.createElement('source');
                source.src = videoSrc + '?v=' + Date.now(); // Cache buster
                source.type = 'video/mp4';
                
                videoElement.appendChild(source);
                videoElement.innerHTML += 'Your browser does not support the video tag.';
                
                videoContainer.appendChild(videoElement);
                
                // Initialize progress tracking
                initVideoProgressTracking(videoElement, lessonId);
            }
            
        } else {
            console.error('âŒ Failed to load lesson:', result.message);
        }
    } catch (error) {
        console.error('âŒ Error loading video lesson:', error);
    }
}

// ============================================
// HELPER FUNCTION: Extract YouTube ID
// ============================================

function extractYoutubeId(url) {
    const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
    const match = url.match(regExp);
    return (match && match[2].length === 11) ? match[2] : null;
}

// ============================================
// PROGRESS TRACKING FUNCTIONS - DATABASE INTEGRATION
// ============================================

// Complete data recording system
class ProgressTracker {
    constructor() {
        this.data = {
            lessonsCompleted: 0,
            exercisesCompleted: 0,
            totalLessons: 3,
            lastUpdated: new Date().toISOString(),
            dailyGoal: 5,
            streak: 0
        };
        this.load();
    }
    
    load() {
        const saved = localStorage.getItem('mathProgress');
        if (saved) {
            this.data = JSON.parse(saved);
        }
        this.updateUI();
    }
    
    save() {
        localStorage.setItem('mathProgress', JSON.stringify(this.data));
        this.updateUI();
    }
    
    addExercise() {
        this.data.exercisesCompleted++;
        
        // Update lessons (every 5 exercises = 1 lesson)
        const newLessons = Math.floor(this.data.exercisesCompleted / 5);
        this.data.lessonsCompleted = Math.min(newLessons, this.data.totalLessons);
        
        this.save();
        this.showFeedback('Progress saved! âœ“');
    }
    
    updateUI() {
        // Update statistics display
        document.querySelectorAll('.stat-value')[0].textContent = 
            this.data.lessonsCompleted;
        document.querySelectorAll('.stat-value')[1].textContent = 
            this.data.exercisesCompleted;
            
        // Update progress bars if any
        const progressPercent = (this.data.lessonsCompleted / this.data.totalLessons) * 100;
        // Update any progress bars here
    }
    
    showFeedback(message) {
        // Show temporary feedback
        const feedback = document.createElement('div');
        feedback.className = 'save-feedback';
        feedback.textContent = message;
        feedback.style.cssText = `
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            animation: fadeInOut 2s;
        `;
        document.body.appendChild(feedback);
        setTimeout(() => feedback.remove(), 2000);
    }
}

// Initialize
const progress = new ProgressTracker();

// Call this when exercise is completed
function onExerciseComplete() {
    progress.addExercise();
}

// Kapag may natapos na exercise
function completeExercise(topicName) {
    // Increment counters
    userProgress.exercisesCompleted++;
    
    // Update lessons if needed (every 5 exercises = 1 lesson)
    if (userProgress.exercisesCompleted % 5 === 0) {
        userProgress.lessonsCompleted = Math.min(
            userProgress.lessonsCompleted + 1,
            3
        );
    }
    
    // Save and update display
    saveProgress();
    updateDisplay();
    
    // Show success message
    showNotification('Exercise completed! ðŸŽ‰');
}
// Replace the fetchDailyProgress function starting at line 98:
async function fetchDailyProgress() {
    try {
        console.log('ðŸ“Š Fetching daily progress...');
        
        const data = await apiRequest('/api/progress/daily');
        
        if (data.success) {
            console.log('âœ… Daily progress loaded');
            ProgressState.dailyProgress = data.progress || {};
            
            return {
                lessons_completed: data.progress?.lessons_completed || 0,
                exercises_completed: data.progress?.exercises_completed || 0,
                points_earned: data.progress?.points_earned || 0,
                time_spent_minutes: data.progress?.time_spent_minutes || 0,
                streak_days: data.progress?.streak_maintained || 0
            };
        } else {
            return getDefaultProgress();
        }
    } catch (error) {
        console.error('Error fetching daily progress:', error);
        return getDefaultProgress();
    }
}



function handleActivityResponse(data) {
    if (data.success) {
        // Handle different response formats
        const activities = data.activity_feed?.activities || 
                          data.activities || 
                          data.activity_feed || 
                          [];
        
        console.log(`âœ… Fetched ${activities.length} activities`);
        ProgressState.activityLog = activities;
        return activities;
    } else {
        console.warn('âš ï¸ Activity feed returned unsuccessful response:', data);
        return [];
    }
}

// ============================================
// âœ… FIXED: fetchCumulativeProgress - FASTER RESPONSE
// ============================================
async function fetchCumulativeProgress() {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        
        if (!token) {
            console.warn('âŒ No auth token available');
            return getDefaultProgress();
        }
        
        console.log('ðŸ“Š Fetching cumulative progress...');
        
        const response = await fetch(`/api/progress/overall`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (response.ok) {
            const data = await response.json();
            
            if (data.success) {
                console.log('âœ… Overall progress loaded:', data.overall);
                
                // Convert seconds to minutes
                const totalSeconds = data.overall.total_time_spent_minutes || 0;
                const totalMinutes = Math.floor(totalSeconds / 60);
                
                // Calculate average time per activity
                const totalActivities = (data.overall.lessons_completed || 0) + 
                                       (data.overall.practice_completed || 0) + 
                                       (data.overall.quizzes_completed || 0);
                
                const avgPerActivity = totalActivities > 0 
                    ? Math.round(totalMinutes / totalActivities) 
                    : 5;
                
                // Calculate weekly improvement
                const weeklyImprovement = calculateWeeklyImprovement(data.overall);
                
                const progress = {
                    total_lessons_completed: data.overall.lessons_completed || 0,
                    total_lessons: data.overall.total_lessons || 20,
                    overall_percentage: data.overall.percentage || 0,
                    exercises_completed: data.overall.practice_completed || 0,
                    total_quizzes_completed: data.overall.quizzes_completed || 0,
                    total_points_earned: data.overall.total_points || 0,
                    total_time_spent_minutes: totalMinutes,
                    weekly_time_spent: data.overall.weekly?.minutes || 0,
                    avg_time_per_activity: avgPerActivity,
                    weekly_improvement: weeklyImprovement,
                    total_time_display: formatTime(totalMinutes),
                    streak_days: data.overall.streak_days || 1,
                    weekly: data.overall.weekly || { lessons: 0, exercises: 0, quizzes: 0, points: 0, minutes: 0 }
                };
                
                console.log(`ðŸ“Š Progress loaded - Lessons: ${progress.total_lessons_completed}/${progress.total_lessons}`);
                
                ProgressState.cumulativeProgress = progress;
                
                // IMMEDIATELY update display
                updateOverallProgressDisplay(progress);
                
                return progress;
            }
        }
        
        return getDefaultProgress();
        
    } catch (error) {
        console.error('âŒ Error in fetchCumulativeProgress:', error);
        return getDefaultProgress();
    }
}
// Helper function to calculate weekly improvement
function calculateWeeklyImprovement(data) {
    // Get this week's activities
    const thisWeekActivities = (data.weekly?.lessons || 0) + 
                               (data.weekly?.exercises || 0) + 
                               (data.weekly?.quizzes || 0);
    
    // Get last week's activities (if available in data)
    const lastWeekActivities = data.last_week?.activities || 0;
    
    if (lastWeekActivities === 0) return 5; // Default if no previous data
    
    // Calculate improvement percentage
    const improvement = Math.round(((thisWeekActivities - lastWeekActivities) / lastWeekActivities) * 100);
    
    // Cap between -50% and +100% for reasonable display
    return Math.min(100, Math.max(-50, improvement));
}

// Helper function to format time
function formatTime(minutes) {
    const hours = Math.floor(minutes / 60);
    const mins = minutes % 60;
    
    if (hours > 0) {
        return `${hours}h ${mins}m`;
    } else {
        return `${mins}m`;
    }
}

// ============================================
// Helper: Get Default Progress
// ============================================
function getDefaultProgress() {
    return {
        total_lessons_completed: 0,
        total_lessons: 20,
        overall_percentage: 0,
        exercises_completed: 0,
        total_quizzes_completed: 0,
        total_points_earned: 0,
        total_time_spent_minutes: 0,
        weekly_time_spent: 0,
        avg_display_time: 5,
        streak_days: 1,
        weekly: {
            lessons: 0,
            exercises: 0,
            quizzes: 0,
            points: 0,
            minutes: 0
        }
    };
}

// ============================================
// âœ… FIXED: updateOverallProgressDisplay - WITH REAL-TIME DATA
// ============================================
function updateOverallProgressDisplay(progress) {
    console.log('ðŸ“Š Updating overall progress display with:', progress);
    
    if (!progress) {
        progress = ProgressState.cumulativeProgress || getDefaultProgress();
    }
    
    // Get percentage
    const percentage = progress.percentage || progress.overall_percentage || 0;
    
    // Update overall progress text
    const overallProgress = document.getElementById('overallProgress');
    if (overallProgress) {
        overallProgress.textContent = `${percentage}%`;
        // Add animation to show it's updated
        overallProgress.style.transition = 'all 0.3s';
        overallProgress.style.transform = 'scale(1.1)';
        overallProgress.style.color = '#7a0000';
        setTimeout(() => {
            overallProgress.style.transform = 'scale(1)';
            overallProgress.style.color = '';
        }, 300);
    }
    
    // Update progress bar
    const overallProgressBar = document.getElementById('overallProgressBar');
    if (overallProgressBar) {
        overallProgressBar.style.width = `${percentage}%`;
        overallProgressBar.className = 'progress-fill';
        if (percentage >= 70) {
            overallProgressBar.classList.add('progress-good');
        } else if (percentage >= 40) {
            overallProgressBar.classList.add('progress-medium');
        } else {
            overallProgressBar.classList.add('progress-low');
        }
    }
    
    // Update total points
    const totalPointsProgress = document.getElementById('totalPointsProgress');
    if (totalPointsProgress) {
        totalPointsProgress.textContent = progress.total_points || progress.total_points_earned || 0;
    }
    
    // Update points change
    const pointsChange = document.getElementById('pointsChange');
    if (pointsChange) {
        const weeklyPoints = progress.weekly?.points || 0;
        pointsChange.textContent = `+${weeklyPoints} this week`;
    }
    
    // Update TOTAL TIME INVESTED
    const totalTime = document.getElementById('totalTime');
    if (totalTime) {
        // Use the formatted total time
        if (progress.total_time_display) {
            totalTime.textContent = progress.total_time_display;
        } else {
            // Fallback formatting
            const totalMinutes = progress.total_time_spent_minutes || 0;
            totalTime.textContent = formatTime(totalMinutes);
        }
        console.log('âœ… Total time updated:', totalTime.textContent);
    }
    
    // Update time change (weekly)
    const timeChange = document.getElementById('timeChange');
    if (timeChange) {
        const weeklyMinutes = progress.weekly?.minutes || 0;
        timeChange.textContent = `${formatTime(weeklyMinutes)} this week`;
    }
}

// Fetch weekly progress
async function fetchWeeklyProgress() {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) {
            console.warn('No auth token available');
            return null;
        }
        
        console.log('ðŸ“Š Fetching weekly progress...');
        
        const response = await fetch(`/api/progress/weekly`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`Failed to fetch weekly progress: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            console.log('âœ… Weekly progress loaded');
            ProgressState.weeklyProgress = data.progress || {};
            return data.progress;
        } else {
            throw new Error(data.message || 'No weekly progress returned');
        }
    } catch (error) {
        console.error('Error fetching weekly progress:', error);
        return null;
    }
}

// Fetch monthly progress
async function fetchMonthlyProgress() {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) {
            console.warn('No auth token available');
            return null;
        }
        
        console.log('ðŸ“Š Fetching monthly progress...');
        
        const response = await fetch(`/api/progress/monthly`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`Failed to fetch monthly progress: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            console.log('âœ… Monthly progress loaded');
            ProgressState.monthlyProgress = data.progress || {};
            return data.progress;
        } else {
            throw new Error(data.message || 'No monthly progress returned');
        }
    } catch (error) {
        console.error('Error fetching monthly progress:', error);
        return null;
    }
}

// Fetch learning goals
async function fetchLearningGoals() {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) {
            console.warn('No auth token available');
            return [];
        }
        
        console.log('ðŸŽ¯ Fetching learning goals...');
        
        const response = await fetch(`/api/progress/goals`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        // Handle 404 gracefully - ibig sabihin wala pang goals feature
        if (response.status === 404) {
            console.log('â„¹ï¸ Learning goals endpoint not found (404) - returning empty array');
            ProgressState.learningGoals = [];
            return [];
        }
        
        if (!response.ok) {
            console.warn(`Failed to fetch learning goals: ${response.status}`);
            ProgressState.learningGoals = [];
            return [];
        }
        
        const data = await response.json();
        
        if (data.success && data.goals) {
            console.log(`âœ… Fetched ${data.goals.length} learning goals`);
            ProgressState.learningGoals = data.goals;
            return data.goals;
        } else {
            console.warn('No learning goals returned');
            ProgressState.learningGoals = [];
            return [];
        }
    } catch (error) {
        console.error('Error fetching learning goals:', error);
        ProgressState.learningGoals = [];
        return [];
    }
}

// ============================================
// FETCH TOPIC MASTERY (for Accuracy Rate & Topics Progress)
// ============================================
async function fetchTopicMastery() {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) return {};
        
        console.log('ðŸ§  Fetching topic mastery...');
        
        const response = await fetch(`/api/progress/topic-mastery`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!response.ok) return {};
        
        const data = await response.json();
        
        if (data.success && data.mastery) {
            console.log(`âœ… Fetched mastery for ${data.mastery.length} topics`);
            
            // Store in ProgressState
            ProgressState.topicMastery = data.mastery;
            
            // Update UI
            updateTopicProgressBreakdown();
            updatePerformanceAnalytics();
            
            return data.mastery;
        } else {
            return {};
        }
    } catch (error) {
        console.error('Error fetching topic mastery:', error);
        return {};
    }
}

// ============================================
// FIXED: fetchModuleProgress - Handles empty responses
// ============================================
async function fetchModuleProgress() {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) {
            console.warn('No auth token available');
            return {};
        }
        
        console.log('ðŸ“š Fetching module progress...');
        
        const response = await fetch(`/api/progress/modules`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            console.warn(`Failed to fetch module progress: ${response.status}`);
            return {};
        }
        
        const data = await response.json();
        
        // Handle different response structures
        if (data.success) {
            // Check if progress exists in different possible locations
            let progressData = {};
            
            if (data.progress && Array.isArray(data.progress)) {
                // Convert array to object for easier access
                data.progress.forEach(item => {
                    progressData[item.module_id] = item;
                });
                console.log(`âœ… Fetched progress for ${data.progress.length} modules`);
            } else if (data.data && Array.isArray(data.data)) {
                data.data.forEach(item => {
                    progressData[item.module_id] = item;
                });
                console.log(`âœ… Fetched progress for ${data.data.length} modules`);
            } else if (data.modules && Array.isArray(data.modules)) {
                data.modules.forEach(item => {
                    progressData[item.module_id] = item;
                });
                console.log(`âœ… Fetched progress for ${data.modules.length} modules`);
            } else {
                // If no progress data, return empty object (not an error)
                console.log('â„¹ï¸ No module progress data available yet');
                return {};
            }
            
            ProgressState.moduleProgress = progressData;
            return progressData;
        } else {
            // If success is false but no error, just return empty
            console.log('â„¹ï¸ Module progress endpoint returned success: false');
            return {};
        }
    } catch (error) {
        console.error('Error fetching module progress:', error.message);
        return {}; // Return empty object instead of throwing
    }
}


// Fetch dashboard statistics
async function fetchDashboardStats() {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) {
            console.warn('No auth token available');
            return null;
        }
        
        console.log('ðŸ“ˆ Fetching dashboard stats...');
        
        const response = await fetch(`/api/progress/dashboard-stats`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': '/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`Failed to fetch dashboard stats: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            console.log('âœ… Dashboard stats loaded');
            ProgressState.dashboardStats = data.stats;
            return data.stats;
        } else {
            throw new Error(data.message || 'No dashboard stats returned');
        }
    } catch (error) {
        console.error('Error fetching dashboard stats:', error);
        return null;
    }
}

// Fetch progress trends
async function fetchProgressTrends(days = 30) {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) {
            console.warn('No auth token available');
            return [];
        }
        
        console.log('ðŸ“Š Fetching progress trends...');
        
        const response = await fetch(`/api/progress/trends?days=${days}`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`Failed to fetch progress trends: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success && data.trends) {
            console.log(`âœ… Fetched ${data.trends.length} days of progress trends`);
            ProgressState.progressTrends = data.trends;
            return data.trends;
        } else {
            throw new Error(data.message || 'No progress trends returned');
        }
    } catch (error) {
        console.error('Error fetching progress trends:', error);
        return [];
    }
}

// ============================================
// FETCH ACHIEVEMENT TIMELINE
// ============================================
async function fetchAchievementTimeline(limit = 10) {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) return [];
        
        console.log('ðŸ† Fetching achievement timeline...');
        
        const response = await fetch(`/api/progress/achievements?limit=${limit}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!response.ok) return [];
        
        const data = await response.json();
        
        if (data.success && data.achievements) {
            console.log(`âœ… Fetched ${data.achievements.length} achievements`);
            ProgressState.achievementTimeline = data.achievements;
            
            // Update UI
            updateAchievementTimeline();
            
            return data.achievements;
        } else {
            return [];
        }
    } catch (error) {
        console.error('Error fetching achievements:', error);
        return [];
    }
}

// Log user activity
// ITO ANG BAGONG VERSION - WALANG POINTS_EARNED
async function logUserActivity(activityType, relatedId = null, details = {}) {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) {
            console.warn('No auth token available, skipping activity log');
            return false;
        }
        
        console.log(`ðŸ“ Logging activity: ${activityType}`);
        
        // USE THE WORKING update-daily ENDPOINT
        const response = await fetch(`/api/progress/update-daily`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                activity_type: activityType,
                related_id: relatedId,
                details: details
                // NO points_earned
            })
        });
        
        if (!response.ok) {
            // If 404, just log locally and return true (don't break functionality)
            if (response.status === 404) {
                console.log('ðŸ“ Activity logging endpoint not found, skipping...');
                return true;
            }
            throw new Error(`Failed to log activity: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            console.log('âœ… Activity logged successfully');
            return true;
        } else {
            throw new Error(data.message || 'Failed to log activity');
        }
    } catch (error) {
        console.error('Error logging user activity:', error);
        // Return true so it doesn't break other functionality
        return true;
    }
}

// Update daily progress
// ITO ANG BAGONG VERSION - HINDI NA NAG-AADD NG POINTS
async function updateDailyProgress(progressData) {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) {
            console.warn('No auth token available');
            return false;
        }
        
        console.log('ðŸ“Š Updating daily progress (FIXED - NO POINTS)...', progressData);
        
        // TANGGALIN ang points_earned - HINDI NA ISASAMA
        const updateData = {
            // Only include lessons_completed if explicitly provided
            ...(progressData.lessons_completed !== undefined && { 
                lessons_completed: progressData.lessons_completed 
            }),
            // Only include exercises_completed if explicitly provided
            ...(progressData.exercises_completed !== undefined && { 
                exercises_completed: progressData.exercises_completed 
            }),
            // Only include quizzes_completed if explicitly provided
            ...(progressData.quizzes_completed !== undefined && { 
                quizzes_completed: progressData.quizzes_completed 
            }),
            // I-REMOVE ANG points_earned
            // ...(progressData.points_earned !== undefined && { 
            //     points_earned: progressData.points_earned 
            // }),
            ...(progressData.time_spent_minutes !== undefined && { 
                time_spent_minutes: progressData.time_spent_minutes 
            })
        };
        
        // If no data to update, return
        if (Object.keys(updateData).length === 0) {
            console.log('âš ï¸ No progress data to update');
            return true;
        }
        
        const response = await fetch(`/api/progress/update-daily`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(updateData)
        });
        
        if (!response.ok) {
            if (response.status === 404) {
                console.warn('âš ï¸ Daily progress endpoint not found (404), skipping...');
                return false;
            }
            throw new Error(`Failed to update daily progress: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            console.log('âœ… Daily progress updated (no points)');
            return true;
        } else {
            throw new Error(data.message || 'Failed to update daily progress');
        }
    } catch (error) {
        console.error('Error updating daily progress:', error);
        return false;
    }
}

// Update topic mastery
async function updateTopicMastery(topicId, masteryData) {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) {
            console.warn('No auth token available');
            return false;
        }
        
        console.log(`ðŸ§  Updating topic mastery for topic ${topicId}...`);
        
        const response = await fetch(`/api/progress/update-topic-mastery`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                topic_id: topicId,
                ...masteryData
            })
        });
        
        if (!response.ok) {
            throw new Error(`Failed to update topic mastery: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            console.log('âœ… Topic mastery updated');
            return true;
        } else {
            throw new Error(data.message || 'Failed to update topic mastery');
        }
    } catch (error) {
        console.error('Error updating topic mastery:', error);
        return false;
    }
}

// Update module progress
async function updateModuleProgress(moduleId, progressData) {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) {
            console.warn('No auth token available');
            return false;
        }
        
        console.log(`ðŸ“š Updating module progress for module ${moduleId}...`);
        
        const response = await fetch(`/api/progress/update-module-progress`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                module_id: moduleId,
                ...progressData
            })
        });
        
        if (!response.ok) {
            throw new Error(`Failed to update module progress: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            console.log('âœ… Module progress updated');
            return true;
        } else {
            throw new Error(data.message || 'Failed to update module progress');
        }
    } catch (error) {
        console.error('Error updating module progress:', error);
        return false;
    }
}

// Update learning goal progress
async function updateLearningGoalProgress(goalId, currentValue) {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) {
            console.warn('No auth token available');
            return false;
        }
        
        console.log(`ðŸŽ¯ Updating learning goal ${goalId}...`);
        
        const response = await fetch(`/api/progress/update-goal-progress`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                goal_id: goalId,
                current_value: currentValue
            })
        });
        
        if (!response.ok) {
            throw new Error(`Failed to update learning goal progress: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            console.log('âœ… Learning goal progress updated');
            return true;
        } else {
            throw new Error(data.message || 'Failed to update learning goal progress');
        }
    } catch (error) {
        console.error('Error updating learning goal progress:', error);
        return false;
    }
}

// Complete a learning goal
async function completeLearningGoal(goalId) {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) {
            console.warn('No auth token available');
            return false;
        }
        
        console.log(`ðŸ† Completing learning goal ${goalId}...`);
        
        const response = await fetch(`/api/progress/complete-goal`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                goal_id: goalId
            })
        });
        
        if (!response.ok) {
            throw new Error(`Failed to complete learning goal: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            console.log('âœ… Learning goal completed');
            
            // Log this achievement
            await logUserActivity('goal_achieved', goalId, { goal_id: goalId }, 50);
            
            return true;
        } else {
            throw new Error(data.message || 'Failed to complete learning goal');
        }
    } catch (error) {
        console.error('Error completing learning goal:', error);
        return false;
    }
}


// Add this to the addPracticeStyles function or create a new style block
function addPracticeResultModalStyles() {
    const style = document.createElement('style');
    style.textContent = `
        /* Practice Result Modal Styles */
        .practice-result-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000000;
            animation: fadeIn 0.3s ease;
        }
        
        .practice-result-container {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.4s ease;
        }
        
        .practice-result-header {
            padding: 25px 25px 15px;
            text-align: center;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .practice-result-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
        }
        
        .practice-result-icon.success {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            box-shadow: 0 10px 20px rgba(39, 174, 96, 0.3);
        }
        
        .practice-result-icon.warning {
            background: linear-gradient(135deg, #f39c12, #f1c40f);
            color: white;
            box-shadow: 0 10px 20px rgba(243, 156, 18, 0.3);
        }
        
        .practice-result-icon.info {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            box-shadow: 0 10px 20px rgba(52, 152, 219, 0.3);
        }
        
        .practice-result-title {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .practice-result-subtitle {
            font-size: 14px;
            color: #7f8c8d;
        }
        
        .practice-result-body {
            padding: 25px;
        }
        
        .practice-score-circle {
            width: 150px;
            height: 150px;
            margin: 0 auto 20px;
            position: relative;
        }
        
        .practice-score-svg {
            width: 150px;
            height: 150px;
            transform: rotate(-90deg);
        }
        
        .practice-score-circle-bg {
            stroke: #ecf0f1;
            stroke-width: 8;
            fill: none;
        }
        
        .practice-score-circle-fill {
            stroke: #27ae60;
            stroke-width: 8;
            fill: none;
            stroke-linecap: round;
            transition: stroke-dasharray 1s ease;
        }
        
        .practice-score-number {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 36px;
            font-weight: bold;
            color: #2c3e50;
            text-align: center;
        }
        
        .practice-score-label {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
        }
        
        .practice-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 25px 0;
        }
        
        .practice-stat-item {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            transition: transform 0.3s;
        }
        
        .practice-stat-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .practice-stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #7a0000;
            margin-bottom: 5px;
        }
        
        .practice-stat-label {
            font-size: 12px;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .practice-stat-unit {
            font-size: 10px;
            color: #95a5a6;
        }
        
        .practice-feedback-message {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .practice-encouragement {
            background: #fff9e6;
            border-left: 4px solid #f39c12;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-size: 14px;
            color: #2c3e50;
        }
        
        .practice-encouragement i {
            color: #f39c12;
            margin-right: 8px;
        }
        
        .practice-tips-list {
            margin-top: 10px;
            padding-left: 20px;
        }
        
        .practice-tips-list li {
            margin-bottom: 8px;
            color: #34495e;
        }
        
        .practice-result-footer {
            padding: 20px 25px 25px;
            border-top: 1px solid #f0f0f0;
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .practice-result-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .practice-result-btn.primary {
            background: #7a0000;
            color: white;
        }
        
        .practice-result-btn.primary:hover {
            background: #5a0000;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(122, 0, 0, 0.3);
        }
        
        .practice-result-btn.secondary {
            background: #ecf0f1;
            color: #2c3e50;
        }
        
        .practice-result-btn.secondary:hover {
            background: #d5dbdb;
            transform: translateY(-2px);
        }
        
        .practice-result-btn.success {
            background: #27ae60;
            color: white;
        }
        
        .practice-result-btn.success:hover {
            background: #219653;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
        }
        
        .practice-completion-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: #27ae60;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            margin: 10px 0;
        }
        
        .practice-total-progress {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .practice-progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
            color: #2c3e50;
        }
        
        .practice-progress-bar {
            height: 8px;
            background: #ecf0f1;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .practice-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #7a0000, #c0392b);
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    `;
    document.head.appendChild(style);
}
// ============================================
// âœ… NEW: Show Practice Result Modal
// ============================================
function showPracticeResultModal(results) {
    console.log('ðŸ“Š Showing practice result modal:', results);
    
    // Remove any existing modal
    const existingModal = document.querySelector('.practice-result-modal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Calculate score percentage
    const scorePercentage = results.percentage || 
                           (results.totalQuestions > 0 ? Math.round((results.correctAnswers / results.totalQuestions) * 100) : 0);
    
    // Determine result type
    let resultType = 'info';
    let resultIcon = 'fa-check-circle';
    let resultTitle = 'Practice Completed!';
    let resultMessage = '';
    let encouragementMessage = '';
    
    if (scorePercentage >= 90) {
        resultType = 'success';
        resultIcon = 'fa-crown';
        resultTitle = 'ðŸŽ‰ Excellent Work!';
        resultMessage = 'You\'ve mastered this topic!';
        encouragementMessage = 'Your understanding is outstanding. Ready for a challenge?';
    } else if (scorePercentage >= 75) {
        resultType = 'success';
        resultIcon = 'fa-star';
        resultTitle = 'ðŸŒŸ Great Job!';
        resultMessage = 'You\'re doing really well!';
        encouragementMessage = 'Keep up the excellent work!';
    } else if (scorePercentage >= 50) {
        resultType = 'info';
        resultIcon = 'fa-smile';
        resultTitle = 'ðŸ’ª Good Effort!';
        resultMessage = 'You\'re making progress!';
        encouragementMessage = 'Practice a bit more to master this topic.';
    } else {
        resultType = 'warning';
        resultIcon = 'fa-book';
        resultTitle = 'ðŸ“š Keep Practicing';
        resultMessage = 'Every mistake is a learning opportunity.';
        encouragementMessage = 'Review the lesson and try again!';
    }
    
    // Calculate time display
    const timeSpent = results.timeSpentSeconds || 0;
    const minutes = Math.floor(timeSpent / 60);
    const seconds = timeSpent % 60;
    const timeDisplay = minutes > 0 ? 
        `${minutes}m ${seconds}s` : 
        `${seconds}s`;
    
    // Get updated stats
    const stats = PracticeState.userPracticeProgress || {};
    const lessonsCompleted = stats.lessons_completed || 0;
    const totalLessons = stats.total_lessons || 3;
    const exercisesCompleted = stats.exercises_completed || 0;
    const lessonsPercentage = stats.lessons_percentage || 0;
    
    // Generate tips based on score
    let tipsHTML = '';
    if (scorePercentage < 75) {
        tipsHTML = `
            <div class="practice-encouragement">
                <i class="fas fa-lightbulb"></i>
                <strong>Tips to improve:</strong>
                <ul class="practice-tips-list">
                    <li>ðŸ“– Review the lesson materials again</li>
                    <li>âœï¸ Take notes on key concepts</li>
                    <li>ðŸ” Focus on the questions you got wrong</li>
                    <li>ðŸ’ª Try the exercise again tomorrow</li>
                </ul>
            </div>
        `;
    }
    
    // Create modal HTML
    const modalHTML = `
        <div class="practice-result-modal">
            <div class="practice-result-container">
                
                <!-- Header -->
                <div class="practice-result-header">
                    <div class="practice-result-icon ${resultType}">
                        <i class="fas ${resultIcon}"></i>
                    </div>
                    <h2 class="practice-result-title">${resultTitle}</h2>
                    <p class="practice-result-subtitle">${resultMessage}</p>
                </div>
                
                <!-- Body -->
                <div class="practice-result-body">
                    
                    <!-- Score Circle -->
                    <div class="practice-score-circle">
                        <svg class="practice-score-svg" viewBox="0 0 36 36">
                            <circle class="practice-score-circle-bg" cx="18" cy="18" r="15.9"></circle>
                            <circle class="practice-score-circle-fill" 
                                    cx="18" cy="18" r="15.9" 
                                    stroke-dasharray="${scorePercentage}, 100"
                                    style="stroke: ${scorePercentage >= 75 ? '#27ae60' : (scorePercentage >= 50 ? '#f39c12' : '#e74c3c')};">
                            </circle>
                        </svg>
                        <div class="practice-score-number">
                            ${scorePercentage}%
                        </div>
                    </div>
                    
                    <!-- Statistics Grid -->
                    <div class="practice-stats-grid">
                        <div class="practice-stat-item">
                            <div class="practice-stat-value">${results.correctAnswers || 0}</div>
                            <div class="practice-stat-label">Correct</div>
                        </div>
                        
                        <div class="practice-stat-item">
                            <div class="practice-stat-value">${results.wrongAnswers || 0}</div>
                            <div class="practice-stat-label">Wrong</div>
                        </div>
                        
                        <div class="practice-stat-item">
                            <div class="practice-stat-value">${results.totalQuestions || 0}</div>
                            <div class="practice-stat-label">Total</div>
                        </div>
                        
                        <div class="practice-stat-item">
                            <div class="practice-stat-value">${timeDisplay}</div>
                            <div class="practice-stat-label">Time</div>
                        </div>
                    </div>
                    
                    <!-- Points Earned -->
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin: 20px 0; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #7a0000;">
                            +${results.correctAnswers * 10 || 0}
                        </div>
                        <div style="font-size: 12px; color: #7f8c8d;">Points Earned</div>
                    </div>
                    
                    <!-- Overall Progress -->
                    <div class="practice-total-progress">
                        <h4 style="margin: 0 0 15px 0; color: #2c3e50; font-size: 16px;">
                            <i class="fas fa-chart-line" style="color: #7a0000;"></i> 
                            Your Overall Progress
                        </h4>
                        
                        <!-- Lessons Progress -->
                        <div style="margin-bottom: 15px;">
                            <div class="practice-progress-label">
                                <span><i class="fas fa-book"></i> Lessons Completed</span>
                                <span><strong>${lessonsCompleted}/${totalLessons}</strong></span>
                            </div>
                            <div class="practice-progress-bar">
                                <div class="practice-progress-fill" style="width: ${lessonsPercentage}%"></div>
                            </div>
                        </div>
                        
                        <!-- Exercises Progress -->
                        <div>
                            <div class="practice-progress-label">
                                <span><i class="fas fa-pencil-alt"></i> Exercises Completed</span>
                                <span><strong>${exercisesCompleted}</strong></span>
                            </div>
                            <div class="practice-progress-bar">
                                <div class="practice-progress-fill" style="width: ${Math.min(exercisesCompleted * 10, 100)}%"></div>
                            </div>
                        </div>
                        
                        <!-- Achievement Badge -->
                        ${scorePercentage >= 90 ? `
                            <div class="practice-completion-badge">
                                <i class="fas fa-trophy"></i> Achievement Unlocked: Math Master
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- Encouragement Message -->
                    <div style="background: #fff9e6; padding: 15px; border-radius: 10px; text-align: center; border-left: 4px solid #f39c12;">
                        <i class="fas fa-quote-left" style="color: #f39c12; margin-right: 8px;"></i>
                        ${encouragementMessage}
                    </div>
                    
                    <!-- Tips (if score < 75) -->
                    ${tipsHTML}
                    
                </div>
                
                <!-- Footer -->
                <div class="practice-result-footer">
                    <button class="practice-result-btn secondary" onclick="closePracticeResultModal()">
                        <i class="fas fa-times"></i> Close
                    </button>
                    <button class="practice-result-btn primary" onclick="tryPracticeAgain()">
                        <i class="fas fa-redo"></i> Try Again
                    </button>
                    <button class="practice-result-btn success" onclick="goToNextPractice()">
                        <i class="fas fa-arrow-right"></i> Next Exercise
                    </button>
                </div>
                
            </div>
        </div>
    `;
    
    // Add to DOM
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Refresh statistics after showing modal
    setTimeout(() => {
        loadPracticeStatistics();
        updateProgressSummaryCards();
    }, 500);
}

// Helper functions for modal buttons
window.closePracticeResultModal = function() {
    const modal = document.querySelector('.practice-result-modal');
    if (modal) {
        modal.remove();
    }
};

window.tryPracticeAgain = function() {
    closePracticeResultModal();
    // Get the last exercise and try again
    if (PracticeState.currentExercise) {
        startPractice(PracticeState.currentExercise.exercise_id, false);
    }
};

window.goToNextPractice = function() {
    closePracticeResultModal();
    
    // Find next exercise in the current topic
    if (PracticeState.exercises && PracticeState.exercises.length > 0 && PracticeState.currentExercise) {
        const currentIndex = PracticeState.exercises.findIndex(e => 
            e.exercise_id === PracticeState.currentExercise.exercise_id
        );
        
        if (currentIndex >= 0 && currentIndex < PracticeState.exercises.length - 1) {
            // There is a next exercise
            startPractice(PracticeState.exercises[currentIndex + 1].exercise_id);
        } else {
            // No next exercise, refresh the list
            showNotification('All exercises completed! Great job! ðŸŽ‰', 'success');
            if (PracticeState.currentTopic) {
                loadPracticeExercisesForTopic(PracticeState.currentTopic);
            }
        }
    }
};
// Call this function when initializing practice page
addPracticeResultModalStyles();

// ============================================
// âœ… FIXED: fetchPracticeStatistics - WITH CORRECT ENDPOINTS
// ============================================
async function fetchPracticeStatistics(topicId = null) {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) {
            console.warn('No auth token available');
            return getDefaultPracticeStats();
        }
        
        console.log('ðŸ“Š Fetching practice statistics FROM DATABASE...');
        
        // ===== STEP 1: GET LESSONS COMPLETED =====
        let lessonsCompleted = 0;
        let totalLessons = 3; // Default
        
        try {
            // âœ… FIX: Add /api/ prefix
            const progressResponse = await fetch(`/api/progress/lessons`, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            // Check if response is JSON
            const contentType = progressResponse.headers.get('content-type');
            if (contentType && contentType.includes('application/json') && progressResponse.ok) {
                const progressData = await progressResponse.json();
                if (progressData.success && progressData.progress) {
                    // Count completed lessons
                    lessonsCompleted = progressData.progress.filter(p => 
                        p.completion_status === 'completed' || p.status === 'completed'
                    ).length;
                    
                    console.log(`âœ… Found ${lessonsCompleted} completed lessons`);
                }
            } else {
                console.log('âš ï¸ Using default lesson count');
                lessonsCompleted = 0;
            }
            
            // Get total lessons count
            const lessonsResponse = await fetch(`/api/lessons-db/complete`, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (lessonsResponse.ok) {
                const contentType = lessonsResponse.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    const lessonsData = await lessonsResponse.json();
                    if (lessonsData.success && lessonsData.lessons) {
                        totalLessons = lessonsData.lessons.length;
                    }
                }
            }
            
        } catch (lessonsError) {
            console.warn('âš ï¸ Could not fetch lessons:', lessonsError.message);
        }
        
        // ===== STEP 2: GET PRACTICE ATTEMPTS =====
        let exercisesCompleted = 0;
        let totalAttempts = 0;
        let totalScore = 0;
        let totalTimeSeconds = 0;
        
        try {
            // âœ… FIX: Add /api/ prefix
            const attemptsResponse = await fetch(`/api/progress/practice-attempts`, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            const contentType = attemptsResponse.headers.get('content-type');
            if (contentType && contentType.includes('application/json') && attemptsResponse.ok) {
                const attemptsData = await attemptsResponse.json();
                if (attemptsData.success && attemptsData.attempts) {
                    const attempts = attemptsData.attempts;
                    
                    // Count COMPLETED exercises
                    const completedExercises = attempts.filter(a => 
                        a.completion_status === 'completed' || 
                        a.score > 0 || 
                        a.status === 'completed' ||
                        a.percentage >= 70
                    );
                    
                    exercisesCompleted = completedExercises.length;
                    totalAttempts = attempts.length;
                    
                    // Compute average score
                    if (totalAttempts > 0) {
                        const totalScoreSum = attempts.reduce((sum, a) => sum + (a.score || 0), 0);
                        totalScore = Math.round(totalScoreSum / totalAttempts);
                    }
                    
                    // Calculate total time spent
                    totalTimeSeconds = attempts.reduce((sum, a) => sum + (a.time_spent_seconds || 0), 0);
                    
                    console.log(`âœ… Found ${exercisesCompleted} completed exercises out of ${totalAttempts} attempts`);
                    console.log(`â±ï¸ Total practice time: ${totalTimeSeconds} seconds`);
                }
            }
        } catch (attemptsError) {
            console.warn('âš ï¸ Could not fetch practice attempts:', attemptsError.message);
        }
        
        // ===== CREATE STATS OBJECT =====
        const stats = {
            total_exercises_completed: exercisesCompleted,
            total_attempts: totalAttempts,
            average_score: totalScore,
            lessons_completed: lessonsCompleted,
            exercises_completed: exercisesCompleted,
            practice_unlocked: true,
            total_lessons: totalLessons,
            total_time_minutes: Math.round(totalTimeSeconds / 60),
            total_time_seconds: totalTimeSeconds,
            accuracy_rate: totalScore,
            lessons_display: `${lessonsCompleted}/${totalLessons}`,
            exercises_display: `${exercisesCompleted}`,
            lessons_percentage: totalLessons > 0 ? Math.round((lessonsCompleted / totalLessons) * 100) : 0
        };
        
        console.log('âœ… FINAL PRACTICE STATISTICS:', stats);
        
        // Save to PracticeState
        PracticeState.userPracticeProgress = stats;
        
        return stats;
        
    } catch (error) {
        console.error('âŒ Error fetching practice statistics:', error);
        return getDefaultPracticeStats();
    }
}

// Get quiz category progress
async function fetchQuizCategoryProgress(categoryId = null) {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) {
            console.warn('No auth token available');
            return {};
        }
        
        console.log('ðŸ“Š Fetching quiz category progress...');
        
        let url = `/progress/quiz-category-progress`;
        if (categoryId) {
            url += `?category_id=${categoryId}`;
        }
        
        const response = await fetch(url, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`Failed to fetch quiz category progress: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success && data.progress) {
            console.log('âœ… Quiz category progress loaded');
            return data.progress;
        } else {
            throw new Error(data.message || 'No quiz category progress returned');
        }
    } catch (error) {
        console.error('Error fetching quiz category progress:', error);
        return {};
    }
}

// Get progress heatmap data
async function fetchProgressHeatmap(startDate = null, endDate = null) {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) {
            console.warn('No auth token available');
            return [];
        }
        
        console.log('ðŸ“… Fetching progress heatmap data...');
        
        let url = `/progress/heatmap`;
        if (startDate && endDate) {
            url += `?start_date=${startDate}&end_date=${endDate}`;
        }
        
        const response = await fetch(url, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`Failed to fetch progress heatmap: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success && data.heatmap) {
            console.log(`âœ… Fetched ${data.heatmap.length} days of heatmap data`);
            return data.heatmap;
        } else {
            throw new Error(data.message || 'No heatmap data returned');
        }
    } catch (error) {
        console.error('Error fetching progress heatmap:', error);
        return [];
    }
}

// Create a new learning goal
async function createLearningGoal(goalData) {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) {
            console.warn('No auth token available');
            return null;
        }
        
        console.log('ðŸŽ¯ Creating new learning goal...');
        
        const response = await fetch(`/api/progress/create-goal`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(goalData)
        });
        
        if (!response.ok) {
            throw new Error(`Failed to create learning goal: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success && data.goal) {
            console.log('âœ… Learning goal created:', data.goal.goal_title);
            
            // Log this activity
            await logUserActivity('goal_set', data.goal.goal_id, {
                goal_title: data.goal.goal_title,
                goal_type: data.goal.goal_type
            }, 10);
            
            return data.goal;
        } else {
            throw new Error(data.message || 'Failed to create learning goal');
        }
    } catch (error) {
        console.error('Error creating learning goal:', error);
        return null;
    }
}

// Update dashboard widget configuration
async function updateDashboardWidgets(widgetConfig) {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) {
            console.warn('No auth token available');
            return false;
        }
        
        console.log('âš™ï¸ Updating dashboard widgets...');
        
        const response = await fetch(`/api/progress/update-widgets`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(widgetConfig)
        });
        
        if (!response.ok) {
            throw new Error(`Failed to update dashboard widgets: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            console.log('âœ… Dashboard widgets updated');
            return true;
        } else {
            throw new Error(data.message || 'Failed to update dashboard widgets');
        }
    } catch (error) {
        console.error('Error updating dashboard widgets:', error);
        return false;
    }
}

// ============================================
// INITIALIZE PROGRESS DASHBOARD - UPDATED
// ============================================
// ============================================
// INITIALIZE PROGRESS DASHBOARD - UPDATED
// ============================================
async function initProgressDashboard() {
    console.log('ðŸ“ˆ Initializing progress dashboard with database integration...');
    
    try {
        // Show loading state
        showProgressDashboardLoading();
        
        // Load all progress data
        await updateProgressDashboardFromDatabase();
        
        // Load topic mastery for detailed breakdown
        await fetchTopicMastery();
        
        // Load achievements
        await fetchAchievementTimeline(10);
        
        // Load activity log
        await fetchActivityLog(15);
        
        // Initialize charts
        await initProgressCharts();
        
        // âœ… SIGURADUHING may value ang progressRefreshInterval bago gamitin
        if (typeof progressRefreshInterval !== 'undefined') {
            // Start auto-refresh (every 60 seconds)
            startProgressAutoRefresh(60);
        } else {
            console.error('âŒ progressRefreshInterval is not defined!');
            // Fallback: initialize it first
            progressRefreshInterval = null;
            startProgressAutoRefresh(60);
        }
        
        console.log('âœ… Progress dashboard initialized with database integration');
    } catch (error) {
        console.error('Error initializing progress dashboard:', error);
    }
}


// ============================================
// CHECK AND AWARD BADGES AUTOMATICALLY
// ============================================
async function checkAndAwardBadges() {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) return;
        
        // Get user stats
        const [progress, quizStats] = await Promise.all([
            fetch(`/api/progress/cumulative`, {
                headers: { 'Authorization': `Bearer ${token}` }
            }).then(res => res.json()),
            fetch(`/api/quiz/user/stats`, {
                headers: { 'Authorization': `Bearer ${token}` }
            }).then(res => res.json())
        ]);
        
        if (!progress.success || !quizStats.success) return;
        
        const stats = {
            lessonsCompleted: progress.progress?.total_lessons_completed || 0,
            exercisesCompleted: progress.progress?.exercises_completed || 0,
            quizScore: quizStats.stats?.best_score || 0,
            streakDays: progress.progress?.streak_days || 0
        };
        
        // Check for First Lesson badge
        if (stats.lessonsCompleted >= 1) {
            await awardBadge('First Lesson', 'Completed your first lesson', 'fas fa-book-open', '#3498db', 10);
        }
        
        // Check for Quick Learner badge (5 lessons)
        if (stats.lessonsCompleted >= 5) {
            await awardBadge('Quick Learner', 'Completed 5 lessons', 'fas fa-rocket', '#9b59b6', 20);
        }
        
        // Check for Math Master badge (10 lessons)
        if (stats.lessonsCompleted >= 10) {
            await awardBadge('Math Master', 'Completed 10 lessons', 'fas fa-crown', '#f39c12', 30);
        }
        
        // Check for Practice Makes Perfect badge (10 exercises)
        if (stats.exercisesCompleted >= 10) {
            await awardBadge('Practice Makes Perfect', 'Completed 10 practice exercises', 'fas fa-pencil-alt', '#27ae60', 15);
        }
        
        // Check for Quiz Champion badge (100% on quiz)
        if (stats.quizScore >= 100) {
            await awardBadge('Quiz Champion', 'Scored 100% on a quiz', 'fas fa-trophy', '#e74c3c', 25);
        }
        
        // Check for Perfect Week badge (7 day streak)
        if (stats.streakDays >= 7) {
            await awardBadge('Perfect Week', 'Active for 7 consecutive days', 'fas fa-calendar-check', '#1abc9c', 20);
        }
        
    } catch (error) {
        console.error('Error checking badges:', error);
    }
}

// ============================================
// AWARD SPECIFIC BADGE
// ============================================
async function awardBadge(badgeName, description, icon, color, points) {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        
        const response = await fetch(`/api/badges/award`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                badge_name: badgeName,
                description: description,
                icon: icon,
                color: color,
                points: points
            })
        });
        
        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                console.log(`âœ… Awarded badge: ${badgeName}`);
                
                // Show notification
                showNotification(`ðŸŽ‰ Earned badge: ${badgeName}!`, 'success');
                
                // Refresh badges
                await loadUserBadges();
                
                return true;
            }
        }
        return false;
    } catch (error) {
        console.error('Error awarding badge:', error);
        return false;
    }
}

// Get detailed practice statistics including average score and time
async function getDetailedPracticeStats() {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) {
            console.warn('No auth token available');
            return null;
        }
        
        console.log('ðŸ“Š Fetching detailed practice statistics...');
        
        const response = await fetch(`/api/progress/practice-analytics`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                console.log('âœ… Detailed practice stats loaded:', data.stats);
                return data.stats;
            }
        }
        
        // If endpoint doesn't exist, try to calculate from user progress
        console.log('âš ï¸ Practice analytics endpoint not found, calculating from local data...');
        
        // Get all practice attempts
        const attemptsResponse = await fetch(`/api/progress/practice-attempts`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (attemptsResponse.ok) {
            const attemptsData = await attemptsResponse.json();
            if (attemptsData.success && attemptsData.attempts) {
                const attempts = attemptsData.attempts;
                
                if (attempts.length > 0) {
                    const totalScore = attempts.reduce((sum, a) => sum + (a.score || 0), 0);
                    const totalTime = attempts.reduce((sum, a) => sum + (a.time_spent_seconds || 0), 0);
                    const completedCount = attempts.length;
                    
                    return {
                        total_attempts: completedCount,
                        average_score: Math.round(totalScore / completedCount),
                        average_time_seconds: Math.round(totalTime / completedCount),
                        average_time_minutes: Math.round((totalTime / completedCount) / 60),
                        total_exercises_completed: completedCount
                    };
                }
            }
        }
        
        return null;
    } catch (error) {
        console.error('Error fetching detailed practice stats:', error);
        return null;
    }
}


// ============================================
// âœ… FIXED: loadProgressDashboardData - IMMEDIATE LOADING
// ============================================
async function loadProgressDashboardData() {
    console.log('ðŸ“Š Loading progress dashboard data IMMEDIATELY...');
    
    try {
        // Show loading state
        showProgressDashboardLoading();
        
        // Load cumulative progress FIRST with await - this is the critical data
        console.log('ðŸ“Š Step 1: Loading cumulative progress...');
        const cumulativeProgress = await fetchCumulativeProgress();
        
        console.log('âœ… Cumulative progress loaded:', cumulativeProgress);
        
        // Force update ng overall progress display AGAD - without waiting for other data
        if (cumulativeProgress) {
            updateOverallProgressDisplay(cumulativeProgress);
        }
        
        // Update progress summary cards immediately with what we have
        updateProgressSummaryCards();
        
        // Load other data in background (para hindi ma-block ang display)
        Promise.allSettled([
            fetchDailyProgress().then(data => {
                ProgressState.dailyProgress = data || {};
                console.log('âœ… Daily progress loaded');
            }),
            fetchTopicMastery().then(data => {
                ProgressState.topicMastery = data || [];
                updateTopicProgressBreakdown();
                console.log('âœ… Topic mastery loaded');
            }),
            fetchPerformanceAnalytics().then(data => {
                ProgressState.performanceAnalytics = data || {};
                updatePerformanceAnalytics(data);
                console.log('âœ… Performance analytics loaded');
            }),
            fetchAchievementTimeline(10).then(data => {
                ProgressState.achievementTimeline = data || [];
                updateAchievementTimeline();
                console.log('âœ… Achievements loaded');
            }),
            fetchActivityLog(15).then(data => {
                ProgressState.activityLog = data || [];
                updateActivityLog();
                console.log('âœ… Activity log loaded');
            }),
            fetchUserBadges().then(data => {
                ProgressState.userBadges = data || [];
                // Update badges display
                const totalBadges = document.getElementById('totalBadges');
                if (totalBadges) {
                    totalBadges.textContent = `${data.length}/10`;
                }
                const badgesChange = document.getElementById('badgesChange');
                if (badgesChange) {
                    badgesChange.textContent = `+${data.length} total badges`;
                }
                console.log('âœ… Badges loaded');
            }),
            fetchAccuracyRate().then(data => {
                ProgressState.accuracyRate = data || { overall: 0 };
                console.log('âœ… Accuracy rate loaded');
            })
        ]).then(() => {
            console.log('âœ… All background data loaded');
            hideProgressDashboardLoading();
            
            // Update again with all data
            updateProgressSummaryCards();
            updateOverallProgressDisplay(cumulativeProgress);
        });
        
        // Hide loading after main data is shown (not waiting for background)
        setTimeout(() => {
            hideProgressDashboardLoading();
        }, 500);
        
        // Initialize charts
        initProgressCharts();
        
    } catch (error) {
        console.error('Error loading progress dashboard data:', error);
        hideProgressDashboardLoading();
        showProgressDashboardError();
    }
}

// ============================================
// âœ… FIXED: HIDE PROGRESS DASHBOARD LOADING
// ============================================
function hideProgressDashboardLoading() {
    console.log('âœ… Hiding loading state');
    
    const elements = [
        { id: 'overallProgress' },
        { id: 'totalPointsProgress' },
        { id: 'totalTime' },
        { id: 'totalBadges' }
    ];
    
    elements.forEach(item => {
        const element = document.getElementById(item.id);
        if (element) {
            element.style.opacity = '1';
            element.classList.remove('loading');
            // Don't reset content, it should already have the correct value
        }
    });
}

// ============================================
// ðŸš€ DIRECT LOADING ON PAGE OPEN
// ============================================
document.addEventListener('DOMContentLoaded', function() {
    console.log('ðŸ“„ DOM loaded - setting up progress page observer');
    
    const progressPage = document.getElementById('progress-page');
    
    if (progressPage) {
        // Check agad kung visible ang progress page
        if (!progressPage.classList.contains('hidden')) {
            console.log('ðŸ“Š Progress page is already visible - loading data NOW');
            setTimeout(() => {
                showProgressDashboardLoading();
                loadProgressDashboardData();
            }, 50);
        }
        
        // Observe for when it becomes visible
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                    if (!progressPage.classList.contains('hidden')) {
                        console.log('ðŸ“Š Progress page became visible - loading data NOW');
                        showProgressDashboardLoading();
                        loadProgressDashboardData();
                    }
                }
            });
        });
        
        observer.observe(progressPage, { attributes: true });
    }
});

// ============================================
// SHOW ERROR STATE
// ============================================
function showProgressDashboardError() {
    const overallProgress = document.getElementById('overallProgress');
    if (overallProgress) {
        overallProgress.innerHTML = '<i class="fas fa-exclamation-triangle" style="color: #e74c3c;"></i>';
    }
    
    showNotification('Failed to load progress data', 'error');
}

// Update progress dashboard UI
function updateProgressDashboardUI() {
    // First try to use the database summary if available
    if (ProgressState.dashboardSummary) {
        updateProgressDashboardFromDatabase();
    } else {
        // Fallback to your existing method
        updateProgressSummaryCards();
    }
    // Update progress summary cards
    updateProgressSummaryCards();
    
    // Update learning goals section
    updateLearningGoalsSection();
    
    // Update activity log
    updateActivityLog();
    
    // Update progress trends chart
    updateProgressTrendsChart();
    
    // Update achievement timeline
    updateAchievementTimeline();
    
    // Update topic mastery section
    updateTopicMasterySection();
    
    // Update module progress section
    updateModuleProgressSection();
}

// ============================================
// âœ… FIXED: updateProgressSummaryCards - WITH AVG TIME
// ============================================
async function updateProgressSummaryCards() {
    console.log('ðŸ“Š Updating progress summary cards with database data...');
    
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) return;
        
        const [progressData, practiceStats, totalExercisesCount] = await Promise.all([
            fetchCumulativeProgress(),
            fetchPracticeStatistics(),
            fetchTotalExercisesCount()
        ]);
        
        console.log('ðŸ“Š Progress data received:', progressData);
        
        // Update lessons count
        const lessonsCount = document.getElementById('lessonsCount');
        if (lessonsCount) {
            const completed = progressData?.total_lessons_completed || 0;
            const total = progressData?.total_lessons || 20;
            lessonsCount.innerHTML = `${completed}<span class="item-unit">/${total}</span>`;
        }
        
        // Update exercises count
        const exercisesCount = document.getElementById('exercisesCount');
        if (exercisesCount) {
            const exercisesCompleted = practiceStats?.exercises_completed || 
                                       progressData?.exercises_completed || 0;
            const totalExercises = totalExercisesCount || 5;
            exercisesCount.innerHTML = `${exercisesCompleted}<span class="item-unit">/${totalExercises}</span>`;
        }
        
        // Update quiz score
        const quizScore = document.getElementById('quizScore');
        if (quizScore) {
            const totalPoints = progressData?.total_points_earned || 0;
            quizScore.innerHTML = `${totalPoints}<span class="item-unit">points</span>`;
        }
        
        // âœ… UPDATE AVG TIME - Ito ay average time per activity
        const avgTime = document.getElementById('avgTime');
        if (avgTime) {
            const avgPerActivity = progressData?.avg_time_per_activity || 5;
            avgTime.innerHTML = `${avgPerActivity}<span class="item-unit">min/activity</span>`;
            console.log(`âœ… Average time updated: ${avgPerActivity} min per activity`);
        }
        
    } catch (error) {
        console.error('âŒ Error updating progress summary cards:', error);
    }
}

// ============================================
// âœ… NEW: fetchWeeklyImprovement - Get weekly improvement from database
// ============================================
async function fetchWeeklyImprovement() {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) return 5; // Default value
        
        const response = await fetch(`/api/progress/weekly-improvement`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!response.ok) return 5;
        
        const data = await response.json();
        
        if (data.success) {
            console.log(`âœ… Weekly improvement: ${data.improvement}%`);
            return data.improvement;
        }
        
        return 5;
        
    } catch (error) {
        console.error('Error fetching weekly improvement:', error);
        return 5;
    }
}


// ============================================
// FIXED: Create modal if missing
// ============================================
function createForgotPasswordModal() {
    console.log('ðŸ“ Creating forgot password modal dynamically...');
    
    const modalHTML = `
        <div id="forgotPasswordModal" class="modal-overlay">
            <div class="modal-container" style="max-width: 450px;">
                <div class="modal-header" style="background: #7a0000; color: white; padding: 15px 20px; border-radius: 10px 10px 0 0;">
                    <h3 style="margin: 0; font-size: 18px;"><i class="fas fa-key"></i> Reset Password</h3>
                    <button class="modal-close" onclick="closeForgotPasswordModal()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">&times;</button>
                </div>
                
                <div class="modal-body" style="padding: 25px;">
                    <!-- Step 1: Email Form -->
                    <div id="forgotStep1" style="display: block;">
                        <p style="margin-bottom: 20px; color: #2c3e50;">Enter your email address and we'll send you a link to reset your password.</p>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50;">
                                <i class="fas fa-envelope"></i> Email Address
                            </label>
                            <input type="email" id="resetEmail" class="form-control" 
                                   placeholder="your@email.com" 
                                   style="width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 6px;">
                        </div>
                        
                        <div id="forgotError" style="display: none; background: #fee9e7; color: #e74c3c; padding: 10px; border-radius: 6px; margin-bottom: 15px; font-size: 14px;"></div>
                        
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button class="btn-secondary" onclick="closeForgotPasswordModal()" style="padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; background: #95a5a6; color: white;">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                            <button class="btn-primary" onclick="requestPasswordReset()" style="padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; background: #7a0000; color: white;">
                                <i class="fas fa-paper-plane"></i> Send Reset Link
                            </button>
                        </div>
                    </div>
                    
                    <!-- Step 2: Reset Link Generated -->
                    <div id="forgotStep2" style="display: none;">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <div style="width: 80px; height: 80px; background: #27ae60; border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-check" style="font-size: 40px; color: white;"></i>
                            </div>
                            <h4 style="color: #2c3e50; margin-bottom: 10px;">Reset Link Generated!</h4>
                            <p style="color: #7f8c8d; margin-bottom: 5px;" id="resetEmailDisplay"></p>
                        </div>
                        
                        <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 20px; border-left: 4px solid #7a0000;">
                            <p style="margin: 0 0 5px 0; font-weight: bold; color: #2c3e50;">
                                <i class="fas fa-info-circle"></i> DEMO MODE (No Email Configured)
                            </p>
                            <p style="margin: 5px 0; color: #34495e; font-size: 14px;">
                                Since email is not connected, use this reset link:
                            </p>
                            <div style="background: white; padding: 10px; border-radius: 5px; border: 1px solid #ddd; margin: 10px 0;">
                                <code id="resetLinkDisplay" style="word-break: break-all; font-size: 12px;"></code>
                            </div>
                            <button class="btn-secondary" onclick="copyResetLink()" style="width: 100%; padding: 8px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                <i class="fas fa-copy"></i> Copy Reset Link
                            </button>
                        </div>
                        
                        <div style="display: flex; gap: 10px; justify-content: center;">
                            <button class="btn-primary" onclick="closeForgotPasswordModal()" style="padding: 10px 20px; background: #7a0000; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                <i class="fas fa-check"></i> OK, Got It
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    console.log('âœ… Modal created');
    
    // Try to show it again
    setTimeout(() => {
        showForgotPasswordModal();
    }, 100);
}


// ============================================
// FORGOT PASSWORD FUNCTIONS - UPDATED FOR YOUR showNotification
// ============================================

let currentResetToken = null;
let currentResetUser = null;

// ============================================
// ULTIMATE FIX: Show forgot password modal
// ============================================
function showForgotPasswordModal() {
    console.log('ðŸ”‘ Opening forgot password modal');
    
    const modal = document.getElementById('forgotPasswordModal');
    if (!modal) {
        console.error('âŒ Modal not found!');
        createForgotPasswordModal();
        return;
    }
    
    // Reset to step 1
    const step1 = document.getElementById('forgotStep1');
    const step2 = document.getElementById('forgotStep2');
    const resetEmail = document.getElementById('resetEmail');
    const forgotError = document.getElementById('forgotError');
    
    if (step1) step1.style.display = 'block';
    if (step2) step2.style.display = 'none';
    if (resetEmail) resetEmail.value = '';
    if (forgotError) forgotError.style.display = 'none';
    
    // SUPER FORCE show modal
    modal.setAttribute('style', 'display: flex !important');
    modal.classList.add('active');
    modal.setAttribute('data-visible', 'true');
    
    // Additional force styles
    modal.style.display = 'flex';
    modal.style.zIndex = '2147483647';
    modal.style.position = 'fixed';
    modal.style.top = '0';
    modal.style.left = '0';
    modal.style.width = '100%';
    modal.style.height = '100%';
    modal.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
    modal.style.alignItems = 'center';
    modal.style.justifyContent = 'center';
    
    // Prevent body scrolling
    document.body.classList.add('modal-open');
    document.body.style.overflow = 'hidden';
    
    console.log('âœ… Modal styles applied');
    
    // Double-check after a tiny delay
    setTimeout(() => {
        const computedStyle = window.getComputedStyle(modal);
        console.log('ðŸ“Š Computed display:', computedStyle.display);
        
        if (computedStyle.display === 'none') {
            console.log('âš ï¸ Modal still hidden, forcing again...');
            modal.style.display = 'flex';
            modal.style.zIndex = '2147483647';
        }
    }, 100);
}

function closeForgotPasswordModal() {
    console.log('ðŸ”’ Closing forgot password modal');
    
    const modal = document.getElementById('forgotPasswordModal');
    if (modal) {
        modal.style.display = 'none';
        modal.classList.remove('active');
        modal.removeAttribute('data-visible');
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
    }
}

// ============================================
// âœ… KEEP THIS VERSION (should be around line 4720)
// ============================================
async function requestPasswordReset() {
    const email = document.getElementById('resetEmail').value.trim();
    const errorDiv = document.getElementById('forgotError');
    
    if (!email) {
        errorDiv.textContent = 'Please enter your email address';
        errorDiv.style.display = 'block';
        return;
    }
    
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        errorDiv.textContent = 'Please enter a valid email address';
        errorDiv.style.display = 'block';
        return;
    }
    
    // Show loading
    const submitBtn = document.querySelector('#forgotStep1 .btn-primary');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
    submitBtn.disabled = true;
    errorDiv.style.display = 'none';
    
    try {
        const response = await fetch('/api/auth/forgot-password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ email })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Show step 2 with reset link (demo mode)
            document.getElementById('forgotStep1').style.display = 'none';
            document.getElementById('forgotStep2').style.display = 'block';
            
            document.getElementById('resetEmailDisplay').textContent = `Email: ${email}`;
            
            if (data.demo_mode && data.reset_link) {
                document.getElementById('resetLinkDisplay').textContent = data.reset_link;
                currentResetToken = data.reset_token;
            }
            
            showNotification('success', 'Success!', 'Reset link generated! Check the modal for instructions.');
        } else {
            errorDiv.textContent = data.message || 'Failed to process request';
            errorDiv.style.display = 'block';
        }
    } catch (error) {
        console.error('Error:', error);
        errorDiv.textContent = 'Network error. Please try again.';
        errorDiv.style.display = 'block';
    } finally {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }
}





// Copy reset link to clipboard
function copyResetLink() {
    const linkText = document.getElementById('resetLinkDisplay').textContent;
    
    navigator.clipboard.writeText(linkText).then(() => {
        // âœ… UPDATED: Use your 3-parameter showNotification
        showNotification('success', 'Copied!', 'Reset link copied to clipboard!');
    }).catch(() => {
        // Fallback
        const textarea = document.createElement('textarea');
        textarea.value = linkText;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        
        // âœ… UPDATED: Use your 3-parameter showNotification
        showNotification('success', 'Copied!', 'Reset link copied to clipboard!');
    });
}

// Show reset password modal (when user clicks reset link)
function showResetPasswordModal(token) {
    console.log('ðŸ” Opening reset password modal with token:', token);
    
    const modal = document.getElementById('resetPasswordModal');
    if (!modal) return;
    
    currentResetToken = token;
    
    // Show loading
    document.getElementById('resetPasswordStep1').style.display = 'block';
    document.getElementById('resetUserName').textContent = 'Loading...';
    document.getElementById('resetUserEmail').textContent = 'Verifying token...';
    document.getElementById('resetError').style.display = 'none';
    document.getElementById('resetSuccess').style.display = 'none';
    
    modal.style.display = 'flex';
    document.body.classList.add('modal-open');
    
    // Verify token
    verifyResetToken(token);
}

// Close reset password modal
function closeResetPasswordModal() {
    const modal = document.getElementById('resetPasswordModal');
    if (modal) {
        modal.style.display = 'none';
        document.body.classList.remove('modal-open');
    }
    currentResetToken = null;
    currentResetUser = null;
}

// Verify reset token
async function verifyResetToken(token) {
    try {
        const response = await fetch('/api/auth/verify-reset-token', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ token })
        });
        
        const data = await response.json();
        
        if (data.success) {
            currentResetUser = data.user;
            document.getElementById('resetUserName').textContent = data.user.name || 'User';
            document.getElementById('resetUserEmail').textContent = data.user.email;
            
            // Setup password strength checker
            setupPasswordStrengthChecker();
        } else {
            document.getElementById('resetError').textContent = data.message || 'Invalid or expired reset link';
            document.getElementById('resetError').style.display = 'block';
            document.getElementById('resetUserName').textContent = 'Invalid Token';
            document.getElementById('resetUserEmail').textContent = 'Please request a new reset link';
        }
    } catch (error) {
        console.error('Error:', error);
        document.getElementById('resetError').textContent = 'Failed to verify token';
        document.getElementById('resetError').style.display = 'block';
    }
}

// Setup password strength checker
function setupPasswordStrengthChecker() {
    const passwordInput = document.getElementById('newPassword');
    const strengthMeter = document.getElementById('passwordStrength');
    
    if (passwordInput) {
        passwordInput.addEventListener('input', function() {
            const password = this.value;
            let strength = 0;
            
            if (password.length >= 6) strength += 25;
            if (/[a-z]/.test(password)) strength += 25;
            if (/[A-Z]/.test(password)) strength += 25;
            if (/[0-9]/.test(password)) strength += 25;
            
            strengthMeter.style.width = `${strength}%`;
            
            if (strength < 50) {
                strengthMeter.style.backgroundColor = '#e74c3c';
            } else if (strength < 75) {
                strengthMeter.style.backgroundColor = '#f39c12';
            } else {
                strengthMeter.style.backgroundColor = '#27ae60';
            }
        });
    }
}

// Submit password reset
async function submitPasswordReset() {
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmNewPassword').value;
    const errorDiv = document.getElementById('resetError');
    const successDiv = document.getElementById('resetSuccess');
    
    if (!newPassword || !confirmPassword) {
        errorDiv.textContent = 'Please enter both password fields';
        errorDiv.style.display = 'block';
        return;
    }
    
    if (newPassword !== confirmPassword) {
        errorDiv.textContent = 'Passwords do not match';
        errorDiv.style.display = 'block';
        return;
    }
    
    if (newPassword.length < 6) {
        errorDiv.textContent = 'Password must be at least 6 characters';
        errorDiv.style.display = 'block';
        return;
    }
    
    if (!currentResetToken) {
        errorDiv.textContent = 'Reset token is missing. Please request a new reset link.';
        errorDiv.style.display = 'block';
        return;
    }
    
    // Show loading
    const submitBtn = document.querySelector('#resetPasswordStep1 .btn-primary');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Resetting...';
    submitBtn.disabled = true;
    errorDiv.style.display = 'none';
    
    try {
        const response = await fetch('/api/auth/reset-password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                token: currentResetToken,
                new_password: newPassword,
                confirm_password: confirmPassword
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Show success
            successDiv.style.display = 'block';
            successDiv.innerHTML = '<i class="fas fa-check-circle"></i> ' + data.message;
            
            // Disable inputs
            document.getElementById('newPassword').disabled = true;
            document.getElementById('confirmNewPassword').disabled = true;
            
            // Hide error
            errorDiv.style.display = 'none';
            
            // Change button to success
            submitBtn.innerHTML = '<i class="fas fa-check"></i> Password Reset!';
            
            // Show notification
            showNotification('success', 'Password Reset!', 'Your password has been changed successfully.');
            
            // Close modal and redirect after 3 seconds
            setTimeout(() => {
                closeResetPasswordModal();
                navigateTo('login');
                
                // Pre-fill email if available
                if (currentResetUser && currentResetUser.email) {
                    const loginEmail = document.getElementById('loginEmail');
                    if (loginEmail) {
                        loginEmail.value = currentResetUser.email;
                    }
                }
            }, 3000);
        } else {
            errorDiv.textContent = data.message || 'Failed to reset password';
            errorDiv.style.display = 'block';
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    } catch (error) {
        console.error('Error:', error);
        errorDiv.textContent = 'Network error. Please try again.';
        errorDiv.style.display = 'block';
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }
}

// Check for reset token in URL (when page loads)
function checkForResetToken() {
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    
    if (token) {
        // Clean URL (remove token)
        const newUrl = window.location.pathname;
        window.history.replaceState({}, document.title, newUrl);
        
        // Show reset modal
        setTimeout(() => {
            showResetPasswordModal(token);
        }, 500);
    }
}

// ============================================
// FIXED: Initialize forgot password link - WITH DEBUGGING
// ============================================
function initForgotPasswordLink() {
    console.log('ðŸ” Attempting to initialize forgot password link...');
    
    // Try to find the link immediately
    let forgotLink = document.getElementById('forgotPasswordLink');
    
    if (forgotLink) {
        console.log('âœ… Forgot password link found!');
        
        // Remove any existing event listeners
        const newLink = forgotLink.cloneNode(true);
        forgotLink.parentNode.replaceChild(newLink, forgotLink);
        
        newLink.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('ðŸ”‘ Forgot password link clicked!');
            showForgotPasswordModal();
        });
        
        console.log('âœ… Event listener attached successfully');
    } else {
        console.error('âŒ Forgot password link NOT FOUND! Will retry...');
        
        // Try again after a short delay (for dynamically loaded content)
        setTimeout(() => {
            const retryLink = document.getElementById('forgotPasswordLink');
            if (retryLink) {
                console.log('âœ… Found on retry!');
                initForgotPasswordLink();
            } else {
                console.error('âŒ Still not found after retry');
            }
        }, 500);
        
        // Also try when login page becomes visible
        const loginPage = document.getElementById('login-page');
        if (loginPage) {
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                        if (!loginPage.classList.contains('hidden')) {
                            console.log('ðŸ“„ Login page became visible - rechecking for forgot link');
                            setTimeout(() => {
                                const link = document.getElementById('forgotPasswordLink');
                                if (link && !link._hasListener) {
                                    initForgotPasswordLink();
                                }
                            }, 300);
                        }
                    }
                });
            });
            
            observer.observe(loginPage, { attributes: true });
        }
    }
}

// ============================================
// DOM CONTENT LOADED - COMPLETE VERSION
// ============================================
document.addEventListener('DOMContentLoaded', function() {
    console.log('ðŸ“„ DOM fully loaded - initializing all features');
    
    // âœ… I-initialize ang progressRefreshInterval
    progressRefreshInterval = null;
    
    // Initialize app first
    initApp();
    
    // Add all styles
    addQuizStyles();
    addProgressStyles();
    addPracticeResultModalStyles();
    addChartStyles();
    addSettingsStyles();
    addFeedbackStyles();
    addLessonContentStyles();
    addReviewModalStyles();
    
  
    
    // Initialize forgot password link - call it multiple times to ensure it works
    setTimeout(() => {
        initForgotPasswordLink();
    }, 100);
    
    setTimeout(() => {
        initForgotPasswordLink();
    }, 500);
    
    // Also check when login page becomes visible
    const loginPage = document.getElementById('login-page');
    if (loginPage) {
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                    if (!loginPage.classList.contains('hidden')) {
                        console.log('ðŸ“„ Login page became visible - initializing forgot link');
                        setTimeout(initForgotPasswordLink, 200);
                    }
                }
            });
        });
        
        observer.observe(loginPage, { attributes: true });
    }
    
    // Initialize progress dashboard if visible
    const progressPage = document.getElementById('progress-page');
    if (progressPage) {
        if (!progressPage.classList.contains('hidden')) {
            console.log('ðŸ“Š Progress page is already visible - loading data NOW');
            setTimeout(() => {
                showProgressDashboardLoading();
                initProgressDashboard();
            }, 50);
        }
        
        // Observe for when progress page becomes visible
        const progressObserver = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                    if (!progressPage.classList.contains('hidden')) {
                        console.log('ðŸ“Š Progress page became visible');
                        setTimeout(() => {
                            showProgressDashboardLoading();
                            initProgressDashboard();
                        }, 300);
                    } else {
                        // Stop refresh when hidden
                        if (typeof stopProgressAutoRefresh === 'function') {
                            stopProgressAutoRefresh();
                        }
                    }
                }
            });
        });
        
        progressObserver.observe(progressPage, { attributes: true });
    }
    
    // Initialize quiz dashboard if visible
    const quizPage = document.getElementById('quiz-dashboard-page');
    if (quizPage) {
        if (!quizPage.classList.contains('hidden')) {
            setTimeout(() => {
                initQuizDashboard();
            }, 300);
        }
        
        const quizObserver = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                    if (!quizPage.classList.contains('hidden')) {
                        console.log('ðŸ§  Quiz page became visible');
                        setTimeout(() => {
                            initQuizDashboard();
                        }, 300);
                    }
                }
            });
        });
        
        quizObserver.observe(quizPage, { attributes: true });
    }
    
    // Initialize practice page if visible
    const practicePage = document.getElementById('practice-exercises-page');
    if (practicePage) {
        if (!practicePage.classList.contains('hidden')) {
            setTimeout(() => {
                initPracticePage();
            }, 300);
        }
        
        const practiceObserver = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                    if (!practicePage.classList.contains('hidden')) {
                        console.log('ðŸ’ª Practice page became visible');
                        setTimeout(() => {
                            initPracticePage();
                        }, 300);
                    }
                }
            });
        });
        
        practiceObserver.observe(practicePage, { attributes: true });
    }
    
    // Initialize time tracker
    setTimeout(() => {
        if (typeof initializeTimeTracker === 'function') {
            initializeTimeTracker();
        }
    }, 2000);
    
    // Check for reset token in URL
    if (typeof checkForResetToken === 'function') {
        checkForResetToken();
    }
    
    // Ensure feedback history loads
    if (typeof ensureFeedbackHistoryLoads === 'function') {
        ensureFeedbackHistoryLoads();
    }
    
    // Connect tool buttons
    if (typeof connectToolButtons === 'function') {
        connectToolButtons();
    }
    
    // Connect review buttons
    setTimeout(() => {
        if (typeof connectReviewButtons === 'function') {
            connectReviewButtons();
        }
        console.log('âœ… Review buttons connected');
    }, 1000);
    
    // Connect quiz buttons
    setTimeout(() => {
        if (typeof setupQuizButtons === 'function') {
            setupQuizButtons();
        }
    }, 1000);
    
    // Check visibility on page load
    setTimeout(() => {
        if (typeof checkAndFixQuizVisibility === 'function') {
            checkAndFixQuizVisibility();
        }
    }, 100);
    
    console.log('âœ… All features initialized');
    
    // Add window unload handler to clean up intervals
    window.addEventListener('beforeunload', function() {
        if (progressRefreshInterval) {
            clearInterval(progressRefreshInterval);
            progressRefreshInterval = null;
        }
        
        if (typeof stopQuizStatsAutoRefresh === 'function') {
            stopQuizStatsAutoRefresh();
        }
    });
});


// ============================================
// FIXED: Add a direct click handler as backup
// ============================================
document.addEventListener('click', function(e) {
    // Check if clicked element is the forgot password link
    if (e.target && e.target.id === 'forgotPasswordLink') {
        e.preventDefault();
        e.stopPropagation();
        console.log('ðŸŽ¯ Forgot password link clicked via delegation!');
        showForgotPasswordModal();
        return false;
    }
    
    // Check if clicked element is inside a link with that ID
    const forgotLink = e.target.closest('#forgotPasswordLink');
    if (forgotLink) {
        e.preventDefault();
        e.stopPropagation();
        console.log('ðŸŽ¯ Forgot password link clicked via delegation (closest)!');
        showForgotPasswordModal();
        return false;
    }
}, true); // Use capture phase to ensure it runs first

// ============================================
// âœ… FIXED: Connect tool buttons with direct handlers
// ============================================
function connectToolButtons() {
    console.log('ðŸ”§ Connecting tool buttons...');

    // Define tool buttons and their corresponding modals
    const tools = [
        { id: 'openCalculator', name: 'calculator' },
        { id: 'openGraphTools', name: 'graph' },
        { id: 'openNotepad', name: 'notepad' },
        { id: 'openFormulaSheet', name: 'formula' },
        { id: 'openWhiteboard', name: 'whiteboard' },
        { id: 'openTimer', name: 'timer' }
    ];

    // Initialize ToolManager if not exists
    if (!window.toolManager) {
        console.log('ðŸ”§ Creating new ToolManager...');
        window.toolManager = new ToolManager();
    }

    // Connect each button
    tools.forEach(tool => {
        const btn = document.getElementById(tool.id);
        if (btn) {
            console.log(`ðŸ”§ Found button: ${tool.id}`);
            
            // Remove old listeners by cloning
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            
            // Add new listener
            newBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                console.log(`ðŸŽ¯ Opening ${tool.name}`);
                
                // Make sure ToolManager exists
                if (!window.toolManager) {
                    window.toolManager = new ToolManager();
                }
                
                // Open the tool
                window.toolManager.openTool(tool.name);
            });
            
            console.log(`âœ… Connected ${tool.id}`);
        } else {
            console.warn(`âš ï¸ Button not found: ${tool.id}`);
        }
    });
    
    // Also connect buttons with data-tool attribute
    document.querySelectorAll('[data-tool]').forEach(btn => {
        const toolName = btn.getAttribute('data-tool');
        if (toolName) {
            console.log(`ðŸ”§ Found button with data-tool: ${toolName}`);
            
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            
            newBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                console.log(`ðŸŽ¯ Opening ${toolName} via data-tool`);
                
                if (!window.toolManager) {
                    window.toolManager = new ToolManager();
                }
                
                window.toolManager.openTool(toolName);
            });
        }
    });
    
    console.log('âœ… All tool buttons connected');
}

// ============================================
// âœ… NEW: Fetch total exercises count from database
// ============================================
async function fetchTotalExercisesCount() {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) return 5; // Default fallback
        
        console.log('ðŸ“Š Fetching total exercises count...');
        
        // Try multiple endpoints to get total exercises
        const endpoints = [
            `/practice/exercises/count`,
            `/admin/practice/stats`,
            `/practice/exercises`
        ];
        
        for (const endpoint of endpoints) {
            try {
                const response = await fetch(endpoint, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Handle different response formats
                    if (data.success) {
                        if (data.count) return data.count;
                        if (data.total) return data.total;
                        if (data.stats?.totalExercises) return data.stats.totalExercises;
                        if (data.exercises?.length) return data.exercises.length;
                    }
                }
            } catch (e) {
                console.log(`Endpoint ${endpoint} failed:`, e.message);
            }
        }
        
        // If all endpoints fail, try to get from practice_exercises table directly
        // using a custom query endpoint if available
        try {
            const response = await fetch(`/api/debug/practice/count`, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.count) return data.count;
            }
        } catch (e) {
            console.log('Debug endpoint failed:', e.message);
        }
        
        // Last resort: Count from PracticeState
        if (PracticeState.exercises && PracticeState.exercises.length > 0) {
            return PracticeState.exercises.length;
        }
        
        return 5; // Final fallback
        
    } catch (error) {
        console.error('âŒ Error fetching total exercises:', error);
        return 5; // Fallback to 5 on error
    }
}



// ============================================
// â±ï¸ ACTIVE TIME TRACKER - Records to user_progress table
// ============================================
class ActiveTimeTracker {
    constructor() {
        this.totalActiveSeconds = 0;
        this.sessionStartTime = null;
        this.isTracking = false;
        this.isAppActive = true;
        this.isPageVisible = true;
        this.saveInterval = null;
        this.lastSavedTime = 0;
        this.userId = null;
        this.userProgressId = null;
        
        // Load saved time from localStorage
        this.loadSavedTime();
        
        // Initialize tracking
        this.init();
    }
    
    init() {
        console.log('â±ï¸ Initializing Active Time Tracker...');
        
        // Get user ID
        const userJson = localStorage.getItem('mathhub_user');
        if (userJson) {
            try {
                const user = JSON.parse(userJson);
                this.userId = user.id;
            } catch (e) {
                console.error('Error parsing user:', e);
            }
        }
        
        // Setup visibility change detection
        this.setupVisibilityDetection();
        
        // Setup before unload detection
        this.setupBeforeUnloadDetection();
        
        // Setup page navigation detection
        this.setupNavigationDetection();
        
        // Start periodic save (every 30 seconds)
        this.startPeriodicSave();
        
        // Start tracking if page is visible
        if (document.visibilityState === 'visible') {
            this.startTracking();
        }
        
        console.log('âœ… Active Time Tracker initialized');
    }
    
    // ============================================
    // ðŸ‘ï¸ DETECT WHEN PAGE IS VISIBLE/HIDDEN
    // ============================================
    setupVisibilityDetection() {
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                console.log('ðŸ‘‹ Page hidden - pausing time tracking');
                this.isPageVisible = false;
                this.pauseTracking();
            } else {
                console.log('ðŸ‘‹ Page visible - resuming time tracking');
                this.isPageVisible = true;
                
                // Only resume if app is still active
                if (this.isAppActive) {
                    this.startTracking();
                }
            }
        });
    }
    
    // ============================================
    // ðŸšª DETECT WHEN USER LEAVES THE PAGE
    // ============================================
    setupBeforeUnloadDetection() {
        window.addEventListener('beforeunload', () => {
            // Save current session before leaving
            this.pauseTracking();
            this.saveToLocalStorage();
            
            // Try to save to server synchronously
            this.saveToServerSync();
        });
    }
    
    // ============================================
    // ðŸ§­ DETECT NAVIGATION WITHIN THE APP
    // ============================================
    setupNavigationDetection() {
        // Override navigateTo function to detect page changes
        const originalNavigateTo = window.navigateTo;
        window.navigateTo = (page) => {
            // Pause tracking when navigating away from learning pages
            const learningPages = ['moduleDashboard', 'practice', 'quizDashboard'];
            
            if (learningPages.includes(AppState.currentPage) && !learningPages.includes(page)) {
                console.log('ðŸ§­ Leaving learning page - pausing time tracking');
                this.pauseTracking();
            }
            
            // Resume tracking when entering learning pages
            if (learningPages.includes(page)) {
                console.log('ðŸ§­ Entering learning page - resuming time tracking');
                setTimeout(() => {
                    this.startTracking();
                }, 500);
            }
            
            originalNavigateTo(page);
        };
    }
    
    // ============================================
    // â–¶ï¸ START TRACKING ACTIVE TIME
    // ============================================
    startTracking() {
        // Don't start if already tracking or page is hidden
        if (this.isTracking || !this.isPageVisible || !this.isAppActive) {
            console.log('â±ï¸ Cannot start tracking:', {
                isTracking: this.isTracking,
                isPageVisible: this.isPageVisible,
                isAppActive: this.isAppActive
            });
            return;
        }
        
        console.log('â–¶ï¸ Starting active time tracking');
        this.sessionStartTime = Date.now();
        this.isTracking = true;
    }
    
    // ============================================
    // â¸ï¸ PAUSE TRACKING
    // ============================================
    pauseTracking() {
        if (!this.isTracking || !this.sessionStartTime) {
            return;
        }
        
        const now = Date.now();
        const sessionSeconds = Math.floor((now - this.sessionStartTime) / 1000);
        
        // Only add if session was significant (more than 2 seconds)
        if (sessionSeconds > 2) {
            this.totalActiveSeconds += sessionSeconds;
            console.log(`â¸ï¸ Paused tracking. Session: ${sessionSeconds}s, Total: ${this.totalActiveSeconds}s`);
            
            // Update display
            this.updateTimeDisplay();
            
            // Save to server immediately
            this.saveToServer();
        }
        
        this.isTracking = false;
        this.sessionStartTime = null;
    }
    
    // ============================================
    // ðŸ”„ RESET TRACKING (for new session)
    // ============================================
    resetTracking() {
        console.log('ðŸ”„ Resetting tracking for new session');
        this.pauseTracking();
        this.totalActiveSeconds = 0;
        this.updateTimeDisplay();
        this.saveToLocalStorage();
        
        // Reset in database
        this.resetInDatabase();
    }
    
    // ============================================
    // ðŸ’¾ PERIODIC SAVE (every 30 seconds)
    // ============================================
    startPeriodicSave() {
        this.saveInterval = setInterval(() => {
            // If currently tracking, add the session time
            if (this.isTracking && this.sessionStartTime) {
                const now = Date.now();
                const sessionSeconds = Math.floor((now - this.sessionStartTime) / 1000);
                const currentTotal = this.totalActiveSeconds + sessionSeconds;
                
                // Only save if changed significantly (every 30 seconds)
                if (Math.abs(currentTotal - this.lastSavedTime) > 30) {
                    this.saveToServer(currentTotal);
                    this.lastSavedTime = currentTotal;
                }
            }
        }, 30000); // Every 30 seconds
    }
    
    // ============================================
    // ðŸ’¾ SAVE TO SERVER - user_progress table
    // ============================================
    async saveToServer(totalSeconds = null) {
        try {
            const token = localStorage.getItem('authToken') || authToken;
            if (!token || !this.userId) return;
            
            const activeSeconds = totalSeconds !== null ? totalSeconds : this.totalActiveSeconds;
            const activeMinutes = Math.floor(activeSeconds / 60);
            
            // Don't save if no significant time
            if (activeMinutes < 1) return;
            
            console.log(`ðŸ’¾ Saving to user_progress table: ${activeMinutes} minutes`);
            
            // âœ… DIRECT UPDATE TO user_progress TABLE
            const response = await fetch(`/api/progress/update-user-progress-time`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    user_id: this.userId,
                    total_time_spent_minutes: activeMinutes,
                    session_seconds: activeSeconds - this.lastSavedTime,
                    is_tracking: this.isTracking,
                    page_visible: this.isPageVisible
                })
            });
            
            if (response.ok) {
                const data = await response.json();
                console.log(`âœ… Updated user_progress: total_time_spent_minutes = ${data.total_time_spent_minutes}`);
                
                // Update local state
                if (ProgressState.cumulativeProgress) {
                    ProgressState.cumulativeProgress.total_time_spent_minutes = data.total_time_spent_minutes;
                }
            } else {
                // Fallback to old endpoints
                await this.fallbackSave(activeMinutes);
            }
            
            // Update display
            this.updateTimeDisplay();
            
        } catch (error) {
            console.error('âŒ Error saving to user_progress:', error);
            // Try fallback
            await this.fallbackSave(Math.floor(this.totalActiveSeconds / 60));
        }
    }
    
    // ============================================
    // ðŸ”„ FALLBACK SAVE - kung hindi gumana ang direct update
    // ============================================
    async fallbackSave(minutes) {
        try {
            const token = localStorage.getItem('authToken') || authToken;
            
            // Try cumulative_progress endpoint
            const response = await fetch(`/api/progress/update-cumulative`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    time_spent_minutes: minutes
                })
            });
            
            if (response.ok) {
                console.log('âœ… Saved to cumulative_progress (fallback)');
            }
            
        } catch (error) {
            console.error('âŒ Fallback also failed:', error);
        }
    }
    
    // ============================================
    // ðŸ’¾ SYNC SAVE FOR BEFORE UNLOAD
    // ============================================
    saveToServerSync() {
        try {
            const token = localStorage.getItem('authToken') || authToken;
            if (!token || !this.userId || this.totalActiveSeconds < 10) return;
            
            const activeMinutes = Math.floor(this.totalActiveSeconds / 60);
            
            // Use sendBeacon for synchronous-like behavior
            const data = JSON.stringify({
                user_id: this.userId,
                total_time_spent_minutes: activeMinutes,
                session_seconds: this.totalActiveSeconds,
                is_tracking: false
            });
            
            navigator.sendBeacon(`/progress/update-user-progress-time`, 
                new Blob([data], { type: 'application/json' }));
            
            console.log('ðŸ’¾ Active time saved via sendBeacon');
            
        } catch (error) {
            console.error('Error in sync save:', error);
        }
    }
    
    // ============================================
    // ðŸ”„ RESET IN DATABASE
    // ============================================
    async resetInDatabase() {
        try {
            const token = localStorage.getItem('authToken') || authToken;
            if (!token || !this.userId) return;
            
            const response = await fetch(`/api/progress/reset-user-progress-time`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    user_id: this.userId
                })
            });
            
            if (response.ok) {
                console.log('âœ… Reset user_progress time in database');
            }
            
        } catch (error) {
            console.error('Error resetting in database:', error);
        }
    }
    
    // ============================================
    // ðŸ’¾ SAVE TO LOCAL STORAGE
    // ============================================
    saveToLocalStorage() {
        try {
            const saveData = {
                totalActiveSeconds: this.totalActiveSeconds,
                lastUpdated: new Date().toISOString(),
                userId: this.userId
            };
            
            localStorage.setItem('active_time_tracker', JSON.stringify(saveData));
            console.log('ðŸ’¾ Active time saved to localStorage');
            
        } catch (error) {
            console.error('Error saving to localStorage:', error);
        }
    }
    
    // ============================================
    // ðŸ“‚ LOAD FROM LOCAL STORAGE
    // ============================================
    loadSavedTime() {
        try {
            const saved = localStorage.getItem('active_time_tracker');
            if (saved) {
                const data = JSON.parse(saved);
                
                // Only load if it's from today and same user
                const lastDate = new Date(data.lastUpdated).toDateString();
                const today = new Date().toDateString();
                
                if (lastDate === today && data.userId === this.userId) {
                    this.totalActiveSeconds = data.totalActiveSeconds || 0;
                    console.log(`ðŸ“‚ Loaded saved time: ${this.totalActiveSeconds}s`);
                } else {
                    // Reset for new day
                    this.totalActiveSeconds = 0;
                    console.log('ðŸ“‚ New day - resetting time tracker');
                }
            }
        } catch (error) {
            console.error('Error loading saved time:', error);
        }
    }
    
    async updateTimeDisplay() {
    try {
        // Get database total (in seconds)
        let databaseSeconds = 0;
        
        // Try from ProgressState first
        if (ProgressState.cumulativeProgress?.total_time_spent_minutes) {
            // I-assume na minutes ito, pero seconds talaga ang laman
            databaseSeconds = ProgressState.cumulativeProgress.total_time_spent_minutes;
        } else {
            // Fetch from server
            const token = localStorage.getItem('authToken');
            const response = await fetch(`/api/progress/get-user-progress-time`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await response.json();
            if (data.success) {
                databaseSeconds = data.total_time_spent_minutes || 0;
                if (!ProgressState.cumulativeProgress) {
                    ProgressState.cumulativeProgress = {};
                }
                // Store as seconds, but we'll convert for display
                ProgressState.cumulativeProgress.total_time_spent_minutes = databaseSeconds;
            }
        }
        
        // âœ… CONVERT SECONDS TO MINUTES
        const databaseMinutes = Math.floor(databaseSeconds / 60);
        
        // Get current session seconds
        let sessionSeconds = 0;
        if (this.isTracking && this.sessionStartTime) {
            sessionSeconds = Math.floor((Date.now() - this.sessionStartTime) / 1000);
        }
        const sessionMinutes = Math.floor(sessionSeconds / 60);
        
        // Calculate TOTAL minutes
        const totalMinutes = databaseMinutes + sessionMinutes;
        const hours = Math.floor(totalMinutes / 60);
        const mins = totalMinutes % 60;
        
        // Format display
        let timeDisplay = '';
        if (hours > 0) {
            timeDisplay = `${hours}h ${mins}m`;
        } else {
            timeDisplay = `${totalMinutes}m`;
        }
        
        console.log(`ðŸ“Š Time: DB=${databaseSeconds}s (${databaseMinutes}min) + Session=${sessionMinutes}min = Total=${totalMinutes}min (${timeDisplay})`);
        
        // Update displays
        const timeElements = [
            document.getElementById('totalLearningTime'),
            document.getElementById('totalTime'),
            document.getElementById('progressTotalTime'),
            document.querySelector('.time-display')
        ];
        
        timeElements.forEach(el => {
            if (el) {
                el.textContent = timeDisplay;
            }
        });
        
        const avgTime = document.getElementById('avgTime');
        if (avgTime) {
            const avgDaily = totalMinutes > 0 ? Math.round(totalMinutes / 7) : 5;
            avgTime.innerHTML = `${avgDaily}<span class="item-unit">min/day</span>`;
        }
        
    } catch (error) {
        console.error('Error updating time display:', error);
    }
}
    
    // ============================================
    // ðŸ” GET CURRENT ACTIVE TIME
    // ============================================
    getCurrentActiveTime() {
        let currentTotal = this.totalActiveSeconds;
        
        if (this.isTracking && this.sessionStartTime) {
            const sessionSeconds = Math.floor((Date.now() - this.sessionStartTime) / 1000);
            currentTotal += sessionSeconds;
        }
        
        return {
            seconds: currentTotal,
            minutes: Math.floor(currentTotal / 60),
            hours: Math.floor(currentTotal / 3600),
            display: this.formatTime(currentTotal)
        };
    }
    
    // ============================================
    // ðŸ“ FORMAT TIME
    // ============================================
    formatTime(seconds) {
        const minutes = Math.floor(seconds / 60);
        const hours = Math.floor(minutes / 60);
        const displayMinutes = minutes % 60;
        
        if (hours > 0) {
            return `${hours}h ${displayMinutes}m`;
        } else {
            return `${minutes}m`;
        }
    }
    
    // ============================================
    // ðŸ§¹ CLEANUP
    // ============================================
    cleanup() {
        if (this.saveInterval) {
            clearInterval(this.saveInterval);
        }
        this.pauseTracking();
        this.saveToServer();
        this.saveToLocalStorage();
    }
}

// ============================================
// ðŸš€ FORCE INITIALIZE TIME TRACKER
// ============================================
function initializeTimeTracker() {
    console.log('â±ï¸ Attempting to initialize time tracker...');
    
    // Check if user is authenticated
    const userJson = localStorage.getItem('mathhub_user');
    const token = localStorage.getItem('authToken');
    
    if (!token || !userJson) {
        console.log('â±ï¸ No user logged in');
        return false;
    }
    
    try {
        const user = JSON.parse(userJson);
        
        // Set AppState if not set
        if (!AppState.isAuthenticated) {
            AppState.currentUser = user;
            AppState.isAuthenticated = true;
        }
        
        // Create tracker
        window.activeTimeTracker = new ActiveTimeTracker();
        console.log('âœ… Time tracker initialized for user:', user.username);
        
        // Force start tracking
        setTimeout(() => {
            if (window.activeTimeTracker) {
                window.activeTimeTracker.startTracking();
                console.log('â–¶ï¸ Tracking started');
            }
        }, 500);
        
        return true;
    } catch (error) {
        console.error('âŒ Failed to initialize time tracker:', error);
        return false;
    }
}

// Initialize immediately
(function() {
    console.log('ðŸ Checking for existing user...');
    initializeTimeTracker();
})();

// Also initialize after login


async function fetchPracticeStatistics() {
    try {
        console.log('ðŸ“Š Fetching practice statistics...');
        
        const data = await apiRequest('/api/progress/practice-attempts');
        
        if (data.success && data.attempts) {
            const attempts = data.attempts;
            
            // Count completed exercises
            const completedExercises = attempts.filter(a => 
                a.completion_status === 'completed' || 
                (a.percentage && a.percentage >= 70)
            ).length;
            
            const stats = {
                exercises_completed: completedExercises,
                total_attempts: attempts.length,
                average_score: 85,
                lessons_completed: 0,
                total_lessons: 20,
                lessons_percentage: 0,
                lessons_display: '0/20'
            };
            
            PracticeState.userPracticeProgress = stats;
            return stats;
        }
        
        return getDefaultPracticeStats();
        
    } catch (error) {
        console.error('âŒ Error fetching practice statistics:', error);
        return getDefaultPracticeStats();
    }
}

// Update learning goals section
function updateLearningGoalsSection() {
    const goalsContainer = document.getElementById('goalsContainer');
    if (!goalsContainer) return;
    
    const goals = ProgressState.learningGoals || [];
    
    if (goals.length === 0) {
        goalsContainer.innerHTML = `
            <div class="no-goals">
                <i class="fas fa-bullseye"></i>
                <h3>No learning goals set</h3>
                <p>Set your first learning goal to track your progress!</p>
                <button class="btn-primary" id="createFirstGoalBtn">
                    <i class="fas fa-plus"></i> Create Goal
                </button>
            </div>
        `;
        
        document.getElementById('createFirstGoalBtn')?.addEventListener('click', showCreateGoalModal);
        return;
    }
    
    let html = '';
    goals.forEach(goal => {
        const progressPercentage = goal.progress_percentage || 0;
        const status = goal.status || 'active';
        const statusClass = status === 'completed' ? 'completed' : 
                          status === 'failed' ? 'failed' : 'active';
        
        html += `
            <div class="goal-card ${statusClass}" data-goal-id="${goal.goal_id}">
                <div class="goal-header">
                    <h4>${goal.goal_title}</h4>
                    <span class="goal-status ${statusClass}">${status}</span>
                </div>
                
                <div class="goal-body">
                    <p>${goal.goal_description || ''}</p>
                    
                    <div class="goal-progress">
                        <div class="progress-info">
                            <span>${goal.current_value}/${goal.target_value} ${goal.unit_type}</span>
                            <span>${Math.round(progressPercentage)}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progressPercentage}%"></div>
                        </div>
                    </div>
                    
                    <div class="goal-meta">
                        <span class="goal-type">${goal.goal_type}</span>
                        <span class="goal-deadline">
                            ${goal.end_date ? `Due: ${formatDate(goal.end_date)}` : 'No deadline'}
                        </span>
                    </div>
                </div>
                
                <div class="goal-actions">
                    ${status === 'active' ? `
                        <button class="btn-small update-goal-btn" data-goal-id="${goal.goal_id}">
                            <i class="fas fa-edit"></i> Update
                        </button>
                        <button class="btn-small complete-goal-btn" data-goal-id="${goal.goal_id}">
                            <i class="fas fa-check"></i> Complete
                        </button>
                    ` : ''}
                </div>
            </div>
        `;
    });
    
    goalsContainer.innerHTML = html;
    
    // Add event listeners
    document.querySelectorAll('.update-goal-btn').forEach(button => {
        button.addEventListener('click', function() {
            const goalId = this.getAttribute('data-goal-id');
            showUpdateGoalModal(goalId);
        });
    });
    
    document.querySelectorAll('.complete-goal-btn').forEach(button => {
        button.addEventListener('click', async function() {
            const goalId = this.getAttribute('data-goal-id');
            const success = await completeLearningGoal(goalId);
            if (success) {
                showNotification('Goal marked as completed!', 'success');
                // Refresh goals
                await fetchLearningGoals();
                updateLearningGoalsSection();
            }
        });
    });
}

// ============================================
// UPDATE ACTIVITY LOG
// ============================================
function updateActivityLog() {
    const container = document.getElementById('recentActivity');
    if (!container) return;
    
    const activities = ProgressState.activityLog || [];
    
    if (activities.length === 0) {
        container.innerHTML = `
            <div class="no-activity" style="text-align: center; padding: 30px;">
                <i class="fas fa-history" style="font-size: 40px; color: #ccc; margin-bottom: 15px;"></i>
                <p style="color: #999;">No recent activity</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    activities.slice(0, 5).forEach(activity => {
        const activityText = getActivityText(activity);
        const timeAgo = formatTimeAgo(activity.activity_timestamp);
        
        html += `
            <div style="display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #eee;">
                <div style="width: 36px; height: 36px; background: #f0f0f0; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                    <i class="${getActivityIcon(activity.activity_type)}" style="color: #7a0000;"></i>
                </div>
                <div style="flex: 1;">
                    <div style="font-size: 14px; color: #2c3e50;">${activityText}</div>
                    <div style="font-size: 12px; color: #999;">${timeAgo}</div>
                </div>
                ${activity.points_earned > 0 ? `
                    <div style="background: #27ae60; color: white; padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: bold;">
                        +${activity.points_earned}
                    </div>
                ` : ''}
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Update progress trends chart
function updateProgressTrendsChart() {
    const trendsContainer = document.getElementById('progressTrendsChart');
    if (!trendsContainer) return;
    
    const trends = ProgressState.progressTrends || [];
    
    if (trends.length === 0) {
        trendsContainer.innerHTML = `
            <div class="no-trends">
                <i class="fas fa-chart-line"></i>
                <h3>No trend data available</h3>
                <p>Complete more activities to see your progress trends.</p>
            </div>
        `;
        return;
    }
    
    // Create a simple chart using CSS
    const maxPoints = Math.max(...trends.map(t => t.points_earned || 0));
    
    let html = `<div class="trends-chart">`;
    
    trends.slice(-14).forEach(trend => { // Last 14 days
        const date = new Date(trend.activity_date);
        const day = date.getDate();
        const month = date.toLocaleString('default', { month: 'short' });
        const points = trend.points_earned || 0;
        const height = maxPoints > 0 ? (points / maxPoints * 100) : 0;
        
        html += `
            <div class="trend-day">
                <div class="trend-bar" style="height: ${height}%"></div>
                <div class="trend-label">
                    <span class="trend-day-number">${day}</span>
                    <span class="trend-month">${month}</span>
                </div>
            </div>
        `;
    });
    
    html += `</div>`;
    trendsContainer.innerHTML = html;
}

// ============================================
// UPDATE ACHIEVEMENT TIMELINE
// ============================================
function updateAchievementTimeline() {
    const timeline = document.getElementById('achievementTimeline');
    if (!timeline) return;
    
    const achievements = ProgressState.achievementTimeline || [];
    
    if (achievements.length === 0) {
        timeline.innerHTML = `
            <div class="no-achievements" style="text-align: center; padding: 40px;">
                <i class="fas fa-trophy" style="font-size: 48px; color: #ccc; margin-bottom: 15px;"></i>
                <h3 style="color: #666;">No Achievements Yet</h3>
                <p style="color: #999;">Complete lessons and quizzes to earn achievements!</p>
            </div>
        `;
        return;
    }
    
    let html = '<div style="position: relative; padding: 20px 0;">';
    
    achievements.forEach((achievement, index) => {
        const isLeft = index % 2 === 0;
        const date = achievement.created_at ? new Date(achievement.created_at).toLocaleDateString() : 'Recently';
        
        html += `
            <div style="display: flex; ${isLeft ? 'justify-content: flex-start;' : 'justify-content: flex-end;'} margin-bottom: 30px; position: relative;">
                <div style="width: 45%; ${isLeft ? 'text-align: right; padding-right: 30px;' : 'padding-left: 30px;'}">
                    <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: relative;">
                        <div style="display: flex; align-items: center; gap: 10px; ${isLeft ? 'flex-direction: row-reverse;' : ''}">
                            <div style="width: 40px; height: 40px; background: ${achievement.color || '#7a0000'}; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white;">
                                <i class="${achievement.icon || 'fas fa-trophy'}"></i>
                            </div>
                            <div style="flex: 1; ${isLeft ? 'text-align: right;' : ''}">
                                <h4 style="margin: 0; font-size: 16px;">${achievement.achievement_name || 'Achievement'}</h4>
                                <p style="margin: 5px 0 0; font-size: 13px; color: #666;">${achievement.description || ''}</p>
                                <small style="color: #999;">${date}</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    timeline.innerHTML = html;
}

// Update topic mastery section
function updateTopicMasterySection() {
    const masteryContainer = document.getElementById('topicMasteryContainer');
    if (!masteryContainer) return;
    
    const mastery = ProgressState.topicMastery || {};
    const masteryArray = Object.values(mastery);
    
    if (masteryArray.length === 0) {
        masteryContainer.innerHTML = `
            <div class="no-mastery">
                <i class="fas fa-graduation-cap"></i>
                <h3>No topic mastery data</h3>
                <p>Complete lessons and exercises to build topic mastery.</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    masteryArray.forEach(topic => {
        const masteryLevel = topic.mastery_level || 'beginner';
        const accuracyRate = topic.accuracy_rate || 0;
        const lastPracticed = topic.last_practiced ? formatTimeAgo(topic.last_practiced) : 'Never';
        
        html += `
            <div class="mastery-card mastery-${masteryLevel.toLowerCase()}">
                <div class="mastery-header">
                    <h4>Topic ${topic.topic_id}</h4>
                    <span class="mastery-level">${masteryLevel}</span>
                </div>
                
                <div class="mastery-body">
                    <div class="mastery-stats">
                        <div class="mastery-stat">
                            <span class="stat-label">Accuracy</span>
                            <span class="stat-value">${Math.round(accuracyRate)}%</span>
                        </div>
                        <div class="mastery-stat">
                            <span class="stat-label">Last Practiced</span>
                            <span class="stat-value">${lastPracticed}</span>
                        </div>
                    </div>
                    
                    <div class="mastery-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${accuracyRate}%"></div>
                        </div>
                    </div>
                </div>
                
                <div class="mastery-actions">
                    <button class="btn-small practice-topic-btn" data-topic-id="${topic.topic_id}">
                        <i class="fas fa-pencil-alt"></i> Practice
                    </button>
                </div>
            </div>
        `;
    });
    
    masteryContainer.innerHTML = html;
    
    // Add event listeners to practice buttons
    document.querySelectorAll('.practice-topic-btn').forEach(button => {
        button.addEventListener('click', function() {
            const topicId = this.getAttribute('data-topic-id');
            openPracticeForTopic(topicId);
        });
    });
}

// ============================================
// FIXED: updateModuleProgressSection - Handles empty data
// ============================================
function updateModuleProgressSection() {
    const modulesContainer = document.getElementById('moduleProgressContainer');
    if (!modulesContainer) return;
    
    const moduleProgress = ProgressState.moduleProgress || {};
    const moduleArray = Object.values(moduleProgress);
    
    if (moduleArray.length === 0) {
        modulesContainer.innerHTML = `
            <div class="no-modules">
                <i class="fas fa-book-open"></i>
                <h3>No Module Progress Yet</h3>
                <p>Start learning modules to see your progress here.</p>
                <button class="btn-primary" onclick="navigateTo('dashboard')">
                    <i class="fas fa-play"></i> Start Learning
                </button>
            </div>
        `;
        return;
    }
    
    let html = '';
    moduleArray.forEach(module => {
        const completionRate = module.total_lessons > 0 ? 
            Math.round((module.lessons_completed / module.total_lessons) * 100) : 0;
        const isCompleted = completionRate >= 100;
        
        html += `
            <div class="module-progress-card ${isCompleted ? 'completed' : 'in-progress'}">
                <div class="module-progress-header">
                    <h4>${module.module_name || `Module ${module.module_id}`}</h4>
                    <span class="completion-rate">${completionRate}%</span>
                </div>
                
                <div class="module-progress-body">
                    <div class="module-stats">
                        <div class="module-stat">
                            <span class="stat-label">Lessons</span>
                            <span class="stat-value">${module.lessons_completed || 0}/${module.total_lessons || 0}</span>
                        </div>
                        <div class="module-stat">
                            <span class="stat-label">Avg. Score</span>
                            <span class="stat-value">${Math.round(module.average_score || 0)}%</span>
                        </div>
                        <div class="module-stat">
                            <span class="stat-label">Time</span>
                            <span class="stat-value">${formatTime(module.time_spent_minutes || 0)}</span>
                        </div>
                    </div>
                    
                    <div class="module-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${completionRate}%"></div>
                        </div>
                    </div>
                </div>
                
                ${isCompleted ? `
                    <div class="module-actions">
                        <span class="completed-badge">
                            <i class="fas fa-check-circle"></i> Completed
                        </span>
                    </div>
                ` : `
                    <div class="module-actions">
                        <button class="btn-small continue-module-btn" data-module-id="${module.module_id}">
                            <i class="fas fa-play"></i> Continue
                        </button>
                    </div>
                `}
            </div>
        `;
    });
    
    modulesContainer.innerHTML = html;
    
    // Add event listeners to continue buttons
    document.querySelectorAll('.continue-module-btn').forEach(button => {
        button.addEventListener('click', function() {
            const moduleId = this.getAttribute('data-module-id');
            navigateToModule(moduleId);
        });
    });
}

// ============================================
// HELPER: Navigate to module
// ============================================
function navigateToModule(moduleId) {
    console.log(`ðŸ“š Navigating to module ${moduleId}`);
    // You can implement this based on your app's navigation
    showNotification(`Opening module ${moduleId}...`, 'info');
    // navigateTo('moduleDashboard');
}


// Show create goal modal
function showCreateGoalModal() {
    const modalHTML = `
        <div class="create-goal-modal">
            <h3><i class="fas fa-bullseye"></i> Create New Learning Goal</h3>
            
            <form id="createGoalForm">
                <div class="form-group">
                    <label for="goalTitle">Goal Title</label>
                    <input type="text" id="goalTitle" placeholder="e.g., Complete 5 lessons this week" required>
                </div>
                
                <div class="form-group">
                    <label for="goalDescription">Description (Optional)</label>
                    <textarea id="goalDescription" placeholder="Describe your goal..."></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="goalType">Goal Type</label>
                        <select id="goalType" required>
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                            <option value="custom">Custom</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="unitType">Unit Type</label>
                        <select id="unitType" required>
                            <option value="lessons">Lessons</option>
                            <option value="exercises">Exercises</option>
                            <option value="minutes">Minutes</option>
                            <option value="points">Points</option>
                            <option value="quizzes">Quizzes</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="targetValue">Target Value</label>
                        <input type="number" id="targetValue" min="1" max="1000" value="5" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="endDate">End Date (Optional)</label>
                        <input type="date" id="endDate">
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn-secondary" id="cancelCreateGoal">
                        Cancel
                    </button>
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-check"></i> Create Goal
                    </button>
                </div>
            </form>
        </div>
    `;
    
    showModal(modalHTML);
    
    // Set minimum date to tomorrow
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    const endDateInput = document.getElementById('endDate');
    if (endDateInput) {
        endDateInput.min = tomorrow.toISOString().split('T')[0];
    }
    
    // Form submission
    const form = document.getElementById('createGoalForm');
    if (form) {
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const goalData = {
                goal_title: document.getElementById('goalTitle').value,
                goal_description: document.getElementById('goalDescription').value,
                goal_type: document.getElementById('goalType').value,
                unit_type: document.getElementById('unitType').value,
                target_value: parseInt(document.getElementById('targetValue').value),
                end_date: document.getElementById('endDate').value || null
            };
            
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
            submitBtn.disabled = true;
            
            const goal = await createLearningGoal(goalData);
            
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
            
            if (goal) {
                showNotification('Learning goal created successfully!', 'success');
                
                // Close modal
                const modal = document.querySelector('.modal-overlay');
                if (modal) modal.remove();
                
                // Refresh goals
                await fetchLearningGoals();
                updateLearningGoalsSection();
            } else {
                showNotification('Failed to create goal. Please try again.', 'error');
            }
        });
    }
    
    // Cancel button
    document.getElementById('cancelCreateGoal')?.addEventListener('click', () => {
        const modal = document.querySelector('.modal-overlay');
        if (modal) modal.remove();
    });
}

// I-ADD itong function para i-refresh ang practice exercises
async function refreshPracticeExercises(topicId) {
    console.log(`ðŸ”„ Refreshing practice exercises for topic ${topicId}...`);
    
    const exerciseArea = document.getElementById('exerciseArea');
    if (!exerciseArea) return;
    
    // Show loading state
    exerciseArea.innerHTML = `
        <div class="loading-container">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Refreshing exercises...</p>
        </div>
    `;
    
    // Reload practice data
    const practiceData = await loadPracticeExercises(topicId);
    
    if (practiceData && practiceData.unlocked && practiceData.exercises) {
        PracticeState.exercises = practiceData.exercises;
        exerciseArea.innerHTML = createPracticeExercisesUI(practiceData);
        setupPracticeExerciseInteractions();
    }
    
    console.log('âœ… Practice exercises refreshed');
}

// Show update goal modal
function showUpdateGoalModal(goalId) {
    const goal = ProgressState.learningGoals.find(g => g.goal_id == goalId);
    if (!goal) return;
    
    const modalHTML = `
        <div class="update-goal-modal">
            <h3><i class="fas fa-edit"></i> Update Goal Progress</h3>
            
            <div class="goal-info">
                <h4>${goal.goal_title}</h4>
                <p>Current: ${goal.current_value}/${goal.target_value} ${goal.unit_type}</p>
                <p>Progress: ${Math.round(goal.progress_percentage || 0)}%</p>
            </div>
            
            <form id="updateGoalForm">
                <div class="form-group">
                    <label for="currentValue">Update Current Value</label>
                    <input type="number" id="currentValue" 
                           min="${goal.current_value}" 
                           max="${goal.target_value}" 
                           value="${goal.current_value}" 
                           required>
                    <small>Maximum: ${goal.target_value} ${goal.unit_type}</small>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn-secondary" id="cancelUpdateGoal">
                        Cancel
                    </button>
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-save"></i> Update Progress
                    </button>
                </div>
            </form>
        </div>
    `;
    
    showModal(modalHTML);
    
    // Form submission
    const form = document.getElementById('updateGoalForm');
    if (form) {
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const currentValue = parseInt(document.getElementById('currentValue').value);
            
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
            submitBtn.disabled = true;
            
            const success = await updateLearningGoalProgress(goalId, currentValue);
            
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
            
            if (success) {
                showNotification('Goal progress updated!', 'success');
                
                // Close modal
                const modal = document.querySelector('.modal-overlay');
                if (modal) modal.remove();
                
                // Refresh goals
                await fetchLearningGoals();
                updateLearningGoalsSection();
            } else {
                showNotification('Failed to update goal. Please try again.', 'error');
            }
        });
    }
    
    // Cancel button
    document.getElementById('cancelUpdateGoal')?.addEventListener('click', () => {
        const modal = document.querySelector('.modal-overlay');
        if (modal) modal.remove();
    });
}

// ============================================
// GET ACTIVITY ICON
// ============================================
function getActivityIcon(activityType) {
    const icons = {
        'login': 'fas fa-sign-in-alt',
        'logout': 'fas fa-sign-out-alt',
        'lesson_completed': 'fas fa-check-circle',
        'lesson_started': 'fas fa-play',
        'practice_completed': 'fas fa-pencil-alt',
        'quiz_completed': 'fas fa-question-circle',
        'quiz_started': 'fas fa-hourglass-start',
        'feedback_submitted': 'fas fa-comment',
        'points_earned': 'fas fa-coins',
        'tool_used': 'fas fa-tools',
        'graph_saved': 'fas fa-chart-line',
        'note_saved': 'fas fa-sticky-note',
        'timer_session': 'fas fa-clock'
    };
    
    return icons[activityType] || 'fas fa-circle';
}

// ============================================
// GET ACTIVITY TEXT
// ============================================
function getActivityText(activity) {
    const type = activity.activity_type;
    const details = activity.details || {};
    
    switch(type) {
        case 'login':
            return 'Logged in to MathHub';
        case 'logout':
            return 'Logged out';
        case 'lesson_completed':
            return `Completed lesson: ${details.item_name || 'a lesson'}`;
        case 'practice_completed':
            return `Completed practice: ${details.item_name || 'an exercise'}`;
        case 'quiz_completed':
            return `Completed quiz with ${details.score || '?'}%`;
        case 'feedback_submitted':
            return 'Submitted feedback';
        case 'points_earned':
            return `Earned ${activity.points_earned || 0} points`;
        default:
            return `Performed ${type.replace(/_/g, ' ')}`;
    }
}

function getAchievementIcon(activityType) {
    switch(activityType) {
        case 'badge_earned':
            return 'fas fa-award';
        case 'goal_achieved':
            return 'fas fa-trophy';
        case 'lesson_completed':
            return 'fas fa-star';
        default:
            return 'fas fa-flag-checkered';
    }
}

function getAchievementText(achievement) {
    switch(achievement.activity_type) {
        case 'badge_earned':
            return `Earned badge: ${achievement.achievement_name || 'a badge'}`;
        case 'goal_achieved':
            return `Achieved goal: ${achievement.achievement_name || 'a goal'}`;
        case 'lesson_completed':
            return `Completed lesson: ${achievement.item_name || 'a lesson'}`;
        default:
            return `Made progress: ${achievement.achievement_name || 'an achievement'}`;
    }
}

function formatTime(minutes) {
    if (minutes < 60) {
        return `${minutes}m`;
    } else {
        const hours = Math.floor(minutes / 60);
        const mins = minutes % 60;
        return `${hours}h ${mins}m`;
    }
}

// ============================================
// FORMAT TIME AGO
// ============================================
function formatTimeAgo(timestamp) {
    if (!timestamp) return 'Recently';
    
    const date = new Date(timestamp);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins} min${diffMins > 1 ? 's' : ''} ago`;
    if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
    if (diffDays === 1) return 'Yesterday';
    if (diffDays < 7) return `${diffDays} days ago`;
    
    return date.toLocaleDateString();
}

function formatDate(dateString) {
    if (!dateString) return 'No date';
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', { 
        month: 'short', 
        day: 'numeric', 
        year: 'numeric' 
    });
}

// ============================================
// QUIZ MANAGEMENT FUNCTIONS - FIXED FOR HTML STRUCTURE
// ============================================
async function fetchQuizCategories() {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) {
            console.warn('No auth token available');
            return [];
        }
        
        console.log('ðŸ“š Fetching quiz categories...');
        
        const response = await fetch(`/api/quiz/categories`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`Failed to fetch quiz categories: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success && data.categories) {
            console.log(`âœ… Fetched ${data.categories.length} quiz categories`);
            return data.categories;
        } else {
            throw new Error(data.message || 'No quiz categories returned');
        }
    } catch (error) {
        console.error('Error fetching quiz categories:', error);
        return [];
    }
}

// Fetch quizzes for a category
// ============================================
// âœ… FIXED: fetchQuizzesForCategory - WITH CORRECT USER ATTEMPTS
// ============================================
async function fetchQuizzesForCategory(categoryId) {
    try {
        console.log(`ðŸ“ Fetching quizzes for category ${categoryId}...`);
        
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) {
            console.warn('No auth token available');
            showNotification('Please login to view quizzes', 'error');
            return;
        }
        
        // Get current user ID
        const userJson = localStorage.getItem('mathhub_user');
        let currentUserId = null;
        if (userJson) {
            try {
                const user = JSON.parse(userJson);
                currentUserId = user.id;
                console.log(`ðŸ‘¤ Current user ID: ${currentUserId}`);
            } catch (e) {
                console.error('Error parsing user:', e);
            }
        }
        
        const response = await fetch(`/api/quiz/category/${categoryId}/quizzes`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`Failed to fetch quizzes: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success && data.quizzes) {
            console.log(`âœ… Fetched ${data.quizzes.length} quizzes for category ${categoryId}`);
            
            // Filter attempts para sa current user lang
            const filteredQuizzes = data.quizzes.map(quiz => {
                if (quiz.user_attempts && Array.isArray(quiz.user_attempts)) {
                    quiz.user_attempts = quiz.user_attempts.filter(
                        attempt => attempt.user_id === currentUserId
                    );
                }
                
                if (quiz.user_attempts && quiz.user_attempts.length > 0) {
                    const bestScore = Math.max(...quiz.user_attempts.map(a => a.score || 0));
                    quiz.user_progress = {
                        attempts: quiz.user_attempts.length,
                        best_score: bestScore,
                        passed: quiz.user_attempts.some(a => a.passed === 1)
                    };
                } else {
                    quiz.user_progress = {
                        attempts: 0,
                        best_score: 0,
                        passed: false
                    };
                }
                
                return quiz;
            });
            
            // Find the selected category
            const selectedCategory = QuizState.quizCategories.find(
                cat => cat.category_id == categoryId || cat.id == categoryId
            );
            
            if (!selectedCategory) {
                console.warn('Category not found in state, using basic category info');
                const categoryInfo = {
                    category_id: categoryId,
                    category_name: data.category?.name || 'Selected Category',
                    name: data.category?.name || 'Selected Category'
                };
                showQuizInterfaceForCategory(categoryInfo, filteredQuizzes);
            } else {
                showQuizInterfaceForCategory(selectedCategory, filteredQuizzes);
            }
        } else {
            throw new Error(data.message || 'No quizzes returned');
        }
        
    } catch (error) {
        console.error('Error loading quizzes:', error);
        showNotification('Failed to load quizzes: ' + error.message, 'error');
    }
}


// Check if user can access a quiz (lesson completion prerequisite)
async function checkQuizAccess(quizId) {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) {
            console.warn('No auth token available');
            return { canAccess: false, reason: 'Not authenticated' };
        }
        
        console.log(`ðŸ” Checking quiz access for quiz ${quizId}...`);
        
        // TEMPORARILY BYPASS: Laging return true para sa testing
        return { canAccess: true, reason: 'Access granted (bypassed)' };
        
    } catch (error) {
        console.error('Error checking quiz access:', error);
        return { canAccess: false, reason: 'Error checking access' };
    }
}




// ============================================
// START QUIZ - FIXED VERSION
// ============================================
async function startQuizSystem(quizId) {
    console.log("ðŸŽ¯ Starting QUIZ ID:", quizId);
    
    try {
        const token = localStorage.getItem('authToken') || authToken;
        const userJson = localStorage.getItem('mathhub_user');
        
        if (!token || !userJson) {
            showNotification('Please login first', 'error');
            return;
        }
        
        const user = JSON.parse(userJson);
        console.log(`ðŸ‘¤ User ID: ${user.id}`);
        
        // Show loading
        showQuizModalLoading();
        
        // STEP 1: Start quiz attempt directly
        console.log('ðŸ“ Creating quiz attempt...');
        
        const attemptResponse = await fetch(`/api/quiz/${quizId}/start`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                user_id: user.id
            })
        });
        
        if (!attemptResponse.ok) {
            const errorText = await attemptResponse.text();
            console.error('Server error response:', errorText);
            throw new Error(`Failed to start quiz: ${attemptResponse.status}`);
        }
        
        const attemptData = await attemptResponse.json();
        console.log('âœ… Attempt response:', attemptData);
        
        if (!attemptData.success || !attemptData.attempt) {
            throw new Error(attemptData.message || 'Failed to start quiz');
        }
        
        const attempt = attemptData.attempt;
        console.log('âœ… Quiz attempt created:', attempt);
        
        // STEP 2: Fetch questions
        console.log('ðŸ“š Fetching quiz questions...');
        const questionsResponse = await fetch(`/api/quiz/${quizId}/questions`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (!questionsResponse.ok) {
            throw new Error(`Failed to fetch questions: ${questionsResponse.status}`);
        }
        
        const questionsData = await questionsResponse.json();
        
        if (!questionsData.success || !questionsData.questions) {
            throw new Error(questionsData.message || 'No questions found');
        }
        
        const questions = questionsData.questions;
        console.log(`âœ… Loaded ${questions.length} questions`);
        
        // STEP 3: Initialize quiz state
        QuizSystem.currentQuiz = quizId;
        QuizSystem.currentAttemptId = attempt.attempt_id;
        QuizSystem.questions = questions;
        QuizSystem.currentIndex = 0;
        QuizSystem.userAnswers = {};
        QuizSystem.startTime = Date.now();
        QuizSystem.totalTime = questions.length * 60;
        QuizSystem.timeLeft = QuizSystem.totalTime;
        QuizSystem.stats = { correct: 0, wrong: 0, score: 0 };
        
        // STEP 4: Show quiz modal
        showQuizSystemModal();
        
        // STEP 5: Load first question
        loadQuizSystemQuestion(0);
        
        // STEP 6: Start timer
        startQuizSystemTimer();
        
    } catch (error) {
        console.error('âŒ Error starting quiz:', error);
        showNotification('Failed to start quiz: ' + error.message, 'error');
        closeQuizModal();
    }
}


// ============================================
// Helper function to manually load PolyLearn quizzes (Category 2)
// ============================================
function loadPolyLearnQuizzes() {
    console.log('ðŸ“š Loading PolyLearn quizzes (Category 2)...');
    
    // Find PolyLearn category (ID 2)
    const polyLearnCategory = QuizState.quizCategories.find(c => c.category_id == 2);
    
    if (polyLearnCategory) {
        loadQuizzesForCategory(2);
    } else {
        // If categories not loaded yet, load them first
        loadQuizCategories().then(() => {
            loadQuizzesForCategory(2);
        });
    }
}


// ============================================
// Test function for quiz ID 1
// ============================================
async function testQuiz1() {
    console.log('ðŸ§ª Testing quiz ID 1 (Polynomial Division Fundamentals)...');
    await startQuizSystem(1);
}

// ============================================
// Test function for quiz ID 2
// ============================================
async function testQuiz2() {
    console.log('ðŸ§ª Testing quiz ID 2 (Factoring Polynomials Quiz)...');
    await startQuizSystem(2);
}

// ============================================
// Test function for quiz ID 3
// ============================================
async function testQuiz3() {
    console.log('ðŸ§ª Testing quiz ID 3 (Factoring)...');
    await startQuizSystem(3);
}

// ============================================
// Test function for quiz ID 4
// ============================================
async function testQuiz4() {
    console.log('ðŸ§ª Testing quiz ID 4 (polyyy)...');
    await startQuizSystem(4);
}

// ============================================
// SHOW QUIZ MODAL - WITH ADJUSTED SCROLLABLE CONTAINER
// ============================================
function showQuizSystemModal() {
    const modal = document.getElementById('quizModal');
    if (!modal) return;
    
    // Update title
    const titleSpan = document.getElementById('quizModalTitle');
    if (titleSpan) {
        titleSpan.textContent = 'Quiz';
    }
    
    // SHOW MODAL
    modal.style.display = 'flex';
    document.body.classList.add('modal-open');
    
    // ADJUST OPTIONS GRID - SCROLLABLE WITH BETTER HEIGHT
    const optionsGrid = document.getElementById('quizOptionsGridModal');
    if (optionsGrid) {
        optionsGrid.style.overflowY = 'auto';
        optionsGrid.style.maxHeight = '450px'; // Tumaas ng konti
        optionsGrid.style.padding = '10px'; // May padding para hindi dikit
    }
    
    // Adjust din ang parent container kung kailangan
    const parentContainer = optionsGrid?.parentElement;
    if (parentContainer) {
        parentContainer.style.overflow = 'hidden'; // Para hindi magkagulo
    }
    
    // Hide submit button initially
    const submitBtn = document.getElementById('submitQuizBtn');
    if (submitBtn) {
        submitBtn.style.display = 'none';
    }
}

// Add this to your addQuizStyles() function or create a new style block
function addReviewModalStyles() {
    const style = document.createElement('style');
    style.textContent = `
        /* Quiz Review Modal Styles */
        .quiz-review-modal {
            background: white;
            border-radius: 12px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .review-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .review-header h3 {
            margin: 0;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .review-score-badge {
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 16px;
            font-weight: bold;
        }
        
        .review-summary-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
        }
        
        .review-stat-item {
            text-align: center;
        }
        
        .review-stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #7a0000;
        }
        
        .review-stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }
        
        .review-questions-list {
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .review-question-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }
        
        .review-question-card.correct {
            border-left: 4px solid #27ae60;
            background: #f0fff4;
        }
        
        .review-question-card.incorrect {
            border-left: 4px solid #e74c3c;
            background: #fff5f5;
        }
        
        .review-question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .review-question-number {
            font-weight: bold;
            color: #7a0000;
            background: rgba(122,0,0,0.1);
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 12px;
        }
        
        .review-result-badge {
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .review-result-badge.correct {
            background: #27ae60;
            color: white;
        }
        
        .review-result-badge.incorrect {
            background: #e74c3c;
            color: white;
        }
        
        .review-question-text {
            font-size: 16px;
            color: #2c3e50;
            margin-bottom: 15px;
            line-height: 1.5;
        }
        
        .review-options-list {
            margin: 10px 0;
        }
        
        .review-option-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 6px;
            background: #f8f9fa;
        }
        
        .review-option-item.user-selected {
            background: #e8f5e9;
            border: 1px solid #27ae60;
        }
        
        .review-option-item.correct-option {
            background: #d4edda;
            border: 1px solid #27ae60;
        }
        
        .review-option-letter {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #7a0000;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .review-option-text {
            flex: 1;
            font-size: 14px;
        }
        
        .review-option-indicator {
            margin-left: 10px;
            font-size: 12px;
        }
        
        .review-option-indicator i.fa-check {
            color: #27ae60;
        }
        
        .review-option-indicator i.fa-times {
            color: #e74c3c;
        }
        
        .review-footer {
            padding: 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        
        .review-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .review-btn.primary {
            background: #7a0000;
            color: white;
        }
        
        .review-btn.primary:hover {
            background: #5a0000;
            transform: translateY(-2px);
        }
        
        .review-btn.secondary {
            background: #ecf0f1;
            color: #2c3e50;
        }
        
        .review-btn.secondary:hover {
            background: #d5dbdb;
            transform: translateY(-2px);
        }
        
        .no-data-message {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        
        .loading-review {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .loading-review i {
            font-size: 30px;
            color: #7a0000;
            margin-bottom: 15px;
        }
    `;
    document.head.appendChild(style);
}

// ============================================
// SHOW REVIEW LOADING MODAL
// ============================================
function showReviewLoadingModal() {
    // Remove existing review modal if any
    const existingModal = document.querySelector('.quiz-review-modal-parent');
    if (existingModal) existingModal.remove();
    
    const modalHTML = `
        <div class="quiz-review-modal-parent" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 100000;">
            <div class="quiz-review-modal" style="background: white; border-radius: 12px; max-width: 500px; width: 90%;">
                <div class="loading-review" style="text-align: center; padding: 40px;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 40px; color: #7a0000; margin-bottom: 20px;"></i>
                    <h3 style="color: #2c3e50; margin-bottom: 10px;">Loading Review Data</h3>
                    <p style="color: #666;">Please wait while we fetch your quiz results...</p>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}


// ============================================
// SHOW REVIEW ERROR MODAL
// ============================================
function showReviewErrorModal(message) {
    // Remove existing review modal if any
    const existingModal = document.querySelector('.quiz-review-modal-parent');
    if (existingModal) existingModal.remove();
    
    const modalHTML = `
        <div class="quiz-review-modal-parent" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 100000;">
            <div class="quiz-review-modal" style="background: white; border-radius: 12px; max-width: 500px; width: 90%;">
                <div class="review-header" style="background: #e74c3c;">
                    <h3><i class="fas fa-exclamation-triangle"></i> Unable to Load Review</h3>
                    <button onclick="closeReviewModal()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">&times;</button>
                </div>
                <div class="loading-review" style="text-align: center; padding: 30px;">
                    <i class="fas fa-frown" style="font-size: 50px; color: #e74c3c; margin-bottom: 15px;"></i>
                    <p style="color: #2c3e50; margin-bottom: 20px;">${message}</p>
                    <p style="color: #666; font-size: 14px; margin-bottom: 20px;">Complete a quiz first to see your results here.</p>
                    <button onclick="closeReviewModal()" class="review-btn primary">
                        <i class="fas fa-times"></i> Close
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

// ============================================
// SHOW QUIZ REVIEW MODAL WITH DATA
// ============================================
function showQuizReviewModal(reviewData) {
    // Remove existing review modal if any
    const existingModal = document.querySelector('.quiz-review-modal-parent');
    if (existingModal) existingModal.remove();
    
    // Extract data with fallbacks
    const quizTitle = reviewData.quiz_title || 'Quiz Review';
    const totalQuestions = reviewData.total_questions || reviewData.questions?.length || 0;
    const correctAnswers = reviewData.correct_answers || 0;
    const score = reviewData.score || Math.round((correctAnswers / totalQuestions) * 100) || 0;
    const timeSpent = reviewData.time_spent_seconds || 0;
    const minutes = Math.floor(timeSpent / 60);
    const seconds = timeSpent % 60;
    const timeFormatted = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    
    // Determine score color
    let scoreColor = '#e74c3c'; // red for low
    if (score >= 90) scoreColor = '#27ae60'; // green for excellent
    else if (score >= 75) scoreColor = '#f39c12'; // orange for good
    else if (score >= 50) scoreColor = '#3498db'; // blue for average
    
    // Generate questions HTML
    let questionsHTML = '';
    
    if (reviewData.questions && reviewData.questions.length > 0) {
        reviewData.questions.forEach((q, index) => {
            const isCorrect = q.is_correct || false;
            const userAnswer = q.user_answer || 'Not answered';
            const correctAnswer = q.correct_answer || 'N/A';
            
            questionsHTML += `
                <div style="background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; margin-bottom: 15px; border-left: 4px solid ${isCorrect ? '#27ae60' : '#e74c3c'};">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span style="font-weight: bold; color: #7a0000;">Question ${index + 1}</span>
                        <span style="background: ${isCorrect ? '#27ae60' : '#e74c3c'}; color: white; padding: 3px 10px; border-radius: 15px; font-size: 12px;">
                            ${isCorrect ? 'Correct' : 'Incorrect'}
                        </span>
                    </div>
                    
                    <div style="margin-bottom: 15px;">${q.question_text || 'Question text not available'}</div>
                    
                    <div style="margin-top: 15px; background: #f8f9fa; padding: 12px; border-radius: 6px;">
                        <p style="margin: 5px 0;"><strong>Your answer:</strong> ${userAnswer}</p>
                        ${!isCorrect ? `<p style="margin: 5px 0;"><strong>Correct answer:</strong> ${correctAnswer}</p>` : ''}
                        ${q.explanation ? `<p style="margin: 5px 0; font-style: italic;">${q.explanation}</p>` : ''}
                    </div>
                </div>
            `;
        });
    } else {
        // Generate summary if detailed questions not available
        const wrongCount = totalQuestions - correctAnswers;
        questionsHTML = `
            <div style="background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; margin-bottom: 15px; text-align: center;">
                <i class="fas fa-check-circle" style="font-size: 50px; color: #27ae60; margin-bottom: 15px;"></i>
                <h4 style="color: #2c3e50; margin-bottom: 10px;">Quiz Summary</h4>
                <p style="color: #666; margin-bottom: 5px;">You answered <strong>${correctAnswers}</strong> out of <strong>${totalQuestions}</strong> questions correctly.</p>
                <p style="color: #666; margin-bottom: 15px;">Score: <strong style="color: #7a0000;">${score}%</strong></p>
                
                <div style="background: #f8f9fa; border-radius: 8px; padding: 15px;">
                    <div style="margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>Correct</span>
                            <span style="color: #27ae60; font-weight: bold;">${correctAnswers}</span>
                        </div>
                        <div style="height: 8px; background: #ecf0f1; border-radius: 4px; overflow: hidden;">
                            <div style="height: 100%; width: ${(correctAnswers/totalQuestions)*100}%; background: #27ae60;"></div>
                        </div>
                    </div>
                    <div>
                        <div style="display: flex; justify-width: space-between; margin-bottom: 5px;">
                            <span>Incorrect</span>
                            <span style="color: #e74c3c; font-weight: bold;">${wrongCount}</span>
                        </div>
                        <div style="height: 8px; background: #ecf0f1; border-radius: 4px; overflow: hidden;">
                            <div style="height: 100%; width: ${(wrongCount/totalQuestions)*100}%; background: #e74c3c;"></div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    // Build complete modal HTML
    const modalHTML = `
        <div class="quiz-review-modal-parent" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 100000; padding: 20px;">
            <div style="background: white; border-radius: 12px; max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                
                <!-- Header -->
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px 12px 0 0; position: sticky; top: 0; z-index: 10;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0; font-size: 18px;"><i class="fas fa-chart-bar"></i> ${quizTitle}</h3>
                        <div style="background: rgba(255,255,255,0.2); padding: 8px 15px; border-radius: 20px; font-weight: bold;">Score: ${score}%</div>
                    </div>
                </div>
                
                <!-- Summary Stats -->
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; padding: 20px; background: #f8f9fa; border-bottom: 1px solid #eee;">
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #7a0000;">${totalQuestions}</div>
                        <div style="font-size: 12px; color: #666;">Total</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #27ae60;">${correctAnswers}</div>
                        <div style="font-size: 12px; color: #666;">Correct</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #e74c3c;">${totalQuestions - correctAnswers}</div>
                        <div style="font-size: 12px; color: #666;">Wrong</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #3498db;">${timeFormatted}</div>
                        <div style="font-size: 12px; color: #666;">Time</div>
                    </div>
                </div>
                
                <!-- Score Circle -->
                <div style="display: flex; justify-content: center; padding: 20px 20px 10px;">
                    <div style="width: 120px; height: 120px; border-radius: 50%; background: conic-gradient(${scoreColor} ${score}%, #ecf0f1 ${score}%); display: flex; align-items: center; justify-content: center; position: relative;">
                        <div style="width: 90px; height: 90px; border-radius: 50%; background: white; display: flex; align-items: center; justify-content: center; flex-direction: column;">
                            <span style="font-size: 28px; font-weight: bold; color: ${scoreColor};">${score}%</span>
                        </div>
                    </div>
                </div>
                
                <!-- Questions List -->
                <div style="padding: 20px; max-height: 400px; overflow-y: auto;">
                    <h4 style="margin: 0 0 15px 0; color: #2c3e50;"><i class="fas fa-question-circle"></i> Question Review</h4>
                    ${questionsHTML}
                </div>
                
                <!-- Footer -->
                <div style="padding: 20px; border-top: 1px solid #eee; display: flex; justify-content: center; gap: 15px; position: sticky; bottom: 0; background: white; border-radius: 0 0 12px 12px;">
                    <button onclick="closeReviewModal()" style="padding: 12px 25px; border: none; border-radius: 6px; cursor: pointer; background: #ecf0f1; color: #2c3e50; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-times"></i> Close
                    </button>
                    <button onclick="retakeQuiz()" style="padding: 12px 25px; border: none; border-radius: 6px; cursor: pointer; background: #7a0000; color: white; font-weight: 600; display: flex; align-items: center; gap: 8px;" data-quiz-id="${reviewData.quiz_id}">
                        <i class="fas fa-redo"></i> Take Again
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Add event listener to retake button
    const retakeBtn = document.querySelector('button[onclick="retakeQuiz()"]');
    if (retakeBtn) {
        retakeBtn.addEventListener('click', function() {
            const quizId = this.getAttribute('data-quiz-id');
            closeReviewModal();
            setTimeout(() => {
                if (typeof startQuizSystem === 'function') {
                    startQuizSystem(parseInt(quizId));
                }
            }, 300);
        });
    }
}

// ============================================
// CLOSE REVIEW MODAL
// ============================================
window.closeReviewModal = function() {
    const modal = document.querySelector('.quiz-review-modal-parent');
    if (modal) {
        modal.remove();
    }
};

// Retake quiz function
window.retakeQuiz = function() {
    const quizId = document.querySelector('.review-btn.primary')?.getAttribute('data-quiz-id');
    if (quizId) {
        closeReviewModal();
        setTimeout(() => {
            if (typeof startQuizSystem === 'function') {
                startQuizSystem(parseInt(quizId));
            }
        }, 300);
    }
};

// ============================================
// CONNECT REVIEW BUTTONS TO FUNCTION
// ============================================
function connectReviewButtons() {
    console.log('ðŸ”— Connecting review buttons...');
    
    document.querySelectorAll('.quiz-review-btn').forEach(button => {
        // Skip if already attached
        if (button.getAttribute('data-review-attached') === 'true') return;
        
        button.setAttribute('data-review-attached', 'true');
        
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const quizId = this.getAttribute('data-quiz-id');
            const attemptId = this.getAttribute('data-attempt-id');
            
            console.log(`ðŸ“Š Review button clicked for quiz ${quizId}${attemptId ? ', attempt ' + attemptId : ''}`);
            
            if (quizId) {
                reviewQuizSystem(parseInt(quizId), attemptId);
            }
        });
    });
}

// ============================================
// FORCE QUIZ MODAL TO BE LARGER AND SCROLLABLE
// ============================================
(function forceQuizModalLarger() {
    console.log('ðŸ“ Forcing quiz modal to be larger and scrollable...');
    
    const style = document.createElement('style');
    style.textContent = `
        /* SUPER LARGE QUIZ MODAL */
        #quizModal .modal-content {
            max-height: 95vh !important;
            width: 98% !important;
            max-width: 1200px !important;
        }
        
        #quizModal .modal-body {
            max-height: calc(95vh - 70px) !important;
            overflow-y: auto !important;
        }
        
        #quizOptionsGridModal {
            max-height: 600px !important;
            overflow-y: auto !important;
        }
        
        .quiz-option-modal {
            padding: 20px 25px !important;
            margin-bottom: 15px !important;
        }
        
        #quizQuestionTextModal {
            font-size: 22px !important;
            padding: 20px 25px !important;
        }
    `;
    document.head.appendChild(style);
    
    // Observe for modal opening
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                const modal = document.getElementById('quizModal');
                if (modal && modal.style.display === 'flex') {
                    console.log('ðŸŽ¯ Quiz modal opened - applying large scrollable styles');
                    
                    // Apply styles directly
                    setTimeout(() => {
                        const optionsGrid = document.getElementById('quizOptionsGridModal');
                        if (optionsGrid) {
                            optionsGrid.style.maxHeight = '600px';
                            optionsGrid.style.overflowY = 'auto';
                        }
                        
                        const modalContent = modal.querySelector('.modal-content');
                        if (modalContent) {
                            modalContent.style.maxWidth = '1200px';
                        }
                    }, 100);
                }
            }
        });
    });
    
    const modal = document.getElementById('quizModal');
    if (modal) {
        observer.observe(modal, { attributes: true });
    }
})();


// ============================================
// CLOSE QUIZ MODAL - BALIK DIN SA DASHBOARD
// ============================================
function closeQuizSystemModal() {
    console.log('ðŸšª Closing quiz modal - returning to dashboard');
    
    const modal = document.getElementById('quizModal');
    const quizContainer = document.getElementById('quizContainer');
    const resultsContainer = document.getElementById('quizResultsContainer');
    
    if (modal) {
        modal.style.display = 'none';
        document.body.classList.remove('modal-open');
    }
    
    // Reset containers
    if (quizContainer) {
        quizContainer.style.display = 'block';
    }
    if (resultsContainer) {
        resultsContainer.style.display = 'none';
    }
    
    // Stop timer
    if (QuizSystem.timerInterval) {
        clearInterval(QuizSystem.timerInterval);
        QuizSystem.timerInterval = null;
    }
    
    // I-SHOW ANG QUIZ DASHBOARD (may categories)
    const quizInterface = document.getElementById('quizInterfaceContainer');
    const quizCards = document.getElementById('userQuizzesContainer');
    const badgesContainer = document.getElementById('badgesContainer');
    const leaderboardContainer = document.getElementById('leaderboardContainer');
    
    if (quizInterface) {
        quizInterface.classList.add('hidden');
        quizInterface.style.display = 'none';
    }
    
    if (quizCards) {
        quizCards.classList.remove('hidden');
        quizCards.style.display = 'block';
    }
    
    if (badgesContainer) {
        badgesContainer.classList.remove('hidden');
        badgesContainer.style.display = 'block';
    }
    
    if (leaderboardContainer) {
        leaderboardContainer.classList.remove('hidden');
        leaderboardContainer.style.display = 'block';
    }
    
    // I-refresh ang quiz dashboard
    if (typeof loadQuizCategories === 'function') {
        setTimeout(() => {
            loadQuizCategories();
        }, 100);
    }
}


// Replace the startQuizAttempt function
// Sa script.js, gamitin itong modified startQuizAttempt
async function startQuizAttempt(quizId) {
    try {
        const token = localStorage.getItem('authToken');
        const userJson = localStorage.getItem('mathhub_user');
        
        if (!token || !userJson) {
            console.error('âŒ No auth data');
            showNotification('Please login first', 'error');
            return null;
        }
        
        const user = JSON.parse(userJson);
        console.log(`ðŸš€ Starting quiz ${quizId} for user ${user.id}...`);
        
        const response = await fetch(`/api/quiz/${quizId}/start`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ user_id: user.id })
        });
        
        const responseText = await response.text();
        console.log('ðŸ“¥ Raw response:', responseText);
        
        if (!response.ok) {
            console.error(`âŒ Server error ${response.status}:`, responseText);
            
            let errorMessage = `HTTP ${response.status}`;
            try {
                const errorData = JSON.parse(responseText);
                errorMessage = errorData.message || errorMessage;
            } catch (e) {}
            
            // If attempt_number error, use fallback
            if (errorMessage.includes('attempt_number') || errorMessage.includes('column')) {
                console.log('âš ï¸ Column error, using fallback...');
                return await createLocalAttempt(quizId, user.id);
            }
            
            throw new Error(errorMessage);
        }
        
        let data;
        try {
            data = JSON.parse(responseText);
        } catch (e) {
            console.error('âŒ Failed to parse success response:', responseText);
            return await createLocalAttempt(quizId, user.id);
        }
        
        if (data.success && data.attempt) {
            console.log(`âœ… Quiz attempt created! ID: ${data.attempt.attempt_id}`);
            return data.attempt;
        } else {
            throw new Error(data.message || 'Unknown error');
        }
        
    } catch (error) {
        console.error('âŒ Error in startQuizAttempt:', error);
        
        // Fallback: Create local attempt
        try {
            const userJson = localStorage.getItem('mathhub_user');
            const user = JSON.parse(userJson);
            return await createLocalAttempt(quizId, user.id);
        } catch (e) {
            console.error('âŒ Fallback also failed:', e);
            return null;
        }
    }
}


// âœ… Local attempt creator
async function createLocalAttempt(quizId, userId) {
    console.log('ðŸ“ Creating local attempt...');
    
    const localAttempt = {
        attempt_id: Date.now(),
        quiz_id: quizId,
        user_id: userId,
        start_time: new Date().toISOString(),
        completion_status: 'in_progress'
    };
    
    // Save to localStorage
    const attempts = JSON.parse(localStorage.getItem('quiz_attempts') || '[]');
    attempts.push(localAttempt);
    localStorage.setItem('quiz_attempts', JSON.stringify(attempts));
    
    console.log('âœ… Local attempt created:', localAttempt);
    return localAttempt;
}


// âœ… Modified submit function for local attempts
async function submitQuizAnswer(attemptId, questionId, answerData) {
    try {
        const token = localStorage.getItem('authToken');
        
        // âœ… Use the CORRECT URL
        const response = await fetch(`/api/quizzes/${attemptId}/answer`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                question_id: questionId,
                selected_option_id: answerData.selected_option_id || null,
                user_answer: answerData.user_answer || null,
                time_spent_seconds: 0
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            console.log(`âœ… Server response:`, data);
            return data;
        } else {
            console.error('âŒ Server error:', data);
            return null;
        }
        
    } catch (error) {
        console.error('âŒ Error in submitQuizAnswer:', error);
        return null;
    }
}


// Update quiz time in database - SAVE TO quiz_performance TABLE
async function updateQuizTimeInDatabase(elapsedSeconds) {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token || !QuizState.currentAttemptId || !QuizState.currentQuiz) return;
        
        console.log(`â±ï¸ Updating quiz time in quiz_performance table: ${elapsedSeconds} seconds`);
        
        const response = await fetch(`/api/quiz/performance/update-time`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                quiz_id: QuizState.currentQuiz,
                attempt_id: QuizState.currentAttemptId,
                time_spent_seconds: elapsedSeconds,
                average_time_seconds: elapsedSeconds
            })
        });
        
        if (!response.ok) {
            console.warn(`Failed to update time: ${response.status}`);
        } else {
            const data = await response.json();
            if (data.success) {
                console.log(`âœ… Quiz time updated in quiz_performance table: ${elapsedSeconds}s`);
                if (data.performance) {
                    console.log(`ðŸ“Š Updated average time: ${data.performance.average_time_seconds}s`);
                }
            }
        }
    } catch (error) {
        console.error('Error updating quiz time:', error);
    }
}


// Fetch quiz questions
async function fetchQuizQuestions(quizId) {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) {
            console.warn('No auth token available');
            return [];
        }
        
        console.log(`â“ Fetching questions for quiz ${quizId}...`);
        
        const response = await fetch(`/api/quiz/${quizId}/questions`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`Failed to fetch quiz questions: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success && data.questions) {
            console.log(`âœ… Fetched ${data.questions.length} questions`);
            return data.questions;
        } else {
            throw new Error(data.message || 'No questions returned');
        }
    } catch (error) {
        console.error('Error fetching quiz questions:', error);
        return [];
    }
}






// Simple function para kunin ang mga sagot
function collectQuizAnswers() {
    const answers = {};
    
    // Kunin lahat ng napiling sagot
    document.querySelectorAll('.quiz-option.selected').forEach(option => {
        const questionId = option.getAttribute('data-question-id');
        const answer = option.getAttribute('data-option-id');
        if (questionId && answer) {
            answers[questionId] = answer;
        }
    });
    
    return answers;
}
// Complete quiz attempt - WITH AVERAGE TIME
async function completeQuizAttempt(attemptId, timeSpentSeconds = null) {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) {
            console.warn('No auth token available');
            return null;
        }
        
        console.log(`ðŸ Completing quiz attempt ${attemptId}...`);
        
        const requestBody = {};
        if (timeSpentSeconds !== null) {
            requestBody.time_spent_seconds = timeSpentSeconds;
        }
        
        const response = await fetch(`/api/quiz/attempt/${attemptId}/complete`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestBody)
        });
        
        const data = await response.json();
        
        if (!response.ok) {
            console.error('âŒ Server error:', data);
            throw new Error(data.message || `HTTP ${response.status}`);
        }
        
        if (data.success) {
            console.log('âœ… Quiz attempt completed:', data);
            
            // Update daily progress
            await updateDailyProgress({
                quizzes_completed: 1,
                points_earned: data.results?.points_earned || 0
            });
            
            return data;
        } else {
            throw new Error(data.message || 'Failed to complete quiz');
        }
        
    } catch (error) {
        console.error('âŒ Error completing quiz:', error);
        return null;
    }
}


// Get quiz results
async function getQuizResults(attemptId) {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) {
            console.warn('No auth token available');
            return null;
        }
        
        console.log(`ðŸ“Š Getting results for attempt ${attemptId}...`);
        
        const response = await fetch(`/api/quiz/attempt/${attemptId}/results`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`Failed to get quiz results: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success && data.results) {
            console.log('âœ… Quiz results fetched successfully');
            return data.results;
        } else {
            throw new Error(data.message || 'Failed to get quiz results');
        }
    } catch (error) {
        console.error('Error getting quiz results:', error);
        return null;
    }
}


// Fetch user's quiz attempts
async function fetchUserQuizAttempts() {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) {
            console.warn('No auth token available');
            return [];
        }
        
        console.log('ðŸ“‹ Fetching user quiz attempts...');
        
        const response = await fetch(`/api/quiz/user/attempts`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`Failed to fetch quiz attempts: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success && data.attempts) {
            console.log(`âœ… Fetched ${data.attempts.length} quiz attempts`);
            return data.attempts;
        } else {
            throw new Error(data.message || 'No quiz attempts returned');
        }
    } catch (error) {
        console.error('Error fetching quiz attempts:', error);
        return [];
    }
}



// Fetch leaderboard
async function fetchLeaderboard(period = 'weekly') {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) {
            console.warn('No auth token available');
            return [];
        }
        
        console.log(`ðŸ† Fetching ${period} leaderboard...`);
        
        const response = await fetch(`/api/quiz/leaderboard/${period}`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`Failed to fetch leaderboard: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success && data.leaderboard) {
            console.log(`âœ… Fetched leaderboard with ${data.leaderboard.length} entries`);
            return data.leaderboard;
        } else {
            throw new Error(data.message || 'No leaderboard data returned');
        }
    } catch (error) {
        console.error('Error fetching leaderboard:', error);
        return [];
    }
}


// ============================================
// âœ… FIXED: fetchUserBadges
// ============================================
async function fetchUserBadges() {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) {
            console.warn('No auth token available');
            return [];
        }
        
        console.log('ðŸŽ–ï¸ Fetching user badges...');
        
        const response = await fetch('/api/dashboard/badges', {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            }
        });
        
        // Check if response is JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const text = await response.text();
            console.error('âŒ Non-JSON response:', text.substring(0, 200));
            return [];
        }
        
        const data = await response.json();
        
        if (data.success && data.badges) {
            console.log(`âœ… Fetched ${data.badges.length} badges`);
            return data.badges;
        }
        
        return [];
        
    } catch (error) {
        console.error('âš ï¸ Error fetching badges:', error.message);
        return [];
    }
}


// Fetch user points
async function fetchUserPoints() {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) {
            console.warn('No auth token available');
            return { total_points: 0, points_history: [] };
        }
        
        console.log('ðŸ’° Fetching user points...');
        
        const response = await fetch(`/api/quiz/user/points`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`Failed to fetch points: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success && data.points) {
            console.log(`âœ… User has ${data.points.total_points} points`);
            return data.points;
        } else {
            throw new Error(data.message || 'No points data returned');
        }
    } catch (error) {
        console.error('Error fetching points:', error);
        return { total_points: 0, points_history: [] };
    }
}

// ============================================
// LOAD QUIZ STATS FROM SERVER - UPDATED
// ============================================
async function loadQuizStatsFromServer() {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) {
            console.warn('No auth token available for quiz stats');
            return;
        }

        console.log('ðŸ“Š Loading quiz statistics from server...');
        
        // Get elements
        const scoreEl = document.getElementById('quizCurrentScore');
        const accuracyEl = document.getElementById('quizAccuracy');
        const timeEl = document.getElementById('quizTimeSpent');
        const rankEl = document.getElementById('quizRank');
        
        // Show loading state
        if (scoreEl) scoreEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        if (accuracyEl) accuracyEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        if (timeEl) timeEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        if (rankEl) rankEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

        // TRY 1: Use the dedicated quiz stats endpoint
        try {
            const response = await fetch(`/api/quiz/user/stats`, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                const data = await response.json();
                console.log('âœ… Quiz stats loaded from /quiz/user/stats:', data);

                if (data.success && data.stats) {
                    updateQuizStatsUI(data.stats);
                    return;
                }
            } else {
                console.warn(`âš ï¸ /quiz/user/stats returned ${response.status}`);
            }
        } catch (error) {
            console.warn('âš ï¸ Could not fetch from /quiz/user/stats:', error.message);
        }

        // TRY 2: Use the user progress stats endpoint
        try {
            const response = await fetch(`/api/user/progress/stats`, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                const data = await response.json();
                console.log('âœ… Quiz stats loaded from /user/progress/stats:', data);

                if (data.success && data.stats) {
                    const mappedStats = {
                        current_score: data.stats.quiz_avg_score || 0,
                        accuracy: data.stats.accuracy || 0,
                        time_spent: formatTimeSpent(data.stats.total_time_minutes || 0),
                        rank: await fetchUserRank() || '#--'
                    };
                    updateQuizStatsUI(mappedStats);
                    return;
                }
            }
        } catch (error) {
            console.warn('âš ï¸ Could not fetch from /user/progress/stats:', error.message);
        }

        // TRY 3: Calculate from quiz attempts
        console.log('ðŸ“Š Calculating quiz stats from attempts...');
        try {
            const attempts = await fetchUserQuizAttempts();
            
            if (attempts && attempts.length > 0) {
                const completedAttempts = attempts.filter(a => a.completion_status === 'completed');
                
                if (completedAttempts.length > 0) {
                    const totalScore = completedAttempts.reduce((sum, a) => sum + (a.score || 0), 0);
                    const avgScore = Math.round(totalScore / completedAttempts.length);
                    
                    const passedCount = completedAttempts.filter(a => a.passed === 1 || a.passed === true).length;
                    const accuracy = Math.round((passedCount / completedAttempts.length) * 100);
                    
                    const totalTimeSeconds = completedAttempts.reduce((sum, a) => sum + (a.time_spent_seconds || 0), 0);
                    const totalTimeMinutes = Math.round(totalTimeSeconds / 60);
                    const formattedTime = formatTimeSpent(totalTimeMinutes);
                    
                    const rank = await fetchUserRank();
                    
                    const calculatedStats = {
                        current_score: avgScore,
                        accuracy: accuracy,
                        time_spent: formattedTime,
                        rank: rank
                    };
                    
                    console.log('âœ… Calculated stats from attempts:', calculatedStats);
                    updateQuizStatsUI(calculatedStats);
                    return;
                }
            }
        } catch (error) {
            console.warn('âš ï¸ Could not calculate from attempts:', error.message);
        }
        
        // No data available - show zeros
        console.log('â„¹ï¸ No quiz data found, showing zeros');
        updateQuizStatsUI({
            current_score: 0,
            accuracy: 0,
            time_spent: '0m',
            rank: '#--'
        });

    } catch (error) {
        console.error('âŒ Fatal error loading quiz stats:', error);
        
        updateQuizStatsUI({
            current_score: 0,
            accuracy: 0,
            time_spent: '0m',
            rank: '#--'
        });
    }
}



// ============================================
// LOAD QUIZ CATEGORIES - UPDATED
// ============================================
async function loadQuizCategories() {
    try {
        const categories = await fetchQuizCategories();
        QuizState.quizCategories = categories;
        
        const quizzesContainer = document.getElementById('userQuizzesContainer');
        if (!quizzesContainer) {
            console.error('Quiz container not found');
            return;
        }
        
        if (categories.length === 0) {
            quizzesContainer.innerHTML = `
                <div class="no-categories">
                    <i class="fas fa-clipboard-list"></i>
                    <h3>No quiz categories available</h3>
                    <p>Check back later for new quizzes!</p>
                </div>
            `;
            return;
        }
        
        // Display categories as cards
        let html = '';
        categories.forEach(category => {
            html += `
                <div class="quiz-category-card" data-category-id="${category.category_id}">
                    <div class="quiz-category-icon" style="background: ${category.color || '#7a0000'}">
                        <i class="${category.icon || 'fas fa-question-circle'}"></i>
                    </div>
                    <div class="quiz-category-info">
                        <h3 class="quiz-category-title">${category.category_name}</h3>
                        <p class="quiz-category-desc">${category.description || 'Test your knowledge in this category'}</p>
                        <div class="quiz-category-stats">
                            <span class="quiz-category-stat">
                                <i class="fas fa-question-circle"></i> ${category.quiz_count || 0} Quizzes
                            </span>
                        </div>
                    </div>
                    <button class="quiz-category-btn" data-category-id="${category.category_id}">
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            `;
        });
        
        quizzesContainer.innerHTML = html;
        
        // Add event listeners to category buttons
        document.querySelectorAll('.quiz-category-btn').forEach(button => {
            button.addEventListener('click', async function(e) {
                e.stopPropagation();
                const categoryId = this.getAttribute('data-category-id');
                await loadQuizzesForCategory(categoryId);
            });
        });
        
        // Add event listeners to category cards
        document.querySelectorAll('.quiz-category-card').forEach(card => {
            card.addEventListener('click', function() {
                const categoryId = this.getAttribute('data-category-id');
                document.querySelectorAll('.quiz-category-card').forEach(c => {
                    c.classList.remove('selected');
                });
                this.classList.add('selected');
                QuizState.selectedCategory = categoryId;
            });
        });
        
    } catch (error) {
        console.error('Error loading quiz categories:', error);
        const quizzesContainer = document.getElementById('userQuizzesContainer');
        if (quizzesContainer) {
            quizzesContainer.innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>Failed to load quiz categories</h3>
                    <p>Please try again later</p>
                </div>
            `;
        }
    }
}


// ============================================
// LOAD QUIZZES FOR CATEGORY - UPDATED
// ============================================
async function loadQuizzesForCategory(categoryId) {
    try {
        console.log(`ðŸ“ Fetching quizzes for category ${categoryId}...`);
        
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) {
            console.warn('No auth token available');
            showNotification('Please login to view quizzes', 'error');
            return;
        }
        
        // Show loading
        const quizOptionsContainer = document.getElementById('quizOptionsContainer');
        if (quizOptionsContainer) {
            quizOptionsContainer.innerHTML = `
                <div style="grid-column: 1/-1; text-align: center; padding: 40px;">
                    <i class="fas fa-spinner fa-pulse fa-3x" style="color: #7a0000;"></i>
                    <p style="margin-top: 20px;">Loading quizzes from database...</p>
                </div>
            `;
        }
        
        const response = await fetch(`/api/quiz/category/${categoryId}/quizzes`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`Failed to fetch quizzes: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('ðŸ“¥ Quiz data:', data);
        
        if (data.success) {
            // Find the selected category
            const selectedCategory = QuizState.quizCategories.find(
                cat => cat.category_id == categoryId || cat.id == categoryId
            ) || {
                category_id: categoryId,
                category_name: data.category?.name || 'Quizzes'
            };
            
            showQuizInterfaceForCategory(selectedCategory, data.quizzes);
        } else {
            throw new Error(data.message || 'No quizzes returned');
        }
        
    } catch (error) {
        console.error('Error loading quizzes:', error);
        showNotification('Failed to load quizzes: ' + error.message, 'error');
        
        const quizOptionsContainer = document.getElementById('quizOptionsContainer');
        if (quizOptionsContainer) {
            quizOptionsContainer.innerHTML = `
                <div style="grid-column: 1/-1; text-align: center; padding: 40px;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #e74c3c; margin-bottom: 15px;"></i>
                    <h3>Failed to load quizzes</h3>
                    <p>${error.message}</p>
                    <button class="btn-primary" onclick="location.reload()">
                        <i class="fas fa-redo"></i> Refresh
                    </button>
                </div>
            `;
        }
    }
}


// Add this function:
async function fetchAllQuizzes() {
    try {
        const token = localStorage.getItem('authToken');
        const response = await fetch(`/api/quizzes/available`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!response.ok) throw new Error('Failed');
        
        const data = await response.json();
        return data.quizzes || [];
    } catch (error) {
        console.error('Error fetching all quizzes:', error);
        return [];
    }
}


// ============================================
// SHOW QUIZ INTERFACE FOR CATEGORY - UPDATED
// ============================================
function showQuizInterfaceForCategory(category, quizzes) {
    console.log('ðŸŽ¯ Showing quiz interface for category:', category);
    console.log('ðŸ“‹ Quizzes to display:', quizzes);
    
    // Get current user ID
    const userJson = localStorage.getItem('mathhub_user');
    let currentUserId = null;
    if (userJson) {
        try {
            const user = JSON.parse(userJson);
            currentUserId = user.id;
        } catch (e) {
            console.error('Error parsing user:', e);
        }
    }
    
    // Hide categories container
    const categoriesContainer = document.getElementById('userQuizzesContainer');
    const quizInterfaceContainer = document.getElementById('quizInterfaceContainer');
    const badgesContainer = document.getElementById('badgesContainer');
    const leaderboardContainer = document.getElementById('leaderboardContainer');
    
    if (categoriesContainer) {
        categoriesContainer.classList.add('hidden');
        categoriesContainer.style.display = 'none';
        console.log('âœ… Hidden categories container');
    }
    
    if (badgesContainer) {
        badgesContainer.classList.add('hidden');
        badgesContainer.style.display = 'none';
    }
    
    if (leaderboardContainer) {
        leaderboardContainer.classList.add('hidden');
        leaderboardContainer.style.display = 'none';
    }
    
    // Show quiz interface
    if (quizInterfaceContainer) {
        quizInterfaceContainer.classList.remove('hidden');
        quizInterfaceContainer.style.display = 'block';
        quizInterfaceContainer.style.opacity = '1';
        quizInterfaceContainer.style.visibility = 'visible';
        console.log('âœ… Showing quiz interface container');
    } else {
        console.error('âŒ quizInterfaceContainer not found!');
        return;
    }
    
    // Update active quiz title
    const activeQuizTitle = document.getElementById('activeQuizTitle');
    if (activeQuizTitle) {
        activeQuizTitle.textContent = `${category.category_name || category.name || 'Quiz'} Quizzes`;
    }
    
    // Get the options container
    const quizOptionsContainer = document.getElementById('quizOptionsContainer');
    if (!quizOptionsContainer) {
        console.error('âŒ quizOptionsContainer not found!');
        return;
    }
    
    quizOptionsContainer.style.display = '';
    quizOptionsContainer.style.opacity = '1';
    quizOptionsContainer.style.visibility = 'visible';
    quizOptionsContainer.innerHTML = '';
    
    if (!quizzes || quizzes.length === 0) {
        quizOptionsContainer.innerHTML = `
            <div style="grid-column: 1/-1; text-align: center; padding: 40px;">
                <i class="fas fa-clipboard-check" style="font-size: 48px; color: #95a5a6; margin-bottom: 15px;"></i>
                <h3>No quizzes available in this category</h3>
                <p>Check back later for new quizzes!</p>
                <button class="btn-primary" onclick="location.reload()" style="margin-top: 15px;">
                    <i class="fas fa-redo"></i> Refresh
                </button>
            </div>
        `;
        return;
    }
    
    // Create quiz cards
    quizzes.forEach(quiz => {
        const difficultyClass = `difficulty-${quiz.difficulty || 'medium'}`;
        const difficultyColor = 
            quiz.difficulty === 'easy' ? '#27ae60' : 
            quiz.difficulty === 'medium' ? '#f39c12' : 
            quiz.difficulty === 'hard' ? '#e74c3c' : '#3498db';
        
        // Get user-specific progress
        let attempts = quiz.user_progress?.attempts || 0;
        let bestScore = quiz.user_progress?.best_score || 0;
        let canAttempt = quiz.user_progress?.can_attempt !== false;
        
        const quizCard = document.createElement('div');
        quizCard.className = 'quiz-option';
        quizCard.setAttribute('data-quiz-id', quiz.quiz_id);
        quizCard.style.opacity = '1';
        quizCard.style.visibility = 'visible';
        quizCard.style.display = 'block';
        
        quizCard.innerHTML = `
    <div class="quiz-option-header">
        <h4>${quiz.quiz_title || 'Untitled Quiz'}</h4>
        <span class="quiz-option-difficulty ${difficultyClass}" style="background: ${difficultyColor}">
            ${quiz.difficulty || 'medium'}
        </span>
    </div>
    
    <div class="quiz-option-body">
        <p>${quiz.description || 'Test your knowledge with this quiz.'}</p>
        
        <div class="quiz-option-meta">
            <span class="quiz-option-meta-item">
                <i class="fas fa-question-circle"></i> ${quiz.total_questions || 0} Questions
            </span>
            <span class="quiz-option-meta-item">
                <i class="fas fa-clock"></i> ${quiz.duration_minutes || 10} min
            </span>
            <span class="quiz-option-meta-item">
                <i class="fas fa-trophy"></i> ${quiz.passing_score || 70}% to pass
            </span>
        </div>
        
        ${attempts > 0 ? `
            <div class="quiz-option-attempts">
                <strong>Your Best Score:</strong> ${bestScore}%
                (${attempts} attempt${attempts > 1 ? 's' : ''})
            </div>
        ` : ''}
    </div>
    
    <div class="quiz-option-actions">
        <button class="quiz-start-btn ${!canAttempt ? 'disabled' : ''}" 
                data-quiz-id="${quiz.quiz_id}"
                ${!canAttempt ? 'disabled' : ''}>
            <i class="fas fa-play"></i> ${attempts > 0 ? 'Retake Quiz' : 'Start Quiz'}
        </button>
        ${attempts > 0 ? `
            <button class="quiz-review-btn" 
                    data-quiz-id="${quiz.quiz_id}"
                    data-attempt-id="${quiz.user_attempts && quiz.user_attempts.length > 0 ? quiz.user_attempts[0].attempt_id : ''}">
                <i class="fas fa-chart-bar"></i> Review
            </button>
        ` : ''}
    </div>
`;
        
        quizOptionsContainer.appendChild(quizCard);
    });
    
    // Add event listeners
    document.querySelectorAll('.quiz-start-btn:not(.disabled)').forEach(button => {
        button.addEventListener('click', async function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const quizId = this.getAttribute('data-quiz-id');
            console.log('ðŸŽ¯ Starting quiz:', quizId);
            await startQuizSystem(parseInt(quizId));
        });
    });
    
    document.querySelectorAll('.quiz-review-btn').forEach(button => {
        button.addEventListener('click', async function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const quizId = this.getAttribute('data-quiz-id');
            console.log('ðŸ“Š Reviewing quiz:', quizId);
            alert('Review feature coming soon!');
        });
    });
    
    console.log('âœ… Quiz interface updated with', quizzes.length, 'quizzes');
}

// Add this function to check visibility on page load
function checkAndFixQuizVisibility() {
    console.log('ðŸ” Checking quiz visibility on page load...');
    
    // Check if quiz interface should be visible
    const quizInterfaceContainer = document.getElementById('quizInterfaceContainer');
    const categoriesContainer = document.getElementById('userQuizzesContainer');
    
    // If categories are hidden, quiz interface should be visible
    if (categoriesContainer?.classList.contains('hidden') || categoriesContainer?.style.display === 'none') {
        if (quizInterfaceContainer) {
            quizInterfaceContainer.classList.remove('hidden');
            quizInterfaceContainer.style.display = 'block';
            quizInterfaceContainer.style.opacity = '1';
            quizInterfaceContainer.style.visibility = 'visible';
        }
    }
    
    // Fix any containers with opacity 0
    document.querySelectorAll('.container').forEach(container => {
        const style = window.getComputedStyle(container);
        if (style.opacity === '0' && container.offsetParent !== null) {
            container.style.opacity = '1';
            container.style.visibility = 'visible';
        }
    });
    
    // Fix quiz cards
    document.querySelectorAll('.quiz-option').forEach(card => {
        card.style.opacity = '1';
        card.style.visibility = 'visible';
    });
}

// Run on every page load
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(checkAndFixQuizVisibility, 100);
});

// Also run after any fetch requests
const originalFetch = window.fetch;
window.fetch = function() {
    return originalFetch.apply(this, arguments).then(response => {
        setTimeout(checkAndFixQuizVisibility, 200);
        return response;
    });
};

// Load user quiz stats - FIXED FOR YOUR HTML STRUCTURE
async function loadUserQuizStats() {
    try {
        const attempts = await fetchUserQuizAttempts();
        const points = await fetchUserPoints();
        
        // Update stats display in your HTML
        const quizCurrentScore = document.getElementById('quizCurrentScore');
        const quizAccuracy = document.getElementById('quizAccuracy');
        const quizTimeSpent = document.getElementById('quizTimeSpent');
        const quizRank = document.getElementById('quizRank');
        
        if (attempts.length > 0) {
            const completedQuizzes = attempts.filter(a => a.completion_status === 'completed').length;
            const averageScore = attempts.reduce((sum, a) => sum + a.score, 0) / attempts.length;
            const totalTimeSpent = attempts.reduce((sum, a) => sum + (a.time_spent_seconds || 0), 0);
            
            // Calculate rank based on points
            const userRank = Math.max(1, Math.floor(Math.random() * 100) + 1); // Temporary random rank
            
            if (quizCurrentScore) {
                quizCurrentScore.textContent = `${Math.round(averageScore)}%`;
            }
            
            if (quizAccuracy) {
                const accuracy = attempts.length > 0 ? 
                    (attempts.filter(a => a.score >= 70).length / attempts.length) * 100 : 0;
                quizAccuracy.textContent = `${Math.round(accuracy)}%`;
            }
            
            if (quizTimeSpent) {
                const hours = Math.floor(totalTimeSpent / 3600);
                const minutes = Math.floor((totalTimeSpent % 3600) / 60);
                quizTimeSpent.textContent = hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;
            }
            
            if (quizRank) {
                quizRank.textContent = `#${userRank}`;
            }
        } else {
            if (quizCurrentScore) quizCurrentScore.textContent = '0%';
            if (quizAccuracy) quizAccuracy.textContent = '0%';
            if (quizTimeSpent) quizTimeSpent.textContent = '0m';
            if (quizRank) quizRank.textContent = '#--';
        }
        
    } catch (error) {
        console.error('Error loading user quiz stats:', error);
        // Set default values on error
        const quizCurrentScore = document.getElementById('quizCurrentScore');
        const quizAccuracy = document.getElementById('quizAccuracy');
        const quizTimeSpent = document.getElementById('quizTimeSpent');
        const quizRank = document.getElementById('quizRank');
        
        if (quizCurrentScore) quizCurrentScore.textContent = '0%';
        if (quizAccuracy) quizAccuracy.textContent = '0%';
        if (quizTimeSpent) quizTimeSpent.textContent = '0m';
        if (quizRank) quizRank.textContent = '#--';
    }
}


// ============================================
// LOAD LEADERBOARD - UPDATED
// ============================================
async function loadLeaderboard(period = 'weekly') {
    try {
        console.log(`ðŸ† Loading ${period} leaderboard...`);
        
        const leaderboardList = document.getElementById('leaderboardList');
        if (!leaderboardList) {
            console.log('Leaderboard element not found, skipping');
            return;
        }
        
        // Show loading
        leaderboardList.innerHTML = `
            <div class="loading-container">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Loading leaderboard...</p>
            </div>
        `;
        
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) {
            leaderboardList.innerHTML = `
                <div class="no-leaderboard">
                    <i class="fas fa-trophy"></i>
                    <h3>Login to see leaderboard</h3>
                    <p>Complete quizzes to appear on the leaderboard!</p>
                </div>
            `;
            return;
        }
        
        const response = await fetch(`/api/quiz/leaderboard/${period}`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`Failed to fetch leaderboard: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success && data.leaderboard && data.leaderboard.length > 0) {
            displayLeaderboard(data.leaderboard);
        } else {
            // No data yet - show empty state
            leaderboardList.innerHTML = `
                <div class="no-leaderboard">
                    <i class="fas fa-trophy"></i>
                    <h3>No leaderboard data yet</h3>
                    <p>Complete quizzes to appear on the leaderboard!</p>
                    <button class="btn-primary" onclick="document.querySelector('[data-page=\"quiz\"]').click()">
                        <i class="fas fa-play"></i> Take a Quiz
                    </button>
                </div>
            `;
        }
        
    } catch (error) {
        console.error('Error loading leaderboard:', error);
        const leaderboardList = document.getElementById('leaderboardList');
        if (leaderboardList) {
            leaderboardList.innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>Unable to load leaderboard</p>
                    <button class="btn-secondary" onclick="loadLeaderboard('${period}')">
                        <i class="fas fa-redo"></i> Try Again
                    </button>
                </div>
            `;
        }
    }
}


// ============================================
// DISPLAY LEADERBOARD - UPDATED
// ============================================
function displayLeaderboard(leaderboard) {
    const leaderboardList = document.getElementById('leaderboardList');
    if (!leaderboardList) return;
    
    // Get current user
    const userJson = localStorage.getItem('mathhub_user');
    let currentUserId = null;
    if (userJson) {
        try {
            const user = JSON.parse(userJson);
            currentUserId = user.id;
        } catch (e) {
            console.error('Error parsing user:', e);
        }
    }
    
    let html = '';
    
    leaderboard.forEach((entry, index) => {
        const isCurrentUser = entry.user_id === currentUserId;
        const rankClass = index === 0 ? 'first' : 
                        index === 1 ? 'second' : 
                        index === 2 ? 'third' : '';
        
        // Get medal icon for top 3
        let rankDisplay = index + 1;
        if (index === 0) rankDisplay = 'ðŸ¥‡';
        else if (index === 1) rankDisplay = 'ðŸ¥ˆ';
        else if (index === 2) rankDisplay = 'ðŸ¥‰';
        
        html += `
            <div class="leaderboard-item ${isCurrentUser ? 'current-user' : ''}">
                <div class="leaderboard-rank ${rankClass}">${rankDisplay}</div>
                <div class="leaderboard-user">
                    <div class="leaderboard-user-name">${entry.full_name || entry.username}</div>
                    <div class="leaderboard-user-stats">
                        <span class="leaderboard-stat">
                            <i class="fas fa-star"></i> ${entry.total_points} pts
                        </span>
                        <span class="leaderboard-stat">
                            <i class="fas fa-trophy"></i> ${entry.quizzes_completed} quizzes
                        </span>
                        <span class="leaderboard-stat">
                            <i class="fas fa-chart-line"></i> ${entry.avg_score}% avg
                        </span>
                    </div>
                </div>
                <div class="leaderboard-score">${entry.highest_score}%</div>
            </div>
        `;
    });
    
    leaderboardList.innerHTML = html;
}


async function initQuizDashboard() {
    console.log('ðŸ§  Initializing quiz dashboard...');
    
    try {
        // Show loading in userQuizzesContainer
        const container = document.getElementById('userQuizzesContainer');
        if (container) {
            container.innerHTML = `
                <div class="loading-container">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Loading quiz categories...</p>
                </div>
            `;
        }
        
        // Show loading in stats cards
        const statsElements = {
            score: document.getElementById('quizCurrentScore'),
            accuracy: document.getElementById('quizAccuracy'),
            time: document.getElementById('quizTimeSpent'),
            rank: document.getElementById('quizRank')
        };
        
        if (statsElements.score) statsElements.score.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        if (statsElements.accuracy) statsElements.accuracy.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        if (statsElements.time) statsElements.time.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        if (statsElements.rank) statsElements.rank.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        
        // Load all data in parallel for better performance
        const [categories, stats, leaderboard, badges] = await Promise.allSettled([
            loadQuizCategories(),
            loadQuizStatsFromServer(),
            loadLeaderboard('weekly'),
            loadUserBadges()
        ]);
        
        // Check results
        if (categories.status === 'rejected') {
            console.error('âŒ Failed to load categories:', categories.reason);
        }
        
        if (stats.status === 'rejected') {
            console.error('âŒ Failed to load stats:', stats.reason);
            // Set default stats
            updateQuizStatsUI({
                current_score: 0,
                accuracy: 0,
                time_spent: '0m',
                rank: '#--'
            });
        }
        
        if (leaderboard.status === 'rejected') {
            console.error('âŒ Failed to load leaderboard:', leaderboard.reason);
        }
        
        if (badges.status === 'rejected') {
            console.error('âŒ Failed to load badges:', badges.reason);
        }
        
        // Hide quiz interface
        const quizInterface = document.getElementById('quizInterfaceContainer');
        if (quizInterface) {
            quizInterface.classList.add('hidden');
            quizInterface.style.display = 'none';
        }
        
        console.log('âœ… Quiz dashboard initialized successfully');
        
        // Show success notification
        showNotification('Quiz dashboard ready!', 'success');
        
    } catch (error) {
        console.error('âŒ Error initializing quiz dashboard:', error);
        showNotification('Failed to initialize quiz dashboard', 'error');
        
        // Show error in stats
        updateQuizStatsUI({
            current_score: 0,
            accuracy: 0,
            time_spent: '0m',
            rank: '#--'
        });
    }
}



// ============================================
// LOAD USER BADGES - UPDATED FOR YOUR HTML
// ============================================
async function loadUserBadges() {
    try {
        const badges = await fetchUserBadges();
        
        const badgesGrid = document.getElementById('badgesGrid');
        if (!badgesGrid) return;
        
        // Clear the grid first
        badgesGrid.innerHTML = '';
        
        if (!badges || badges.length === 0) {
            badgesGrid.innerHTML = `
                <div class="no-badges">
                    <i class="fas fa-award"></i>
                    <h3>No badges yet</h3>
                    <p>Complete quizzes and exercises to earn badges!</p>
                </div>
            `;
            return;
        }
        
        let html = '';
        badges.forEach(badge => {
            const badgeName = badge.badge_name || badge.name || 'Achievement Badge';
            const badgeDescription = badge.description || badge.desc || 'Achievement badge earned through excellence';
            const badgeIcon = badge.icon || badge.badge_icon || 'fas fa-award';
            const badgeColor = badge.color || badge.badge_color || '#3498db';
            const earnedDate = badge.earned_at || badge.date_earned || badge.created_at;
            
            html += `
                <div class="badge-item" title="${badgeName} - Earned: ${formatDate(earnedDate) || 'Recently'}">
                    <div class="badge-icon" style="background: ${badgeColor}">
                        <i class="${badgeIcon}"></i>
                    </div>
                    <div class="badge-info">
                        <h4>${badgeName}</h4>
                        <p>${badgeDescription}</p>
                        ${earnedDate ? `<small>Earned: ${formatTimeAgo(earnedDate)}</small>` : ''}
                    </div>
                </div>
            `;
        });
        
        badgesGrid.innerHTML = html;
        
    } catch (error) {
        console.error('âš ï¸ Error loading badges:', error);
        const badgesGrid = document.getElementById('badgesGrid');
        if (badgesGrid) {
            badgesGrid.innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>Unable to load badges</h3>
                    <p>Please try refreshing the page</p>
                </div>
            `;
        }
    }
}


// ============================================
// FETCH ACCURACY RATE - NEW FUNCTION
// ============================================
async function fetchAccuracyRate() {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) return null;
        
        console.log('ðŸ“Š Fetching accuracy rate...');
        
        const response = await fetch(`/api/progress/accuracy-rate`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!response.ok) return null;
        
        const data = await response.json();
        
        if (data.success && data.accuracy) {
            console.log('âœ… Accuracy rate loaded:', data.accuracy);
            
            // Update UI elements
            updateAccuracyRateDisplay(data.accuracy);
            
            return data.accuracy;
        } else {
            return null;
        }
    } catch (error) {
        console.error('Error fetching accuracy rate:', error);
        return null;
    }
}

// ============================================
// UPDATE ACCURACY RATE DISPLAY
// ============================================
function updateAccuracyRateDisplay(accuracy) {
    // Update accuracy in module dashboard sidebar
    const accuracyRate = document.getElementById('accuracyRate');
    if (accuracyRate) {
        accuracyRate.textContent = `${accuracy.overall}%`;
    }
    
    // Update accuracy in quiz dashboard stats
    const quizAccuracy = document.getElementById('quizAccuracy');
    if (quizAccuracy) {
        quizAccuracy.textContent = `${accuracy.quiz}%`;
    }
    
    // Update in progress page stats if they exist
    const overallAccuracy = document.querySelector('.stat-value.accuracy');
    if (overallAccuracy) {
        overallAccuracy.textContent = `${accuracy.overall}%`;
    }
    
    // Update topic mastery accuracy
    if (ProgressState.topicMastery && ProgressState.topicMastery.length > 0) {
        const avgTopicAccuracy = Math.round(
            ProgressState.topicMastery.reduce((sum, t) => sum + (t.accuracy_rate || 0), 0) / 
            ProgressState.topicMastery.length
        );
        
        const accuracyElements = document.querySelectorAll('.topic-item .accuracy-value');
        // Elements will be updated when topics are rendered
    }
}

// Start a quiz - FIXED FOR YOUR HTML STRUCTURE
async function startQuiz(quizId) {
    try {
        console.log(`ðŸš€ Starting quiz ${quizId}...`);
        
        // âœ… CHECK MUNA KUNG MAY USER
        const userJson = localStorage.getItem('mathhub_user');
        if (!userJson) {
            showNotification('Please login first', 'error');
            navigateTo('login');
            return;
        }
        
        const user = JSON.parse(userJson);
        console.log('ðŸ‘¤ Current user:', user);
        
        // Check if user can access the quiz
        const accessCheck = await checkQuizAccess(quizId);
        
        if (!accessCheck.canAccess) {
            showNotification(accessCheck.reason || 'You need to complete the required lessons first', 'error');
            return;
        }
        
        // Show loading sa modal
        showQuizModalLoading();
        
        // âœ… Start quiz attempt - with retry logic
        let attempt = await startQuizAttempt(quizId);
        
        // âœ… If first attempt fails, try one more time
        if (!attempt) {
            console.log('âš ï¸ First attempt failed, retrying...');
            await new Promise(resolve => setTimeout(resolve, 1000));
            attempt = await startQuizAttempt(quizId);
        }
        
        if (!attempt) {
            showNotification('Failed to start quiz. Please try again.', 'error');
            closeQuizModal();
            return;
        }
        
        console.log('âœ… Quiz attempt created:', attempt);
        
        // Fetch quiz questions
        const questions = await fetchQuizQuestions(quizId);
        if (!questions || questions.length === 0) {
            showNotification('No questions available for this quiz', 'error');
            closeQuizModal();
            return;
        }
        
        console.log(`âœ… Loaded ${questions.length} questions`);
        
        // Set quiz state
        QuizState.currentQuiz = quizId;
        QuizState.currentAttemptId = attempt.attempt_id;
        QuizState.questions = questions;
        QuizState.currentQuestionIndex = 0;
        QuizState.userAnswers = {};
        QuizState.startTime = new Date();
        QuizState.isQuizActive = true;
        
        // Ipakita ang quiz modal
        showQuizModal();
        
        // I-load ang unang tanong
        loadQuizQuestionModal(0);
        
        // Simulan ang timer
        startQuizTimerModal();
        
    } catch (error) {
        console.error('âŒ Error starting quiz:', error);
        showNotification('Failed to start quiz: ' + error.message, 'error');
        closeQuizModal();
    }
}
// Ipakita ang quiz modal
function showQuizModal() {
    const modal = document.getElementById('quizModal');
    if (modal) {
        modal.style.display = 'flex';
        document.body.classList.add('modal-open');
        
        // Kunin ang pangalan ng quiz
        const category = QuizState.quizCategories.find(c => 
            c.quizzes?.some(q => q.quiz_id == QuizState.currentQuiz)
        );
        
        const titleSpan = document.getElementById('quizModalTitle');
        if (titleSpan && category) {
            titleSpan.textContent = `${category.category_name} Quiz`;
        }
    }
}

// Isara ang quiz modal
function closeQuizModal() {
    console.log('ðŸšª Closing quiz modal - returning to dashboard');
    
    const modal = document.getElementById('quizModal');
    const quizContainer = document.getElementById('quizContainer');
    const resultsContainer = document.getElementById('quizResultsContainer');
    
    if (modal) {
        modal.style.display = 'none';
        document.body.classList.remove('modal-open');
    }
    
    // Reset containers
    if (quizContainer) {
        quizContainer.style.display = 'block';
    }
    if (resultsContainer) {
        resultsContainer.style.display = 'none';
    }
    
    // Stop timer
    if (QuizSystem.timerInterval) {
        clearInterval(QuizSystem.timerInterval);
        QuizSystem.timerInterval = null;
    }
    
    // I-SHOW ANG QUIZ DASHBOARD (may categories)
    const quizInterface = document.getElementById('quizInterfaceContainer');
    const quizCards = document.getElementById('userQuizzesContainer');
    const badgesContainer = document.getElementById('badgesContainer');
    const leaderboardContainer = document.getElementById('leaderboardContainer');
    
    if (quizInterface) {
        quizInterface.classList.add('hidden');
        quizInterface.style.display = 'none';
    }
    
    if (quizCards) {
        quizCards.classList.remove('hidden');
        quizCards.style.display = 'block';
    }
    
    if (badgesContainer) {
        badgesContainer.classList.remove('hidden');
        badgesContainer.style.display = 'block';
    }
    
    if (leaderboardContainer) {
        leaderboardContainer.classList.remove('hidden');
        leaderboardContainer.style.display = 'block';
    }
    
    // I-refresh ang quiz dashboard
    if (typeof loadQuizCategories === 'function') {
        setTimeout(() => {
            loadQuizCategories();
        }, 100);
    }
}


// Ipakita ang loading sa modal
// ============================================
// SHOW LOADING
// ============================================
function showQuizModalLoading() {
    const modal = document.getElementById('quizModal');
    if (modal) {
        modal.style.display = 'flex';
        
        const optionsGrid = document.getElementById('quizOptionsGridModal');
        if (optionsGrid) {
            optionsGrid.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 50px; color: #7a0000;"></i>
                    <p style="margin-top: 20px; color: #666;">Loading quiz questions...</p>
                </div>
            `;
        }
    }
}




// ============================================
// LOAD QUIZ SYSTEM QUESTION - UPDATED
// ============================================
function loadQuizSystemQuestion(index) {
    if (!QuizSystem.questions || QuizSystem.questions.length === 0) return;
    
    const question = QuizSystem.questions[index];
    QuizSystem.currentIndex = index;
    
    console.log(`ðŸ“ Loading question ${index + 1}/${QuizSystem.questions.length}`);
    
    // Update question number
    const currentNum = document.getElementById('quizCurrentNum');
    const totalNum = document.getElementById('quizTotalNum');
    if (currentNum) currentNum.textContent = index + 1;
    if (totalNum) totalNum.textContent = QuizSystem.questions.length;
    
    // Update question text
    const questionText = document.getElementById('quizQuestionTextModal');
    if (questionText) {
        questionText.textContent = question.question_text || 'Question text not available';
    }
    
    // Update progress dots
    updateQuizSystemProgressDots();
    
    // Show/hide submit button
    const submitBtn = document.getElementById('submitQuizBtn');
    if (submitBtn) {
        const allAnswered = QuizSystem.questions.every(q => 
            QuizSystem.userAnswers[q.question_id] !== undefined
        );
        
        if (index === QuizSystem.questions.length - 1 || allAnswered) {
            submitBtn.style.display = 'block';
        } else {
            submitBtn.style.display = 'none';
        }
    }
    
    // Clear previous options
    const optionsGrid = document.getElementById('quizOptionsGridModal');
    if (!optionsGrid) return;
    
    optionsGrid.innerHTML = '';
    
    // Generate options
    if (question.options && question.options.length > 0) {
        question.options.forEach((option, i) => {
            // âœ… FIXED: Gamitin ang tamang property names
            const optionId = option.id;  // â† DITO: option.id, hindi option.option_id
            const optionText = option.text || option.option_text || `Option ${String.fromCharCode(65 + i)}`;
            const isCorrect = option.is_correct === 1;  // â† TAMA na ito
            const letter = String.fromCharCode(65 + i);
            
            console.log(`Option ${letter}:`, {
                id: optionId,
                text: optionText,
                isCorrect: isCorrect
            });
            
            // Check if this option was previously selected
            const isSelected = QuizSystem.userAnswers[question.question_id] == optionId;
            
            const optionDiv = document.createElement('div');
            optionDiv.className = 'quiz-option-modal' + (isSelected ? ' selected' : '');
            optionDiv.setAttribute('data-option-id', optionId);
            optionDiv.setAttribute('data-question-id', question.question_id);
            optionDiv.setAttribute('data-is-correct', isCorrect);  // Store kung correct
            
            optionDiv.innerHTML = `
                <div class="option-letter" style="
                    width: 30px; height: 30px; border: 2px solid #7a0000; border-radius: 50%; 
                    display: flex; align-items: center; justify-content: center; font-weight: bold;
                    background: ${isSelected ? '#7a0000' : 'transparent'}; 
                    color: ${isSelected ? 'white' : '#7a0000'};
                ">
                    ${letter}
                </div>
                <div style="flex: 1; font-size: 16px;">${optionText}</div>
            `;
            
            optionDiv.addEventListener('click', function() {
                // Remove selected from all
                document.querySelectorAll('.quiz-option-modal').forEach(opt => {
                    opt.classList.remove('selected');
                    opt.querySelector('.option-letter').style.background = 'transparent';
                    opt.querySelector('.option-letter').style.color = '#7a0000';
                });
                
                // Mark this as selected
                this.classList.add('selected');
                this.querySelector('.option-letter').style.background = '#7a0000';
                this.querySelector('.option-letter').style.color = 'white';
                
                // Save answer
                const questionId = question.question_id;
                const optionId = this.getAttribute('data-option-id');
                
                saveAnswerAndContinue(questionId, optionId);
            });
            
            optionsGrid.appendChild(optionDiv);
        });
    } else {
        optionsGrid.innerHTML = '<p class="no-options">No options available for this question.</p>';
    }
}



function loadQuizQuestionModal(index) {
    if (!QuizState.questions || QuizState.questions.length === 0) return;
    
    const question = QuizState.questions[index];
    QuizState.currentQuestionIndex = index;
    
    console.log('ðŸ“ Loading question in modal:', question);
    
    // Update question number
    const currentNum = document.getElementById('quizCurrentNum');
    const totalNum = document.getElementById('quizTotalNum');
    if (currentNum) currentNum.textContent = index + 1;
    if (totalNum) totalNum.textContent = QuizState.questions.length;
    
    // Update question text
    const questionText = document.getElementById('quizQuestionTextModal');
    if (questionText) {
        questionText.textContent = question.question_text || 'Question text not available';
    }
    
    // Get options grid
    const optionsGrid = document.getElementById('quizOptionsGridModal');
    if (!optionsGrid) return;
    
    // Clear previous options
    optionsGrid.innerHTML = '';
    
    // Add options based on question type
    if (question.question_type === 'multiple_choice' || question.question_type === 'true_false') {
        if (question.options && question.options.length > 0) {
            question.options.forEach((option, i) => {
                const optionId = option.id || option.option_id || i + 1;
                const optionText = option.text || option.option_text || `Option ${String.fromCharCode(65 + i)}`;
                
                const optionDiv = document.createElement('div');
                optionDiv.className = 'quiz-option-modal';
                optionDiv.setAttribute('data-option-id', optionId);
                optionDiv.style.cssText = `
                    background: white;
                    border: 2px solid #e0e0e0;
                    border-radius: 8px;
                    padding: 15px 20px;
                    cursor: pointer;
                    transition: all 0.3s;
                    display: flex;
                    align-items: center;
                    gap: 15px;
                `;
                
                optionDiv.innerHTML = `
                    <div style="width: 24px; height: 24px; border: 2px solid #7a0000; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #7a0000;">
                        ${String.fromCharCode(65 + i)}
                    </div>
                    <div style="flex: 1; font-size: 16px;">${optionText}</div>
                `;
                
                optionDiv.addEventListener('mouseover', function() {
                    if (!this.classList.contains('selected')) {
                        this.style.background = '#f5f5f5';
                        this.style.borderColor = '#7a0000';
                    }
                });
                
                optionDiv.addEventListener('mouseout', function() {
                    if (!this.classList.contains('selected')) {
                        this.style.background = 'white';
                        this.style.borderColor = '#e0e0e0';
                    }
                });
                
                optionDiv.addEventListener('click', function() {
                    // Remove selected from all
                    document.querySelectorAll('.quiz-option-modal').forEach(opt => {
                        opt.classList.remove('selected');
                        opt.style.background = 'white';
                        opt.style.borderColor = '#e0e0e0';
                        opt.querySelector('div:first-child').style.background = 'transparent';
                        opt.querySelector('div:first-child').style.color = '#7a0000';
                    });
                    
                    // Mark this as selected
                    this.classList.add('selected');
                    this.style.background = '#e8f5e9';
                    this.style.borderColor = '#7a0000';
                    this.querySelector('div:first-child').style.background = '#7a0000';
                    this.querySelector('div:first-child').style.color = 'white';
                    
                    // Save answer
                    const questionId = question.question_id;
                    QuizState.userAnswers[questionId] = optionId;
                    
                    // Update progress dots
                    updateQuizProgressDots();
                    
                    // Move to next question after short delay
                    setTimeout(() => {
                        if (index < QuizState.questions.length - 1) {
                            loadQuizQuestionModal(index + 1);
                        } else {
                            submitQuizModal();
                        }
                    }, 500);
                });
                
                optionsGrid.appendChild(optionDiv);
            });
        }
    }
    
    // Update progress dots
    updateQuizProgressDots();
}

// Update progress dots
// ============================================
// UPDATE PROGRESS DOTS
// ============================================
function updateQuizSystemProgressDots() {
    const dotsContainer = document.getElementById('quizProgressDotsModal');
    if (!dotsContainer || !QuizSystem.questions) return;
    
    let dotsHTML = '';
    QuizSystem.questions.forEach((q, i) => {
        const isAnswered = QuizSystem.userAnswers[q.question_id] !== undefined;
        const isCurrent = i === QuizSystem.currentIndex;
        
        dotsHTML += `
            <div style="
                width: 12px; 
                height: 12px; 
                border-radius: 50%; 
                background: ${isAnswered ? '#7a0000' : (isCurrent ? '#ff6b6b' : '#ddd')};
                cursor: pointer;
                transition: all 0.3s;
                transform: ${isCurrent ? 'scale(1.2)' : 'scale(1)'};
            " onclick="jumpToQuizQuestion(${i})"></div>
        `;
    });
    
    dotsContainer.innerHTML = dotsHTML;
}


// Jump to specific question
window.jumpToQuizQuestion = function(index) {
    if (index >= 0 && index < QuizSystem.questions.length) {
        loadQuizSystemQuestion(index);
    }
};


// ============================================
// START TIMER
// ============================================
function startQuizSystemTimer() {
    if (QuizSystem.timerInterval) {
        clearInterval(QuizSystem.timerInterval);
    }
    
    QuizSystem.timerInterval = setInterval(() => {
        if (QuizSystem.timeLeft > 0) {
            QuizSystem.timeLeft--;
            
            const minutes = Math.floor(QuizSystem.timeLeft / 60);
            const seconds = QuizSystem.timeLeft % 60;
            
            const timerDisplay = document.getElementById('quizTimerDisplay');
            if (timerDisplay) {
                timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
            
            // Auto-submit when time runs out
            if (QuizSystem.timeLeft <= 0) {
                clearInterval(QuizSystem.timerInterval);
                submitQuizSystem();
            }
        }
    }, 1000);
}


// Submit quiz

// ============================================
// âœ… PERMANENT FIX: SUBMIT QUIZ SYSTEM - WITH WORKING RESULTS DISPLAY & AUTO REFRESH
// ============================================
async function submitQuizSystem() {
    console.log('ðŸ“ Submitting quiz to database...');
    
    try {
        if (!QuizSystem.currentAttemptId) {
            console.error('âŒ No attempt_id found!');
            showNotification('Quiz session expired. Please start again.', 'error');
            closeQuizSystemModal();
            return;
        }
        
        // Stop timer
        if (QuizSystem.timerInterval) {
            clearInterval(QuizSystem.timerInterval);
            QuizSystem.timerInterval = null;
        }
        
        const timeSpentSeconds = Math.floor((Date.now() - QuizSystem.startTime) / 1000);
        console.log(`â±ï¸ Time spent: ${timeSpentSeconds} seconds`);
        
        const token = localStorage.getItem('authToken');
        if (!token) {
            showNotification('Please login again', 'error');
            return;
        }
        
        // ===== COMPUTE SCORE =====
        let correctCount = 0;
        let totalQuestions = QuizSystem.questions.length;
        
        // âœ… Gumamit ng answerResults kung meron
        if (QuizSystem.answerResults) {
            correctCount = Object.values(QuizSystem.answerResults).filter(v => v === true).length;
            console.log(`âœ… Score from answerResults: ${correctCount}/${totalQuestions}`);
        } 
        // âœ… Kung wala, gamitin ang stats
        else if (QuizSystem.stats) {
            correctCount = QuizSystem.stats.correct || 0;
            console.log(`âœ… Score from stats: ${correctCount}/${totalQuestions}`);
        }
        // âœ… Fallback: compute from questions
        else {
            QuizSystem.questions.forEach(q => {
                const userAnswer = QuizSystem.userAnswers[q.question_id];
                if (userAnswer) {
                    const correctOption = q.options?.find(opt => opt.is_correct === 1 || opt.correct === true);
                    if (correctOption && userAnswer == correctOption.id) {
                        correctCount++;
                    }
                }
            });
            console.log(`âœ… Score from questions fallback: ${correctCount}/${totalQuestions}`);
        }
        
        const wrongCount = totalQuestions - correctCount;
        const score = Math.round((correctCount / totalQuestions) * 100);
        const pointsEarned = correctCount * 10;
        
        console.log(`ðŸ“Š FINAL SCORE: ${correctCount}/${totalQuestions} = ${score}%`);
        console.log(`ðŸ’° Points earned: ${pointsEarned}`);
        
        // ===== COMPLETE THE QUIZ ATTEMPT =====
        console.log(`ðŸ Completing attempt ${QuizSystem.currentAttemptId}...`);
        
        const completeResponse = await fetch(`/api/quiz/attempt/${QuizSystem.currentAttemptId}/complete`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                time_spent_seconds: timeSpentSeconds
            })
        });
        
        const completeData = await completeResponse.json();
        console.log('ðŸ“¥ Complete response:', completeData);
        
        // ===== SHOW RESULTS =====
        const quizContainer = document.getElementById('quizContainer');
        const resultsContainer = document.getElementById('quizResultsContainer');
        
        if (quizContainer) quizContainer.style.display = 'none';
        if (resultsContainer) {
            resultsContainer.style.display = 'block';
            
            // âœ… I-display ang results
            resultsContainer.innerHTML = generateResultsHTML({
                score,
                correctCount,
                wrongCount,
                totalQuestions,
                timeSpentSeconds,
                attemptId: QuizSystem.currentAttemptId,
                pointsEarned
            });
        }
        
        // ===== âœ… CRITICAL: AUTO-REFRESH QUIZ STATS =====
        console.log('ðŸ”„ Auto-refreshing quiz stats...');
        
        // I-update ang quiz stats sa sidebar
        await loadQuizStatsFromServer();
        
        // I-update din ang overall progress sa dashboard
        if (typeof updateProgressSummaryCards === 'function') {
            await updateProgressSummaryCards();
        }
        
        // I-update ang cumulative progress
        if (typeof fetchCumulativeProgress === 'function') {
            await fetchCumulativeProgress();
        }
        
        // I-update ang daily progress
        if (typeof fetchDailyProgress === 'function') {
            await fetchDailyProgress();
        }
        
        // I-update ang practice statistics (kung may connection ang quizzes at practice)
        if (typeof fetchPracticeStatistics === 'function') {
            await fetchPracticeStatistics();
        }
        
        // ===== I-UPDATE ANG SPECIFIC UI ELEMENTS =====
        const quizCurrentScore = document.getElementById('quizCurrentScore');
        if (quizCurrentScore) {
            quizCurrentScore.textContent = `${score}%`;
            // Add animation para mapansin
            quizCurrentScore.style.transition = 'all 0.3s';
            quizCurrentScore.style.transform = 'scale(1.2)';
            quizCurrentScore.style.color = '#27ae60';
            setTimeout(() => {
                quizCurrentScore.style.transform = 'scale(1)';
                quizCurrentScore.style.color = '';
            }, 500);
        }
        
        const quizAccuracy = document.getElementById('quizAccuracy');
        if (quizAccuracy) {
            const accuracy = Math.round((correctCount / totalQuestions) * 100);
            quizAccuracy.textContent = `${accuracy}%`;
        }
        
        showNotification(`ðŸŽ‰ Quiz completed! Score: ${score}%`, 'success');
        
        // ===== LOG ACTIVITY =====
        try {
            await logUserActivity('quiz_completed', QuizSystem.currentQuiz, {
                score: score,
                attempt_id: QuizSystem.currentAttemptId
            });
        } catch (logError) {
            console.warn('âš ï¸ Could not log activity:', logError.message);
        }
        
        // Clear tracking
        delete QuizSystem.submittedQuestions;
        delete QuizSystem.answerResults;
        delete QuizSystem.stats;
        
    } catch (error) {
        console.error('âŒ Error in submitQuizSystem:', error);
        
        const resultsContainer = document.getElementById('quizResultsContainer');
        if (resultsContainer) {
            resultsContainer.style.display = 'block';
            resultsContainer.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 60px; color: #e74c3c; margin-bottom: 20px;"></i>
                    <h3 style="color: #2c3e50; margin-bottom: 10px;">Something went wrong</h3>
                    <p style="color: #7f8c8d; margin-bottom: 20px;">${error.message}</p>
                    <button onclick="closeQuizSystemModal()" class="btn-primary" style="padding: 12px 30px;">
                        <i class="fas fa-times"></i> Close
                    </button>
                </div>
            `;
        }
    }
}

// ============================================
// ðŸš€ FORCE REFRESH ALL QUIZ-RELATED UI
// ============================================
async function refreshAllQuizUI() {
    console.log('ðŸ”„ Refreshing all quiz-related UI elements...');
    
    try {
        await Promise.all([
            loadQuizStatsFromServer(),
            fetchCumulativeProgress(),
            fetchDailyProgress(),
            updateProgressSummaryCards()
        ]);
        
        console.log('âœ… All quiz UI refreshed');
    } catch (error) {
        console.error('âŒ Error refreshing quiz UI:', error);
    }
}

// ============================================
// ðŸ”„ AUTO-REFRESH QUIZ STATS EVERY 30 SECONDS (kapag nasa quiz dashboard)
// ============================================
let quizStatsInterval = null;

function startQuizStatsAutoRefresh() {
    // Stop existing interval
    if (quizStatsInterval) {
        clearInterval(quizStatsInterval);
    }
    
    // Start new interval
    quizStatsInterval = setInterval(async () => {
        // Check if quiz dashboard is visible
        const quizPage = document.getElementById('quiz-dashboard-page');
        if (quizPage && !quizPage.classList.contains('hidden')) {
            console.log('ðŸ”„ Auto-refreshing quiz stats...');
            await loadQuizStatsFromServer();
        }
    }, 30000); // Every 30 seconds
}

function stopQuizStatsAutoRefresh() {
    if (quizStatsInterval) {
        clearInterval(quizStatsInterval);
        quizStatsInterval = null;
    }
}

// ============================================
// ðŸŽ¯ DIRECT UPDATE NG QUIZ STATS SA SIDEBAR
// ============================================
async function updateQuizStatsDirectly(score, correctCount, totalQuestions) {
    console.log(`ðŸ“Š Directly updating quiz stats: ${score}%, ${correctCount}/${totalQuestions}`);
    
    const elements = {
        score: document.getElementById('quizCurrentScore'),
        accuracy: document.getElementById('quizAccuracy'),
        time: document.getElementById('quizTimeSpent'),
        rank: document.getElementById('quizRank')
    };
    
    if (elements.score) {
        elements.score.textContent = `${score}%`;
        elements.score.style.transition = 'all 0.3s';
        elements.score.style.transform = 'scale(1.2)';
        elements.score.style.color = '#27ae60';
        setTimeout(() => {
            elements.score.style.transform = 'scale(1)';
            elements.score.style.color = '';
        }, 500);
    }
    
    if (elements.accuracy) {
        const accuracy = Math.round((correctCount / totalQuestions) * 100);
        elements.accuracy.textContent = `${accuracy}%`;
    }
    
    // I-try kunin ang updated rank
    try {
        const token = localStorage.getItem('authToken');
        const rankResponse = await fetch('/api/leaderboard/user/position', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (rankResponse.ok) {
            const rankData = await rankResponse.json();
            if (rankData.success && elements.rank) {
                elements.rank.textContent = `#${rankData.position.rank}`;
            }
        }
    } catch (error) {
        console.warn('Could not fetch rank:', error);
    }
}




// ============================================
// DISPLAY QUIZ RESULTS
// ============================================
function displayQuizResults(container, data) {
    const minutes = Math.floor(data.timeSpentSeconds / 60);
    const seconds = data.timeSpentSeconds % 60;
    const timeFormatted = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    
    const score = data.score;
    let icon = 'fa-smile';
    let iconColor = '#27ae60';
    let bgColor = '#d4edda';
    let message = 'Great job!';
    
    if (score >= 90) {
        icon = 'fa-crown';
        iconColor = '#f1c40f';
        bgColor = '#fff3cd';
        message = 'ðŸ† Excellent! You\'re a math wizard!';
    } else if (score >= 75) {
        icon = 'fa-star';
        iconColor = '#f39c12';
        bgColor = '#fff4e0';
        message = 'ðŸŒŸ Great job! You\'re doing well!';
    } else if (score >= 50) {
        icon = 'fa-smile';
        iconColor = '#3498db';
        bgColor = '#e8f4fd';
        message = 'ðŸ’ª Good effort! Keep practicing!';
    } else {
        icon = 'fa-book';
        iconColor = '#e74c3c';
        bgColor = '#fee9e7';
        message = 'ðŸ“š Don\'t give up! Practice makes perfect!';
    }
    
    container.innerHTML = `
        <div class="modal-body" style="padding: 20px; background: white; border-radius: 12px;">
            <div style="text-align: center; max-width: 400px; margin: 0 auto;">
                
                <!-- Icon -->
                <div style="
                    width: 80px;
                    height: 80px;
                    background: ${iconColor}20;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    margin: 0 auto 15px;
                    border: 3px solid ${iconColor};
                ">
                    <i class="fas ${icon}" style="font-size: 40px; color: ${iconColor};"></i>
                </div>
                
                <!-- Title -->
                <h2 style="color: #2c3e50; margin-bottom: 10px; font-size: 28px;">Quiz Completed!</h2>
                
                <!-- Score Circle -->
                <div style="position: relative; width: 150px; height: 150px; margin: 15px auto;">
                    <svg viewBox="0 0 36 36" style="width: 150px; height: 150px;">
                        <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#e0e0e0" stroke-width="3"></path>
                        <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="${iconColor}" stroke-width="3" stroke-dasharray="${score}, 100" stroke-linecap="round"></path>
                    </svg>
                    <div style="
                        position: absolute;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        font-size: 36px;
                        font-weight: bold;
                        color: ${iconColor};
                    ">
                        ${score}%
                    </div>
                </div>
                
                <!-- Message -->
                <div style="
                    background: ${bgColor};
                    padding: 12px 15px;
                    border-radius: 8px;
                    margin: 15px 0;
                    font-size: 16px;
                    color: #2c3e50;
                    border-left: 4px solid ${iconColor};
                    text-align: left;
                ">
                    <i class="fas fa-quote-left" style="color: ${iconColor}; margin-right: 8px; font-size: 14px;"></i>
                    ${message}
                </div>
                
                <!-- Results Grid -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 10px; color: white;">
                        <div style="font-size: 28px; font-weight: bold;">${data.correctCount}</div>
                        <div style="font-size: 12px; opacity: 0.9;">Correct</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); padding: 15px; border-radius: 10px; color: white;">
                        <div style="font-size: 28px; font-weight: bold;">${data.wrongCount}</div>
                        <div style="font-size: 12px; opacity: 0.9;">Wrong</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); padding: 15px; border-radius: 10px; color: white;">
                        <div style="font-size: 28px; font-weight: bold;">${data.totalQuestions}</div>
                        <div style="font-size: 12px; opacity: 0.9;">Total</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); padding: 15px; border-radius: 10px; color: white;">
                        <div style="font-size: 28px; font-weight: bold;">${timeFormatted}</div>
                        <div style="font-size: 12px; opacity: 0.9;">Time</div>
                    </div>
                </div>
                
                <!-- Points and Attempt ID -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin: 15px 0;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-size: 20px; font-weight: bold; color: #7a0000;">+${data.correctCount * 10}</div>
                            <div style="font-size: 12px; color: #666;">Points Earned</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 16px; font-weight: bold; color: #34495e;">#${data.attemptId}</div>
                            <div style="font-size: 12px; color: #666;">Attempt ID</div>
                        </div>
                    </div>
                </div>
                
                <!-- Database Status -->
                <div style="background: #27ae60; color: white; padding: 8px 12px; border-radius: 6px; margin: 15px 0; font-size: 14px;">
                    <i class="fas fa-check-circle" style="font-size: 14px;"></i> Results saved to database
                </div>
                
                <!-- Action Buttons -->
                <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                    <button onclick="closeQuizSystemModal()" style="
                        padding: 8px 20px;
                        border: 2px solid #7a0000;
                        background: white;
                        color: #7a0000;
                        border-radius: 6px;
                        font-size: 14px;
                        font-weight: bold;
                        cursor: pointer;
                        transition: all 0.3s;
                    ">
                        <i class="fas fa-times"></i> Close
                    </button>
                    <button onclick="window.location.href='/quizdashboard'" style="
                        padding: 8px 20px;
                        background: #3498db;
                        color: white;
                        border: none;
                        border-radius: 6px;
                        font-size: 14px;
                        font-weight: bold;
                        cursor: pointer;
                        transition: all 0.3s;
                    ">
                        <i class="fas fa-tachometer-alt"></i> Dashboard
                    </button>
                    <button onclick="startNewQuiz()" style="
                        padding: 8px 20px;
                        background: #7a0000;
                        color: white;
                        border: none;
                        border-radius: 6px;
                        font-size: 14px;
                        font-weight: bold;
                        cursor: pointer;
                        transition: all 0.3s;
                    ">
                        <i class="fas fa-redo"></i> New
                    </button>
                </div>
            </div>
        </div>
    `;
}


// âœ… Helper functions for result styling
function getResultIcon(score) {
    if (score >= 90) return 'fa-crown';
    if (score >= 75) return 'fa-star';
    if (score >= 50) return 'fa-smile';
    return 'fa-book';
}

function getResultColor(score) {
    if (score >= 90) return '#f1c40f';
    if (score >= 75) return '#f39c12';
    if (score >= 50) return '#3498db';
    return '#e74c3c';
}

function getResultBgColor(score) {
    if (score >= 90) return '#fff9e6';
    if (score >= 75) return '#fff4e0';
    if (score >= 50) return '#e8f4fd';
    return '#fee9e7';
}

function getResultMessage(score) {
    if (score >= 90) return 'ðŸ† Excellent! You\'re a math wizard!';
    if (score >= 75) return 'ðŸŒŸ Great job! You\'re doing well!';
    if (score >= 50) return 'ðŸ’ª Good effort! Keep practicing!';
    return 'ðŸ“š Don\'t give up! Practice makes perfect!';
}

// âœ… Error display function
function showErrorInResults(error) {
    const resultsContainer = document.getElementById('quizResultsContainer');
    if (resultsContainer) {
        resultsContainer.innerHTML = `
            <div class="modal-body" style="padding: 40px; text-align: center;">
                <i class="fas fa-exclamation-triangle" style="font-size: 60px; color: #e74c3c; margin-bottom: 20px;"></i>
                <h3 style="color: #2c3e50;">Something went wrong</h3>
                <p style="color: #7f8c8d; margin: 20px 0;">${error.message}</p>
                <button onclick="closeQuizSystemModal()" style="
                    padding: 12px 20px;
                    background: #7a0000;
                    color: white;
                    border: none;
                    border-radius: 8px;
                    font-size: 16px;
                    cursor: pointer;
                ">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        `;
    }
}

// âœ… Function for new quiz
function startNewQuiz() {
    const quizId = QuizSystem.quizId;
    closeQuizSystemModal();
    setTimeout(() => {
        startQuizSystem(quizId);
    }, 300);
}

// ============================================
// MISSING QUIZ FUNCTIONS - IDAGDAG ITO
// ============================================

window.exitQuiz = function() {
    console.log('ðŸšª Exiting quiz - returning to quiz dashboard');
    
    // Stop timer if running
    if (QuizSystem.timerInterval) {
        clearInterval(QuizSystem.timerInterval);
        QuizSystem.timerInterval = null;
    }
    
    // Hide quiz modal
    const modal = document.getElementById('quizModal');
    if (modal) {
        modal.style.display = 'none';
        document.body.classList.remove('modal-open');
    }
    
    // Reset quiz state
    QuizSystem.currentQuiz = null;
    QuizSystem.currentAttemptId = null;
    QuizSystem.questions = [];
    QuizSystem.currentIndex = 0;
    QuizSystem.userAnswers = {};
    QuizSystem.startTime = null;
    QuizSystem.timeLeft = 0;
    QuizSystem.stats = { correct: 0, wrong: 0, score: 0 };
    
    // I-SHOW ANG QUIZ DASHBOARD (may categories)
    const quizInterface = document.getElementById('quizInterfaceContainer');
    const quizCards = document.getElementById('userQuizzesContainer');
    const badgesContainer = document.getElementById('badgesContainer');
    const leaderboardContainer = document.getElementById('leaderboardContainer');
    
    if (quizInterface) {
        quizInterface.classList.add('hidden');
        quizInterface.style.display = 'none';
    }
    
    if (quizCards) {
        quizCards.classList.remove('hidden');
        quizCards.style.display = 'block';
    }
    
    if (badgesContainer) {
        badgesContainer.classList.remove('hidden');
        badgesContainer.style.display = 'block';
    }
    
    if (leaderboardContainer) {
        leaderboardContainer.classList.remove('hidden');
        leaderboardContainer.style.display = 'block';
    }
    
    // I-refresh ang quiz dashboard kung kailangan
    if (typeof loadQuizCategories === 'function') {
        loadQuizCategories();
    }
    
    if (typeof loadLeaderboard === 'function') {
        loadLeaderboard('weekly');
    }
    
    if (typeof loadUserBadges === 'function') {
        loadUserBadges();
    }
    
    showNotification('Returned to quiz dashboard', 'info');
};


// Return to quiz list
// ============================================
// RETURN TO QUIZ LIST - ALIAS PARA SA EXIT
// ============================================
window.returnToQuizList = function() {
    console.log('ðŸ“‹ Returning to quiz list');
    exitQuiz(); // Tawagin lang ang exitQuiz
};

// Review quiz
window.reviewQuiz = function() {
    console.log('Reviewing quiz');
    if (QuizState.currentQuiz) {
        startQuiz(QuizState.currentQuiz);
    }
};

// Start quiz function (simplified version)
async function startQuiz(quizId) {
    console.log('Starting quiz:', quizId);
    alert('Quiz feature coming soon!');
}

// Make sure QuizState is defined (kung wala pa)
if (typeof QuizState === 'undefined') {
    window.QuizState = {
        currentQuiz: null,
        currentAttemptId: null,
        questions: [],
        currentIndex: 0,
        userAnswers: {},
        startTime: null,
        timerInterval: null,
        timeLeft: 0,
        totalTime: 0
    };
}
function setupQuizButtons() {
    // Find all "Start Quiz" buttons
    document.querySelectorAll('.quiz-start-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const quizId = this.getAttribute('data-quiz-id');
            if (quizId) {
                startQuizSystem(parseInt(quizId));
            }
        });
    });
    
    // Also find any buttons with class 'start-quiz'
    document.querySelectorAll('.start-quiz').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const quizId = this.getAttribute('data-quiz-id') || this.getAttribute('data-id');
            if (quizId) {
                startQuizSystem(parseInt(quizId));
            }
        });
    });
}


document.addEventListener('DOMContentLoaded', function() {
    // Initial setup
    setTimeout(setupQuizButtons, 1000);
    
    // Also setup when quiz interface becomes visible
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'childList' || mutation.type === 'subtree') {
                setupQuizButtons();
            }
        });
    });
    
    observer.observe(document.body, { childList: true, subtree: true });
});
// Run this sa console AFTER mag-quiz
async function checkDatabase() {
    const token = localStorage.getItem('authToken');
    
    // Check latest attempts
    const response = await fetch('/api/quiz/user/attempts', {
        headers: { 'Authorization': `Bearer ${token}` }
    });
    const data = await response.json();
    
    console.log('ðŸ“Š LATEST ATTEMPTS FROM DATABASE:');
    data.attempts.slice(0, 3).forEach(a => {
        console.log({
            attempt_id: a.attempt_id,
            status: a.status,
            score: a.score,
            submit_time: a.submit_time
        });
    });
    
    return data.attempts;
}

// Add this to check what's happening in the database
async function debugLastQuizAttempt() {
    try {
        const token = localStorage.getItem('authToken');
        const response = await fetch(`/api/quiz/debug/last-attempt`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await response.json();
        console.log('ðŸ” Last Quiz Attempt Debug:', data);
        
        if (data.attempt) {
            console.log('ðŸ“Š Attempt ID:', data.attempt.attempt_id);
            console.log('ðŸ“Š Status:', data.attempt.status);
            console.log('ðŸ“Š Score:', data.attempt.total_score);
            console.log('ðŸ“Š Correct Answers:', data.attempt.correct_answers);
            console.log('ðŸ“Š Submit Time:', data.attempt.submit_time);
        }
        
        return data;
    } catch (error) {
        console.error('Debug error:', error);
    }
}


// TO THIS:
const whiteboardStyle = document.createElement('style');  // â† RENAMED HERE
whiteboardStyle.textContent = `
    /* Prevent page scroll/drag when drawing on whiteboard */
    #whiteboardCanvas {
        touch-action: none !important;
        -webkit-touch-callout: none !important;
        -webkit-user-select: none !important;
        user-select: none !important;
        cursor: crosshair !important;
    }
    
    /* Ensure modal doesn't scroll */
    #whiteboardModal.modal-overlay.active {
        overflow: hidden !important;
    }
    
    #whiteboardModal .modal-body {
        overflow: hidden !important;
    }
`;
document.head.appendChild(whiteboardStyle);  // â† UPDATED HERE TOO

console.log('âœ… Mobile whiteboard fix applied');

// Show actual quiz interface (question-by-question) - NEW FUNCTION
function showActualQuizInterface(questions) {
    const quizInterface = document.getElementById('quizInterface');
    const quizOptionsGrid = document.getElementById('quizOptionsGrid');
    
    if (!quizInterface || !quizOptionsGrid) return;
    
    // Hide the quiz selection interface
    quizOptionsGrid.innerHTML = '';
    
    // Load first question
    loadQuizQuestion(0);
}

// Replace the loadQuizQuestion function
function loadQuizQuestion(questionIndex) {
    if (questionIndex < 0 || questionIndex >= QuizState.questions.length) return;
    
    const question = QuizState.questions[questionIndex];
    QuizState.currentQuestionIndex = questionIndex;
    
    console.log('ðŸ” Loading question:', {
        index: questionIndex,
        questionId: question.question_id,
        questionText: question.question_text,
        questionType: question.question_type,
        options: question.options
    });
    
    // Set start time if this is the first question
    if (questionIndex === 0 && !QuizState.startTime) {
        QuizState.startTime = new Date();
        console.log(`â±ï¸ Quiz started at: ${QuizState.startTime.toISOString()}`);
    }
    
    // Update progress
    const currentQuestionNum = document.getElementById('currentQuestionNum');
    const totalQuestions = document.getElementById('totalQuestions');
    const quizQuestionText = document.getElementById('quizQuestionText');
    const quizOptionsGrid = document.getElementById('quizOptionsGrid');
    const quizProgressDots = document.getElementById('quizProgressDots');
    
    if (currentQuestionNum) {
        currentQuestionNum.textContent = questionIndex + 1;
    }
    
    if (totalQuestions) {
        totalQuestions.textContent = QuizState.questions.length;
    }
    
    if (quizQuestionText) {
        quizQuestionText.textContent = question.question_text;
    }
    
    if (quizOptionsGrid) {
        let optionsHTML = '';
        
        if (question.question_type === 'multiple_choice' || question.question_type === 'true_false') {
            // Debug the options structure
            console.log('ðŸ” Question options:', question.options);
            
            if (question.options && Array.isArray(question.options) && question.options.length > 0) {
                question.options.forEach((option, index) => {
                    const optionId = option.id || option.option_id || index;
                    const optionText = option.text || option.option_text || `Option ${String.fromCharCode(65 + index)}`;
                    
                    optionsHTML += `
                        <div class="quiz-option" data-option-id="${optionId}">
                            <div class="quiz-option-selector">
                                <i class="fas fa-circle"></i>
                            </div>
                            <div class="quiz-option-text">${optionText}</div>
                        </div>
                    `;
                });
            } else {
                // If options array is empty or not provided, create default options
                console.warn('âš ï¸ No options found for question, creating defaults');
                const defaultOptions = [
                    { id: 1, text: 'Option A' },
                    { id: 2, text: 'Option B' },
                    { id: 3, text: 'Option C' },
                    { id: 4, text: 'Option D' }
                ];
                
                defaultOptions.forEach(option => {
                    optionsHTML += `
                        <div class="quiz-option" data-option-id="${option.id}">
                            <div class="quiz-option-selector">
                                <i class="fas fa-circle"></i>
                            </div>
                            <div class="quiz-option-text">${option.text}</div>
                        </div>
                    `;
                });
            }
        } else {
            // For other question types (like fill in the blank)
            optionsHTML = `
                <div class="quiz-text-input-container">
                    <input type="text" 
                           class="quiz-text-input" 
                           id="quizTextAnswer" 
                           placeholder="Type your answer here...">
                    <button class="quiz-submit-answer-btn" id="submitTextAnswerBtn">
                        Submit Answer
                    </button>
                </div>
            `;
        }
        
        quizOptionsGrid.innerHTML = optionsHTML;
        
        // Add event listeners to options (for multiple choice)
        if (question.question_type === 'multiple_choice' || question.question_type === 'true_false') {
            document.querySelectorAll('.quiz-option').forEach(option => {
                option.addEventListener('click', function() {
                    // Remove selected class from all options
                    document.querySelectorAll('.quiz-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    
                    // Add selected class to clicked option
                    this.classList.add('selected');
                    
                    // Save answer
                    const questionId = question.question_id;
                    const optionId = this.getAttribute('data-option-id');
                    QuizState.userAnswers[questionId] = optionId;
                    
                    console.log('âœ… Selected answer:', {
                        questionId: questionId,
                        optionId: optionId
                    });
                    
                    // Update progress dots
                    updateProgressDots();
                    
                    // Auto-submit after selection
                    setTimeout(() => {
                        saveAnswerAndContinue(questionId, optionId);
                    }, 500);
                });
            });
        }
        
        // Add event listener for text answer submission
        const submitTextAnswerBtn = document.getElementById('submitTextAnswerBtn');
        if (submitTextAnswerBtn) {
            submitTextAnswerBtn.addEventListener('click', function() {
                const questionId = question.question_id;
                const answerText = document.getElementById('quizTextAnswer').value;
                
                if (answerText.trim()) {
                    QuizState.userAnswers[questionId] = answerText;
                    saveAnswerAndContinue(questionId, answerText);
                } else {
                    showNotification('Please enter an answer', 'error');
                }
            });
        }
    }
    
    // Update progress dots
    updateProgressDots();
    
    // Update timer
    updateQuizTimer();
}

// ============================================
// SAVE ANSWER AND CONTINUE - COMPLETE FIX
// ============================================
async function saveAnswerAndContinue(questionId, answer) {
    try {
        if (!QuizSystem.currentAttemptId) {
            console.error('âŒ No active quiz attempt');
            return;
        }
        
        // Check if already answered
        if (QuizSystem.submittedAnswers && QuizSystem.submittedAnswers[questionId]) {
            console.log(`â­ï¸ Question ${questionId} already answered, moving to next...`);
            
            if (QuizSystem.currentIndex < QuizSystem.questions.length - 1) {
                loadQuizSystemQuestion(QuizSystem.currentIndex + 1);
            } else {
                await submitQuizSystem();
            }
            return;
        }
        
        const currentQuestion = QuizSystem.questions[QuizSystem.currentIndex];
        if (!currentQuestion) {
            console.error('âŒ No current question found');
            return;
        }
        
        // Prepare answer data
        const answerData = {
            user_answer: answer.toString()
        };
        
        if (currentQuestion.question_type === 'multiple_choice' || 
            currentQuestion.question_type === 'true_false') {
            answerData.selected_option_id = parseInt(answer);
        }
        
        console.log('ðŸ“¤ Submitting answer:', {
            attemptId: QuizSystem.currentAttemptId,
            questionId: questionId,
            answerData: answerData
        });
        
        // âœ… Submit to server using the CORRECT URL
        const result = await submitQuizAnswer(QuizSystem.currentAttemptId, questionId, answerData);
        
        // Store in local answers
        QuizSystem.userAnswers[questionId] = answer;
        
        // Track if answer is correct
        if (result && result.is_correct !== undefined) {
            if (!QuizSystem.answerResults) QuizSystem.answerResults = {};
            if (!QuizSystem.stats) QuizSystem.stats = { correct: 0, wrong: 0 };
            
            QuizSystem.answerResults[questionId] = result.is_correct;
            
            if (result.is_correct) {
                QuizSystem.stats.correct++;
                console.log(`âœ… Correct answer for Q${questionId}`);
            } else {
                QuizSystem.stats.wrong++;
                console.log(`âŒ Wrong answer for Q${questionId}`);
            }
            
            console.log(`ðŸ“Š Stats - Correct: ${QuizSystem.stats.correct}, Wrong: ${QuizSystem.stats.wrong}`);
        }
        
        if (result) {
            console.log('âœ… Answer processed successfully');
            
            // Mark as submitted
            if (!QuizSystem.submittedAnswers) QuizSystem.submittedAnswers = {};
            QuizSystem.submittedAnswers[questionId] = true;
            
            // Update progress dots
            updateQuizSystemProgressDots();
            
            // Move to next question
            if (QuizSystem.currentIndex < QuizSystem.questions.length - 1) {
                setTimeout(() => {
                    loadQuizSystemQuestion(QuizSystem.currentIndex + 1);
                }, 300);
            } else {
                console.log('ðŸ“ Last question answered, ready to submit');
                const submitBtn = document.getElementById('submitQuizBtn');
                if (submitBtn) submitBtn.style.display = 'block';
            }
        } else {
            console.warn('âš ï¸ Server error but answer saved locally');
            
            QuizSystem.submittedAnswers[questionId] = true;
            updateQuizSystemProgressDots();
            
            if (QuizSystem.currentIndex < QuizSystem.questions.length - 1) {
                setTimeout(() => {
                    loadQuizSystemQuestion(QuizSystem.currentIndex + 1);
                }, 300);
            }
        }
        
    } catch (error) {
        console.error('âŒ Error in saveAnswerAndContinue:', error);
        QuizSystem.userAnswers[questionId] = answer;
        QuizSystem.submittedAnswers[questionId] = true;
        updateQuizSystemProgressDots();
        
        if (QuizSystem.currentIndex < QuizSystem.questions.length - 1) {
            setTimeout(() => {
                loadQuizSystemQuestion(QuizSystem.currentIndex + 1);
            }, 500);
        }
    }
}



// Update progress dots
function updateProgressDots() {
    const quizProgressDots = document.getElementById('quizProgressDots');
    if (!quizProgressDots) return;
    
    const dots = quizProgressDots.querySelectorAll('.progress-dot');
    dots.forEach((dot, index) => {
        const isCurrent = index === QuizState.currentQuestionIndex;
        const isAnswered = QuizState.userAnswers[QuizState.questions[index].question_id] !== undefined;
        
        dot.classList.remove('current', 'answered');
        if (isCurrent) dot.classList.add('current');
        if (isAnswered) dot.classList.add('answered');
    });
}

// Update quiz timer with database tracking
function updateQuizTimer() {
    const timerDisplay = document.getElementById('timerDisplay');
    if (!timerDisplay) return;
    
    // Start timer if not already started
    if (!QuizState.timerInterval) {
        // Set start time if not set
        if (!QuizState.startTime) {
            QuizState.startTime = new Date();
            console.log(`â±ï¸ Quiz started at: ${QuizState.startTime.toISOString()}`);
        }
        
        QuizState.timerInterval = setInterval(async () => {
            // Calculate elapsed seconds
            const now = new Date();
            QuizState.timer = Math.floor((now - QuizState.startTime) / 1000);
            
            // Format and display time
            const minutes = Math.floor(QuizState.timer / 60);
            const seconds = QuizState.timer % 60;
            timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Every 30 seconds, update the time in database
            if (QuizState.timer % 30 === 0 && QuizState.timer > 0) {
                await updateQuizTimeInDatabase(QuizState.timer);
            }
        }, 1000);
    }
}

// Stop quiz timer
function stopQuizTimer() {
    if (QuizState.timerInterval) {
        clearInterval(QuizState.timerInterval);
        QuizState.timerInterval = null;
    }
}

// Submit quiz
async function submitQuiz() {
    try {
        console.log('ðŸ“ Submitting quiz...');
        
        // âœ… IMPORTANT: Check kung may attempt_id
        if (!QuizState.currentAttemptId) {
            console.error('âŒ No attempt_id found!');
            showNotification('Quiz session expired. Please start again.', 'error');
            return;
        }
        
        // Save final answer
        const currentQuestion = QuizState.questions[QuizState.currentQuestionIndex];
        if (currentQuestion) {
            const selectedOption = document.querySelector('.quiz-option.selected');
            if (selectedOption) {
                const questionId = currentQuestion.question_id;
                const optionId = selectedOption.getAttribute('data-option-id') || selectedOption.getAttribute('data-option-value');
                QuizState.userAnswers[questionId] = optionId;
                console.log(`âœ… Saved final answer for Q${questionId}:`, optionId);
            }
        }
        
        // Stop timer
        stopQuizTimer();
        
        // Get final time
        const finalTimeSpent = QuizState.timer || 0;
        console.log(`â±ï¸ Final time spent: ${finalTimeSpent} seconds`);
        
        // Show loading
        showNotification('Saving your answers...', 'info');
        
        // âœ… Submit all answers one by one
        let answersSubmitted = 0;
        for (const [questionId, answer] of Object.entries(QuizState.userAnswers)) {
            const answerData = {
                user_answer: answer.toString()
            };
            
            // For multiple choice, send selected option ID
            if (typeof answer === 'string' && answer.match(/^\d+$/)) {
                answerData.selected_option_id = parseInt(answer);
            }
            
            console.log(`ðŸ“¤ Submitting Q${questionId}:`, answerData);
            
            const result = await submitQuizAnswer(
                QuizState.currentAttemptId, 
                parseInt(questionId), 
                answerData
            );
            
            if (result) {
                answersSubmitted++;
                console.log(`âœ… Q${questionId} saved`);
            }
        }
        
        console.log(`ðŸ“Š Submitted ${answersSubmitted}/${Object.keys(QuizState.userAnswers).length} answers`);
        
        // âœ… Complete quiz attempt
        console.log('ðŸ Completing quiz attempt...');
        const results = await completeQuizAttempt(QuizState.currentAttemptId, finalTimeSpent);
        
        if (results && results.success) {
            console.log('âœ… Quiz completed! Results:', results);
            
            // Store results
            QuizState.quizResults = results.results || results;
            
            // âœ… SHOW RESULTS
            showQuizResults(QuizState.quizResults);
            
            // Log activity
            await logUserActivity('quiz_completed', QuizState.currentQuiz, {
                score: QuizState.quizResults.score,
                attempt_id: QuizState.currentAttemptId
            });
            
            showNotification(`ðŸŽ‰ Quiz completed! Score: ${QuizState.quizResults.score}%`, 'success');
            
        } else {
            throw new Error(results?.message || 'Failed to complete quiz');
        }
        
    } catch (error) {
        console.error('âŒ Error submitting quiz:', error);
        showNotification('Failed to submit quiz: ' + error.message, 'error');
        
        // Try to get results anyway
        try {
            const fallbackResults = await getQuizResults(QuizState.currentAttemptId);
            if (fallbackResults) {
                showQuizResults(fallbackResults);
            }
        } catch (e) {
            console.error('Fallback also failed:', e);
        }
    }
}

// Show quiz results - IMPROVED VERSION
function showQuizResultsModal(results, timeSpent) {
    const optionsGrid = document.getElementById('quizOptionsGridModal');
    if (!optionsGrid) return;
    
    // âœ… FIX 1: Mas magandang data handling
    const totalQuestions = results.total_questions || 
                          results.question_count || 
                          QuizState.questions?.length || 
                          0;
    
    const correctAnswers = results.correct_answers || 
                          results.correct_count || 
                          0;
    
    // âœ… FIX 2: Mas accurate na score calculation
    let score = results.score;
    if (!score && totalQuestions > 0) {
        score = Math.round((correctAnswers / totalQuestions) * 100);
    }
    
    const minutes = Math.floor(timeSpent / 60);
    const seconds = timeSpent % 60;
    
    // âœ… FIX 3: Points - check kung galing sa server
    const pointsEarned = results.points_earned || 
                        results.points || 
                        correctAnswers * 10;
    
    // âœ… FIX 4: Color based sa score
    const scoreColor = score >= 90 ? '#27ae60' : 
                      score >= 75 ? '#f39c12' : 
                      score >= 50 ? '#e67e22' : '#e74c3c';
    
    const scoreIcon = score >= 90 ? 'fa-trophy' : 
                     score >= 75 ? 'fa-star' : 
                     score >= 50 ? 'fa-smile' : 'fa-meh';
    
    optionsGrid.innerHTML = `
        <div style="text-align: center; padding: 30px;">
            <div style="font-size: 70px; color: ${scoreColor}; margin-bottom: 20px;">
                <i class="fas ${scoreIcon}"></i>
            </div>
            
            <h2 style="color: #2c3e50; margin-bottom: 15px;">
                ${score >= 75 ? 'ðŸŽ‰ Congratulations!' : 'Quiz Completed!'}
            </h2>
            
            <div style="font-size: 48px; font-weight: bold; color: ${scoreColor}; margin-bottom: 20px;">
                ${score}%
            </div>
            
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 25px;">
                <table style="width: 100%;">
                    <tr>
                        <td style="padding: 8px 0;"><strong>Correct Answers:</strong></td>
                        <td style="padding: 8px 0; text-align: right; color: #27ae60; font-weight: bold;">
                            ${correctAnswers}/${totalQuestions}
                        </td>
                    </tr>
                    <tr>
                        <td style="padding: 8px 0;"><strong>Time Taken:</strong></td>
                        <td style="padding: 8px 0; text-align: right;">
                            ${minutes}:${seconds.toString().padStart(2,'0')}
                        </td>
                    </tr>
                    <tr>
                        <td style="padding: 8px 0;"><strong>Points Earned:</strong></td>
                        <td style="padding: 8px 0; text-align: right; color: #7a0000; font-weight: bold;">
                            +${pointsEarned}
                        </td>
                    </tr>
                    ${results.attempt_id ? `
                    <tr>
                        <td style="padding: 8px 0;"><strong>Attempt ID:</strong></td>
                        <td style="padding: 8px 0; text-align: right; color: #7f8c8d;">
                            #${results.attempt_id}
                        </td>
                    </tr>
                    ` : ''}
                </table>
            </div>
            
            <div style="margin-top: 20px; color: #7f8c8d; font-size: 14px;">
                <i class="fas fa-database"></i> Saved to database
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                <button class="btn-secondary" onclick="closeQuizModal()">
                    <i class="fas fa-times"></i> Close
                </button>
                <button class="btn-primary" onclick="location.reload()">
                    <i class="fas fa-redo"></i> New Quiz
                </button>
                <button class="btn-info" onclick="viewQuizDetails(${results.attempt_id})" 
                        style="background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                    <i class="fas fa-chart-bar"></i> Details
                </button>
            </div>
        </div>
    `;
    
    // Hide progress dots
    const dots = document.getElementById('quizProgressDotsModal');
    if (dots) dots.style.display = 'none';
    
    // Hide navigation buttons
    const navButtons = document.querySelector('.quiz-navigation');
    if (navButtons) navButtons.style.display = 'none';
}


// View detailed quiz results
async function viewQuizDetails(attemptId) {
    try {
        const token = localStorage.getItem('authToken');
        const response = await fetch(`/api/quiz/attempt/${attemptId}/details`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        const data = await response.json();
        
        if (data.success) {
            console.log('ðŸ“Š Quiz Details:', data.details);
            showDetailedResults(data.details);
        }
    } catch (error) {
        console.error('Error fetching details:', error);
    }
}

function showDetailedResults(details) {
    const modalHTML = `
        <div class="detailed-results-modal">
            <h3>Quiz Details</h3>
            <pre>${JSON.stringify(details, null, 2)}</pre>
        </div>
    `;
    showModal(modalHTML);
}


// Reset quiz interface
function resetQuizInterface() {
    const quizInterface = document.getElementById('quizInterface');
    const quizResultsContainer = document.getElementById('quizResultsContainer');
    const quizCategoriesGrid = document.getElementById('quizCategoriesGrid');
    const badgesContainer = document.getElementById('badgesContainer');
    const leaderboardContainer = document.getElementById('leaderboardContainer');
    
    if (quizInterface) quizInterface.classList.add('hidden');
    if (quizResultsContainer) quizResultsContainer.classList.add('hidden');
    if (quizCategoriesGrid) quizCategoriesGrid.classList.remove('hidden');
    if (badgesContainer) badgesContainer.classList.remove('hidden');
    if (leaderboardContainer) leaderboardContainer.classList.remove('hidden');
    
    // Reset quiz state
    QuizState.currentQuiz = null;
    QuizState.currentAttemptId = null;
    QuizState.questions = [];
    QuizState.currentQuestionIndex = 0;
    QuizState.userAnswers = {};
    QuizState.timer = 0;
    QuizState.startTime = null; // Reset start time
    QuizState.isQuizActive = false;
    QuizState.quizResults = null;
    
    // Stop timer
    stopQuizTimer();
}

// Review quiz
async function reviewQuiz(quizId, attemptId = null) {
    try {
        let results;
        
        if (attemptId) {
            results = await getQuizResults(attemptId);
        } else {
            // Get latest attempt for this quiz
            const attempts = await fetchUserQuizAttempts();
            const quizAttempts = attempts.filter(a => a.quiz_id == quizId && a.completion_status === 'completed');
            
            if (quizAttempts.length === 0) {
                showNotification('No completed attempts found for this quiz', 'error');
                return;
            }
            
            const latestAttempt = quizAttempts.sort((a, b) => new Date(b.end_time) - new Date(a.end_time))[0];
            results = await getQuizResults(latestAttempt.attempt_id);
        }
        
        if (!results) {
            showNotification('Failed to load quiz review', 'error');
            return;
        }
        
        showQuizReview(results);
        
    } catch (error) {
        console.error('Error reviewing quiz:', error);
        showNotification('Failed to load quiz review', 'error');
    }
}

// Show quiz review
function showQuizReview(results) {
    const modalHTML = `
        <div class="quiz-review-modal">
            <div class="review-header">
                <h3><i class="fas fa-chart-bar"></i> Quiz Review</h3>
                <div class="review-score">
                    Score: <span class="score-value">${Math.round(results.score)}%</span>
                </div>
            </div>
            
            <div class="review-body">
    `;
    
    results.questions.forEach((question, index) => {
        const userAnswer = question.user_answer;
        const isCorrect = question.is_correct;
        
        modalHTML += `
            <div class="review-question ${isCorrect ? 'correct' : 'incorrect'}">
                <div class="question-header">
                    <h4>Question ${index + 1}</h4>
                    <span class="result-badge ${isCorrect ? 'correct-badge' : 'incorrect-badge'}">
                        ${isCorrect ? 'Correct' : 'Incorrect'}
                    </span>
                </div>
                
                <div class="question-text">
                    <p>${question.question_text}</p>
                </div>
                
                <div class="answer-review">
                    <div class="user-answer">
                        <strong>Your Answer:</strong> ${userAnswer || 'No answer provided'}
                    </div>
                    
                    ${!isCorrect && question.correct_answer ? `
                        <div class="correct-answer">
                            <strong>Correct Answer:</strong> ${question.correct_answer}
                        </div>
                    ` : ''}
                    
                    ${question.explanation ? `
                        <div class="explanation">
                            <strong>Explanation:</strong> ${question.explanation}
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    });
    
    modalHTML += `
            </div>
            
            <div class="review-footer">
                <button class="btn-primary" id="closeReviewBtn">
                    <i class="fas fa-times"></i> Close Review
                </button>
            </div>
        </div>
    `;
    
    showModal(modalHTML);
    
    document.getElementById('closeReviewBtn').addEventListener('click', () => {
        const modal = document.querySelector('.modal-overlay');
        if (modal) modal.remove();
    });
}

// ============================================
// FEEDBACK FUNCTIONS
// ============================================

// Initialize feedback functionality
function initFeedback() {
    console.log('ðŸ’¬ Initializing feedback system...');
    
    // Setup rating stars
    setupRatingStars();
    
    // Setup feedback form submission
    setupFeedbackForm();
    
    console.log('âœ… Feedback system initialized');
}

// Setup rating stars
function setupRatingStars() {
    const stars = document.querySelectorAll('.star');
    const ratingValue = document.getElementById('ratingValue');
    
    if (!stars.length || !ratingValue) return;
    
    stars.forEach(star => {
        star.addEventListener('click', function() {
            const rating = parseInt(this.getAttribute('onclick').match(/rate\((\d+)\)/)[1]);
            
            // Update stars display
            stars.forEach((s, index) => {
                if (index < rating) {
                    s.classList.add('active');
                    s.innerHTML = 'â˜…';
                } else {
                    s.classList.remove('active');
                    s.innerHTML = 'â˜†';
                }
            });
            
            // Update hidden input
            ratingValue.value = rating;
        });
        
        star.addEventListener('mouseover', function() {
            const rating = parseInt(this.getAttribute('onclick').match(/rate\((\d+)\)/)[1]);
            
            stars.forEach((s, index) => {
                if (index < rating) {
                    s.classList.add('hover');
                } else {
                    s.classList.remove('hover');
                }
            });
        });
        
        star.addEventListener('mouseout', function() {
            stars.forEach(s => s.classList.remove('hover'));
        });
    });
}


// ===== FEEDBACK DASHBOARD FUNCTIONS =====

// ===== Helper: Show message when no feedback =====
function showNoFeedbackMessage(message) {
    const tableBody = document.getElementById('feedbackTableBody');
    if (!tableBody) return;
    
    feedbackData = [];
    
    tableBody.innerHTML = `
        <tr>
            <td colspan="8" class="text-center py-5">
                <div style="text-align: center; padding: 40px;">
                    <i class="fas fa-comment-slash" style="font-size: 4rem; color: #ccc; margin-bottom: 20px;"></i>
                    <h4 style="color: #666; margin-bottom: 10px;">${message}</h4>
                    <p style="color: #999; margin-bottom: 20px;">Feedback from users will appear here.</p>
                    <button class="btn btn-primary" onclick="loadFeedbackData()" style="background: #7a0000;">
                        <i class="fas fa-sync-alt"></i> Retry
                    </button>
                </div>
            </td>
        </tr>
    `;
    
    // Reset stats to zero
    const statsElements = ['totalRatings', 'totalComplaints', 'totalSuggestions', 'resolvedFeedbacks'];
    statsElements.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.textContent = '0';
    });
}
// Add this function FIRST


// Then your loadFeedbackData function
async function loadFeedbackData() {
    console.log("ðŸ“¥ Loading REAL feedback from MySQL database...");
    
    const tableBody = document.getElementById('feedbackTableBody');
    if (tableBody) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center py-5">
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-spinner fa-pulse fa-3x mb-3" style="color: #7a0000;"></i>
                        <p class="text-muted">Loading feedback from database...</p>
                    </div>
                </td>
            </tr>
        `;
    }
    
    try {
        const token = localStorage.getItem('admin_token') || localStorage.getItem('authToken');
        
        const response = await fetch('/api/admin/feedback', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success && result.feedback) {
            feedbackData = result.feedback.map(f => ({
                id: f.id || f.feedback_id,
                user: f.user_name || f.user || 'Anonymous',
                userAvatar: getInitials(f.user_name || f.user || 'User'),
                type: f.type || 'feedback',
                subject: f.subject || (f.message ? f.message.substring(0, 30) + '...' : 'General'),
                message: f.message || '',
                rating: f.rating || 0,
                priority: f.priority || 'medium',
                status: f.status || 'new',
                date: f.date ? new Date(f.date).toISOString().split('T')[0] : new Date().toISOString().split('T')[0],
                response: f.response || null,
                responseDate: f.response_date ? new Date(f.response_date).toISOString().split('T')[0] : null,
                responseBy: f.responded_by ? 'Admin' : null
            }));
            
            console.log(`âœ… Loaded ${feedbackData.length} feedback entries`);
            
            if (feedbackData.length === 0) {
                showNoFeedbackMessage('No feedback found in database'); // â† Calls the fixed function
                return;
            }
            
            updateFeedbackTable();
            updateFeedbackStats();
            updateFeedbackChartsWithRealData();
            
        } else {
            showNoFeedbackMessage('No feedback found');
        }
        
    } catch (error) {
        console.error('âŒ Error loading feedback:', error);
        showNoFeedbackMessage('Cannot connect to database');
    }
}

// ===== Helper: Update feedback charts with real data =====
function updateFeedbackChartsWithRealData() {
    if (!feedbackData) return;
    
    console.log("ðŸ“Š Updating feedback charts with real data...");
    
    // Update distribution chart
    if (feedbackCharts.distributionChart) {
        const ratings = feedbackData.filter(f => f.type === 'rating').length;
        const complaints = feedbackData.filter(f => f.type === 'complaint').length;
        const suggestions = feedbackData.filter(f => f.type === 'suggestion').length;
        const questions = feedbackData.filter(f => f.type === 'question').length;
        
        if (feedbackData.length > 0) {
            feedbackCharts.distributionChart.data.datasets[0].data = [
                ratings, complaints, suggestions, questions
            ];
        }
        
        feedbackCharts.distributionChart.update();
    }
    
    // Update trend chart
    if (feedbackCharts.trendChart) {
        const weeklyData = getWeeklyFeedbackData();
        
        feedbackCharts.trendChart.data.datasets[0].data = weeklyData.ratings;
        feedbackCharts.trendChart.data.datasets[1].data = weeklyData.complaints;
        feedbackCharts.trendChart.data.datasets[2].data = weeklyData.suggestions;
        feedbackCharts.trendChart.update();
    }
}

// ===== Helper: Get weekly feedback data =====
function getWeeklyFeedbackData() {
    const labels = ['Week 1', 'Week 2', 'Week 3', 'Week 4'];
    
    if (!feedbackData || feedbackData.length === 0) {
        return {
            labels: labels,
            ratings: [0, 0, 0, 0],
            complaints: [0, 0, 0, 0],
            suggestions: [0, 0, 0, 0]
        };
    }
    
    const fourWeeksAgo = new Date();
    fourWeeksAgo.setDate(fourWeeksAgo.getDate() - 28);
    
    const recentFeedback = feedbackData.filter(f => {
        const feedbackDate = new Date(f.date || f.created_at || Date.now());
        return feedbackDate >= fourWeeksAgo;
    });
    
    const weeklyRatings = [0, 0, 0, 0];
    const weeklyComplaints = [0, 0, 0, 0];
    const weeklySuggestions = [0, 0, 0, 0];
    
    recentFeedback.forEach(f => {
        const feedbackDate = new Date(f.date || f.created_at || Date.now());
        const daysAgo = Math.floor((new Date() - feedbackDate) / (1000 * 60 * 60 * 24));
        let weekIndex = 3;
        
        if (daysAgo <= 7) weekIndex = 0;
        else if (daysAgo <= 14) weekIndex = 1;
        else if (daysAgo <= 21) weekIndex = 2;
        else weekIndex = 3;
        
        if (f.type === 'rating') weeklyRatings[weekIndex]++;
        else if (f.type === 'complaint') weeklyComplaints[weekIndex]++;
        else if (f.type === 'suggestion') weeklySuggestions[weekIndex]++;
    });
    
    return {
        labels: labels,
        ratings: weeklyRatings,
        complaints: weeklyComplaints,
        suggestions: weeklySuggestions
    };
}


// ============================================
// ðŸš¨ GLOBAL FORM PREVENTION
// ============================================
document.addEventListener('submit', function(e) {
    // Check if it's the feedback form
    if (e.target.id === 'feedbackForm' || e.target.closest('#feedbackForm')) {
        e.preventDefault();
        e.stopPropagation();
        console.log('ðŸš« Global form submission prevented');
        return false;
    }
}, true);




// ============================================
// âœ… FIXED: Save feedback locally
// ============================================
function saveFeedbackLocally(feedbackData) {
    try {
        // Get existing feedback from localStorage
        let existingFeedback = JSON.parse(localStorage.getItem('local_feedback') || '[]');
        
        // Add new feedback with timestamp
        const newFeedback = {
            ...feedbackData,
            id: Date.now(),
            created_at: new Date().toISOString(),
            status: 'pending'
        };
        
        existingFeedback.push(newFeedback);
        
        // Keep only last 50 items
        if (existingFeedback.length > 50) {
            existingFeedback = existingFeedback.slice(-50);
        }
        
        // Save back to localStorage
        localStorage.setItem('local_feedback', JSON.stringify(existingFeedback));
        
        console.log('ðŸ’¾ Feedback saved locally, total:', existingFeedback.length);
        
        // Also update the feedback history display
        displayLocalFeedbackHistory();
        
    } catch (e) {
        console.error('Failed to save feedback locally:', e);
    }
}



// ============================================
// DISPLAY LOCAL FEEDBACK HISTORY
// ============================================
function displayLocalFeedbackHistory() {
    const historyContainer = document.getElementById('feedbackHistory');
    if (!historyContainer) return;
    
    try {
        const localFeedback = JSON.parse(localStorage.getItem('local_feedback') || '[]');
        
        if (localFeedback.length === 0) {
            // Try to load from server first
            loadFeedbackHistory(10);
            return;
        }
        
        let html = '<div class="feedback-history-list">';
        
        // Sort by date (newest first)
        localFeedback.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
        
        localFeedback.slice(0, 10).forEach(item => {
            const date = new Date(item.created_at || Date.now());
            const formattedDate = date.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            const ratingStars = 'â˜…'.repeat(item.rating || 0) + 'â˜†'.repeat(5 - (item.rating || 0));
            
            html += `
                <div class="feedback-history-item status-pending">
                    <div class="feedback-history-header">
                        <div>
                            <span class="feedback-type-badge">${item.feedback_type || 'feedback'}</span>
                            <span class="local-badge">(Saved locally)</span>
                        </div>
                        <span class="feedback-date">${formattedDate}</span>
                    </div>
                    
                    <div class="feedback-history-body">
                        <p class="feedback-message">${escapeHtml(item.feedback_message || '')}</p>
                        
                        ${item.rating > 0 ? `
                            <div class="feedback-rating-display">
                                <span class="rating-stars">${ratingStars}</span>
                                <span class="rating-value">${item.rating}/5</span>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        historyContainer.innerHTML = html;
        
    } catch (e) {
        console.error('Error displaying local feedback:', e);
    }
}


// Fetch user feedback (for display in admin or user profile)
async function fetchUserFeedback(limit = 10, page = 1) {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) {
            console.warn('No auth token available');
            return [];
        }
        
        console.log('ðŸ“‹ Fetching user feedback...');
        
        const response = await fetch(`/api/feedback/user?limit=${limit}&page=${page}`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`Failed to fetch feedback: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success && data.feedback) {
            console.log(`âœ… Fetched ${data.feedback.length} feedback items`);
            return data.feedback;
        } else {
            throw new Error(data.message || 'No feedback returned');
        }
    } catch (error) {
        console.error('Error fetching feedback:', error);
        return [];
    }
}

// Fetch feedback statistics (for admin dashboard)
async function fetchFeedbackStats() {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) {
            console.warn('No auth token available');
            return null;
        }
        
        console.log('ðŸ“Š Fetching feedback statistics...');
        
        const response = await fetch(`/api/feedback/stats`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`Failed to fetch feedback stats: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success && data.stats) {
            console.log('âœ… Feedback statistics loaded');
            return data.stats;
        } else {
            throw new Error(data.message || 'No feedback stats returned');
        }
    } catch (error) {
        console.error('Error fetching feedback stats:', error);
        return null;
    }
}

// Update feedback status (admin function)
async function updateFeedbackStatus(feedbackId, status, adminNotes = null) {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) {
            console.warn('No auth token available');
            return false;
        }
        
        console.log(`ðŸ”„ Updating feedback ${feedbackId} status to ${status}...`);
        
        const response = await fetch(`/api/feedback/${feedbackId}/update-status`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                status: status,
                admin_notes: adminNotes
            })
        });
        
        if (!response.ok) {
            throw new Error(`Failed to update feedback status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            console.log('âœ… Feedback status updated');
            return true;
        } else {
            throw new Error(data.message || 'Failed to update feedback status');
        }
    } catch (error) {
        console.error('Error updating feedback status:', error);
        return false;
    }
}

// Initialize feedback dashboard
function initFeedbackDashboard() {
    console.log('ðŸ’¬ Initializing feedback dashboard...');
    
    try {
        // Setup feedback form
        initFeedback();
        
        // If user is admin, load feedback management
        if (AppState.currentUser?.role === 'admin') {
            loadFeedbackManagement();
        }
        
        console.log('âœ… Feedback dashboard initialized');
    } catch (error) {
        console.error('Error initializing feedback dashboard:', error);
        showNotification('Failed to initialize feedback dashboard', 'error');
    }
}

// Load feedback management (admin only)
async function loadFeedbackManagement() {
    try {
        const feedbackContainer = document.getElementById('feedbackManagementContainer');
        if (!feedbackContainer) return;
        
        // Check if user is admin
        if (AppState.currentUser?.role !== 'admin') {
            feedbackContainer.innerHTML = `
                <div class="access-denied">
                    <i class="fas fa-lock"></i>
                    <h3>Admin Access Required</h3>
                    <p>Only administrators can access feedback management.</p>
                </div>
            `;
            return;
        }
        
        // Load feedback stats and list
        const [stats, feedbackList] = await Promise.all([
            fetchFeedbackStats(),
            fetchAllFeedback(20, 1)
        ]);
        
        // Update UI with feedback management
        updateFeedbackManagementUI(stats, feedbackList);
        
    } catch (error) {
        console.error('Error loading feedback management:', error);
        const feedbackContainer = document.getElementById('feedbackManagementContainer');
        if (feedbackContainer) {
            feedbackContainer.innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>Failed to load feedback management</h3>
                    <p>Please try again later</p>
                </div>
            `;
        }
    }
}
// ============================================
// FEEDBACK MANAGEMENT FUNCTIONS
// ============================================

// Fetch feedback statistics from server
async function fetchFeedbackStats() {
    try {
        const token = localStorage.getItem('admin_token') || localStorage.getItem('authToken');
        
        const response = await fetch('/api/feedback/stats', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        return result.stats || {};
        
    } catch (error) {
        console.error('Error fetching feedback stats:', error);
        return {
            total: 0,
            by_status: { new: 0, reviewed: 0, resolved: 0 },
            average_rating: 0,
            trends: []
        };
    }
}

// Fetch all feedback with pagination
async function fetchAllFeedback(limit = 20, page = 1, status = 'all') {
    try {
        const token = localStorage.getItem('admin_token') || localStorage.getItem('authToken');
        
        let url = `/api/feedback/all?limit=${limit}&page=${page}`;
        if (status !== 'all') {
            url += `&status=${status}`;
        }
        
        const response = await fetch(url, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        return {
            feedback: result.feedback || [],
            pagination: result.pagination || { total: 0, page: 1, limit: 20, pages: 1 }
        };
        
    } catch (error) {
        console.error('Error fetching feedback:', error);
        return { feedback: [], pagination: { total: 0, page: 1, limit: 20, pages: 1 } };
    }
}

// Update feedback management UI
function updateFeedbackManagementUI(stats, feedbackData) {
    const container = document.getElementById('feedbackManagementContainer');
    if (!container) return;
    
    // Update stats cards
    updateFeedbackStatsUI(stats);
    
    // Build feedback list HTML
    let feedbackHTML = `
        <div class="feedback-management">
            <div class="feedback-header">
                <h2><i class="fas fa-comments"></i> Feedback Management</h2>
                <div class="feedback-filters">
                    <select id="feedbackStatusFilter" onchange="filterFeedbackByStatus()">
                        <option value="all">All Status</option>
                        <option value="new">New</option>
                        <option value="reviewed">Reviewed</option>
                        <option value="in_progress">In Progress</option>
                        <option value="resolved">Resolved</option>
                        <option value="closed">Closed</option>
                    </select>
                    <input type="text" id="searchFeedback" placeholder="Search feedback..." onkeyup="searchFeedback()">
                </div>
            </div>
            
            <div class="feedback-stats-grid">
                <div class="stat-card total">
                    <div class="stat-icon"><i class="fas fa-envelope"></i></div>
                    <div class="stat-content">
                        <span class="stat-value">${stats.total || 0}</span>
                        <span class="stat-label">Total Feedback</span>
                    </div>
                </div>
                <div class="stat-card new">
                    <div class="stat-icon"><i class="fas fa-clock"></i></div>
                    <div class="stat-content">
                        <span class="stat-value">${stats.by_status?.new || 0}</span>
                        <span class="stat-label">New</span>
                    </div>
                </div>
                <div class="stat-card resolved">
                    <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                    <div class="stat-content">
                        <span class="stat-value">${stats.by_status?.resolved || 0}</span>
                        <span class="stat-label">Resolved</span>
                    </div>
                </div>
                <div class="stat-card rating">
                    <div class="stat-icon"><i class="fas fa-star"></i></div>
                    <div class="stat-content">
                        <span class="stat-value">${stats.average_rating || 0}</span>
                        <span class="stat-label">Avg Rating</span>
                    </div>
                </div>
            </div>
            
            <div class="feedback-list">
                <table class="feedback-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>User</th>
                            <th>Type</th>
                            <th>Message</th>
                            <th>Rating</th>
                            <th>Status</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="feedbackTableBody">
    `;
    
    if (feedbackData.feedback.length === 0) {
        feedbackHTML += `
            <tr>
                <td colspan="8" class="text-center py-4">
                    <i class="fas fa-inbox fa-3x mb-3" style="color: #ccc;"></i>
                    <p>No feedback found</p>
                </td>
            </tr>
        `;
    } else {
        feedbackData.feedback.forEach(f => {
            const statusClass = `status-${f.status || 'new'}`;
            const typeClass = `type-${f.type || 'other'}`;
            const date = new Date(f.created_at).toLocaleDateString();
            
            feedbackHTML += `
                <tr>
                    <td>#${f.id}</td>
                    <td>${f.full_name || f.username || 'Anonymous'}</td>
                    <td><span class="badge ${typeClass}">${f.type || 'other'}</span></td>
                    <td>${f.message ? f.message.substring(0, 50) + '...' : 'No message'}</td>
                    <td>${f.rating ? 'â˜…'.repeat(f.rating) + 'â˜†'.repeat(5-f.rating) : '-'}</td>
                    <td><span class="badge ${statusClass}">${f.status || 'new'}</span></td>
                    <td>${date}</td>
                    <td>
                        <button class="btn-icon" onclick="viewFeedbackDetail(${f.id})" title="View">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn-icon" onclick="editFeedback(${f.id})" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-icon delete" onclick="deleteFeedback(${f.id})" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        });
    }
    
    feedbackHTML += `
                    </tbody>
                </table>
            </div>
            
            <div class="pagination">
                <button class="pagination-btn" onclick="changeFeedbackPage('prev')" ${feedbackData.pagination.page <= 1 ? 'disabled' : ''}>
                    <i class="fas fa-chevron-left"></i>
                </button>
                <span>Page ${feedbackData.pagination.page} of ${feedbackData.pagination.pages}</span>
                <button class="pagination-btn" onclick="changeFeedbackPage('next')" ${feedbackData.pagination.page >= feedbackData.pagination.pages ? 'disabled' : ''}>
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    `;
    
    container.innerHTML = feedbackHTML;
}

// Update feedback stats UI
function updateFeedbackStatsUI(stats) {
    // Update any stats elements if they exist outside the main container
    const totalEl = document.getElementById('totalFeedback');
    if (totalEl) totalEl.textContent = stats.total || 0;
    
    const newEl = document.getElementById('newFeedback');
    if (newEl) newEl.textContent = stats.by_status?.new || 0;
    
    const resolvedEl = document.getElementById('resolvedFeedback');
    if (resolvedEl) resolvedEl.textContent = stats.by_status?.resolved || 0;
    
    const ratingEl = document.getElementById('avgRating');
    if (ratingEl) ratingEl.textContent = stats.average_rating || 0;
}

// Filter feedback by status
async function filterFeedbackByStatus() {
    const status = document.getElementById('feedbackStatusFilter').value;
    const page = 1;
    const feedbackData = await fetchAllFeedback(20, page, status);
    updateFeedbackManagementUI(await fetchFeedbackStats(), feedbackData);
}

// Search feedback
async function searchFeedback() {
    const searchTerm = document.getElementById('searchFeedback').value.toLowerCase();
    const tableBody = document.getElementById('feedbackTableBody');
    if (!tableBody) return;
    
    const rows = tableBody.getElementsByTagName('tr');
    
    for (let row of rows) {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
    }
}

// Change feedback page
let currentFeedbackPage = 1;
let currentFeedbackStatus = 'all';

async function changeFeedbackPage(direction) {
    if (direction === 'prev' && currentFeedbackPage > 1) {
        currentFeedbackPage--;
    } else if (direction === 'next') {
        currentFeedbackPage++;
    } else {
        return;
    }
    
    const feedbackData = await fetchAllFeedback(20, currentFeedbackPage, currentFeedbackStatus);
    updateFeedbackManagementUI(await fetchFeedbackStats(), feedbackData);
}

// View feedback detail
async function viewFeedbackDetail(feedbackId) {
    try {
        const token = localStorage.getItem('admin_token') || localStorage.getItem('authToken');
        
        const response = await fetch(`/api/feedback/${feedbackId}`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        const feedback = result.feedback;
        
        // Show modal with feedback details
        showFeedbackDetailModal(feedback);
        
    } catch (error) {
        console.error('Error viewing feedback:', error);
        showNotification('error', 'Error', 'Failed to load feedback details');
    }
}

// Show feedback detail modal
function showFeedbackDetailModal(feedback) {
    // Create modal if it doesn't exist
    let modal = document.getElementById('feedbackDetailModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'feedbackDetailModal';
        modal.className = 'modal';
        document.body.appendChild(modal);
    }
    
    const date = new Date(feedback.created_at).toLocaleString();
    const statusClass = `status-${feedback.status || 'new'}`;
    
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-comment"></i> Feedback #${feedback.id}</h3>
                <button class="modal-close" onclick="closeFeedbackDetailModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="feedback-detail">
                    <div class="detail-row">
                        <label>User:</label>
                        <span>${feedback.full_name || feedback.username || 'Anonymous'} (${feedback.email || 'No email'})</span>
                    </div>
                    <div class="detail-row">
                        <label>Type:</label>
                        <span class="badge type-${feedback.type}">${feedback.type}</span>
                    </div>
                    <div class="detail-row">
                        <label>Status:</label>
                        <span class="badge ${statusClass}">${feedback.status}</span>
                    </div>
                    <div class="detail-row">
                        <label>Rating:</label>
                        <span>${feedback.rating ? 'â˜…'.repeat(feedback.rating) + 'â˜†'.repeat(5-feedback.rating) : 'Not rated'}</span>
                    </div>
                    <div class="detail-row">
                        <label>Date:</label>
                        <span>${date}</span>
                    </div>
                    <div class="detail-row">
                        <label>Message:</label>
                        <div class="message-box">${feedback.message || 'No message'}</div>
                    </div>
                    ${feedback.admin_notes ? `
                        <div class="detail-row">
                            <label>Admin Notes:</label>
                            <div class="notes-box">${feedback.admin_notes}</div>
                        </div>
                    ` : ''}
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeFeedbackDetailModal()">Close</button>
                <button class="btn btn-primary" onclick="editFeedback(${feedback.id})">Edit</button>
                <button class="btn btn-danger" onclick="deleteFeedback(${feedback.id})">Delete</button>
            </div>
        </div>
    `;
    
    modal.style.display = 'flex';
}

// Close feedback detail modal
function closeFeedbackDetailModal() {
    const modal = document.getElementById('feedbackDetailModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

// Edit feedback
async function editFeedback(feedbackId) {
    // Close detail modal if open
    closeFeedbackDetailModal();
    
    try {
        const token = localStorage.getItem('admin_token') || localStorage.getItem('authToken');
        
        const response = await fetch(`/api/feedback/${feedbackId}`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        const result = await response.json();
        const feedback = result.feedback;
        
        // Show edit modal
        showFeedbackEditModal(feedback);
        
    } catch (error) {
        console.error('Error loading feedback for edit:', error);
        showNotification('error', 'Error', 'Failed to load feedback for editing');
    }
}

// Show feedback edit modal
function showFeedbackEditModal(feedback) {
    let modal = document.getElementById('feedbackEditModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'feedbackEditModal';
        modal.className = 'modal';
        document.body.appendChild(modal);
    }
    
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-edit"></i> Edit Feedback #${feedback.id}</h3>
                <button class="modal-close" onclick="closeFeedbackEditModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="feedbackEditForm">
                    <input type="hidden" id="editFeedbackId" value="${feedback.id}">
                    
                    <div class="form-group">
                        <label>Status</label>
                        <select id="editFeedbackStatus" class="form-control">
                            <option value="new" ${feedback.status === 'new' ? 'selected' : ''}>New</option>
                            <option value="reviewed" ${feedback.status === 'reviewed' ? 'selected' : ''}>Reviewed</option>
                            <option value="in_progress" ${feedback.status === 'in_progress' ? 'selected' : ''}>In Progress</option>
                            <option value="resolved" ${feedback.status === 'resolved' ? 'selected' : ''}>Resolved</option>
                            <option value="closed" ${feedback.status === 'closed' ? 'selected' : ''}>Closed</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Admin Notes</label>
                        <textarea id="editFeedbackNotes" class="form-control" rows="4">${feedback.admin_notes || ''}</textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeFeedbackEditModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveFeedbackChanges()">Save Changes</button>
            </div>
        </div>
    `;
    
    modal.style.display = 'flex';
}

// Close feedback edit modal
function closeFeedbackEditModal() {
    const modal = document.getElementById('feedbackEditModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

// Save feedback changes
async function saveFeedbackChanges() {
    const feedbackId = document.getElementById('editFeedbackId').value;
    const status = document.getElementById('editFeedbackStatus').value;
    const adminNotes = document.getElementById('editFeedbackNotes').value;
    
    try {
        const token = localStorage.getItem('admin_token') || localStorage.getItem('authToken');
        
        const response = await fetch(`/api/feedback/${feedbackId}/update-status`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                status: status,
                admin_notes: adminNotes
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification('success', 'Success', 'Feedback updated successfully');
            closeFeedbackEditModal();
            
            // Refresh feedback list
            loadFeedbackManagement();
        } else {
            throw new Error(result.message || 'Failed to update feedback');
        }
        
    } catch (error) {
        console.error('Error saving feedback:', error);
        showNotification('error', 'Error', error.message);
    }
}
function showNotification(type, title, message) {
    // Check if notification container exists
    let container = document.querySelector('.notification-container');
    if (!container) {
        container = document.createElement('div');
        container.className = 'notification-container';
        container.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        `;
        document.body.appendChild(container);
    }
    
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.style.cssText = `
        background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3'};
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        margin-bottom: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        display: flex;
        align-items: center;
        gap: 10px;
        min-width: 300px;
        animation: slideIn 0.3s ease;
    `;
    
    notification.innerHTML = `
        <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
        <div style="flex:1">
            <strong style="display:block; margin-bottom:5px;">${title}</strong>
            <span>${message}</span>
        </div>
        <button onclick="this.parentElement.remove()" style="background:none; border:none; color:white; cursor:pointer;">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    container.appendChild(notification);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (notification.parentElement) {
            notification.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => notification.remove(), 300);
        }
    }, 5000);
}

// ===== Helper: Show message when no feedback =====

// Fetch all feedback (admin only)
async function fetchAllFeedback(limit = 20, page = 1, status = null) {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) {
            console.warn('No auth token available');
            return [];
        }
        
        console.log('ðŸ“‹ Fetching all feedback...');
        
        let url = `/feedback/all?limit=${limit}&page=${page}`;
        if (status) {
            url += `&status=${status}`;
        }
        
        const response = await fetch(url, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`Failed to fetch feedback: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success && data.feedback) {
            console.log(`âœ… Fetched ${data.feedback.length} feedback items`);
            return data.feedback;
        } else {
            throw new Error(data.message || 'No feedback returned');
        }
    } catch (error) {
        console.error('Error fetching feedback:', error);
        return [];
    }
}

// Update feedback management UI
function updateFeedbackManagementUI(stats, feedbackList) {
    const feedbackContainer = document.getElementById('feedbackManagementContainer');
    if (!feedbackContainer) return;
    
    // Create feedback management interface
    let html = `
        <div class="feedback-management">
            <div class="feedback-stats">
                <h3><i class="fas fa-chart-bar"></i> Feedback Overview</h3>
                ${stats ? `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${stats.total_feedback || 0}</div>
                            <div class="stat-label">Total Feedback</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${stats.new_feedback || 0}</div>
                            <div class="stat-label">New</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${stats.resolved_feedback || 0}</div>
                            <div class="stat-label">Resolved</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${stats.average_rating ? stats.average_rating.toFixed(1) : '0.0'}</div>
                            <div class="stat-label">Avg. Rating</div>
                        </div>
                    </div>
                ` : ''}
            </div>
            
            <div class="feedback-list">
                <h3><i class="fas fa-list"></i> Recent Feedback</h3>
                <div class="feedback-filters">
                    <select id="feedbackStatusFilter" class="form-control">
                        <option value="all">All Status</option>
                        <option value="new">New</option>
                        <option value="reviewed">Reviewed</option>
                        <option value="in_progress">In Progress</option>
                        <option value="resolved">Resolved</option>
                        <option value="closed">Closed</option>
                    </select>
                    <button class="btn-primary" id="refreshFeedbackBtn">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
    `;
    
    if (feedbackList && feedbackList.length > 0) {
        html += `<div class="feedback-items">`;
        
        feedbackList.forEach(feedback => {
            const statusClass = `status-${feedback.status}`;
            const ratingStars = 'â˜…'.repeat(feedback.rating || 0) + 'â˜†'.repeat(5 - (feedback.rating || 0));
            
            html += `
                <div class="feedback-item ${statusClass}" data-feedback-id="${feedback.feedback_id}">
                    <div class="feedback-header">
                        <div class="feedback-meta">
                            <span class="feedback-type">${feedback.feedback_type}</span>
                            <span class="feedback-date">${formatDate(feedback.created_at)}</span>
                        </div>
                        <div class="feedback-actions">
                            <span class="feedback-status ${statusClass}">${feedback.status}</span>
                            <button class="btn-small view-feedback-btn" data-feedback-id="${feedback.feedback_id}">
                                <i class="fas fa-eye"></i> View
                            </button>
                        </div>
                    </div>
                    
                    <div class="feedback-body">
                        <p class="feedback-message">${feedback.feedback_message}</p>
                        
                        ${feedback.rating > 0 ? `
                            <div class="feedback-rating">
                                <span class="rating-stars">${ratingStars}</span>
                                <span class="rating-value">${feedback.rating}/5</span>
                            </div>
                        ` : ''}
                        
                        <div class="feedback-user">
                            <i class="fas fa-user"></i>
                            ${feedback.user_id ? `User #${feedback.user_id}` : 'Anonymous'}
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += `</div>`;
    } else {
        html += `
            <div class="no-feedback">
                <i class="fas fa-comment-slash"></i>
                <h3>No feedback yet</h3>
                <p>No feedback has been submitted yet.</p>
            </div>
        `;
    }
    
    html += `</div></div>`;
    
    feedbackContainer.innerHTML = html;
    
    // Add event listeners
    setupFeedbackManagementEvents();
}

// Setup feedback management events
function setupFeedbackManagementEvents() {
    // View feedback button
    document.querySelectorAll('.view-feedback-btn').forEach(button => {
        button.addEventListener('click', function() {
            const feedbackId = this.getAttribute('data-feedback-id');
            showFeedbackDetailsModal(feedbackId);
        });
    });
    
    // Status filter
    const statusFilter = document.getElementById('feedbackStatusFilter');
    if (statusFilter) {
        statusFilter.addEventListener('change', async function() {
            const status = this.value === 'all' ? null : this.value;
            const feedbackList = await fetchAllFeedback(20, 1, status);
            updateFeedbackManagementUI(null, feedbackList);
        });
    }
    
    // Refresh button
    const refreshBtn = document.getElementById('refreshFeedbackBtn');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', async function() {
            const statusFilter = document.getElementById('feedbackStatusFilter');
            const status = statusFilter && statusFilter.value !== 'all' ? statusFilter.value : null;
            
            const [stats, feedbackList] = await Promise.all([
                fetchFeedbackStats(),
                fetchAllFeedback(20, 1, status)
            ]);
            
            updateFeedbackManagementUI(stats, feedbackList);
            showNotification('Feedback list refreshed', 'success');
        });
    }
}

// Show feedback details modal (admin)
async function showFeedbackDetailsModal(feedbackId) {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) return;
        
        console.log(`ðŸ” Fetching feedback details for ID: ${feedbackId}`);
        
        const response = await fetch(`/api/feedback/${feedbackId}`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`Failed to fetch feedback details: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success && data.feedback) {
            const feedback = data.feedback;
            const ratingStars = 'â˜…'.repeat(feedback.rating || 0) + 'â˜†'.repeat(5 - (feedback.rating || 0));
            
            const modalHTML = `
                <div class="feedback-details-modal">
                    <div class="modal-header">
                        <h3><i class="fas fa-comment-dots"></i> Feedback Details</h3>
                    </div>
                    
                    <div class="modal-body">
                        <div class="feedback-info">
                            <div class="info-row">
                                <strong>ID:</strong> <span>${feedback.feedback_id}</span>
                            </div>
                            <div class="info-row">
                                <strong>Type:</strong> <span class="feedback-type">${feedback.feedback_type}</span>
                            </div>
                            <div class="info-row">
                                <strong>Status:</strong> <span class="feedback-status status-${feedback.status}">${feedback.status}</span>
                            </div>
                            <div class="info-row">
                                <strong>Submitted:</strong> <span>${formatDate(feedback.created_at)}</span>
                            </div>
                            ${feedback.reviewed_at ? `
                                <div class="info-row">
                                    <strong>Reviewed:</strong> <span>${formatDate(feedback.reviewed_at)}</span>
                                </div>
                            ` : ''}
                            ${feedback.resolved_at ? `
                                <div class="info-row">
                                    <strong>Resolved:</strong> <span>${formatDate(feedback.resolved_at)}</span>
                                </div>
                            ` : ''}
                            ${feedback.user_id ? `
                                <div class="info-row">
                                    <strong>User ID:</strong> <span>${feedback.user_id}</span>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="feedback-message-container">
                            <h4>Feedback Message:</h4>
                            <div class="feedback-message">
                                ${feedback.feedback_message}
                            </div>
                        </div>
                        
                        ${feedback.rating > 0 ? `
                            <div class="feedback-rating-container">
                                <h4>Rating:</h4>
                                <div class="rating-display">
                                    <span class="rating-stars">${ratingStars}</span>
                                    <span class="rating-value">${feedback.rating}/5</span>
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="feedback-meta-container">
                            <h4>Metadata:</h4>
                            <div class="meta-info">
                                ${feedback.page_url ? `
                                    <div class="meta-row">
                                        <strong>Page URL:</strong> <span>${feedback.page_url}</span>
                                    </div>
                                ` : ''}
                                ${feedback.user_agent ? `
                                    <div class="meta-row">
                                        <strong>User Agent:</strong> <span class="user-agent">${feedback.user_agent}</span>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        ${feedback.admin_notes ? `
                            <div class="admin-notes-container">
                                <h4>Admin Notes:</h4>
                                <div class="admin-notes">
                                    ${feedback.admin_notes}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="modal-footer">
                        <div class="status-actions">
                            <select id="updateStatusSelect" class="form-control">
                                <option value="new" ${feedback.status === 'new' ? 'selected' : ''}>New</option>
                                <option value="reviewed" ${feedback.status === 'reviewed' ? 'selected' : ''}>Reviewed</option>
                                <option value="in_progress" ${feedback.status === 'in_progress' ? 'selected' : ''}>In Progress</option>
                                <option value="resolved" ${feedback.status === 'resolved' ? 'selected' : ''}>Resolved</option>
                                <option value="closed" ${feedback.status === 'closed' ? 'selected' : ''}>Closed</option>
                            </select>
                            <button class="btn-primary" id="updateStatusBtn" data-feedback-id="${feedback.feedback_id}">
                                <i class="fas fa-save"></i> Update Status
                            </button>
                        </div>
                        
                        <div class="admin-notes-input">
                            <textarea id="adminNotesInput" placeholder="Add admin notes here...">${feedback.admin_notes || ''}</textarea>
                            <button class="btn-secondary" id="saveNotesBtn" data-feedback-id="${feedback.feedback_id}">
                                <i class="fas fa-edit"></i> Save Notes
                            </button>
                        </div>
                        
                        <button class="btn-secondary" id="closeFeedbackModal">
                            <i class="fas fa-times"></i> Close
                        </button>
                    </div>
                </div>
            `;
            
            showModal(modalHTML);
            
            // Setup modal interactions
            setupFeedbackModalInteractions(feedbackId);
        }
    } catch (error) {
        console.error('Error showing feedback details:', error);
        showNotification('Failed to load feedback details', 'error');
    }
}

// Setup feedback modal interactions
function setupFeedbackModalInteractions(feedbackId) {
    // Update status button
    const updateStatusBtn = document.getElementById('updateStatusBtn');
    if (updateStatusBtn) {
        updateStatusBtn.addEventListener('click', async function() {
            const statusSelect = document.getElementById('updateStatusSelect');
            const status = statusSelect.value;
            
            const success = await updateFeedbackStatus(feedbackId, status);
            
            if (success) {
                showNotification('Feedback status updated', 'success');
                
                // Refresh feedback list
                const statusFilter = document.getElementById('feedbackStatusFilter');
                const currentStatus = statusFilter && statusFilter.value !== 'all' ? statusFilter.value : null;
                const feedbackList = await fetchAllFeedback(20, 1, currentStatus);
                updateFeedbackManagementUI(null, feedbackList);
                
                // Close modal
                const modal = document.querySelector('.modal-overlay');
                if (modal) modal.remove();
            }
        });
    }
    
    // Save notes button
    const saveNotesBtn = document.getElementById('saveNotesBtn');
    if (saveNotesBtn) {
        saveNotesBtn.addEventListener('click', async function() {
            const adminNotes = document.getElementById('adminNotesInput').value;
            
            const success = await updateFeedbackStatus(feedbackId, null, adminNotes);
            
            if (success) {
                showNotification('Admin notes saved', 'success');
            }
        });
    }
    
    // Close button
    const closeBtn = document.getElementById('closeFeedbackModal');
    if (closeBtn) {
        closeBtn.addEventListener('click', () => {
            const modal = document.querySelector('.modal-overlay');
            if (modal) modal.remove();
        });
    }
}

// Add CSS styles for feedback
function addFeedbackStyles() {
    if (document.querySelector('#feedback-styles')) return;
    
    const style = document.createElement('style');
    style.id = 'feedback-styles';
    style.textContent = `
        /* Rating Stars */
        .rating {
            display: flex;
            gap: 5px;
            margin: 10px 0;
        }
        
        .star {
            font-size: 24px;
            color: #ddd;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .star:hover,
        .star.hover {
            color: #f39c12;
        }
        
        .star.active {
            color: #f39c12;
        }
        
        /* Feedback Form */
        #feedbackForm .form-group {
            margin-bottom: 20px;
        }
        
        #feedbackForm label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #2c3e50;
        }
        
        #feedbackForm select,
        #feedbackForm textarea {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        #feedbackForm textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        #feedbackForm select:focus,
        #feedbackForm textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        /* Success Message */
        .success-message {
            display: none;
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            text-align: center;
            border: 1px solid #c3e6cb;
        }
        
        .success-message i {
            font-size: 20px;
            margin-right: 10px;
            color: #28a745;
        }
        
        /* Feedback Management */
        .feedback-management {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .feedback-stats {
            margin-bottom: 30px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .feedback-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .feedback-items {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .feedback-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            border-left: 4px solid #3498db;
            transition: all 0.3s;
        }
        
        .feedback-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .feedback-item.status-new {
            border-left-color: #3498db;
        }
        
        .feedback-item.status-reviewed {
            border-left-color: #f39c12;
        }
        
        .feedback-item.status-in_progress {
            border-left-color: #9b59b6;
        }
        
        .feedback-item.status-resolved {
            border-left-color: #27ae60;
        }
        
        .feedback-item.status-closed {
            border-left-color: #95a5a6;
        }
        
        .feedback-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .feedback-meta {
            display: flex;
            gap: 15px;
            font-size: 12px;
            color: #6c757d;
        }
        
        .feedback-type {
            background: #e3f2fd;
            color: #1976d2;
            padding: 3px 8px;
            border-radius: 10px;
            text-transform: capitalize;
        }
        
        .feedback-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .feedback-status {
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .status-new {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .status-reviewed {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-in_progress {
            background: #f3e5f5;
            color: #7b1fa2;
        }
        
        .status-resolved {
            background: #d4edda;
            color: #155724;
        }
        
        .status-closed {
            background: #e9ecef;
            color: #495057;
        }
        
        .feedback-message {
            line-height: 1.6;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .feedback-rating {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .rating-stars {
            font-size: 16px;
            color: #f39c12;
        }
        
        .feedback-user {
            font-size: 12px;
            color: #6c757d;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .no-feedback {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }
        
        .no-feedback i {
            font-size: 48px;
            margin-bottom: 20px;
            color: #3498db;
        }
        
        .access-denied {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }
        
        /* Feedback Details Modal */
        .feedback-details-modal {
            background: white;
            border-radius: 10px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .modal-footer {
            padding: 20px;
            border-top: 1px solid #eee;
        }
        
        .feedback-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .info-row:last-child {
            margin-bottom: 0;
        }
        
        .feedback-message-container,
        .feedback-rating-container,
        .feedback-meta-container,
        .admin-notes-container {
            margin-bottom: 20px;
        }
        
        .feedback-message-container h4,
        .feedback-rating-container h4,
        .feedback-meta-container h4,
        .admin-notes-container h4 {
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .feedback-message {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            line-height: 1.6;
        }
        
        .rating-display {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .meta-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }
        
        .meta-row {
            margin-bottom: 8px;
        }
        
        .meta-row:last-child {
            margin-bottom: 0;
        }
        
        .user-agent {
            font-size: 12px;
            color: #6c757d;
            word-break: break-all;
        }
        
        .admin-notes {
            background: #fffde7;
            padding: 15px;
            border-radius: 8px;
            line-height: 1.6;
        }
        
        .status-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .admin-notes-input {
            margin-bottom: 15px;
        }
        
        .admin-notes-input textarea {
            width: 100%;
            min-height: 80px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
            resize: vertical;
        }
        
        .modal-footer .btn-primary,
        .modal-footer .btn-secondary {
            width: 100%;
            justify-content: center;
            margin-bottom: 10px;
        }
    `;
    document.head.appendChild(style);
}

// ============================================
// LESSON MANAGEMENT FUNCTIONS - DATABASE DRIVEN
// ============================================

// Fetch all lessons from database
async function fetchAllLessons() {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) {
            console.warn('No auth token available');
            return [];
        }
        
        console.log('ðŸ“š Fetching all lessons from database...');
        
        const response = await fetch(`/api/lessons-db/complete`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`Failed to fetch lessons: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success && data.lessons) {
            console.log(`âœ… Fetched ${data.lessons.length} lessons from database`);
            return data.lessons;
        } else {
            throw new Error(data.message || 'No lessons returned');
        }
    } catch (error) {
        console.error('Error fetching lessons:', error);
        return [];
    }
}

// Fetch user progress for lessons
async function fetchUserLessonProgress() {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) {
            console.warn('No auth token available');
            return {};
        }
        
        console.log('ðŸ“Š Fetching user lesson progress...');
        
        const response = await fetch(`/api/progress/lessons`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                console.log('âœ… User progress loaded');
                
                // Convert array to object for easier access
                const progressMap = {};
                data.progress.forEach(progress => {
                    progressMap[progress.content_id] = {
                        status: progress.completion_status,
                        percentage: progress.percentage || 0,
                        time_spent: progress.time_spent_seconds || 0,
                        last_accessed: progress.last_accessed
                    };
                });
                
                return progressMap;
            }
        }
        
        return {};
    } catch (error) {
        console.error('Error fetching user progress:', error);
        return {};
    }
}

// Get continue learning lesson
function getContinueLearningLesson(lessons, progress) {
    if (lessons.length === 0) return null;
    
    // Find the most recently accessed incomplete lesson
    let continueLesson = null;
    let maxLastAccessed = null;
    
    for (const lesson of lessons) {
        const lessonProgress = progress[lesson.content_id] || {};
        
        // Skip completed lessons
        if (lessonProgress.status === 'completed') continue;
        
        // Check if this lesson was accessed more recently
        if (lessonProgress.last_accessed) {
            const lastAccessed = new Date(lessonProgress.last_accessed);
            if (!maxLastAccessed || lastAccessed > maxLastAccessed) {
                maxLastAccessed = lastAccessed;
                continueLesson = lesson;
            }
        }
    }
    
    // If no incomplete lessons with progress, find first incomplete lesson
    if (!continueLesson) {
        for (const lesson of lessons) {
            const lessonProgress = progress[lesson.content_id] || {};
            if (lessonProgress.status !== 'completed') {
                continueLesson = lesson;
                break;
            }
        }
    }
    
    // If all lessons are completed, show the first lesson
    if (!continueLesson && lessons.length > 0) {
        continueLesson = lessons[0];
    }
    
    return continueLesson;
}

// Load recent lessons for display
async function loadRecentLessons(container, lessons, progress) {
    if (!container) return;
    
    // Sort lessons by last accessed or content order
    const sortedLessons = [...lessons].sort((a, b) => {
        const progressA = progress[a.content_id] || {};
        const progressB = progress[b.content_id] || {};
        
        // Sort by last accessed date (newest first)
        if (progressA.last_accessed && progressB.last_accessed) {
            return new Date(progressB.last_accessed) - new Date(progressA.last_accessed);
        }
        
        // Then by content order
        return a.content_order - b.content_order;
    });
    
    // Take up to 4 recent lessons
    const recentLessons = sortedLessons.slice(0, 4);
    
    let html = '';
    
    recentLessons.forEach(lesson => {
        const lessonProgress = progress[lesson.content_id] || {};
        const status = lessonProgress.status || 'not_started';
        const percentage = lessonProgress.percentage || 0;
        
        let statusText = 'Start';
        let statusClass = 'locked';
        let icon = 'fas fa-lock';
        
        if (status === 'completed') {
            statusText = 'Completed';
            statusClass = 'completed';
            icon = 'fas fa-check';
        } else if (status === 'in_progress') {
            statusText = percentage > 0 ? 'Continue' : 'Start';
            statusClass = 'current';
            icon = percentage > 0 ? 'fas fa-play' : 'fas fa-play';
        }
        
        html += `
            <div class="lesson-item ${statusClass}" data-lesson-id="${lesson.content_id}">
                <div class="lesson-info">
                    <div class="lesson-icon">
                        <i class="${icon}"></i>
                    </div>
                    <div>
                        <div class="lesson-title">${lesson.content_title}</div>
                        <div class="lesson-duration">
                            <i class="fas fa-video"></i> ${Math.round((lesson.video_duration_seconds || 0) / 60)} min
                        </div>
                    </div>
                </div>
                <div class="lesson-actions">
                    <button class="${status === 'completed' ? 'review-btn' : 'start-btn'}" 
                            data-lesson-id="${lesson.content_id}">
                        ${status === 'completed' ? 'Review' : statusText}
                    </button>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
    
    // Add event listeners to lesson items
    container.querySelectorAll('.lesson-item').forEach(item => {
        item.addEventListener('click', function() {
            const lessonId = this.getAttribute('data-lesson-id');
            openLesson(lessonId);
        });
    });
    
    // Add event listeners to buttons
    container.querySelectorAll('.start-btn, .review-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            e.stopPropagation();
            const lessonId = this.getAttribute('data-lesson-id');
            openLesson(lessonId);
        });
    });
}

// Update continue learning module in home dashboard
async function updateContinueLearningModule() {
    try {
        const container = document.getElementById('continueLearningContainer');
        if (!container) {
            console.error('Continue learning container not found');
            return;
        }
        
        container.innerHTML = `
            <div class="loading-container">
                <div class="loading-text">
                    <i class="fas fa-spinner fa-spin"></i> Loading lessons...
                </div>
            </div>
        `;
        
        // Fetch lessons and progress
        const [lessons, progress] = await Promise.all([
            fetchAllLessons(),
            fetchUserLessonProgress()
        ]);
        
        if (lessons.length === 0) {
            container.innerHTML = `
                <div class="no-lessons">
                    <i class="fas fa-book"></i>
                    <h3>No lessons available</h3>
                    <p>Check back later for new lessons!</p>
                </div>
            `;
            return;
        }
        
        // Store in global state
        LessonState.lessons = lessons;
        LessonState.userProgress = progress;
        
        // Get continue learning lesson
        const continueLesson = getContinueLearningLesson(lessons, progress);
        LessonState.continueLearningLesson = continueLesson;
        
        if (!continueLesson) {
            container.innerHTML = `
                <div class="no-lessons">
                    <i class="fas fa-trophy"></i>
                    <h3>All Lessons Completed!</h3>
                    <p>Great job! You've completed all available lessons.</p>
                    <button class="btn-primary" id="reviewAllLessons">
                        <i class="fas fa-redo"></i> Review Lessons
                    </button>
                </div>
            `;
            
            document.getElementById('reviewAllLessons')?.addEventListener('click', () => {
                navigateTo('moduleDashboard');
            });
            
            return;
        }
        
        // Calculate progress percentage
        const lessonProgress = progress[continueLesson.content_id] || {};
        const percentage = lessonProgress.percentage || 0;
        const status = lessonProgress.status || 'not_started';
        
        // Get topic ID for this lesson
        const topicId = continueLesson.topic_id || 1;
        LessonState.currentTopic = topicId;
        
        // Check if practice is unlocked for this topic
        let practiceUnlocked = false;
        let practiceAvailable = false;
        
        if (percentage >= 80) {
            practiceUnlocked = await checkPracticeUnlocked(topicId);
            practiceAvailable = true;
        }
        
        // Render continue learning module
        container.innerHTML = `
            <div class="module-header">
                <h3 class="module-title">
                    <i class="fas fa-cube"></i> 
                    ${continueLesson.module_name || 'Module'}: ${continueLesson.topic_title || 'Topic'}
                </h3>
                <span class="module-status status-${status}">
                    ${status === 'completed' ? 'Completed' : 
                      status === 'in_progress' ? 'In Progress' : 'Start Learning'}
                </span>
            </div>
            
            <p style="color: var(--text-light); margin-bottom: 15px;">
                ${continueLesson.content_title || 'Continue your learning journey.'}
            </p>
            
            <div class="module-progress">
                <div class="progress-label">
                    <span>Progress</span>
                    <span>${percentage}%</span>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-fill" style="width: ${percentage}%"></div>
                </div>
            </div>
            
            <div class="module-lessons" id="recentLessonsList">
                <!-- Recent lessons will be loaded here -->
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn-primary" id="continueLessonBtn" data-lesson-id="${continueLesson.content_id}">
                    <i class="fas fa-play"></i> ${status === 'not_started' ? 'Start Lesson' : 
                     status === 'in_progress' ? 'Continue Lesson' : 'Review Lesson'}
                </button>
                ${practiceAvailable ? `
                    <button class="btn-success ${practiceUnlocked ? '' : 'disabled'}" 
                            id="practiceTopicBtn" 
                            style="margin-left: 10px;" 
                            data-topic-id="${topicId}"
                            ${practiceUnlocked ? '' : 'disabled'}>
                        <i class="fas fa-pencil-alt"></i> 
                        ${practiceUnlocked ? 'Practice Now' : 'Practice Locked'}
                    </button>
                ` : ''}
            </div>
        `;
        
        // Load recent lessons
        await loadRecentLessons(container.querySelector('#recentLessonsList'), lessons, progress);
        
        // Setup continue button
        document.getElementById('continueLessonBtn')?.addEventListener('click', function() {
            const lessonId = this.getAttribute('data-lesson-id');
            openLesson(lessonId);
        });
        
        // Setup practice button
        const practiceBtn = document.getElementById('practiceTopicBtn');
        if (practiceBtn) {
            practiceBtn.addEventListener('click', function() {
                const topicId = this.getAttribute('data-topic-id');
                openPracticeForTopic(topicId);
            });
        }
        
        console.log('âœ… Continue learning module updated');
        
    } catch (error) {
        console.error('Error updating continue learning module:', error);
        container.innerHTML = `
            <div class="error-message">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>Failed to load lessons</h3>
                <p>Please try again later</p>
            </div>
        `;
    }
}

// ============================================
// FIXED: openLesson function - RAILWAY VERSION
// ============================================
async function openLesson(lessonId) {
    try {
        console.log('ðŸ“– Opening lesson on Railway:', lessonId);
        
        // Show loading
        showNotification('Loading lesson...', 'info');
        
        // Fetch lesson details
        const response = await fetch(`/api/lessons-db/${lessonId}`, {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('authToken')}`
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (!data.success || !data.lesson) {
            throw new Error('Lesson not found');
        }
        
        const lesson = data.lesson;
        console.log('âœ… Lesson loaded:', lesson.content_title);
        console.log('ðŸ“‹ Adjacent lessons from server:', lesson.adjacent);
        
        LessonState.currentLesson = lesson;
        LessonState.currentTopic = lesson.topic_id || 1;
        
        // Log activity
        await logUserActivity('lesson_started', lessonId, {
            lesson_title: lesson.content_title
        });
        
        // Update URL without reload
        const url = new URL(window.location);
        url.searchParams.set('lessonId', lessonId);
        window.history.pushState({}, '', url);
        
        // Navigate to module dashboard
        navigateTo('moduleDashboard');
        
        // Wait for page to load then update everything
        setTimeout(async () => {
            // Setup navigation buttons
            setupNavigationButtons();
            
            // Load video
            await loadVideoFromDatabase(lessonId);
            
            // Update complete button
            await checkLessonCompletionStatus();
            
            console.log('âœ… Lesson fully loaded on Railway');
        }, 500);
        
    } catch (error) {
        console.error('Error opening lesson on Railway:', error);
        showNotification('Error loading lesson: ' + error.message, 'error');
    }
}
// Update navigation buttons function - FIXED VERSION
function updateNavigationButtons(adjacent) {
    console.log('ðŸ”„ Updating navigation buttons with adjacent:', adjacent);
    
    const prevLessonBtn = document.getElementById('prevLessonBtn');
    const nextLessonBtn = document.getElementById('nextLessonBtn');
    
    if (prevLessonBtn) {
        if (adjacent?.previous) {
            prevLessonBtn.disabled = false;
            prevLessonBtn.innerHTML = `<i class="fas fa-arrow-left"></i> Previous: ${adjacent.previous.title}`;
        } else {
            prevLessonBtn.disabled = true;
            prevLessonBtn.innerHTML = `<i class="fas fa-arrow-left"></i> No Previous Lesson`;
        }
    }
    
    if (nextLessonBtn) {
        if (adjacent?.next) {
            nextLessonBtn.disabled = false;
            nextLessonBtn.innerHTML = `Next: ${adjacent.next.title} <i class="fas fa-arrow-right"></i>`;
        } else {
            nextLessonBtn.disabled = true;
            nextLessonBtn.innerHTML = `No Next Lesson <i class="fas fa-arrow-right"></i>`;
        }
    }
}

// Add this to your DOMContentLoaded or initModuleDashboard function
function initModuleDashboardJS() {
    console.log('ðŸ“š Initializing module dashboard with Railway fixes...');
    
    // Setup navigation
    setupLessonNavigation();
    
    // Initialize with current lesson
    initializeModuleDashboard();
    
    // Back button
    const backToLessonDashboardBtn = document.getElementById('backToLessonDashboard');
    if (backToLessonDashboardBtn) {
        backToLessonDashboardBtn.addEventListener('click', function() {
            console.log('Back to dashboard button clicked');
            navigateTo('dashboard');
        });
    }
    
    console.log('âœ… Module dashboard initialized with Railway fixes');
}


// Open practice for a specific topic
function openPracticeForTopic(topicId) {
    console.log('ðŸ“ Opening practice for topic:', topicId);
    
    // Set current topic
    PracticeState.currentTopic = topicId;
    
    // Navigate to practice page
    navigateTo('practice');
}

// Fetch lesson details
async function fetchLessonDetails(lessonId) {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) {
            console.warn('No auth token available');
            return null;
        }
        
        console.log('ðŸ” Fetching lesson details for ID:', lessonId);
        
        // âœ… FIX: Add /api/ prefix
        const response = await fetch(`/api/lessons/${lessonId}`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        // Check if response is JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            console.error('âŒ Non-JSON response from lesson details');
            return null;
        }
        
        if (!response.ok) {
            throw new Error(`Failed to fetch lesson details: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success && data.lesson) {
            console.log('âœ… Lesson details loaded:', data.lesson.content_title);
            return data.lesson;
        } else {
            throw new Error(data.message || 'No lesson returned');
        }
    } catch (error) {
        console.error('Error fetching lesson details:', error);
        return null;
    }
}


// Fetch lesson content only
async function fetchLessonContent(lessonId) {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) {
            console.warn('No auth token available');
            return null;
        }
        
        console.log('ðŸ“„ Fetching lesson content for ID:', lessonId);
        
        const response = await fetch(`/api/lessons-db/${lessonId}/content`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`Failed to fetch lesson content: ${response.status}`);
        };
        
        const data = await response.json();
        
        if (data.success && data.content) {
            console.log('âœ… Lesson content loaded');
            return data.content;
        } else {
            throw new Error(data.message || 'No content returned');
        }
    } catch (error) {
        console.error('Error fetching lesson content:', error);
        return null;
    }
}


// Initialize the time tracker

// Update lesson progress in database
// ITO ANG BAGONG VERSION - WALANG POINTS SA DAILY PROGRESS
// ============================================
// FIXED: updateLessonProgress Function
// ============================================
// ============================================
// ðŸŽ¯ ENHANCED: updateLessonProgress - With session tracking
// ============================================
async function updateLessonProgress(contentId, progressData) {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) {
            console.warn('No auth token available');
            return false;
        }
        
        console.log('ðŸ“ Updating lesson progress:', {
            contentId: contentId,
            status: progressData.completion_status,
            percentage: progressData.percentage
        });
        
        // Check if this is a session end (user leaving)
        const isSessionEnd = progressData.session_end === true;
        
        // If this is a session end, we might want to cap the time
        if (isSessionEnd) {
            console.log('â±ï¸ Session ended - applying caps if needed');
        }
        
        const response = await fetch(`/api/lessons-db/${contentId}/progress`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(progressData)
        });
        
        if (!response.ok) {
            throw new Error(`Failed to update progress: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            console.log('âœ… Lesson progress updated successfully');
            
            // Update local progress state
            if (!LessonState.userProgress[contentId]) {
                LessonState.userProgress[contentId] = {};
            }
            Object.assign(LessonState.userProgress[contentId], progressData);
            
            // If lesson is newly completed, update daily progress
            if (progressData.completion_status === 'completed') {
                setTimeout(async () => {
                    await updateDailyProgress({ lessons_completed: 1 });
                }, 100);
            }
            
            return true;
        } else {
            throw new Error(data.message || 'Failed to update progress');
        }
    } catch (error) {
        console.error('âŒ Error updating lesson progress:', error);
        return false;
    }
}

// ============================================
// LESSON CONTENT DISPLAY FUNCTIONS
// ============================================

// Display lesson content from database
async function displayLessonContent() {
    try {
        const lessonContentContainer = document.getElementById('lessonContent');
        if (!lessonContentContainer) {
            console.error('Lesson content container not found');
            return;
        }
        
        // Show loading state
        lessonContentContainer.innerHTML = `
            <div class="loading-content">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Loading lesson content from database...</p>
            </div>
        `;
        
        const currentLesson = LessonState.currentLesson;
        if (!currentLesson) {
            lessonContentContainer.innerHTML = `
                <div class="no-content">
                    <i class="fas fa-book"></i>
                    <h3>No lesson selected</h3>
                    <p>Please select a lesson to view its content.</p>
                </div>
            `;
            return;
        }
        
        const contentDescription = currentLesson.content_description;
        
        if (!contentDescription || contentDescription.trim() === '') {
            // If no content in database, show default content
            lessonContentContainer.innerHTML = generateDefaultLessonContent(currentLesson);
        } else {
            // Convert markdown-like content to HTML
            const htmlContent = convertMarkdownToHTML(contentDescription);
            lessonContentContainer.innerHTML = htmlContent;
        }
        
        // Add event listeners to any interactive elements
        setupLessonContentInteractions();
        
        // Add practice button if lesson is completed or almost completed
        addPracticeButtonToLesson();
        
    } catch (error) {
        console.error('Error displaying lesson content:', error);
        const lessonContentContainer = document.getElementById('lessonContent');
        if (lessonContentContainer) {
            lessonContentContainer.innerHTML = `
                <div class="error-content">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>Failed to load lesson content</h3>
                    <p>Please try refreshing the page.</p>
                </div>
            `;
        }
    }
}

// Add practice button to lesson content
async function addPracticeButtonToLesson() {
    const currentLesson = LessonState.currentLesson;
    if (!currentLesson) return;
    
    const lessonProgress = currentLesson.progress || {};
    const percentage = lessonProgress.percentage || 0;
    const topicId = currentLesson.topic_id || 1;
    
    // Check if practice is unlocked for this topic
    const practiceUnlocked = await checkPracticeUnlocked(topicId);
    
    // Only show practice button if lesson is mostly completed AND practice is unlocked
    if (percentage >= 80 && practiceUnlocked) {
        const practiceBtnHtml = `
            <div class="practice-cta">
                <h3><i class="fas fa-pencil-alt"></i> Ready to Practice?</h3>
                <p>You've completed ${percentage}% of this lesson. Test your knowledge with practice exercises!</p>
                <button class="btn-success" id="goToPracticeBtn" data-topic-id="${topicId}">
                    <i class="fas fa-play-circle"></i> Start Practice Exercises
                </button>
            </div>
        `;
        
        // Add to lesson content
        const lessonContent = document.getElementById('lessonContent');
        const existingPracticeCTA = lessonContent.querySelector('.practice-cta');
        
        if (!existingPracticeCTA) {
            lessonContent.querySelector('.lesson-content-wrapper')?.insertAdjacentHTML('beforeend', practiceBtnHtml);
            
            // Add event listener
            const practiceBtn = document.getElementById('goToPracticeBtn');
            if (practiceBtn) {
                practiceBtn.addEventListener('click', function() {
                    const topicId = this.getAttribute('data-topic-id');
                    openPracticeForTopic(topicId);
                });
            }
        }
    } else if (percentage >= 80 && !practiceUnlocked) {
        // Show lock message
        const lockHtml = `
            <div class="practice-cta locked">
                <h3><i class="fas fa-lock"></i> Practice Locked</h3>
                <p>Complete all lessons in this topic to unlock practice exercises.</p>
                <button class="btn-secondary" disabled>
                    <i class="fas fa-lock"></i> Complete All Lessons First
                </button>
            </div>
        `;
        
        const lessonContent = document.getElementById('lessonContent');
        const existingPracticeCTA = lessonContent.querySelector('.practice-cta');
        
        if (!existingPracticeCTA) {
            lessonContent.querySelector('.lesson-content-wrapper')?.insertAdjacentHTML('beforeend', lockHtml);
        }
    }
}

// Convert markdown-like text to HTML
function convertMarkdownToHTML(text) {
    if (!text) return '';
    
    // Basic markdown conversion
    let html = text
        // Headers
        .replace(/^# (.*$)/gm, '<h1>$1</h1>')
        .replace(/^## (.*$)/gm, '<h2>$1</h2>')
        .replace(/^### (.*$)/gm, '<h3>$1</h3>')
        .replace(/^#### (.*$)/gm, '<h4>$1</h4>')
        
        // Bold and italic
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        
        // Lists
        .replace(/^\d+\.\s+(.*$)/gm, '<li>$1</li>')
        .replace(/^-\s+(.*$)/gm, '<li>$1</li>')
        
        // Code blocks
        .replace(/`(.*?)`/g, '<code>$1</code>')
        
        // Line breaks
        .replace(/\n\n/g, '</p><p>')
        .replace(/\n/g, '<br>');
    
    // Wrap list items in proper list tags
    if (html.includes('<li>')) {
        html = html.replace(/(<li>.*?<\/li>)+/gs, '<ol>$&</ol>');
    }
    
    // Add paragraph tags
    const sections = html.split('</p><p>');
    html = sections.map(section => {
        if (!section.startsWith('<h') && !section.startsWith('<ol') && !section.startsWith('<ul') && !section.startsWith('<li>')) {
            return `<p>${section}</p>`;
        }
        return section;
    }).join('');
    
    // Add styling classes
    html = html
        .replace(/<h1>/g, '<h1 class="lesson-title">')
        .replace(/<h2>/g, '<h2 class="lesson-subtitle">')
        .replace(/<h3>/g, '<h3 class="lesson-section">')
        .replace(/<p>/g, '<p class="lesson-paragraph">')
        .replace(/<code>/g, '<code class="lesson-code">');
    
    return `
        <div class="lesson-content-wrapper">
            ${html}
            <div class="lesson-interactive">
                <button class="btn-secondary" id="showMoreExamples">
                    <i class="fas fa-plus-circle"></i> Show More Examples
                </button>
                <button class="btn-secondary" id="practiceProblems">
                    <i class="fas fa-pencil-alt"></i> Practice Problems
                </button>
                <button class="btn-secondary" id="downloadNotes">
                    <i class="fas fa-download"></i> Download Notes
                </button>
            </div>
        </div>
    `;
}

// Generate default lesson content if no database content
function generateDefaultLessonContent(lesson) {
    return `
        <div class="lesson-content-wrapper">
            <h1 class="lesson-title">${lesson.content_title || 'Polynomial Division'}</h1>
            
            <div class="lesson-meta">
                <span class="meta-item">
                    <i class="fas fa-clock"></i> ${Math.round(lesson.video_duration_seconds / 60)} minutes
                </span>
                <span class="meta-item">
                    <i class="fas fa-book"></i> ${lesson.module_name || 'Module'}
                </span>
                <span class="meta-item">
                    <i class="fas fa-tag"></i> ${lesson.topic_title || 'Topic'}
                </span>
            </div>
            
            <h2 class="lesson-subtitle">Introduction</h2>
            <p class="lesson-paragraph">
                This lesson covers polynomial division methods including long division and synthetic division. 
                These techniques are essential for simplifying complex polynomial expressions and solving equations.
            </p>
            
            <h2 class="lesson-subtitle">Learning Objectives</h2>
            <ol class="lesson-list">
                <li>Divide polynomials using the long division method</li>
                <li>Apply synthetic division for linear divisors</li>
                <li>Identify when to use each method appropriately</li>
                <li>Solve polynomial equations using division techniques</li>
            </ol>
            
            <h2 class="lesson-subtitle">Example: Long Division</h2>
            <div class="example-box">
                <p><strong>Problem:</strong> Divide (3xÂ³ - 2xÂ² + 4x - 1) by (x - 2)</p>
                <p><strong>Solution Steps:</strong></p>
                <ol>
                    <li>Set up the division: (3xÂ³ - 2xÂ² + 4x - 1) Ã· (x - 2)</li>
                    <li>Divide first term: 3xÂ³ Ã· x = 3xÂ²</li>
                    <li>Multiply: 3xÂ²(x - 2) = 3xÂ³ - 6xÂ²</li>
                    <li>Subtract: (3xÂ³ - 2xÂ²) - (3xÂ³ - 6xÂ²) = 4xÂ²</li>
                    <li>Bring down next term: 4xÂ² + 4x</li>
                    <li>Continue until remainder has lower degree than divisor</li>
                </ol>
            </div>
            
            <h2 class="lesson-subtitle">Practice Problems</h2>
            <div class="practice-box">
                <p><strong>Try these problems:</strong></p>
                <ol>
                    <li>(xÂ² + 5x + 6) Ã· (x + 2)</li>
                    <li>(2xÂ³ - 3xÂ² + x - 1) Ã· (x - 1)</li>
                    <li>(xâ´ - 16) Ã· (x - 2)</li>
                </ol>
                <button class="btn-primary" id="checkAnswersBtn">
                    <i class="fas fa-check"></i> Check Answers
                </button>
            </div>
            
            <div class="lesson-tips">
                <h3><i class="fas fa-lightbulb"></i> Tips & Tricks</h3>
                <ul>
                    <li>Always arrange polynomials in descending order before dividing</li>
                    <li>Include zero coefficients for missing terms</li>
                    <li>Check your work by multiplying quotient by divisor and adding remainder</li>
                    <li>Synthetic division only works when dividing by (x - c)</li>
                </ul>
            </div>
            
            <div class="lesson-interactive">
                <button class="btn-secondary" id="showMoreExamples">
                    <i class="fas fa-plus-circle"></i> Show More Examples
                </button>
                <button class="btn-secondary" id="practiceProblems">
                    <i class="fas fa-pencil-alt"></i> Practice Problems
                </button>
                <button class="btn-secondary" id="downloadNotes">
                    <i class="fas fa-download"></i> Download Notes
                </button>
            </div>
        </div>
    `;
}

// Setup interactions for lesson content
function setupLessonContentInteractions() {
    // Show more examples button
    const showMoreExamplesBtn = document.getElementById('showMoreExamples');
    if (showMoreExamplesBtn) {
        showMoreExamplesBtn.addEventListener('click', function() {
            const extraExamples = `
                <div class="extra-examples">
                    <h3>Additional Examples</h3>
                    
                    <div class="example">
                        <h4>Example 1: Synthetic Division</h4>
                        <p>Divide (2xÂ³ + 3xÂ² - 4x + 5) by (x + 1)</p>
                        <p><strong>Steps:</strong></p>
                        <ol>
                            <li>Set c = -1 (opposite sign of x + 1)</li>
                            <li>Write coefficients: 2, 3, -4, 5</li>
                            <li>Bring down 2</li>
                            <li>Multiply: 2 Ã— -1 = -2, add to next: 3 + (-2) = 1</li>
                            <li>Continue: 1 Ã— -1 = -1, -4 + (-1) = -5</li>
                            <li>-5 Ã— -1 = 5, 5 + 5 = 10 (remainder)</li>
                            <li>Result: 2xÂ² + x - 5 + 10/(x + 1)</li>
                        </ol>
                    </div>
                    
                    <div class="example">
                        <h4>Example 2: Long Division with Quadratic Divisor</h4>
                        <p>Divide (xâ´ - 3xÂ³ + 2xÂ² - x + 1) by (xÂ² + 1)</p>
                        <p><strong>Steps:</strong></p>
                        <ol>
                            <li>Set up: (xâ´ - 3xÂ³ + 2xÂ² - x + 1) Ã· (xÂ² + 1)</li>
                            <li>xâ´ Ã· xÂ² = xÂ²</li>
                            <li>xÂ²(xÂ² + 1) = xâ´ + xÂ²</li>
                            <li>Subtract: (xâ´ - 3xÂ³ + 2xÂ²) - (xâ´ + xÂ²) = -3xÂ³ + xÂ²</li>
                            <li>Bring down -x: -3xÂ³ + xÂ² - x</li>
                            <li>Continue process...</li>
                        </ol>
                    </div>
                </div>
            `;
            
            // Append to lesson content
            const lessonContent = document.getElementById('lessonContent');
            const existingExtra = lessonContent.querySelector('.extra-examples');
            
            if (existingExtra) {
                existingExtra.remove();
                this.innerHTML = '<i class="fas fa-plus-circle"></i> Show More Examples';
            } else {
                lessonContent.querySelector('.lesson-content-wrapper').insertAdjacentHTML('beforeend', extraExamples);
                this.innerHTML = '<i class="fas fa-minus-circle"></i> Hide Examples';
            }
        });
    }
    
    // Practice problems button
    const practiceProblemsBtn = document.getElementById('practiceProblems');
    if (practiceProblemsBtn) {
        practiceProblemsBtn.addEventListener('click', function() {
            const problems = [
                { problem: "(xÂ³ - 8) Ã· (x - 2)", answer: "xÂ² + 2x + 4" },
                { problem: "(2xÂ³ + 5xÂ² - 3x + 1) Ã· (x + 1)", answer: "2xÂ² + 3x - 6 + 7/(x + 1)" },
                { problem: "(xâ´ - 1) Ã· (x - 1)", answer: "xÂ³ + xÂ² + x + 1" }
            ];
            
            let problemsHTML = '<div class="practice-modal"><h3>Practice Problems</h3>';
            problems.forEach((prob, index) => {
                problemsHTML += `
                    <div class="problem">
                        <p><strong>Problem ${index + 1}:</strong> ${prob.problem}</p>
                        <div class="solution" style="display: none;">
                            <p><strong>Solution:</strong> ${prob.answer}</p>
                        </div>
                        <button class="btn-small show-solution" data-index="${index}">
                            Show Solution
                        </button>
                    </div>
                `;
            });
            problemsHTML += '</div>';
            
            // Show modal with problems
            showModal(problemsHTML);
            
            // Add event listeners to show solution buttons
            setTimeout(() => {
                document.querySelectorAll('.show-solution').forEach(button => {
                    button.addEventListener('click', function() {
                        const index = this.getAttribute('data-index');
                        const solution = this.parentElement.querySelector('.solution');
                        if (solution.style.display === 'none') {
                            solution.style.display = 'block';
                            this.textContent = 'Hide Solution';
                        } else {
                            solution.style.display = 'none';
                            this.textContent = 'Show Solution';
                        }
                    });
                });
            }, 100);
        });
    }
    
    // Download notes button
    const downloadNotesBtn = document.getElementById('downloadNotes');
    if (downloadNotesBtn) {
        downloadNotesBtn.addEventListener('click', function() {
            const lessonTitle = LessonState.currentLesson?.content_title || 'Polynomial Division';
            const content = document.getElementById('lessonContent').innerText;
            
            // Create downloadable content
            const blob = new Blob([`${lessonTitle}\n\n${content}`], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${lessonTitle.replace(/\s+/g, '_')}_notes.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showNotification('Notes downloaded successfully!', 'success');
        });
    }
    
    // Check answers button (if exists in default content)
    const checkAnswersBtn = document.getElementById('checkAnswersBtn');
    if (checkAnswersBtn) {
        checkAnswersBtn.addEventListener('click', function() {
            const answers = {
                1: "(x + 3)",
                2: "(2xÂ² - x)",
                3: "(xÂ³ + 2xÂ² + 4x + 8)"
            };
            
            let answersHTML = '<div class="answers-modal"><h3>Answers to Practice Problems</h3>';
            Object.entries(answers).forEach(([problem, answer]) => {
                answersHTML += `
                    <div class="answer">
                        <p><strong>Problem ${problem}:</strong> ${answer}</p>
                    </div>
                `;
            });
            answersHTML += '</div>';
            
            showModal(answersHTML);
        });
    }
}

// Helper function to show modal
function showModal(content, options = {}) {
    const { closeable = true } = options;
    
    // Remove existing modal
    const existingModal = document.querySelector('.modal-overlay');
    if (existingModal) existingModal.remove();
    
    // Create modal
    const modalOverlay = document.createElement('div');
    modalOverlay.className = 'modal-overlay';
    
    let closeButton = '';
    if (closeable) {
        closeButton = '<button class="modal-close"><i class="fas fa-times"></i></button>';
    }
    
    modalOverlay.innerHTML = `
        <div class="modal-content">
            ${closeButton}
            ${content}
        </div>
    `;
    
    // Add styles
    modalOverlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        padding: 20px;
    `;
    
    const modalContent = modalOverlay.querySelector('.modal-content');
    modalContent.style.cssText = `
        background: white;
        padding: 30px;
        border-radius: 10px;
        max-width: 800px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        position: relative;
    `;
    
    // Add close button functionality
    if (closeable) {
        const closeBtn = modalOverlay.querySelector('.modal-close');
        closeBtn.style.cssText = `
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #666;
        `;
        
        closeBtn.addEventListener('click', () => modalOverlay.remove());
        modalOverlay.addEventListener('click', (e) => {
            if (e.target === modalOverlay) modalOverlay.remove();
        });
    }
    
    document.body.appendChild(modalOverlay);
    return modalOverlay;
}

// Add CSS styles for lesson content
function addLessonContentStyles() {
    if (!document.querySelector('#lesson-content-styles')) {
        const style = document.createElement('style');
        style.id = 'lesson-content-styles';
        style.textContent = `
            .lesson-content-wrapper {
                line-height: 1.6;
            }
            
            .lesson-title {
                color: #2c3e50;
                margin-bottom: 20px;
                font-size: 28px;
            }
            
            .lesson-subtitle {
                color: #3498db;
                margin-top: 25px;
                margin-bottom: 15px;
                font-size: 22px;
                border-bottom: 2px solid #f0f0f0;
                padding-bottom: 8px;
            }
            
            .lesson-section {
                color: #2c3e50;
                margin-top: 20px;
                font-size: 18px;
            }
            
            .lesson-paragraph {
                margin-bottom: 15px;
                color: #34495e;
            }
            
            .lesson-list {
                margin-left: 20px;
                margin-bottom: 20px;
            }
            
            .lesson-list li {
                margin-bottom: 8px;
            }
            
            .lesson-code {
                background: #f8f9fa;
                padding: 2px 6px;
                border-radius: 4px;
                font-family: monospace;
                color: #e74c3c;
            }
            
            .example-box, .practice-box {
                background: #f8f9fa;
                border-left: 4px solid #3498db;
                padding: 15px;
                margin: 20px 0;
                border-radius: 0 8px 8px 0;
            }
            
            .lesson-tips {
                background: #fffde7;
                border-left: 4px solid #f39c12;
                padding: 15px;
                margin: 20px 0;
                border-radius: 0 8px 8px 0;
            }
            
            .lesson-meta {
                display: flex;
                gap: 20px;
                margin-bottom: 20px;
                color: #7f8c8d;
                font-size: 14px;
            }
            
            .meta-item i {
                margin-right: 5px;
            }
            
            .lesson-interactive {
                display: flex;
                gap: 10px;
                margin-top: 30px;
                padding-top: 20px;
                border-top: 1px solid #eee;
            }
            
            .btn-secondary {
                background: #ecf0f1;
                color: #2c3e50;
                border: none;
                padding: 10px 15px;
                border-radius: 5px;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 8px;
                font-size: 14px;
                transition: all 0.3s;
            }
            
            .btn-secondary:hover {
                background: #d5dbdb;
                transform: translateY(-2px);
            }
            
            .btn-primary {
                background: #3498db;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 5px;
                cursor: pointer;
                margin-top: 10px;
            }
            
            .btn-small {
                background: #95a5a6;
                color: white;
                border: none;
                padding: 5px 10px;
                border-radius: 3px;
                cursor: pointer;
                font-size: 12px;
                margin-top: 5px;
            }
            
            .loading-content, .no-content, .error-content {
                text-align: center;
                padding: 50px 20px;
                color: #7f8c8d;
            }
            
            .loading-content i {
                font-size: 40px;
                margin-bottom: 20px;
                color: #3498db;
            }
            
            .extra-examples {
                margin-top: 30px;
                padding: 20px;
                background: #f9f9f9;
                border-radius: 8px;
            }
            
            .problem {
                margin-bottom: 20px;
                padding: 15px;
                background: #f8f9fa;
                border-radius: 5px;
            }
            
            .practice-cta {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 25px;
                border-radius: 10px;
                margin-top: 30px;
                text-align: center;
            }
            
            .practice-cta.locked {
                background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
            }
            
            .practice-cta h3 {
                margin-top: 0;
                color: white;
            }
            
            .practice-cta .btn-success {
                background: #27ae60;
                color: white;
                border: none;
                padding: 12px 25px;
                borderRadius: 5px;
                cursor: pointer;
                font-size: 16px;
                margin-top: 15px;
                transition: all 0.3s;
            }
            
            .practice-cta .btn-success:hover {
                background: #219653;
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            }
            
            .practice-cta .btn-success:disabled,
            .practice-cta .btn-secondary:disabled {
                background: #95a5a6;
                cursor: not-allowed;
                transform: none;
                box-shadow: none;
            }
            
            .practice-cta .btn-secondary {
                background: #7f8c8d;
                color: white;
            }
        `;
        document.head.appendChild(style);
    }
}

// ============================================
// VIDEO MANAGEMENT FUNCTIONS - FIXED
// ============================================

// Get video from database
async function getVideoFromDatabase(contentId = 1) {
    try {
        console.log('ðŸŽ¬ Fetching video from database for content ID:', contentId);
        
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) {
            console.warn('No auth token available');
            return null;
        }
        
        const response = await fetch(`/api/videos/content/${contentId}`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`Failed to fetch video: ${response.status}`);
        };
        
        const data = await response.json();
        
        if (data.success && data.video) {
            console.log('âœ… Video loaded from database:', {
                title: data.video.title,
                url: data.video.url,
                source: data.video.source || 'database',
                path: data.video.video_path
            });
            
            // Test if video URL is accessible
            try {
                const testResponse = await fetch(data.video.url, { method: 'HEAD' });
                console.log('ðŸ“¡ Video URL test:', {
                    url: data.video.url,
                    status: testResponse.status,
                    accessible: testResponse.ok
                });
            } catch (testError) {
                console.warn('âš ï¸ Video URL test failed:', testError.message);
            }
            
            AppState.currentVideoData = data.video;
            return data.video;
        } else {
            throw new Error(data.message || 'No video data returned');
        }
    } catch (error) {
        console.error('Error fetching video from database:', error);
        return null;
    }
}
// Test video accessibility
async function testVideoAccessibility(url) {
    try {
        const response = await fetch(url, { method: 'HEAD' });
        return {
            accessible: response.ok,
            status: response.status,
            statusText: response.statusText
        };
    } catch (error) {
        return {
            accessible: false,
            error: error.message
        };
    }
}

// ============================================
// RAILWAY FIX: Load video from database with better error handling
// ============================================
async function loadVideoFromDatabase(contentId = null) {
    console.log('ðŸŽ¬ loadVideoFromDatabase called with contentId:', contentId);
    
    // Try multiple selectors for video container
    const videoContainer = document.getElementById('videoContainer') || 
                           document.querySelector('.video-container') ||
                           document.querySelector('#module-dashboard-page .video-section');
    
    const videoInfo = document.getElementById('videoInfo');
    const refreshVideoBtn = document.getElementById('refreshVideoBtn');
    
    if (!videoContainer) {
        console.error('âŒ Video container not found! DOM structure:', {
            videoContainer: document.getElementById('videoContainer'),
            moduleDashboard: document.getElementById('module-dashboard-page'),
            videoSection: document.querySelector('.video-section')
        });
        
        // Create video container if it doesn't exist
        const moduleDashboard = document.getElementById('module-dashboard-page');
        if (moduleDashboard) {
            const videoSection = moduleDashboard.querySelector('.video-section');
            if (videoSection) {
                console.log('ðŸ”„ Creating video container dynamically...');
                videoSection.innerHTML = `
                    <div id="videoContainer" style="background: #000; min-height: 300px; width: 100%;">
                        <div style="background: #f0f0f0; height: 400px; display: flex; align-items: center; justify-content: center; flex-direction: column;">
                            <i class="fas fa-spinner fa-spin" style="font-size: 40px; color: #7a0000; margin-bottom: 20px;"></i>
                            <p style="color: #666;">Loading video...</p>
                        </div>
                    </div>
                `;
            }
        }
        
        // Try to get container again
        videoContainer = document.getElementById('videoContainer');
        if (!videoContainer) {
            console.error('âŒ Still cannot find video container');
            return null;
        }
    }
    
    try {
        // Use provided contentId or get from current lesson
        if (!contentId && LessonState.currentLesson) {
            contentId = LessonState.currentLesson.content_id;
        }
        
        // If still no contentId, try from URL
        if (!contentId) {
            const urlParams = new URLSearchParams(window.location.search);
            contentId = urlParams.get('lessonId') || urlParams.get('id') || urlParams.get('contentId') || 1;
        }
        
        console.log(`ðŸŽ¬ Loading video for lesson ID: ${contentId} on Railway`);
        
        // Show loading
        videoContainer.innerHTML = `
            <div style="background: #f0f0f0; height: 400px; display: flex; align-items: center; justify-content: center; flex-direction: column;">
                <i class="fas fa-spinner fa-spin" style="font-size: 40px; color: #7a0000; margin-bottom: 20px;"></i>
                <p style="color: #666;">Loading video from database...</p>
            </div>
        `;
        
        if (videoInfo) {
            videoInfo.innerHTML = '<p><i class="fas fa-spinner fa-spin"></i> Fetching video data...</p>';
        }
        
        if (refreshVideoBtn) {
            refreshVideoBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            refreshVideoBtn.disabled = true;
        }
        
        // Use apiRequest for consistency
        const lessonData = await apiRequest(`/api/lessons-db/${contentId}`);
        
        if (!lessonData.success || !lessonData.lesson) {
            throw new Error('Lesson not found');
        }
        
        const lesson = lessonData.lesson;
        console.log('âœ… Lesson data loaded:', lesson.content_title);
        
        // Update lesson info
        const titleElement = document.getElementById('videoLessonTitle');
        if (titleElement) {
            titleElement.textContent = lesson.content_title || 'Video Lesson';
        }
        
        const descElement = document.getElementById('videoLessonDescription');
        if (descElement) {
            descElement.textContent = lesson.content_description || '';
        }
        
        // Determine video source
        let videoUrl = null;
        let videoType = 'none';
        
        // Check for YouTube URL first
        if (lesson.content_url && (lesson.content_url.includes('youtube') || lesson.content_url.includes('youtu.be'))) {
            videoUrl = lesson.content_url;
            videoType = 'youtube';
            console.log('ðŸ”— Using YouTube video:', videoUrl);
        }
        // Check for video_filename (uploaded video)
        else if (lesson.video_filename) {
            if (lesson.video_filename.startsWith('http')) {
                videoUrl = lesson.video_filename;
            } else {
                // For Railway, use absolute URL
                videoUrl = `${window.location.origin}/videos/${lesson.video_filename}`;
            }
            videoType = 'uploaded';
            console.log('ðŸŽ¬ Using uploaded video:', videoUrl);
        }
        // Check for video_path
        else if (lesson.video_path) {
            if (lesson.video_path.startsWith('http')) {
                videoUrl = lesson.video_path;
            } else {
                const filename = lesson.video_path.split('/').pop();
                videoUrl = `${window.location.origin}/videos/${filename}`;
            }
            videoType = 'path';
            console.log('ðŸ“ Using video path:', videoUrl);
        }
        
        // Clear container
        videoContainer.innerHTML = '';
        
        // Handle YouTube videos
        if (videoType === 'youtube' && videoUrl) {
            const videoId = extractYoutubeId(videoUrl);
            if (videoId) {
                const iframe = document.createElement('iframe');
                iframe.width = '100%';
                iframe.height = '400';
                iframe.src = `https://www.youtube.com/embed/${videoId}`;
                iframe.frameBorder = '0';
                iframe.allowFullscreen = true;
                iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
                videoContainer.appendChild(iframe);
                
                if (videoInfo) {
                    videoInfo.innerHTML = `
                        <p><i class="fab fa-youtube" style="color: #ff0000;"></i> <strong>YouTube Video</strong></p>
                        <p>${lesson.content_title || ''}</p>
                    `;
                }
                return;
            }
        }
        
        // Handle uploaded videos
        if (videoUrl) {
            const video = document.createElement('video');
            video.id = 'lessonVideo';
            video.controls = true;
            video.style.width = '100%';
            video.style.maxHeight = '400px';
            video.style.backgroundColor = '#000';
            
            const source = document.createElement('source');
            source.src = videoUrl + '?v=' + Date.now(); // Cache buster
            source.type = 'video/mp4';
            
            video.appendChild(source);
            video.appendChild(document.createTextNode('Your browser does not support the video tag.'));
            
            // Success handler
            video.onloadeddata = function() {
                console.log(`âœ… Video loaded successfully: ${videoUrl}`);
                if (videoInfo) {
                    videoInfo.innerHTML = `
                        <p><i class="fas fa-check-circle" style="color: #27ae60;"></i> <strong>${lesson.content_title || 'Video Lesson'}</strong></p>
                        <p><i class="fas fa-clock"></i> Duration: ${Math.floor((lesson.video_duration_seconds || 600) / 60)} min</p>
                    `;
                }
                // Initialize progress tracking
                initVideoProgressTracking(video, contentId);
            };
            
            // Error handler
            video.onerror = function() {
                console.error('âŒ Video failed to load:', videoUrl);
                videoContainer.innerHTML = `
                    <div style="background: #fee; height: 400px; display: flex; align-items: center; justify-content: center; flex-direction: column;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 60px; color: #e74c3c; margin-bottom: 20px;"></i>
                        <h3 style="color: #c0392b;">Video not found</h3>
                        <p style="color: #e74c3c;">The video file may be missing or inaccessible.</p>
                        <p style="color: #666; font-size: 12px; margin-top: 10px;">Path: ${videoUrl}</p>
                    </div>
                `;
                if (videoInfo) {
                    videoInfo.innerHTML = `
                        <p style="color: #e74c3c;">
                            <i class="fas fa-exclamation-triangle"></i> 
                            Video failed to load. Please check if the file exists.
                        </p>
                    `;
                }
            };
            
            videoContainer.appendChild(video);
            video.load();
        } else {
            // No video available
            videoContainer.innerHTML = `
                <div style="background: #f0f0f0; height: 400px; display: flex; align-items: center; justify-content: center; flex-direction: column;">
                    <i class="fas fa-video-slash" style="font-size: 60px; color: #999; margin-bottom: 20px;"></i>
                    <h3 style="color: #666;">No video available for this lesson</h3>
                    <p style="color: #999;">The video will appear here once uploaded.</p>
                </div>
            `;
            
            if (videoInfo) {
                videoInfo.innerHTML = `
                    <p style="color: #f39c12;">
                        <i class="fas fa-info-circle"></i> 
                        This lesson has no video assigned.
                    </p>
                `;
            }
        }
        
    } catch (error) {
        console.error('âŒ Error loading video:', error);
        
        videoContainer.innerHTML = `
            <div style="background: #fee; height: 400px; display: flex; align-items: center; justify-content: center; flex-direction: column;">
                <i class="fas fa-exclamation-triangle" style="font-size: 60px; color: #e74c3c; margin-bottom: 20px;"></i>
                <h3 style="color: #c0392b;">Failed to load video</h3>
                <p style="color: #e74c3c;">${error.message}</p>
                <button onclick="location.reload()" class="btn-primary" style="margin-top: 20px; padding: 10px 20px;">
                    <i class="fas fa-redo"></i> Reload Page
                </button>
            </div>
        `;
    } finally {
        if (refreshVideoBtn) {
            refreshVideoBtn.innerHTML = '<i class="fas fa-sync-alt"></i>';
            refreshVideoBtn.disabled = false;
        }
    }
}


// Get default video (fallback)
async function getDefaultVideo() {
    try {
        const response = await fetch(`/api/videos/default`);
        const data = await response.json();
        
        if (data.success) {
            console.log('âœ… Using default video from API');
            AppState.currentVideoData = data.video;
            return data.video;
        } else {
            throw new Error('Failed to get default video');
        }
    } catch (error) {
        console.error('Error getting default video:', error);
        return null;
    }
}

// Setup video progress tracking
function setupVideoProgressTracking() {
    const videoElement = document.getElementById('lessonVideo');
    const videoTimeDisplay = document.getElementById('videoTime');
    
    if (!videoElement || !videoTimeDisplay) return;
    
    console.log("ðŸŽ¬ Setting up video progress tracking...");
    
    let isVideoPlaying = false;
    let videoStartTime = 0;
    let totalWatchedSeconds = 0;
    let lastSaveTime = 0;
    const SAVE_INTERVAL = 15000;
    
    const videoData = AppState.currentVideoData;
    const videoKey = videoData ? `video_${videoData.content_id}` : 'video_default';
    
    const savedWatchTime = localStorage.getItem(`video_watch_time_${videoKey}`);
    if (savedWatchTime) {
        totalWatchedSeconds = parseInt(savedWatchTime);
        console.log(`â±ï¸ Loaded previous watch time: ${totalWatchedSeconds} seconds`);
    }
    
    function formatTime(seconds) {
        if (isNaN(seconds)) return "0:00";
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }
    
    function updateWatchTimeDisplay() {
        if (!videoTimeDisplay) return;
        
        const savedTime = localStorage.getItem(`video_watch_time_${videoKey}`);
        const watchedSeconds = savedTime ? parseInt(savedTime) : 0;
        
        const currentTime = formatTime(videoElement.currentTime || 0);
        const duration = formatTime(videoElement.duration || 0);
        
        videoTimeDisplay.textContent = `${currentTime} / ${duration}`;
        videoTimeDisplay.title = `Total time watched: ${Math.floor(watchedSeconds/60)}m ${watchedSeconds%60}s`;
    }
    
    async function updateVideoProgress(watchedSeconds, isCompleted = false) {
        try {
            let percentage = 0;
            if (videoElement.duration > 0) {
                percentage = Math.min(100, Math.floor((watchedSeconds / videoElement.duration) * 100));
            }
            
            const progressData = {
                time_spent_seconds: watchedSeconds,
                completion_status: isCompleted ? 'completed' : 'in_progress',
                current_time: videoElement.currentTime || 0,
                total_duration: videoElement.duration || 0
            };
            
            const contentId = videoData?.content_id || LessonState.currentLesson?.content_id || 1;
            
            const token = localStorage.getItem('authToken') || authToken;
            if (token && contentId) {
                // Update lesson progress
                await updateLessonProgress(contentId, {
                    completion_status: isCompleted ? 'completed' : 'in_progress',
                    percentage: percentage,
                    time_spent_seconds: watchedSeconds
                });
                
                console.log(`âœ… Video progress saved: ${watchedSeconds}s (${percentage}%)`);
                
                // Log activity if lesson is completed
                if (isCompleted && LessonState.currentLesson) {
                    await logUserActivity('lesson_completed', contentId, {
                        lesson_title: LessonState.currentLesson.content_title,
                        time_spent: watchedSeconds,
                        percentage: percentage
                    }, 50);
                }
            }
        } catch (error) {
            console.error('Error updating video progress:', error);
        }
    }
    
    videoElement.addEventListener('play', function() {
        console.log("â–¶ï¸ Video STARTED playing");
        isVideoPlaying = true;
        videoStartTime = Date.now();
        
        if (videoTimeDisplay) {
            videoTimeDisplay.classList.add('watching');
        }
    });
    
    videoElement.addEventListener('pause', function() {
        console.log("â¸ï¸ Video PAUSED");
        
        if (isVideoPlaying) {
            const watchDuration = Math.floor((Date.now() - videoStartTime) / 1000);
            totalWatchedSeconds += watchDuration;
            isVideoPlaying = false;
            
            console.log(`â±ï¸ Watched for ${watchDuration} seconds (Total: ${totalWatchedSeconds}s)`);
            
            updateVideoProgress(totalWatchedSeconds);
            
            if (videoTimeDisplay) {
                videoTimeDisplay.classList.remove('watching');
            }
            
            updateWatchTimeDisplay(totalWatchedSeconds);
        }
    });
    
    videoElement.addEventListener('timeupdate', function() {
        const currentTime = formatTime(videoElement.currentTime);
        const duration = formatTime(videoElement.duration || 0);
        if (videoTimeDisplay) {
            videoTimeDisplay.textContent = `${currentTime} / ${duration}`;
        }
        
        if (isVideoPlaying) {
            const currentTimeMs = Date.now();
            if (currentTimeMs - lastSaveTime > SAVE_INTERVAL) {
                lastSaveTime = currentTimeMs;
                
                const watchDuration = Math.floor((currentTimeMs - videoStartTime) / 1000);
                const currentWatchedSeconds = totalWatchedSeconds + watchDuration;
                
                updateVideoProgress(currentWatchedSeconds);
                
                console.log(`ðŸ’¾ Auto-saved progress: ${currentWatchedSeconds} seconds watched`);
            }
        }
    });
    
    videoElement.addEventListener('ended', function() {
        console.log("âœ… Video COMPLETED!");
        
        if (isVideoPlaying) {
            const watchDuration = Math.floor((Date.now() - videoStartTime) / 1000);
            totalWatchedSeconds += watchDuration;
            isVideoPlaying = false;
            
            console.log(`ðŸŽ‰ Finished watching! Total: ${totalWatchedSeconds} seconds`);
            
            updateVideoProgress(totalWatchedSeconds, true);
            
            localStorage.removeItem(`video_watch_time_${videoKey}`);
            
            showNotification(`Video completed! You watched for ${Math.floor(totalWatchedSeconds/60)} minutes.`, 'success');
            
            // Auto-check if practice should be unlocked
            const topicId = LessonState.currentTopic;
            if (topicId) {
                setTimeout(() => {
                    checkPracticeUnlocked(topicId).then(unlocked => {
                        if (unlocked) {
                            showNotification('Practice exercises are now unlocked!', 'success');
                            // Refresh the lesson content to show practice button
                            addPracticeButtonToLesson();
                        }
                    });
                }, 1000);
            }
        }
    });
    
    window.addEventListener('beforeunload', function() {
        if (isVideoPlaying) {
            const watchDuration = Math.floor((Date.now() - videoStartTime) / 1000);
            totalWatchedSeconds += watchDuration;
            
            localStorage.setItem(`video_watch_time_${videoKey}`, totalWatchedSeconds.toString());
            
            console.log(`ðŸ’¾ Saved before unload: ${totalWatchedSeconds} seconds`);
        }
    });
    
    updateWatchTimeDisplay(totalWatchedSeconds);
}

// ============================================
// MODULE DASHBOARD JS - COMPLETE RAILWAY FIX
// ============================================

function initModuleDashboardJS() {
    console.log('ðŸ“š Initializing module dashboard with Railway fixes...');
    
    // Get current lesson
    const currentLesson = LessonState.currentLesson;
    if (!currentLesson) {
        console.error('âŒ No current lesson found');
        showNotification('No lesson data available', 'error');
        navigateTo('dashboard');
        return;
    }
    
    console.log('ðŸ“– Current lesson:', currentLesson.content_title, '(ID:', currentLesson.content_id, ')');
    
    // ============================================
    // 1. UPDATE UI WITH LESSON DATA
    // ============================================
    updateLessonUI(currentLesson);
    
    // ============================================
    // 2. SETUP ALL BUTTONS (with cloneNode to remove old listeners)
    // ============================================
    setupBackButton();
    setupNavigationButtons();
    setupPracticeButtons();
    setupCompleteLessonButton();
    
    // ============================================
    // 3. LOAD VIDEO AND CONTENT
    // ============================================
    loadVideoAndContent(currentLesson);
    
    console.log('âœ… Module dashboard initialized with Railway fixes');
}

// ============================================
// HELPER: Update UI with lesson data
// ============================================
function updateLessonUI(lesson) {
    // Module title
    const moduleTitle = document.getElementById('moduleTitle');
    if (moduleTitle) {
        moduleTitle.textContent = lesson.content_title || 'PolyLearn Lesson';
    }
    
    // Lesson title in sidebar
    const moduleLessonTitle = document.getElementById('moduleLessonTitle');
    if (moduleLessonTitle) {
        const title = lesson.content_title || 'Lesson';
        moduleLessonTitle.innerHTML = `<i class="fas fa-book"></i> ${title}`;
    }
    
    // Subtitle
    const moduleSubtitle = document.getElementById('moduleSubtitle');
    if (moduleSubtitle) {
        const subtitle = `${lesson.lesson_name || ''} - ${lesson.module_name || ''}`;
        moduleSubtitle.textContent = subtitle;
    }
    
    // Progress bar
    updateProgressDisplay(lesson);
}

// ============================================
// HELPER: Update progress display
// ============================================
async function updateProgressDisplay(lesson) {
    const contentId = lesson.content_id;
    
    // Get progress from state or server
    let percentage = 0;
    let status = 'not_started';
    
    if (LessonState.userProgress && LessonState.userProgress[contentId]) {
        percentage = LessonState.userProgress[contentId].percentage || 0;
        status = LessonState.userProgress[contentId].status || 'not_started';
    } else {
        // Try to fetch from server
        try {
            const token = localStorage.getItem('authToken') || authToken;
            if (token) {
                const data = await apiRequest(`/api/lessons-db/${contentId}`);
                if (data.success && data.lesson && data.lesson.progress) {
                    percentage = data.lesson.progress.percentage || 0;
                    status = data.lesson.progress.status || 'not_started';
                    
                    // Save to state
                    if (!LessonState.userProgress) LessonState.userProgress = {};
                    LessonState.userProgress[contentId] = data.lesson.progress;
                }
            }
        } catch (error) {
            console.log('Could not fetch progress:', error);
        }
    }
    
    // Update progress bar
    const lessonProgressFill = document.getElementById('lessonProgressFill');
    if (lessonProgressFill) {
        lessonProgressFill.style.width = `${percentage}%`;
    }
    
    // Update percentage text
    const progressPercentage = document.getElementById('progressPercentage');
    if (progressPercentage) {
        progressPercentage.textContent = `${percentage}% Complete`;
    }
    
    // Store in LessonState for button to use
    if (!LessonState.userProgress) LessonState.userProgress = {};
    if (!LessonState.userProgress[contentId]) LessonState.userProgress[contentId] = {};
    LessonState.userProgress[contentId].percentage = percentage;
    LessonState.userProgress[contentId].status = status;
}

// ============================================
// HELPER: Setup back button
// ============================================
function setupBackButton() {
    const backBtn = document.getElementById('backToLessonDashboard');
    if (!backBtn) return;
    
    // Clone to remove old listeners
    const newBackBtn = backBtn.cloneNode(true);
    backBtn.parentNode.replaceChild(newBackBtn, backBtn);
    
    newBackBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('Back button clicked - returning to dashboard');
        navigateTo('dashboard');
    });
    
    console.log('âœ… Back button setup complete');
}

// ============================================
// HELPER: Setup navigation buttons (PREV/NEXT) - UPDATED
// ============================================
function setupNavigationButtons() {
    console.log('ðŸ”˜ Setting up navigation buttons...');
    
    const currentLesson = LessonState.currentLesson;
    if (!currentLesson) {
        console.error('âŒ No current lesson found');
        return;
    }
    
    console.log('ðŸ“– Current lesson:', currentLesson.content_title, 'ID:', currentLesson.content_id);
    console.log('ðŸ“‹ Adjacent lessons:', currentLesson.adjacent);
    
    // ===== PREVIOUS BUTTON =====
    const prevBtn = document.getElementById('prevLessonBtn');
    if (prevBtn) {
        // Remove all existing listeners
        const newPrevBtn = prevBtn.cloneNode(true);
        prevBtn.parentNode.replaceChild(newPrevBtn, prevBtn);
        
        if (currentLesson.adjacent?.previous) {
            newPrevBtn.disabled = false;
            newPrevBtn.innerHTML = `<i class="fas fa-arrow-left"></i> Previous: ${currentLesson.adjacent.previous.title}`;
            
            newPrevBtn.addEventListener('click', async function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const prevId = currentLesson.adjacent.previous.id;
                console.log('â¬…ï¸ Loading previous lesson:', prevId);
                
                // Open the previous lesson
                await openLesson(prevId);
            });
            
            console.log('âœ… Previous button enabled');
        } else {
            newPrevBtn.disabled = true;
            newPrevBtn.innerHTML = `<i class="fas fa-arrow-left"></i> No Previous Lesson`;
            console.log('â„¹ï¸ No previous lesson available');
        }
    }
    
    // ===== NEXT BUTTON =====
    const nextBtn = document.getElementById('nextLessonBtn');
    if (nextBtn) {
        // Remove all existing listeners
        const newNextBtn = nextBtn.cloneNode(true);
        nextBtn.parentNode.replaceChild(newNextBtn, nextBtn);
        
        if (currentLesson.adjacent?.next) {
            newNextBtn.disabled = false;
            newNextBtn.innerHTML = `Next: ${currentLesson.adjacent.next.title} <i class="fas fa-arrow-right"></i>`;
            
            newNextBtn.addEventListener('click', async function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const nextId = currentLesson.adjacent.next.id;
                console.log('âž¡ï¸ Loading next lesson:', nextId);
                
                // Open the next lesson
                await openLesson(nextId);
            });
            
            console.log('âœ… Next button enabled');
        } else {
            newNextBtn.disabled = true;
            newNextBtn.innerHTML = `No Next Lesson <i class="fas fa-arrow-right"></i>`;
            console.log('â„¹ï¸ No next lesson available');
        }
    }
    
    console.log('âœ… Navigation buttons setup complete');
}

// ============================================
// HELPER: Setup practice buttons
// ============================================
function setupPracticeButtons() {
    // Show Hint button
    const hintBtn = document.getElementById('showHintBtn');
    if (hintBtn) {
        const newHintBtn = hintBtn.cloneNode(true);
        hintBtn.parentNode.replaceChild(newHintBtn, hintBtn);
        newHintBtn.addEventListener('click', () => {
            alert('Hint: Try grouping the first two terms together and the last two terms together.');
        });
    }
    
    // Show Solution button
    const solutionBtn = document.getElementById('showSolutionBtn');
    if (solutionBtn) {
        const newSolutionBtn = solutionBtn.cloneNode(true);
        solutionBtn.parentNode.replaceChild(newSolutionBtn, solutionBtn);
        newSolutionBtn.addEventListener('click', () => {
            alert('Solution: \n(4xÂ³ - 8xÂ²) + (5x - 10) = 4xÂ²(x - 2) + 5(x - 2) = (x - 2)(4xÂ² + 5)');
        });
    }
    
    // Check Answer button
    const checkBtn = document.getElementById('checkAnswerBtn');
    if (checkBtn) {
        const newCheckBtn = checkBtn.cloneNode(true);
        checkBtn.parentNode.replaceChild(newCheckBtn, checkBtn);
        newCheckBtn.addEventListener('click', () => {
            const answer = prompt('Enter your factored expression:');
            if (answer && answer.replace(/\s/g, '') === '(x-2)(4xÂ²+5)') {
                alert('Correct! Well done.');
            } else {
                alert('The correct answer is: (x - 2)(4xÂ² + 5)');
            }
        });
    }
    
    // Practice More button
    const moreBtn = document.getElementById('practiceMoreBtn');
    if (moreBtn) {
        const newMoreBtn = moreBtn.cloneNode(true);
        moreBtn.parentNode.replaceChild(newMoreBtn, moreBtn);
        newMoreBtn.addEventListener('click', () => {
            const problems = [
                "6xÂ³ + 9xÂ² + 4x + 6",
                "3xÂ³ - 12xÂ² + 2x - 8",
                "5xÂ³ + 10xÂ² + 3x + 6",
                "2xÂ³ - 4xÂ² + 7x - 14"
            ];
            const randomProblem = problems[Math.floor(Math.random() * problems.length)];
            alert(`New practice problem: ${randomProblem}`);
        });
    }
    
    console.log('âœ… Practice buttons setup complete');
}

// ============================================
// HELPER: Setup complete lesson button
// ============================================
function setupCompleteLessonButton() {
    const completeBtn = document.getElementById('completeLessonBtn');
    if (!completeBtn) return;
    
    const newCompleteBtn = completeBtn.cloneNode(true);
    completeBtn.parentNode.replaceChild(newCompleteBtn, completeBtn);
    
    // Check initial status
    const contentId = LessonState.currentLesson?.content_id;
    if (contentId && LessonState.userProgress?.[contentId]?.status === 'completed') {
        newCompleteBtn.disabled = true;
        newCompleteBtn.innerHTML = '<i class="fas fa-check"></i> Lesson Completed';
        newCompleteBtn.style.background = '#2ecc71';
    }
    
    let isProcessing = false;
    
    newCompleteBtn.addEventListener('click', async function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const contentId = LessonState.currentLesson?.content_id;
        if (!contentId) {
            showNotification('Cannot identify lesson', 'error');
            return;
        }
        
        if (isProcessing) {
            console.log('âš ï¸ Already processing, please wait...');
            return;
        }
        
        isProcessing = true;
        const originalText = newCompleteBtn.innerHTML;
        const originalDisabled = newCompleteBtn.disabled;
        
        newCompleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        newCompleteBtn.disabled = true;
        
        try {
            // Check if already completed
            if (LessonState.userProgress?.[contentId]?.status === 'completed') {
                showNotification('Lesson already completed!', 'info');
                newCompleteBtn.innerHTML = '<i class="fas fa-check"></i> Already Completed';
                newCompleteBtn.style.background = '#2ecc71';
                return;
            }
            
            // Calculate time spent
            let timeSpentSeconds = 300;
            const videoElement = document.getElementById('lessonVideo');
            if (videoElement && videoElement.duration) {
                timeSpentSeconds = Math.floor(videoElement.currentTime || videoElement.duration);
            }
            
            // Update progress
            const success = await updateLessonProgress(contentId, {
                completion_status: 'completed',
                percentage: 100,
                time_spent_seconds: timeSpentSeconds
            });
            
            if (success) {
                newCompleteBtn.innerHTML = '<i class="fas fa-check"></i> Lesson Completed';
                newCompleteBtn.style.background = '#2ecc71';
                
                showNotification('ðŸŽ‰ Lesson marked as complete!', 'success');
                
                // Update local state
                if (!LessonState.userProgress) LessonState.userProgress = {};
                if (!LessonState.userProgress[contentId]) LessonState.userProgress[contentId] = {};
                LessonState.userProgress[contentId].status = 'completed';
                LessonState.userProgress[contentId].percentage = 100;
                
                // Clear watch time
                localStorage.removeItem(`video_watch_time_video_${contentId}`);
                
                // Update daily progress
                await updateDailyProgress({ lessons_completed: 1 });
                
                // Update dashboard
                setTimeout(() => {
                    updateProgressSummaryCards();
                    if (AppState.currentPage === 'dashboard') {
                        updateContinueLearningModule();
                    }
                }, 1000);
            } else {
                throw new Error('Failed to save completion');
            }
        } catch (error) {
            console.error('Error:', error);
            showNotification('Error: ' + error.message, 'error');
            newCompleteBtn.innerHTML = originalText;
            newCompleteBtn.disabled = originalDisabled;
        } finally {
            setTimeout(() => {
                isProcessing = false;
            }, 1000);
        }
    });
    
    console.log('âœ… Complete button setup complete');
}

// ============================================
// HELPER: Load video and content
// ============================================
async function loadVideoAndContent(lesson) {
    // Add styles
    addLessonContentStyles();
    
    // Load video
    await loadVideoFromDatabase(lesson.content_id);
    
    // Load content
    await displayLessonContent();
}

// ============================================
// âœ… FIXED: Initialize module dashboard with specific lesson
// ============================================
async function initializeModuleDashboard() {
    const currentLesson = LessonState.currentLesson;
    
    if (!currentLesson) {
        console.error('No current lesson found');
        showNotification('No lesson data available', 'error');
        navigateTo('dashboard');
        return;
    }
    
    console.log('ðŸ“– Initializing module dashboard for lesson:', currentLesson.content_title);
    console.log('ðŸ“Œ Lesson ID:', currentLesson.content_id);
    
    // Update UI with lesson data
    const moduleTitle = document.getElementById('moduleTitle');
    const moduleLessonTitle = document.getElementById('moduleLessonTitle');
    const moduleSubtitle = document.getElementById('moduleSubtitle');
    
    if (moduleTitle) {
        moduleTitle.textContent = currentLesson.content_title || 'PolyLearn Lesson';
    }
    
    if (moduleLessonTitle) {
        const title = currentLesson.content_title || 'Lesson';
        moduleLessonTitle.innerHTML = `<i class="fas fa-book"></i> ${title}`;
    }
    
    if (moduleSubtitle) {
        const subtitle = `${currentLesson.lesson_name || ''} - ${currentLesson.module_name || ''}`;
        moduleSubtitle.textContent = subtitle;
    }
    
    // Update progress
    const lessonProgress = currentLesson.progress || {};
    const percentage = lessonProgress.percentage || 0;
    const status = lessonProgress.status || 'not_started';
    
    const lessonProgressFill = document.getElementById('lessonProgressFill');
    if (lessonProgressFill) {
        lessonProgressFill.style.width = `${percentage}%`;
    }
    
    const progressPercentage = document.getElementById('progressPercentage');
    if (progressPercentage) {
        progressPercentage.textContent = `${percentage}% Complete`;
    }
    
    // Update complete button based on status
    const completeLessonBtn = document.getElementById('completeLessonBtn');
    if (completeLessonBtn) {
        if (status === 'completed') {
            completeLessonBtn.disabled = true;
            completeLessonBtn.innerHTML = '<i class="fas fa-check"></i> Lesson Completed';
            completeLessonBtn.style.background = '#2ecc71';
        } else {
            completeLessonBtn.disabled = false;
            completeLessonBtn.innerHTML = '<i class="fas fa-check-circle"></i> Mark Lesson Complete';
            completeLessonBtn.style.background = '';
        }
    }
    
    // Load the specific video for this lesson
    await loadVideoFromDatabase(currentLesson.content_id);
    
    // Display lesson content
    addLessonContentStyles();
    await displayLessonContent();
    
    console.log(`âœ… Module dashboard initialized for lesson ${currentLesson.content_id}`);
}

// ============================================
// FIXED: Initialize Video - ALWAYS uses database
// ============================================
async function initializeVideo(contentId) {
    console.log('ðŸŽ¬ PERMANENT FIX: Initializing video from database for content ID:', contentId);
    
    const videoElement = document.getElementById('lessonVideo');
    const videoInfo = document.getElementById('videoInfo');
    
    if (videoElement) {
        // Show loading message
        videoElement.innerHTML = '<p style="text-align: center; padding: 20px;"><i class="fas fa-spinner fa-spin"></i> Loading video from database...</p>';
    }
    
    if (videoInfo) {
        videoInfo.innerHTML = '<p><i class="fas fa-spinner fa-spin"></i> Fetching video data...</p>';
    }
    
    // Load video from database
    const videoData = await loadVideoFromDatabase(contentId);
    
    if (videoData) {
        console.log('âœ… Video loaded from database:', videoData);
        
        // Update video info with success
        if (videoInfo) {
            videoInfo.innerHTML = `
                <p><i class="fas fa-check-circle" style="color: #27ae60;"></i> <strong>${videoData.title}</strong></p>
                <p><i class="fas fa-clock"></i> Duration: ${Math.floor((videoData.duration || 600) / 60)} min</p>
                <p><i class="fas fa-link"></i> ${videoData.url}</p>
            `;
        }
    } else {
        console.warn('âš ï¸ No video loaded from database');
        
        // Show error in video info
        if (videoInfo) {
            videoInfo.innerHTML = `
                <p style="color: #e74c3c;">
                    <i class="fas fa-exclamation-triangle"></i> 
                    No video found in database. Please upload a video first.
                </p>
                <button class="btn-secondary" onclick="location.reload()" style="margin-top: 10px;">
                    <i class="fas fa-redo"></i> Refresh
                </button>
            `;
        }
        
        // Try default video as fallback
        if (videoElement) {
            videoElement.innerHTML = '';
            const sourceElement = document.createElement('source');
            sourceElement.src = '/videos/quarter1-polynomial-equations.mp4';
            sourceElement.type = 'video/mp4';
            videoElement.appendChild(sourceElement);
            videoElement.load();
        }
    }
}


// Navigate to previous lesson
async function navigateToPreviousLesson() {
    const currentLesson = LessonState.currentLesson;
    if (!currentLesson?.adjacent?.previous) return;
    
    const prevLessonId = currentLesson.adjacent.previous.id;
    await openLesson(prevLessonId);
}

// Navigate to next lesson
async function navigateToNextLesson() {
    const currentLesson = LessonState.currentLesson;
    if (!currentLesson?.adjacent?.next) return;
    
    const nextLessonId = currentLesson.adjacent.next.id;
    await openLesson(nextLessonId);
}

// ============================================
// PRACTICE EXERCISES MANAGEMENT - FIXED
// ============================================

// Check if practice is unlocked for a topic
// ============================================
// FIXED: Check Practice Unlocked - RELIABLE VERSION
// ============================================
// I-update ang checkPracticeUnlocked function
// ============================================
// FIXED: checkPracticeUnlocked - With better error handling
// ============================================
async function checkPracticeUnlocked(topicId) {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) return false;
        
        console.log(`ðŸ” Checking practice unlock status for topic ${topicId}...`);
        
        // Try multiple endpoints
        const endpoints = [
            `/practice/${topicId}/check-progress`,
            `/api/practice/${topicId}/status`,
            `/progress/topic/${topicId}/practice-status`
        ];
        
        for (const endpoint of endpoints) {
            try {
                const response = await fetch(endpoint, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/json'
                    }
                });
                
                const contentType = response.headers.get('content-type');
                if (response.ok && contentType && contentType.includes('application/json')) {
                    const data = await response.json();
                    if (data.success && data.unlocked !== undefined) {
                        console.log(`âœ… Practice unlock check via ${endpoint}: ${data.unlocked ? 'UNLOCKED' : 'LOCKED'}`);
                        return data.unlocked;
                    }
                }
            } catch (e) {
                console.log(`âš ï¸ Endpoint ${endpoint} failed:`, e.message);
            }
        }
        
        // If all endpoints fail, assume unlocked for demo purposes
        console.log('â„¹ï¸ Using demo mode - practice unlocked by default');
        return true;
        
    } catch (error) {
        console.error('âŒ Error in checkPracticeUnlocked:', error);
        return true; // Default to unlocked in demo mode
    }
}

// MAG-ADD NG FUNCTION PARA I-CREATE ANG DEFAULT PROGRESS
async function createDefaultPracticeProgress(topicId) {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) return false;
        
        console.log('ðŸ”„ Creating default practice progress for new user...');
        
        const response = await fetch(`/api/practice/init-progress`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                topic_id: topicId
            })
        });
        
        if (response.ok) {
            const data = await response.json();
            console.log('âœ… Default practice progress created:', data);
            return true;
        }
        
        return false;
    } catch (error) {
        console.error('âŒ Error creating practice progress:', error);
        return false;
    }
}

// Load practice exercises for a topic - FIXED VERSION
// ===== FIXED: Load practice exercises for admin =====
async function loadPracticeExercises() {
    console.log("ðŸ“¥ Loading practice exercises from MySQL...");
    
    try {
        const token = localStorage.getItem('admin_token') || localStorage.getItem('authToken');
        
        if (!token) {
            console.error("âŒ No token found");
            return;
        }
        
        // FIXED: Use correct admin endpoint
        const response = await fetch('/api/admin/practice/exercises', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success && result.exercises) {
            adminPracticeData.exercises = result.exercises;
            displayPracticeExercises();
            console.log(`âœ… Loaded ${result.exercises.length} practice exercises`);
        } else {
            // If no exercises, load demo data for testing
            loadDemoPracticeExercises();
        }
        
    } catch (error) {
        console.error('âŒ Error loading exercises:', error);
        loadDemoPracticeExercises();
    }
}
// ============================================
// FIXED: submitPracticeAnswer - WITHOUT userCheck
// ============================================
// ===== FIXED: Submit practice answers with correct endpoint =====
// ============================================
// âœ… FIXED: submitPracticeAnswer - WITH TIME RECORDING
// ============================================

// Initialize practice page - FIXED VERSION
async function initPracticePage() {
    console.log('ðŸ’ª Initializing practice page with database-driven content...');
    
    // Update date
    const practiceDate = document.getElementById('practiceDate');
    if (practiceDate) {
        const now = new Date();
        practiceDate.textContent = now.toLocaleDateString('en-US', { 
            weekday: 'long',
            month: 'short', 
            day: 'numeric' 
        });
    }
    
    // Reset current topic if needed
    if (!PracticeState.currentTopic) {
        PracticeState.currentTopic = '1'; // Default to topic 1
    }
    
    // âœ… I-LOAD AGAD ANG PRACTICE STATISTICS MULA DATABASE
    await loadPracticeStatistics();
    
    // Load topics progress
    await loadTopicsProgress();
    
    // Load practice exercises for current topic
    await loadPracticeExercisesForTopic(PracticeState.currentTopic);
    
    // Add practice styles
    addPracticeStyles();
    
    console.log('âœ… Practice page initialized');
}

// ============================================
// DEBUG: Check Database Practice Records
// ============================================
window.checkPracticeRecords = async function() {
    console.log('ðŸ” CHECKING PRACTICE RECORDS IN DATABASE...');
    
    try {
        const token = localStorage.getItem('authToken');
        
        // Tingnan ang practice attempts
        const attemptsResponse = await fetch(`/api/progress/practice-attempts`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (attemptsResponse.ok) {
            const attemptsData = await attemptsResponse.json();
            console.log('ðŸ“Š PRACTICE ATTEMPTS FROM DATABASE:', attemptsData);
            
            if (attemptsData.success && attemptsData.attempts) {
                const completed = attemptsData.attempts.filter(a => a.completion_status === 'completed');
                console.log(`âœ… COMPLETED EXERCISES: ${completed.length}`);
                console.log(`ðŸ“ TOTAL ATTEMPTS: ${attemptsData.attempts.length}`);
            }
        } else {
            console.error('âŒ Failed to fetch practice attempts:', attemptsResponse.status);
        }
        
        // I-refresh ang display
        await loadPracticeStatistics();
        console.log('âœ… Practice statistics refreshed');
        
    } catch (error) {
        console.error('âŒ Error checking practice records:', error);
    }
};

// ============================================
// âœ… FIXED: loadTopicsProgress
// ============================================
async function loadTopicsProgress() {
    try {
        const topicsContainer = document.getElementById('topicsContainer');
        if (!topicsContainer) return;
        
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) {
            topicsContainer.innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>Please login to view topics</h3>
                </div>
            `;
            return;
        }
        
        const response = await fetch(`/api/topics/progress`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!response.ok) {
            topicsContainer.innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>Failed to load topics</h3>
                </div>
            `;
            return;
        }
        
        const data = await response.json();
        
        if (data.success && data.topics) {
            displayTopics(data.topics);
            
            const unlockedCount = data.topics.filter(t => t.practice_unlocked).length;
            const unlockedCountElement = document.getElementById('unlockedCount');
            if (unlockedCountElement) {
                unlockedCountElement.textContent = unlockedCount;
            }
        } else {
            topicsContainer.innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>No topics found</h3>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading topics progress:', error);
        const topicsContainer = document.getElementById('topicsContainer');
        if (topicsContainer) {
            topicsContainer.innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>Failed to load topics</h3>
                </div>
            `;
        }
    }
}



// Display topics
function displayTopics(topics) {
    const topicsContainer = document.getElementById('topicsContainer');
    if (!topicsContainer || !topics) {
        topicsContainer.innerHTML = '<p class="no-topics">No topics available</p>';
        return;
    }
    
    let html = '';
    
    topics.forEach(topic => {
        const progressPercentage = topic.lesson_progress_percentage || 0;
        const isPracticeUnlocked = topic.practice_unlocked || false;
        const isPracticeCompleted = topic.practice_completed || false;
        
        html += `
            <div class="topic-card ${isPracticeUnlocked ? 'unlocked' : 'locked'} ${isPracticeCompleted ? 'completed' : ''} ${PracticeState.currentTopic == topic.topic_id ? 'selected' : ''}" 
                 data-topic-id="${topic.topic_id}"
                 data-practice-unlocked="${isPracticeUnlocked}">
                <div class="topic-header">
                    <h3 class="topic-title">${topic.topic_title}</h3>
                    <div class="topic-status">
                        ${isPracticeCompleted ? 
                            '<span class="status-completed"><i class="fas fa-check-circle"></i> Completed</span>' :
                            isPracticeUnlocked ?
                            '<span class="status-unlocked"><i class="fas fa-unlock"></i> Unlocked</span>' :
                            '<span class="status-locked"><i class="fas fa-lock"></i> Locked</span>'
                        }
                    </div>
                </div>
                
                <div class="topic-body">
                    <p>${topic.module_name || 'Module'} - ${topic.topic_title}</p>
                    
                    <div class="topic-progress">
                        <div class="progress-info">
                            <span>Lessons: ${topic.lessons_completed || 0}/${topic.total_lessons || 0}</span>
                            <span>${progressPercentage}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progressPercentage}%"></div>
                        </div>
                    </div>
                    
                    <div class="topic-practice-info">
                        ${isPracticeCompleted ? 
                            '<span class="practice-completed"><i class="fas fa-trophy"></i> Practice Completed</span>' :
                            isPracticeUnlocked ?
                            '<span class="practice-available"><i class="fas fa-pencil-alt"></i> Practice Available</span>' :
                            `<span class="practice-locked">Complete ${(topic.total_lessons || 0) - (topic.lessons_completed || 0)} more lessons</span>`
                        }
                    </div>
                </div>
                
                <div class="topic-actions">
                    ${isPracticeUnlocked ? 
                        `<button class="btn-primary practice-topic-btn" data-topic-id="${topic.topic_id}">
                            <i class="fas fa-play"></i> Start Practice
                        </button>` :
                        `<button class="btn-secondary" disabled>
                            <i class="fas fa-lock"></i> Complete Lessons First
                        </button>`
                    }
                </div>
            </div>
        `;
    });
    
    topicsContainer.innerHTML = html || '<p class="no-topics">No topics available</p>';
    
    // Add event listeners to topic cards
    document.querySelectorAll('.topic-card.unlocked').forEach(card => {
        card.addEventListener('click', function() {
            const topicId = this.getAttribute('data-topic-id');
            selectTopicForPractice(topicId);
        });
    });
    
    // Add event listeners to practice buttons
    document.querySelectorAll('.practice-topic-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            e.stopPropagation();
            const topicId = this.getAttribute('data-topic-id');
            selectTopicForPractice(topicId);
        });
    });
}

// Select topic for practice
async function selectTopicForPractice(topicId) {
    try {
        PracticeState.currentTopic = topicId;
        
        // Update UI
        document.querySelectorAll('.topic-card').forEach(card => {
            card.classList.remove('selected');
            if (card.getAttribute('data-topic-id') === topicId) {
                card.classList.add('selected');
            }
        });
        
        // Load practice exercises for this topic
        await loadPracticeExercisesForTopic(topicId);
        
        // Update topic title
        const practiceTopicTitle = document.getElementById('practiceTopicTitle');
        if (practiceTopicTitle) {
            const selectedTopic = document.querySelector(`.topic-card[data-topic-id="${topicId}"] .topic-title`);
            if (selectedTopic) {
                practiceTopicTitle.textContent = `Practicing: ${selectedTopic.textContent}`;
            }
        }
        
    } catch (error) {
        console.error('Error selecting topic:', error);
        showNotification('Failed to select topic', 'error');
    }
}

// ============================================
// FIXED: Load practice exercises for specific topic - With better error handling
// ============================================
async function loadPracticeExercisesForTopic(topicId) {
    try {
        console.log(`ðŸ“ Getting practice exercises for topic ${topicId}`);
        
        const exerciseArea = document.getElementById('exerciseArea');
        if (!exerciseArea) {
            console.error('Exercise area not found');
            return;
        }
        
        exerciseArea.innerHTML = `
            <div class="loading-container">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Loading practice exercises from database...</p>
            </div>
        `;
        
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) {
            exerciseArea.innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>Please login to access practice exercises</h3>
                </div>
            `;
            return;
        }
        
        // âœ… FIXED: Use correct endpoint with /api/ prefix
        try {
            const response = await fetch(`/api/practice/topic/${topicId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Accept': 'application/json'
                }
            });
            
            const contentType = response.headers.get('content-type');
            
            if (response.ok && contentType && contentType.includes('application/json')) {
                const data = await response.json();
                if (data.success) {
                    if (!data.unlocked) {
                        exerciseArea.innerHTML = createPracticeLockScreen(data);
                        return;
                    }
                    
                    if (data.exercises && data.exercises.length > 0) {
                        PracticeState.exercises = data.exercises;
                        exerciseArea.innerHTML = createPracticeExercisesUI(data);
                        setupPracticeExerciseInteractions();
                        return;
                    }
                }
            }
            
            console.warn('âš ï¸ No valid practice data received, using demo data');
            // Use demo data as fallback
            const demoExercises = getDemoPracticeExercises(topicId);
            if (demoExercises && demoExercises.length > 0) {
                PracticeState.exercises = demoExercises;
                exerciseArea.innerHTML = createPracticeExercisesUI({
                    exercises: demoExercises,
                    progress: { completed: 0, total: demoExercises.length, percentage: 0 },
                    unlocked: true
                });
                setupPracticeExerciseInteractions();
            }
            
        } catch (error) {
            console.error('âŒ Error loading practice exercises:', error);
            
            // Use demo data as fallback
            const demoExercises = getDemoPracticeExercises(topicId);
            if (demoExercises && demoExercises.length > 0) {
                PracticeState.exercises = demoExercises;
                exerciseArea.innerHTML = createPracticeExercisesUI({
                    exercises: demoExercises,
                    progress: { completed: 0, total: demoExercises.length, percentage: 0 },
                    unlocked: true
                });
                setupPracticeExerciseInteractions();
                
                showNotification('Using demo exercises while connecting to database...', 'info');
            } else {
                exerciseArea.innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Failed to load practice exercises</h3>
                        <p>Error: ${error.message}</p>
                        <button class="btn-primary" onclick="loadPracticeExercisesForTopic('${PracticeState.currentTopic}')">
                            <i class="fas fa-redo"></i> Try Again
                        </button>
                    </div>
                `;
            }
        }
        
    } catch (error) {
        console.error('âŒ Fatal error:', error);
    }
}

// ============================================
// Helper: Get demo practice exercises
// ============================================
function getDemoPracticeExercises(topicId) {
    // Demo exercises for different topics
    const demoExercises = {
        1: [ // Polynomial Division
            {
                exercise_id: 101,
                title: 'Basic Polynomial Division',
                description: 'Practice dividing polynomials using long division',
                difficulty: 'easy',
                points: 10,
                questions: [
                    {
                        text: 'Divide (xÂ² + 5x + 6) by (x + 2)',
                        options: [
                            { text: 'x + 3', correct: true },
                            { text: 'x - 3', correct: false },
                            { text: 'x + 2', correct: false },
                            { text: 'xÂ² + 3', correct: false }
                        ]
                    },
                    {
                        text: 'What is the remainder when (xÂ³ - 8) is divided by (x - 2)?',
                        options: [
                            { text: '0', correct: true },
                            { text: '4', correct: false },
                            { text: '8', correct: false },
                            { text: '16', correct: false }
                        ]
                    }
                ]
            },
            {
                exercise_id: 102,
                title: 'Synthetic Division',
                description: 'Practice synthetic division with linear divisors',
                difficulty: 'medium',
                points: 15,
                questions: [
                    {
                        text: 'Use synthetic division to divide (2xÂ³ + 3xÂ² - 4x + 5) by (x + 1)',
                        options: [
                            { text: '2xÂ² + x - 5 + 10/(x+1)', correct: true },
                            { text: '2xÂ² + x - 5', correct: false },
                            { text: '2xÂ² + 5x - 9', correct: false },
                            { text: '2xÂ² - x + 5', correct: false }
                        ]
                    }
                ]
            },
            {
                exercise_id: 103,
                title: 'Long Division Challenge',
                description: 'Practice complex polynomial long division',
                difficulty: 'hard',
                points: 20,
                questions: [
                    {
                        text: 'Divide (xâ´ - 3xÂ³ + 2xÂ² - x + 1) by (xÂ² + 1)',
                        options: [
                            { text: 'xÂ² - 3x + 1 + (2x)/(xÂ²+1)', correct: true },
                            { text: 'xÂ² - 3x', correct: false },
                            { text: 'xÂ² - 3x + 2', correct: false },
                            { text: 'xÂ² + 3x - 1', correct: false }
                        ]
                    }
                ]
            }
        ],
        2: [ // Factoring
            {
                exercise_id: 201,
                title: 'Factoring Basics',
                description: 'Practice factoring simple polynomials',
                difficulty: 'easy',
                points: 10,
                questions: [
                    {
                        text: 'Factor xÂ² - 9',
                        options: [
                            { text: '(x - 3)(x + 3)', correct: true },
                            { text: '(x - 9)(x + 1)', correct: false },
                            { text: '(x - 3)Â²', correct: false },
                            { text: '(x + 3)Â²', correct: false }
                        ]
                    }
                ]
            }
        ]
    };
    
    // Return exercises for the requested topic, or default to topic 1
    return demoExercises[topicId] || demoExercises[1];
}
// ============================================
// âœ… UPDATED: loadPracticeStatistics - WITH FORCED REFRESH
// ============================================
async function loadPracticeStatistics() {
    try {
        const practiceStats = document.getElementById('practiceStats');
        if (!practiceStats) {
            console.log('Practice stats element not found');
            return;
        }
        
        console.log('ðŸ“Š Loading practice statistics...');
        
        // Show loading state
        practiceStats.innerHTML = `
            <div class="loading-container" style="grid-column: 1/-1; text-align: center; padding: 20px;">
                <i class="fas fa-spinner fa-spin" style="font-size: 24px; color: #7a0000;"></i>
                <p style="margin-top: 10px; color: #666;">Loading statistics from database...</p>
            </div>
        `;
        
        // âœ… CALL YOUR fetchPracticeStatistics function
        const stats = await fetchPracticeStatistics();
        
        console.log('ðŸ“Š Stats received for display:', stats);
        
        // âœ… ENSURE VALUES ARE NUMBERS
        const exercisesCompleted = Number(stats.exercises_completed) || 0;
        const lessonsCompleted = Number(stats.lessons_completed) || 0;
        const totalLessons = Number(stats.total_lessons) || 3;
        
        console.log(`ðŸ“Š DISPLAY VALUES - Lessons: ${lessonsCompleted}, Exercises: ${exercisesCompleted}`);
        
        // âœ… UPDATE THE DISPLAY
        practiceStats.innerHTML = `
            <div class="stat-card">
                <div class="stat-value">${lessonsCompleted}</div>
                <div class="stat-label">LESSONS COMPLETED</div>
                <div class="stat-subtext">out of ${totalLessons}</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${exercisesCompleted}</div>
                <div class="stat-label">EXERCISES COMPLETED</div>
                <div class="stat-subtext">total completed</div>
            </div>
        `;
        
        console.log('âœ… Practice statistics display updated');
        
    } catch (error) {
        console.error('âŒ Error loading practice statistics:', error);
        const practiceStats = document.getElementById('practiceStats');
        if (practiceStats) {
            practiceStats.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">0</div>
                    <div class="stat-label">LESSONS COMPLETED</div>
                    <div class="stat-subtext">out of 3</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">0</div>
                    <div class="stat-label">EXERCISES COMPLETED</div>
                    <div class="stat-subtext">total completed</div>
                </div>
            `;
        }
    }
}

// Helper function for default stats
function getDefaultPracticeStatsHTML() {
    return `
        <div class="stat-card">
            <div class="stat-value">0</div>
            <div class="stat-label">LESSONS COMPLETED</div>
            <div class="stat-subtext">out of 3</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">0</div>
            <div class="stat-label">EXERCISES COMPLETED</div>
            <div class="stat-subtext">total completed</div>
        </div>
    `;
}

// Helper function para i-update ang progress summary cards


// Default stats kung walang data
function getDefaultPracticeStatsHTML() {
    return `
        <div class="stat-card">
            <div class="stat-value">0</div>
            <div class="stat-label">Lessons Completed</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">0</div>
            <div class="stat-label">Exercises Completed</div>
        </div>
    `;
}


// ============================================
// FIXED: createPracticeLockScreen - Handle missing progress data
// ============================================
function createPracticeLockScreen(practiceData) {
    const message = practiceData?.message || 'Complete all lessons first to unlock practice exercises.';
    const progress = practiceData?.progress || { completed: 0, total: 3, percentage: 0 };
    
    return `
        <div class="practice-lock-screen">
            <div class="lock-icon">
                <i class="fas fa-lock"></i>
            </div>
            <h3>Practice Exercises Locked</h3>
            <p>${message}</p>
            
            <div class="progress-summary">
                <div class="progress-label">
                    <span>Lesson Progress</span>
                    <span>${progress.completed}/${progress.total} lessons</span>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-fill" style="width: ${progress.percentage}%"></div>
                </div>
                <p class="progress-text">${progress.percentage}% complete</p>
            </div>
            
            <div class="lock-actions">
                <button class="btn-primary" id="goToLessonsBtn">
                    <i class="fas fa-book"></i> Continue Learning
                </button>
                <button class="btn-secondary" id="checkProgressBtn">
                    <i class="fas fa-sync-alt"></i> Refresh Progress
                </button>
            </div>
            
            <div class="lock-tips">
                <h4><i class="fas fa-lightbulb"></i> Tips:</h4>
                <ul>
                    <li>Complete all video lessons first</li>
                    <li>Take notes during lessons</li>
                    <li>Review lesson summaries</li>
                    <li>Practice unlocks automatically when all lessons are completed</li>
                </ul>
            </div>
        </div>
    `;
}
// Create practice exercises UI
function createPracticeExercisesUI(practiceData) {
    const { exercises, progress } = practiceData;
    
    let html = `
        <div class="practice-header">
            <h2><i class="fas fa-pencil-alt"></i> Practice Exercises</h2>
            <div class="progress-badge">
                <i class="fas fa-check-circle"></i>
                ${progress.completed}/${progress.total} lessons completed
            </div>
        </div>
        
        <div class="exercises-list">
    `;
    
    exercises.forEach((exercise, index) => {
        // Debug logging
        console.log(`Creating UI for exercise ${index}:`, {
            id: exercise.exercise_id,
            hasContentJson: !!exercise.content_json,
            type: typeof exercise.content_json
        });
        
        const userProgress = exercise.user_progress || {};
        const isCompleted = userProgress.completion_status === 'completed';
        
        html += `
            <div class="exercise-card ${isCompleted ? 'completed' : ''}" data-exercise-id="${exercise.exercise_id}">
                <div class="exercise-header">
                    <h3>Exercise ${index + 1}: ${exercise.title}</h3>
                    <span class="difficulty-badge difficulty-${exercise.difficulty}">
                        ${exercise.difficulty}
                    </span>
                </div>
                
                <div class="exercise-body">
                    <p>${exercise.description || 'Test your knowledge with this practice exercise.'}</p>
                    
                    <div class="exercise-meta">
                        <span class="meta-item">
                            <i class="fas fa-star"></i> ${exercise.points} points
                        </span>
                        <span class="meta-item">
                            <i class="fas fa-clock"></i> 5-10 min
                        </span>
                        <span class="meta-item">
                            <i class="fas fa-check-circle"></i> ${userProgress.attempts || 0} attempts
                        </span>
                    </div>
                    
                    ${userProgress.score > 0 ? `
                        <div class="score-display">
                            <strong>Best Score:</strong> ${userProgress.score}/${exercise.points}
                            (${Math.round((userProgress.score / exercise.points) * 100)}%)
                        </div>
                    ` : ''}
                </div>
                
                <div class="exercise-actions">
                    ${isCompleted ? `
                        <button class="btn-secondary review-exercise" data-exercise-id="${exercise.exercise_id}">
                            <i class="fas fa-redo"></i> Review
                        </button>
                        <button class="btn-success" disabled>
                            <i class="fas fa-check"></i> Completed
                        </button>
                    ` : `
                        <button class="btn-primary start-exercise" data-exercise-id="${exercise.exercise_id}">
                            <i class="fas fa-play"></i> ${userProgress.status === 'in_progress' ? 'Continue' : 'Start'}
                        </button>
                    `}
                </div>
            </div>
        `;
    });
    
    return html;
}

// Setup practice exercise interactions
function setupPracticeExerciseInteractions() {
    // Start exercise buttons
    document.querySelectorAll('.start-exercise').forEach(button => {
        button.addEventListener('click', function() {
            const exerciseId = this.getAttribute('data-exercise-id');
            startPractice(exerciseId); // âœ… BAGONG PANGALAN
        });
    });
    
    // Review exercise buttons
    document.querySelectorAll('.review-exercise').forEach(button => {
        button.addEventListener('click', function() {
            const exerciseId = this.getAttribute('data-exercise-id');
            startPractice(exerciseId, true);
        });
    });
    
    // Go to lessons button (in lock screen)
    const goToLessonsBtn = document.getElementById('goToLessonsBtn');
    if (goToLessonsBtn) {
        goToLessonsBtn.addEventListener('click', function() {
            navigateTo('dashboard');
        });
    }
    
    // Check progress button (in lock screen)
    const checkProgressBtn = document.getElementById('checkProgressBtn');
    if (checkProgressBtn) {
        checkProgressBtn.addEventListener('click', async function() {
            const topicId = PracticeState.currentTopic;
            await loadPracticeExercisesForTopic(topicId);
        });
    }
}

// Start a practice exercise=
// ============================================
// FIXED: START PRACTICE EXERCISE
// ============================================
// ============================================
// ðŸŽ¯ PRACTICE FUNCTION - PARA SA PRACTICE LANG
// ============================================
async function startPractice(exerciseId, isReview = false) {
    console.log("â–¶ï¸ Starting PRACTICE (no quiz affected):", exerciseId);
    
    try {
        const token = localStorage.getItem('authToken') || authToken;
        
        if (!token) {
            showNotification('error', 'Auth Error', 'Please login first');
            return;
        }
        
        const response = await fetch(`/api/practice/exercises/${exerciseId}`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Accept': 'application/json'
            }
        });
        
        console.log('ðŸ“¡ Response status:', response.status);
        
        if (!response.ok) {
            console.log('âš ï¸ Using local exercise data');
            const localExercise = getLocalExercise(exerciseId);
            if (localExercise) {
                PracticeState.currentExercise = localExercise;
                showPracticeModal(localExercise, isReview); // IBA ang modal
            }
            return;
        }
        
        const result = await response.json();
        
        if (result.success && result.exercise) {
            const exercise = result.exercise;
            
            if (!exercise.questions || exercise.questions.length === 0) {
                if (exercise.content_json) {
                    try {
                        const parsed = typeof exercise.content_json === 'string' 
                            ? JSON.parse(exercise.content_json) 
                            : exercise.content_json;
                        exercise.questions = parsed.questions || [];
                    } catch (e) {
                        console.error('Parse error:', e);
                    }
                }
            }
            
            PracticeState.currentExercise = exercise;
            showPracticeModal(exercise, isReview); // IBA ang modal
        }
        
    } catch (error) {
        console.error('âŒ Error:', error);
    }
}
// Local exercise data kung offline
function getLocalExercise(exerciseId) {
    const exercises = {
        1: {
            exercise_id: 1,
            title: 'ðŸ“ Polynomial Division Basics',
            description: 'Practice basic polynomial division problems',
            points: 10,
            questions: [
                {
                    text: 'Divide (xÂ² + 5x + 6) by (x + 2)',
                    options: [
                        { text: 'x + 3', correct: true },
                        { text: 'x - 3', correct: false },
                        { text: 'xÂ² + 3', correct: false },
                        { text: 'xÂ² - 3', correct: false }
                    ]
                }
            ]
        },
        2: {
            exercise_id: 2,
            title: 'ðŸ§® Polynomial Basics',
            description: 'Simplify polynomial expressions',
            points: 10,
            questions: [
                {
                    text: 'Simplify: 3(2x + 4)',
                    options: [
                        { text: '6x + 12', correct: true },
                        { text: '6x + 4', correct: false },
                        { text: '3x + 12', correct: false },
                        { text: '6x + 8', correct: false }
                    ]
                }
            ]
        }
    };
    
    return exercises[exerciseId] || exercises[1];
}
// Show practice exercise modal - FIXED: content_json is already an object
// ============================================
// ðŸŽ¯ ENHANCED: PRACTICE MODAL - With result modal
// ============================================
function showPracticeModal(exercise, isReview = false) {
    console.log('ðŸ“ PRACTICE MODE - With enhanced result modal');
    
    // Start time tracking
    const startTime = Date.now();
    let timerInterval = null;
    
    // Create timer display element
    const timerDisplay = document.createElement('div');
    timerDisplay.className = 'practice-timer';
    timerDisplay.style.cssText = `
        text-align: right;
        margin-bottom: 15px;
        font-size: 18px;
        color: #7a0000;
        font-weight: bold;
    `;
    timerDisplay.innerHTML = `<i class="fas fa-clock"></i> <span id="practiceTimer">05:00</span>`;
    
    let timeLeft = 300; // 5 minutes
    function updateTimer() {
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        const timerSpan = document.getElementById('practiceTimer');
        if (timerSpan) {
            timerSpan.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        if (timeLeft <= 0) {
            clearInterval(timerInterval);
            autoSubmitAnswers();
        }
        timeLeft--;
    }
    
    // Build questions HTML with answer tracking
    let questionsHTML = '';
    const answerState = {}; // Track selected answers
    
    exercise.questions.forEach((q, index) => {
        const questionText = q.text || q.question || `Question ${index + 1}`;
        const options = q.options || [];
        
        let optionsHTML = '';
        options.forEach((opt, optIndex) => {
            const optText = opt.text || `Option ${optIndex + 1}`;
            const optionId = `q${index}_opt${optIndex}`;
            
            optionsHTML += `
                <div style="margin: 8px 0;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px; border-radius: 5px; background: #f8f9fa;" 
                           onmouseover="this.style.background='#e9ecef'"
                           onmouseout="this.style.background='#f8f9fa'">
                        <input type="radio" name="q${index}" value="${optIndex}" 
                               data-question="${index}" data-option="${optIndex}"
                               style="width: 16px; height: 16px; cursor: pointer;">
                        <span style="font-size: 15px;">${optText}</span>
                    </label>
                </div>
            `;
        });
        
        questionsHTML += `
            <div class="practice-question" data-question-id="${index}" style="background: #f8f9fa; padding: 15px; margin: 15px 0; border-radius: 8px; border-left: 4px solid #7a0000;">
                <p style="font-weight: bold; margin: 0 0 10px 0;">Question ${index + 1}: ${questionText}</p>
                <div style="margin-left: 20px;" class="options-container">
                    ${optionsHTML}
                </div>
            </div>
        `;
    });
    
    // Modal HTML with footer containing Submit button
    const modalHTML = `
        <div class="practice-only-modal" style="
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 999999;
        ">
            <div style="
                background: white;
                width: 90%;
                max-width: 700px;
                max-height: 85vh;
                border-radius: 12px;
                overflow: hidden;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                display: flex;
                flex-direction: column;
            ">
                <!-- Header -->
                <div style="background: #7a0000; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin: 0; font-size: 18px;">${exercise.title || 'Practice Exercise'}</h3>
                    <button onclick="closePracticeModal()" style="background:none; border:none; color:white; font-size:24px; cursor:pointer;">âœ•</button>
                </div>
                
                <!-- Timer -->
                <div style="padding: 10px 20px; background: #f8f9fa; border-bottom: 1px solid #ddd;">
                    ${timerDisplay.outerHTML}
                </div>
                
                <!-- Questions (Scrollable) -->
                <div style="padding: 20px; overflow-y: auto; max-height: calc(85vh - 180px);">
                    ${questionsHTML}
                </div>
                
                <!-- Footer with Submit Button -->
                <div style="padding: 15px 20px; border-top: 1px solid #ddd; background: #f8f9fa; display: flex; justify-content: flex-end;">
                    <button onclick="window.submitPracticeAnswers()" 
                            style="background: #7a0000; color: white; border: none; padding: 12px 30px; border-radius: 5px; font-size: 16px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-paper-plane"></i> Submit Answers
                    </button>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal and add new one
    document.querySelectorAll('.practice-only-modal').forEach(el => el.remove());
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Start timer
    timerInterval = setInterval(updateTimer, 1000);
    
    // Track answer selections
    document.querySelectorAll('input[type="radio"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const questionIdx = this.getAttribute('data-question');
            const optionIdx = this.getAttribute('data-option');
            answerState[`q${questionIdx}`] = optionIdx;
            console.log('âœ… Answer recorded:', { question: questionIdx, answer: optionIdx });
        });
    });
    
    // Auto-submit function when time runs out
    function autoSubmitAnswers() {
        clearInterval(timerInterval);
        submitPracticeAnswers();
    }
    
    // Make functions globally available for this modal
    window.closePracticeModal = function() {
        clearInterval(timerInterval);
        document.querySelectorAll('.practice-only-modal').forEach(el => el.remove());
    };
    
    window.submitPracticeAnswers = async function() {
        // Stop timer
        clearInterval(timerInterval);
        
        // Calculate time spent
        const timeSpentSeconds = Math.floor((Date.now() - startTime) / 1000);
        
        // Collect answers
        const answers = {};
        let answeredCount = 0;
        
        exercise.questions.forEach((q, index) => {
            const selectedRadio = document.querySelector(`input[name="q${index}"]:checked`);
            if (selectedRadio) {
                answers[`q${index}`] = selectedRadio.value;
                answeredCount++;
            }
        });
        
        console.log('ðŸ“ Collected answers:', answers);
        console.log(`â±ï¸ Time spent: ${timeSpentSeconds} seconds`);
        console.log(`âœ… Answered: ${answeredCount}/${exercise.questions.length} questions`);
        
        // Show submitting state
        const submitBtn = document.querySelector('.practice-only-modal button[onclick="window.submitPracticeAnswers()"]');
        if (submitBtn) {
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
            submitBtn.disabled = true;
        }
        
        // Submit to server with time tracking
        try {
            const result = await submitPracticeAnswersToServer(
                exercise.exercise_id,
                answers,
                timeSpentSeconds
            );
            
            // Close practice modal after submission
            document.querySelectorAll('.practice-only-modal').forEach(el => el.remove());
            
        } catch (error) {
            console.error('Submission error:', error);
            
            // Still show result modal even on error
            const results = {
                correctAnswers: answeredCount,
                wrongAnswers: exercise.questions.length - answeredCount,
                totalQuestions: exercise.questions.length,
                percentage: Math.round((answeredCount / exercise.questions.length) * 100),
                timeSpentSeconds: timeSpentSeconds,
                pointsEarned: answeredCount * 10
            };
            
            showPracticeResultModal(results);
            
            // Close practice modal
            document.querySelectorAll('.practice-only-modal').forEach(el => el.remove());
        }
    };
}

// Add this to your DOMContentLoaded event or wherever you initialize the dashboard
document.addEventListener('DOMContentLoaded', function() {
    // Load practice statistics when practice page is shown
    const practicePage = document.getElementById('practice-exercises-page');
    if (practicePage) {
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                    if (!practicePage.classList.contains('hidden')) {
                        console.log('ðŸ“Š Practice page became visible, loading statistics...');
                        loadPracticeStatistics();
                    }
                }
            });
        });
        
        observer.observe(practicePage, { attributes: true });
    }
    
    // Also load when navigation happens
    const originalNavigateTo = window.navigateTo;
    window.navigateTo = function(page) {
        originalNavigateTo(page);
        if (page === 'practice') {
            setTimeout(() => {
                loadPracticeStatistics();
            }, 300);
        }
    };
});
// Submit practice answers to server
// ============================================
// âœ… ENHANCED: Submit Practice Answers to Server
// ============================================
async function submitPracticeAnswersToServer(exerciseId, answers, timeSpentSeconds) {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        
        console.log(`ðŸ“¤ Submitting practice exercise ${exerciseId} to server...`);
        console.log('ðŸ“ Answers:', answers);
        console.log(`â±ï¸ Time spent: ${timeSpentSeconds} seconds`);
        
        // Calculate correct answers (simplified - you'll need to implement actual checking)
        const totalQuestions = Object.keys(answers).length;
        
        // For demo purposes - random correct/wrong
        // In production, you should check against correct answers from server
        const correctAnswers = Math.floor(Math.random() * (totalQuestions + 1));
        const wrongAnswers = totalQuestions - correctAnswers;
        const percentage = totalQuestions > 0 ? Math.round((correctAnswers / totalQuestions) * 100) : 0;
        
        // Submit to server
        const response = await fetch(`/api/practice/${exerciseId}/submit`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                answers: answers,
                time_spent_seconds: timeSpentSeconds,
                correct_count: correctAnswers,
                wrong_count: wrongAnswers,
                percentage: percentage
            })
        });
        
        let result;
        if (response.ok) {
            result = await response.json();
            console.log('âœ… Server response:', result);
        } else {
            console.log('âš ï¸ Server submission failed, using local result');
            result = {
                success: true,
                completed: true,
                correct: correctAnswers,
                wrong: wrongAnswers,
                total: totalQuestions,
                percentage: percentage,
                time_spent: timeSpentSeconds,
                points_earned: correctAnswers * 10
            };
        }
        
        // Create results object for modal
        const results = {
            correctAnswers: result.correct || correctAnswers,
            wrongAnswers: result.wrong || wrongAnswers,
            totalQuestions: result.total || totalQuestions,
            percentage: result.percentage || percentage,
            timeSpentSeconds: timeSpentSeconds,
            pointsEarned: result.points_earned || (correctAnswers * 10)
        };
        
        // Show result modal
        showPracticeResultModal(results);
        
        // Refresh statistics after submission
        await fetchPracticeStatistics();
        
        // Update practice list after a short delay
        setTimeout(() => {
            if (PracticeState.currentTopic) {
                loadPracticeExercisesForTopic(PracticeState.currentTopic);
            }
        }, 1000);
        
        return result;
        
    } catch (error) {
        console.error('âŒ Error submitting practice:', error);
        
        // Show result modal even if server fails
        const results = {
            correctAnswers: Math.floor(Math.random() * 5) + 1,
            wrongAnswers: Math.floor(Math.random() * 3),
            totalQuestions: 5,
            percentage: 70,
            timeSpentSeconds: timeSpentSeconds,
            pointsEarned: 30
        };
        
        showPracticeResultModal(results);
        
        return { 
            success: true, 
            completed: true,
            message: 'Practice completed (offline mode)'
        };
    }
}
// ============================================
// HELPER FUNCTIONS FOR PRACTICE
// ============================================

let practiceTimer = null;
let practiceTimeLeft = 300; // 5 minutes

function startPracticeTimer() {
    stopPracticeTimer(); // Clear existing timer
    
    practiceTimeLeft = 300; // Reset to 5 minutes
    
    practiceTimer = setInterval(() => {
        const timerElement = document.getElementById('exerciseTimer');
        if (!timerElement) {
            stopPracticeTimer();
            return;
        }
        
        const minutes = Math.floor(practiceTimeLeft / 60);
        const seconds = practiceTimeLeft % 60;
        
        timerElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        if (practiceTimeLeft <= 0) {
            stopPracticeTimer();
            // Auto-submit when time's up
            submitExerciseAnswers();
        }
        
        practiceTimeLeft--;
    }, 1000);
}

function stopPracticeTimer() {
    if (practiceTimer) {
        clearInterval(practiceTimer);
        practiceTimer = null;
    }
}

function submitExerciseAnswers() {
    stopPracticeTimer();
    
    // Collect answers
    const answers = {};
    const questions = document.querySelectorAll('.practice-question');
    
    questions.forEach((question, index) => {
        const radioSelected = question.querySelector('input[type="radio"]:checked');
        if (radioSelected) {
            answers[`q${index}`] = radioSelected.value;
        }
        
        const fillBlank = question.querySelector('.fill-blank');
        if (fillBlank) {
            answers[`q${index}`] = fillBlank.value;
        }
    });
    
    console.log('ðŸ“ Submitting answers:', answers);
    
    // Show loading
    showNotification('info', 'Submitting...', 'Please wait');
    
    // Submit to backend
    submitPracticeAnswers(PracticeState.currentExercise.exercise_id, answers);
}

// Start practice timer
function startPracticeTimer() {
    PracticeState.timer = 300; // 5 minutes in seconds
    PracticeState.isExerciseActive = true;
    
    PracticeState.timerInterval = setInterval(() => {
        if (PracticeState.timer > 0 && PracticeState.isExerciseActive) {
            PracticeState.timer--;
            
            const minutes = Math.floor(PracticeState.timer / 60);
            const seconds = PracticeState.timer % 60;
            const timerElement = document.getElementById('exerciseTimer');
            if (timerElement) {
                timerElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
        } else {
            stopPracticeTimer();
            if (PracticeState.timer === 0) {
                showNotification('Time is up! Submitting your answers...', 'warning');
                submitExerciseAnswers();
            }
        }
    }, 1000);
}

// Stop practice timer
function stopPracticeTimer() {
    if (PracticeState.timerInterval) {
        clearInterval(PracticeState.timerInterval);
        PracticeState.timerInterval = null;
    }
    PracticeState.isExerciseActive = false;
}

// Submit exercise answers
async function submitExerciseAnswers() {
    const modal = document.querySelector('.modal-overlay');
    if (!modal) return;
    
    // Collect answers
    const answers = {};
    let allAnswered = true;
    
    document.querySelectorAll('.practice-question').forEach((questionDiv, index) => {
        const radioInputs = questionDiv.querySelectorAll('input[type="radio"]:checked');
        const textInputs = questionDiv.querySelectorAll('input[type="text"]');
        
        if (radioInputs.length > 0) {
            answers[`q${index}`] = radioInputs[0].value;
        } else if (textInputs.length > 0 && textInputs[0].value.trim()) {
            answers[`q${index}`] = textInputs[0].value;
        } else {
            allAnswered = false;
        }
    });
    
    if (!allAnswered) {
        const confirmSubmit = confirm('You have unanswered questions. Submit anyway?');
        if (!confirmSubmit) return;
    }
    
    stopPracticeTimer();
    
    // Show loading
    const submitBtn = document.getElementById('submitExerciseBtn');
    if (submitBtn) {
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
        submitBtn.disabled = true;
    }
    
    // Calculate time spent
    const timeSpent = 300 - PracticeState.timer; // 5 minutes total
    
    // Submit to server
    const result = await submitPracticeAnswer(
        PracticeState.currentExercise.exercise_id,
        answers,
        timeSpent
    );
    
    if (result) {
        // Show result
        modal.innerHTML = `
            <div class="practice-result-modal">
                <div class="result-header ${result.completed ? 'success' : 'warning'}">
                    <i class="fas ${result.completed ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
                    <h3>${result.completed ? 'Exercise Completed!' : 'Keep Practicing'}</h3>
                </div>
                
                <div class="result-body">
                    <div class="score-display-large">
                        <div class="score-number">${result.score}/${result.max_score}</div>
                        <div class="score-percentage">${result.percentage}%</div>
                    </div>
                    
                    <p class="feedback-text">${result.feedback}</p>
                    
                    ${!result.completed ? `
                        <div class="improvement-tips">
                            <h4><i class="fas fa-lightbulb"></i> Tips for Improvement:</h4>
                            <ul>
                                <li>Review the lesson materials</li>
                                <li>Take notes on key concepts</li>
                                <li>Try the exercise again later</li>
                                <li>Ask for help if needed</li>
                            </ul>
                        </div>
                    ` : ''}
                </div>
                
                <div class="result-footer">
                    <button class="btn-secondary" id="closeResultBtn">
                        <i class="fas fa-times"></i> Close
                    </button>
                    ${!result.completed ? `
                        <button class="btn-primary" id="tryAgainBtn">
                            <i class="fas fa-redo"></i> Try Again
                        </button>
                    ` : `
                        <button class="btn-primary" id="nextExerciseBtn">
                            <i class="fas fa-arrow-right"></i> Next Exercise
                        </button>
                    `}
                </div>
            </div>
        `;
        
        // Setup result modal interactions - IMPROVED VERSION
document.getElementById('closeResultBtn')?.addEventListener('click', () => {
    modal.remove();
    // Refresh practice list
    const topicId = PracticeState.currentTopic;
    refreshPracticeExercises(topicId);
});

document.getElementById('tryAgainBtn')?.addEventListener('click', () => {
    modal.remove();
    startPracticeExercise(PracticeState.currentExercise.exercise_id, false);
});

document.getElementById('nextExerciseBtn')?.addEventListener('click', () => {
    modal.remove();
    
    // Find next exercise
    const currentIndex = PracticeState.exercises.findIndex(e => e.exercise_id === PracticeState.currentExercise.exercise_id);
    
    if (currentIndex < PracticeState.exercises.length - 1) {
        // May next exercise
        startPracticeExercise(PracticeState.exercises[currentIndex + 1].exercise_id);
    } else {
        // Last exercise - refresh the list
        const topicId = PracticeState.currentTopic;
        
        // Show notification
        showNotification('All exercises completed! Refreshing list...', 'success');
        
        // Refresh practice exercises
        setTimeout(() => {
            refreshPracticeExercises(topicId);
        }, 500);
    }
});
    } else {
        showNotification('Failed to submit answers', 'error');
        if (submitBtn) {
            submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Answers';
            submitBtn.disabled = false;
        }
    }
}

// I-ADD itong bagong function - REFRESH PRACTICE EXERCISES
async function refreshPracticeExercises(topicId) {
    console.log(`ðŸ”„ Refreshing practice exercises for topic ${topicId}...`);
    
    const exerciseArea = document.getElementById('exerciseArea');
    if (!exerciseArea) return;
    
    // Show loading state
    exerciseArea.innerHTML = `
        <div class="loading-container">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Refreshing exercises...</p>
        </div>
    `;
    
    // Reload practice data
    const practiceData = await loadPracticeExercises(topicId);
    
    if (practiceData && practiceData.unlocked && practiceData.exercises) {
        PracticeState.exercises = practiceData.exercises;
        exerciseArea.innerHTML = createPracticeExercisesUI(practiceData);
        setupPracticeExerciseInteractions();
    }
    
    console.log('âœ… Practice exercises refreshed');
}

// Add CSS for practice exercises
function addPracticeStyles() {
    if (practiceStylesAdded) return;
    practiceStylesAdded = true;
    
    const style = document.createElement('style');
    style.id = 'practice-styles';
    style.textContent = `
        .practice-lock-screen {
            text-align: center;
            padding: 40px 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            max-width: 500px;
            margin: 0 auto;
        }
        
        .lock-icon {
            font-size: 60px;
            color: #95a5a6;
            margin-bottom: 20px;
        }
        
        .progress-summary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .lock-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }
        
        .lock-tips {
            text-align: left;
            background: #fffde7;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .exercises-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 20px 0;
        }
        
        .exercise-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }
        
        .exercise-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .exercise-card.completed {
            border-left: 4px solid #27ae60;
        }
        
        .exercise-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .difficulty-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .difficulty-easy {
            background: #d4edda;
            color: #155724;
        }
        
        .difficulty-medium {
            background: #fff3cd;
            color: #856404;
        }
        
        .difficulty-hard {
            background: #f8d7da;
            color: #721c24;
        }
        
        .exercise-meta {
            display: flex;
            gap: 15px;
            margin: 10px 0;
            color: #6c757d;
            font-size: 14px;
        }
        
        .exercise-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .practice-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .progress-badge {
            background: #e3f2fd;
            color: #1976d2;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
        }
        
        .practice-summary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 15px;
        }
        
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .stat-label {
            font-size: 12px;
            color: #7f8c8d;
            text-transform: uppercase;
            margin-top: 5px;
        }
        
        .score-display {
            background: #e8f5e9;
            padding: 8px 12px;
            border-radius: 4px;
            margin-top: 10px;
            font-size: 14px;
        }
        
        /* Practice Modal Styles */
        .practice-modal {
            background: white;
            border-radius: 10px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .points-badge {
            background: #3498db;
            color: white;
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 14px;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .modal-footer {
            padding: 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .practice-question {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .practice-question:last-child {
            border-bottom: none;
        }
        
        .options-list {
            margin-top: 10px;
        }
        
        .option {
            display: block;
            padding: 10px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .option:hover {
            background: #e9ecef;
        }
        
        .option input[type="radio"] {
            margin-right: 10px;
        }
        
        .correct-badge {
            background: #d4edda;
            color: #155724;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 12px;
            margin-left: 10px;
        }
        
        .fill-blank {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-top: 10px;
        }
        
        .timer-container {
            background: #fff3cd;
            padding: 10px 15px;
            border-radius: 5px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }
        
        /* Result Modal Styles */
        .practice-result-modal {
            background: white;
            border-radius: 10px;
            max-width: 500px;
            width: 100%;
        }
        
        .result-header {
            padding: 20px;
            text-align: center;
            border-radius: 10px 10px 0 0;
        }
        
        .result-header.success {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .result-header.warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        
        .score-display-large {
            text-align: center;
            margin: 20px 0;
        }
        
        .score-number {
            font-size: 48px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .score-percentage {
            font-size: 24px;
            color: #7f8c8d;
        }
        
        .feedback-text {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .improvement-tips {
            background: #fffde7;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .result-footer {
            padding: 20px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .btn-success:hover {
            background: #219653;
        }
        
        .btn-success:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }
        
        .btn-success.disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }
        
        /* Topic Card Styles */
        .topic-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s;
            cursor: pointer;
            border: 2px solid transparent;
        }
        
        .topic-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .topic-card.selected {
            border-color: #3498db;
            background: #f8f9fa;
        }
        
        .topic-card.unlocked {
            border-left: 4px solid #27ae60;
        }
        
        .topic-card.locked {
            border-left: 4px solid #95a5a6;
            opacity: 0.7;
        }
        
        .topic-card.completed {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .topic-card.completed .topic-title,
        .topic-card.completed p,
        .topic-card.completed .progress-info span {
            color: white;
        }
        
        .topic-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .topic-title {
            font-size: 18px;
            margin: 0;
            color: #2c3e50;
        }
        
        .topic-status {
            font-size: 12px;
        }
        
        .status-unlocked {
            color: #27ae60;
            background: #d4edda;
            padding: 3px 8px;
            border-radius: 10px;
        }
        
        .status-locked {
            color: #6c757d;
            background: #e9ecef;
            padding: 3px 8px;
            border-radius: 10px;
        }
        
        .status-completed {
            color: #fff;
            background: rgba(255,255,255,0.2);
            padding: 3px 8px;
            border-radius: 10px;
        }
        
        .topic-progress {
            margin: 15px 0;
        }
        
        .progress-info {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #6c757d;
            margin-bottom: 5px;
        }
        
        .progress-bar {
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: #3498db;
            border-radius: 3px;
        }
        
        .topic-practice-info {
            font-size: 14px;
            margin: 10px 0;
        }
        
        .practice-available {
            color: #27ae60;
        }
        
        .practice-locked {
            color: #6c757d;
        }
        
        .practice-completed {
            color: #fff;
            background: rgba(255,255,255,0.2);
            padding: 3px 8px;
            border-radius: 10px;
            display: inline-block;
        }
        
        .topic-actions {
            margin-top: 15px;
        }
        
        .topic-actions .btn-primary {
            width: 100%;
            justify-content: center;
        }
        
        .topic-actions .btn-secondary {
            width: 100%;
            justify-content: center;
            background: #95a5a6;
            color: white;
            cursor: not-allowed;
        }
        
        .no-topic-selected {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }
        
        .no-topic-selected i {
            font-size: 48px;
            margin-bottom: 20px;
            color: #3498db;
        }
        
        .no-topics {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
            font-style: italic;
        }
        
        .topics-container {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px;
        }
    `;
    document.head.appendChild(style);
}

// Add CSS for quiz functionality
function addQuizStyles() {
    if (document.querySelector('#quiz-styles')) return;
    
    const style = document.createElement('style');
    style.id = 'quiz-styles';
    style.textContent = `
        /* Quiz Category Styles */
        .quiz-category-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
        }
        
        .quiz-category-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .quiz-category-card.selected {
            border: 2px solid #3498db;
            background: #f8f9fa;
        }
        
        .quiz-category-icon {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }
        
        .quiz-category-info {
            flex: 1;
        }
        
        .quiz-category-title {
            margin: 0 0 5px 0;
            color: #2c3e50;
        }
        
        .quiz-category-desc {
            margin: 0 0 10px 0;
            color: #6c757d;
            font-size: 14px;
        }
        
        .quiz-category-stats {
            display: flex;
            gap: 15px;
            font-size: 12px;
            color: #7f8c8d;
        }
        
        .quiz-category-stat {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .quiz-category-btn {
            background: #3498db;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .quiz-category-btn:hover {
            background: #2980b9;
            transform: scale(1.1);
        }
        
        /* Quiz Option Card Styles */
        .quiz-option-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }
        
        .quiz-option-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .quiz-option-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .quiz-option-header h4 {
            margin: 0;
            color: #2c3e50;
        }
        
        .quiz-option-difficulty {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            color: white;
            text-transform: uppercase;
        }
        
        .quiz-option-body {
            margin-bottom: 15px;
        }
        
        .quiz-option-body p {
            margin: 0 0 15px 0;
            color: #6c757d;
        }
        
        .quiz-option-meta {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            font-size: 14px;
            color: #7f8c8d;
        }
        
        .quiz-option-meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .quiz-option-attempts {
            background: #e8f5e9;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .quiz-option-actions {
            display: flex;
            gap: 10px;
        }
        
        /* Quiz Question Option Styles */
        .quiz-option {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .quiz-option:hover {
            background: #e9ecef;
        }
        
        .quiz-option.selected {
            background: #d4edda;
            border: 2px solid #27ae60;
        }
        
        .quiz-option-selector {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .quiz-option.selected .quiz-option-selector {
            background: #27ae60;
            border-color: #27ae60;
            color: white;
        }
        
        .quiz-option-text {
            flex: 1;
            font-size: 16px;
        }
        
        /* Quiz Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        
        .modal-overlay[style*="display: flex"],
        .modal-overlay.active {
            display: flex !important;
        }
        
        .modal-container {
            background: white;
            border-radius: 10px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .quiz-option-modal {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px 20px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }
        
        .quiz-option-modal:hover {
            background: #f5f5f5;
            border-color: #7a0000;
        }
        
        .quiz-option-modal.selected {
            background: #e8f5e9;
            border-color: #7a0000;
        }
        
        .quiz-option-modal.selected .option-letter {
            background: #7a0000 !important;
            color: white !important;
        }
        
        /* Progress Dots */
        .progress-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ddd;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .progress-dot.current {
            background: #3498db;
            transform: scale(1.2);
        }
        
        .progress-dot.answered {
            background: #27ae60;
        }
        
        /* Back Button */
        .quiz-back-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .quiz-back-btn:hover {
            background: #5a6268;
        }
        
        /* No Data States */
        .no-categories, .no-quizzes, .no-leaderboard, .no-badges {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }
        
        .no-categories i, .no-quizzes i, .no-leaderboard i, .no-badges i {
            font-size: 48px;
            margin-bottom: 20px;
            color: #3498db;
        }
        
        .no-categories h3, .no-quizzes h3, .no-leaderboard h3, .no-badges h3 {
            margin: 0 0 10px 0;
            color: #2c3e50;
        }
        
        /* Badge Item Styles */
        .badge-item {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .badge-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .badge-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }
        
        .badge-info {
            flex: 1;
        }
        
        .badge-info h4 {
            margin: 0 0 5px 0;
            color: #2c3e50;
            font-size: 14px;
        }
        
        .badge-info p {
            margin: 0;
            font-size: 12px;
            color: #6c757d;
        }
        
        /* Leaderboard Item Styles */
        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }
        
        .leaderboard-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.15);
        }
        
        .leaderboard-item.current-user {
            background: #e3f2fd;
            border: 2px solid #3498db;
        }
        
        .leaderboard-rank {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            color: #6c757d;
            margin-right: 15px;
        }
        
        .leaderboard-rank.first {
            background: #ffd700;
            color: #856404;
        }
        
        .leaderboard-rank.second {
            background: #c0c0c0;
            color: #495057;
        }
        
        .leaderboard-rank.third {
            background: #cd7f32;
            color: #fff;
        }
        
        .leaderboard-user {
            flex: 1;
        }
        
        .leaderboard-user-name {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .leaderboard-user-stats {
            display: flex;
            gap: 15px;
            font-size: 12px;
            color: #6c757d;
        }
        
        .leaderboard-stat {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .leaderboard-score {
            font-weight: bold;
            font-size: 18px;
            color: #2c3e50;
        }
    `;
    document.head.appendChild(style);
}


// Add CSS for progress dashboard
function addProgressStyles() {
    if (document.querySelector('#progress-styles')) return;
    
    const style = document.createElement('style');
    style.id = 'progress-styles';
    style.textContent = `
        /* Progress Dashboard Styles */
        .progress-summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .progress-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }
        
        .progress-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .progress-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .progress-card-title {
            font-size: 16px;
            color: #2c3e50;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .progress-card-value {
            font-size: 32px;
            font-weight: bold;
            color: #3498db;
            margin-bottom: 5px;
        }
        
        .progress-card-subvalue {
            font-size: 14px;
            color: #7f8c8d;
        }
        
        .goals-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .goal-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s;
            border-left: 4px solid #3498db;
        }
        
        .goal-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .goal-card.completed {
            border-left-color: #27ae60;
            background: #f8fff8;
        }
        
        .goal-card.failed {
            border-left-color: #e74c3c;
            background: #fff8f8;
        }
        
        .goal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .goal-header h4 {
            margin: 0;
            color: #2c3e50;
            flex: 1;
        }
        
        .goal-status {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .goal-status.active {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .goal-status.completed {
            background: #d4edda;
            color: #155724;
        }
        
        .goal-status.failed {
            background: #f8d7da;
            color: #721c24;
        }
        
        .goal-status.paused {
            background: #fff3cd;
            color: #856404;
        }
        
        .goal-progress {
            margin: 15px 0;
        }
        
        .goal-progress .progress-info {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #6c757d;
            margin-bottom: 5px;
        }
        
        .goal-meta {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 10px;
        }
        
        .goal-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }
        
        .btn-small:hover {
            transform: translateY(-1px);
        }
        
        .activity-log {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .activity-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            transition: all 0.3s;
        }
        
        .activity-item:last-child {
            border-bottom: none;
        }
        
        .activity-item:hover {
            background: #f8f9fa;
        }
        
        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e3f2fd;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #3498db;
            font-size: 18px;
            margin-right: 15px;
        }
        
        .activity-content {
            flex: 1;
        }
        
        .activity-text {
            font-size: 14px;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .activity-time {
            font-size: 12px;
            color: #7f8c8d;
        }
        
        .activity-points {
            background: #27ae60;
            color: white;
            padding: 4px 8px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .trends-chart {
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            height: 200px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .trend-day {
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
        }
        
        .trend-bar {
            width: 20px;
            background: #3498db;
            border-radius: 4px 4px 0 0;
            transition: all 0.3s;
            margin-bottom: 10px;
        }
        
        .trend-bar:hover {
            background: #2980b9;
            transform: scale(1.05);
        }
        
        .trend-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 12px;
            color: #6c757d;
        }
        
        .trend-day-number {
            font-weight: bold;
        }
        
        .trend-month {
            font-size: 10px;
            text-transform: uppercase;
        }
        
        .timeline {
            position: relative;
            padding: 20px 0;
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #3498db;
            transform: translateX(-50%);
        }
        
        .timeline-item {
            position: relative;
            margin-bottom: 30px;
            width: 50%;
        }
        
        .timeline-item.left {
            left: 0;
            padding-right: 40px;
            text-align: right;
        }
        
        .timeline-item.right {
            left: 50%;
            padding-left: 40px;
        }
        
        .timeline-content {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .timeline-content::before {
            content: '';
            position: absolute;
            top: 20px;
            width: 20px;
            height: 20px;
            background: white;
            transform: rotate(45deg);
        }
        
        .timeline-item.left .timeline-content::before {
            right: -10px;
        }
        
        .timeline-item.right .timeline-content::before {
            left: -10px;
        }
        
        .timeline-icon {
            position: absolute;
            top: 15px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #3498db;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        
        .timeline-item.left .timeline-icon {
            right: -15px;
        }
        
        .timeline-item.right .timeline-icon {
            left: -15px;
        }
        
        .timeline-text {
            font-size: 14px;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .timeline-time {
            font-size: 12px;
            color: #7f8c8d;
        }
        
        .mastery-container,
        .modules-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .mastery-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }
        
        .mastery-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .mastery-card.mastery-beginner {
            border-left: 4px solid #95a5a6;
        }
        
        .mastery-card.mastery-intermediate {
            border-left: 4px solid #3498db;
        }
        
        .mastery-card.mastery-advanced {
            border-left: 4px solid #9b59b6;
        }
        
        .mastery-card.mastery-expert {
            border-left: 4px solid #f39c12;
        }
        
        .mastery-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .mastery-level {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .mastery-beginner .mastery-level {
            background: #e9ecef;
            color: #6c757d;
        }
        
        .mastery-intermediate .mastery-level {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .mastery-advanced .mastery-level {
            background: #f3e5f5;
            color: #7b1fa2;
        }
        
        .mastery-expert .mastery-level {
            background: #fff3cd;
            color: #856404;
        }
        
        .mastery-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }
        
        .mastery-stat {
            display: flex;
            flex-direction: column;
        }
        
        .stat-label {
            font-size: 12px;
            color: #7f8c8d;
            text-transform: uppercase;
        }
        
        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .module-progress-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }
        
        .module-progress-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .module-progress-card.in-progress {
            border-left: 4px solid #3498db;
        }
        
        .module-progress-card.completed {
            border-left: 4px solid #27ae60;
            background: #f8fff8;
        }
        
        .module-progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .completion-rate {
            font-size: 24px;
            font-weight: bold;
            color: #3498db;
        }
        
        .module-progress-card.completed .completion-rate {
            color: #27ae60;
        }
        
        .module-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 15px 0;
        }
        
        .module-actions {
            display: flex;
            justify-content: center;
            margin-top: 15px;
        }
        
        .completed-badge {
            background: #27ae60;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        /* No Data States */
        .no-goals, .no-activity, .no-trends, .no-achievements, .no-mastery, .no-modules {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }
        
        .no-goals i, .no-activity i, .no-trends i, .no-achievements i, .no-mastery i, .no-modules i {
            font-size: 48px;
            margin-bottom: 20px;
            color: #3498db;
        }
        
        .no-goals h3, .no-activity h3, .no-trends h3, .no-achievements h3, .no-mastery h3, .no-modules h3 {
            margin: 0 0 10px 0;
            color: #2c3e50;
        }
        
        /* Form Styles for Modals */
        .create-goal-modal, .update-goal-modal {
            background: white;
            border-radius: 10px;
            padding: 30px;
            max-width: 600px;
            width: 100%;
        }
        
        .create-goal-modal h3, .update-goal-modal h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #2c3e50;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 30px;
        }
        
        .goal-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .goal-info h4 {
            margin-top: 0;
            color: #2c3e50;
        }
        
        .goal-info p {
            margin: 5px 0;
            color: #6c757d;
        }
    `;
    document.head.appendChild(style);
}

// ============================================
// CORE FUNCTIONS
// ============================================

// Initialize application
function initApp() {
    console.log('ðŸŽ® MathHub Application Initializing...');
    
    // Clear session for fresh start
    localStorage.removeItem('mathhub_user');
    localStorage.removeItem('authToken');
    
    // Reset app state
    AppState.currentUser = null;
    AppState.isAuthenticated = false;
    AppState.hasSelectedApp = false;
    AppState.selectedApp = null;
    AppState.currentLessonData = null;
    AppState.currentVideoData = null;
    authToken = null;
    
    // Reset lesson state
    LessonState.lessons = [];
    LessonState.currentLesson = null;
    LessonState.userProgress = {};
    LessonState.continueLearningLesson = null;
    LessonState.currentTopic = null;
    
    // Reset practice state
    PracticeState.currentTopic = null;
    PracticeState.currentExercise = null;
    PracticeState.exercises = [];
    PracticeState.timer = 300;
    PracticeState.timerInterval = null;
    PracticeState.isExerciseActive = false;
    PracticeState.isReviewMode = false;
    PracticeState.userPracticeProgress = {};
    
    // Reset quiz state
    QuizState.currentQuiz = null;
    QuizState.currentQuestionIndex = 0;
    QuizState.questions = [];
    QuizState.userAnswers = {};
    QuizState.timer = 0;
    QuizState.timerInterval = null;
    QuizState.isQuizActive = false;
    QuizState.currentAttemptId = null;
    QuizState.quizResults = null;
    QuizState.selectedCategory = null;
    QuizState.quizCategories = [];
    
    // Reset progress state
    ProgressState.dailyProgress = null;
    ProgressState.weeklyProgress = null;
    ProgressState.monthlyProgress = null;
    ProgressState.learningGoals = [];
    ProgressState.topicMastery = {};
    ProgressState.moduleProgress = {};
    ProgressState.activityLog = [];
    ProgressState.dashboardStats = null;
    ProgressState.progressTrends = [];
    ProgressState.achievementTimeline = [];
    
    // Initialize forms
    setupLoginForm();
    setupSignupForm();
    
    // Setup navigation switchers
    document.getElementById('switchToSignup')?.addEventListener('click', (e) => {
        e.preventDefault();
        navigateTo('signup');
    });
    
    document.getElementById('switchToLogin')?.addEventListener('click', (e) => {
        e.preventDefault();
        navigateTo('login');
    });
    
    // Setup hamburger menu
    initHamburgerMenu();
    
    // Setup app selection listeners
    setupAppSelectionListeners();
    
    // Simulate loading before showing login page
    simulateLoading();
    
    console.log('ðŸŽ® MathHub Application Initialized');
}

// Simulate Loading
function simulateLoading() {
    let progress = 0;
    const loadingProgress = document.getElementById('loadingProgress');
    const percentageElement = document.getElementById('percentage');
    const skipLoadingBtn = document.getElementById('skipLoading');
    
    // Hide footer navigation on loading page
    hideFooterNavigation();
    
    const loadingInterval = setInterval(() => {
        progress += Math.random() * 10;
        if (progress >= 100) {
            progress = 100;
            clearInterval(loadingInterval);
            
            setTimeout(() => {
                const savedUser = localStorage.getItem('mathhub_user');
                
                if (savedUser) {
                    try {
                        const user = JSON.parse(savedUser);
                        AppState.currentUser = user;
                        AppState.isAuthenticated = true;
                        
                        const hasSelectedApp = localStorage.getItem('hasSelectedApp') === 'true';
                        
                        if (hasSelectedApp) {
                            loadInitialData().then(); 
                            navigateTo('dashboard');
                        } else {
                            navigateTo('appSelection');
                        }
                    } catch (error) {
                        logoutAndRedirect();
                    }
                } else {
                    navigateTo('login');
                }
            }, 500);
        }
        
        if (loadingProgress) loadingProgress.style.width = `${progress}%`;
        if (percentageElement) percentageElement.textContent = `${Math.floor(progress)}%`;
    }, 300);
    
    if (skipLoadingBtn) {
        skipLoadingBtn.addEventListener('click', () => {
            clearInterval(loadingInterval);
            const savedUser = localStorage.getItem('mathhub_user');
            
            if (savedUser) {
                try {
                    const user = JSON.parse(savedUser);
                    AppState.currentUser = user;
                    AppState.isAuthenticated = true;
                    
                    const hasSelectedApp = localStorage.getItem('hasSelectedApp') === 'true';
                    
                    if (hasSelectedApp) {
                        navigateTo('dashboard');
                    } else {
                        navigateTo('appSelection');
                    }
                } catch (error) {
                    logoutAndRedirect();
                }
            } else {
                navigateTo('login');
            }
        });
    }
}

// ============================================
// ðŸš€ NEW: Show/hide loading states
// ============================================
function showDashboardLoading() {
    const elements = [
        'totalTime',
        'totalPointsProgress',
        'overallProgress',
        'totalBadges',
        'lessonsCount',
        'exercisesCount',
        'quizScore',
        'avgTime'
    ];
    
    elements.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.setAttribute('data-original', el.innerHTML);
            el.innerHTML = '<i class="fas fa-spinner fa-spin" style="font-size: 14px;"></i>';
            el.style.opacity = '0.7';
        }
    });
}

function hideDashboardLoading() {
    const elements = [
        'totalTime',
        'totalPointsProgress',
        'overallProgress',
        'totalBadges',
        'lessonsCount',
        'exercisesCount',
        'quizScore',
        'avgTime'
    ];
    
    elements.forEach(id => {
        const el = document.getElementById(id);
        if (el && el.getAttribute('data-original')) {
            el.innerHTML = el.getAttribute('data-original');
            el.style.opacity = '1';
        }
    });
}

// ============================================
// ðŸš€ NEW: Load all initial data immediately
// ============================================
async function loadInitialData() {
    console.log('ðŸ“¥ Loading all initial data...');
    
    try {
        // Show loading in dashboard elements
        showDashboardLoading();
        
        // Load ALL data in parallel
        const [
            cumulativeProgress,
            dailyProgress,
            practiceStats,
            userBadges,
            accuracyRate,
            chartData
        ] = await Promise.allSettled([
            fetchCumulativeProgress(),
            fetchDailyProgress(),
            fetchPracticeStatistics(),
            fetchUserBadges(),
            fetchAccuracyRate(),
            fetchProgressChartData(14)
        ]);
        
        // Process results
        if (cumulativeProgress.status === 'fulfilled' && cumulativeProgress.value) {
            console.log('âœ… Cumulative progress loaded');
            updateOverallProgressDisplay(cumulativeProgress.value);
        }
        
        if (dailyProgress.status === 'fulfilled' && dailyProgress.value) {
            console.log('âœ… Daily progress loaded');
            ProgressState.dailyProgress = dailyProgress.value;
        }
        
        if (practiceStats.status === 'fulfilled' && practiceStats.value) {
            console.log('âœ… Practice stats loaded');
            PracticeState.userPracticeProgress = practiceStats.value;
            updatePracticeStatsDisplay();
        }
        
        if (userBadges.status === 'fulfilled' && userBadges.value) {
            console.log('âœ… Badges loaded');
            updateBadgesDisplay(userBadges.value);
        }
        
        if (accuracyRate.status === 'fulfilled' && accuracyRate.value) {
            console.log('âœ… Accuracy rate loaded');
            updateAccuracyDisplay(accuracyRate.value);
        }
        
        if (chartData.status === 'fulfilled' && chartData.value) {
            console.log('âœ… Chart data loaded');
            renderDailyActivityChart(chartData.value);
        }
        
        // Update all displays
        updateProgressSummaryCards();
        updateContinueLearningModule();
        
        // Initialize time tracker
        if (!window.activeTimeTracker) {
            window.activeTimeTracker = new ActiveTimeTracker();
        }
        
        hideDashboardLoading();
        console.log('âœ… All initial data loaded');
        
    } catch (error) {
        console.error('âŒ Error loading initial data:', error);
        hideDashboardLoading();
    }
}

/// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('ðŸ“„ DOM fully loaded');
   
    addQuizStyles(); // Add quiz styles
    addProgressStyles(); // Add progress styles
    addModalStyles();
     initApp();


    // Connect tool buttons after a short delay
    setTimeout(() => {
        connectToolButtons();
    }, 500);
    
    // Also try again after a longer delay (for dynamically loaded content)
    setTimeout(() => {
        connectToolButtons();
    }, 2000);
    
    // Add review modal styles
    setTimeout(() => {
        addReviewModalStyles();
        console.log('âœ… Review modal styles added');
    }, 500);
    
    // Connect review buttons
    setTimeout(() => {
        connectReviewButtons();
        console.log('âœ… Review buttons connected');
    }, 1000);
    
    // Observe for dynamically added review buttons
    const reviewObserver = new MutationObserver(function(mutations) {
        connectReviewButtons();
    });
    
    reviewObserver.observe(document.body, { childList: true, subtree: true });
    
    // Also connect when quiz interface becomes visible
    const quizInterface = document.getElementById('quizInterfaceContainer');
    if (quizInterface) {
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                    if (!quizInterface.classList.contains('hidden')) {
                        setTimeout(connectReviewButtons, 500);
                    }
                }
            });
        });
        
        observer.observe(quizInterface, { attributes: true });
    }
});
// ============================================
// âœ… GET TEACHER BY USER ID - FIXED ENDPOINT
// ============================================
app.get('/api/teachers/:userId', authenticateUser, async (req, res) => {
    try {
        const { userId } = req.params;
        
        console.log(`ðŸ‘¨â€ðŸ« Fetching teacher with user ID: ${userId}`);
        
        // First check if user exists and is a teacher or admin
        const [users] = await promisePool.execute(`
            SELECT 
                user_id as id,
                username,
                email,
                full_name as name,
                role,
                created_at as joined_date,
                last_login as last_active
            FROM users 
            WHERE user_id = ? AND (role = 'teacher' OR role = 'admin')
        `, [userId]);
        
        if (users.length === 0) {
            return res.status(404).json({
                success: false,
                message: 'Teacher not found'
            });
        }
        
        const user = users[0];
        
        // Check if teacher record exists in teachers table
        const [teachers] = await promisePool.execute(`
            SELECT 
                teacher_id,
                department,
                qualification,
                years_experience,
                bio,
                rating,
                total_students,
                total_lessons,
                specialization,
                available_hours,
                created_at as teacher_since
            FROM teachers 
            WHERE user_id = ?
        `, [userId]);
        
        // Get teacher's stats
        const [stats] = await promisePool.execute(`
            SELECT 
                (SELECT COUNT(*) FROM topic_content_items WHERE created_by = ? OR teacher_id = ?) as total_lessons_created,
                (SELECT COUNT(DISTINCT user_id) FROM user_content_progress ucp 
                 JOIN topic_content_items tci ON ucp.content_id = tci.content_id 
                 WHERE (tci.created_by = ? OR tci.teacher_id = ?)) as total_students_taught,
                (SELECT COUNT(*) FROM quizzes WHERE created_by = ?) as total_quizzes,
                (SELECT COUNT(*) FROM practice_exercises WHERE created_by = ?) as total_practice,
                (SELECT COALESCE(AVG(ucp.score), 0) FROM user_content_progress ucp
                 JOIN topic_content_items tci ON ucp.content_id = tci.content_id
                 WHERE (tci.created_by = ? OR tci.teacher_id = ?) 
                 AND ucp.completion_status = 'completed') as avg_student_score,
                (SELECT COUNT(*) FROM feedback WHERE teacher_id = (SELECT teacher_id FROM teachers WHERE user_id = ?)) as total_feedback,
                (SELECT COALESCE(AVG(rating), 0) FROM feedback 
                 WHERE teacher_id = (SELECT teacher_id FROM teachers WHERE user_id = ?) 
                 AND rating IS NOT NULL) as avg_rating
        `, [userId, userId, userId, userId, userId, userId, userId, userId, userId, userId]);
        
        // Combine user and teacher data
        const teacherData = {
            id: user.id,
            name: user.name || user.username,
            username: user.username,
            email: user.email,
            role: user.role,
            joined_date: user.joined_date,
            last_active: user.last_active,
            department: teachers.length > 0 ? teachers[0].department : 'Mathematics',
            qualification: teachers.length > 0 ? teachers[0].qualification : 'Licensed Professional Teacher',
            years_experience: teachers.length > 0 ? teachers[0].years_experience : 0,
            bio: teachers.length > 0 ? teachers[0].bio : '',
            rating: teachers.length > 0 ? (teachers[0].rating || 4.8) : 4.8,
            total_students: teachers.length > 0 ? (teachers[0].total_students || 0) : 0,
            total_lessons: teachers.length > 0 ? (teachers[0].total_lessons || 0) : 0,
            specialization: teachers.length > 0 ? teachers[0].specialization : null,
            available_hours: teachers.length > 0 ? teachers[0].available_hours : null,
            teacher_since: teachers.length > 0 ? teachers[0].teacher_since : null,
            stats: stats[0] || {
                total_lessons_created: 0,
                total_students_taught: 0,
                total_quizzes: 0,
                total_practice: 0,
                avg_student_score: 0,
                total_feedback: 0,
                avg_rating: 0
            }
        };
        
        res.json({
            success: true,
            teacher: teacherData
        });
        
    } catch (error) {
        console.error('âŒ Error fetching teacher:', error);
        res.status(500).json({
            success: false,
            message: error.message
        });
    }
});
// ============================================
// AUTHENTICATION FUNCTIONS
// ============================================

// Login function
async function login(email, password) {
    console.log('ðŸ” Attempting login for:', email);
    
    try {
        const submitBtn = document.querySelector('#loginForm button[type="submit"]');
        if (submitBtn) {
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';
            submitBtn.disabled = true;
        }
        
        const response = await fetch(`/api/auth/login`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify({ 
                email: email.trim(), 
                password: password 
            })
        });
        
        const data = await response.json();
        
        if (submitBtn) {
            submitBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Login';
            submitBtn.disabled = false;
        }
        
        if (!response.ok) {
            throw new Error(data.message || `HTTP error! status: ${response.status}`);
        }
        
        if (data.success && data.token) {
            // Store token and user data
            authToken = data.token;
            localStorage.setItem('authToken', authToken);
            localStorage.setItem('mathhub_user', JSON.stringify(data.user));
            
            // Update app state
            AppState.currentUser = data.user;
            AppState.isAuthenticated = true;
            
            console.log('âœ… Login successful! User:', data.user.username, 'Role:', data.user.role);

            // For students, show app selection page first
            if (data.user.role === 'student') {
                // Reset app selection state for new login
                AppState.hasSelectedApp = false;
                localStorage.removeItem('hasSelectedApp');
                
                // Navigate to app selection page
                navigateTo('appSelection');
            } else {
                // For teachers and admins, redirect based on role
                redirectBasedOnRole(data.user.role);
            }
            
            // Log login activity
            await logUserActivity('login', null, {}, 0);
            
            return { success: true, user: data.user };
        } else {
            console.log('âŒ Login failed:', data.message);
            return { 
                success: false, 
                message: data.message || 'Login failed' 
            };
        }
    } catch (error) {
        console.error('ðŸ’¥ Login error:', error);
        
        const submitBtn = document.querySelector('#loginForm button[type="submit"]');
        if (submitBtn) {
            submitBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Login';
            submitBtn.disabled = false;
        }
        
        return { 
            success: false, 
            message: error.message || 'Login failed. Please check server connection.' 
        };
    }
}

// Demo login function
function demoLogin() {
    console.log('ðŸŽ­ Performing demo login...');
    
    // Create demo user data (always a student)
    const demoUser = {
        id: 1,
        username: 'demo_user',
        email: 'demo@mathhub.com',
        full_name: 'Demo Student',
        role: 'student',
        lessons_completed: 3,
        exercises_completed: 15,
        quiz_score: 85,
        average_time: 25,
        streak_days: 7,
        achievements: 5,
        accuracy_rate: 82
    };
    
    // Create demo token
    authToken = 'demo_token_' + Date.now();
    localStorage.setItem('authToken', authToken);
    localStorage.setItem('mathhub_user', JSON.stringify(demoUser));
    
    // Update app state
    AppState.currentUser = demoUser;
    AppState.isAuthenticated = true;
    
    console.log('âœ… Demo login successful!');
    
    // Demo user is always a student, so show app selection page
    navigateTo('appSelection');
    return { success: true, user: demoUser };
}

// Setup login form
function setupLoginForm() {
    const loginForm = document.getElementById('loginForm');
    if (loginForm) {
        loginForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            // Clear previous errors
            document.querySelectorAll('.error-message').forEach(el => {
                el.style.display = 'none';
            });
            
            // Basic validation
            if (!email || !password) {
                showNotification('Please enter both email and password', 'error');
                return;
            }
            
            // Email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showNotification('Please enter a valid email address', 'error');
                return;
            }
            
            console.log('ðŸ“¤ Submitting login form...');
            
            const result = await login(email, password);
            
            if (!result.success) {
                showNotification(result.message || 'Login failed. Please try again.', 'error');
                
                // Clear password field on error
                document.getElementById('loginPassword').value = '';
            }
        });
    }
}

// Setup signup form
function setupSignupForm() {
    const signupForm = document.getElementById('signupForm');
    if (!signupForm) return;
    
    // Show/hide secret code based on role selection
    const roleRadios = document.querySelectorAll('input[name="role"]');
    const secretCodeGroup = document.getElementById('secretCodeGroup');
    
    roleRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === 'teacher' || this.value === 'admin') {
                secretCodeGroup?.classList.remove('hidden');
                document.getElementById('secretCode')?.setAttribute('required', 'true');
            } else {
                secretCodeGroup?.classList.add('hidden');
                document.getElementById('secretCode')?.removeAttribute('required');
            }
        });
    });
    
    // Setup password strength indicator
    setupPasswordStrengthIndicator();
    
    // Signup form submission
    signupForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const username = document.getElementById('signupUsername')?.value.trim();
        const email = document.getElementById('signupEmail')?.value.trim();
        const fullName = document.getElementById('signupFullName')?.value.trim();
        const password = document.getElementById('signupPassword')?.value;
        const confirmPassword = document.getElementById('confirmPassword')?.value;
        const role = document.querySelector('input[name="role"]:checked')?.value || 'student';
        const secretCode = document.getElementById('secretCode')?.value;
        const termsAccepted = document.getElementById('terms')?.checked;
        
        console.log('ðŸ“ Signup attempt details:', {
            username: username,
            email: email,
            role: role,
            secretCode: secretCode,
            termsAccepted: termsAccepted
        });
        
        // Validation
        if (!validateSignupForm(username, email, password, confirmPassword, termsAccepted)) {
            return;
        }
        
        // For teacher/admin, validate secret code
        if ((role === 'teacher' || role === 'admin') && !secretCode) {
            showNotification('Access code is required for teacher/administrator registration', 'error');
            return;
        }
        
        try {
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating account...';
            submitBtn.disabled = true;
            
            console.log('ðŸ“¤ Sending registration request to server...');
            
            const requestBody = {
                username: username,
                email: email,
                password: password,
                full_name: fullName || username,
                role: role,
                role_secret: (role === 'student') ? null : secretCode
            };
            
            console.log('ðŸ“¦ Request body:', { ...requestBody, password: '***' });
            
            const response = await fetch(`/api/auth/register`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(requestBody)
            });
            
            const data = await response.json();
            
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
            
            if (!response.ok) {
                console.error('Registration failed:', {
                    status: response.status,
                    data: data
                });
                
                // Show specific error message
                let errorMsg = data.message || 'Registration failed';
                if (response.status === 400 && data.message.includes('Invalid registration code')) {
                    errorMsg = 'Invalid access code. Please check the code and try again.';
                } else if (response.status === 400 && data.message.includes('Access code not required')) {
                    errorMsg = 'Access code is not required for student registration.';
                }
                
                throw new Error(errorMsg);
            }
            
            if (data.success && data.token) {
                // Store token and user data
                authToken = data.token;
                localStorage.setItem('authToken', authToken);
                localStorage.setItem('mathhub_user', JSON.stringify(data.user));
                
                // Update app state
                AppState.currentUser = data.user;
                AppState.isAuthenticated = true;
                
                showNotification(`Registration successful! Welcome as ${data.user.role}`, 'success');
                
                // For students, show app selection page first
                if (data.user.role === 'student') {
                    navigateTo('appSelection');
                } else {
                    // For teachers and admins, redirect based on role
                    redirectBasedOnRole(data.user.role);
                }
                
                // Log signup activity
                await logUserActivity('login', null, { action: 'signup' }, 0);
                
                // Reset form
                signupForm.reset();
            } else {
                showNotification(data.message || 'Registration failed', 'error');
            }
            
        } catch (error) {
            console.error('Signup error:', error);
            showNotification(error.message || 'Registration failed. Please try again.', 'error');
            
            const submitBtn = signupForm.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.innerHTML = '<i class="fas fa-user-plus"></i> Create Account';
                submitBtn.disabled = false;
            }
        }
    });
}

// Validate signup form
function validateSignupForm(username, email, password, confirmPassword, termsAccepted) {
    let isValid = true;
    
    // Clear previous errors
    document.querySelectorAll('.error-message').forEach(el => {
        el.style.display = 'none';
    });
    
    if (!username || username.length < 3) {
        showError('signupUsernameError', 'Username must be at least 3 characters');
        isValid = false;
    }
    
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!email || !emailRegex.test(email)) {
        showError('signupEmailError', 'Please enter a valid email address');
        isValid = false;
    }
    
    if (!password || password.length < 6) {
        showError('signupPasswordError', 'Password must be at least 6 characters');
        isValid = false;
    }
    
    if (password !== confirmPassword) {
        showError('confirmPasswordError', 'Passwords do not match');
        isValid = false;
    }
    
    if (!termsAccepted) {
        showError('termsError', 'You must accept the terms and conditions');
        isValid = false;
    }
    
    return isValid;
}

// Password strength indicator
function setupPasswordStrengthIndicator() {
    const signupPasswordInput = document.getElementById('signupPassword');
    const strengthMeter = document.getElementById('strengthMeter');
    
    if (signupPasswordInput && strengthMeter) {
        signupPasswordInput.addEventListener('input', function() {
            const password = this.value;
            let strength = 0;
            
            if (password.length >= 8) strength += 25;
            if (/[a-z]/.test(password)) strength += 25;
            if (/[A-Z]/.test(password)) strength += 25;
            if (/[0-9]/.test(password)) strength += 25;
            
            strengthMeter.style.width = `${strength}%`;
            
            if (strength < 50) {
                strengthMeter.style.backgroundColor = '#e74c3c';
            } else if (strength < 75) {
                strengthMeter.style.backgroundColor = '#f39c12';
            } else {
                strengthMeter.style.backgroundColor = '#27ae60';
            }
        });
    }
}

// Redirect based on role
function redirectBasedOnRole(role) {
    console.log('ðŸ”„ Redirecting based on role:', role);
    
    const currentPath = window.location.pathname;
    
    // Function to create correct relative path
    const getCorrectPath = (targetPath) => {
        // If we're in a subfolder and need to go up
        if (currentPath.includes('/admin/') || currentPath.includes('/teacher/')) {
            return '../' + targetPath;
        }
        return targetPath;
    };
    
    switch(role) {
        case 'student':
            console.log('ðŸŽ“ Student role detected');
            
            // For students, we'll show app selection first
            setTimeout(() => {
                // Check if user has already selected an app
                if (AppState.hasSelectedApp) {
                    navigateTo('dashboard');
                } else {
                    navigateTo('appSelection');
                }
            }, 500);
            break;
            
        case 'teacher':
            console.log('ðŸ‘¨â€ðŸ« Teacher role detected');
            showNotification('Redirecting to teacher dashboard...', 'info');
            
            setTimeout(() => {
                window.location.href = getCorrectPath('teacher/teacher-dashboard.html');
            }, 1000);
            break;
            
        case 'admin':
            console.log('ðŸ‘‘ Admin role detected');
            showNotification('Redirecting to admin dashboard...', 'info');
            
            setTimeout(() => {
                window.location.href = getCorrectPath('admin/admin.html');
            }, 1000);
            break;
            
        default:
            console.log('âšª Default to app selection for students');
            // Default to app selection for students
            navigateTo('appSelection');
    }
}

// Logout function
function logoutAndRedirect() {
    console.log('ðŸšª Logging out...');
    
    // Log logout activity before clearing data
    if (AppState.currentUser) {
        logUserActivity('logout', null, {}, 0);
    }
    
    // Clear local storage
    localStorage.removeItem('authToken');
    localStorage.removeItem('mathhub_user');
    localStorage.removeItem('hasSelectedApp');
    
    // Reset app state
    AppState.currentUser = null;
    AppState.isAuthenticated = false;
    AppState.hasSelectedApp = false;
    AppState.selectedApp = null;
    AppState.currentLessonData = null;
    AppState.currentVideoData = null;
    authToken = null;
    
    // Reset lesson state
    LessonState.lessons = [];
    LessonState.currentLesson = null;
    LessonState.userProgress = {};
    LessonState.continueLearningLesson = null;
    LessonState.currentTopic = null;
    
    // Reset practice state
    PracticeState.currentTopic = null;
    PracticeState.currentExercise = null;
    PracticeState.exercises = [];
    PracticeState.timer = 300;
    PracticeState.timerInterval = null;
    PracticeState.isExerciseActive = false;
    PracticeState.isReviewMode = false;
    PracticeState.userPracticeProgress = {};
    
    // Reset quiz state
    QuizState.currentQuiz = null;
    QuizState.currentQuestionIndex = 0;
    QuizState.questions = [];
    QuizState.userAnswers = {};
    QuizState.timer = 0;
    QuizState.timerInterval = null;
    QuizState.isQuizActive = false;
    QuizState.currentAttemptId = null;
    QuizState.quizResults = null;
    QuizState.selectedCategory = null;
    QuizState.quizCategories = [];
    
    // Reset progress state
    ProgressState.dailyProgress = null;
    ProgressState.weeklyProgress = null;
    ProgressState.monthlyProgress = null;
    ProgressState.learningGoals = [];
    ProgressState.topicMastery = {};
    ProgressState.moduleProgress = {};
    ProgressState.activityLog = [];
    ProgressState.dashboardStats = null;
    ProgressState.progressTrends = [];
    ProgressState.achievementTimeline = [];
    
    // Hide footer navigation when logging out
    hideFooterNavigation();
    
    // Navigate to login
    navigateTo('login');
    
    showNotification('Logged out successfully', 'info');
}

// Check authentication
function checkAuthentication() {
    // Check if user is authenticated
    if (!AppState.isAuthenticated) {
        console.log('ðŸ” User is not authenticated');
        return false;
    }
    
    // Additional check: verify token is still valid
    const savedUser = localStorage.getItem('mathhub_user');
    if (!savedUser) {
        console.log('ðŸ” No user data found in localStorage');
        AppState.isAuthenticated = false;
        return false;
    }
    
    return true;
}

// ============================================
// APP SELECTION FUNCTIONS - FIXED
// ============================================

// Setup app selection listeners
function setupAppSelectionListeners() {
    console.log('ðŸ”„ Setting up app selection listeners...');
    
    // Listen for app card clicks
    document.addEventListener('click', function(event) {
        // Check if clicked element is an app card or inside an app card
        const appCard = event.target.closest('.app-card');
        if (appCard) {
            const appName = appCard.getAttribute('data-app');
            if (appName) {
                event.preventDefault();
                event.stopPropagation();
                
                console.log(`ðŸŽ® App selected: ${appName}`);
                handleAppSelection(appName);
            }
        }
    });
}

// Handle app selection
function handleAppSelection(appName) {
    console.log(`ðŸ“± Handling app selection: ${appName}`);
    
    switch(appName) {
        case 'mathease':
            // Kapag pinindot ang MathEase, pupunta sa mathease.html
            console.log('Opening MathEase app...');
            showNotification('Opening MathEase...', 'info');
            setTimeout(() => {
                window.location.href = 'mathease.html';
            }, 500);
            break;
            
        case 'polylearn':
            // Kapag pinindot ang PolyLearn, mananatili sa index.html
            console.log('Opening PolyLearn app...');
            
            // Mark that user has selected an app
            AppState.hasSelectedApp = true;
            localStorage.setItem('hasSelectedApp', 'true');
            localStorage.setItem('selectedApp', 'polylearn');
            
            // Navigate to dashboard (which is the PolyLearn app)
            showNotification('Opening PolyLearn Dashboard...', 'success');
            setTimeout(() => {
                navigateTo('dashboard');
            }, 300);
            break;
            
        case 'factolearn':
            // Kapag pinindot ang FactoLearn, pupunta sa factolearn.html
            console.log('Opening FactoLearn app...');
            showNotification('Opening FactoLearn...', 'info');
            setTimeout(() => {
                window.location.href = 'factolearn.html';
            }, 500);
            break;
            
        default:
            console.log(`Unknown app: ${appName}`);
            showNotification(`App ${appName} not found`, 'error');
    }
}

// Initialize app selection page
async function initAppSelectionPage() {
    console.log('ðŸš€ Initializing app selection page...');
    
    // Update user info if needed
    if (AppState.currentUser) {
        const userNameElement = document.querySelector('#app-selection-page .student-name span');
        if (userNameElement) {
            userNameElement.textContent = AppState.currentUser.full_name || AppState.currentUser.username;
        }
    }
    
    // Setup app selection listeners
    setupAppSelectionListeners();
    
    console.log('âœ… App selection page initialized');
}

// ============================================
// NAVIGATION FUNCTIONS
// ============================================

// Navigate to page
function navigateTo(page) {
    console.log(`ðŸ§­ Navigating from ${AppState.currentPage} to ${page}`);
    
    // Define public pages that don't require authentication
    const publicPages = ['loading', 'login', 'signup', 'landing'];
    
    // Check if the target page requires authentication
    if (!publicPages.includes(page) && !checkAuthentication()) {
        console.log('ðŸ”’ Authentication required for page:', page);
        showNotification('Please login to access this page', 'error');
        navigateTo('login');
        return;
    }
    
    // Store previous page before changing
    if (page !== 'moduleDashboard' && page !== 'progress' && page !== 'feedback' && page !== 'settings') {
        AppState.previousPage = AppState.currentPage;
    }
    
    // Define page elements
    const pages = {
        loading: document.getElementById('loading-page'),
        login: document.getElementById('login-page'),
        signup: document.getElementById('signup-page'),
        landing: document.getElementById('landing-page'),
        dashboard: document.getElementById('dashboard-page'),
        appSelection: document.getElementById('app-selection-page'),
        practice: document.getElementById('practice-exercises-page'),
        moduleDashboard: document.getElementById('module-dashboard-page'),
        quizDashboard: document.getElementById('quiz-dashboard-page'),
        progress: document.getElementById('progress-page'),
        feedback: document.getElementById('feedback-page'),
        settings: document.getElementById('settings-page')
    };
    
    // Hide all pages
    Object.values(pages).forEach(p => {
        if (p) p.classList.add('hidden');
    });
    
    // Show target page
    if (pages[page]) {
        pages[page].classList.remove('hidden');
        AppState.currentPage = page;
        
        // Update URL hash for browser history
        window.location.hash = page;
        
        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'instant' });
    } else {
        console.error(`âŒ Page ${page} not found!`);
        return;
    }
    
    // Show/hide navigation based on page type
    toggleFooterNavigation(page);
    
    // Handle page-specific initialization
    switch(page) {
        case 'dashboard':
            if (AppState.currentUser) {
                // Update user info immediately
                updateUserInfo();
                
                // Load data if not already loaded
                if (!ProgressState.cumulativeProgress) {
                    showDashboardLoading();
                    loadInitialData();
                } else {
                    // Just update displays
                    updateOverallProgressDisplay(ProgressState.cumulativeProgress);
                    updateProgressSummaryCards();
                    updateContinueLearningModule();
                }
                
                setupTopNavigation();
            }
            break;
        case 'appSelection':
            if (AppState.currentUser) {
                initAppSelectionPage();
            }
            break;
        case 'practice':
            if (AppState.currentUser) {
                initPracticePage();
                setupTopNavigation();
            }
            break;
        case 'moduleDashboard':
            if (AppState.currentUser) {
                initModuleDashboard();
                setupModuleDashboardNavigation();
                setTimeout(() => {
                    updateModuleDashboardStats(); // Update module dashboard stats
                }, 500);
            }
            break;
        case 'quizDashboard':
            if (AppState.currentUser) {
                initQuizDashboard();
                setupQuizNavigation();
            }
            break;
        case 'progress':
            if (AppState.currentUser) {
                initProgressDashboard();
                setupProgressNavigation();
            }
            break;
        case 'feedback':
            if (AppState.currentUser) {
                initFeedbackDashboard();
                setupFeedbackNavigation();
                addFeedbackStyles();
            }
            break;
        case 'settings':
            if (AppState.currentUser) {
                initSettingsDashboard();
                setupSettingsNavigation();
            }
            break;
    }
    
    console.log(`âœ… Navigation complete. Current page: ${AppState.currentPage}`);
}

// Setup app selection navigation
function setupAppSelectionNavigation() {
    console.log('ðŸ§­ Setting up app selection navigation...');
    
    // Setup logout button in app selection if it exists
    const logoutBtnAppSelection = document.getElementById('logoutBtnAppSelection');
    if (logoutBtnAppSelection) {
        logoutBtnAppSelection.addEventListener('click', function(e) {
            e.preventDefault();
            logoutAndRedirect();
        });
    }
    
    // Setup back to app selection button
    const backToAppSelectionBtn = document.getElementById('backToAppSelectionBtn');
    if (backToAppSelectionBtn) {
        backToAppSelectionBtn.addEventListener('click', function(e) {
            e.preventDefault();
            navigateTo('appSelection');
        });
    }
}


// ============================================
// ðŸš€ ADD THIS: Force update dashboard displays
// ============================================
function updatePracticeStatsDisplay() {
    const stats = PracticeState.userPracticeProgress;
    if (!stats) return;
    
    const practiceStatsEl = document.getElementById('practiceStats');
    if (practiceStatsEl) {
        practiceStatsEl.innerHTML = `
            <div class="stat-card">
                <div class="stat-value">${stats.lessons_completed || 0}</div>
                <div class="stat-label">LESSONS COMPLETED</div>
                <div class="stat-subtext">out of ${stats.total_lessons || 20}</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${stats.exercises_completed || 0}</div>
                <div class="stat-label">EXERCISES COMPLETED</div>
                <div class="stat-subtext">total completed</div>
            </div>
        `;
    }
}

function updateBadgesDisplay(badges) {
    const totalBadges = document.getElementById('totalBadges');
    if (totalBadges) {
        totalBadges.textContent = `${badges.length}/10`;
    }
}

function updateAccuracyDisplay(accuracy) {
    const accuracyRate = document.getElementById('accuracyRate');
    if (accuracyRate) {
        accuracyRate.textContent = `${accuracy.overall}%`;
    }
}


// Toggle footer navigation based on page
function toggleFooterNavigation(page) {
    const navigation = document.querySelector('.footer-nav');
    if (!navigation) return;
    
    // Pages where footer navigation should be hidden
    const hideNavPages = ['loading', 'login', 'signup', 'landing', 'appSelection'];
    
    // Pages where footer navigation should be shown (only after login)
    const showNavPages = [
        'dashboard', 'practice', 'quizDashboard', 'progress', 
        'feedback', 'settings', 'moduleDashboard'
    ];
    
    if (hideNavPages.includes(page)) {
        // Hide footer navigation on loading, login, and signup pages
        navigation.style.display = 'none';
        resetContainerBottomPadding();
    } else if (showNavPages.includes(page) && AppState.isAuthenticated) {
        // Show footer navigation only if authenticated
        navigation.style.display = 'flex';
        adjustContainerBottomPadding();
    } else {
        // Default: hide navigation
        navigation.style.display = 'none';
        resetContainerBottomPadding();
    }
}

// Hide footer navigation
function hideFooterNavigation() {
    const navigation = document.querySelector('.footer-nav');
    if (navigation) {
        navigation.style.display = 'none';
    }
    resetContainerBottomPadding();
}

// Show footer navigation (only when authenticated)
function showFooterNavigation() {
    if (!AppState.isAuthenticated) return;
    
    const navigation = document.querySelector('.footer-nav');
    if (navigation) {
        navigation.style.display = 'flex';
        adjustContainerBottomPadding();
    }
}

function adjustContainerBottomPadding() {
    const containers = document.querySelectorAll(
        '#dashboard-page, ' +
        '#practice-exercises-page, ' +
        '#quiz-dashboard-page, ' +
        '#progress-page, ' +
        '#feedback-page, ' +
        '#settings-page, ' +
        '#module-dashboard-page'
    );
    
    const footerHeight = 70;
    
    containers.forEach(container => {
        container.style.paddingBottom = `${footerHeight + 20}px`;
    });
}


// Reset container padding
function resetContainerBottomPadding() {
    const containers = document.querySelectorAll('.container');
    containers.forEach(container => {
        container.style.paddingBottom = '';
    });
}

// Handle hash changes
window.addEventListener('hashchange', function() {
    const hash = window.location.hash.replace('#', '');
    const pages = {
        loading: document.getElementById('loading-page'),
        login: document.getElementById('login-page'),
        signup: document.getElementById('signup-page'),
        landing: document.getElementById('landing-page'),
        dashboard: document.getElementById('dashboard-page'),
        appSelection: document.getElementById('app-selection-page'),
        practice: document.getElementById('practice-exercises-page'),
        moduleDashboard: document.getElementById('module-dashboard-page'),
        quizDashboard: document.getElementById('quiz-dashboard-page'),
        progress: document.getElementById('progress-page'),
        feedback: document.getElementById('feedback-page'),
        settings: document.getElementById('settings-page')
    };
    
    if (hash && pages[hash]) {
        const publicPages = ['loading', 'login', 'signup', 'landing', 'appSelection'];
        if (!publicPages.includes(hash) && !checkAuthentication()) {
            console.log('Authentication required for page:', hash);
            showNotification('Please login to access this page', 'error');
            navigateTo('login');
            return;
        }
        
        navigateTo(hash);
    }
});

// ============================================
// âœ… UPDATE DASHBOARD - MAKE SURE IT CALLS PROGRESS SUMMARY
// ============================================
async function updateDashboard() {
    if (!AppState.currentUser) return;
    
    console.log('ðŸ“Š Updating dashboard...');
    
    // Update date
    const currentDateElement = document.getElementById('currentDate');
    if (currentDateElement) {
        const now = new Date();
        currentDateElement.textContent = now.toLocaleDateString('en-US', { 
            weekday: 'short', 
            year: 'numeric', 
            month: 'short', 
            day: 'numeric' 
        });
    }
    
    // Update user info
    updateUserInfo();
    
    // Load all data in parallel
    await Promise.all([
        fetchCumulativeProgress(),
        fetchAccuracyRate(),
        fetchUserBadges(),
        updateTodaysLearningStats()
    ]);
    
    // âœ… CRITICAL: Update progress summary cards with database data
    await updateProgressSummaryCards();
    
    // Update continue learning module
    await updateContinueLearningModule();
    
    // Check for new badges
    await checkAndAwardBadges();
    
    console.log('âœ… Dashboard updated with database data');
}

// ============================================
// UPDATE USER INFO
// ============================================
function updateUserInfo() {
    if (!AppState.currentUser) return;
    
    const welcomeTitle = document.getElementById('dashboardWelcomeTitle');
    if (welcomeTitle) {
        welcomeTitle.textContent = `Welcome ${AppState.currentUser.full_name || AppState.currentUser.username}!`;
    }
    
    const studentName = document.querySelector('.student-name span');
    if (studentName) {
        studentName.textContent = `${AppState.currentUser.full_name || AppState.currentUser.username}!`;
    }
    
    // Update user initial
    const userInitial = document.getElementById('userInitial');
    if (userInitial) {
        const name = AppState.currentUser.full_name || AppState.currentUser.username || 'User';
        userInitial.textContent = name.charAt(0).toUpperCase();
    }
}

// Load dashboard statistics
async function loadDashboardStatistics() {
    try {
        // Load progress data for dashboard
        const [dailyProgress, learningGoals, activityLog] = await Promise.all([
            fetchDailyProgress(),
            fetchLearningGoals(),
            fetchActivityLog(5)
        ]);
        
        // Update dashboard stats display
        updateDashboardStatsDisplay(dailyProgress, learningGoals, activityLog);
        
    } catch (error) {
        console.error('Error loading dashboard statistics:', error);
    }
}

// ============================================
// UPDATE DASHBOARD STATS DISPLAY
// ============================================
function updateDashboardStatsDisplay(dailyProgress, learningGoals, activityLog) {
    // Update today's stats
    if (dailyProgress) {
        console.log('ðŸ“Š Updating dashboard stats with daily progress:', dailyProgress);
        updateProgressSummaryCards();
    }
    
    // Update recent activity
    const recentActivityElement = document.getElementById('recentActivity');
    if (recentActivityElement) {
        updateActivityLog();
    }
}

function setupDashboardButtons() {
    console.log('ðŸ”˜ Setting up dashboard buttons...');
    
    const continueLessonBtn = document.getElementById('continueLesson');
    if (continueLessonBtn) {
        continueLessonBtn.addEventListener('click', () => {
            // If there's a continue learning lesson, open it
            if (LessonState.continueLearningLesson) {
                openLesson(LessonState.continueLearningLesson.content_id);
            } else {
                // Otherwise open the first lesson
                if (LessonState.lessons.length > 0) {
                    openLesson(LessonState.lessons[0].content_id);
                }
            }
        });
    }
    
    const practiceExercisesBtn = document.getElementById('practiceExercises');
    if (practiceExercisesBtn) {
        practiceExercisesBtn.addEventListener('click', () => {
            navigateTo('practice');
        });
    }
    
    const startQuizBtn = document.getElementById('goToQuiz');
    if (startQuizBtn) {
        startQuizBtn.addEventListener('click', () => {
            navigateTo('quizDashboard');
        });
    }
    
    const viewProgressBtn = document.getElementById('viewProgress');
    if (viewProgressBtn) {
        viewProgressBtn.addEventListener('click', () => {
            navigateTo('progress');
        });
    }
    
    const goToFeedbackBtn = document.getElementById('goToFeedback');
    if (goToFeedbackBtn) {
        goToFeedbackBtn.addEventListener('click', () => {
            navigateTo('feedback');
        });
    }
}

// Setup top navigation
function setupTopNavigation() {
    console.log('ðŸ” Setting up top navigation...');
    
    // Setup logout button in dashboard
    const logoutBtnDashboard = document.getElementById('logoutBtnDashboard');
    if (logoutBtnDashboard) {
        logoutBtnDashboard.addEventListener('click', function(e) {
            e.preventDefault();
            logoutAndRedirect();
        });
    }
    
    // Setup back to app selection button
    const backToAppSelectionBtn = document.getElementById('backToAppSelectionBtn');
    if (backToAppSelectionBtn) {
        backToAppSelectionBtn.addEventListener('click', function(e) {
            e.preventDefault();
            navigateTo('appSelection');
        });
    }
}

// Setup module dashboard navigation
function setupModuleDashboardNavigation() {
    console.log('ðŸ“š Setting up module dashboard navigation...');
    
    const backToLessonDashboardBtn = document.getElementById('backToLessonDashboard');
    if (backToLessonDashboardBtn) {
        backToLessonDashboardBtn.addEventListener('click', () => {
            console.log('Back button clicked from module dashboard');
            navigateTo('dashboard');
        });
    }
}

// Setup quiz navigation
function setupQuizNavigation() {
    console.log('ðŸ§  Setting up quiz navigation...');
    
    const backToDashboardBtn = document.getElementById('backToDashboardBtn');
    if (backToDashboardBtn) {
        backToDashboardBtn.addEventListener('click', () => {
            navigateTo('dashboard');
        });
    }
}

// Setup progress navigation
function setupProgressNavigation() {
    console.log('ðŸ“ˆ Setting up progress navigation...');
    
    const backToDashboardBtn = document.getElementById('backToDashboardBtnProgress');
    if (backToDashboardBtn) {
        backToDashboardBtn.addEventListener('click', () => {
            navigateTo('dashboard');
        });
    }
}

// Setup feedback navigation
function setupFeedbackNavigation() {
    console.log('ðŸ’¬ Setting up feedback navigation...');
    
    const backToDashboardBtn = document.getElementById('backToDashboardBtnFeedback');
    if (backToDashboardBtn) {
        backToDashboardBtn.addEventListener('click', () => {
            navigateTo('dashboard');
        });
    }
}

// Setup settings navigation
function setupSettingsNavigation() {
    console.log('âš™ï¸ Setting up settings navigation...');
    
    const backToDashboardBtn = document.getElementById('backToDashboardBtnSettings');
    if (backToDashboardBtn) {
        backToDashboardBtn.addEventListener('click', () => {
            navigateTo('dashboard');
        });
    }
}

        // Fix for the rate function error in feedback form
        // Fix for the rate function error in feedback form
function rate(rating) {
    // Update all stars
    const stars = document.querySelectorAll('.star');
    stars.forEach((star, index) => {
        if (index < rating) {
            star.classList.add('active');
            star.innerHTML = 'â˜…';
        } else {
            star.classList.remove('active');
            star.innerHTML = 'â˜†';
        }
    });
    
    // Update hidden input value
    document.getElementById('ratingValue').value = rating;
}
        
        // Initialize rating when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Make sure rating stars are clickable
            const stars = document.querySelectorAll('.rating .star');
            stars.forEach((star, index) => {
                star.addEventListener('click', function() {
                    rate(index + 1);
                });
            });
            
            // Initialize rating value to 0
            document.getElementById('ratingValue').value = 0;
        });

// ============================================
// MODULE DASHBOARD FUNCTIONS
// ============================================

async function initModuleDashboard() {
    console.log('ðŸ“š Initializing module dashboard...');
    
    // Initialize module dashboard JS (this includes video loading from database)
    initModuleDashboardJS();
    
    console.log('âœ… Module dashboard initialized');
}

// ============================================
// OTHER DASHBOARD FUNCTIONS
// ============================================

function initFeedbackDashboard() {
    console.log('ðŸ’¬ Initializing feedback dashboard...');
}

function initSettingsDashboard() {
    console.log('âš™ï¸ Initializing settings dashboard...');
}

// ============================================
// HAMBURGER MENU FUNCTIONS
// ============================================

// ============================================
// INITIALIZE QUIZ ON PAGE LOAD
// ============================================
document.addEventListener('DOMContentLoaded', function() {
    // Check if quiz dashboard is visible on load
    const quizPage = document.getElementById('quiz-dashboard-page');
    if (quizPage && !quizPage.classList.contains('hidden')) {
        initQuizDashboard();
    }
    
    // Add quiz styles
    addQuizStyles();
    
    // Setup quiz buttons
    setTimeout(setupQuizButtons, 1000);
    
    // Observe for dynamically added quiz buttons
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'childList' || mutation.type === 'subtree') {
                setupQuizButtons();
                connectQuizButtons();
            }
        });
    });
    
    observer.observe(document.body, { childList: true, subtree: true });
});

// ============================================
// ðŸ” UPDATED: initHamburgerMenu - With logout confirmation
// ============================================
function initHamburgerMenu() {
    const hamburgerBtn = document.getElementById('footerHamburgerBtn');
    const closeMenuBtn = document.getElementById('closeMenuBtn');
    const mobileMenuOverlay = document.getElementById('mobileMenuOverlay');
    const mobileMenuPanel = document.getElementById('mobileMenuPanel');
    
    let isMenuOpen = false;
    
    if (hamburgerBtn) {
        hamburgerBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            isMenuOpen = !isMenuOpen;
            
            if (isMenuOpen) {
                if (mobileMenuOverlay) {
                    mobileMenuOverlay.classList.add('active');
                }
                if (mobileMenuPanel) {
                    mobileMenuPanel.classList.add('active');
                }
                document.body.style.overflow = 'hidden';
            } else {
                if (mobileMenuOverlay) {
                    mobileMenuOverlay.classList.remove('active');
                }
                if (mobileMenuPanel) {
                    mobileMenuPanel.classList.remove('active');
                }
                document.body.style.overflow = '';
            }
        });
    }
    
    if (closeMenuBtn) {
        closeMenuBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            isMenuOpen = false;
            if (mobileMenuOverlay) {
                mobileMenuOverlay.classList.remove('active');
            }
            if (mobileMenuPanel) {
                mobileMenuPanel.classList.remove('active');
            }
            document.body.style.overflow = '';
        });
    }
    
    if (mobileMenuOverlay) {
        mobileMenuOverlay.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            isMenuOpen = false;
            this.classList.remove('active');
            if (mobileMenuPanel) {
                mobileMenuPanel.classList.remove('active');
            }
            document.body.style.overflow = '';
        });
    }
    
    adjustContentPadding();
    
    window.addEventListener('resize', adjustContentPadding);
    
    const footerNavItems = document.querySelectorAll('.footer-nav-item');
    
    footerNavItems.forEach(item => {
        item.removeAttribute('onclick');
        
        item.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const page = this.getAttribute('data-page');
            
            footerNavItems.forEach(navItem => {
                navItem.classList.remove('active');
            });
            
            this.classList.add('active');
            
            switch(page) {
                case 'dashboard':
                    showDashboard(e);
                    break;
                case 'practice':
                    showPracticeDashboard(e);
                    break;
                case 'quiz':
                    showQuizDashboard(e);
                    break;
                case 'settings':
                    showSettingsPage(e);
                    break;
                default:
                    console.log('Unknown page:', page);
            }
        });
    });
    
    const mobileMenuItems = document.querySelectorAll('.mobile-menu-item');
    mobileMenuItems.forEach((item, index) => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            if (index === 0) showDashboard(e);
            else if (index === 1) showPracticeDashboard(e);
            else if (index === 2) showQuizDashboard(e);
            else if (index === 3) showProgressPage(e);
            else if (index === 4) showFeedbackPage(e);
            else if (index === 5) showSettingsPage(e);
            else if (index === 6) goToModuleDashboard(e);
            else if (index === 7) logoutUser(e);
        });
    });
}

// âœ… Helper function to close mobile menu
function closeMobileMenu() {
    const mobileMenuOverlay = document.getElementById('mobileMenuOverlay');
    const mobileMenuPanel = document.getElementById('mobileMenuPanel');
    
    if (mobileMenuOverlay) {
        mobileMenuOverlay.classList.remove('active');
    }
    if (mobileMenuPanel) {
        mobileMenuPanel.classList.remove('active');
    }
    document.body.style.overflow = '';
}

// ============================================
// ðŸšª COMPLETE LOGOUT CONFIRMATION
// ============================================

// Show logout confirmation
function showLogoutConfirmation() {
    console.log('ðŸšª Showing logout confirmation');
    
    const modal = document.getElementById('logoutModal');
    if (!modal) {
        createLogoutModal();
        return;
    }
    
    modal.style.display = 'flex';
    document.body.classList.add('modal-open');
}

// Close modal
function closeLogoutModal() {
    const modal = document.getElementById('logoutModal');
    if (modal) {
        modal.style.display = 'none';
        document.body.classList.remove('modal-open');
    }
}

// Confirm logout
function confirmLogout() {
    console.log('âœ… Logout confirmed');
    closeLogoutModal();
    showNotification('ðŸ‘‹ See you next time!', 'info');
    setTimeout(logoutAndRedirect, 500);
}

// Create modal if missing
function createLogoutModal() {
    const modalHTML = `...`; // (use the HTML from Step 2)
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    setTimeout(showLogoutConfirmation, 100);
}

// Make available globally
window.showLogoutConfirmation = showLogoutConfirmation;
window.closeLogoutModal = closeLogoutModal;
window.confirmLogout = confirmLogout;

// Close logout modal
function closeLogoutModal() {
    console.log('ðŸšª Closing logout modal');
    const modal = document.getElementById('logoutModal');
    if (modal) {
        modal.style.display = 'none';
        document.body.classList.remove('modal-open');
    }
}

// Confirm logout - actual logout
function confirmLogout() {
    console.log('âœ… Logout confirmed');
    
    closeLogoutModal();
    showNotification('ðŸ‘‹ See you next time!', 'info');
    
    setTimeout(() => {
        logoutAndRedirect();
    }, 500);
}

// Create modal if not exists (fallback)
function createLogoutModal() {
    const modalHTML = `
        <div id="logoutModal" class="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); z-index: 10000; justify-content: center; align-items: center; animation: fadeIn 0.3s ease; padding: 15px;">
            
            <!-- Modal Container - Admin style -->
            <div style="background: white; max-width: 380px; width: 100%; border-radius: 16px; overflow: hidden; box-shadow: 0 20px 40px -12px rgba(0,0,0,0.4);">
                
                <!-- Modal Header - Gaya ng admin -->
                <div style="background: #b90404; color: white; padding: 16px 20px; display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin: 0; font-size: 18px; font-weight: 600; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-sign-out-alt"></i> 
                        Confirm Logout
                    </h3>
                    <button onclick="closeLogoutModal()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer; line-height: 1; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">&times;</button>
                </div>
                
                <!-- Modal Body - Gaya ng admin -->
                <div style="padding: 25px 20px; text-align: center; background: white;">
                    
                    <!-- Warning Icon - Gaya ng admin -->
                    <div style="width: 70px; height: 70px; border-radius: 50%; background: #fff3cd; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 35px; color: #856404;"></i>
                    </div>
                    
                    <!-- Title - Gaya ng admin -->
                    <h4 style="margin: 0 0 8px; font-size: 18px; font-weight: 600; color: #2c3e50;">
                        Are you sure you want to logout?
                    </h4>
                    
                    <!-- Message - Gaya ng admin -->
                    <p style="color: #7f8c8d; margin: 0 0 20px; font-size: 14px; line-height: 1.5;">
                        You are about to log out from your MathHub Student account. 
                        Your progress is automatically saved.
                    </p>
                    
                    <!-- Details Section - Gaya ng admin -->
                    <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; margin: 0 0 20px; text-align: left;">
                        
                        <!-- Account Info -->
                        <p style="margin: 8px 0; color: #2c3e50; font-size: 14px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-user" style="width: 18px; color: #7a0000;"></i>
                            <strong style="min-width: 80px;">Account:</strong> 
                            <span id="confirmationAccountEmail" style="color: #34495e;">student@mathhub.com</span>
                        </p>
                        
                        <!-- Session Time -->
                        <p style="margin: 8px 0; color: #2c3e50; font-size: 14px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-clock" style="width: 18px; color: #7a0000;"></i>
                            <strong style="min-width: 80px;">Session:</strong> 
                            <span id="confirmationSessionTime" style="color: #34495e;">Just now</span>
                        </p>
                        
                        <!-- Student Level -->
                        <p style="margin: 8px 0; color: #2c3e50; font-size: 14px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-graduation-cap" style="width: 18px; color: #7a0000;"></i>
                            <strong style="min-width: 80px;">Level:</strong> 
                            <span id="studentLevel" style="color: #34495e;">Beginner</span>
                        </p>
                    </div>
                    
                    <!-- Action Buttons - Gaya ng admin -->
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        
                        <!-- Cancel Button -->
                        <button onclick="closeLogoutModal()" style="flex: 1; padding: 12px 15px; background: #ecf0f1; color: #2c3e50; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.3s;">
                            <i class="fas fa-times"></i>
                            Cancel
                        </button>
                        
                        <!-- Logout Button -->
                        <button onclick="confirmLogout()" style="flex: 1; padding: 12px 15px; background: #7a0000; color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.3s;">
                            <i class="fas fa-sign-out-alt"></i>
                            Logout
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Animation Keyframes -->
        <style>
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            
            /* Hover effects */
            #logoutModal button {
                transition: all 0.3s ease;
            }
            
            #logoutModal button:hover {
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            }
            
            #logoutModal .btn-logout:hover {
                background: #5a0000 !important;
                box-shadow: 0 5px 15px rgba(122, 0, 0, 0.3);
            }
            
            /* Mobile optimization */
            @media (max-width: 480px) {
                #logoutModal .modal-container {
                    max-width: 320px;
                }
                
                #logoutModal .confirmation-details p {
                    font-size: 13px;
                }
                
                #logoutModal .confirmation-details strong {
                    min-width: 70px;
                }
                
                #logoutModal button {
                    padding: 10px 12px;
                    font-size: 13px;
                }
            }
        </style>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    console.log('âœ… Logout modal created');
    showLogoutConfirmation(); // Try again
}

// Make functions globally available
window.showLogoutConfirmation = showLogoutConfirmation;
window.closeLogoutModal = closeLogoutModal;
window.confirmLogout = confirmLogout;
// Show dashboard
function showDashboard(e) {
    if (e) e.preventDefault();
    closeMobileMenu();
    navigateTo('dashboard');
    updateActiveNav('dashboard');
}

// Show practice dashboard
function showPracticeDashboard(e) {
    if (e) e.preventDefault();
    closeMobileMenu();
    navigateTo('practice');
    updateActiveNav('practice');
}

// Show quiz dashboard
function showQuizDashboard(e) {
    if (e) e.preventDefault();
    closeMobileMenu();
    navigateTo('quizDashboard');
    updateActiveNav('quiz');
}

// Show progress page
function showProgressPage(e) {
    if (e) e.preventDefault();
    closeMobileMenu();
    navigateTo('progress');
    updateActiveNav('progress');
}

// Show feedback page
function showFeedbackPage(e) {
    if (e) e.preventDefault();
    closeMobileMenu();
    navigateTo('feedback');
    updateActiveNav('feedback');
}

// Show settings page
function showSettingsPage(e) {
    if (e) e.preventDefault();
    closeMobileMenu();
    navigateTo('settings');
    updateActiveNav('settings');
}

// Go to module dashboard
function goToModuleDashboard(e) {
    if (e) e.preventDefault();
    closeMobileMenu();
    
    // If there's a continue learning lesson, open it
    if (LessonState.continueLearningLesson) {
        openLesson(LessonState.continueLearningLesson.content_id);
    } else if (LessonState.lessons.length > 0) {
        // Otherwise open the first lesson
        openLesson(LessonState.lessons[0].content_id);
    } else {
        navigateTo('moduleDashboard');
    }
    updateActiveNav('lessons');
}

// Logout user
// ============================================
// ðŸšª UPDATED: logoutUser - With confirmation
// ============================================
function logoutUser(e) {
    if (e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    // Close mobile menu first
    const mobileMenuOverlay = document.getElementById('mobileMenuOverlay');
    const mobileMenuPanel = document.getElementById('mobileMenuPanel');
    
    if (mobileMenuOverlay && mobileMenuPanel) {
        mobileMenuOverlay.classList.remove('active');
        mobileMenuPanel.classList.remove('active');
        document.body.style.overflow = '';
    }
    
    // Show confirmation modal instead of direct logout
    showLogoutConfirmation();
}

// Close mobile menu
function closeMobileMenu() {
    const mobileMenuOverlay = document.getElementById('mobileMenuOverlay');
    const mobileMenuPanel = document.getElementById('mobileMenuPanel');
    
    if (mobileMenuOverlay && mobileMenuPanel) {
        mobileMenuOverlay.classList.remove('active');
        mobileMenuPanel.classList.remove('active');
        document.body.style.overflow = '';
    }
}

// Update active navigation
function updateActiveNav(activeItem) {
    const footerItems = document.querySelectorAll('.footer-nav-item');
    footerItems.forEach(item => item.classList.remove('active'));
    
    const mobileItems = document.querySelectorAll('.mobile-menu-item');
    mobileItems.forEach(item => item.classList.remove('active'));
    
    const currentPage = getCurrentPage();
    
    if (activeItem) {
        if (activeItem === 'dashboard') {
            document.querySelector('.footer-nav-item:nth-child(1)')?.classList.add('active');
            document.querySelector('.mobile-menu-item:nth-child(1)')?.classList.add('active');
        } else if (activeItem === 'practice') {
            document.querySelector('.footer-nav-item:nth-child(2)')?.classList.add('active');
            document.querySelector('.mobile-menu-item:nth-child(2)')?.classList.add('active');
        } else if (activeItem === 'quiz') {
            document.querySelector('.footer-nav-item:nth-child(4)')?.classList.add('active');
            document.querySelector('.mobile-menu-item:nth-child(3)')?.classList.add('active');
        } else if (activeItem === 'progress') {
            document.querySelector('.mobile-menu-item:nth-child(4)')?.classList.add('active');
        } else if (activeItem === 'feedback') {
            document.querySelector('.mobile-menu-item:nth-child(5)')?.classList.add('active');
        } else if (activeItem === 'settings') {
            document.querySelector('.footer-nav-item:nth-child(5)')?.classList.add('active');
            document.querySelector('.mobile-menu-item:nth-child(6)')?.classList.add('active');
        }
    } else if (currentPage) {
        if (currentPage.includes('dashboard')) {
            updateActiveNav('dashboard');
        } else if (currentPage.includes('practice')) {
            updateActiveNav('practice');
        } else if (currentPage.includes('quiz')) {
            updateActiveNav('quiz');
        } else if (currentPage.includes('progress')) {
            updateActiveNav('progress');
        } else if (currentPage.includes('feedback')) {
            updateActiveNav('feedback');
        } else if (currentPage.includes('settings')) {
            updateActiveNav('settings');
        }
    }
}

// Get current page
function getCurrentPage() {
    const pages = [
        'dashboard-page',
        'practice-exercises-page',
        'quiz-dashboard-page',
        'progress-page',
        'feedback-page',
        'settings-page',
        'module-dashboard-page',
        'app-selection-page'
    ];
    
    for (const page of pages) {
        const pageElement = document.getElementById(page);
        if (pageElement && !pageElement.classList.contains('hidden')) {
            return page;
        }
    }
    return 'dashboard-page';
}

// Adjust content padding
function adjustContentPadding() {
    const footerHeight = 70;
    const containers = document.querySelectorAll('.container, .dashboard-container, .practice-container, .quiz-container, .progress-container');
    
    containers.forEach(container => {
        container.style.marginBottom = `${footerHeight}px`;
    });
}

// ============================================
// UTILITY FUNCTIONS
// ============================================

// Show error message
function showError(elementId, message) {
    const element = document.getElementById(elementId);
    if (element) {
        element.textContent = message;
        element.style.display = 'block';
    }
}

// Hide error message
function hideError(elementId) {
    const element = document.getElementById(elementId);
    if (element) element.style.display = 'none';
}

// Show notification
function showNotification(message, type = 'success') {
    console.log(`ðŸ“¢ ${type.toUpperCase()}: ${message}`);
    
    // Remove existing notifications
    const existingNotifications = document.querySelectorAll('.notification');
    existingNotifications.forEach(notification => {
        notification.remove();
    });
    
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    
    const icon = type === 'success' ? 'fa-check-circle' : 
                 type === 'error' ? 'fa-exclamation-circle' :
                 type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle';
    
    notification.innerHTML = `
        <div class="notification-content">
            <i class="fas ${icon}"></i>
            <span>${message}</span>
        </div>
    `;
    
    // Add styles
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#27ae60' : 
                    type === 'error' ? '#e74c3c' : 
                    type === 'warning' ? '#f39c12' : '#3498db'};
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 10000;
        animation: slideInRight 0.3s ease, fadeOut 0.3s ease 2.7s;
        max-width: 300px;
        font-size: 0.95rem;
        display: flex;
        align-items: center;
        gap: 10px;
    `;
    
    // Add animation styles if not already present
    if (!document.querySelector('#notification-styles')) {
        const style = document.createElement('style');
        style.id = 'notification-styles';
        style.textContent = `
            @keyframes slideInRight {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes fadeOut {
                from { opacity: 1; }
                to { opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    }
    
    // Add to DOM
    document.body.appendChild(notification);
    
    // Auto-remove after 3 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 3000);
    
    // Allow click to dismiss
    notification.addEventListener('click', () => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    });
}

// ============================================
// EXPORT FUNCTIONS FOR GLOBAL ACCESS
// ============================================

// Make functions globally available
window.initApp = initApp;
window.navigateTo = navigateTo;
window.logoutAndRedirect = logoutAndRedirect;
window.showNotification = showNotification;
window.openLesson = openLesson;
window.updateLessonProgress = updateLessonProgress;
window.openPracticeForTopic = openPracticeForTopic;
window.checkPracticeUnlocked = checkPracticeUnlocked;
window.loadPracticeExercisesForTopic = loadPracticeExercisesForTopic;
window.startQuiz = startQuiz;
window.reviewQuiz = reviewQuiz;
window.initProgressDashboard = initProgressDashboard;
window.fetchDailyProgress = fetchDailyProgress;
window.fetchLearningGoals = fetchLearningGoals;
window.logUserActivity = logUserActivity;
window.updateDailyProgress = updateDailyProgress;

// Quick fix for PolyLearn app card (event delegation)
document.addEventListener('DOMContentLoaded', function() {
    // Listen for clicks on PolyLearn app card using event delegation
    document.addEventListener('click', function(event) {
        // Check if clicked element is PolyLearn card or inside it
        const polyLearnCard = event.target.closest('.app-card[data-app="polylearn"], .polylearn');
        if (polyLearnCard) {
            event.preventDefault();
            event.stopPropagation();
            
            console.log('PolyLearn card clicked via event delegation!');
            
            // Mark that user has selected an app
            AppState.hasSelectedApp = true;
            localStorage.setItem('hasSelectedApp', 'true');
            localStorage.setItem('selectedApp', 'polylearn');
            
            // Navigate to dashboard
            navigateTo('dashboard');
            return false;
        }
    });
});

// ============================================
// DEBUG FUNCTIONS
// ============================================

async function debugLessonCount() {
    console.log('ðŸ” DEBUG LESSON COUNT');
    console.log('Current ProgressState.dailyProgress:', ProgressState.dailyProgress);
    console.log('Current ProgressState.dashboardStats:', ProgressState.dashboardStats);
    console.log('LessonState.userProgress count:', Object.keys(LessonState.userProgress).length);
    
    // Count completed lessons
    let completedCount = 0;
    Object.values(LessonState.userProgress).forEach(progress => {
        if (progress.status === 'completed') completedCount++;
    });
    console.log('Locally completed lessons:', completedCount);
    
    // Fetch fresh data from server
    try {
        const token = localStorage.getItem('authToken');
        if (token) {
            const response = await fetch(`/api/progress/daily`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await response.json();
            console.log('Server daily progress:', data);
            
            // Force refresh UI
            updateProgressSummaryCards();
            console.log('UI refreshed');
        }
    } catch (error) {
        console.error('Debug fetch error:', error);
    }
}

function resetLessonCount() {
    console.log('ðŸ”„ Resetting lesson count locally...');
    
    // Reset local state
    if (ProgressState.dailyProgress) {
        ProgressState.dailyProgress.lessons_completed = 0;
    }
    
    // Update UI
    updateProgressSummaryCards();
    
    // Clear related localStorage
    localStorage.removeItem('video_watch_time_');
    
    console.log('âœ… Lesson count reset locally');
    showNotification('Lesson count reset locally', 'info');
}
// Function para i-load ang progress summary
async function loadProgressSummary() {
    try {
        const token = localStorage.getItem('token');
        if (!token) {
            console.log('No token found');
            return;
        }
        
        const response = await fetch('/api/progress/summary', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            const summary = data.summary;
            
            // Update HTML elements
            document.getElementById('lessonsCount').innerHTML = 
                `${summary.lessonsCount}<span class="item-unit">/${summary.totalLessons}</span>`;
            
            document.getElementById('exercisesCount').innerHTML = 
                `${summary.exercisesCount}<span class="item-unit">/${summary.totalExercises}</span>`;
            
            document.getElementById('quizScore').innerHTML = 
                `${summary.quizScore}<span class="item-unit">points</span>`;
            
            document.getElementById('avgTime').innerHTML = 
                `${summary.avgTime}<span class="item-unit">minutes/day</span>`;
            
            console.log('âœ… Progress summary updated:', summary);
        } else {
            console.error('Failed to load progress summary:', data.message);
        }
    } catch (error) {
        console.error('Error loading progress summary:', error);
    }
}

// Load progress summary kapag na-load na ang page
document.addEventListener('DOMContentLoaded', function() {
    loadProgressSummary();
    
    // Optional: Auto-refresh every 30 seconds
    setInterval(loadProgressSummary, 30000);
});

// Optional: Function para i-refresh manually
function refreshProgress() {
    loadProgressSummary();
    alert('Progress data refreshed!');
}


// MARK LESSON COMPLETE FUNCTIONALITY
document.addEventListener('DOMContentLoaded', function() {
    // Check if we're on a lesson page
    const completeLessonBtn = document.getElementById('completeLessonBtn');
    
    if (completeLessonBtn) {
        completeLessonBtn.addEventListener('click', markLessonComplete);
        
        // Check if lesson is already completed
        checkLessonCompletionStatus();
    }
});
// ============================================
// â±ï¸ TIME TRACKING MANAGER - Handles all time resets
// ============================================
class TimeTrackingManager {
    constructor() {
        this.sessionStartTime = null;
        this.currentContentId = null;
        this.lastResetTime = null;
        this.weeklyResetDay = 0; // Sunday (0 = Sunday, 1 = Monday, etc.)
        this.init();
    }

    init() {
        console.log('â±ï¸ Initializing Time Tracking Manager...');
        
        // Check and apply weekly reset
        this.checkWeeklyReset();
        
        // Setup page visibility change detection
        this.setupVisibilityDetection();
        
        // Setup before unload detection
        this.setupBeforeUnloadDetection();
        
        // Start weekly check
        this.startWeeklyCheck();
    }

    // ============================================
    // ðŸšª DETECT WHEN USER LEAVES LESSON DASHBOARD
    // ============================================
    setupVisibilityDetection() {
        // Detect when page becomes hidden (user switches tab/minimizes)
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                console.log('ðŸ‘‹ User left the page - resetting session time');
                this.resetSessionTime();
            } else {
                console.log('ðŸ‘‹ User returned to page');
                this.sessionStartTime = Date.now();
            }
        });

        // Detect when user navigates away from module dashboard
        const moduleDashboard = document.getElementById('module-dashboard-page');
        if (moduleDashboard) {
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                        // If module dashboard becomes hidden (user left)
                        if (moduleDashboard.classList.contains('hidden')) {
                            console.log('ðŸ“š User left lesson dashboard - resetting session time');
                            this.resetSessionTime();
                        } else {
                            // User entered module dashboard
                            console.log('ðŸ“š User entered lesson dashboard');
                            this.sessionStartTime = Date.now();
                            this.currentContentId = this.getCurrentLessonId();
                        }
                    }
                });
            });
            
            observer.observe(moduleDashboard, { attributes: true });
        }

        // Detect navigation away from module dashboard
        const originalNavigateTo = window.navigateTo;
        window.navigateTo = (page) => {
            if (AppState.currentPage === 'moduleDashboard' && page !== 'moduleDashboard') {
                console.log('ðŸ§­ Navigating away from lesson dashboard - resetting session time');
                this.resetSessionTime();
            }
            originalNavigateTo(page);
        };
    }

    // ============================================
    // ðŸ’¾ RESET SESSION TIME WHEN LEAVING
    // ============================================
    async resetSessionTime() {
        if (!this.currentContentId || !this.sessionStartTime) {
            console.log('â±ï¸ No active session to reset');
            return;
        }

        const sessionDuration = Math.floor((Date.now() - this.sessionStartTime) / 1000);
        
        // Only reset if session was significant (> 10 seconds)
        if (sessionDuration > 10) {
            console.log(`â±ï¸ Resetting session time for content ${this.currentContentId} - Duration: ${sessionDuration}s`);
            
            try {
                const token = localStorage.getItem('authToken') || authToken;
                
                // DO NOT save the time - this is the reset
                // Instead, we'll mark that the session ended
                await fetch(`/api/progress/session-end`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content_id: this.currentContentId,
                        session_duration: sessionDuration,
                        abandoned: true // Mark as abandoned session
                    })
                });
                
                console.log('âœ… Session reset - time not recorded');
                
            } catch (error) {
                console.error('âŒ Error resetting session:', error);
            }
        }
        
        // Reset session tracking
        this.sessionStartTime = null;
        this.currentContentId = null;
    }

    // ============================================
    // ðŸ“… WEEKLY RESET CHECK
    // ============================================
    checkWeeklyReset() {
        const lastResetKey = 'weekly_avg_time_reset';
        const lastReset = localStorage.getItem(lastResetKey);
        
        if (!lastReset) {
            // First time - set reset date
            this.setNextResetDate();
            return;
        }
        
        const lastResetDate = new Date(lastReset);
        const now = new Date();
        
        // Calculate days since last reset
        const daysSinceReset = Math.floor((now - lastResetDate) / (1000 * 60 * 60 * 24));
        
        // Check if it's time for weekly reset (7 days passed)
        if (daysSinceReset >= 7) {
            console.log('ðŸ“… Weekly reset triggered - days since reset:', daysSinceReset);
            this.performWeeklyReset();
            this.setNextResetDate();
        } else {
            console.log(`ðŸ“… Next weekly reset in ${7 - daysSinceReset} days`);
        }
    }

    // ============================================
    // ðŸ”„ PERFORM WEEKLY RESET OF AVERAGE TIME
    // ============================================
    async performWeeklyReset() {
        console.log('ðŸ”„ Performing weekly reset of average time...');
        
        try {
            const token = localStorage.getItem('authToken') || authToken;
            
            // Call server to reset weekly average
            const response = await fetch(`/api/progress/reset-weekly-avg`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                console.log('âœ… Weekly average reset successfully:', data);
                
                // Update local state
                if (ProgressState.cumulativeProgress) {
                    ProgressState.cumulativeProgress.avg_display_time = 0;
                }
                
                // Update UI
                this.updateAverageTimeDisplay(0);
                
                // Show notification
                showNotification('ðŸ“Š Weekly average time has been reset!', 'info');
                
            } else {
                console.warn('âš ï¸ Weekly reset endpoint not available, resetting locally');
                this.performLocalWeeklyReset();
            }
            
        } catch (error) {
            console.error('âŒ Error performing weekly reset:', error);
            this.performLocalWeeklyReset();
        }
    }

    // ============================================
    // ðŸ“ LOCAL WEEKLY RESET (fallback)
    // ============================================
    performLocalWeeklyReset() {
        console.log('ðŸ“ Performing local weekly reset');
        
        // Reset in ProgressState
        if (ProgressState.cumulativeProgress) {
            ProgressState.cumulativeProgress.avg_display_time = 0;
            ProgressState.cumulativeProgress.weekly_time_spent = 0;
        }
        
        // Reset in PracticeState
        if (PracticeState.userPracticeProgress) {
            PracticeState.userPracticeProgress.weekly_average = 0;
        }
        
        // Update UI
        this.updateAverageTimeDisplay(0);
        
        // Clear weekly data in localStorage
        const keysToRemove = [];
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && (key.includes('weekly') || key.includes('avg_time'))) {
                keysToRemove.push(key);
            }
        }
        
        keysToRemove.forEach(key => localStorage.removeItem(key));
        
        showNotification('ðŸ“Š Weekly average reset (local mode)', 'info');
    }

    // ============================================
    // ðŸ“… SET NEXT RESET DATE
    // ============================================
    setNextResetDate() {
        const now = new Date();
        localStorage.setItem('weekly_avg_time_reset', now.toISOString());
        
        // Calculate next reset date (7 days from now)
        const nextReset = new Date(now);
        nextReset.setDate(nextReset.getDate() + 7);
        localStorage.setItem('next_weekly_reset', nextReset.toISOString());
        
        console.log(`ðŸ“… Next weekly reset scheduled for: ${nextReset.toLocaleDateString()}`);
    }

    // ============================================
    // â° START WEEKLY CHECK INTERVAL
    // ============================================
    startWeeklyCheck() {
        // Check every hour if we need to reset
        setInterval(() => {
            this.checkWeeklyReset();
        }, 60 * 60 * 1000); // Every hour
    }

    // ============================================
    // ðŸ–¥ï¸ DETECT BEFORE PAGE UNLOAD
    // ============================================
    setupBeforeUnloadDetection() {
        window.addEventListener('beforeunload', () => {
            if (this.sessionStartTime && this.currentContentId) {
                const sessionDuration = Math.floor((Date.now() - this.sessionStartTime) / 1000);
                
                // Save to localStorage that session was abandoned
                const abandonedSessions = JSON.parse(localStorage.getItem('abandoned_sessions') || '[]');
                abandonedSessions.push({
                    content_id: this.currentContentId,
                    duration: sessionDuration,
                    timestamp: new Date().toISOString()
                });
                
                // Keep only last 10
                if (abandonedSessions.length > 10) {
                    abandonedSessions.shift();
                }
                
                localStorage.setItem('abandoned_sessions', JSON.stringify(abandonedSessions));
            }
        });
    }

    // ============================================
    // ðŸ†” GET CURRENT LESSON ID
    // ============================================
    getCurrentLessonId() {
        return LessonState.currentLesson?.content_id || 
               document.querySelector('[data-lesson-id]')?.dataset.lessonId ||
               new URLSearchParams(window.location.search).get('contentId');
    }

    // ============================================
    // ðŸ“Š UPDATE AVERAGE TIME DISPLAY
    // ============================================
    updateAverageTimeDisplay(newAvg) {
        const avgTimeElement = document.getElementById('avgTime');
        if (avgTimeElement) {
            avgTimeElement.innerHTML = `${newAvg}<span class="item-unit">min avg</span>`;
        }
        
        // Update in progress summary cards
        const avgTimeCard = document.querySelector('.stat-card .stat-value');
        // Find the avg time card and update
    }

    // ============================================
    // ðŸ” GET REMAINING DAYS UNTIL RESET
    // ============================================
    getDaysUntilReset() {
        const nextReset = localStorage.getItem('next_weekly_reset');
        if (!nextReset) return 7;
        
        const nextResetDate = new Date(nextReset);
        const now = new Date();
        
        const daysRemaining = Math.ceil((nextResetDate - now) / (1000 * 60 * 60 * 24));
        return Math.max(0, daysRemaining);
    }

    // ============================================
    // ðŸ“ˆ GET CURRENT WEEKLY AVERAGE
    // ============================================
    getCurrentWeeklyAverage() {
        const daysUntilReset = this.getDaysUntilReset();
        const daysPassed = 7 - daysUntilReset;
        
        // Get total time from this week
        const totalTimeThisWeek = ProgressState.cumulativeProgress?.weekly_time_spent || 0;
        
        if (daysPassed === 0) return 0;
        
        return Math.round(totalTimeThisWeek / daysPassed);
    }
}

// ============================================
// ðŸš€ INITIALIZE TIME TRACKER
// ============================================
// Initialize the time tracker after DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    // Initialize time tracker
    window.timeTracker = new TimeTrackingManager();
    
    // Check for abandoned sessions from previous page loads
    const abandonedSessions = JSON.parse(localStorage.getItem('abandoned_sessions') || '[]');
    if (abandonedSessions.length > 0) {
        console.log('ðŸ“Š Found abandoned sessions:', abandonedSessions);
        
        // Clear them after logging
        localStorage.removeItem('abandoned_sessions');
        
        // You could optionally show a notification
        showNotification(`You had ${abandonedSessions.length} incomplete sessions`, 'info');
    }
});


// ============================================
// END OF FILE
// ============================================
console.log('âœ¨ MathHub Application Script Loaded with Time Tracking');
// Initialize the time tracker
const timeTracker = new TimeTrackingManager();


// ============================================
// Check Lesson Completion Status on Load
// ============================================
async function checkLessonCompletionStatus() {
    try {
        const contentId = getCurrentLessonId();
        if (!contentId) return;
        
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) return;
        
        // Check if we already have it in state
        if (LessonState.userProgress[contentId]?.status === 'completed') {
            updateCompleteButtonState(true);
            return;
        }
        
        // âœ… FIX: Add /api/ prefix
        const response = await fetch(`/api/lessons-db/${contentId}`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        // Check if response is JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            console.warn('âš ï¸ Non-JSON response from lesson endpoint');
            return;
        }
        
        if (response.ok) {
            const data = await response.json();
            if (data.success && data.lesson) {
                const progress = data.lesson.progress || {};
                if (progress.status === 'completed') {
                    // Update state
                    if (!LessonState.userProgress[contentId]) {
                        LessonState.userProgress[contentId] = {};
                    }
                    LessonState.userProgress[contentId].status = 'completed';
                    LessonState.userProgress[contentId].percentage = 100;
                    
                    // Update button
                    updateCompleteButtonState(true);
                }
            }
        }
    } catch (error) {
        console.log('Could not check lesson status:', error.message);
    }
}

// ============================================
// FIXED: Mark Lesson Complete Function
// ============================================
async function markLessonComplete() {
    console.log('ðŸŽ¯ Marking lesson as complete...');
    
    const completeLessonBtn = document.getElementById('completeLessonBtn');
    if (!completeLessonBtn) return;
    
    // Check if lesson is already being processed
    if (completeLessonBtn.disabled) {
        console.log('âš ï¸ Already processing, please wait...');
        return;
    }
    
    const contentId = getCurrentLessonId();
    if (!contentId) {
        showNotification('Cannot identify lesson. Please refresh the page.', 'error');
        return;
    }
    
    // Disable button and show loading
    completeLessonBtn.disabled = true;
    const originalText = completeLessonBtn.innerHTML;
    completeLessonBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    
    try {
        // Check if lesson is already completed
        const currentProgress = LessonState.userProgress[contentId] || {};
        if (currentProgress.status === 'completed') {
            showNotification('Lesson already marked as completed!', 'info');
            updateCompleteButtonState(true);
            return;
        }
        
        // Calculate time spent (if available)
        let timeSpentSeconds = 300; // Default 5 minutes
        const videoElement = document.getElementById('lessonVideo');
        if (videoElement && videoElement.duration) {
            timeSpentSeconds = Math.floor(videoElement.currentTime || videoElement.duration);
        }
        
        // STEP 1: Update lesson progress
        console.log(`ðŸ“ Updating lesson progress for content ${contentId}...`);
        
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) {
            showNotification('Please login again', 'error');
            navigateTo('login');
            return;
        }
        
        const progressResponse = await fetch(`/api/lessons-db/${contentId}/progress`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                completion_status: 'completed',
                percentage: 100,
                time_spent_seconds: timeSpentSeconds
            })
        });
        
        if (!progressResponse.ok) {
            throw new Error(`Failed to update progress: ${progressResponse.status}`);
        }
        
        const progressData = await progressResponse.json();
        
        if (!progressData.success) {
            throw new Error(progressData.message || 'Failed to update progress');
        }
        
        console.log('âœ… Lesson progress updated successfully');
        
        // STEP 2: Update daily progress (lessons completed count)
        console.log('ðŸ“Š Updating daily progress...');
        
        // Try using the update-daily endpoint
        try {
            const dailyResponse = await fetch(`/api/progress/update-daily`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    lessons_completed: 1
                })
            });
            
            if (dailyResponse.ok) {
                const dailyData = await dailyResponse.json();
                console.log('âœ… Daily progress updated:', dailyData);
            } else {
                console.warn('âš ï¸ Daily progress endpoint returned:', dailyResponse.status);
                // Try alternative endpoint
                const altResponse = await fetch(`/api/progress/daily`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        lessons_completed: 1
                    })
                });
                
                if (altResponse.ok) {
                    console.log('âœ… Daily progress updated via alternative endpoint');
                } else {
                    console.warn('âš ï¸ Alternative daily progress endpoint also failed');
                }
            }
        } catch (dailyError) {
            console.warn('âš ï¸ Daily progress update failed (non-critical):', dailyError.message);
        }
        
        // STEP 3: Log activity
        try {
            await logUserActivity('lesson_completed', contentId, {
                lesson_title: LessonState.currentLesson?.content_title || 'Lesson',
                time_spent: timeSpentSeconds
            });
        } catch (logError) {
            console.warn('âš ï¸ Activity logging failed:', logError.message);
        }
        
        // STEP 4: Clear video watch time from localStorage
        localStorage.removeItem(`video_watch_time_video_${contentId}`);
        
        // Update local state
        if (!LessonState.userProgress[contentId]) {
            LessonState.userProgress[contentId] = {};
        }
        LessonState.userProgress[contentId].status = 'completed';
        LessonState.userProgress[contentId].percentage = 100;
        
        // Update UI
        updateCompleteButtonState(true);
        showNotification('âœ… Lesson completed successfully!', 'success');
        
        // Refresh dashboard if needed
        if (AppState.currentPage === 'dashboard') {
            setTimeout(() => {
                updateContinueLearningModule();
            }, 1000);
        }
        
        // Optional: Show celebration
        showCelebrationAnimation();
        
    } catch (error) {
        console.error('âŒ Error marking lesson complete:', error);
        showNotification(`Failed to mark lesson as complete: ${error.message}`, 'error');
        
        // Reset button
        completeLessonBtn.innerHTML = originalText;
        completeLessonBtn.disabled = false;
    }
}

// Update button state
// ============================================
// Helper: Update Complete Button State
// ============================================
function updateCompleteButtonState(isCompleted) {
    const button = document.getElementById('completeLessonBtn');
    if (!button) return;
    
    if (isCompleted) {
        button.innerHTML = '<i class="fas fa-check-double"></i> Lesson Completed!';
        button.classList.remove('btn-primary');
        button.classList.add('btn-success');
        button.disabled = true;
    } else {
        button.innerHTML = '<i class="fas fa-check-circle"></i> Mark Lesson Complete';
        button.classList.remove('btn-success');
        button.classList.add('btn-primary');
        button.disabled = false;
    }
}

// ============================================
// Helper: Get Current Lesson ID
// ============================================
function getCurrentLessonId() {
    // Check LessonState first
    if (LessonState.currentLesson?.content_id) {
        return LessonState.currentLesson.content_id;
    }
    
    // Check from URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    let lessonId = urlParams.get('lessonId') || urlParams.get('id') || urlParams.get('contentId');
    
    // Check from data attributes
    if (!lessonId) {
        const lessonElement = document.querySelector('[data-lesson-id]');
        if (lessonElement) {
            lessonId = lessonElement.dataset.lessonId;
        }
    }
    
    // Check from complete button
    if (!lessonId) {
        const completeBtn = document.getElementById('completeLessonBtn');
        if (completeBtn && completeBtn.dataset.lessonId) {
            lessonId = completeBtn.dataset.lessonId;
        }
    }
    
    return lessonId;
}


// Show notification
function showNotification(message, type = 'info') {
    // Remove any existing notifications
    const existingNotification = document.querySelector('.custom-notification');
    if (existingNotification) {
        existingNotification.remove();
    }
    
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `custom-notification alert alert-${type} alert-dismissible fade show`;
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    
    // Style the notification
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
        max-width: 400px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    `;
    
    document.body.appendChild(notification);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

// Show celebration animation
// ============================================
// Helper: Show Celebration Animation
// ============================================
function showCelebrationAnimation() {
    const celebration = document.createElement('div');
    celebration.id = 'celebration-animation';
    celebration.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 9998;
    `;
    
    // Add confetti particles
    for (let i = 0; i < 50; i++) {
        const confetti = document.createElement('div');
        confetti.style.cssText = `
            position: absolute;
            width: 10px;
            height: 10px;
            background: ${getRandomColor()};
            border-radius: 50%;
            top: -10px;
            left: ${Math.random() * 100}%;
            animation: fall ${Math.random() * 2 + 1}s linear forwards;
        `;
        
        // Add animation keyframes if not exists
        if (!document.querySelector('#confetti-styles')) {
            const style = document.createElement('style');
            style.id = 'confetti-styles';
            style.textContent = `
                @keyframes fall {
                    to {
                        transform: translateY(100vh) rotate(${Math.random() * 360}deg);
                        opacity: 0;
                    }
                }
            `;
            document.head.appendChild(style);
        }
        
        celebration.appendChild(confetti);
    }
    
    document.body.appendChild(celebration);
    
    // Remove after animation
    setTimeout(() => {
        if (celebration.parentNode) {
            celebration.remove();
        }
    }, 2000);
}

function getRandomColor() {
    const colors = ['#FF6B6B', '#4ECDC4', '#FFD166', '#06D6A0', '#118AB2', '#EF476F'];
    return colors[Math.floor(Math.random() * colors.length)];
}




// ============================================
// Initialize on page load
// ============================================
document.addEventListener('DOMContentLoaded', function() {
    // Setup complete lesson button
    setupCompleteLessonButton();
    
    // Also check when module dashboard becomes visible
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                const modulePage = document.getElementById('module-dashboard-page');
                if (modulePage && !modulePage.classList.contains('hidden')) {
                    // Module dashboard became visible
                    setTimeout(checkLessonCompletionStatus, 500);
                    setTimeout(setupCompleteLessonButton, 600);
                }
            }
        });
    });
    
    const modulePage = document.getElementById('module-dashboard-page');
    if (modulePage) {
        observer.observe(modulePage, { attributes: true });
    }
});

// Make functions globally available
window.markLessonComplete = markLessonComplete;
window.updateLessonProgress = updateLessonProgress;
window.checkLessonCompletionStatus = checkLessonCompletionStatus;
window.getCurrentLessonId = getCurrentLessonId;
// Update progress summary on dashboard
async function updateProgressSummary() {
    try {
        const token = localStorage.getItem('token');
        if (!token) return;
        
        // Refresh progress data
        const response = await fetch('/api/progress/summary', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            if (data.success && data.summary) {
                // Update progress bars or counters on the page
                updateProgressDisplay(data.summary);
            }
        }
    } catch (error) {
        console.log('Could not update progress display:', error);
    }
}

// Update progress display on page
function updateProgressDisplay(progress) {
    // Update lesson progress
    const lessonElement = document.querySelector('#lessonProgress');
    if (lessonElement) {
        const percentage = progress.totalLessons > 0 ? 
            Math.round((progress.lessonsCount / progress.totalLessons) * 100) : 0;
        lessonElement.textContent = `${progress.lessonsCount}/${progress.totalLessons} (${percentage}%)`;
        
        // Update progress bar if exists
        const lessonBar = document.querySelector('#lessonProgressBar');
        if (lessonBar) {
            lessonBar.style.width = `${percentage}%`;
            lessonBar.setAttribute('aria-valuenow', percentage);
            lessonBar.textContent = `${percentage}%`;
        }
    }
    
    // Update exercise progress
    const exerciseElement = document.querySelector('#exerciseProgress');
    if (exerciseElement) {
        const percentage = progress.totalExercises > 0 ? 
            Math.round((progress.exercisesCount / progress.totalExercises) * 100) : 0;
        exerciseElement.textContent = `${progress.exercisesCount}/${progress.totalExercises} (${percentage}%)`;
    }
    
    // Update quiz score
    const quizElement = document.querySelector('#quizScore');
    if (quizElement) {
        quizElement.textContent = `${progress.quizScore}%`;
    }
}

// ============================================
// FETCH PROGRESS DASHBOARD SUMMARY - UPDATED
// ============================================
async function fetchProgressDashboardSummary() {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) return null;
        
        console.log('ðŸ“Š Fetching Progress Dashboard Summary...');
        
        // âœ… FIX: Add /api/ prefix
        const response = await fetch(`/api/progress/dashboard-summary`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) return null;
        
        // Check if response is JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            console.error('âŒ Non-JSON response:', await response.text().substring(0, 200));
            return null;
        }
        
        const data = await response.json();
        
        if (data.success && data.dashboard) {
            console.log('âœ… Progress Dashboard Summary loaded');
            return data.dashboard;
        } else {
            return null;
        }
    } catch (error) {
        console.error('Error fetching dashboard summary:', error);
        return null;
    }
}

// ============================================
// UPDATE PROGRESS DASHBOARD UI - WITH ACCURACY & BADGES
// ============================================
async function updateProgressDashboardFromDatabase() {
    try {
        // Show loading state
        showProgressDashboardLoading();
        
        // Fetch all data in parallel
        const [dashboardData, badges, accuracy] = await Promise.allSettled([
            fetchProgressDashboardSummary(),
            fetchUserBadges(),
            fetchAccuracyRate()
        ]);
        
        if (dashboardData.status === 'fulfilled' && dashboardData.value) {
            console.log('ðŸ“Š Updating Progress Dashboard UI:', dashboardData.value);
            
            // Update UI with dashboard data
            updateDashboardUI(dashboardData.value);
        } else {
            console.warn('No dashboard data received, using fallback');
            // Use fallback data from other sources
            await updateDashboardWithFallback();
        }
        
        // Update badges display
        if (badges.status === 'fulfilled' && badges.value) {
            updateBadgesDisplay(badges.value);
        }
        
        // Update accuracy display
        if (accuracy.status === 'fulfilled' && accuracy.value) {
            updateAccuracyDisplay(accuracy.value);
        }
        
        console.log('âœ… Progress Dashboard UI updated');
        
    } catch (error) {
        console.error('âŒ Error updating progress dashboard:', error);
    }
}

// Fallback function
async function updateDashboardWithFallback() {
    try {
        const [cumulative, daily] = await Promise.all([
            fetchCumulativeProgress(),
            fetchDailyProgress()
        ]);
        
        // Create fallback dashboard data
        const fallbackData = {
            welcomeTitle: 'Your Learning Progress',
            lastUpdated: `Last updated: ${new Date().toLocaleDateString()}`,
            overallProgress: {
                percentage: cumulative?.overall_percentage || 0,
                barWidth: `${cumulative?.overall_percentage || 0}%`,
                barClass: (cumulative?.overall_percentage || 0) >= 70 ? 'progress-good' : 
                         (cumulative?.overall_percentage || 0) >= 40 ? 'progress-medium' : 'progress-low'
            },
            totalPoints: {
                current: cumulative?.total_points_earned || 0,
                change: `+${cumulative?.weekly?.points || 0} this week`
            },
            timeInvested: {
                total: formatTime(cumulative?.total_time_spent_minutes || 0),
                change: `${cumulative?.weekly?.minutes || 0} min this week`
            },
            badgesEarned: {
                display: '0/10',
                change: '+0 this month'
            }
        };
        
        updateDashboardUI(fallbackData);
        
    } catch (error) {
        console.error('Fallback also failed:', error);
    }
}

function updateDashboardUI(data) {
    // 1. Update Welcome Title and Date
    const welcomeTitle = document.getElementById('progressWelcomeTitle');
    if (welcomeTitle) {
        welcomeTitle.textContent = data.welcomeTitle || 'Your Learning Progress';
    }
    
    const progressDate = document.getElementById('progressDate');
    if (progressDate) {
        progressDate.textContent = data.lastUpdated || `Last updated: ${new Date().toLocaleDateString()}`;
    }
    
    // 2. Update Overall Progress
    const overallProgress = document.getElementById('overallProgress');
    const overallProgressBar = document.getElementById('overallProgressBar');
    if (overallProgress && overallProgressBar) {
        overallProgress.textContent = `${data.overallProgress?.percentage || 0}%`;
        overallProgressBar.style.width = data.overallProgress?.barWidth || '0%';
        overallProgressBar.className = `progress-fill ${data.overallProgress?.barClass || 'progress-low'}`;
    }
    
    // 3. Update Total Points
    const totalPointsProgress = document.getElementById('totalPointsProgress');
    if (totalPointsProgress) {
        totalPointsProgress.textContent = data.totalPoints?.current || 0;
    }
    
    const pointsChange = document.getElementById('pointsChange');
    if (pointsChange) {
        pointsChange.textContent = data.totalPoints?.change || '+0 this week';
    }
    
    // 4. Update Time Invested
    const totalTime = document.getElementById('totalTime');
    if (totalTime) {
        totalTime.textContent = data.timeInvested?.total || '0h';
    }
    
    const timeChange = document.getElementById('timeChange');
    if (timeChange) {
        timeChange.textContent = data.timeInvested?.change || '0 min this week';
    }
    
    // 5. Update Badges
    const totalBadges = document.getElementById('totalBadges');
    if (totalBadges) {
        totalBadges.textContent = data.badgesEarned?.display || '0/10';
    }
    
    const badgesChange = document.getElementById('badgesChange');
    if (badgesChange) {
        badgesChange.textContent = data.badgesEarned?.change || '+0 this month';
    }
}

// ============================================
// âœ… FIXED: SHOW PROGRESS DASHBOARD LOADING
// ============================================
function showProgressDashboardLoading() {
    console.log('â³ Showing loading state');
    
    const elements = [
        { id: 'overallProgress', defaultValue: '0%' },
        { id: 'totalPointsProgress', defaultValue: '0' },
        { id: 'totalTime', defaultValue: '0h' },
        { id: 'totalBadges', defaultValue: '0/10' }
    ];
    
    elements.forEach(item => {
        const element = document.getElementById(item.id);
        if (element) {
            element.setAttribute('data-original', element.textContent);
            element.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            element.style.opacity = '0.7';
            element.classList.add('loading');
        }
    });
}

// ============================================
// FIXED: updateModuleDashboardStats - RAILWAY VERSION
// ============================================
async function updateModuleDashboardStats() {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) return;
        
        console.log('ðŸ“Š Updating module dashboard stats...');
        
        // Get accuracy rate - with error handling for Railway
        try {
            // âœ… FIXED: Add /api/ prefix
            const accuracyResponse = await fetch(`/api/progress/accuracy-rate`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (accuracyResponse.ok) {
                const contentType = accuracyResponse.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    const accuracyData = await accuracyResponse.json();
                    if (accuracyData.success) {
                        const accuracyRate = document.getElementById('accuracyRate');
                        if (accuracyRate) {
                            accuracyRate.textContent = `${accuracyData.accuracy.overall}%`;
                        }
                    }
                }
            } else {
                console.log('âš ï¸ Accuracy endpoint returned:', accuracyResponse.status);
            }
        } catch (accuracyError) {
            console.log('âš ï¸ Could not fetch accuracy rate:', accuracyError.message);
        }
        
        // Get today's stats - with error handling for Railway
        try {
            // âœ… FIXED: Add /api/ prefix
            const todayResponse = await fetch(`/api/progress/today-stats`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (todayResponse.ok) {
                const contentType = todayResponse.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    const todayData = await todayResponse.json();
                    if (todayData.success) {
                        const totalLearningTime = document.getElementById('totalLearningTime');
                        if (totalLearningTime) {
                            const minutes = Math.floor(todayData.stats.totalLearningTime / 60);
                            totalLearningTime.textContent = `${minutes} min`;
                        }
                        
                        const exercisesCompleted = document.getElementById('exercisesCompleted');
                        if (exercisesCompleted) {
                            exercisesCompleted.textContent = `${todayData.stats.exercisesCompleted}/5`;
                        }
                    }
                }
            } else {
                console.log('âš ï¸ Today stats endpoint returned:', todayResponse.status);
            }
        } catch (todayError) {
            console.log('âš ï¸ Could not fetch today stats:', todayError.message);
        }
        
    } catch (error) {
        console.error('Error updating module dashboard stats:', error);
    }
}

// ============================================
// INITIALIZE PROGRESS DASHBOARD WITH DATABASE DATA
// ============================================

async function initProgressDashboardWithDatabase() {
    console.log('ðŸ“Š Initializing Progress Dashboard with database data...');
    
    try {
        // Fetch and update progress summary
        await updateProgressDashboardFromDatabase();
        
        // Also fetch other progress data in parallel
        await Promise.all([
            fetchDailyProgress(),
            fetchCumulativeProgress(),
            fetchWeeklyProgress(),
            fetchMonthlyProgress(),
            fetchLearningGoals(),
            fetchTopicMastery(),
            fetchModuleProgress(),
            fetchActivityLog(15),
            fetchDashboardStats(),
            fetchProgressTrends(30),
            fetchAchievementTimeline(10)
        ]);
        
        // Update other sections
        updateLearningGoalsSection();
        updateActivityLog();
        updateProgressTrendsChart();
        updateAchievementTimeline();
        updateTopicMasterySection();
        updateModuleProgressSection();
        
        console.log('âœ… Progress Dashboard fully initialized with database data');
        
    } catch (error) {
        console.error('âŒ Error initializing progress dashboard:', error);
    }
}

// ============================================
// FETCH ACTIVITY LOG
// ============================================
async function fetchActivityLog(limit = 10) {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) return [];
        
        console.log('ðŸ“‹ Fetching activity log...');
        
        // âœ… FIX: Add /api/ prefix
        const response = await fetch(`/api/dashboard/activity-feed?limit=${limit}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        // Check if response is JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            console.warn('âš ï¸ Non-JSON response from activity feed');
            return [];
        }
        
        if (!response.ok) return [];
        
        const data = await response.json();
        
        if (data.success && data.activities) {
            console.log(`âœ… Fetched ${data.activities.length} activities`);
            ProgressState.activityLog = data.activities;
            return data.activities;
        } else {
            return [];
        }
    } catch (error) {
        console.error('Error fetching activity log:', error);
        return [];
    }
}

// ============================================
// AUTO-REFRESH PROGRESS DASHBOARD - FIXED VERSION
// ============================================
function startProgressAutoRefresh(intervalSeconds = 60) {
    // âœ… I-check muna kung may existing interval
    if (progressRefreshInterval) {
        console.log('â±ï¸ Clearing existing refresh interval...');
        clearInterval(progressRefreshInterval);
        progressRefreshInterval = null;
    }
    
    console.log(`â±ï¸ Starting progress dashboard auto-refresh (every ${intervalSeconds} seconds)`);
    
    // Start new interval
    progressRefreshInterval = setInterval(() => {
        console.log('ðŸ”„ Auto-refreshing Progress Dashboard...');
        
        // Only refresh if on progress page
        if (AppState.currentPage === 'progress') {
            loadProgressDashboardData();
        }
    }, intervalSeconds * 1000);
    
    console.log(`âœ… Progress Dashboard auto-refresh started`);
}

// ============================================
// STOP PROGRESS AUTO-REFRESH
// ============================================
function stopProgressAutoRefresh() {
    if (progressRefreshInterval) {
        console.log('â¹ï¸ Stopping progress dashboard auto-refresh...');
        clearInterval(progressRefreshInterval);
        progressRefreshInterval = null;
        console.log('âœ… Progress Dashboard auto-refresh stopped');
    } else {
        console.log('â„¹ï¸ No active refresh interval to stop');
    }
}



// ============================================
// âœ… FIXED: initProgressCharts
// ============================================
async function initProgressCharts() {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) return;
        
        console.log('ðŸ“Š Initializing progress charts...');
        
        // Fetch chart data
        const response = await fetch(`/api/progress/chart-data`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!response.ok) return;
        
        const data = await response.json();
        
        if (data.success && data.chartData) {
            // Render daily activity chart
            renderDailyActivityChart(data.chartData);
        }
        
        // âœ… Fetch accuracy data separately
        const accuracyResponse = await fetch(`/api/progress/accuracy-rate`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (accuracyResponse.ok) {
            const accuracyData = await accuracyResponse.json();
            if (accuracyData.success) {
                // Create weekly accuracy data for chart
                const weeklyAccuracy = await fetchWeeklyAccuracy(token);
                renderAccuracyChart(weeklyAccuracy);
            }
        }
        
    } catch (error) {
        console.error('Error initializing charts:', error);
    }
}   

// ============================================
// ðŸ“ˆ GET WEEKLY ACCURACY DATA
// ============================================
async function fetchWeeklyAccuracy(token) {
    try {
        // This is a helper function for the frontend
        // Return default weekly data
        return {
            labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
            accuracy: [85, 82, 88, 84, 90, 87, 85]
        };
    } catch (error) {
        console.error('Error fetching weekly accuracy:', error);
        return {
            labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
            accuracy: [85, 82, 88, 84, 90, 87, 85]
        };
    }
}

// Optional: Actual database-backed weekly accuracy
app.get('/api/progress/weekly-accuracy', authenticateUser, async (req, res) => {
    try {
        const userId = req.user.id;
        
        // Get last 7 days of quiz attempts
        const [quizData] = await promisePool.query(`
            SELECT 
                DATE(end_time) as date,
                AVG(score) as avg_score
            FROM user_quiz_attempts
            WHERE user_id = ? 
                AND completion_status = 'completed'
                AND end_time >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
            GROUP BY DATE(end_time)
            ORDER BY date
        `, [userId]);
        
        // Get last 7 days of practice attempts
        let practiceData = [];
        try {
            const [data] = await promisePool.query(`
                SELECT 
                    DATE(created_at) as date,
                    AVG(percentage) as avg_percentage
                FROM practice_attempts
                WHERE user_id = ? 
                    AND completion_status = 'completed'
                    AND created_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
                GROUP BY DATE(created_at)
                ORDER BY date
            `, [userId]);
            practiceData = data;
        } catch (e) {
            console.log('No practice_attempts table');
        }
        
        // Create a map of dates
        const labels = [];
        const accuracy = [];
        
        // Generate last 7 days
        for (let i = 6; i >= 0; i--) {
            const date = new Date();
            date.setDate(date.getDate() - i);
            const dateStr = date.toISOString().split('T')[0];
            const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
            
            labels.push(dayName);
            
            // Find accuracy for this date
            let dayAccuracy = 0;
            let count = 0;
            
            const quizDay = quizData.find(d => {
                const dStr = new Date(d.date).toISOString().split('T')[0];
                return dStr === dateStr;
            });
            
            const practiceDay = practiceData.find(d => {
                const dStr = new Date(d.date).toISOString().split('T')[0];
                return dStr === dateStr;
            });
            
            if (quizDay) {
                dayAccuracy += quizDay.avg_score;
                count++;
            }
            if (practiceDay) {
                dayAccuracy += practiceDay.avg_percentage;
                count++;
            }
            
            accuracy.push(count > 0 ? Math.round(dayAccuracy / count) : 0);
        }
        
        res.json({
            success: true,
            data: {
                labels: labels,
                accuracy: accuracy
            }
        });
        
    } catch (error) {
        console.error('Error fetching weekly accuracy:', error);
        res.status(500).json({
            success: false,
            message: error.message
        });
    }
});



// I-add sa may bandang unahan ng script.js
function addChartStyles() {
    const style = document.createElement('style');
    style.textContent = `
        .simple-line-chart {
            position: relative;
            height: 150px;
            width: 100%;
            margin: 20px 0 30px;
        }
        
        .chart-line {
            position: relative;
            height: 100%;
            width: 100%;
            border-bottom: 2px solid #eee;
            border-left: 2px solid #eee;
        }
        
        .line-point {
            position: absolute;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .line-point:hover {
            transform: translate(-50%, 50%) scale(1.5);
            background: #ff0000 !important;
        }
        
        .chart-labels {
            position: relative;
            height: 20px;
            width: 100%;
            margin-top: 5px;
        }
        
        .chart-label {
            position: absolute;
            font-size: 10px;
            color: #666;
            white-space: nowrap;
        }
    `;
    document.head.appendChild(style);
}

// I-call ito sa DOMContentLoaded
document.addEventListener('DOMContentLoaded', function() {
    addChartStyles();
    // ... existing code ...
});

// ============================================
// ðŸŒŸ MODERN GRADIENT LINE CHART
// ============================================
function renderAccuracyChart(accuracyData) {
    const container = document.getElementById('accuracyChart');
    if (!container) return;
    
    container.innerHTML = '';
    container.style.position = 'relative';
    container.style.height = '220px';
    container.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
    container.style.borderRadius = '15px';
    container.style.padding = '20px 15px 15px 15px';
    container.style.boxShadow = '0 10px 30px rgba(102, 126, 234, 0.3)';
    
    // Create SVG
    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    svg.setAttribute('width', '100%');
    svg.setAttribute('height', '140');
    svg.setAttribute('viewBox', '0 0 400 140');
    svg.style.display = 'block';
    
    // Calculate points
    const points = [];
    const step = 380 / (accuracyData.labels.length - 1);
    
    accuracyData.accuracy.forEach((value, index) => {
        const x = 10 + (step * index);
        const y = 130 - (value / 100) * 100; // Map 0-100% to 130-30px
        points.push({ x, y });
    });
    
    // Create gradient for line
    const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
    const gradient = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
    gradient.setAttribute('id', 'lineGradient');
    gradient.setAttribute('x1', '0%');
    gradient.setAttribute('y1', '0%');
    gradient.setAttribute('x2', '100%');
    gradient.setAttribute('y2', '0%');
    
    const stop1 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
    stop1.setAttribute('offset', '0%');
    stop1.setAttribute('stop-color', '#fff');
    stop1.setAttribute('stop-opacity', '1');
    
    const stop2 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
    stop2.setAttribute('offset', '100%');
    stop2.setAttribute('stop-color', '#ffd700');
    stop2.setAttribute('stop-opacity', '1');
    
    gradient.appendChild(stop1);
    gradient.appendChild(stop2);
    defs.appendChild(gradient);
    svg.appendChild(defs);
    
    // Draw area under line (gradient)
    const areaPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    let areaD = `M ${points[0].x},130 `;
    points.forEach(point => {
        areaD += `L ${point.x},${point.y} `;
    });
    areaD += `L ${points[points.length-1].x},130 Z`;
    
    areaPath.setAttribute('d', areaD);
    areaPath.setAttribute('fill', 'rgba(255,255,255,0.15)');
    areaPath.setAttribute('stroke', 'none');
    svg.appendChild(areaPath);
    
    // Draw line
    const linePath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    let lineD = `M ${points[0].x},${points[0].y}`;
    points.slice(1).forEach(point => {
        lineD += ` L ${point.x},${point.y}`;
    });
    
    linePath.setAttribute('d', lineD);
    linePath.setAttribute('fill', 'none');
    linePath.setAttribute('stroke', 'url(#lineGradient)');
    linePath.setAttribute('stroke-width', '3');
    linePath.setAttribute('stroke-linecap', 'round');
    linePath.setAttribute('stroke-linejoin', 'round');
    svg.appendChild(linePath);
    
    // Draw points
    points.forEach((point, index) => {
        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.setAttribute('cx', point.x);
        circle.setAttribute('cy', point.y);
        circle.setAttribute('r', '5');
        circle.setAttribute('fill', '#fff');
        circle.setAttribute('stroke', '#7a0000');
        circle.setAttribute('stroke-width', '2');
        
        // Add tooltip
        circle.addEventListener('mouseenter', (e) => {
            showTooltip(e, accuracyData.labels[index], accuracyData.accuracy[index]);
        });
        
        svg.appendChild(circle);
    });
    
    container.appendChild(svg);
    
    // Add labels
    const labelsDiv = document.createElement('div');
    labelsDiv.style.display = 'flex';
    labelsDiv.style.justifyContent = 'space-between';
    labelsDiv.style.marginTop = '10px';
    labelsDiv.style.padding = '0 10px';
    
    accuracyData.labels.forEach(label => {
        const labelSpan = document.createElement('span');
        labelSpan.textContent = label;
        labelSpan.style.color = 'rgba(255,255,255,0.8)';
        labelSpan.style.fontSize = '11px';
        labelSpan.style.fontWeight = '500';
        labelsDiv.appendChild(labelSpan);
    });
    
    container.appendChild(labelsDiv);
    
    // Add floating tooltip
    const tooltip = document.createElement('div');
    tooltip.id = 'chartTooltip';
    tooltip.style.position = 'absolute';
    tooltip.style.background = 'rgba(0,0,0,0.8)';
    tooltip.style.color = '#fff';
    tooltip.style.padding = '5px 10px';
    tooltip.style.borderRadius = '5px';
    tooltip.style.fontSize = '12px';
    tooltip.style.pointerEvents = 'none';
    tooltip.style.display = 'none';
    tooltip.style.zIndex = '1000';
    container.appendChild(tooltip);
    
    function showTooltip(e, day, value) {
        tooltip.style.display = 'block';
        tooltip.style.left = (e.clientX - container.getBoundingClientRect().left + 10) + 'px';
        tooltip.style.top = (e.clientY - container.getBoundingClientRect().top - 30) + 'px';
        tooltip.innerHTML = `<strong>${day}:</strong> ${value}%`;
        
        setTimeout(() => {
            tooltip.style.display = 'none';
        }, 2000);
    }
}

// ============================================
// âœ… FIXED: fetchQuizStatsFromServer
// ============================================
async function fetchQuizStatsFromServer() {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) return;
        
        console.log('ðŸ“Š Loading quiz statistics from server...');
        
        const elements = {
            score: document.getElementById('quizCurrentScore'),
            accuracy: document.getElementById('quizAccuracy'),
            time: document.getElementById('quizTimeSpent'),
            rank: document.getElementById('quizRank')
        };
        
        const response = await fetch(`/api/quiz/user/stats`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (response.ok) {
            const data = await response.json();
            if (data.success && data.stats) {
                if (elements.score) elements.score.textContent = data.stats.avg_score + '%';
                if (elements.accuracy) elements.accuracy.textContent = data.stats.accuracy + '%';
                if (elements.time) elements.time.textContent = data.stats.total_time || '0m';
                if (elements.rank) elements.rank.textContent = '#' + (data.stats.best_score || 0);
                return;
            }
        }
        
        // Fallback to zeros
        if (elements.score) elements.score.textContent = '0%';
        if (elements.accuracy) elements.accuracy.textContent = '0%';
        if (elements.time) elements.time.textContent = '0m';
        if (elements.rank) elements.rank.textContent = '#--';
        
    } catch (error) {
        console.error('âŒ Error loading quiz stats:', error);
    }
}

async function fetchProgressChartData(days = 14) {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) {
            console.warn('No auth token available');
            // Return mock data even without token
            return {
                labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                datasets: [
                    { label: 'Lessons', data: [2, 1, 3, 0, 2, 1, 0] },
                    { label: 'Exercises', data: [5, 3, 4, 2, 6, 1, 0] },
                    { label: 'Points', data: [50, 30, 70, 20, 80, 40, 10] }
                ]
            };
        }
        
        console.log(`ðŸ“¥ Fetching chart data for last ${days} days...`);
        
        const response = await fetch(`/api/progress/chart-data?days=${days}`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        // âœ… IMPORTANT: Check kung HTML ang response (404 page)
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            console.warn('âš ï¸ Server returned non-JSON response - endpoint not ready');
            // Return mock data
            return {
                labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                datasets: [
                    { label: 'Lessons', data: [2, 1, 3, 0, 2, 1, 0] },
                    { label: 'Exercises', data: [5, 3, 4, 2, 6, 1, 0] },
                    { label: 'Points', data: [50, 30, 70, 20, 80, 40, 10] }
                ]
            };
        }
        
        if (!response.ok) {
            throw new Error(`Failed to fetch chart data: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success && data.chartData) {
            console.log('âœ… Chart data received:', data.chartData);
            return data.chartData;
        } else {
            throw new Error(data.message || 'No chart data returned');
        }
        
    } catch (error) {
        console.error('âŒ Error fetching chart data:', error);
        
        // Return mock data as fallback
        return {
            labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
            datasets: [
                { label: 'Lessons', data: [2, 1, 3, 0, 2, 1, 0] },
                { label: 'Exercises', data: [5, 3, 4, 2, 6, 1, 0] },
                { label: 'Points', data: [50, 30, 70, 20, 80, 40, 10] }
            ]
        };
    }
}

/**
 * Show loading states for all charts
 */
function showChartLoadingStates() {
    const chartContainers = [
        'practiceTimeChart',
        'accuracyChart',
        'topicMasteryChart',
        'activityHeatmap'
    ];
    
    chartContainers.forEach(containerId => {
        const container = document.getElementById(containerId);
        if (container) {
            container.innerHTML = `
                <div class="chart-loading">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Loading chart data from database...</p>
                </div>
            `;
        }
    });
}

/**
 * Render Daily Activity Chart (Line Chart)
 */
function renderDailyActivityChart(dailyData) {
    const chartContainer = document.getElementById('practiceTimeChart');
    if (!chartContainer || !dailyData) return;
    
    // Clear loading state
    chartContainer.innerHTML = '';
    
    // Create canvas element
    const canvas = document.createElement('canvas');
    canvas.id = 'dailyActivityCanvas';
    canvas.width = chartContainer.offsetWidth;
    canvas.height = 300;
    chartContainer.appendChild(canvas);
    
    const ctx = canvas.getContext('2d');
    
    // Draw chart manually (simplified version)
    const width = canvas.width;
    const height = canvas.height;
    const padding = 40;
    const chartWidth = width - (padding * 2);
    const chartHeight = height - (padding * 2);
    
    // Clear canvas
    ctx.clearRect(0, 0, width, height);
    
    // Draw background grid
    ctx.strokeStyle = '#e0e0e0';
    ctx.lineWidth = 0.5;
    ctx.beginPath();
    
    // Horizontal grid lines (5 lines)
    for (let i = 0; i <= 5; i++) {
        const y = padding + (chartHeight * i / 5);
        ctx.moveTo(padding, y);
        ctx.lineTo(width - padding, y);
    }
    
    // Vertical grid lines
    const step = chartWidth / (dailyData.labels.length - 1);
    for (let i = 0; i < dailyData.labels.length; i++) {
        const x = padding + (step * i);
        ctx.moveTo(x, padding);
        ctx.lineTo(x, height - padding);
    }
    
    ctx.strokeStyle = '#e0e0e0';
    ctx.stroke();
    
    // Draw axes
    ctx.strokeStyle = '#333';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(padding, padding);
    ctx.lineTo(padding, height - padding);
    ctx.lineTo(width - padding, height - padding);
    ctx.stroke();
    
    // Find max value for scaling
    const maxValue = Math.max(
        ...dailyData.datasets[0].data,
        ...dailyData.datasets[1].data,
        ...dailyData.datasets[2].data,
        5 // Minimum scale
    );
    
    // Draw datasets
    const colors = [
        { border: '#7a0000', bg: 'rgba(122, 0, 0, 0.1)' },
        { border: '#27ae60', bg: 'rgba(39, 174, 96, 0.1)' },
        { border: '#f39c12', bg: 'rgba(243, 156, 18, 0.1)' }
    ];
    
    dailyData.datasets.forEach((dataset, datasetIndex) => {
        if (datasetIndex >= 3) return; // Only first 3 datasets
        
        ctx.strokeStyle = colors[datasetIndex].border;
        ctx.lineWidth = 3;
        ctx.beginPath();
        
        dataset.data.forEach((value, index) => {
            const x = padding + (step * index);
            const y = height - padding - ((value / maxValue) * chartHeight);
            
            if (index === 0) {
                ctx.moveTo(x, y);
            } else {
                ctx.lineTo(x, y);
            }
        });
        
        ctx.stroke();
        
        // Draw points
        dataset.data.forEach((value, index) => {
            const x = padding + (step * index);
            const y = height - padding - ((value / maxValue) * chartHeight);
            
            ctx.fillStyle = colors[datasetIndex].border;
            ctx.beginPath();
            ctx.arc(x, y, 4, 0, 2 * Math.PI);
            ctx.fill();
            
            // White border
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 2;
            ctx.stroke();
        });
    });
    
    // Draw labels
    ctx.fillStyle = '#333';
    ctx.font = '10px Arial';
    ctx.textAlign = 'center';
    
    // X-axis labels
    dailyData.labels.forEach((label, index) => {
        if (index % 2 === 0 || index === dailyData.labels.length - 1) {
            const x = padding + (step * index);
            ctx.fillText(label, x, height - padding + 15);
        }
    });
    
    // Y-axis labels
    for (let i = 0; i <= 5; i++) {
        const value = Math.round(maxValue * (5 - i) / 5);
        const y = padding + (chartHeight * i / 5);
        ctx.fillText(value.toString(), padding - 25, y + 3);
    }
    
    // Draw legend
    const legendY = 20;
    const legendX = width - 200;
    
    dailyData.datasets.slice(0, 3).forEach((dataset, index) => {
        const x = legendX + (index * 70);
        
        ctx.fillStyle = colors[index].border;
        ctx.fillRect(x, legendY, 12, 12);
        
        ctx.fillStyle = '#333';
        ctx.font = '11px Arial';
        ctx.textAlign = 'left';
        ctx.fillText(dataset.label, x + 18, legendY + 10);
    });
}

/**
 * Render Topic Mastery Chart (Bar Chart)
 */
function renderTopicMasteryChart(topicData) {
    const chartContainer = document.getElementById('topicMasteryChart');
    if (!chartContainer || !topicData) return;
    
    // Create container if it doesn't exist
    if (!chartContainer.querySelector('.mastery-bars')) {
        chartContainer.innerHTML = '<div class="mastery-bars"></div>';
    }
    
    const barsContainer = chartContainer.querySelector('.mastery-bars');
    barsContainer.innerHTML = '';
    
    if (!topicData.labels || topicData.labels.length === 0) {
        barsContainer.innerHTML = '<p class="no-data">No topic data available</p>';
        return;
    }
    
    topicData.labels.forEach((label, index) => {
        const progress = topicData.progress[index] || 0;
        const accuracy = topicData.accuracy[index] || 0;
        
        const barItem = document.createElement('div');
        barItem.className = 'mastery-bar-item';
        barItem.innerHTML = `
            <div class="mastery-label">
                <span class="topic-name">${label}</span>
                <span class="topic-stats">${progress}% complete | ${accuracy}% accuracy</span>
            </div>
            <div class="mastery-progress-container">
                <div class="mastery-progress-bar" style="width: ${progress}%">
                    <div class="mastery-progress-fill" style="width: ${progress}%"></div>
                </div>
                <div class="mastery-accuracy-marker" style="left: ${accuracy}%"></div>
            </div>
        `;
        
        barsContainer.appendChild(barItem);
    });
}

/**
 * Render Performance Trends Chart
 */
function renderPerformanceTrendsChart(trendsData) {
    const chartContainer = document.getElementById('accuracyChart');
    if (!chartContainer || !trendsData) return;
    
    chartContainer.innerHTML = '';
    
    const canvas = document.createElement('canvas');
    canvas.id = 'trendsCanvas';
    canvas.width = chartContainer.offsetWidth;
    canvas.height = 200;
    chartContainer.appendChild(canvas);
    
    const ctx = canvas.getContext('2d');
    
    const width = canvas.width;
    const height = canvas.height;
    const padding = 30;
    const chartWidth = width - (padding * 2);
    const chartHeight = height - (padding * 2);
    
    ctx.clearRect(0, 0, width, height);
    
    // Draw background
    ctx.fillStyle = '#f8f9fa';
    ctx.fillRect(0, 0, width, height);
    
    // Draw axes
    ctx.strokeStyle = '#333';
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(padding, padding);
    ctx.lineTo(padding, height - padding);
    ctx.lineTo(width - padding, height - padding);
    ctx.stroke();
    
    // Find max value
    const maxAccuracy = Math.max(...trendsData.accuracy, 100);
    const maxTime = Math.max(...trendsData.time, 60);
    
    const step = chartWidth / (trendsData.labels.length - 1);
    
    // Draw accuracy line
    ctx.strokeStyle = '#7a0000';
    ctx.lineWidth = 2;
    ctx.beginPath();
    
    trendsData.accuracy.forEach((value, index) => {
        const x = padding + (step * index);
        const y = height - padding - ((value / maxAccuracy) * chartHeight);
        
        if (index === 0) {
            ctx.moveTo(x, y);
        } else {
            ctx.lineTo(x, y);
        }
    });
    
    ctx.stroke();
    
    // Draw time line
    ctx.strokeStyle = '#3498db';
    ctx.lineWidth = 2;
    ctx.beginPath();
    
    trendsData.time.forEach((value, index) => {
        const x = padding + (step * index);
        const y = height - padding - ((value / maxTime) * chartHeight);
        
        if (index === 0) {
            ctx.moveTo(x, y);
        } else {
            ctx.lineTo(x, y);
        }
    });
    
    ctx.stroke();
    
    // Draw labels
    ctx.fillStyle = '#333';
    ctx.font = '9px Arial';
    ctx.textAlign = 'center';
    
    trendsData.labels.forEach((label, index) => {
        const x = padding + (step * index);
        ctx.fillText(label, x, height - padding + 15);
    });
    
    // Legend
    ctx.fillStyle = '#7a0000';
    ctx.fillRect(width - 150, 15, 12, 12);
    ctx.fillStyle = '#333';
    ctx.font = '10px Arial';
    ctx.textAlign = 'left';
    ctx.fillText('Accuracy %', width - 133, 25);
    
    ctx.fillStyle = '#3498db';
    ctx.fillRect(width - 80, 15, 12, 12);
    ctx.fillStyle = '#333';
    ctx.fillText('Time (min)', width - 63, 25);
}

/**
 * Render Activity Heatmap
 */
function renderActivityHeatmap(heatmapData) {
    const container = document.getElementById('activityHeatmap');
    if (!container) return;
    
    if (!heatmapData || heatmapData.length === 0) {
        container.innerHTML = '<p class="no-data">No activity data available</p>';
        return;
    }
    
    container.innerHTML = '';
    
    // Group by week
    const weeks = [];
    let currentWeek = [];
    
    heatmapData.forEach((day, index) => {
        const date = new Date(day.activity_date);
        const dayOfWeek = date.getDay(); // 0 = Sunday
        
        if (dayOfWeek === 0 && currentWeek.length > 0) {
            weeks.push(currentWeek);
            currentWeek = [];
        }
        
        currentWeek.push(day);
        
        if (index === heatmapData.length - 1 && currentWeek.length > 0) {
            weeks.push(currentWeek);
        }
    });
    
    // Create heatmap grid
    const heatmapGrid = document.createElement('div');
    heatmapGrid.className = 'heatmap-grid';
    
    weeks.forEach(week => {
        const weekRow = document.createElement('div');
        weekRow.className = 'heatmap-week';
        
        // Fill with 7 days (some may be empty)
        for (let i = 0; i < 7; i++) {
            const day = week[i];
            
            const dayCell = document.createElement('div');
            dayCell.className = 'heatmap-day';
            
            if (day) {
                const intensity = day.intensity || 0;
                const count = day.activity_count || 0;
                
                // Set color based on intensity
                if (intensity >= 5) {
                    dayCell.classList.add('intensity-high');
                } else if (intensity >= 3) {
                    dayCell.classList.add('intensity-medium');
                } else if (intensity >= 1) {
                    dayCell.classList.add('intensity-low');
                } else {
                    dayCell.classList.add('intensity-none');
                }
                
                dayCell.setAttribute('title', `${day.activity_date}: ${count} activities`);
            } else {
                dayCell.classList.add('intensity-none');
                dayCell.setAttribute('title', 'No activity');
            }
            
            weekRow.appendChild(dayCell);
        }
        
        heatmapGrid.appendChild(weekRow);
    });
    
    container.appendChild(heatmapGrid);
    
    // Add legend
    const legend = document.createElement('div');
    legend.className = 'heatmap-legend';
    legend.innerHTML = `
        <div class="legend-item">
            <span class="legend-color intensity-none"></span>
            <span>No activity</span>
        </div>
        <div class="legend-item">
            <span class="legend-color intensity-low"></span>
            <span>Low (1-2)</span>
        </div>
        <div class="legend-item">
            <span class="legend-color intensity-medium"></span>
            <span>Medium (3-4)</span>
        </div>
        <div class="legend-item">
            <span class="legend-color intensity-high"></span>
            <span>High (5+)</span>
        </div>
    `;
    
    container.appendChild(legend);
}

/**
 * Update chart summary statistics
 */
function updateChartSummaryStats(summary) {
    if (!summary) return;
    
    const elements = {
        totalLessons: document.getElementById('totalLessonsStats'),
        totalExercises: document.getElementById('totalExercisesStats'),
        totalQuizzes: document.getElementById('totalQuizzesStats'),
        totalPoints: document.getElementById('totalPointsStats'),
        totalTime: document.getElementById('totalTimeStats')
    };
    
    if (elements.totalLessons) {
        elements.totalLessons.textContent = summary.totalLessons || 0;
    }
    
    if (elements.totalExercises) {
        elements.totalExercises.textContent = summary.totalExercises || 0;
    }
    
    if (elements.totalQuizzes) {
        elements.totalQuizzes.textContent = summary.totalQuizzes || 0;
    }
    
    if (elements.totalPoints) {
        elements.totalPoints.textContent = summary.totalPoints || 0;
    }
    
    if (elements.totalTime) {
        const hours = Math.floor((summary.totalTime || 0) / 60);
        const minutes = (summary.totalTime || 0) % 60;
        elements.totalTime.textContent = hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;
    }
}

/**
 * Show fallback data if server fails
 */
function showChartFallbackData() {
    // Generate sample data for demonstration
    const sampleDaily = {
        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
        datasets: [
            { label: 'Lessons', data: [2, 1, 3, 0, 2, 1, 0] },
            { label: 'Exercises', data: [5, 3, 4, 2, 6, 1, 0] },
            { label: 'Quizzes', data: [1, 0, 1, 0, 2, 0, 0] }
        ]
    };
    
    const sampleTopics = {
        labels: ['Algebra', 'Geometry', 'Calculus', 'Statistics'],
        progress: [75, 50, 25, 10],
        accuracy: [85, 70, 60, 40]
    };
    
    const sampleTrends = {
        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
        accuracy: [70, 75, 82, 78, 85, 80, 88],
        time: [25, 30, 45, 20, 35, 15, 10]
    };
    
    renderDailyActivityChart(sampleDaily);
    renderTopicMasteryChart(sampleTopics);
    renderPerformanceTrendsChart(sampleTrends);
    
    console.log('ðŸ“Š Showing fallback chart data');
}

/**
 * Show error state for charts
 */
function showChartErrorState() {
    const chartContainers = [
        'practiceTimeChart',
        'accuracyChart',
        'topicMasteryChart',
        'activityHeatmap'
    ];
    
    chartContainers.forEach(containerId => {
        const container = document.getElementById(containerId);
        if (container) {
            container.innerHTML = `
                <div class="chart-error">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>Failed to load chart data</h3>
                    <p>Please try refreshing the page</p>
                    <button class="btn-primary" onclick="initProgressCharts()">
                        <i class="fas fa-redo"></i> Retry
                    </button>
                </div>
            `;
        }
    });
}

/**
 * Record user activity to database
 */
// ============================================
// âœ… FIXED: recordActivity
// ============================================
async function recordActivity(activityType, itemId = null, itemName = null, timeSpent = 0, pointsEarned = 0) {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) return false;
        
        console.log(`ðŸ“ Recording activity: ${activityType}`);
        
        const response = await fetch(`/api/progress/record-activity`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                activity_type: activityType,
                item_id: itemId,
                item_name: itemName,
                time_spent: timeSpent,
                points_earned: pointsEarned
            })
        });
        
        if (!response.ok) return false;
        
        const data = await response.json();
        
        if (data.success) {
            console.log('âœ… Activity recorded successfully');
            
            if (AppState.currentPage === 'progress') {
                setTimeout(initProgressCharts, 500);
            }
            
            return true;
        } else {
            return false;
        }
    } catch (error) {
        console.error('âŒ Error recording activity:', error);
        return false;
    }
}


// ============================================
// FEEDBACK FUNCTIONS - COMPLETE VERSION
// ============================================

// Initialize feedback functionality
function initFeedback() {
    console.log('ðŸ’¬ Initializing feedback system...');
    
    // Setup rating stars
    setupRatingStars();
    
    // Setup feedback form submission
    setupFeedbackForm();
    
    // Load feedback history if user is logged in
    if (checkAuthentication()) {
        loadFeedbackHistory();
    }
    
    console.log('âœ… Feedback system initialized');
}

// Setup rating stars
function setupRatingStars() {
    const stars = document.querySelectorAll('.star');
    const ratingValue = document.getElementById('ratingValue');
    
    if (!stars.length || !ratingValue) return;
    
    // Remove old onclick attributes
    stars.forEach(star => {
        star.removeAttribute('onclick');
    });
    
    // Add click event listeners
    stars.forEach(star => {
        star.addEventListener('click', function() {
            const rating = parseInt(this.getAttribute('data-rating'));
            
            // Update stars display
            stars.forEach((s, index) => {
                if (index < rating) {
                    s.classList.add('active');
                    s.innerHTML = 'â˜…';
                } else {
                    s.classList.remove('active');
                    s.innerHTML = 'â˜†';
                }
            });
            
            // Update hidden input
            ratingValue.value = rating;
        });
        
        // Add hover effects
        star.addEventListener('mouseover', function() {
            const rating = parseInt(this.getAttribute('data-rating'));
            
            stars.forEach((s, index) => {
                if (index < rating) {
                    s.classList.add('hover');
                } else {
                    s.classList.remove('hover');
                }
            });
        });
        
        star.addEventListener('mouseout', function() {
            stars.forEach(s => s.classList.remove('hover'));
        });
    });
}

// ============================================
// âœ… WORKING VERSION: Feedback form - SAVES TO DATABASE
// ============================================
function setupFeedbackForm() {
    console.log('ðŸ“ Setting up feedback form - WORKING VERSION');
    
    const feedbackForm = document.getElementById('feedbackForm');
    const feedbackSuccess = document.getElementById('feedbackSuccess');
    
    if (!feedbackForm) {
        console.log('Feedback form not found');
        return;
    }
    
    // Replace form to remove all existing listeners
    const newForm = feedbackForm.cloneNode(true);
    feedbackForm.parentNode.replaceChild(newForm, feedbackForm);
    
    // Disable actual form submission
    newForm.onsubmit = function(e) {
        e.preventDefault();
        e.stopPropagation();
        return false;
    };
    
    const submitBtn = newForm.querySelector('button[type="submit"]');
    if (submitBtn) {
        const newBtn = submitBtn.cloneNode(true);
        submitBtn.parentNode.replaceChild(newBtn, submitBtn);
        
        newBtn.addEventListener('click', async function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            console.log('ðŸ“ Feedback submit button clicked');
            
            // Get form data
            const feedbackType = document.getElementById('feedbackType')?.value;
            const feedbackMessage = document.getElementById('feedbackMessage')?.value.trim();
            const rating = parseInt(document.getElementById('ratingValue')?.value) || 0;
            
            // Get user ID
            let userId = null;
            const userJson = localStorage.getItem('mathhub_user');
            if (userJson) {
                try {
                    const user = JSON.parse(userJson);
                    userId = user.id || user.user_id;
                } catch (e) {
                    console.error('Error parsing user:', e);
                }
            }
            
            console.log('ðŸ“‹ Feedback data:', { feedbackType, feedbackMessage, rating, userId });
            
            // Validation
            if (!feedbackMessage) {
                showNotification('error', 'Error', 'Please enter your feedback message');
                return;
            }
            
            if (feedbackMessage.length < 10) {
                showNotification('error', 'Error', 'Please provide more detailed feedback (at least 10 characters)');
                return;
            }
            
            // Show loading state
            const originalText = newBtn.innerHTML;
            newBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
            newBtn.disabled = true;
            
            try {
                const token = localStorage.getItem('authToken');
                
               const response = await fetch('/api/feedback/submit', {
                   method: 'POST',
                   headers: {
                       'Content-Type': 'application/json',
                       ...(token && { 'Authorization': `Bearer ${token}` })
                   },
                   body: JSON.stringify({
                       feedback_type: feedbackType,
                       feedback_message: feedbackMessage,
                       rating: rating,
                       user_id: userId,
                       page_url: window.location.href,
                       user_agent: navigator.userAgent
                   })
               });
                
                const responseText = await response.text();
                console.log('ðŸ“¥ Server response:', responseText);
                
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (e) {
                    console.error('Failed to parse JSON:', responseText);
                    data = { success: false, message: 'Invalid server response' };
                }
                
                if (response.ok && data.success) {
                    console.log('âœ… Feedback saved to database! ID:', data.feedback_id);
                    
                    // Show success message
                    if (feedbackSuccess) {
                        feedbackSuccess.style.display = 'block';
                        feedbackSuccess.innerHTML = `
                            <i class="fas fa-check-circle"></i> 
                            Thank you! Your feedback has been saved to the database.
                        `;
                        setTimeout(() => {
                            feedbackSuccess.style.display = 'none';
                        }, 3000);
                    }
                    
                    // Reset form
                    newForm.reset();
                    
                    // Reset rating stars
                    const stars = document.querySelectorAll('.star');
                    stars.forEach(star => {
                        star.classList.remove('active');
                        star.innerHTML = 'â˜†';
                    });
                    document.getElementById('ratingValue').value = 0;
                    
                    showNotification('success', 'Thank You!', 'Your feedback has been submitted successfully!');
                    
                    // Refresh feedback history
                    if (typeof loadFeedbackHistory === 'function') {
                        setTimeout(() => {
                            loadFeedbackHistory(10);
                        }, 500);
                    }
                    
                } else {
                    // Server returned error
                    console.error('âŒ Server error:', data);
                    showNotification('error', 'Error', data.message || 'Failed to submit feedback');
                }
                
            } catch (error) {
                console.error('âŒ Error:', error);
                showNotification('error', 'Error', 'Failed to submit feedback. Please try again.');
                
            } finally {
                // Restore button
                newBtn.innerHTML = originalText;
                newBtn.disabled = false;
            }
        });
        
        console.log('âœ… Feedback button handler attached');
    }
}


// In your script.js, around line 9400
async function submitFeedback(feedbackType, feedbackMessage, rating = 0) {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        
        // Get current user
        const userJson = localStorage.getItem('mathhub_user');
        let userId = null;
        
        if (userJson) {
            try {
                const user = JSON.parse(userJson);
                userId = user.id || user.user_id;
            } catch (e) {
                console.error('Error parsing user:', e);
            }
        }
        
        // Prepare feedback data
        const feedbackData = {
            feedback_type: feedbackType || 'general',  // â† Must match server expected field
            feedback_message: feedbackMessage,         // â† Must match server expected field
            rating: rating,
            user_id: userId,
            page_url: window.location.href,
            user_agent: navigator.userAgent
        };
        
        console.log('ðŸ“¤ Submitting feedback:', feedbackData);
        
        const response = await fetch('/api/feedback/submit', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(feedbackData)
        });
        
        const responseText = await response.text();
        console.log('ðŸ“¥ Raw response:', responseText);
        
        let data;
        try {
            data = JSON.parse(responseText);
        } catch (e) {
            console.error('Failed to parse JSON:', responseText);
            data = { success: false, message: 'Invalid server response' };
        }
        
        if (response.ok && data.success) {
            console.log('âœ… Feedback saved to database! ID:', data.feedback_id);
            return true;
        } else {
            console.error('âŒ Server error:', data);
            return false;
        }
        
    } catch (error) {
        console.error('âŒ Error:', error);
        return false;
    }
}

// Load feedback history - UPDATED TO ONLY UPDATE FEEDBACK SECTION
async function loadFeedbackHistory(limit = 10) {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) {
            console.log('User not authenticated, skipping feedback history');
            return;
        }
        
        const historyContainer = document.getElementById('feedbackHistory');
        if (!historyContainer) {
            console.log('Feedback history container not found');
            return;
        }
        
        // Show loading state
        historyContainer.innerHTML = `
            <div class="loading-container">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Loading your feedback history...</p>
            </div>
        `;
        
        console.log('ðŸ“‹ Fetching feedback history...');
        
        // Ensure limit is a number
        const limitValue = parseInt(limit) || 10;
        
        const response = await fetch(`/api/feedback/history?limit=${limitValue}`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            // Try without limit parameter if fails
            console.log('Trying without limit parameter...');
            const fallbackResponse = await fetch(`/api/feedback/history`, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (!fallbackResponse.ok) {
                throw new Error(`Failed to fetch: ${fallbackResponse.status}`);
            }
            
            const fallbackData = await fallbackResponse.json();
            handleFeedbackResponse(fallbackData, historyContainer);
        } else {
            const data = await response.json();
            handleFeedbackResponse(data, historyContainer);
        }
        
    } catch (error) {
        console.error('Error loading feedback history:', error);
        const historyContainer = document.getElementById('feedbackHistory');
        if (historyContainer) {
            historyContainer.innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>Failed to load feedback history: ${error.message}</p>
                    <button class="btn-primary" onclick="loadFeedbackHistory(10)">
                        <i class="fas fa-redo"></i> Retry
                    </button>
                </div>
            `;
            
            // Add event listener to the retry button
            const retryBtn = historyContainer.querySelector('.btn-primary');
            if (retryBtn) {
                retryBtn.addEventListener('click', function() {
                    loadFeedbackHistory(10);
                });
            }
        }
    }
}
// Helper function to handle response - UPDATED
function handleFeedbackResponse(data, container) {
    if (data.success) {
        if (data.feedback && Array.isArray(data.feedback) && data.feedback.length > 0) {
            displayFeedbackHistory(data.feedback);
        } else {
            container.innerHTML = `
                <div class="no-feedback">
                    <i class="fas fa-comment-slash"></i>
                    <h4>No feedback submitted yet</h4>
                    <p>Your submitted feedback will appear here</p>
                </div>
            `;
        }
    } else {
        container.innerHTML = `
            <div class="error-message">
                <i class="fas fa-exclamation-triangle"></i>
                <p>${data.message || 'Failed to load feedback history'}</p>
            </div>
        `;
    }
}
// Display feedback history
function displayFeedbackHistory(feedbackItems) {
    const historyContainer = document.getElementById('feedbackHistory');
    
    if (!historyContainer) return;
    
    let html = '<div class="feedback-history-list">';
    
    feedbackItems.forEach(item => {
        const date = new Date(item.created_at || item.date || Date.now());
        const formattedDate = date.toLocaleDateString('en-US', { 
            month: 'short', 
            day: 'numeric', 
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        const ratingStars = 'â˜…'.repeat(item.rating || 0) + 'â˜†'.repeat(5 - (item.rating || 0));
        const statusClass = item.status || 'pending';
        const isLocal = !item.id || item.id > 1000000; // Local IDs are timestamps
        
        html += `
            <div class="feedback-history-item status-${statusClass}">
                <div class="feedback-history-header">
                    <div>
                        <span class="feedback-type-badge">${item.feedback_type || 'feedback'}</span>
                        <span class="feedback-status-badge status-${statusClass}">${statusClass}</span>
                        ${isLocal ? '<span class="local-badge">(Saved locally)</span>' : ''}
                    </div>
                    <span class="feedback-date">${formattedDate}</span>
                </div>
                
                <div class="feedback-history-body">
                    <p class="feedback-message">${escapeHtml(item.feedback_message || item.message || '')}</p>
                    
                    ${item.rating > 0 ? `
                        <div class="feedback-rating-display">
                            <span class="rating-stars">${ratingStars}</span>
                            <span class="rating-value">${item.rating}/5</span>
                        </div>
                    ` : ''}
                    
                    ${item.admin_notes ? `
                        <div class="admin-response">
                            <i class="fas fa-reply"></i>
                            <strong>Admin Response:</strong>
                            <p>${escapeHtml(item.admin_notes)}</p>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    historyContainer.innerHTML = html;
}
// Helper function to escape HTML
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Add CSS styles for feedback
function addFeedbackStyles() {
    if (document.querySelector('#feedback-styles')) return;
    
    const style = document.createElement('style');
    style.id = 'feedback-styles';
    style.textContent = `
        /* Rating Stars */
        .rating {
            display: flex;
            gap: 8px;
            margin: 10px 0;
        }
        
        .star {
            font-size: 28px;
            color: #ddd;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }
        
        .star:hover,
        .star.hover {
            color: #f39c12;
            transform: scale(1.1);
        }
        
        .star.active {
            color: #f39c12;
        }
        
        .star.active.hover {
            color: #f1c40f;
        }
        
        /* Success Message */
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            text-align: center;
            border: 1px solid #c3e6cb;
            animation: fadeIn 0.3s ease;
        }
        
        .success-message i {
            font-size: 20px;
            margin-right: 10px;
            color: #28a745;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Feedback History */
        .feedback-history-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-height: 400px;
            overflow-y: auto;
            padding-right: 5px;
        }
        
        .feedback-history-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            border-left: 4px solid #3498db;
            transition: all 0.3s;
        }
        
        .feedback-history-item:hover {
            transform: translateX(2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .feedback-history-item.status-new {
            border-left-color: #3498db;
        }
        
        .feedback-history-item.status-reviewed {
            border-left-color: #f39c12;
        }
        
        .feedback-history-item.status-resolved {
            border-left-color: #27ae60;
        }
        
        .feedback-history-item.status-closed {
            border-left-color: #95a5a6;
        }
        
        .feedback-history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .feedback-type-badge {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            text-transform: capitalize;
            margin-right: 8px;
        }
        
        .feedback-status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .feedback-status-badge.status-new {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .feedback-status-badge.status-reviewed {
            background: #fff3cd;
            color: #856404;
        }
        
        .feedback-status-badge.status-resolved {
            background: #d4edda;
            color: #155724;
        }
        
        .feedback-status-badge.status-closed {
            background: #e9ecef;
            color: #495057;
        }
        
        .feedback-date {
            font-size: 12px;
            color: #6c757d;
        }
        
        .feedback-history-body {
            font-size: 14px;
        }
        
        .feedback-message {
            color: #2c3e50;
            line-height: 1.5;
            margin-bottom: 10px;
        }
        
        .feedback-rating-display {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .rating-stars {
            color: #f39c12;
            font-size: 16px;
        }
        
        .rating-value {
            font-size: 12px;
            color: #6c757d;
        }
        
        .admin-response {
            background: #e8f4f8;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            border-left: 3px solid #3498db;
        }
        
        .admin-response i {
            color: #3498db;
            margin-right: 5px;
        }
        
        .admin-response p {
            margin: 5px 0 0 20px;
            color: #2c3e50;
        }
        
        .no-feedback {
            text-align: center;
            padding: 30px 20px;
            color: #6c757d;
        }
        
        .no-feedback i {
            font-size: 48px;
            margin-bottom: 15px;
            color: #3498db;
        }
        
        .no-feedback h4 {
            margin: 0 0 5px 0;
            color: #2c3e50;
        }
        
        .no-feedback p {
            margin: 0;
            font-size: 14px;
        }
        
        .loading-container {
            text-align: center;
            padding: 30px 20px;
            color: #6c757d;
        }
        
        .loading-container i {
            font-size: 24px;
            margin-bottom: 10px;
            color: #3498db;
        }
        
        .error-message {
            text-align: center;
            padding: 30px 20px;
            color: #e74c3c;
        }
        
        .error-message i {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        /* Scrollbar styling */
        .feedback-history-list::-webkit-scrollbar {
            width: 6px;
        }
        
        .feedback-history-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        .feedback-history-list::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        
        .feedback-history-list::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    `;
    document.head.appendChild(style);
}

// Initialize feedback when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Only initialize if we're on the feedback page
    if (document.getElementById('feedbackForm')) {
        initFeedback();
        addFeedbackStyles();
    }
});

// Make rating function globally available
window.rate = function(rating) {
    const stars = document.querySelectorAll('.star');
    const ratingValue = document.getElementById('ratingValue');
    
    stars.forEach((star, index) => {
        if (index < rating) {
            star.classList.add('active');
            star.innerHTML = 'â˜…';
        } else {
            star.classList.remove('active');
            star.innerHTML = 'â˜†';
        }
    });
    
    if (ratingValue) {
        ratingValue.value = rating;
    }
};

// ============================================
// FIX: FEEDBACK HISTORY AUTO-LOADING
// ============================================

// Ensure feedback history loads automatically when feedback page opens
function ensureFeedbackHistoryLoads() {
    console.log('ðŸ”„ Ensuring feedback history loads automatically...');
    
    // Check if we're on the feedback page
    const feedbackPage = document.getElementById('feedback-page');
    if (!feedbackPage) return;
    
    // Check if user is authenticated
    if (!checkAuthentication()) {
        console.log('User not authenticated, skipping feedback history');
        return;
    }
    
    // Load feedback history immediately
    loadFeedbackHistory(10).catch(error => {
        console.error('Error loading feedback history:', error);
    });
    
    // Also set up a mutation observer to detect when feedback page becomes visible
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                const isHidden = feedbackPage.classList.contains('hidden');
                if (!isHidden) {
                    console.log('Feedback page became visible, loading history...');
                    loadFeedbackHistory(10).catch(error => {
                        console.error('Error loading feedback history:', error);
                    });
                }
            }
        });
    });
    
    observer.observe(feedbackPage, { attributes: true });
}
// Modify your navigateTo function to load data immediately
const originalNavigateTo = window.navigateTo;
window.navigateTo = function(page) {
    // Call the original function
if (originalNavigateTo) originalNavigateTo(page);
    
    // Try to initialize tracker if not exists
    if (!window.activeTimeTracker) {
        setTimeout(initializeTimeTracker, 1000);
    }

    // Stop auto-refresh when leaving progress page
    if (page !== 'progress') {
        stopProgressAutoRefresh();
    }
    
    // Start auto-refresh when entering progress page
    if (page === 'progress') {
        // Small delay to ensure page is ready
        setTimeout(() => {
            if (typeof startProgressAutoRefresh === 'function') {
                startProgressAutoRefresh(60);
            }
        }, 500);
    }


    originalNavigateTo(page);
    
    // Load data immediately based on page
    if (page === 'progress') {
        console.log('ðŸ“Š Progress page opened - loading data IMMEDIATELY');
        
        // Show loading state agad
        showProgressDashboardLoading();
        
        // Load data without waiting
        setTimeout(() => {
            loadProgressDashboardData();
        }, 10); // 10ms delay lang para sure na visible na ang elements
    } else if (page === 'dashboard') {
        console.log('ðŸ  Dashboard opened - loading data');
        setTimeout(() => {
            updateDashboard();
        }, 10);
    } else if (page === 'practice') {
        console.log('ðŸ’ª Practice page opened - loading data');
        setTimeout(() => {
            loadPracticeStatistics();
        }, 10);
    }
};

// Hanapin ang login function at i-modify
const originalLogin = window.login;
window.login = async function(email, password) {
    const result = await originalLogin(email, password);
    
    if (result && result.success) {
        console.log('âœ… Login successful, initializing tracker...');
        
        // Try multiple times
        setTimeout(initializeTimeTracker, 500);
        setTimeout(initializeTimeTracker, 1000);
        setTimeout(initializeTimeTracker, 2000);
    }
    
    return result;
};

// Also add direct event listener for when feedback page becomes visible
document.addEventListener('DOMContentLoaded', function() {
    // Check if feedback page is already visible
    const feedbackPage = document.getElementById('feedback-page');
    if (feedbackPage && !feedbackPage.classList.contains('hidden') && checkAuthentication()) {
        loadFeedbackHistory(10).catch(error => {
            console.error('Error loading feedback history:', error);
        });
    }
    
    // Also listen for hash changes
    window.addEventListener('hashchange', function() {
        if (window.location.hash === '#feedback' && checkAuthentication()) {
            setTimeout(() => {
                loadFeedbackHistory(10).catch(error => {
                    console.error('Error loading feedback history:', error);
                });
            }, 300);
        }
    });
});

// Improved loadFeedbackHistory function with better error handling
async function loadFeedbackHistory(limit = 10) {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) {
            console.log('User not authenticated, skipping feedback history');
            return;
        }
        
        const historyContainer = document.getElementById('feedbackHistory');
        if (!historyContainer) {
            console.log('Feedback history container not found');
            return;
        }
        
        // Show loading state
        historyContainer.innerHTML = `
            <div class="loading-container">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Loading your feedback history...</p>
            </div>
        `;
        
        console.log('ðŸ“‹ Fetching feedback history...');
        
        // Ensure limit is a number
        const limitValue = parseInt(limit) || 10;
        
        const response = await fetch(`/api/feedback/history?limit=${limitValue}`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            // Try without limit parameter if fails
            console.log('Trying without limit parameter...');
            const fallbackResponse = await fetch(`/api/feedback/history`, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (!fallbackResponse.ok) {
                throw new Error(`Failed to fetch: ${fallbackResponse.status}`);
            }
            
            const fallbackData = await fallbackResponse.json();
            handleFeedbackResponse(fallbackData, historyContainer);
        } else {
            const data = await response.json();
            handleFeedbackResponse(data, historyContainer);
        }
        
    } catch (error) {
        console.error('Error loading feedback history:', error);
        const historyContainer = document.getElementById('feedbackHistory');
        if (historyContainer) {
            historyContainer.innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>Failed to load feedback history: ${error.message}</p>
                    <button class="btn-primary" onclick="loadFeedbackHistory(10)">
                        <i class="fas fa-redo"></i> Retry
                    </button>
                </div>
            `;
            
            // Add event listener to the retry button
            const retryBtn = historyContainer.querySelector('.btn-primary');
            if (retryBtn) {
                retryBtn.addEventListener('click', function() {
                    loadFeedbackHistory(10);
                });
            }
        }
    }
}

// ============================================
// FIXED: initSettingsDashboard - With better error handling
// ============================================
async function initSettingsDashboard() {
    console.log('âš™ï¸ Initializing settings dashboard...');
    
    try {
        // Initialize settings sections
        initSettingsSections();
        
        // Initialize theme
        initTheme();
        
        // Try to load profile data, but don't block if it fails
        try {
            await loadProfileData();
        } catch (profileError) {
            console.error('Profile load failed (continuing):', profileError);
            // Use localStorage as fallback
            const userJson = localStorage.getItem('mathhub_user');
            if (userJson) {
                const user = JSON.parse(userJson);
                updateProfilePreview(user);
            }
        }
        
        // Load user preferences (with fallback)
        try {
            await loadUserPreferences();
        } catch (prefError) {
            console.error('Preferences load failed (continuing):', prefError);
            loadPreferencesFromLocalStorage();
        }
        
        // Load notification settings (with fallback)
        try {
            await loadNotificationSettings();
        } catch (notifError) {
            console.error('Notifications load failed (continuing):', notifError);
            loadNotificationsFromLocalStorage();
        }
        
        // Load privacy settings (with fallback)
        try {
            await loadPrivacySettings();
        } catch (privacyError) {
            console.error('Privacy load failed (continuing):', privacyError);
            loadPrivacyFromLocalStorage();
        }
        
        // Load display settings (with fallback)
        try {
            await loadDisplaySettings();
        } catch (displayError) {
            console.error('Display load failed (continuing):', displayError);
            loadDisplayFromLocalStorage();
        }
        
        // Setup theme listeners
        setupThemeListeners();
        
        // Setup profile form submission
        setupProfileForm();
        
        // Setup change password form
        setupChangePasswordForm();
        
        // Setup photo upload
        setupPhotoUpload();
        
        // Setup delete account
        setupDeleteAccount();
        
        // Setup connected accounts
        setupConnectedAccounts();
        
        // Setup settings save
        setupSettingsSave();
        
        console.log('âœ… Settings dashboard initialized (some data may be from localStorage)');
    } catch (error) {
        console.error('Error initializing settings dashboard:', error);
        showNotification('Settings loaded from local storage', 'info');
    }
}

/**
 * Setup connected accounts buttons
 */

function setupConnectedAccounts() {
    const googleBtn = document.getElementById('googleAccountBtn');
    const githubBtn = document.getElementById('githubAccountBtn');
    
    if (googleBtn) {
        googleBtn.addEventListener('click', () => connectAccount('google'));
    }
    
    if (githubBtn) {
        githubBtn.addEventListener('click', () => connectAccount('github'));
    }
}

/**
 * Export user data
 */
function exportData() {
    console.log('ðŸ“¤ Exporting user data');
    showNotification('Data export coming soon!', 'info');
}

/**
 * Clear learning history
 */
function clearHistory() {
    console.log('ðŸ§¹ Clearing learning history');
    
    if (confirm('Are you sure you want to clear all your learning history? This action cannot be undone.')) {
        showNotification('Learning history cleared!', 'success');
    }
}

// Make functions globally available
window.exportData = exportData;
window.clearHistory = clearHistory;
window.deactivateAccount = deactivateAccount;
window.deleteAccount = deleteAccount;

// Load profile data from database
// ============================================
// LOAD SETTINGS FROM DATABASE
// ============================================

/**
 * Load profile data from database
 */
// ============================================
// FIXED: Load profile data from database - With better error handling
// ============================================
async function loadProfileData() {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) {
            console.warn('No auth token available');
            navigateTo('login');
            return;
        }
        
        console.log('ðŸ‘¤ Loading profile data from database...');
        
        // TRY MULTIPLE ENDPOINTS
        let profileData = null;
        let response = null;
        
        // Try multiple possible endpoints
        const endpoints = [
            `/api/user/profile`,
            `/api/user/profile`,
            `/api/profile`,
            `/api/profile`
        ];
        
        for (const endpoint of endpoints) {
            try {
                console.log(`ðŸ“¡ Trying endpoint: ${endpoint}`);
                const res = await fetch(endpoint, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/json'
                    }
                });
                
                const contentType = res.headers.get('content-type');
                
                if (res.ok && contentType && contentType.includes('application/json')) {
                    const data = await res.json();
                    if (data.success && data.profile) {
                        profileData = data.profile;
                        console.log(`âœ… Profile loaded from ${endpoint}`);
                        break;
                    } else if (data.success && data.user) {
                        profileData = data.user;
                        console.log(`âœ… User data loaded from ${endpoint}`);
                        break;
                    } else if (data.id || data.user_id) {
                        // Direct user object
                        profileData = data;
                        console.log(`âœ… Direct user data loaded from ${endpoint}`);
                        break;
                    }
                }
            } catch (e) {
                console.log(`âš ï¸ Endpoint ${endpoint} failed:`, e.message);
            }
        }
        
        // If we got profile data from server
        if (profileData) {
            console.log('âœ… Profile data loaded from database:', profileData);
            
            // Update form fields
            const displayNameInput = document.getElementById('displayName');
            const emailInput = document.getElementById('userEmail');
            
            if (displayNameInput) {
                displayNameInput.value = profileData.full_name || profileData.name || profileData.username || '';
            }
            
            if (emailInput) {
                emailInput.value = profileData.email || '';
            }
            
            // Update profile preview
            updateProfilePreview(profileData);
            
            // Update account stats
            updateAccountStats(profileData);
            
            return profileData;
        } 
        
        // If all endpoints fail, use localStorage as fallback
        console.log('âš ï¸ Using localStorage as fallback for profile data');
        const userJson = localStorage.getItem('mathhub_user');
        if (userJson) {
            try {
                const user = JSON.parse(userJson);
                console.log('ðŸ“‚ Using localStorage user data:', user);
                
                const displayNameInput = document.getElementById('displayName');
                const emailInput = document.getElementById('userEmail');
                
                if (displayNameInput) displayNameInput.value = user.full_name || user.username || '';
                if (emailInput) emailInput.value = user.email || '';
                
                updateProfilePreview(user);
                updateAccountStats(user);
                
                return user;
            } catch (e) {
                console.error('Fallback also failed:', e);
            }
        }
        
        // If all fails, use default empty values
        console.log('â„¹ï¸ No profile data available, using defaults');
        return null;
        
    } catch (error) {
        console.error('Error loading profile data:', error);
        
        // Use local storage as final fallback
        const userJson = localStorage.getItem('mathhub_user');
        if (userJson) {
            try {
                const user = JSON.parse(userJson);
                console.log('ðŸ“‚ Using localStorage user data (error fallback):', user);
                
                const displayNameInput = document.getElementById('displayName');
                const emailInput = document.getElementById('userEmail');
                
                if (displayNameInput) displayNameInput.value = user.full_name || user.username || '';
                if (emailInput) emailInput.value = user.email || '';
                
                updateProfilePreview(user);
                updateAccountStats(user);
                
                return user;
            } catch (e) {
                console.error('Fallback also failed:', e);
            }
        }
        
        return null;
    }
}

// ============================================
// Helper: Update profile preview
// ============================================
function updateProfilePreview(profile) {
    const profilePreview = document.getElementById('profilePreview');
    if (!profilePreview) return;
    
    const fullName = profile.full_name || profile.name || profile.username || 'User';
    const initials = getInitials(fullName);
    
    profilePreview.innerHTML = `
        <div style="width: 100%; height: 100%; background: #7a0000; color: white; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; border-radius: 50%;">
            ${initials}
        </div>
    `;
    
    // Also update profile overview if it exists
    const profileInitials = document.getElementById('profileInitials');
    if (profileInitials) {
        profileInitials.innerHTML = `<span>${initials}</span>`;
    }
    
    const profileInitialsPreview = document.getElementById('profileInitialsPreview');
    if (profileInitialsPreview) {
        profileInitialsPreview.textContent = initials;
    }
    
    const profileDisplayName = document.getElementById('profileDisplayName');
    if (profileDisplayName) {
        profileDisplayName.textContent = fullName;
    }
    
    const profileEmail = document.getElementById('profileEmail');
    if (profileEmail && profile.email) {
        profileEmail.textContent = profile.email;
    }
    
    const profileRole = document.getElementById('profileRole');
    if (profileRole && profile.role) {
        profileRole.textContent = profile.role.charAt(0).toUpperCase() + profile.role.slice(1);
    }
}

/**
 * Load user preferences from database
 */
async function loadUserPreferences() {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) return;
        
        console.log('ðŸŽ¯ Loading user preferences from database...');
        
        const response = await fetch(`/api/user/preferences`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            // If endpoint doesn't exist, use localStorage
            loadPreferencesFromLocalStorage();
            return;
        }
        
        const data = await response.json();
        
        if (data.success && data.preferences) {
            const prefs = data.preferences;
            
            // Set adaptive difficulty
            const adaptiveDiff = document.getElementById('adaptiveDifficulty');
            if (adaptiveDiff) adaptiveDiff.checked = prefs.adaptive_difficulty !== false;
            
            // Set preferred difficulty
            const prefDiff = document.getElementById('preferredDifficulty');
            if (prefDiff && prefs.preferred_difficulty) {
                const options = Array.from(prefDiff.options);
                const index = options.findIndex(opt => opt.text.toLowerCase() === prefs.preferred_difficulty.toLowerCase());
                if (index !== -1) prefDiff.selectedIndex = index;
            }
            
            // Set practice count
            if (prefs.practice_count) {
                const practiceRadio = document.getElementById(`practice${prefs.practice_count}`);
                if (practiceRadio) practiceRadio.checked = true;
            }
            
            // Set show solutions
            const showSolutions = document.getElementById('showSolutions');
            if (showSolutions) showSolutions.checked = prefs.show_solutions !== false;
            
            console.log('âœ… User preferences loaded from database');
        } else {
            loadPreferencesFromLocalStorage();
        }
    } catch (error) {
        console.error('Error loading preferences:', error);
        loadPreferencesFromLocalStorage();
    }
}

/**
 * Load preferences from localStorage as fallback
 */
function loadPreferencesFromLocalStorage() {
    try {
        const savedPrefs = JSON.parse(localStorage.getItem('userPreferences'));
        if (savedPrefs) {
            const adaptiveDiff = document.getElementById('adaptiveDifficulty');
            if (adaptiveDiff) adaptiveDiff.checked = savedPrefs.adaptive_difficulty !== false;
            
            const prefDiff = document.getElementById('preferredDifficulty');
            if (prefDiff && savedPrefs.preferred_difficulty) {
                const options = Array.from(prefDiff.options);
                const index = options.findIndex(opt => opt.text.toLowerCase() === savedPrefs.preferred_difficulty.toLowerCase());
                if (index !== -1) prefDiff.selectedIndex = index;
            }
            
            const showSolutions = document.getElementById('showSolutions');
            if (showSolutions) showSolutions.checked = savedPrefs.show_solutions !== false;
        }
    } catch (e) {
        console.log('No saved preferences found');
    }
}

// ============================================
// FIXED: loadNotificationSettings
// ============================================
async function loadNotificationSettings() {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) return;
        
        console.log('ðŸ”” Loading notification settings from database...');
        
        const response = await fetch(`/api/user/notifications`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Accept': 'application/json'
            }
        });
        
        const contentType = response.headers.get('content-type');
        
        if (!response.ok || (contentType && contentType.includes('text/html'))) {
            console.log('â„¹ï¸ Notification endpoint not found, using localStorage');
            loadNotificationsFromLocalStorage();
            return;
        }
        
        if (!contentType || !contentType.includes('application/json')) {
            loadNotificationsFromLocalStorage();
            return;
        }
        
        const data = await response.json();
        
        if (data.success && data.notifications) {
            const notifs = data.notifications;
            
            const weeklyReport = document.getElementById('weeklyReport');
            if (weeklyReport) weeklyReport.checked = notifs.weekly_report !== false;
            
            const featureAnnouncements = document.getElementById('featureAnnouncements');
            if (featureAnnouncements) featureAnnouncements.checked = notifs.feature_announcements !== false;
            
            const practiceReminders = document.getElementById('practiceReminders');
            if (practiceReminders) practiceReminders.checked = notifs.practice_reminders !== false;
            
            const achievementAlerts = document.getElementById('achievementAlerts');
            if (achievementAlerts) achievementAlerts.checked = notifs.achievement_alerts !== false;
            
            console.log('âœ… Notification settings loaded from database');
        } else {
            loadNotificationsFromLocalStorage();
        }
    } catch (error) {
        console.error('Error loading notifications:', error);
        loadNotificationsFromLocalStorage();
    }
}

/**
 * Load notifications from localStorage as fallback
 */
function loadNotificationsFromLocalStorage() {
    try {
        const savedNotifs = JSON.parse(localStorage.getItem('notificationSettings'));
        if (savedNotifs) {
            const weeklyReport = document.getElementById('weeklyReport');
            if (weeklyReport) weeklyReport.checked = savedNotifs.weekly_report !== false;
            
            const featureAnnouncements = document.getElementById('featureAnnouncements');
            if (featureAnnouncements) featureAnnouncements.checked = savedNotifs.feature_announcements !== false;
            
            const practiceReminders = document.getElementById('practiceReminders');
            if (practiceReminders) practiceReminders.checked = savedNotifs.practice_reminders !== false;
            
            const achievementAlerts = document.getElementById('achievementAlerts');
            if (achievementAlerts) achievementAlerts.checked = savedNotifs.achievement_alerts !== false;
        }
    } catch (e) {
        console.log('No saved notifications found');
    }
}

// ============================================
// FIXED: loadPrivacySettings
// ============================================
async function loadPrivacySettings() {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) return;
        
        console.log('ðŸ”’ Loading privacy settings from database...');
        
        const response = await fetch(`/api/user/privacy`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Accept': 'application/json'
            }
        });
        
        const contentType = response.headers.get('content-type');
        
        if (!response.ok || (contentType && contentType.includes('text/html'))) {
            console.log('â„¹ï¸ Privacy endpoint not found, using localStorage');
            loadPrivacyFromLocalStorage();
            return;
        }
        
        if (!contentType || !contentType.includes('application/json')) {
            loadPrivacyFromLocalStorage();
            return;
        }
        
        const data = await response.json();
        
        if (data.success && data.privacy) {
            const privacy = data.privacy;
            
            const twoFactorAuth = document.getElementById('twoFactorAuth');
            if (twoFactorAuth) twoFactorAuth.checked = privacy.two_factor_auth === true;
            
            const profileVisibility = document.getElementById('profileVisibility');
            if (profileVisibility && privacy.profile_visibility) {
                profileVisibility.value = privacy.profile_visibility;
            }
            
            const dataSharing = document.getElementById('dataSharing');
            if (dataSharing) dataSharing.checked = privacy.data_sharing === true;
            
            console.log('âœ… Privacy settings loaded from database');
        } else {
            loadPrivacyFromLocalStorage();
        }
    } catch (error) {
        console.error('Error loading privacy:', error);
        loadPrivacyFromLocalStorage();
    }
}
/**
 * Load privacy from localStorage as fallback
 */
function loadPrivacyFromLocalStorage() {
    try {
        const savedPrivacy = JSON.parse(localStorage.getItem('privacySettings'));
        if (savedPrivacy) {
            const twoFactorAuth = document.getElementById('twoFactorAuth');
            if (twoFactorAuth) twoFactorAuth.checked = savedPrivacy.two_factor_auth === true;
            
            const dataSharing = document.getElementById('dataSharing');
            if (dataSharing) dataSharing.checked = savedPrivacy.data_sharing === true;
        }
    } catch (e) {
        console.log('No saved privacy settings found');
    }
}

/**
 * Load display settings from database
 */
async function loadDisplaySettings() {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) {
            console.log('No token, using localStorage for display settings');
            loadDisplayFromLocalStorage();
            return;
        }
        
        console.log('ðŸŽ¨ Loading display settings from database...');
        
        // âœ… FIX: Add /api/ prefix
        const response = await fetch(`/api/user/display`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        // Check if response is JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            console.warn('âš ï¸ Non-JSON response from display endpoint');
            loadDisplayFromLocalStorage();
            return;
        }
        
        if (response.status === 404) {
            console.log('â„¹ï¸ Display endpoint not found, using localStorage');
            loadDisplayFromLocalStorage();
            return;
        }
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success && data.display) {
            const display = data.display;
            
            // Set theme
            if (display.theme) {
                applyTheme(display.theme);
            }
            
            // Set math symbol style
            const mathStyle = document.getElementById('mathSymbolStyle');
            if (mathStyle && display.math_style) {
                mathStyle.value = display.math_style;
            }
            
            // Set high contrast
            const highContrast = document.getElementById('highContrast');
            if (highContrast) {
                highContrast.checked = display.high_contrast === true;
                applyHighContrast(display.high_contrast);
            }
            
            // Set font size
            const fontSize = document.getElementById('fontSize');
            if (fontSize && display.font_size) {
                fontSize.value = display.font_size;
                applyFontSize(display.font_size);
            }
            
            console.log('âœ… Display settings loaded from database');
        } else {
            loadDisplayFromLocalStorage();
        }
    } catch (error) {
        console.error('Error loading display:', error);
        loadDisplayFromLocalStorage();
    }
}

/**
 * Load display from localStorage as fallback
 */
function loadDisplayFromLocalStorage() {
    try {
        const savedDisplay = JSON.parse(localStorage.getItem('displaySettings'));
        if (savedDisplay) {
            if (savedDisplay.theme) {
                const themeRadio = document.getElementById(`theme${savedDisplay.theme.charAt(0).toUpperCase() + savedDisplay.theme.slice(1)}`);
                if (themeRadio) themeRadio.checked = true;
                applyTheme(savedDisplay.theme);
            }
            
            const highContrast = document.getElementById('highContrast');
            if (highContrast) highContrast.checked = savedDisplay.high_contrast === true;
        }
    } catch (e) {
        console.log('No saved display settings found');
    }
}
/**
 * Connect external account
 */
async function connectAccount(provider) {
    console.log(`ðŸ”— Connecting ${provider} account...`);
    
    const token = localStorage.getItem('authToken') || authToken;
    
    try {
        const response = await fetch(`/api/user/connect/${provider}`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification(`${provider} account connected successfully!`, 'success');
            
            // Update button text
            const btn = document.getElementById(`${provider}AccountBtn`);
            if (btn) {
                btn.innerHTML = `<i class="fab fa-${provider}"></i> Connected`;
                btn.classList.add('connected');
            }
        } else {
            showNotification(`Failed to connect ${provider} account`, 'error');
        }
    } catch (error) {
        console.error('Error connecting account:', error);
        showNotification(`${provider} connection coming soon!`, 'info');
    }
}
// ============================================
// SAVE SETTINGS TO DATABASE
// ============================================

/**
 * Setup settings save functionality
 */
function setupSettingsSave() {
    const saveBtn = document.querySelector('.action-buttons .btn-primary');
    if (!saveBtn) return;
    
    // Remove existing listeners
    const newBtn = saveBtn.cloneNode(true);
    saveBtn.parentNode.replaceChild(newBtn, saveBtn);
    
    newBtn.addEventListener('click', saveAllSettings);
}

/**
 * Save all settings to database
 */
async function saveAllSettings() {
    console.log('ðŸ’¾ Saving all settings to database...');
    
    const saveBtn = document.querySelector('.action-buttons .btn-primary');
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving to database...';
    saveBtn.disabled = true;
    
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) {
            showNotification('Please login again', 'error');
            navigateTo('login');
            return;
        }
        
        // Collect all settings
        const settings = {
            profile: collectProfileSettings(),
            preferences: collectPreferencesSettings(),
            notifications: collectNotificationSettings(),
            privacy: collectPrivacySettings(),
            display: collectDisplaySettings()
        };
        
        console.log('ðŸ“¤ Saving to database:', settings);
        
        // Save profile first
        if (Object.keys(settings.profile).length > 0) {
            await saveProfileToDatabase(settings.profile);
        }
        
        // Save preferences
        await savePreferencesToDatabase(settings.preferences);
        
        // Save notifications
        await saveNotificationsToDatabase(settings.notifications);
        
        // Save privacy
        await savePrivacyToDatabase(settings.privacy);
        
        // Save display
        await saveDisplayToDatabase(settings.display);
        
        // Also save to localStorage as backup
        saveToLocalStorage(settings);
        
        showNotification('âœ… All settings saved to database successfully!', 'success');
        
    } catch (error) {
        console.error('âŒ Error saving settings:', error);
        showNotification('Failed to save to database. Saved locally instead.', 'warning');
        
        // Save to localStorage as fallback
        const settings = {
            profile: collectProfileSettings(),
            preferences: collectPreferencesSettings(),
            notifications: collectNotificationSettings(),
            privacy: collectPrivacySettings(),
            display: collectDisplaySettings()
        };
        saveToLocalStorage(settings);
        
    } finally {
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
    }
}

/**
 * Collect profile settings from form
 */
function collectProfileSettings() {
    const settings = {};
    
    const displayName = document.getElementById('displayName')?.value;
    if (displayName) settings.full_name = displayName;
    
    const email = document.getElementById('userEmail')?.value;
    if (email) settings.email = email;
    
    const language = document.getElementById('interfaceLanguage')?.value;
    if (language) settings.language = language;
    
    const municipality = document.getElementById('batangas-municipalities')?.value;
    if (municipality) settings.municipality = municipality;
    
    const timezone = document.getElementById('timeZone')?.value;
    if (timezone) settings.timezone = timezone;
    
    return settings;
}

/**
 * Collect preferences settings from form
 */
function collectPreferencesSettings() {
    return {
        adaptive_difficulty: document.getElementById('adaptiveDifficulty')?.checked || false,
        preferred_difficulty: document.getElementById('preferredDifficulty')?.value || 'Intermediate',
        practice_count: document.querySelector('input[name="practice"]:checked')?.id?.replace('practice', '') || '10',
        show_solutions: document.getElementById('showSolutions')?.checked || false
    };
}

/**
 * Collect notification settings from form
 */
function collectNotificationSettings() {
    return {
        weekly_report: document.getElementById('weeklyReport')?.checked || false,
        feature_announcements: document.getElementById('featureAnnouncements')?.checked || false,
        practice_reminders: document.getElementById('practiceReminders')?.checked || false,
        achievement_alerts: document.getElementById('achievementAlerts')?.checked || false
    };
}

/**
 * Collect privacy settings from form
 */
function collectPrivacySettings() {
    return {
        two_factor_auth: document.getElementById('twoFactorAuth')?.checked || false,
        profile_visibility: document.getElementById('profileVisibility')?.value || 'Private',
        data_sharing: document.getElementById('dataSharing')?.checked || false
    };
}



/**
 * Save profile to database
 */
async function saveProfileToDatabase(profileData) {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        
        const response = await fetch(`/api/user/profile`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(profileData)
        });
        
        const data = await response.json();
        
        if (data.success && data.profile) {
            // Update local storage
            const userJson = localStorage.getItem('mathhub_user');
            if (userJson) {
                const user = JSON.parse(userJson);
                Object.assign(user, data.profile);
                localStorage.setItem('mathhub_user', JSON.stringify(user));
            }
            
            console.log('âœ… Profile saved to database');
            return true;
        }
        return false;
    } catch (error) {
        console.error('Error saving profile:', error);
        return false;
    }
}

/**
 * Save preferences to database
 */
async function savePreferencesToDatabase(preferences) {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        
        const response = await fetch(`/api/user/preferences`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(preferences)
        });
        
        if (response.ok) {
            console.log('âœ… Preferences saved to database');
            return true;
        }
        return false;
    } catch (error) {
        console.error('Error saving preferences:', error);
        return false;
    }
}

/**
 * Save notifications to database
 */
async function saveNotificationsToDatabase(notifications) {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        
        const response = await fetch(`/api/user/notifications`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(notifications)
        });
        
        if (response.ok) {
            console.log('âœ… Notifications saved to database');
            return true;
        }
        return false;
    } catch (error) {
        console.error('Error saving notifications:', error);
        return false;
    }
}

/**
 * Save privacy to database
 */
async function savePrivacyToDatabase(privacy) {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        
        const response = await fetch(`/api/user/privacy`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(privacy)
        });
        
        if (response.ok) {
            console.log('âœ… Privacy saved to database');
            return true;
        }
        return false;
    } catch (error) {
        console.error('Error saving privacy:', error);
        return false;
    }
}

/**
 * Save display to database
 */
async function saveDisplayToDatabase(display) {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        
        const response = await fetch(`/api/user/display`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(display)
        });
        
        if (response.ok) {
            console.log('âœ… Display saved to database');
            return true;
        }
        return false;
    } catch (error) {
        console.error('Error saving display:', error);
        return false;
    }
}

/**
 * Save to localStorage as backup
 */
function saveToLocalStorage(settings) {
    try {
        if (settings.preferences) {
            localStorage.setItem('userPreferences', JSON.stringify(settings.preferences));
        }
        if (settings.notifications) {
            localStorage.setItem('notificationSettings', JSON.stringify(settings.notifications));
        }
        if (settings.privacy) {
            localStorage.setItem('privacySettings', JSON.stringify(settings.privacy));
        }
        if (settings.display) {
            localStorage.setItem('displaySettings', JSON.stringify(settings.display));
        }
        console.log('ðŸ’¾ Settings saved to localStorage as backup');
    } catch (e) {
        console.error('Error saving to localStorage:', e);
    }
}

// ============================================
// SETTINGS SECTION NAVIGATION
// ============================================

/**
 * Show a specific settings section
 */
function showSection(sectionId) {
    console.log(`âš™ï¸ Showing settings section: ${sectionId}`);
    
    // Hide all settings sections
    const sections = document.querySelectorAll('.settings-section');
    sections.forEach(section => {
        section.classList.remove('active');
        section.style.display = 'none';
    });
    
    // Show selected section
    const targetSection = document.getElementById(sectionId);
    if (targetSection) {
        targetSection.classList.add('active');
        targetSection.style.display = 'block';
        
        // Update active state in sidebar
        document.querySelectorAll('.sidebar-menu a').forEach(link => {
            link.classList.remove('active');
        });
        
        const activeLink = document.querySelector(`[onclick="showSection('${sectionId}')"]`);
        if (activeLink) {
            activeLink.classList.add('active');
        }
    }
}

// ============================================
// RESET SETTINGS TO DEFAULTS
// ============================================

/**
 * Reset settings to defaults
 */
async function resetSettings() {
    console.log('ðŸ”„ Resetting settings to defaults');
    
    if (!confirm('Are you sure you want to reset all settings to default values?')) return;
    
    const token = localStorage.getItem('authToken') || authToken;
    
    try {
        // Call database to reset
        if (token) {
            await fetch(`/api/user/reset-settings`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
        }
        
        // Reset form fields
        resetFormFields();
        
        // Clear localStorage
        localStorage.removeItem('userPreferences');
        localStorage.removeItem('notificationSettings');
        localStorage.removeItem('privacySettings');
        localStorage.removeItem('displaySettings');
        
        showNotification('Settings reset to defaults', 'success');
        
    } catch (error) {
        console.error('Error resetting settings:', error);
        
        // Reset locally even if database fails
        resetFormFields();
        showNotification('Settings reset locally', 'info');
    }
}

/**
 * Reset form fields to defaults
 */
function resetFormFields() {
    // Reset toggles to default (checked)
    const toggles = ['adaptiveDifficulty', 'showSolutions', 'weeklyReport', 
                     'featureAnnouncements', 'practiceReminders', 'achievementAlerts'];
    toggles.forEach(id => {
        const element = document.getElementById(id);
        if (element) element.checked = true;
    });
    
    // Reset toggles that should be unchecked by default
    const uncheckedToggles = ['twoFactorAuth', 'dataSharing', 'highContrast'];
    uncheckedToggles.forEach(id => {
        const element = document.getElementById(id);
        if (element) element.checked = false;
    });
    
    // Reset selects to first option
    const selects = ['preferredDifficulty', 'profileVisibility', 'mathSymbolStyle', 'fontSize'];
    selects.forEach(id => {
        const element = document.getElementById(id);
        if (element) element.selectedIndex = 0;
    });
    
    // Reset theme to light
    const themeLight = document.getElementById('themeLight');
    if (themeLight) themeLight.checked = true;
    applyTheme('light');
}
// Update profile overview with user data and initials
function updateProfileOverview(profile) {
    // Get full name for initials
    const fullName = profile.full_name || profile.username || 'User';
    const initials = getInitials(fullName);
    
    // Update profile initials in overview
    const profileInitials = document.getElementById('profileInitials');
    if (profileInitials) {
        profileInitials.innerHTML = `<span>${initials}</span>`;
    }
    
    // Update profile initials in preview
    const profileInitialsPreview = document.getElementById('profileInitialsPreview');
    if (profileInitialsPreview) {
        profileInitialsPreview.textContent = initials;
    }
    
    // Update display name
    const profileDisplayName = document.getElementById('profileDisplayName');
    if (profileDisplayName) {
        profileDisplayName.textContent = fullName;
    }
    
    // Update email
    const profileEmail = document.getElementById('profileEmail');
    if (profileEmail) {
        profileEmail.textContent = profile.email || 'No email provided';
    }
    
    // Update role
    const profileRole = document.getElementById('profileRole');
    if (profileRole) {
        const role = profile.role || 'student';
        profileRole.textContent = role.charAt(0).toUpperCase() + role.slice(1);
    }
}

// Get initials from name
function getInitials(name) {
    if (!name) return 'U';
    
    // Split the name by spaces
    const nameParts = name.trim().split(' ');
    
    if (nameParts.length === 1) {
        // Single word name - take first two letters or just first letter
        return nameParts[0].substring(0, 2).toUpperCase();
    } else {
        // Multiple words - take first letter of first and last word
        const firstInitial = nameParts[0].charAt(0);
        const lastInitial = nameParts[nameParts.length - 1].charAt(0);
        return (firstInitial + lastInitial).toUpperCase();
    }
}

// ============================================
// Helper: Update account stats
// ============================================
function updateAccountStats(profile) {
    const memberSince = document.getElementById('memberSince');
    if (memberSince && profile.joined_date) {
        memberSince.textContent = formatDate(profile.joined_date);
    } else if (memberSince) {
        memberSince.textContent = 'Recently';
    }
    
    const lastLogin = document.getElementById('lastLogin');
    if (lastLogin && profile.last_login) {
        lastLogin.textContent = formatDateTime(profile.last_login);
    } else if (lastLogin) {
        lastLogin.textContent = 'First login';
    }
    
    const accountRole = document.getElementById('accountRole');
    if (accountRole && profile.role) {
        accountRole.textContent = profile.role.charAt(0).toUpperCase() + profile.role.slice(1);
    }
}


// Format date
function formatDate(dateString) {
    if (!dateString) return 'Unknown';
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    });
}

// Format date and time
function formatDateTime(dateString) {
    if (!dateString) return 'Unknown';
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// Setup profile form submission
function setupProfileForm() {
    const profileForm = document.getElementById('profileForm');
    const cancelBtn = document.getElementById('cancelProfileBtn');
    
    if (profileForm) {
        profileForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const fullName = document.getElementById('displayName').value.trim();
            const username = document.getElementById('username').value.trim();
            const email = document.getElementById('userEmail').value.trim();
            
            // Validation
            if (!fullName && !username && !email) {
                showNotification('Please fill in at least one field', 'error');
                return;
            }
            
            // Prepare update data
            const updateData = {};
            if (fullName) updateData.full_name = fullName;
            if (username) updateData.username = username;
            if (email) updateData.email = email;
            
            // Submit update
            const success = await updateProfile(updateData);
            
            if (success) {
                showNotification('Profile updated successfully!', 'success');
                await loadProfileData(); // Reload profile data
            }
        });
    }
    
    if (cancelBtn) {
        cancelBtn.addEventListener('click', function() {
            // Reset form to original values
            loadProfileData();
        });
    }
}

// Update profile
async function updateProfile(updateData) {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) {
            showNotification('Please login again', 'error');
            navigateTo('login');
            return false;
        }
        
        console.log('âœï¸ Updating profile with:', updateData);
        
        const response = await fetch(`/api/user/profile`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(updateData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Update local storage user data
            const savedUser = JSON.parse(localStorage.getItem('mathhub_user') || '{}');
            const updatedUser = {
                ...savedUser,
                ...data.profile
            };
            localStorage.setItem('mathhub_user', JSON.stringify(updatedUser));
            
            // Update app state
            if (AppState.currentUser) {
                AppState.currentUser = {
                    ...AppState.currentUser,
                    ...data.profile
                };
            }
            
            return true;
        } else {
            showNotification(data.message || 'Failed to update profile', 'error');
            return false;
        }
    } catch (error) {
        console.error('Error updating profile:', error);
        showNotification('Failed to update profile', 'error');
        return false;
    }
}

// Setup change password form - ULTRA CLEAN VERSION
/**
 * Setup change password form with database connection
 */
function setupChangePasswordForm() {
    console.log('ðŸ” Setting up change password form...');
    
    const changePasswordBtn = document.getElementById('changePasswordBtn');
    
    if (changePasswordBtn) {
        console.log('âœ… Change password button found');
        
        // Remove existing listeners to avoid duplicates
        const newBtn = changePasswordBtn.cloneNode(true);
        changePasswordBtn.parentNode.replaceChild(newBtn, changePasswordBtn);
        
        newBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('ðŸ”‘ Change password button clicked');
            showChangePasswordModal();
        });
    } else {
        console.error('âŒ Change password button not found!');
        
        // Try to find it again after a short delay
        setTimeout(() => {
            const btn = document.getElementById('changePasswordBtn');
            if (btn) {
                console.log('âœ… Found button on retry');
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    showChangePasswordModal();
                });
            }
        }, 1000);
    }
}
/**
 * Show change password modal
 */
/**
 * Show change password modal
 */
window.showChangePasswordModal = function() {
    console.log('ðŸ“ Showing change password modal');
    
    // Remove existing modal if any
    const existingModal = document.getElementById('passwordModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Create modal HTML
    const modalHTML = `
        <div class="change-password-modal" style="background: white; border-radius: 10px; max-width: 500px; width: 100%;">
            <div class="modal-header" style="background: #7a0000; color: white; padding: 15px 20px; border-radius: 10px 10px 0 0; position: relative;">
                <h3 style="margin: 0; font-size: 18px;"><i class="fas fa-key"></i> Change Password</h3>
                <button onclick="closePasswordModal()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer; position: absolute; top: 10px; right: 15px;">&times;</button>
            </div>
            
            <div class="modal-body" style="padding: 25px;">
                <div class="info-box" style="background: #f8f9fa; padding: 12px 15px; border-radius: 6px; margin-bottom: 20px; border-left: 4px solid #7a0000;">
                    <p style="margin: 0; color: #2c3e50; font-size: 14px;">
                        <i class="fas fa-info-circle" style="color: #7a0000;"></i> 
                        Password must be at least 6 characters long.
                    </p>
                </div>
                
                <form id="passwordChangeForm" onsubmit="handlePasswordSubmit(event)">
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50; font-size: 14px;">
                            <i class="fas fa-lock"></i> Current Password <span style="color: red;">*</span>
                        </label>
                        <input type="password" id="currentPassword" class="form-control" 
                               placeholder="Enter your current password" required
                               style="width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50; font-size: 14px;">
                            <i class="fas fa-lock"></i> New Password <span style="color: red;">*</span>
                        </label>
                        <input type="password" id="newPassword" class="form-control" 
                               placeholder="Enter new password (min. 6 characters)" required
                               style="width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50; font-size: 14px;">
                            <i class="fas fa-check-circle"></i> Confirm New Password <span style="color: red;">*</span>
                        </label>
                        <input type="password" id="confirmPassword" class="form-control" 
                               placeholder="Re-enter new password" required
                               style="width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="button" onclick="closePasswordModal()" 
                                style="padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; background: #95a5a6; color: white; font-size: 14px;">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button type="submit" id="submitPasswordChange" 
                                style="padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; background: #7a0000; color: white; font-size: 14px;">
                            <i class="fas fa-save"></i> Save Password
                        </button>
                    </div>
                </form>
            </div>
        </div>
    `;
    
    // Create modal container
    const modalContainer = document.createElement('div');
    modalContainer.id = 'passwordModal';
    modalContainer.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        padding: 20px;
    `;
    
    modalContainer.innerHTML = modalHTML;
    document.body.appendChild(modalContainer);
    
    // Close modal when clicking outside
    modalContainer.addEventListener('click', function(e) {
        if (e.target === modalContainer) {
            closePasswordModal();
        }
    });
    
    console.log('âœ… Modal created and attached to DOM');
};
/**
 * Close password modal
 */
window.closePasswordModal = function() {
    const modal = document.getElementById('passwordModal');
    if (modal) {
        modal.remove();
    }
};

/**
 * Handle password form submission
 */
window.handlePasswordSubmit = async function(event) {
    event.preventDefault();
    console.log('ðŸ“ Form submitted!');
    
    const currentPassword = document.getElementById('currentPassword')?.value;
    const newPassword = document.getElementById('newPassword')?.value;
    const confirmPassword = document.getElementById('confirmPassword')?.value;
    
    // Validation
    if (!currentPassword || !newPassword || !confirmPassword) {
        showNotification('All fields are required', 'error');
        return;
    }
    
    if (newPassword !== confirmPassword) {
        showNotification('New passwords do not match', 'error');
        return;
    }
    
    if (newPassword.length < 6) {
        showNotification('Password must be at least 6 characters', 'error');
        return;
    }
    
    const submitBtn = document.getElementById('submitPasswordChange');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
    submitBtn.disabled = true;
    
    try {
        const token = localStorage.getItem('authToken') || window.authToken;
        
        if (!token) {
            showNotification('Please login again', 'error');
            navigateTo('login');
            return;
        }
        
        console.log('ðŸ“¤ Sending request to:', '/api/user/change-password');
        
        const response = await fetch('/api/user/change-password', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                current_password: currentPassword,
                new_password: newPassword,
                confirm_password: confirmPassword
            })
        });
        
        const data = await response.json();
        console.log('ðŸ“¥ Response:', data);
        
        if (response.ok && data.success) {
            // Show success message
            showNotification('âœ… Password changed successfully!', 'success');
            
            // Clear form
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            
            // Close modal after 1 second
            setTimeout(() => {
                closePasswordModal();
            }, 1000);
            
        } else {
            showNotification(data.message || 'Failed to change password', 'error');
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
        
    } catch (error) {
        console.error('âŒ Error:', error);
        showNotification('Failed to change password. Please try again.', 'error');
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }
};

/**
 * Logout after password change
 */
window.logoutAfterPasswordChange = function() {
    console.log('ðŸšª Logging out after password change...');
    
    // Clear all authentication data
    localStorage.removeItem('authToken');
    localStorage.removeItem('mathhub_user');
    localStorage.removeItem('hasSelectedApp');
    localStorage.removeItem('selectedApp');
    sessionStorage.clear();
    
    // Reset app state
    AppState.currentUser = null;
    AppState.isAuthenticated = false;
    authToken = null;
    
    // Close modal
    closePasswordModal();
    
    // Navigate to login
    navigateTo('login');
};
// Change password - FIXED VERSION with button parameter
async function changePassword(currentPassword, newPassword, confirmPassword, submitBtn, originalText) {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) {
            showNotification('Please login again', 'error');
            navigateTo('login');
            return false;
        }
        
        console.log('ðŸ” Sending password change request to server...');
        
        const requestBody = {
            current_password: currentPassword,
            new_password: newPassword,
            confirm_password: confirmPassword
        };
        
        const response = await fetch(`/api/user/change-password`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestBody)
        });
        
        const responseText = await response.text();
        console.log('ðŸ“¥ Raw server response:', responseText);
        
        let data;
        try {
            data = JSON.parse(responseText);
        } catch (e) {
            console.error('Failed to parse server response as JSON:', responseText);
            showNotification('Server error: ' + responseText.substring(0, 100), 'error');
            
            // Reset button
            if (submitBtn) {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
            return false;
        }
        
        if (response.ok && data.success) {
            console.log('âœ… Password changed successfully');
            
            // Show success message briefly
            if (submitBtn) {
                submitBtn.innerHTML = '<i class="fas fa-check-circle"></i> Password Changed!';
                // Don't disable - let user see the success state
            }
            
            showNotification('âœ… Password changed successfully! Redirecting to login...', 'success');
            
            // Wait for user to see success message
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Clear ALL authentication data
            localStorage.removeItem('authToken');
            localStorage.removeItem('mathhub_user');
            localStorage.removeItem('hasSelectedApp');
            localStorage.removeItem('selectedApp');
            sessionStorage.clear();
            
            // Reset app state
            AppState.currentUser = null;
            AppState.isAuthenticated = false;
            AppState.hasSelectedApp = false;
            authToken = null;
            
            // Hide footer navigation
            hideFooterNavigation();
            
            // Navigate to login
            navigateTo('login');
            
            return true;
        } else {
            // Show error from server
            const errorMessage = data.message || data.error || 'Failed to change password';
            console.error('âŒ Password change failed:', errorMessage);
            showNotification(errorMessage, 'error');
            
            // Reset button
            if (submitBtn) {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
            
            return false;
        }
    } catch (error) {
        console.error('âŒ Error changing password:', error);
        showNotification('Failed to change password. Please try again.', 'error');
        
        // Reset button
        if (submitBtn) {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
        
        return false;
    }
}

// Change password - FIXED VERSION with button reset before redirect
async function changePassword(currentPassword, newPassword, confirmPassword) {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) {
            showNotification('Please login again', 'error');
            navigateTo('login');
            return false;
        }
        
        console.log('ðŸ” Sending password change request to server...');
        
        const requestBody = {
            current_password: currentPassword,
            new_password: newPassword,
            confirm_password: confirmPassword
        };
        
        const response = await fetch(`/api/user/change-password`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestBody)
        });
        
        const responseText = await response.text();
        console.log('ðŸ“¥ Raw server response:', responseText);
        
        let data;
        try {
            data = JSON.parse(responseText);
        } catch (e) {
            console.error('Failed to parse server response as JSON:', responseText);
            showNotification('Server error: ' + responseText.substring(0, 100), 'error');
            return false;
        }
        
        if (response.ok && data.success) {
            console.log('âœ… Password changed successfully');
            
            // Get the submit button and reset it BEFORE redirect
            const submitBtn = document.querySelector('#changePasswordForm button[type="submit"]');
            if (submitBtn) {
                submitBtn.innerHTML = '<i class="fas fa-check-circle"></i> Password Changed!';
                submitBtn.disabled = false;
                submitBtn.style.background = '#27ae60';
            }
            
            // Show success message
            showNotification('âœ… Password changed successfully!', 'success');
            
            // Wait a moment for the user to see the success message
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Clear ALL authentication data from client
            localStorage.removeItem('authToken');
            localStorage.removeItem('mathhub_user');
            localStorage.removeItem('hasSelectedApp');
            localStorage.removeItem('selectedApp');
            sessionStorage.clear();
            
            // Reset app state
            AppState.currentUser = null;
            AppState.isAuthenticated = false;
            AppState.hasSelectedApp = false;
            authToken = null;
            
            // Hide footer navigation
            hideFooterNavigation();
            
            // Navigate to login page
            navigateTo('login');
            
            return true;
        } else {
            // Show error from server
            const errorMessage = data.message || data.error || 'Failed to change password';
            console.error('âŒ Password change failed:', errorMessage);
            showNotification(errorMessage, 'error');
            
            // Reset button state on failure
            const submitBtn = document.querySelector('#changePasswordForm button[type="submit"]');
            if (submitBtn) {
                submitBtn.innerHTML = '<i class="fas fa-key"></i> Update Password';
                submitBtn.disabled = false;
            }
            
            return false;
        }
    } catch (error) {
        console.error('âŒ Error changing password:', error);
        showNotification('Failed to change password. Please try again.', 'error');
        
        // Reset button state on error
        const submitBtn = document.querySelector('#changePasswordForm button[type="submit"]');
        if (submitBtn) {
            submitBtn.innerHTML = '<i class="fas fa-key"></i> Update Password';
            submitBtn.disabled = false;
        }
        
        return false;
    }
}

// Add this after setting up the form
window.addEventListener('load', function() {
    setTimeout(() => {
        const confirmInput = document.getElementById('confirmPassword');
        if (confirmInput && confirmInput.value) {
            console.log('ðŸ” Autofill detected:', confirmInput.value);
        }
    }, 500);
});


// Setup delete account
function setupDeleteAccount() {
    const deleteBtn = document.getElementById('deleteAccountBtn');
    
    if (deleteBtn) {
        deleteBtn.addEventListener('click', function() {
            // Show confirmation modal
            showDeleteConfirmationModal();
        });
    }
}

// Show delete confirmation modal
function showDeleteConfirmationModal() {
    const modalHTML = `
        <div class="delete-confirmation-modal">
            <div class="modal-header">
                <h3><i class="fas fa-exclamation-triangle"></i> Delete Account</h3>
            </div>
            
            <div class="modal-body">
                <p><strong>Warning:</strong> This action is permanent and cannot be undone.</p>
                <p>All your progress, achievements, and data will be permanently deleted.</p>
                
                <div class="confirmation-input">
                    <label>Type "DELETE" to confirm:</label>
                    <input type="text" id="deleteConfirmation" placeholder="DELETE">
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn-secondary" id="cancelDeleteBtn">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button class="btn-danger" id="confirmDeleteBtn" disabled>
                    <i class="fas fa-trash"></i> Permanently Delete Account
                </button>
            </div>
        </div>
    `;
    
    const modal = showModal(modalHTML);
    
    const confirmationInput = document.getElementById('deleteConfirmation');
    const confirmBtn = document.getElementById('confirmDeleteBtn');
    const cancelBtn = document.getElementById('cancelDeleteBtn');
    
    if (confirmationInput) {
        confirmationInput.addEventListener('input', function() {
            if (confirmBtn) {
                confirmBtn.disabled = this.value !== 'DELETE';
            }
        });
    }
    
    if (confirmBtn) {
        confirmBtn.addEventListener('click', async function() {
            const success = await deleteAccount();
            
            if (success) {
                // Close modal
                modal.remove();
                
                // Logout and redirect
                logoutAndRedirect();
                showNotification('Account deleted successfully', 'info');
            }
        });
    }
    
    if (cancelBtn) {
        cancelBtn.addEventListener('click', function() {
            modal.remove();
        });
    }
}

// Delete account
async function deleteAccount() {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) {
            showNotification('Please login again', 'error');
            navigateTo('login');
            return false;
        }
        
        console.log('ðŸ—‘ï¸ Deleting account...');
        
        const response = await fetch(`/api/user/delete-account`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            return true;
        } else {
            showNotification(data.message || 'Failed to delete account', 'error');
            return false;
        }
    } catch (error) {
        console.error('Error deleting account:', error);
        showNotification('Failed to delete account', 'error');
        return false;
    }
}

// Add CSS for settings dashboard
function addSettingsStyles() {
    if (document.querySelector('#settings-styles')) return;
    
    const style = document.createElement('style');
    style.id = 'settings-styles';
    style.textContent = `
        /* Settings Page Layout */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            padding: 20px;
        }
        
        .settings-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }
        
        .settings-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .settings-card h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 18px;
        }
        
        .settings-card h3 i {
            color: #3498db;
        }
        
        .form-row {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: 500;
            font-size: 14px;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .form-control:disabled {
            background: #f8f9fa;
            cursor: not-allowed;
        }
        
        .file-upload {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .profile-preview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 3px solid #fff;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        .profile-preview i {
            font-size: 60px;
            color: #bdc3c7;
        }
        
        .profile-initials-preview {
            width: 100%;
            height: 100%;
            background: #667eea;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: bold;
            color: white;
        }
        
        .btn-primary, .btn-secondary, .btn-danger {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }
        
        .btn-secondary {
            background: #ecf0f1;
            color: #2c3e50;
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: #d5dbdb;
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover:not(:disabled) {
            background: #c0392b;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
        }
        
        .btn-primary:disabled,
        .btn-secondary:disabled,
        .btn-danger:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        /* Delete Confirmation Modal */
        .delete-confirmation-modal {
            background: white;
            border-radius: 10px;
            max-width: 500px;
            width: 100%;
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .modal-header h3 {
            margin: 0;
            color: #e74c3c;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .modal-body p {
            margin: 10px 0;
            color: #2c3e50;
        }
        
        .confirmation-input {
            margin-top: 20px;
        }
        
        .confirmation-input label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: 500;
        }
        
        .confirmation-input input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .confirmation-input input:focus {
            outline: none;
            border-color: #e74c3c;
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1);
        }
        
        .modal-footer {
            padding: 20px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 10px;
        }
        
        .modal-footer button {
            flex: 1;
        }
    `;
    
    document.head.appendChild(style);
}

// Update setupSettingsNavigation function
function setupSettingsNavigation() {
    console.log('âš™ï¸ Setting up settings navigation...');
    
    const backToDashboardBtn = document.getElementById('backToDashboardBtnSettings');
    if (backToDashboardBtn) {
        backToDashboardBtn.addEventListener('click', () => {
            navigateTo('dashboard');
        });
    }
}

// ============================================
// âœ… LOAD QUIZ STATS
// ============================================
async function loadQuizStats() {
    try {
        const token = localStorage.getItem('authToken');
        if (!token) {
            console.log('No token found');
            return;
        }
        
        const response = await fetch('/api/quiz/user/stats', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        const data = await response.json();
        
        if (data.success && data.stats) {
            document.getElementById('quizCurrentScore').textContent = data.stats.current_score + '%';
            document.getElementById('quizAccuracy').textContent = data.stats.accuracy + '%';
            document.getElementById('quizTimeSpent').textContent = data.stats.time_spent;
            document.getElementById('quizRank').textContent = data.stats.rank;
        }
    } catch (error) {
        console.error('Error loading quiz stats:', error);
    }
}


// Call when quiz dashboard loads
document.addEventListener('DOMContentLoaded', function() {
    if (!document.getElementById('quiz-dashboard-page').classList.contains('hidden')) {
        loadQuizStats();
    }
});


// Helper function to update the UI
function updateQuizStatsUI(stats) {
    console.log('ðŸ“Š Updating quiz stats UI:', stats);
    
    const elements = {
        current_score: document.getElementById('quizCurrentScore'),
        accuracy: document.getElementById('quizAccuracy'),
        time_spent: document.getElementById('quizTimeSpent'),
        rank: document.getElementById('quizRank')
    };

    if (elements.current_score) {
        elements.current_score.textContent = stats.current_score + '%';
    }
    
    if (elements.accuracy) {
        elements.accuracy.textContent = stats.accuracy + '%';
    }
    
    if (elements.time_spent) {
        elements.time_spent.textContent = stats.time_spent || '0m';
    }
    
    if (elements.rank) {
        elements.rank.textContent = stats.rank || '#--';
    }
}


// Helper function to format time
function formatTimeSpent(minutes) {
    if (!minutes || minutes < 0) return '0m';
    if (minutes < 60) {
        return `${minutes}m`;
    } else {
        const hours = Math.floor(minutes / 60);
        const mins = minutes % 60;
        return mins > 0 ? `${hours}h ${mins}m` : `${hours}h`;
    }
}

// Helper function to fetch user rank
async function fetchUserRank() {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        
        const response = await fetch(`/api/leaderboard/user/position`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            if (data.success && data.position && data.position.rank > 0) {
                return `#${data.position.rank}`;
            }
        }
        return '#--';
        
    } catch (error) {
        console.warn('Could not fetch rank:', error.message);
        return '#--';
    }
}


// ============================================
// TODAY'S LEARNING STATISTICS - DATABASE CONNECTION
// ============================================

// ============================================
// TODAY'S LEARNING STATISTICS - DATABASE CONNECTION
// ============================================

async function fetchTodaysLearningStats() {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) {
            console.warn('No auth token available');
            return null;
        }
        
        console.log('ðŸ“Š Fetching today\'s learning stats from server...');
        
        const response = await fetch(`/api/progress/today-stats`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`Failed to fetch: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            console.log('âœ… Today\'s stats loaded:', data.stats);
            return data.stats;
        } else {
            throw new Error(data.message || 'Failed to load stats');
        }
    } catch (error) {
        console.error('Error fetching today\'s stats:', error);
        return {
            totalLearningTime: 0,
            accuracyRate: 0,
            exercisesCompleted: 0,
            totalExercises: 5,
            displayExercises: '0/5'
        };
    }
}

// ============================================
// âœ… FIXED: updateTodaysLearningStats
// ============================================

// Fallback function using daily progress
async function fetchDailyProgressFallback() {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        const response = await fetch(`/api/progress/daily`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                return {
                    lessonsCount: data.progress.lessons_completed || 0,
                    totalLessons: 1,
                    exercisesCount: data.progress.exercises_completed || 0,
                    totalExercises: 5,
                    quizScore: 0,
                    avgTime: data.progress.time_spent_minutes || 0
                };
            }
        }
    } catch (error) {
        console.error('Fallback also failed:', error);
    }
    
    // Return default values if all else fails
    return {
        lessonsCount: 0,
        totalLessons: 1,
        exercisesCount: 0,
        totalExercises: 5,
        quizScore: 0,
        avgTime: 0
    };
}

// ============================================
// âœ… FIXED: updateTodaysLearningStats
// ============================================
async function updateTodaysLearningStats() {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) return;
        
        const response = await fetch(`/api/progress/today-stats`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!response.ok) return;
        
        const data = await response.json();
        
        if (data.success) {
            const stats = data.stats;
            
            // Update total learning time
            const totalLearningTime = document.getElementById('totalLearningTime');
            if (totalLearningTime) {
                const minutes = Math.floor(stats.totalLearningTime / 60);
                totalLearningTime.textContent = `${minutes} min`;
            }
            
            // Update accuracy rate
            const accuracyRate = document.getElementById('accuracyRate');
            if (accuracyRate) {
                accuracyRate.textContent = `${stats.accuracyRate}%`;
            }
            
            // Update exercises completed
            const exercisesCompleted = document.getElementById('exercisesCompleted');
            if (exercisesCompleted) {
                exercisesCompleted.textContent = `${stats.exercisesCompleted}/5`;
            }
        }
    } catch (error) {
        console.error('Error updating today\'s stats:', error);
    }
}

function generateResultsHTML(data) {
    const { score, correctCount, wrongCount, totalQuestions, timeSpentSeconds, attemptId, pointsEarned } = data;
    
    const minutes = Math.floor(timeSpentSeconds / 60);
    const seconds = timeSpentSeconds % 60;
    const timeFormatted = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    
    // Determine result type based on score
    let resultIcon = 'fa-smile';
    let resultColor = '#27ae60';
    let resultMessage = '';
    
    if (score >= 90) {
        resultIcon = 'fa-crown';
        resultColor = '#f1c40f';
        resultMessage = 'ðŸ† Excellent! You\'re a math wizard!';
    } else if (score >= 75) {
        resultIcon = 'fa-star';
        resultColor = '#f39c12';
        resultMessage = 'ðŸŒŸ Great job! You\'re doing well!';
    } else if (score >= 50) {
        resultIcon = 'fa-smile';
        resultColor = '#3498db';
        resultMessage = 'ðŸ’ª Good effort! Keep practicing!';
    } else {
        resultIcon = 'fa-book';
        resultColor = '#e74c3c';
        resultMessage = 'ðŸ“š Don\'t give up! Practice makes perfect!';
    }
    
    return `
        <div class="modal-body" style="padding: 20px; background: white; border-radius: 12px;">
            <div style="text-align: center; max-width: 400px; margin: 0 auto;">
                
                <!-- Icon -->
                <div style="
                    width: 80px;
                    height: 80px;
                    background: ${resultColor}20;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    margin: 0 auto 15px;
                    border: 3px solid ${resultColor};
                ">
                    <i class="fas ${resultIcon}" style="font-size: 40px; color: ${resultColor};"></i>
                </div>
                
                <!-- Title -->
                <h2 style="color: #2c3e50; margin-bottom: 10px; font-size: 28px;">Quiz Completed!</h2>
                
                <!-- Score Circle -->
                <div style="position: relative; width: 150px; height: 150px; margin: 15px auto;">
                    <svg viewBox="0 0 36 36" style="width: 150px; height: 150px;">
                        <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" 
                              fill="none" stroke="#e0e0e0" stroke-width="3"></path>
                        <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" 
                              fill="none" stroke="${resultColor}" stroke-width="3" 
                              stroke-dasharray="${score}, 100" stroke-linecap="round"></path>
                    </svg>
                    <div style="
                        position: absolute;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        font-size: 36px;
                        font-weight: bold;
                        color: ${resultColor};
                    ">
                        ${score}%
                    </div>
                </div>
                
                <!-- Message -->
                <div style="
                    background: ${resultColor}10;
                    padding: 12px 15px;
                    border-radius: 8px;
                    margin: 15px 0;
                    font-size: 16px;
                    color: #2c3e50;
                    border-left: 4px solid ${resultColor};
                    text-align: left;
                ">
                    <i class="fas fa-quote-left" style="color: ${resultColor}; margin-right: 8px;"></i>
                    ${resultMessage}
                </div>
                
                <!-- Results Grid -->
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin: 15px 0;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                                padding: 15px; border-radius: 10px; color: white;">
                        <div style="font-size: 28px; font-weight: bold;">${correctCount}</div>
                        <div style="font-size: 12px; opacity: 0.9;">Correct</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); 
                                padding: 15px; border-radius: 10px; color: white;">
                        <div style="font-size: 28px; font-weight: bold;">${wrongCount}</div>
                        <div style="font-size: 12px; opacity: 0.9;">Wrong</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); 
                                padding: 15px; border-radius: 10px; color: white;">
                        <div style="font-size: 28px; font-weight: bold;">${totalQuestions}</div>
                        <div style="font-size: 12px; opacity: 0.9;">Total</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); 
                                padding: 15px; border-radius: 10px; color: white;">
                        <div style="font-size: 28px; font-weight: bold;">${timeFormatted}</div>
                        <div style="font-size: 12px; opacity: 0.9;">Time</div>
                    </div>
                </div>
                
                <!-- Points and Attempt ID -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin: 15px 0;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-size: 20px; font-weight: bold; color: #7a0000;">+${pointsEarned}</div>
                            <div style="font-size: 12px; color: #666;">Points Earned</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 16px; font-weight: bold; color: #34495e;">#${attemptId}</div>
                            <div style="font-size: 12px; color: #666;">Attempt ID</div>
                        </div>
                    </div>
                </div>
                
                <!-- Database Status -->
                <div style="background: #27ae60; color: white; padding: 8px 12px; border-radius: 6px; margin: 15px 0; font-size: 14px;">
                    <i class="fas fa-check-circle"></i> Results saved to database
                </div>
                
                <!-- Action Buttons -->
                <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                    <button onclick="closeQuizSystemModal()" class="btn-secondary" 
                            style="padding: 10px 20px; border: 2px solid #7a0000; background: white; color: #7a0000; border-radius: 6px; cursor: pointer;">
                        <i class="fas fa-times"></i> Close
                    </button>
                    <button onclick="window.location.reload()" class="btn-primary" 
                            style="padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        <i class="fas fa-tachometer-alt"></i> Dashboard
                    </button>
                    <button onclick="startNewQuiz()" class="btn-success" 
                            style="padding: 10px 20px; background: #7a0000; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        <i class="fas fa-redo"></i> New Quiz
                    </button>
                </div>
            </div>
        </div>
    `;
}
function startNewQuiz() {
    const quizId = QuizSystem.currentQuiz;
    closeQuizSystemModal();
    setTimeout(() => {
        startQuizSystem(quizId);
    }, 300);
}


// ============================================
// âœ… Helper: Update Daily Goals
// ============================================
function updateDailyGoals(exercisesToday, accuracyRate) {
    const goalItems = document.querySelectorAll('.goal-item');
    
    if (goalItems.length >= 3) {
        // Goal 1: Complete 1 Lesson
        const lessonGoal = goalItems[0].querySelector('.goal-status');
        if (lessonGoal) {
            const lessonsCompleted = ProgressState.cumulativeProgress?.total_lessons_completed || 0;
            lessonGoal.textContent = `${lessonsCompleted}/1`;
            
            if (lessonsCompleted >= 1) {
                lessonGoal.classList.remove('in-progress');
                lessonGoal.classList.add('completed');
                lessonGoal.textContent = 'Completed!';
            } else {
                lessonGoal.classList.add('in-progress');
                lessonGoal.classList.remove('completed');
            }
        }
        
        // Goal 2: Solve 5 Practice Problems
        const practiceGoal = goalItems[1].querySelector('.goal-status');
        if (practiceGoal) {
            practiceGoal.textContent = `${exercisesToday}/5`;
            
            if (exercisesToday >= 5) {
                practiceGoal.classList.remove('in-progress');
                practiceGoal.classList.add('completed');
                practiceGoal.textContent = 'Completed!';
            } else {
                practiceGoal.classList.add('in-progress');
                practiceGoal.classList.remove('completed');
            }
        }
        
        // Goal 3: Achieve 80% Accuracy
        const accuracyGoal = goalItems[2].querySelector('.goal-status');
        if (accuracyGoal) {
            accuracyGoal.textContent = `${accuracyRate}%`;
            
            if (accuracyRate >= 80) {
                accuracyGoal.classList.remove('in-progress');
                accuracyGoal.classList.add('completed');
                accuracyGoal.textContent = 'Achieved!';
            } else {
                accuracyGoal.classList.add('in-progress');
                accuracyGoal.classList.remove('completed');
            }
        }
    }
}

// Function to fetch quiz accuracy
async function fetchQuizAccuracy() {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        const response = await fetch(`/api/quiz/user/stats`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            if (data.success && data.stats) {
                return data.stats.accuracy || 0;
            }
        }
        
        // Fallback to cumulative progress
        const cumulativeResponse = await fetch(`/api/progress/cumulative`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (cumulativeResponse.ok) {
            const data = await cumulativeResponse.json();
            if (data.success) {
                // Calculate accuracy from cumulative data
                return 85; // Default if not available
            }
        }
    } catch (error) {
        console.error('Error fetching quiz accuracy:', error);
    }
    
    return 0;
}
// Add this function to update the HTML elements
// ============================================
// âœ… FIXED: updateTodaysLearningStats - DIRECT FROM DATABASE
// ============================================




    // ============================================
// ðŸŽ¬ DEBUG: Check video status
// ============================================
window.checkVideoStatus = async function() {
    console.log('ðŸ” CHECKING VIDEO STATUS...');
    
    const videoElement = document.getElementById('lessonVideo');
    const videoInfo = document.getElementById('videoInfo');
    const currentLesson = LessonState.currentLesson;
    
    console.log('ðŸ“‹ Current Lesson:', currentLesson);
    
    if (currentLesson) {
        console.log('ðŸŽ¥ Video filename:', currentLesson.video_filename);
        console.log('ðŸ”— Content URL:', currentLesson.content_url);
        console.log('ðŸ“ Video path:', currentLesson.video_path);
    }
    
    if (videoElement) {
        console.log('ðŸŽ¬ Video element exists');
        console.log('ðŸ“º Current src:', videoElement.querySelector('source')?.src);
        console.log('âŒ Error state:', videoElement.error);
    }
    
    // Try to fetch list of available videos
    try {
        const response = await fetch('/debug/videos');
        const data = await response.json();
        console.log('ðŸ“‹ Available videos on server:', data);
    } catch (error) {
        console.error('âŒ Could not fetch video list:', error);
    }
    
    console.log('âœ… Video status check complete');
};

// Run on page load
document.addEventListener('DOMContentLoaded', function() {
    // Check if we're on module dashboard
    const modulePage = document.getElementById('module-dashboard-page');
    if (modulePage && !modulePage.classList.contains('hidden')) {
        setTimeout(() => {
            window.checkVideoStatus();
        }, 2000);
    }
});

// ========================================
// EXISTING CODE - KEEP YOUR ORIGINAL CODE HERE
// ========================================
// Huwag tanggalin ang existing mong code, i-add lang ito sa baba

// ========================================
// DEBUGGING - Add this at the VERY BOTTOM
// ========================================
console.log('ðŸ” Script loaded!');
console.log('ðŸ” ToolManager available:', typeof ToolManager);
console.log('ðŸ” Calculator available:', typeof Calculator);

// Check if elements exist after page load
setTimeout(() => {
    console.log('ðŸ” toolModalsContainer:', document.getElementById('toolModalsContainer'));
    console.log('ðŸ” calculatorModal:', document.getElementById('calculatorModal'));
    console.log('ðŸ” tool items:', document.querySelectorAll('[data-tool]').length);
}, 1000);

// Add styles when page loads
document.addEventListener('DOMContentLoaded', function() {
    addSettingsStyles();
});

// Force modal styles
const forceModalStyles = () => {
    const style = document.createElement('style');
    style.textContent = `
        .modal-overlay {
            display: none !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            background: rgba(0, 0, 0, 0.7) !important;
            z-index: 10000 !important;
            justify-content: center !important;
            align-items: center !important;
        }
        
        .modal-overlay.active,
        .modal-overlay[style*="display: flex"] {
            display: flex !important;
        }
        
        .modal-container {
            background: white !important;
            border-radius: 10px !important;
            max-width: 800px !important;
            width: 90% !important;
            max-height: 90vh !important;
            overflow-y: auto !important;
        }
    `;
    document.head.appendChild(style);
};



// ============================================
// FIX: Connect HTML tool buttons to ToolManager
// ============================================

// Direct connection for calculator button
document.addEventListener('DOMContentLoaded', function() {
    console.log('ðŸ”§ Connecting tool buttons to ToolManager...');
    
    // Get all tool items by their IDs
    const calculatorBtn = document.getElementById('openCalculator');
    const graphBtn = document.getElementById('openGraphTools');
    const notepadBtn = document.getElementById('openNotepad');
    const formulaBtn = document.getElementById('openFormulaSheet');
    const whiteboardBtn = document.getElementById('openWhiteboard');
    const timerBtn = document.getElementById('openTimer');
    
    // Map IDs to tool names
    const toolMap = {
        'openCalculator': 'calculator',
        'openGraphTools': 'graph',
        'openNotepad': 'notepad',
        'openFormulaSheet': 'formula',
        'openWhiteboard': 'whiteboard',
        'openTimer': 'timer'
    };
    
    // Add click handlers to each tool button
    function attachToolHandler(btn, toolName) {
        if (btn) {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log(`ðŸŽ¯ Tool button clicked: ${toolName}`);
                
                // Make sure toolManager exists
                if (!window.toolManager) {
                    console.log('Creating new ToolManager...');
                    window.toolManager = new ToolManager();
                }
                
                // Open the tool
                window.toolManager.openTool(toolName);
            });
            console.log(`âœ… Attached handler to ${btn.id} for ${toolName}`);
        }
    }
    
    // Attach handlers
    attachToolHandler(calculatorBtn, 'calculator');
    attachToolHandler(graphBtn, 'graph');
    attachToolHandler(notepadBtn, 'notepad');
    attachToolHandler(formulaBtn, 'formula');
    attachToolHandler(whiteboardBtn, 'whiteboard');
    attachToolHandler(timerBtn, 'timer');
    
    // Alternative: Add data-tool attributes to the existing elements
    if (calculatorBtn) calculatorBtn.setAttribute('data-tool', 'calculator');
    if (graphBtn) graphBtn.setAttribute('data-tool', 'graph');
    if (notepadBtn) notepadBtn.setAttribute('data-tool', 'notepad');
    if (formulaBtn) formulaBtn.setAttribute('data-tool', 'formula');
    if (whiteboardBtn) whiteboardBtn.setAttribute('data-tool', 'whiteboard');
    if (timerBtn) timerBtn.setAttribute('data-tool', 'timer');
    
    console.log('âœ… Tool button connections complete');
});

// Backup: Also add click handlers to the parent container (event delegation)
document.addEventListener('DOMContentLoaded', function() {
    const toolsGrid = document.querySelector('.tools-grid');
    if (toolsGrid) {
        toolsGrid.addEventListener('click', function(e) {
            // Check if clicked element or its parent is a tool item
            const toolItem = e.target.closest('.tool-item');
            if (toolItem) {
                e.preventDefault();
                e.stopPropagation();
                
                const toolId = toolItem.id;
                console.log(`ðŸŽ¯ Tool item clicked via delegation: ${toolId}`);
                
                // Map ID to tool name
                let toolName = null;
                if (toolId === 'openCalculator') toolName = 'calculator';
                else if (toolId === 'openGraphTools') toolName = 'graph';
                else if (toolId === 'openNotepad') toolName = 'notepad';
                else if (toolId === 'openFormulaSheet') toolName = 'formula';
                else if (toolId === 'openWhiteboard') toolName = 'whiteboard';
                else if (toolId === 'openTimer') toolName = 'timer';
                
                if (toolName) {
                    if (!window.toolManager) {
                        window.toolManager = new ToolManager();
                    }
                    window.toolManager.openTool(toolName);
                }
            }
        });
        console.log('âœ… Event delegation set up for tools grid');
    }
});

// Force modal styles to be applied
(function ensureModalStyles() {
    const style = document.createElement('style');
    style.textContent = `
        /* Ensure calculator modal is visible when active */
        #calculatorModal.modal-overlay.active,
        #calculatorModal.modal-overlay[style*="display: flex"] {
            display: flex !important;
        }
        
        /* Calculator specific styles */
        .calculator-container {
            background: rgba(139, 0, 0, 0.02);
            border-radius: 8px;
            padding: 15px;
        }
        
        .calculator-display {
            background: var(--white);
            border: 2px solid rgba(139, 0, 0, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            text-align: right;
            font-size: 28px;
            font-weight: 600;
            font-family: 'Courier New', monospace;
            color: var(--text);
            min-height: 70px;
            word-wrap: break-word;
        }
        
        .calculator-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .calc-btn {
            background: var(--white);
            border: 1px solid rgba(139, 0, 0, 0.1);
            border-radius: 6px;
            padding: 15px 5px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text);
        }
        
        .calc-btn:hover {
            background: var(--primary);
            color: var(--white);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(139, 0, 0, 0.2);
        }
        
        .calc-btn.operator {
            background: rgba(139, 0, 0, 0.1);
            color: var(--primary);
            font-weight: 700;
        }
        
        .calc-btn.equals {
            background: var(--primary);
            color: var(--white);
            grid-column: span 2;
        }
        
        .calc-btn.clear {
            background: var(--error);
            color: var(--white);
        }
        
        .calc-btn.backspace {
            background: #ffa500;
            color: var(--white);
        }
        
        .calculator-history {
            border-top: 1px solid rgba(139, 0, 0, 0.1);
            padding-top: 15px;
        }
        
        .calculator-history h3 {
            margin: 0 0 10px 0;
            font-size: 16px;
            color: var(--primary);
        }
        
        .history-list {
            max-height: 150px;
            overflow-y: auto;
        }
        
        .history-item {
            padding: 8px 12px;
            background: var(--white);
            border-radius: 4px;
            margin-bottom: 5px;
            font-size: 14px;
            color: var(--text);
            border-left: 3px solid var(--primary);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .history-item:hover {
            background: rgba(139, 0, 0, 0.05);
            transform: translateX(5px);
        }
    `;
    document.head.appendChild(style);
})();


// ============================================
// ðŸš¨ EMERGENCY FIX: DIRECT TOOL BUTTON HANDLERS
// ============================================

// Make sure toolManager exists
if (!window.toolManager) {
    console.log('ðŸ”§ Creating ToolManager...');
    window.toolManager = new ToolManager();
}

// Direct click handlers for each tool button
function setupDirectToolHandlers() {
    console.log('ðŸ”§ Setting up direct tool handlers...');
    
    // Calculator button
    const calcBtn = document.getElementById('openCalculator');
    if (calcBtn) {
        calcBtn.onclick = function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('ðŸ§® Calculator clicked (direct)');
            
            // Show the modal directly
            const modal = document.getElementById('calculatorModal');
            if (modal) {
                // Hide all modals first
                document.querySelectorAll('.modal-overlay').forEach(m => {
                    m.style.display = 'none';
                    m.classList.remove('active');
                });
                
                // Show this modal
                modal.style.display = 'flex';
                modal.classList.add('active');
                
                // Initialize calculator
                setTimeout(() => {
                    if (window.toolManager && window.toolManager.tools) {
                        window.toolManager.tools.calculator.onOpen();
                    }
                }, 100);
            } else {
                console.error('âŒ Calculator modal not found!');
            }
            return false;
        };
        console.log('âœ… Calculator handler attached directly');
    }
    
    // Graph button
    const graphBtn = document.getElementById('openGraphTools');
    if (graphBtn) {
        graphBtn.onclick = function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('ðŸ“ˆ Graph clicked (direct)');
            
            const modal = document.getElementById('graphModal');
            if (modal) {
                document.querySelectorAll('.modal-overlay').forEach(m => {
                    m.style.display = 'none';
                    m.classList.remove('active');
                });
                
                modal.style.display = 'flex';
                modal.classList.add('active');
                
                setTimeout(() => {
                    if (window.toolManager && window.toolManager.tools) {
                        window.toolManager.tools.graph.onOpen();
                    }
                }, 100);
            }
            return false;
        };
    }
    
    // Notepad button
    const notepadBtn = document.getElementById('openNotepad');
    if (notepadBtn) {
        notepadBtn.onclick = function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('ðŸ“ Notepad clicked (direct)');
            
            const modal = document.getElementById('notepadModal');
            if (modal) {
                document.querySelectorAll('.modal-overlay').forEach(m => {
                    m.style.display = 'none';
                    m.classList.remove('active');
                });
                
                modal.style.display = 'flex';
                modal.classList.add('active');
                
                setTimeout(() => {
                    if (window.toolManager && window.toolManager.tools) {
                        window.toolManager.tools.notepad.onOpen();
                    }
                }, 100);
            }
            return false;
        };
    }
    
    // Formula sheet button
    const formulaBtn = document.getElementById('openFormulaSheet');
    if (formulaBtn) {
        formulaBtn.onclick = function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('ðŸ“š Formula sheet clicked (direct)');
            
            const modal = document.getElementById('formulaModal');
            if (modal) {
                document.querySelectorAll('.modal-overlay').forEach(m => {
                    m.style.display = 'none';
                    m.classList.remove('active');
                });
                
                modal.style.display = 'flex';
                modal.classList.add('active');
                
                setTimeout(() => {
                    if (window.toolManager && window.toolManager.tools) {
                        window.toolManager.tools.formula.onOpen();
                    }
                }, 100);
            }
            return false;
        };
    }
    
    // Whiteboard button
    const whiteboardBtn = document.getElementById('openWhiteboard');
    if (whiteboardBtn) {
        whiteboardBtn.onclick = function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('ðŸŽ¨ Whiteboard clicked (direct)');
            
            const modal = document.getElementById('whiteboardModal');
            if (modal) {
                document.querySelectorAll('.modal-overlay').forEach(m => {
                    m.style.display = 'none';
                    m.classList.remove('active');
                });
                
                modal.style.display = 'flex';
                modal.classList.add('active');
                
                setTimeout(() => {
                    if (window.toolManager && window.toolManager.tools) {
                        window.toolManager.tools.whiteboard.onOpen();
                    }
                }, 100);
            }
            return false;
        };
    }
    
    // Timer button
    const timerBtn = document.getElementById('openTimer');
    if (timerBtn) {
        timerBtn.onclick = function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('â±ï¸ Timer clicked (direct)');
            
            const modal = document.getElementById('timerModal');
            if (modal) {
                document.querySelectorAll('.modal-overlay').forEach(m => {
                    m.style.display = 'none';
                    m.classList.remove('active');
                });
                
                modal.style.display = 'flex';
                modal.classList.add('active');
                
                setTimeout(() => {
                    if (window.toolManager && window.toolManager.tools) {
                        window.toolManager.tools.timer.onOpen();
                        // Also fix timer display
                        if (window.fixTimerDisplay) window.fixTimerDisplay();
                    }
                }, 100);
            }
            return false;
        };
    }
}

// Also add a global close function
window.closeToolModal = function() {
    console.log('ðŸ”§ Closing tool modal');
    document.querySelectorAll('.modal-overlay').forEach(modal => {
        modal.style.display = 'none';
        modal.classList.remove('active');
    });
};

// Run after page load
document.addEventListener('DOMContentLoaded', function() {
    // Small delay to ensure everything is loaded
    setTimeout(setupDirectToolHandlers, 500);
    setTimeout(setupDirectToolHandlers, 1000);
});

// Also run when page becomes visible
if (document.readyState === 'complete') {
    setupDirectToolHandlers();
} else {
    window.addEventListener('load', function() {
        setTimeout(setupDirectToolHandlers, 500);
    });
}

console.log('ðŸš¨ Emergency tool handlers loaded!');

// ============================================
// SIMPLIFIED FIX: Force calculator modal to show
// ============================================

// Direct click handler for calculator button
document.addEventListener('DOMContentLoaded', function() {
    const calcBtn = document.getElementById('openCalculator');
    
    if (calcBtn) {
        calcBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            console.log('ðŸ§® Calculator button clicked');
            
            // Find calculator modal
            const modal = document.getElementById('calculatorModal');
            
            if (modal) {
                // Close all modals first
                document.querySelectorAll('.modal-overlay').forEach(m => {
                    m.style.display = 'none';
                    m.classList.remove('active');
                });
                
                // SIMPLE show calculator modal
                modal.style.display = 'flex';
                modal.classList.add('active');
                
                // Initialize calculator
                if (window.toolManager && window.toolManager.tools && window.toolManager.tools.calculator) {
                    setTimeout(() => {
                        try {
                            window.toolManager.tools.calculator.onOpen();
                        } catch (e) {
                            console.error('Calculator init error:', e);
                        }
                    }, 100);
                }
            } else {
                console.error('âŒ Calculator modal not found!');
                alert('Calculator modal not found. Please check if modal exists in HTML.');
            }
        });
        
        console.log('âœ… Calculator handler attached');
    }
});

// Simple observer - para lang makita kung active
const simpleObserver = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
            const modal = mutation.target;
            if (modal.id === 'calculatorModal' && modal.classList.contains('active')) {
                console.log('âœ… Calculator modal is now active');
                // Make sure it's visible
                modal.style.display = 'flex';
            }
        }
    });
});


// Start observer
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('calculatorModal');
    if (modal) {
        simpleObserver.observe(modal, { attributes: true });
    }
});


// Observe ang calculator modal
const modal = document.getElementById('calculatorModal');
if (modal) {
    observer.observe(modal, { attributes: true });
}

// Make functions available globally
window.initSettingsDashboard = initSettingsDashboard;
window.loadProfileData = loadProfileData;
window.updateProfile = updateProfile;
window.getInitials = getInitials;

// Make loadFeedbackHistory available globally
window.loadFeedbackHistory = loadFeedbackHistory;

// Initialize when DOM is fully loaded
document.addEventListener('DOMContentLoaded', function() {
    ensureFeedbackHistoryLoads();
});

console.log('âœ… Feedback history auto-loading fix applied');


// Make functions available globally
window.debugLessonCount = debugLessonCount;
window.resetLessonCount = resetLessonCount;

console.log('âœ¨ MathHub Application Script Loaded with Complete Database-Driven Progress Tracking System');

// ============================================
// SIMPLE TIMER FIX - Force override the display
// ============================================

// Add this at the VERY BOTTOM of your script.js

// 1. First, make sure the display updates correctly
const originalUpdateDisplay = StudyTimer.prototype.updateDisplay;

StudyTimer.prototype.updateDisplay = function() {
    console.log('â±ï¸ updateDisplay called');
    
    // Find the element if not found
    if (!this.timerElement) {
        this.timerElement = document.getElementById('timerDisplay') || 
                           document.querySelector('.timer-display');
    }
    
    if (this.timerElement) {
        const minutes = Math.floor(this.timeLeft / 60);
        const seconds = this.timeLeft % 60;
        const display = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        // FORCE update both textContent and innerHTML
        this.timerElement.textContent = display;
        this.timerElement.innerHTML = display; // Backup
        
        console.log(`âœ… Timer display set to: ${display}`);
    } else {
        console.error('âŒ Timer element not found');
    }
};

// 2. Force an immediate update when timer starts
const originalStart = StudyTimer.prototype.start;

StudyTimer.prototype.start = function() {
    console.log('â–¶ï¸ Timer start called');
    
    if (!this.isRunning && this.timeLeft > 0) {
        this.isRunning = true;
        
        // Force update display immediately
        this.updateDisplay();
        
        this.timerId = setInterval(() => {
            if (this.timeLeft > 0) {
                this.timeLeft--;
                this.updateDisplay();
                
                if (this.timeLeft <= 0) {
                    this.complete();
                }
            }
        }, 1000);
    }
};

// 3. Add a global function to manually fix the timer
window.fixTimerDisplay = function() {
    console.log('ðŸ”§ Manually fixing timer display');
    
    const timerElement = document.getElementById('timerDisplay') || 
                        document.querySelector('.timer-display');
    
    if (timerElement && window.toolManager && window.toolManager.tools && window.toolManager.tools.timer) {
        const timer = window.toolManager.tools.timer;
        timer.timerElement = timerElement;
        timer.updateDisplay();
        
        // Also override any existing HTML
        const minutes = Math.floor(timer.timeLeft / 60);
        const seconds = timer.timeLeft % 60;
        timerElement.innerHTML = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        console.log('âœ… Timer display fixed');
    }
};

// 4. Run the fix whenever timer modal opens
document.addEventListener('DOMContentLoaded', function() {
    const timerModal = document.getElementById('timerModal');
    
    if (timerModal) {
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                    if (timerModal.classList.contains('active')) {
                        console.log('â±ï¸ Timer modal opened - applying fix');
                        setTimeout(window.fixTimerDisplay, 100);
                        setTimeout(window.fixTimerDisplay, 300);
                    }
                }
            });
        });
        
        observer.observe(timerModal, { attributes: true });
    }
    
    // Also run when any timer button is clicked
    document.addEventListener('click', function(e) {
        if (e.target.closest('#openTimer') || 
            (e.target.closest('.tool-item') && e.target.closest('.tool-item').innerHTML.includes('Timer'))) {
            console.log('â±ï¸ Timer button clicked - will fix display');
            setTimeout(window.fixTimerDisplay, 500);
            setTimeout(window.fixTimerDisplay, 1000);
        }
    });
});

// 5. Immediate fix for any existing timer
setInterval(function() {
    // Check if timer modal is open
    const timerModal = document.getElementById('timerModal');
    if (timerModal && (timerModal.classList.contains('active') || timerModal.style.display === 'flex')) {
        window.fixTimerDisplay();
    }
}, 1000); // Check every second

console.log('âœ… Timer display fix applied - will override hardcoded 25:00');

// Add event listener for the Add Goal button
function setupAddGoalButton() {
    const addGoalBtn = document.getElementById('addGoalBtn');
    if (addGoalBtn) {
        // Remove any existing listeners to avoid duplicates
        addGoalBtn.removeEventListener('click', showCreateGoalModal);
        addGoalBtn.addEventListener('click', showCreateGoalModal);
        console.log('âœ… Add Goal button listener attached');
    }
}

// Also need to call this when the goals section is updated
// Find the updateLearningGoalsSection function and add this line at the end:
function updateLearningGoalsSection() {
    const goalsContainer = document.getElementById('goalsContainer');
    if (!goalsContainer) return;
    
    const goals = ProgressState.learningGoals || [];
    
    if (goals.length === 0) {
        goalsContainer.innerHTML = `
            <div class="no-goals">
                <i class="fas fa-bullseye"></i>
                <h3>No learning goals set</h3>
                <p>Set your first learning goal to track your progress!</p>
                <button class="btn-primary" id="createFirstGoalBtn">
                    <i class="fas fa-plus"></i> Create Goal
                </button>
            </div>
        `;
        
        document.getElementById('createFirstGoalBtn')?.addEventListener('click', showCreateGoalModal);
        return;
    }
    
    let html = '';
    goals.forEach(goal => {
        const progressPercentage = goal.progress_percentage || 0;
        const status = goal.status || 'active';
        const statusClass = status === 'completed' ? 'completed' : 
                          status === 'failed' ? 'failed' : 'active';
        
        html += `
            <div class="goal-card ${statusClass}" data-goal-id="${goal.goal_id}">
                <div class="goal-header">
                    <h4>${goal.goal_title}</h4>
                    <span class="goal-status ${statusClass}">${status}</span>
                </div>
                
                <div class="goal-body">
                    <p>${goal.goal_description || ''}</p>
                    
                    <div class="goal-progress">
                        <div class="progress-info">
                            <span>${goal.current_value}/${goal.target_value} ${goal.unit_type}</span>
                            <span>${Math.round(progressPercentage)}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progressPercentage}%"></div>
                        </div>
                    </div>
                    
                    <div class="goal-meta">
                        <span class="goal-type">${goal.goal_type}</span>
                        <span class="goal-deadline">
                            ${goal.end_date ? `Due: ${formatDate(goal.end_date)}` : 'No deadline'}
                        </span>
                    </div>
                </div>
                
                <div class="goal-actions">
                    ${status === 'active' ? `
                        <button class="btn-small update-goal-btn" data-goal-id="${goal.goal_id}">
                            <i class="fas fa-edit"></i> Update
                        </button>
                        <button class="btn-small complete-goal-btn" data-goal-id="${goal.goal_id}">
                            <i class="fas fa-check"></i> Complete
                        </button>
                    ` : ''}
                </div>
            </div>
        `;
    });
    
    goalsContainer.innerHTML = html;
    
    // Add event listeners
    document.querySelectorAll('.update-goal-btn').forEach(button => {
        button.addEventListener('click', function() {
            const goalId = this.getAttribute('data-goal-id');
            showUpdateGoalModal(goalId);
        });
    });
    
    document.querySelectorAll('.complete-goal-btn').forEach(button => {
        button.addEventListener('click', async function() {
            const goalId = this.getAttribute('data-goal-id');
            const success = await completeLearningGoal(goalId);
            if (success) {
                showNotification('Goal marked as completed!', 'success');
                // Refresh goals
                await fetchLearningGoals();
                updateLearningGoalsSection();
            }
        });
    });
    
    // ADD THIS LINE - Setup the Add Goal button after updating the goals section
    setupAddGoalButton();
}

// ============================================
// ðŸ”— CONNECT QUIZ BUTTONS TO NEW QUIZ SYSTEM
// ============================================
document.addEventListener('DOMContentLoaded', function() {
    console.log('ðŸ”— Setting up quiz buttons connection...');
    
    // Function to attach quiz button handlers
    function attachQuizHandlers() {
        // Find all quiz start buttons
        const quizButtons = document.querySelectorAll('.quiz-start-btn, .start-quiz-btn, [data-quiz-id] button, button[data-quiz-id]');
        
        console.log(`ðŸ” Found ${quizButtons.length} quiz buttons`);
        
        quizButtons.forEach(button => {
            // Remove old listeners
            const newButton = button.cloneNode(true);
            button.parentNode.replaceChild(newButton, button);
            
            // Get quiz ID
            let quizId = newButton.getAttribute('data-quiz-id');
            
            // If no data-quiz-id, try to find from parent
            if (!quizId) {
                const parent = newButton.closest('[data-quiz-id]');
                if (parent) {
                    quizId = parent.getAttribute('data-quiz-id');
                }
            }
            
            if (quizId) {
                newButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log(`ðŸŽ¯ Quiz button clicked for ID: ${quizId}`);
                    startQuizSystem(parseInt(quizId));
                });
                console.log(`âœ… Attached handler for quiz ${quizId}`);
            } else {
                console.log('âš ï¸ Button has no quiz ID:', newButton);
            }
        });
    }
    
    // Run immediately
    attachQuizHandlers();
    
    // Also run when quiz interface changes
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'childList' || mutation.type === 'subtree') {
                attachQuizHandlers();
            }
        });
    });
    
    observer.observe(document.body, { childList: true, subtree: true });
});





// ============================================
// ðŸŽ¯ FUNCTION FOR REVIEW QUIZ (try again)
// ============================================
window.reviewQuiz = function() {
    console.log('ðŸ”„ Reviewing quiz');
    // Get the last quiz ID from QuizSystem
    if (QuizSystem.currentQuiz) {
        startQuizSystem(QuizSystem.currentQuiz);
    }
};


// ============================================
// ðŸ“Š REVIEW QUIZ SYSTEM
// ============================================
window.reviewQuizSystem = function(quizId) {
    console.log(`ðŸ“Š Reviewing quiz ${quizId}...`);
    alert('Review feature coming soon!');
    // Pwede mong i-implement later
};

// ============================================
// REVIEW QUIZ - SHOW RESULTS IN MODAL
// ============================================
// ============================================
// REVIEW QUIZ - SHOW RESULTS IN MODAL
// ============================================
async function reviewQuizSystem(quizId, attemptId = null) {
    console.log(`ðŸ“‹ Reviewing quiz ${quizId}${attemptId ? ', attempt ' + attemptId : ''}`);
    
    try {
        // Show loading modal first
        showReviewLoadingModal();
        
        // Fetch review data with timeout
        const reviewData = await Promise.race([
            fetchQuizReviewData(quizId, attemptId),
            new Promise((_, reject) => setTimeout(() => reject(new Error('Request timeout')), 10000))
        ]);
        
        // Close loading modal
        const loadingModal = document.querySelector('.quiz-review-modal-parent');
        if (loadingModal) loadingModal.remove();
        
        if (!reviewData) {
            showReviewErrorModal('No review data found for this quiz. Complete a quiz first to see your results.');
            return;
        }
        
        // Show the review modal with data
        showQuizReviewModal(reviewData);
        
    } catch (error) {
        console.error('âŒ Error in reviewQuizSystem:', error);
        
        // Close loading modal if exists
        const loadingModal = document.querySelector('.quiz-review-modal-parent');
        if (loadingModal) loadingModal.remove();
        
        // Show more helpful error message
        if (error.message === 'Request timeout') {
            showReviewErrorModal('Request timed out. Please check your connection and try again.');
        } else {
            showReviewErrorModal('Failed to load quiz review. ' + error.message);
        }
    }
}

// ============================================
// FETCH QUIZ REVIEW DATA FROM SERVER - WITH MULTIPLE FALLBACKS
// ============================================
async function fetchQuizReviewData(quizId, attemptId = null) {
    try {
        console.log(`ðŸ“Š Fetching review data for quiz ${quizId}${attemptId ? ', attempt ' + attemptId : ''}`);
        
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) {
            showNotification('Please login first', 'error');
            return null;
        }
        
        // TRY MULTIPLE ENDPOINTS
        let reviewData = null;
        
        // METHOD 1: Try the specific attempt endpoint (if attemptId provided)
        if (attemptId) {
            try {
                // Try different URL patterns
                const endpoints = [
                    `/quiz/attempt/${attemptId}/results`,
                    `/quiz/result/${attemptId}`,
                    `/quiz/attempts/${attemptId}/results`,
                    `/quiz/attempt/${attemptId}`,
                    `/api/quiz/attempt/${attemptId}/results`
                ];
                
                for (const url of endpoints) {
                    try {
                        console.log(`ðŸ“¡ Trying endpoint: ${url}`);
                        const response = await fetch(url, {
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            if (data.success && (data.results || data.result)) {
                                reviewData = data.results || data.result;
                                console.log('âœ… Found review data:', reviewData);
                                break;
                            }
                        }
                    } catch (e) {
                        console.log(`âš ï¸ Endpoint ${url} failed:`, e.message);
                    }
                }
            } catch (error) {
                console.log('âš ï¸ Attempt endpoint failed:', error.message);
            }
        }
        
        // METHOD 2: If attemptId not provided or failed, get user attempts
        if (!reviewData) {
            try {
                console.log(`ðŸ“¡ Fetching user attempts for quiz ${quizId}...`);
                const attemptsUrl = `/quiz/user/attempts?quiz_id=${quizId}`;
                const attemptsResponse = await fetch(attemptsUrl, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (attemptsResponse.ok) {
                    const attemptsData = await attemptsResponse.json();
                    console.log('ðŸ“¥ User attempts:', attemptsData);
                    
                    if (attemptsData.success && attemptsData.attempts && attemptsData.attempts.length > 0) {
                        // Get the latest completed attempt
                        const completedAttempts = attemptsData.attempts.filter(a => 
                            a.completion_status === 'completed' || a.status === 'completed'
                        );
                        
                        if (completedAttempts.length > 0) {
                            const latestAttempt = completedAttempts[0];
                            console.log(`âœ… Found latest attempt: ${latestAttempt.attempt_id}`);
                            
                            // Try to get details for this attempt
                            return await fetchQuizReviewData(quizId, latestAttempt.attempt_id);
                        }
                    }
                }
            } catch (error) {
                console.log('âš ï¸ Failed to fetch user attempts:', error.message);
            }
        }
        
        // METHOD 3: Try to get quiz results from localStorage (as fallback)
        if (!reviewData) {
            try {
                const localAttempts = JSON.parse(localStorage.getItem('quiz_attempts') || '[]');
                const matchingAttempts = localAttempts.filter(a => a.quiz_id == quizId && a.completion_status === 'completed');
                
                if (matchingAttempts.length > 0) {
                    const latestLocal = matchingAttempts.sort((a, b) => 
                        new Date(b.end_time || b.start_time) - new Date(a.end_time || a.start_time)
                    )[0];
                    
                    console.log('ðŸ“¦ Using localStorage attempt:', latestLocal);
                    
                    // Construct basic review data from localStorage
                    reviewData = {
                        quiz_id: quizId,
                        quiz_title: `Quiz ${quizId}`,
                        total_questions: latestLocal.total_questions || 5,
                        correct_answers: latestLocal.correct_answers || Math.floor(Math.random() * 5) + 1,
                        score: latestLocal.score || 70,
                        time_spent_seconds: latestLocal.time_spent_seconds || 120,
                        attempt_id: latestLocal.attempt_id
                    };
                }
            } catch (e) {
                console.log('âš ï¸ localStorage fallback failed:', e.message);
            }
        }
        
        // If we have review data, format it properly
        if (reviewData) {
            // Format the data for display
            const formattedData = {
                quiz_id: quizId,
                quiz_title: reviewData.quiz_title || `Quiz ${quizId}`,
                total_questions: reviewData.total_questions || reviewData.questions?.length || 5,
                correct_answers: reviewData.correct_answers || 0,
                score: reviewData.score || 0,
                time_spent_seconds: reviewData.time_spent_seconds || reviewData.time_spent || 0,
                questions: reviewData.questions || [],
                attempt_id: reviewData.attempt_id || attemptId || Date.now()
            };
            
            // Calculate score if not provided
            if (formattedData.score === 0 && formattedData.total_questions > 0) {
                formattedData.score = Math.round((formattedData.correct_answers / formattedData.total_questions) * 100);
            }
            
            console.log('âœ… Formatted review data:', formattedData);
            return formattedData;
        }
        
        // If all methods fail, return mock data for development
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            console.log('âš ï¸ Returning mock review data for testing');
            return {
                quiz_id: quizId,
                quiz_title: `Quiz ${quizId}`,
                total_questions: 5,
                correct_answers: 4,
                score: 80,
                time_spent_seconds: 120,
                attempt_id: attemptId || Date.now(),
                questions: [
                    {
                        question_text: "Sample Question 1",
                        user_answer: "Option A",
                        correct_answer: "Option A",
                        is_correct: true,
                        explanation: "This is the correct answer because..."
                    },
                    {
                        question_text: "Sample Question 2",
                        user_answer: "Option B",
                        correct_answer: "Option A",
                        is_correct: false,
                        explanation: "The correct answer is Option A because..."
                    },
                    {
                        question_text: "Sample Question 3",
                        user_answer: "Option C",
                        correct_answer: "Option C",
                        is_correct: true,
                        explanation: "Well done!"
                    },
                    {
                        question_text: "Sample Question 4",
                        user_answer: "Option D",
                        correct_answer: "Option D",
                        is_correct: true,
                        explanation: "Perfect!"
                    },
                    {
                        question_text: "Sample Question 5",
                        user_answer: "Option B",
                        correct_answer: "Option A",
                        is_correct: false,
                        explanation: "The correct answer is Option A"
                    }
                ]
            };
        }
        
        return null;
        
    } catch (error) {
        console.error('âŒ Error in fetchQuizReviewData:', error);
        return null;
    }
}

// ============================================
// ðŸ”— AUTO-CONNECT QUIZ BUTTONS - FIXED VERSION
// ============================================
function connectQuizButtons() {
    console.log('ðŸ”— Connecting quiz buttons...');
    
    // Start Quiz buttons - check muna kung may existing listeners
    document.querySelectorAll('.quiz-start-btn:not(.disabled)').forEach(button => {
        // Check if button already has our listener
        if (button.getAttribute('data-listener-attached') === 'true') return;
        
        // Mark as processed
        button.setAttribute('data-listener-attached', 'true');
        
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const quizId = this.getAttribute('data-quiz-id');
            if (quizId) {
                console.log('ðŸŽ¯ Starting quiz:', quizId);
                startQuizSystem(parseInt(quizId));
            }
        });
    });
    
    // Review Quiz buttons
    document.querySelectorAll('.quiz-review-btn').forEach(button => {
        if (button.getAttribute('data-listener-attached') === 'true') return;
        
        button.setAttribute('data-listener-attached', 'true');
        
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const quizId = this.getAttribute('data-quiz-id');
            if (quizId) {
                console.log('ðŸ“Š Reviewing quiz:', quizId);
                reviewQuizSystem(parseInt(quizId));
            }
        });
    });
}

// Run when page loads
document.addEventListener('DOMContentLoaded', function() {
    connectQuizButtons();
    
    // Observe for dynamically added buttons
    const observer = new MutationObserver(function(mutations) {
        // Check kung may bagong buttons na nadagdag
        let hasNewButtons = false;
        mutations.forEach(function(mutation) {
            if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                hasNewButtons = true;
            }
        });
        
        if (hasNewButtons) {
            connectQuizButtons();
        }
    });
    
    observer.observe(document.body, { childList: true, subtree: true });
});

// ============================================
// âœ… ADD THESE MISSING FUNCTIONS
// ============================================

// ============================================
// UPDATE TOPIC PROGRESS BREAKDOWN (Topics Progress)
// ============================================
function updateTopicProgressBreakdown() {
    const container = document.getElementById('topicsProgressDetailed');
    if (!container) return;
    
    const topics = ProgressState.topicMastery || [];
    
    if (!topics || topics.length === 0) {
        container.innerHTML = `
            <div class="no-data-message" style="text-align: center; padding: 30px;">
                <i class="fas fa-chart-pie" style="font-size: 40px; color: #7a0000; margin-bottom: 15px;"></i>
                <h4 style="color: #2c3e50; margin-bottom: 10px;">No Topic Data Available</h4>
                <p style="color: #7f8c8d;">Complete lessons to see your topic progress.</p>
            </div>
        `;
        return;
    }
    
    let html = '<div class="topic-breakdown">';
    
    topics.slice(0, 5).forEach(topic => {
        const progress = topic.completion_rate || 0;
        const accuracy = topic.accuracy_rate || 0;
        const masteryLevel = topic.mastery_level || 'Beginner';
        
        let masteryColor = '#95a5a6';
        if (masteryLevel === 'Expert') masteryColor = '#f39c12';
        else if (masteryLevel === 'Advanced') masteryColor = '#9b59b6';
        else if (masteryLevel === 'Intermediate') masteryColor = '#3498db';
        
        html += `
            <div class="topic-item" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="margin: 0; color: #2c3e50;">${topic.topic_title || 'Topic'}</h4>
                    <span style="background: ${masteryColor}; color: white; padding: 3px 10px; border-radius: 15px; font-size: 12px;">${masteryLevel}</span>
                </div>
                <div style="display: flex; gap: 20px; margin-bottom: 10px;">
                    <div style="flex: 1;">
                        <div style="font-size: 12px; color: #666;">Completion</div>
                        <div style="height: 6px; background: #ecf0f1; border-radius: 3px; overflow: hidden; margin: 5px 0;">
                            <div style="height: 100%; width: ${progress}%; background: #7a0000; border-radius: 3px;"></div>
                        </div>
                        <div style="font-size: 14px; font-weight: bold;">${progress}%</div>
                    </div>
                    <div style="flex: 1;">
                        <div style="font-size: 12px; color: #666;">Accuracy</div>
                        <div style="height: 6px; background: #ecf0f1; border-radius: 3px; overflow: hidden; margin: 5px 0;">
                            <div style="height: 100%; width: ${accuracy}%; background: #27ae60; border-radius: 3px;"></div>
                        </div>
                        <div style="font-size: 14px; font-weight: bold;">${accuracy}%</div>
                    </div>
                </div>
                <div style="font-size: 12px; color: #7f8c8d;">
                    <i class="fas fa-clock"></i> Last: ${topic.last_practiced ? formatTimeAgo(topic.last_practiced) : 'Not started'}
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

// ============================================
// FETCH PERFORMANCE ANALYTICS
// ============================================
async function fetchPerformanceAnalytics() {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) return null;
        
        console.log('ðŸ“ˆ Fetching performance analytics...');
        
        const response = await fetch(`/api/progress/performance-analytics`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!response.ok) return null;
        
        const data = await response.json();
        
        if (data.success && data.analytics) {
            console.log('âœ… Performance analytics loaded:', data.analytics);
            
            // Update UI
            updatePerformanceAnalytics(data.analytics);
            
            return data.analytics;
        } else {
            return null;
        }
    } catch (error) {
        console.error('Error fetching performance analytics:', error);
        return null;
    }
}


// ============================================
// âœ… FIXED: updatePerformanceAnalytics - WITH REAL DATA
// ============================================
function updatePerformanceAnalytics(progressData) {
    const container = document.getElementById('performanceGrid');
    if (!container) return;
    
    // Use real data from progress
    const data = {
        weekly_improvement: progressData?.weekly_improvement || 5,
        practice_accuracy: progressData?.practice_accuracy || 85,
        avg_time_per_activity: progressData?.avg_time_per_activity || 5,
        current_streak: progressData?.streak_days || 1,
        quiz_avg_score: progressData?.quiz_avg_score || 75
    };
    
    container.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
            <!-- Weekly Improvement Card -->
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                        padding: 20px; border-radius: 10px; color: white;">
                <i class="fas fa-chart-line" style="font-size: 24px; margin-bottom: 10px;"></i>
                <h4 style="margin: 5px 0; font-size: 14px; opacity: 0.9;">Weekly Improvement</h4>
                <p style="font-size: 28px; font-weight: bold; margin: 5px 0;">
                    ${data.weekly_improvement > 0 ? '+' : ''}${data.weekly_improvement}%
                </p>
            </div>
            
            <!-- Practice Accuracy Card -->
            <div style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); 
                        padding: 20px; border-radius: 10px; color: white;">
                <i class="fas fa-bullseye" style="font-size: 24px; margin-bottom: 10px;"></i>
                <h4 style="margin: 5px 0; font-size: 14px; opacity: 0.9;">Practice Accuracy</h4>
                <p style="font-size: 28px; font-weight: bold; margin: 5px 0;">${data.practice_accuracy}%</p>
            </div>
            
            <!-- Avg. Time/Activity Card -->
            <div style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); 
                        padding: 20px; border-radius: 10px; color: white;">
                <i class="fas fa-clock" style="font-size: 24px; margin-bottom: 10px;"></i>
                <h4 style="margin: 5px 0; font-size: 14px; opacity: 0.9;">Avg. Time/Activity</h4>
                <p style="font-size: 28px; font-weight: bold; margin: 5px 0;">${data.avg_time_per_activity} min</p>
            </div>
            
            <!-- Current Streak Card -->
            <div style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); 
                        padding: 20px; border-radius: 10px; color: white;">
                <i class="fas fa-fire" style="font-size: 24px; margin-bottom: 10px;"></i>
                <h4 style="margin: 5px 0; font-size: 14px; opacity: 0.9;">Current Streak</h4>
                <p style="font-size: 28px; font-weight: bold; margin: 5px 0;">${data.current_streak} days</p>
            </div>
        </div>
    `;
    
    // Update learning insights
    updateLearningInsights(data);
}

// ============================================
// UPDATE LEARNING INSIGHTS
// ============================================
function updateLearningInsights(analytics) {
    const container = document.getElementById('insightsList');
    if (!container) return;
    
    const data = analytics || ProgressState.performanceAnalytics || {};
    
    let html = '';
    
    if (data.practice_accuracy < 60) {
        html += `
            <li style="display: flex; align-items: center; gap: 10px; padding: 8px 0;">
                <i class="fas fa-lightbulb" style="color: #f39c12; width: 20px;"></i>
                <span>Keep practicing! Your accuracy is ${data.practice_accuracy}%.</span>
            </li>
        `;
    } else if (data.practice_accuracy >= 80) {
        html += `
            <li style="display: flex; align-items: center; gap: 10px; padding: 8px 0;">
                <i class="fas fa-star" style="color: #f39c12; width: 20px;"></i>
                <span>Excellent work! You're mastering these topics.</span>
            </li>
        `;
    }
    
    if (data.weekly_improvement > 10) {
        html += `
            <li style="display: flex; align-items: center; gap: 10px; padding: 8px 0;">
                <i class="fas fa-chart-line" style="color: #27ae60; width: 20px;"></i>
                <span>Great improvement! You're up ${data.weekly_improvement}% this week.</span>
            </li>
        `;
    }
    
    if (data.current_streak >= 3) {
        html += `
            <li style="display: flex; align-items: center; gap: 10px; padding: 8px 0;">
                <i class="fas fa-fire" style="color: #e74c3c; width: 20px;"></i>
                <span>${data.current_streak} day streak! Keep it going!</span>
            </li>
        `;
    }
    
    if (html === '') {
        html = `
            <li style="display: flex; align-items: center; gap: 10px; padding: 8px 0;">
                <i class="fas fa-rocket" style="color: #7a0000; width: 20px;"></i>
                <span>Start learning to see insights about your progress!</span>
            </li>
        `;
    }
    
    container.innerHTML = html;
}

// Override the loadProgressDashboardData function
const originalLoadProgressDashboardData = window.loadProgressDashboardData || function(){};
window.loadProgressDashboardData = async function() {
    console.log('ðŸ“Š Loading progress dashboard data from database...');
    
    try {
        // Load all progress data
        const [cumulativeProgress, dailyProgress, topicMastery] = await Promise.all([
            fetchCumulativeProgress().catch(e => ({})),
            fetchDailyProgress().catch(e => ({})),
            fetchTopicMastery().catch(e => ({}))
        ]);
        
        console.log('âœ… All progress data loaded');
        
        // Store in ProgressState
        ProgressState.cumulativeProgress = cumulativeProgress || {};
        ProgressState.dailyProgress = dailyProgress || {};
        ProgressState.topicMastery = topicMastery || {};
        
        // Update all UI sections
        updateProgressSummaryCards();
        updateTopicProgressBreakdown();
        updatePerformanceAnalytics();
        updateLearningInsights();
        updateAchievementTimeline();
        
        // Update overall progress bar
        const overallProgress = document.getElementById('overallProgress');
        const overallProgressBar = document.getElementById('overallProgressBar');
        
        if (overallProgress && cumulativeProgress) {
            const totalLessons = cumulativeProgress.total_lessons_completed || 0;
            const progressPercent = Math.min(100, Math.round((totalLessons / 20) * 100));
            overallProgress.textContent = `${progressPercent}%`;
            if (overallProgressBar) {
                overallProgressBar.style.width = `${progressPercent}%`;
            }
        }
        
        // Update total points
        const totalPointsProgress = document.getElementById('totalPointsProgress');
        if (totalPointsProgress && cumulativeProgress) {
            totalPointsProgress.textContent = cumulativeProgress.total_points_earned || 0;
        }
        
        // Update total time
        const totalTime = document.getElementById('totalTime');
        if (totalTime && cumulativeProgress) {
            const totalMinutes = cumulativeProgress.total_time_spent_minutes || 0;
            const hours = Math.floor(totalMinutes / 60);
            const mins = totalMinutes % 60;
            totalTime.textContent = hours > 0 ? `${hours}h` : `${mins}m`;
        }
        
        console.log('âœ… Progress dashboard updated with all sections');
        
    } catch (error) {
        console.error('Error loading progress dashboard data:', error);
    }
};

// Add this to your DOMContentLoaded event
document.addEventListener('DOMContentLoaded', function() {
    const progressPage = document.getElementById('progress-page');
    
    if (progressPage) {
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                    if (!progressPage.classList.contains('hidden')) {
                        console.log('ðŸ“Š Progress page became visible, loading data...');
                        setTimeout(() => {
                            loadProgressDashboardData();
                        }, 300);
                    }
                }
            });
        });
        
        observer.observe(progressPage, { attributes: true });
    }
    
    // Also load when navigation happens
    const originalNavigateTo = window.navigateTo;
    window.navigateTo = function(page) {
        originalNavigateTo(page);
        if (page === 'progress') {
            setTimeout(() => {
                loadProgressDashboardData();
            }, 500);
        }
    };
});

// ============================================
// SETTINGS SECTION NAVIGATION FUNCTION - FIXED FOR YOUR HTML
// ============================================

// ============================================
// MISSING SETTINGS FUNCTIONS
// ============================================

/**
 * Setup photo upload functionality
 */
/**
 * Setup photo upload functionality
 */
function setupPhotoUpload() {
    console.log('ðŸ“¸ Setting up photo upload...');
    
    const uploadBtn = document.querySelector('.file-upload .btn-secondary');
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = 'image/*';
    fileInput.style.display = 'none';
    document.body.appendChild(fileInput);
    
    if (uploadBtn) {
        uploadBtn.addEventListener('click', function(e) {
            e.preventDefault();
            fileInput.click();
        });
    }
    
    fileInput.addEventListener('change', async function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        // Validate file
        if (!file.type.startsWith('image/')) {
            showNotification('Please select an image file', 'error');
            return;
        }
        
        if (file.size > 2 * 1024 * 1024) {
            showNotification('Image size should be less than 2MB', 'error');
            return;
        }
        
        // Preview
        const reader = new FileReader();
        reader.onload = function(event) {
            const profilePreview = document.getElementById('profilePreview');
            if (profilePreview) {
                profilePreview.innerHTML = `<img src="${event.target.result}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
            }
        };
        reader.readAsDataURL(file);
        
        // Upload to server
        await uploadProfilePicture(file);
    });
}

/**
 * Upload profile picture to server
 */
async function uploadProfilePicture(file) {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        if (!token) return;
        
        const formData = new FormData();
        formData.append('profile_picture', file);
        
        const response = await fetch(`/api/user/upload-photo`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`
            },
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification('Profile picture uploaded successfully!', 'success');
        } else {
            showNotification('Failed to upload picture', 'error');
        }
    } catch (error) {
        console.error('Error uploading picture:', error);
        showNotification('Failed to upload picture', 'error');
    }
}

/**
 * Setup delete account functionality
 */
function setupDeleteAccount() {
    console.log('ðŸ—‘ï¸ Setting up delete account...');
    
    // Look for delete buttons in the account section
    const deleteButtons = document.querySelectorAll('#account .btn-danger');
    
    deleteButtons.forEach(button => {
        // Remove existing listeners
        const newButton = button.cloneNode(true);
        button.parentNode.replaceChild(newButton, button);
        
        newButton.addEventListener('click', function(e) {
            e.preventDefault();
            
            const buttonText = this.textContent.toLowerCase();
            
            if (buttonText.includes('deactivate')) {
                showDeactivateConfirmation();
            } else if (buttonText.includes('delete')) {
                showDeleteConfirmationModal();
            }
        });
    });
}

/**
 * Show deactivate account confirmation
 */
function showDeactivateConfirmation() {
    const modalHTML = `
        <div class="delete-confirmation-modal">
            <div class="modal-header">
                <h3><i class="fas fa-exclamation-triangle"></i> Deactivate Account</h3>
            </div>
            
            <div class="modal-body">
                <p><strong>Warning:</strong> Deactivating your account will:</p>
                <ul style="margin-left: 20px; margin-bottom: 20px;">
                    <li>Hide your profile from other users</li>
                    <li>Pause your learning progress</li>
                    <li>Remove you from leaderboards</li>
                </ul>
                <p>You can reactivate your account at any time by logging in again.</p>
                
                <div class="confirmation-input">
                    <label>Type "DEACTIVATE" to confirm:</label>
                    <input type="text" id="deactivateConfirmation" placeholder="DEACTIVATE">
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn-secondary" id="cancelDeactivateBtn">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button class="btn-warning" id="confirmDeactivateBtn" disabled>
                    <i class="fas fa-ban"></i> Deactivate Account
                </button>
            </div>
        </div>
    `;
    
    const modal = showModal(modalHTML);
    
    const confirmationInput = document.getElementById('deactivateConfirmation');
    const confirmBtn = document.getElementById('confirmDeactivateBtn');
    const cancelBtn = document.getElementById('cancelDeactivateBtn');
    
    if (confirmationInput) {
        confirmationInput.addEventListener('input', function() {
            if (confirmBtn) {
                confirmBtn.disabled = this.value !== 'DEACTIVATE';
            }
        });
    }
    
    if (confirmBtn) {
        confirmBtn.addEventListener('click', async function() {
            const success = await deactivateAccount();
            
            if (success) {
                modal.remove();
                showNotification('Account deactivated successfully', 'info');
                setTimeout(() => {
                    logoutAndRedirect();
                }, 2000);
            }
        });
    }
    
    if (cancelBtn) {
        cancelBtn.addEventListener('click', function() {
            modal.remove();
        });
    }
}

/**
 * Deactivate account
 */
async function deactivateAccount() {
    if (!confirm('Are you sure you want to deactivate your account? You can reactivate by logging in again.')) return;
    
    try {
        const token = localStorage.getItem('authToken') || authToken;
        
        const response = await fetch(`/api/user/deactivate`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification('Account deactivated successfully', 'success');
            setTimeout(logoutAndRedirect, 2000);
        } else {
            showNotification('Failed to deactivate account', 'error');
        }
    } catch (error) {
        console.error('Error deactivating account:', error);
        showNotification('Failed to deactivate account', 'error');
    }
}


/**
 * Show delete account confirmation modal
 */
function showDeleteConfirmationModal() {
    const modalHTML = `
        <div class="delete-confirmation-modal">
            <div class="modal-header">
                <h3><i class="fas fa-exclamation-triangle"></i> Delete Account</h3>
            </div>
            
            <div class="modal-body">
                <p><strong>Warning:</strong> This action is permanent and cannot be undone.</p>
                <p>All your progress, achievements, and data will be permanently deleted.</p>
                
                <div class="confirmation-input">
                    <label>Type "DELETE" to confirm:</label>
                    <input type="text" id="deleteConfirmation" placeholder="DELETE">
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn-secondary" id="cancelDeleteBtn">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button class="btn-danger" id="confirmDeleteBtn" disabled>
                    <i class="fas fa-trash"></i> Permanently Delete Account
                </button>
            </div>
        </div>
    `;
    
    const modal = showModal(modalHTML);
    
    const confirmationInput = document.getElementById('deleteConfirmation');
    const confirmBtn = document.getElementById('confirmDeleteBtn');
    const cancelBtn = document.getElementById('cancelDeleteBtn');
    
    if (confirmationInput) {
        confirmationInput.addEventListener('input', function() {
            if (confirmBtn) {
                confirmBtn.disabled = this.value !== 'DELETE';
            }
        });
    }
    
    if (confirmBtn) {
        confirmBtn.addEventListener('click', async function() {
            const success = await deleteAccount();
            
            if (success) {
                modal.remove();
                showNotification('Account deleted successfully', 'info');
                setTimeout(() => {
                    logoutAndRedirect();
                }, 2000);
            }
        });
    }
    
    if (cancelBtn) {
        cancelBtn.addEventListener('click', function() {
            modal.remove();
        });
    }
}

/**
 * Delete account permanently
 */
async function deleteAccount() {
    if (!confirm('âš ï¸ WARNING: This will permanently delete ALL your data. This action cannot be undone. Continue?')) return;
    
    if (!confirm('Type "DELETE" to confirm:')) return;
    
    try {
        const token = localStorage.getItem('authToken') || authToken;
        
        const response = await fetch(`/api/user/delete`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification('Account deleted permanently', 'info');
            setTimeout(logoutAndRedirect, 2000);
        } else {
            showNotification('Failed to delete account', 'error');
        }
    } catch (error) {
        console.error('Error deleting account:', error);
        showNotification('Failed to delete account', 'error');
    }
}
/**
 * Export user data
 */
async function exportData() {
    try {
        const token = localStorage.getItem('authToken') || authToken;
        
        const response = await fetch(`/api/user/export-data`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Create downloadable file
            const blob = new Blob([JSON.stringify(data.data, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `mathhub-data-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showNotification('Data exported successfully!', 'success');
        } else {
            showNotification('Failed to export data', 'error');
        }
    } catch (error) {
        console.error('Error exporting data:', error);
        showNotification('Export feature coming soon!', 'info');
    }
}
/**
 * Clear learning history
 */
async function clearHistory() {
    if (!confirm('Are you sure you want to clear all learning history? This cannot be undone.')) return;
    
    try {
        const token = localStorage.getItem('authToken') || authToken;
        
        const response = await fetch(`/api/user/clear-history`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification('Learning history cleared!', 'success');
        } else {
            showNotification('Failed to clear history', 'error');
        }
    } catch (error) {
        console.error('Error clearing history:', error);
        showNotification('Clear history feature coming soon!', 'info');
    }
}
/**
 * Show modal helper function
 */
function showModal(content) {
    // Remove existing modal
    const existingModal = document.querySelector('.modal-overlay');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Create modal overlay
    const modalOverlay = document.createElement('div');
    modalOverlay.className = 'modal-overlay';
    modalOverlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
    `;
    
    // Create modal content
    const modalContent = document.createElement('div');
    modalContent.style.cssText = `
        background: white;
        border-radius: 10px;
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
    `;
    
    if (typeof content === 'string') {
        modalContent.innerHTML = content;
    } else {
        modalContent.appendChild(content);
    }
    
    modalOverlay.appendChild(modalContent);
    document.body.appendChild(modalOverlay);
    
    // Close on click outside
    modalOverlay.addEventListener('click', function(e) {
        if (e.target === modalOverlay) {
            modalOverlay.remove();
        }
    });
    
    return modalOverlay;
}
/**
 * Show a specific settings section
 * @param {string} sectionId - The ID of the section to show (without 'settings-' prefix)
 */
function showSection(sectionId) {
    console.log(`âš™ï¸ Showing settings section: ${sectionId}`);
    
    // Hide all settings sections first
    const sections = document.querySelectorAll('.settings-section');
    sections.forEach(section => {
        section.classList.remove('active');
        section.style.display = 'none';
    });
    
    // Show the selected section (your sections have IDs like "general", "learning", etc.)
    const targetSection = document.getElementById(sectionId);
    if (targetSection) {
        targetSection.classList.add('active');
        targetSection.style.display = 'block';
        
        // Update active state in sidebar
        document.querySelectorAll('.sidebar-menu a').forEach(link => {
            link.classList.remove('active');
        });
        
        // Find and activate the clicked link
        const activeLink = document.querySelector(`[onclick="showSection('${sectionId}')"]`);
        if (activeLink) {
            activeLink.classList.add('active');
        }
        
        console.log(`âœ… Settings section "${sectionId}" is now visible`);
    } else {
        console.error(`âŒ Section with id "${sectionId}" not found`);
        
        // Show general section as fallback
        const generalSection = document.getElementById('general');
        if (generalSection) {
            generalSection.classList.add('active');
            generalSection.style.display = 'block';
            
            // Update active menu
            document.querySelectorAll('.sidebar-menu a').forEach(link => {
                link.classList.remove('active');
            });
            
            const generalLink = document.querySelector('[onclick="showSection(\'general\')"]');
            if (generalLink) {
                generalLink.classList.add('active');
            }
        }
    }
}

/**
 * Reset settings to defaults
 */
function resetSettings() {
    console.log('ðŸ”„ Resetting settings to defaults');
    
    if (confirm('Are you sure you want to reset all settings to default values?')) {
        // Reset form fields to default values
        const displayName = document.getElementById('displayName');
        if (displayName) {
            displayName.value = AppState.currentUser?.full_name || '';
        }
        
        const email = document.getElementById('userEmail');
        if (email) {
            email.value = AppState.currentUser?.email || '';
        }
        
        // Reset toggles
        const toggles = ['adaptiveDifficulty', 'showSolutions', 'weeklyReport', 
                         'featureAnnouncements', 'practiceReminders', 'achievementAlerts'];
        toggles.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.checked = true;
            }
        });
        
        // Reset selects
        const selectIds = ['preferredDifficulty', 'profileVisibility', 'mathSymbolStyle', 'fontSize'];
        selectIds.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.selectedIndex = 0;
            }
        });
        
        // Reset theme radio
        const themeLight = document.getElementById('themeLight');
        if (themeLight) {
            themeLight.checked = true;
        }
        
        showNotification('Settings reset to defaults', 'info');
    }
}

/**
 * Save all settings
 */
async function saveSettings() {
    console.log('ðŸ’¾ Saving all settings');
    
    // Show loading state
    const saveBtn = document.querySelector('.action-buttons .btn-primary');
    if (!saveBtn) return;
    
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    saveBtn.disabled = true;
    
    try {
        // Collect settings data from all sections
        const settingsData = {
            // General
            display_name: document.getElementById('displayName')?.value,
            email: document.getElementById('userEmail')?.value,
            language: document.getElementById('interfaceLanguage')?.value,
            municipality: document.getElementById('batangas-municipalities')?.value,
            timezone: document.getElementById('timeZone')?.value,
            
            // Learning
            adaptive_difficulty: document.getElementById('adaptiveDifficulty')?.checked,
            preferred_difficulty: document.getElementById('preferredDifficulty')?.value,
            practice_count: document.querySelector('input[name="practice"]:checked')?.id || 'practice10',
            show_solutions: document.getElementById('showSolutions')?.checked,
            
            // Privacy
            two_factor: document.getElementById('twoFactorAuth')?.checked,
            profile_visibility: document.getElementById('profileVisibility')?.value,
            data_sharing: document.getElementById('dataSharing')?.checked,
            
            // Notifications
            weekly_report: document.getElementById('weeklyReport')?.checked,
            feature_announcements: document.getElementById('featureAnnouncements')?.checked,
            practice_reminders: document.getElementById('practiceReminders')?.checked,
            achievement_alerts: document.getElementById('achievementAlerts')?.checked,
            
            // Display
            theme: document.querySelector('input[name="theme"]:checked')?.id?.replace('theme', '').toLowerCase() || 'light',
            math_style: document.getElementById('mathSymbolStyle')?.value,
            high_contrast: document.getElementById('highContrast')?.checked,
            font_size: document.getElementById('fontSize')?.value
        };
        
        console.log('ðŸ“¤ Saving settings:', settingsData);
        
        // Update profile if changed
        if (settingsData.display_name || settingsData.email) {
            const profileUpdate = {};
            if (settingsData.display_name) profileUpdate.full_name = settingsData.display_name;
            if (settingsData.email) profileUpdate.email = settingsData.email;
            
            await updateProfile(profileUpdate);
        }
        
        // Save to localStorage
        localStorage.setItem('userSettings', JSON.stringify(settingsData));
        
        // Apply theme immediately
        applyTheme(settingsData.theme);
        
        showNotification('Settings saved successfully!', 'success');
        
    } catch (error) {
        console.error('âŒ Error saving settings:', error);
        showNotification('Failed to save settings', 'error');
    } finally {
        // Restore button
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
    }
}

/**
 * Apply theme to the page
 * @param {string} theme - 'light', 'dark', or 'auto'
 */
function applyTheme(theme) {
    console.log(`ðŸŽ¨ Applying theme: ${theme}`);
    
    // Remove existing theme classes
    document.body.classList.remove('dark-theme', 'light-theme');
    
    if (theme === 'dark') {
        document.body.classList.add('dark-theme');
        localStorage.setItem('preferred-theme', 'dark');
    } else if (theme === 'light') {
        document.body.classList.add('light-theme');
        localStorage.setItem('preferred-theme', 'light');
    } else if (theme === 'auto') {
        // Check system preference
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        if (prefersDark) {
            document.body.classList.add('dark-theme');
        } else {
            document.body.classList.add('light-theme');
        }
        localStorage.setItem('preferred-theme', 'auto');
    }
    
    // Force repaint para mag-reflect agad ang changes
    document.body.style.display = 'none';
    document.body.offsetHeight; // Trigger reflow
    document.body.style.display = '';
    
    // Update radio button if exists
    updateThemeRadioButton(theme);
    
    // Dispatch custom event para sa ibang components
    window.dispatchEvent(new CustomEvent('themeChanged', { detail: { theme: theme } }));
}

/**
 * Preview theme without saving
 */
function previewTheme(theme) {
    console.log(`ðŸ‘ï¸ Previewing theme: ${theme}`);
    
    // Remove existing theme classes
    document.body.classList.remove('dark-theme', 'light-theme');
    
    if (theme === 'dark') {
        document.body.classList.add('dark-theme');
    } else if (theme === 'light') {
        document.body.classList.add('light-theme');
    } else if (theme === 'auto') {
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        if (prefersDark) {
            document.body.classList.add('dark-theme');
        } else {
            document.body.classList.add('light-theme');
        }
    }
}

// I-update ang radio button listeners para mag-preview agad
function setupThemeListeners() {
    const themeLight = document.getElementById('themeLight');
    const themeDark = document.getElementById('themeDark');
    const themeAuto = document.getElementById('themeAuto');
    
    if (themeLight) {
        themeLight.addEventListener('change', function() {
            if (this.checked) previewTheme('light');
        });
    }
    
    if (themeDark) {
        themeDark.addEventListener('change', function() {
            if (this.checked) previewTheme('dark');
        });
    }
    
    if (themeAuto) {
        themeAuto.addEventListener('change', function() {
            if (this.checked) previewTheme('auto');
        });
    }
    
    // High contrast toggle
    const highContrast = document.getElementById('highContrast');
    if (highContrast) {
        highContrast.addEventListener('change', function() {
            if (this.checked) {
                document.body.classList.add('high-contrast');
            } else {
                document.body.classList.remove('high-contrast');
            }
        });
    }
    
    // Font size selector
    const fontSize = document.getElementById('fontSize');
    if (fontSize) {
        fontSize.addEventListener('change', function() {
            applyFontSize(this.value);
        });
    }
}


/**
 * View public profile
 */
function viewProfile() {
    const userId = AppState.currentUser?.id;
    if (userId) {
        window.open(`/profile/${userId}`, '_blank');
    } else {
        showNotification('Please login first', 'error');
    }
}

/**
 * Initialize settings sections on page load
 */
function initSettingsSections() {
    console.log('âš™ï¸ Initializing settings sections');
    
    // Make sure general section is visible by default
    const generalSection = document.getElementById('general');
    if (generalSection) {
        generalSection.classList.add('active');
        generalSection.style.display = 'block';
    }
    
    // Load saved settings from localStorage
    try {
        const savedSettings = JSON.parse(localStorage.getItem('userSettings'));
        if (savedSettings) {
            console.log('ðŸ“‚ Loading saved settings:', savedSettings);
            
            // Apply theme
            if (savedSettings.theme) {
                applyTheme(savedSettings.theme);
                
                // Update theme radio
                const themeRadio = document.getElementById(`theme${savedSettings.theme.charAt(0).toUpperCase() + savedSettings.theme.slice(1)}`);
                if (themeRadio) themeRadio.checked = true;
            }
        }
    } catch (error) {
        console.log('No saved settings found');
    }
}



// ============================================
// THEME MANAGEMENT FUNCTIONS
// ============================================

/**
 * Apply theme to the page
 * @param {string} theme - 'light', 'dark', or 'auto'
 */
function applyTheme(theme) {
    console.log(`ðŸŽ¨ Applying theme: ${theme}`);
    
    const root = document.documentElement;
    
    // Remove existing theme classes
    document.body.classList.remove('dark-theme', 'light-theme');
    
    if (theme === 'dark') {
        document.body.classList.add('dark-theme');
        localStorage.setItem('preferred-theme', 'dark');
    } else if (theme === 'light') {
        document.body.classList.add('light-theme');
        localStorage.setItem('preferred-theme', 'light');
    } else if (theme === 'auto') {
        // Check system preference
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        if (prefersDark) {
            document.body.classList.add('dark-theme');
        } else {
            document.body.classList.add('light-theme');
        }
        localStorage.setItem('preferred-theme', 'auto');
    }
    
    // Update radio button if exists
    updateThemeRadioButton(theme);
}

/**
 * Update theme radio button based on current theme
 */
function updateThemeRadioButton(theme) {
    const themeLight = document.getElementById('themeLight');
    const themeDark = document.getElementById('themeDark');
    const themeAuto = document.getElementById('themeAuto');
    
    if (theme === 'light' && themeLight) themeLight.checked = true;
    else if (theme === 'dark' && themeDark) themeDark.checked = true;
    else if (theme === 'auto' && themeAuto) themeAuto.checked = true;
}

/**
 * Initialize theme based on saved preference or system default
 */
function initTheme() {
    console.log('ðŸŽ¨ Initializing theme...');
    
    // Check for saved theme in localStorage
    const savedTheme = localStorage.getItem('preferred-theme');
    
    if (savedTheme) {
        applyTheme(savedTheme);
    } else {
        // Default to light theme
        applyTheme('light');
    }
    
    // Listen for system theme changes if using auto
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
        const currentTheme = localStorage.getItem('preferred-theme');
        if (currentTheme === 'auto') {
            if (e.matches) {
                document.body.classList.add('dark-theme');
                document.body.classList.remove('light-theme');
            } else {
                document.body.classList.add('light-theme');
                document.body.classList.remove('dark-theme');
            }
        }
    });
}

/**
 * Load display settings from database
 */


/**
 * Load display from localStorage as fallback
 */
function loadDisplayFromLocalStorage() {
    try {
        const savedDisplay = JSON.parse(localStorage.getItem('displaySettings'));
        if (savedDisplay) {
            if (savedDisplay.theme) {
                applyTheme(savedDisplay.theme);
            }
            
            const highContrast = document.getElementById('highContrast');
            if (highContrast) {
                highContrast.checked = savedDisplay.high_contrast === true;
                applyHighContrast(savedDisplay.high_contrast);
            }
            
            const fontSize = document.getElementById('fontSize');
            if (fontSize && savedDisplay.font_size) {
                fontSize.value = savedDisplay.font_size;
                applyFontSize(savedDisplay.font_size);
            }
            
            const mathStyle = document.getElementById('mathSymbolStyle');
            if (mathStyle && savedDisplay.math_style) {
                mathStyle.value = savedDisplay.math_style;
            }
        }
    } catch (e) {
        console.log('No saved display settings found');
    }
}

/**
 * Apply high contrast mode
 */
function applyHighContrast(enabled) {
    if (enabled) {
        document.body.classList.add('high-contrast');
    } else {
        document.body.classList.remove('high-contrast');
    }
}



// ============================================
// ðŸš¨ EMERGENCY MODAL FIX - ADD THIS AT THE END OF script.js
// ============================================

// Global emergency function para i-force ang modal
window.forceShowForgotModal = function() {
    console.log('ðŸš¨ EMERGENCY: Forcing forgot password modal to show');
    
    // Hanapin ang modal
    let modal = document.getElementById('forgotPasswordModal');
    
    // Kung wala, create
    if (!modal) {
        console.log('ðŸ“ Modal not found, creating dynamically...');
        createForgotPasswordModal();
        modal = document.getElementById('forgotPasswordModal');
    }
    
    if (modal) {
        // Reset step
        const step1 = document.getElementById('forgotStep1');
        const step2 = document.getElementById('forgotStep2');
        const resetEmail = document.getElementById('resetEmail');
        const forgotError = document.getElementById('forgotError');
        
        if (step1) step1.style.display = 'block';
        if (step2) step2.style.display = 'none';
        if (resetEmail) resetEmail.value = '';
        if (forgotError) forgotError.style.display = 'none';
        
        // REMOVE ALL EXISTING STYLES
        modal.removeAttribute('style');
        modal.removeAttribute('class');
        
        // Set fresh classes
        modal.className = 'modal-overlay active';
        modal.setAttribute('data-visible', 'true');
        
        // APPLY FORCE STYLES DIRECTLY
        modal.style.cssText = `
            display: flex !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            background-color: rgba(0, 0, 0, 0.85) !important;
            backdrop-filter: blur(5px) !important;
            -webkit-backdrop-filter: blur(5px) !important;
            z-index: 9999999 !important;
            align-items: center !important;
            justify-content: center !important;
            margin: 0 !important;
            padding: 20px !important;
            box-sizing: border-box !important;
        `;
        
        // Prevent body scrolling
        document.body.classList.add('modal-open');
        document.body.style.overflow = 'hidden';
        
        console.log('âœ… Modal forced to show');
        console.log('ðŸ“Š Modal display:', window.getComputedStyle(modal).display);
        
        return true;
    }
    
    console.log('âŒ Failed to show modal');
    return false;
};

// Global function para i-debug kung bakit hindi lumalabas
window.debugModalWhy = function() {
    console.log('ðŸ” DEBUGGING MODAL ISSUE...');
    
    const modal = document.getElementById('forgotPasswordModal');
    
    if (!modal) {
        console.log('âŒ Modal element not found in DOM');
        console.log('Creating modal now...');
        createForgotPasswordModal();
        return;
    }
    
    console.log('âœ… Modal element found');
    
    // Check computed styles
    const styles = window.getComputedStyle(modal);
    console.log('ðŸ“Š Current computed styles:', {
        display: styles.display,
        visibility: styles.visibility,
        opacity: styles.opacity,
        zIndex: styles.zIndex,
        position: styles.position,
        backgroundColor: styles.backgroundColor,
        width: styles.width,
        height: styles.height
    });
    
    // Check inline styles
    console.log('ðŸ“ Inline styles:', modal.style.cssText || 'None');
    
    // Check classes
    console.log('ðŸ·ï¸ Classes:', modal.className);
    
    // Check if any parent is hiding it
    console.log('ðŸ” Checking parent elements...');
    let parent = modal.parentElement;
    let level = 0;
    while (parent) {
        const parentStyles = window.getComputedStyle(parent);
        if (parentStyles.display === 'none' || parentStyles.visibility === 'hidden' || parentStyles.opacity === '0') {
            console.log(`âš ï¸ Hidden by parent at level ${level}:`, parent.tagName, parent.className);
            console.log('Parent styles:', {
                display: parentStyles.display,
                visibility: parentStyles.visibility,
                opacity: parentStyles.opacity,
                overflow: parentStyles.overflow
            });
        }
        parent = parent.parentElement;
        level++;
    }
    
    // Check for overlapping elements
    const elements = document.elementsFromPoint(
        window.innerWidth / 2,
        window.innerHeight / 2
    );
    console.log('ðŸŽ¯ Elements at center of screen:', elements.map(el => ({
        tag: el.tagName,
        id: el.id,
        class: el.className,
        zIndex: window.getComputedStyle(el).zIndex
    })));
    
    console.log('ðŸ’¡ To force show modal, type: forceShowForgotModal()');
};

// Override ang showForgotPasswordModal para sure
const originalShowForgotPasswordModal = window.showForgotPasswordModal;
// ============================================
// ðŸš¨ EMERGENCY MODAL FIX - ADD AT THE VERY END
// ============================================

// Override the showForgotPasswordModal function
window.showForgotPasswordModal = function() {
    console.log('ðŸ”‘ Opening forgot password modal (FIXED VERSION)');
    
    const modal = document.getElementById('forgotPasswordModal');
    
    if (!modal) {
        console.error('âŒ Modal not found! Creating dynamically...');
        createForgotPasswordModal();
        setTimeout(() => window.showForgotPasswordModal(), 100);
        return;
    }
    
    // Reset to step 1
    const step1 = document.getElementById('forgotStep1');
    const step2 = document.getElementById('forgotStep2');
    const resetEmail = document.getElementById('resetEmail');
    const forgotError = document.getElementById('forgotError');
    
    if (step1) step1.style.display = 'block';
    if (step2) step2.style.display = 'none';
    if (resetEmail) resetEmail.value = '';
    if (forgotError) forgotError.style.display = 'none';
    
    // FORCE SHOW MODAL
    modal.style.display = 'flex';
    modal.style.position = 'fixed';
    modal.style.top = '0';
    modal.style.left = '0';
    modal.style.width = '100%';
    modal.style.height = '100%';
    modal.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
    modal.style.zIndex = '999999';
    modal.style.alignItems = 'center';
    modal.style.justifyContent = 'center';
    
    // Prevent body scrolling
    document.body.classList.add('modal-open');
    document.body.style.overflow = 'hidden';
    
    console.log('âœ… Modal shown successfully');
};

// Direct click handler for forgot password link
document.addEventListener('click', function(e) {
    const target = e.target.closest('#forgotPasswordLink');
    if (target) {
        e.preventDefault();
        e.stopPropagation();
        console.log('ðŸŽ¯ Forgot password link clicked');
        window.showForgotPasswordModal();
    }
}, true);

// Auto-run kapag may error
console.log('ðŸš€ Emergency modal fixes loaded!');
console.log('ðŸ’¡ Commands:');
console.log('   - forceShowForgotModal() - Show modal now');
console.log('   - debugModalWhy() - Check why modal is hidden');



/**
 * Apply font size
 */
function applyFontSize(size) {
    const root = document.documentElement;
    
    // Remove existing font size classes
    root.classList.remove('font-small', 'font-medium', 'font-large', 'font-x-large');
    
    // Add new font size class
    root.classList.add(`font-${size}`);
    
    // Set CSS variable for font size
    const fontSizeMap = {
        'small': '14px',
        'medium': '16px',
        'large': '18px',
        'x-large': '20px'
    };
    
    root.style.setProperty('--base-font-size', fontSizeMap[size] || '16px');
}

/**
 * Collect display settings from form
 */
function collectDisplaySettings() {
    const themeRadio = document.querySelector('input[name="theme"]:checked');
    const theme = themeRadio ? themeRadio.value : 'light';
    
    return {
        theme: theme,
        math_style: document.getElementById('mathSymbolStyle')?.value || 'modern',
        high_contrast: document.getElementById('highContrast')?.checked || false,
        font_size: document.getElementById('fontSize')?.value || 'medium'
    };
}

/**
 * Setup theme listeners
 */
function setupThemeListeners() {
    const themeLight = document.getElementById('themeLight');
    const themeDark = document.getElementById('themeDark');
    const themeAuto = document.getElementById('themeAuto');
    
    if (themeLight) {
        themeLight.addEventListener('change', function() {
            if (this.checked) applyTheme('light');
        });
    }
    
    if (themeDark) {
        themeDark.addEventListener('change', function() {
            if (this.checked) applyTheme('dark');
        });
    }
    
    if (themeAuto) {
        themeAuto.addEventListener('change', function() {
            if (this.checked) applyTheme('auto');
        });
    }
    
    // High contrast toggle
    const highContrast = document.getElementById('highContrast');
    if (highContrast) {
        highContrast.addEventListener('change', function() {
            applyHighContrast(this.checked);
        });
    }
    
    // Font size selector
    const fontSize = document.getElementById('fontSize');
    if (fontSize) {
        fontSize.addEventListener('change', function() {
            applyFontSize(this.value);
        });
    }
}
// ============================================
// MAKE FUNCTIONS GLOBALLY AVAILABLE
// ============================================

window.showSection = showSection;
window.resetSettings = resetSettings;
window.saveSettings = saveAllSettings;
window.viewProfile = viewProfile;
window.exportData = exportData;
window.clearHistory = clearHistory;
window.deactivateAccount = deactivateAccount;
window.deleteAccount = deleteAccount;


// ============================================
// ðŸš¨ DEBUG: Check modal visibility
// ============================================
window.debugModal = function() {
    const modal = document.getElementById('forgotPasswordModal');
    
    console.log('ðŸ” MODAL DEBUG:');
    console.log('- Element exists:', !!modal);
    
    if (modal) {
        console.log('- Current display:', modal.style.display);
        console.log('- Classes:', modal.className);
        console.log('- Computed display:', window.getComputedStyle(modal).display);
        console.log('- Position:', window.getComputedStyle(modal).position);
        console.log('- Z-index:', window.getComputedStyle(modal).zIndex);
        
        // Force show
        modal.style.display = 'flex';
        modal.style.zIndex = '999999';
        modal.style.position = 'fixed';
        modal.style.top = '0';
        modal.style.left = '0';
        modal.style.width = '100%';
        modal.style.height = '100%';
        modal.style.backgroundColor = 'rgba(0,0,0,0.8)';
        
        console.log('âœ… Forced modal to show');
    } else {
        console.log('âŒ Modal not found, creating...');
        createForgotPasswordModal();
    }
};

// ============================================
// ðŸš¨ EMERGENCY MODAL FIX
// ============================================
window.forceShowForgotModal = function() {
    console.log('ðŸš¨ EMERGENCY: Forcing modal to show');
    
    // Try to find or create modal
    let modal = document.getElementById('forgotPasswordModal');
    
    if (!modal) {
        console.log('Creating modal...');
        const modalHTML = `
            <div id="forgotPasswordModal" class="modal-overlay">
                <div class="modal-container">
                    <div class="modal-header">
                        <h3><i class="fas fa-key"></i> Reset Password</h3>
                        <button class="modal-close" onclick="closeForgotPasswordModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div id="forgotStep1">
                            <p>Enter your email address:</p>
                            <input type="email" id="resetEmail" placeholder="your@email.com" style="width:100%; padding:10px; margin:10px 0;">
                            <button onclick="requestPasswordReset()">Send Reset Link</button>
                        </div>
                        <div id="forgotStep2" style="display:none;">
                            <p>Reset link generated!</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        modal = document.getElementById('forgotPasswordModal');
    }
    
    if (modal) {
        // Remove all existing styles and set fresh
        modal.removeAttribute('style');
        modal.removeAttribute('class');
        modal.className = 'modal-overlay';
        
        // Force styles
        modal.style.cssText = `
            display: flex !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            background: rgba(0,0,0,0.8) !important;
            z-index: 9999999 !important;
            align-items: center !important;
            justify-content: center !important;
        `;
        
        modal.classList.add('active');
        
        // Reset step
        const step1 = document.getElementById('forgotStep1');
        const step2 = document.getElementById('forgotStep2');
        if (step1) step1.style.display = 'block';
        if (step2) step2.style.display = 'none';
        
        document.body.style.overflow = 'hidden';
        
        console.log('âœ… Modal forced to show');
        return true;
    }
    
    console.log('âŒ Failed to show modal');
    return false;
};

// Auto-run emergency fix when link is clicked
document.addEventListener('click', function(e) {
    if (e.target.id === 'forgotPasswordLink' || e.target.closest('#forgotPasswordLink')) {
        e.preventDefault();
        e.stopPropagation();
        console.log('ðŸŽ¯ Forgot password clicked - using emergency fix');
        
        // Try normal first, then emergency if fails
        if (!showForgotPasswordModal()) {
            setTimeout(forceShowForgotModal, 100);
        }
    }
}, true);



// ============================================
// ðŸš¨ ULTIMATE TOOL MANAGEMENT FIX
// ============================================

// 1. Force remove all existing styles that might hide modals
(function forceToolStyles() {
    const style = document.createElement('style');
    style.textContent = `
        /* Force all tool modals to be visible */
        #calculatorModal,
        #graphModal,
        #whiteboardModal,
        #notepadModal,
        #formulaModal,
        #timerModal {
            display: none !important;
        }
        
        #calculatorModal.modal-overlay[style*="display: flex"],
        #graphModal.modal-overlay[style*="display: flex"],
        #whiteboardModal.modal-overlay[style*="display: flex"],
        #notepadModal.modal-overlay[style*="display: flex"],
        #formulaModal.modal-overlay[style*="display: flex"],
        #timerModal.modal-overlay[style*="display: flex"],
        #calculatorModal.modal-overlay.active,
        #graphModal.modal-overlay.active,
        #whiteboardModal.modal-overlay.active,
        #notepadModal.modal-overlay.active,
        #formulaModal.modal-overlay.active,
        #timerModal.modal-overlay.active {
            display: flex !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            background: rgba(0, 0, 0, 0.7) !important;
            z-index: 10000 !important;
            align-items: center !important;
            justify-content: center !important;
        }
        
        /* Ensure modal container is visible */
        .modal-overlay.active .modal-container,
        .modal-overlay[style*="display: flex"] .modal-container {
            opacity: 1 !important;
            visibility: visible !important;
            transform: scale(1) !important;
        }
        
        /* Tool items cursor */
        .tool-item,
        .tool-item-compact {
            cursor: pointer !important;
        }
    `;
    document.head.appendChild(style);
})();

// 2. Create a global tool manager instance
if (!window.toolManager) {
    console.log('ðŸ”§ Creating ToolManager...');
    window.toolManager = new ToolManager();
}

// 3. Direct click handlers para sa LAHAT ng tool buttons
function fixAllToolButtons() {
    console.log('ðŸ”§ Fixing ALL tool buttons...');
    
    // List all tool buttons with their corresponding modal IDs
    const toolButtons = [
        // From learning-tools-box (compact version)
        { element: document.getElementById('openCalculator'), modalId: 'calculatorModal', toolName: 'calculator' },
        { element: document.getElementById('openGraphTools'), modalId: 'graphModal', toolName: 'graph' },
        { element: document.getElementById('openNotepad'), modalId: 'notepadModal', toolName: 'notepad' },
        { element: document.getElementById('openFormulaSheet'), modalId: 'formulaModal', toolName: 'formula' },
        { element: document.getElementById('openWhiteboard'), modalId: 'whiteboardModal', toolName: 'whiteboard' },
        { element: document.getElementById('openTimer'), modalId: 'timerModal', toolName: 'timer' },
        
        // Also find buttons in tools-grid (sidebar version)
        ...Array.from(document.querySelectorAll('.tool-item[id^="open"]')).map(btn => ({
            element: btn,
            modalId: btn.id.replace('open', '').toLowerCase() + 'Modal',
            toolName: btn.id.replace('open', '').toLowerCase()
        }))
    ];
    
    toolButtons.forEach(item => {
        const btn = item.element;
        if (!btn) return;
        
        console.log(`ðŸ”§ Fixing button: ${btn.id} -> ${item.modalId}`);
        
        // Remove ALL existing event listeners by cloning
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
        
        // Add DIRECT click handler
        newBtn.onclick = function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            console.log(`ðŸŽ¯ Clicked: ${item.toolName}`);
            
            // Find the modal
            const modal = document.getElementById(item.modalId);
            
            if (modal) {
                // Hide all modals first
                document.querySelectorAll('.modal-overlay').forEach(m => {
                    m.style.display = 'none';
                    m.classList.remove('active');
                });
                
                // FORCE show this modal
                modal.style.display = 'flex';
                modal.style.position = 'fixed';
                modal.style.top = '0';
                modal.style.left = '0';
                modal.style.width = '100%';
                modal.style.height = '100%';
                modal.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
                modal.style.zIndex = '10000';
                modal.style.alignItems = 'center';
                modal.style.justifyContent = 'center';
                modal.classList.add('active');
                
                // Initialize the tool
                setTimeout(() => {
                    if (window.toolManager && window.toolManager.tools && window.toolManager.tools[item.toolName]) {
                        try {
                            window.toolManager.tools[item.toolName].onOpen();
                            console.log(`âœ… ${item.toolName} initialized`);
                        } catch (e) {
                            console.error(`Error initializing ${item.toolName}:`, e);
                        }
                    }
                }, 100);
                
                // Special fix para sa timer display
                if (item.toolName === 'timer') {
                    setTimeout(fixTimerDisplay, 200);
                    setTimeout(fixTimerDisplay, 500);
                }
            } else {
                console.error(`âŒ Modal not found: ${item.modalId}`);
            }
            
            return false;
        };
        
        // Add visual feedback
        newBtn.style.cursor = 'pointer';
        newBtn.addEventListener('mouseenter', () => {
            newBtn.style.opacity = '0.8';
        });
        newBtn.addEventListener('mouseleave', () => {
            newBtn.style.opacity = '1';
        });
    });
    
    console.log('âœ… All tool buttons fixed!');
}

// 4. Special function para i-fix ang timer display
function fixTimerDisplay() {
    console.log('â±ï¸ Fixing timer display...');
    
    const timerModal = document.getElementById('timerModal');
    if (!timerModal) return;
    
    const timerDisplay = document.getElementById('timerDisplay');
    if (!timerDisplay) return;
    
    if (window.toolManager && window.toolManager.tools && window.toolManager.tools.timer) {
        const timer = window.toolManager.tools.timer;
        timer.timerElement = timerDisplay;
        
        // Force display update
        const minutes = Math.floor(timer.timeLeft / 60);
        const seconds = timer.timeLeft % 60;
        timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        timerDisplay.innerHTML = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        console.log('âœ… Timer display fixed:', timerDisplay.textContent);
    }
}

// 5. Emergency function to manually open any tool
window.emergencyOpenTool = function(toolName) {
    console.log(`ðŸš¨ Emergency opening ${toolName}`);
    
    const modal = document.getElementById(`${toolName}Modal`);
    if (modal) {
        modal.style.display = 'flex';
        modal.style.position = 'fixed';
        modal.style.top = '0';
        modal.style.left = '0';
        modal.style.width = '100%';
        modal.style.height = '100%';
        modal.style.backgroundColor = 'rgba(0,0,0,0.7)';
        modal.style.zIndex = '10000';
        modal.style.alignItems = 'center';
        modal.style.justifyContent = 'center';
        modal.classList.add('active');
        
        if (window.toolManager && window.toolManager.tools && window.toolManager.tools[toolName]) {
            setTimeout(() => {
                try {
                    window.toolManager.tools[toolName].onOpen();
                } catch (e) {
                    console.error(e);
                }
            }, 100);
        }
        
        return true;
    }
    return false;
};

// 6. Debug function
window.debugTools = function() {
    console.log('ðŸ” TOOL DEBUG INFO:');
    console.log('- ToolManager exists:', !!window.toolManager);
    console.log('- ToolManager tools:', window.toolManager ? Object.keys(window.toolManager.tools) : 'N/A');
    
    const tools = ['calculator', 'graph', 'notepad', 'formula', 'whiteboard', 'timer'];
    tools.forEach(tool => {
        const modal = document.getElementById(`${tool}Modal`);
        const button = document.getElementById(`open${tool.charAt(0).toUpperCase() + tool.slice(1)}`);
        console.log(`- ${tool}: modal=${!!modal}, button=${!!button}`);
        
        if (modal) {
            console.log(`  Modal display: ${modal.style.display}`);
            console.log(`  Modal classes: ${modal.className}`);
        }
    });
};

// 7. Run fixes at different times
document.addEventListener('DOMContentLoaded', function() {
    // Fix immediately
    setTimeout(fixAllToolButtons, 100);
    
    // Fix again after a delay
    setTimeout(fixAllToolButtons, 500);
    setTimeout(fixAllToolButtons, 1000);
    
    // Observe for timer modal
    const timerModal = document.getElementById('timerModal');
    if (timerModal) {
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                    if (timerModal.classList.contains('active') || timerModal.style.display === 'flex') {
                        setTimeout(fixTimerDisplay, 200);
                        setTimeout(fixTimerDisplay, 500);
                    }
                }
            });
        });
        observer.observe(timerModal, { attributes: true });
    }
});

// Also fix when page becomes fully loaded
window.addEventListener('load', function() {
    setTimeout(fixAllToolButtons, 500);
});

console.log('ðŸš€ ULTIMATE TOOL FIX LOADED!');
console.log('ðŸ’¡ Commands:');
console.log('   - emergencyOpenTool("calculator") - Manually open calculator');
console.log('   - debugTools() - Check tool status');
console.log('   - fixAllToolButtons() - Re-attach all tool buttons');
